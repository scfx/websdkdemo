import { Component, Input } from '@angular/core';
import { ControlContainer, NgForm } from '@angular/forms';
import { defaults, cloneDeep, isFinite } from 'lodash-es';
import { gettext, TenantUiService } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
export class SessionConfigurationComponent {
    constructor(tenantUiService, translateService) {
        this.tenantUiService = tenantUiService;
        this.translateService = translateService;
        this.ABSOLUTE_TIMEOUT_VALIDATION_MESSAGE = gettext('The value must be greater than "Token lifespan" and not less than {{ minAbsoluteTimeout }}.');
        this.RENEWAL_TIMEOUT_VALIDATION_MESSAGE = gettext('The value must be less than "Token lifespan".');
        this.MAX_TOKEN_LIFESPAN_VALIDATION_MESSAGE = gettext('The value must be less than "Session absolute timeout".');
        this.MIN_TOKEN_LIFESPAN_VALIDATION_MESSAGE = gettext('The value must be greater than "Session renewal timeout".');
        this.USER_AGENT_VALIDATION_REQUIRED_POPOVER = gettext('If selected, then every request needs to use the same "User-Agent" header as the first request which initiated the session.');
        this.MIN_ABSOLUTE_TIMEOUT = 15 * 60;
        this.ABSOLUTE_TIMEOUT_VALIDATION_MESSAGE = this.translateService.instant(this.ABSOLUTE_TIMEOUT_VALIDATION_MESSAGE, { minAbsoluteTimeout: this.MIN_ABSOLUTE_TIMEOUT });
    }
    ngOnChanges(changes) {
        if (changes.authConfiguration && changes.authConfiguration.currentValue) {
            const oauthInternal = changes.authConfiguration.currentValue.loginOptions.find(this.tenantUiService.isOauthInternal) || {};
            this.originalSessionConfiguration = cloneDeep(oauthInternal.sessionConfiguration);
            this.sessionConfiguration = oauthInternal.sessionConfiguration;
            this.previousTokenLifespan = this.authConfiguration.tenantOptions['oauth.internal']['basic-token.lifespan.seconds'];
        }
    }
    get renewalTimeoutSeconds() {
        const sessionConfiguration = this.sessionConfiguration;
        return this.convertToSeconds(sessionConfiguration.renewalTimeoutMillis);
    }
    set renewalTimeoutSeconds(value) {
        this.sessionConfiguration.renewalTimeoutMillis = this.convertToMillis(value);
    }
    get absoluteTimeoutSeconds() {
        const sessionConfiguration = this.sessionConfiguration;
        return this.convertToSeconds(sessionConfiguration.absoluteTimeoutMillis);
    }
    set absoluteTimeoutSeconds(value) {
        this.sessionConfiguration.absoluteTimeoutMillis = this.convertToMillis(value);
    }
    get maximumNumberOfParallelSessions() {
        return this.sessionConfiguration.maximumNumberOfParallelSessions;
    }
    set maximumNumberOfParallelSessions(value) {
        this.sessionConfiguration.maximumNumberOfParallelSessions = value;
    }
    get userAgentValidationRequired() {
        return this.sessionConfiguration.userAgentValidationRequired;
    }
    set userAgentValidationRequired(value) {
        this.sessionConfiguration.userAgentValidationRequired = value;
    }
    get basicTokenLifespan() {
        return this.authConfiguration.tenantOptions['oauth.internal']['basic-token.lifespan.seconds'];
    }
    set basicTokenLifespan(value) {
        this.authConfiguration.tenantOptions['oauth.internal']['basic-token.lifespan.seconds'] = value;
    }
    get useSessionConfiguration() {
        return !!this.sessionConfiguration;
    }
    set useSessionConfiguration(value) {
        this.sessionConfiguration = value ? defaults({}, this.originalSessionConfiguration, {
            absoluteTimeoutMillis: 1209600000,
            renewalTimeoutMillis: 86400000,
            maximumNumberOfParallelSessions: 5,
            userAgentValidationRequired: false
        }) : null;
        this.basicTokenLifespan = this.previousTokenLifespan || 172800; // 2 days
    }
    get absoluteTimeoutConstraints() {
        return {
            min: Math.max(this.MIN_ABSOLUTE_TIMEOUT, this.basicTokenLifespan + 1)
        };
    }
    get renewalTimeoutConstraints() {
        return {
            min: this.MIN_ABSOLUTE_TIMEOUT / 2,
            max: this.basicTokenLifespan ? this.basicTokenLifespan - 1 : null
        };
    }
    get basicTokenLifespanConstraints() {
        return {
            min: this.renewalTimeoutSeconds ? this.renewalTimeoutSeconds + 1 : null,
            max: this.absoluteTimeoutSeconds ? this.absoluteTimeoutSeconds - 1 : null
        };
    }
    get sessionConfiguration() {
        return this.authConfiguration.loginOptions.find(this.tenantUiService.isOauthInternal)
            .sessionConfiguration;
    }
    set sessionConfiguration(value) {
        this.authConfiguration.loginOptions.find(this.tenantUiService.isOauthInternal)
            .sessionConfiguration = value;
    }
    convertToMillis(seconds) {
        return isFinite(seconds) ? seconds * 1000 : null;
    }
    convertToSeconds(milliseconds) {
        return isFinite(milliseconds) ? Math.ceil(milliseconds / 1000) : null;
    }
}
SessionConfigurationComponent.decorators = [
    { type: Component, args: [{
                selector: 'c8y-session-configuration',
                template: "<div class=\"card-block separator-top overflow-auto\" *ngIf=\"authConfiguration\">\n  <div class=\"col-sm-2\">\n    <h4 class=\"text-right\">{{ 'OAI-Secure session configuration' | translate }}</h4>\n  </div>\n\n  <div class=\"col-sm-9\">\n    <div class=\"row\">\n      <div class=\"col-sm-6\">\n        <c8y-form-group>\n          <label class=\"c8y-switch\" title=\"{{ 'Use session configuration' | translate }}\">\n            <input\n              type=\"checkbox\"\n              name=\"useSessionConfiguration\"\n              [(ngModel)]=\"useSessionConfiguration\"\n            />\n            <span></span>\n            <span>{{ 'Use session configuration' | translate }}</span>\n          </label>\n        </c8y-form-group>\n      </div>\n    </div>\n\n    <fieldset *ngIf=\"sessionConfiguration\">\n      <div class=\"row\">\n        <div class=\"col-sm-6\">\n          <c8y-form-group>\n            <label class=\"c8y-switch\" title=\"{{ 'User agent validation required' | translate }}\">\n              <input\n                type=\"checkbox\"\n                name=\"userAgentValidationRequired\"\n                [(ngModel)]=\"userAgentValidationRequired\"\n              />\n              <span></span>\n              <span>{{ 'User agent validation required' | translate }}</span>\n              <button\n                class=\"btn btn-clean\"\n                popover=\"{{ USER_AGENT_VALIDATION_REQUIRED_POPOVER | translate }}\"\n                placement=\"right\"\n                [outsideClick]=\"true\"\n                container=\"body\"\n              >\n                <i [c8yIcon]=\"'question-circle-o'\" class=\"text-info\"></i>\n              </button>\n            </label>\n          </c8y-form-group>\n        </div>\n      </div>\n      <div class=\"row\">\n        <div class=\"col-sm-6\">\n          <c8y-form-group>\n            <label title=\"{{ 'Session absolute timeout' | translate }}\">{{ 'Session absolute timeout' | translate }}\n            </label>\n            <div class=\"input-group\">\n              <input\n                type=\"number\"\n                name=\"absoluteTimeoutSeconds\"\n                class=\"form-control text-right\"\n                [(ngModel)]=\"absoluteTimeoutSeconds\"\n                [required]=\"useSessionConfiguration\"\n                [min]=\"absoluteTimeoutConstraints.min\"\n                step=\"1\"\n              />\n              <span class=\"input-group-addon\" translate>seconds</span>\n            </div>\n            <c8y-messages>\n              <c8y-message\n                name=\"min\"\n                text=\"{{ ABSOLUTE_TIMEOUT_VALIDATION_MESSAGE | translate }}\"\n              ></c8y-message>\n            </c8y-messages>\n          </c8y-form-group>\n        </div>\n        <div class=\"col-sm-6\">\n          <c8y-form-group>\n            <label title=\"{{ 'Session renewal timeout' | translate }}\">{{ 'Session renewal timeout' | translate }}</label>\n            <div class=\"input-group\">\n              <input\n                type=\"number\"\n                name=\"renewalTimeoutSeconds\"\n                class=\"form-control text-right\"\n                [(ngModel)]=\"renewalTimeoutSeconds\"\n                [required]=\"useSessionConfiguration\"\n                [max]=\"renewalTimeoutConstraints.max\"\n                [min]=\"renewalTimeoutConstraints.min\"\n                step=\"1\"\n              />\n              <span class=\"input-group-addon\" translate>seconds</span>\n            </div>\n            <c8y-messages>\n              <c8y-message\n                name=\"max\"\n                text=\"{{ RENEWAL_TIMEOUT_VALIDATION_MESSAGE | translate }}\"\n              ></c8y-message>\n            </c8y-messages>\n          </c8y-form-group>\n        </div>\n      </div>\n\n      <div class=\"row\">\n        <div class=\"col-sm-6\">\n          <c8y-form-group>\n            <label title=\"{{ 'Maximum parallel sessions per user' | translate }}\">{{\n              'Maximum parallel sessions per user' | translate\n            }}</label>\n            <div class=\"input-group\">\n              <input\n                type=\"number\"\n                name=\"maximumNumberOfParallelSessions\"\n                class=\"form-control text-right\"\n                [(ngModel)]=\"maximumNumberOfParallelSessions\"\n                [required]=\"useSessionConfiguration\"\n                [min]=\"1\"\n                step=\"1\"\n              />\n              <span class=\"input-group-addon\" translate>sessions</span>\n            </div>\n          </c8y-form-group>\n        </div>\n        <div class=\"col-sm-6\">\n          <c8y-form-group>\n            <label title=\"{{ 'Token lifespan' | translate }}\">{{\n              'Token lifespan' | translate\n            }}</label>\n            <div class=\"input-group\">\n              <input\n                type=\"number\"\n                name=\"basicTokenLifespan\"\n                class=\"form-control text-right\"\n                [(ngModel)]=\"basicTokenLifespan\"\n                [required]=\"useSessionConfiguration\"\n                [max]=\"basicTokenLifespanConstraints.max\"\n                [min]=\"basicTokenLifespanConstraints.min\"\n                step=\"1\"\n              />\n              <span class=\"input-group-addon\" translate>seconds</span>\n            </div>\n            <c8y-messages>\n              <c8y-message\n                name=\"max\"\n                text=\"{{ MAX_TOKEN_LIFESPAN_VALIDATION_MESSAGE | translate }}\"\n              ></c8y-message>\n              <c8y-message\n                name=\"min\"\n                text=\"{{ MIN_TOKEN_LIFESPAN_VALIDATION_MESSAGE | translate }}\"\n              ></c8y-message>\n            </c8y-messages>\n          </c8y-form-group>\n        </div>\n      </div>\n    </fieldset>\n  </div>\n</div>\n",
                viewProviders: [{ provide: ControlContainer, useExisting: NgForm }]
            },] }
];
SessionConfigurationComponent.ctorParameters = () => [
    { type: TenantUiService },
    { type: TranslateService }
];
SessionConfigurationComponent.propDecorators = {
    authConfiguration: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Vzc2lvbi1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2F1dGgtY29uZmlndXJhdGlvbi9zZXNzaW9uLWNvbmZpZ3VyYXRpb24uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUVoRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDMUQsT0FBTyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzFELE9BQU8sRUFBRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFL0QsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFPdkQsTUFBTSxPQUFPLDZCQUE2QjtJQW1CeEMsWUFBb0IsZUFBZ0MsRUFDaEMsZ0JBQWtDO1FBRGxDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUNoQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBaEJ0RCx3Q0FBbUMsR0FBRyxPQUFPLENBQUMsNkZBQTZGLENBQUMsQ0FBQztRQUM3SSx1Q0FBa0MsR0FBRyxPQUFPLENBQUMsK0NBQStDLENBQUMsQ0FBQztRQUM5RiwwQ0FBcUMsR0FBRyxPQUFPLENBQzdDLHlEQUF5RCxDQUMxRCxDQUFDO1FBQ0YsMENBQXFDLEdBQUcsT0FBTyxDQUM3QywyREFBMkQsQ0FDNUQsQ0FBQztRQUVGLDJDQUFzQyxHQUFHLE9BQU8sQ0FBQyw2SEFBNkgsQ0FBQyxDQUFDO1FBRXhLLHlCQUFvQixHQUFXLEVBQUUsR0FBRyxFQUFFLENBQUM7UUFNN0MsSUFBSSxDQUFDLG1DQUFtQyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQ3RFLElBQUksQ0FBQyxtQ0FBbUMsRUFBRSxFQUFFLGtCQUFrQixFQUFFLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFFLENBQUM7SUFDbEcsQ0FBQztJQUVELFdBQVcsQ0FBQyxPQUFzQjtRQUNoQyxJQUFJLE9BQU8sQ0FBQyxpQkFBaUIsSUFBSSxPQUFPLENBQUMsaUJBQWlCLENBQUMsWUFBWSxFQUFFO1lBQ3ZFLE1BQU0sYUFBYSxHQUNqQixPQUFPLENBQUMsaUJBQWlCLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQ3RELElBQUksQ0FBQyxlQUFlLENBQUMsZUFBZSxDQUNyQyxJQUFJLEVBQUUsQ0FBQztZQUNWLElBQUksQ0FBQyw0QkFBNEIsR0FBRyxTQUFTLENBQUMsYUFBYSxDQUFDLG9CQUFvQixDQUFDLENBQUM7WUFDbEYsSUFBSSxDQUFDLG9CQUFvQixHQUFHLGFBQWEsQ0FBQyxvQkFBb0IsQ0FBQztZQUMvRCxJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLDhCQUE4QixDQUFDLENBQUM7U0FDckg7SUFDSCxDQUFDO0lBRUQsSUFBSSxxQkFBcUI7UUFDdkIsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUM7UUFDdkQsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsb0JBQW9CLENBQUMsb0JBQW9CLENBQUMsQ0FBQztJQUMxRSxDQUFDO0lBRUQsSUFBSSxxQkFBcUIsQ0FBQyxLQUFhO1FBQ3JDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFFRCxJQUFJLHNCQUFzQjtRQUN4QixNQUFNLG9CQUFvQixHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztRQUN2RCxPQUFPLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxvQkFBb0IsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0lBQzNFLENBQUM7SUFFRCxJQUFJLHNCQUFzQixDQUFDLEtBQWE7UUFDdEMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLHFCQUFxQixHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDaEYsQ0FBQztJQUVELElBQUksK0JBQStCO1FBQ2pDLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDLCtCQUErQixDQUFDO0lBQ25FLENBQUM7SUFFRCxJQUFJLCtCQUErQixDQUFDLEtBQWE7UUFDL0MsSUFBSSxDQUFDLG9CQUFvQixDQUFDLCtCQUErQixHQUFHLEtBQUssQ0FBQztJQUNwRSxDQUFDO0lBRUQsSUFBSSwyQkFBMkI7UUFDN0IsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUMsMkJBQTJCLENBQUM7SUFDL0QsQ0FBQztJQUVELElBQUksMkJBQTJCLENBQUMsS0FBYztRQUM1QyxJQUFJLENBQUMsb0JBQW9CLENBQUMsMkJBQTJCLEdBQUcsS0FBSyxDQUFDO0lBQ2hFLENBQUM7SUFFRCxJQUFJLGtCQUFrQjtRQUNwQixPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO0lBQ2hHLENBQUM7SUFFRCxJQUFJLGtCQUFrQixDQUFDLEtBQUs7UUFDMUIsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLDhCQUE4QixDQUFDLEdBQUcsS0FBSyxDQUFDO0lBQ2pHLENBQUM7SUFFRCxJQUFJLHVCQUF1QjtRQUN6QixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUM7SUFDckMsQ0FBQztJQUVELElBQUksdUJBQXVCLENBQUMsS0FBSztRQUMvQixJQUFJLENBQUMsb0JBQW9CLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyw0QkFBNEIsRUFBRTtZQUNsRixxQkFBcUIsRUFBRSxVQUFVO1lBQ2pDLG9CQUFvQixFQUFFLFFBQVE7WUFDOUIsK0JBQStCLEVBQUUsQ0FBQztZQUNsQywyQkFBMkIsRUFBRSxLQUFLO1NBQ25DLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ1YsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxxQkFBcUIsSUFBSSxNQUFNLENBQUMsQ0FBQyxTQUFTO0lBQzNFLENBQUM7SUFFRCxJQUFJLDBCQUEwQjtRQUM1QixPQUFPO1lBQ0wsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLG9CQUFvQixFQUFFLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxDQUFDLENBQUM7U0FDdEUsQ0FBQztJQUNKLENBQUM7SUFFRCxJQUFJLHlCQUF5QjtRQUMzQixPQUFPO1lBQ0wsR0FBRyxFQUFFLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxDQUFDO1lBQ2xDLEdBQUcsRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUk7U0FDbEUsQ0FBQztJQUNKLENBQUM7SUFFRCxJQUFJLDZCQUE2QjtRQUMvQixPQUFPO1lBQ0wsR0FBRyxFQUFFLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLHFCQUFxQixHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSTtZQUN2RSxHQUFHLEVBQUUsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsc0JBQXNCLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJO1NBQzFFLENBQUM7SUFDSixDQUFDO0lBRUQsSUFBSSxvQkFBb0I7UUFDdEIsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQzthQUNsRixvQkFBb0IsQ0FBQztJQUMxQixDQUFDO0lBRUQsSUFBSSxvQkFBb0IsQ0FBQyxLQUE0QjtRQUNuRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLGVBQWUsQ0FBQzthQUMzRSxvQkFBb0IsR0FBRyxLQUFLLENBQUM7SUFDbEMsQ0FBQztJQUVPLGVBQWUsQ0FBQyxPQUFlO1FBQ3JDLE9BQU8sUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDbkQsQ0FBQztJQUVPLGdCQUFnQixDQUFDLFlBQW9CO1FBQzNDLE9BQU8sUUFBUSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO0lBQ3hFLENBQUM7OztZQXRJRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLDJCQUEyQjtnQkFDckMseXZMQUFxRDtnQkFDckQsYUFBYSxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxDQUFDO2FBQ3BFOzs7WUFSaUIsZUFBZTtZQUV4QixnQkFBZ0I7OztnQ0FRdEIsS0FBSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5wdXQsIFNpbXBsZUNoYW5nZXMgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElTZXNzaW9uQ29uZmlndXJhdGlvbiB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IENvbnRyb2xDb250YWluZXIsIE5nRm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IGRlZmF1bHRzLCBjbG9uZURlZXAsIGlzRmluaXRlIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IGdldHRleHQsIFRlbmFudFVpU2VydmljZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgQXV0aENvbmZpZ3VyYXRpb24gfSBmcm9tICcuL2F1dGgtY29uZmlndXJhdGlvbi5tb2RlbCc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1zZXNzaW9uLWNvbmZpZ3VyYXRpb24nLFxuICB0ZW1wbGF0ZVVybDogJy4vc2Vzc2lvbi1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5odG1sJyxcbiAgdmlld1Byb3ZpZGVyczogW3sgcHJvdmlkZTogQ29udHJvbENvbnRhaW5lciwgdXNlRXhpc3Rpbmc6IE5nRm9ybSB9XVxufSlcbmV4cG9ydCBjbGFzcyBTZXNzaW9uQ29uZmlndXJhdGlvbkNvbXBvbmVudCB7XG4gIEBJbnB1dCgpXG4gIGF1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvbjtcblxuICBBQlNPTFVURV9USU1FT1VUX1ZBTElEQVRJT05fTUVTU0FHRSA9IGdldHRleHQoJ1RoZSB2YWx1ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBcIlRva2VuIGxpZmVzcGFuXCIgYW5kIG5vdCBsZXNzIHRoYW4ge3sgbWluQWJzb2x1dGVUaW1lb3V0IH19LicpO1xuICBSRU5FV0FMX1RJTUVPVVRfVkFMSURBVElPTl9NRVNTQUdFID0gZ2V0dGV4dCgnVGhlIHZhbHVlIG11c3QgYmUgbGVzcyB0aGFuIFwiVG9rZW4gbGlmZXNwYW5cIi4nKTtcbiAgTUFYX1RPS0VOX0xJRkVTUEFOX1ZBTElEQVRJT05fTUVTU0FHRSA9IGdldHRleHQoXG4gICAgJ1RoZSB2YWx1ZSBtdXN0IGJlIGxlc3MgdGhhbiBcIlNlc3Npb24gYWJzb2x1dGUgdGltZW91dFwiLidcbiAgKTtcbiAgTUlOX1RPS0VOX0xJRkVTUEFOX1ZBTElEQVRJT05fTUVTU0FHRSA9IGdldHRleHQoXG4gICAgJ1RoZSB2YWx1ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBcIlNlc3Npb24gcmVuZXdhbCB0aW1lb3V0XCIuJ1xuICApO1xuXG4gIFVTRVJfQUdFTlRfVkFMSURBVElPTl9SRVFVSVJFRF9QT1BPVkVSID0gZ2V0dGV4dCgnSWYgc2VsZWN0ZWQsIHRoZW4gZXZlcnkgcmVxdWVzdCBuZWVkcyB0byB1c2UgdGhlIHNhbWUgXCJVc2VyLUFnZW50XCIgaGVhZGVyIGFzIHRoZSBmaXJzdCByZXF1ZXN0IHdoaWNoIGluaXRpYXRlZCB0aGUgc2Vzc2lvbi4nKTtcblxuICBwcml2YXRlIE1JTl9BQlNPTFVURV9USU1FT1VUOiBudW1iZXIgPSAxNSAqIDYwO1xuICBwcml2YXRlIG9yaWdpbmFsU2Vzc2lvbkNvbmZpZ3VyYXRpb247XG4gIHByaXZhdGUgcHJldmlvdXNUb2tlbkxpZmVzcGFuO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgdGVuYW50VWlTZXJ2aWNlOiBUZW5hbnRVaVNlcnZpY2UsXG4gICAgICAgICAgICAgIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRlU2VydmljZSkge1xuICAgIHRoaXMuQUJTT0xVVEVfVElNRU9VVF9WQUxJREFUSU9OX01FU1NBR0UgPSB0aGlzLnRyYW5zbGF0ZVNlcnZpY2UuaW5zdGFudChcbiAgICAgIHRoaXMuQUJTT0xVVEVfVElNRU9VVF9WQUxJREFUSU9OX01FU1NBR0UsIHsgbWluQWJzb2x1dGVUaW1lb3V0OiB0aGlzLk1JTl9BQlNPTFVURV9USU1FT1VUIH0gKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoY2hhbmdlcy5hdXRoQ29uZmlndXJhdGlvbiAmJiBjaGFuZ2VzLmF1dGhDb25maWd1cmF0aW9uLmN1cnJlbnRWYWx1ZSkge1xuICAgICAgY29uc3Qgb2F1dGhJbnRlcm5hbCA9XG4gICAgICAgIGNoYW5nZXMuYXV0aENvbmZpZ3VyYXRpb24uY3VycmVudFZhbHVlLmxvZ2luT3B0aW9ucy5maW5kKFxuICAgICAgICAgIHRoaXMudGVuYW50VWlTZXJ2aWNlLmlzT2F1dGhJbnRlcm5hbFxuICAgICAgICApIHx8IHt9O1xuICAgICAgdGhpcy5vcmlnaW5hbFNlc3Npb25Db25maWd1cmF0aW9uID0gY2xvbmVEZWVwKG9hdXRoSW50ZXJuYWwuc2Vzc2lvbkNvbmZpZ3VyYXRpb24pO1xuICAgICAgdGhpcy5zZXNzaW9uQ29uZmlndXJhdGlvbiA9IG9hdXRoSW50ZXJuYWwuc2Vzc2lvbkNvbmZpZ3VyYXRpb247XG4gICAgICB0aGlzLnByZXZpb3VzVG9rZW5MaWZlc3BhbiA9IHRoaXMuYXV0aENvbmZpZ3VyYXRpb24udGVuYW50T3B0aW9uc1snb2F1dGguaW50ZXJuYWwnXVsnYmFzaWMtdG9rZW4ubGlmZXNwYW4uc2Vjb25kcyddO1xuICAgIH1cbiAgfVxuXG4gIGdldCByZW5ld2FsVGltZW91dFNlY29uZHMoKTogbnVtYmVyIHtcbiAgICBjb25zdCBzZXNzaW9uQ29uZmlndXJhdGlvbiA9IHRoaXMuc2Vzc2lvbkNvbmZpZ3VyYXRpb247XG4gICAgcmV0dXJuIHRoaXMuY29udmVydFRvU2Vjb25kcyhzZXNzaW9uQ29uZmlndXJhdGlvbi5yZW5ld2FsVGltZW91dE1pbGxpcyk7XG4gIH1cblxuICBzZXQgcmVuZXdhbFRpbWVvdXRTZWNvbmRzKHZhbHVlOiBudW1iZXIpIHtcbiAgICB0aGlzLnNlc3Npb25Db25maWd1cmF0aW9uLnJlbmV3YWxUaW1lb3V0TWlsbGlzID0gdGhpcy5jb252ZXJ0VG9NaWxsaXModmFsdWUpO1xuICB9XG5cbiAgZ2V0IGFic29sdXRlVGltZW91dFNlY29uZHMoKTogbnVtYmVyIHtcbiAgICBjb25zdCBzZXNzaW9uQ29uZmlndXJhdGlvbiA9IHRoaXMuc2Vzc2lvbkNvbmZpZ3VyYXRpb247XG4gICAgcmV0dXJuIHRoaXMuY29udmVydFRvU2Vjb25kcyhzZXNzaW9uQ29uZmlndXJhdGlvbi5hYnNvbHV0ZVRpbWVvdXRNaWxsaXMpO1xuICB9XG5cbiAgc2V0IGFic29sdXRlVGltZW91dFNlY29uZHModmFsdWU6IG51bWJlcikge1xuICAgIHRoaXMuc2Vzc2lvbkNvbmZpZ3VyYXRpb24uYWJzb2x1dGVUaW1lb3V0TWlsbGlzID0gdGhpcy5jb252ZXJ0VG9NaWxsaXModmFsdWUpO1xuICB9XG5cbiAgZ2V0IG1heGltdW1OdW1iZXJPZlBhcmFsbGVsU2Vzc2lvbnMoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5zZXNzaW9uQ29uZmlndXJhdGlvbi5tYXhpbXVtTnVtYmVyT2ZQYXJhbGxlbFNlc3Npb25zO1xuICB9XG5cbiAgc2V0IG1heGltdW1OdW1iZXJPZlBhcmFsbGVsU2Vzc2lvbnModmFsdWU6IG51bWJlcikge1xuICAgIHRoaXMuc2Vzc2lvbkNvbmZpZ3VyYXRpb24ubWF4aW11bU51bWJlck9mUGFyYWxsZWxTZXNzaW9ucyA9IHZhbHVlO1xuICB9XG5cbiAgZ2V0IHVzZXJBZ2VudFZhbGlkYXRpb25SZXF1aXJlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5zZXNzaW9uQ29uZmlndXJhdGlvbi51c2VyQWdlbnRWYWxpZGF0aW9uUmVxdWlyZWQ7XG4gIH1cblxuICBzZXQgdXNlckFnZW50VmFsaWRhdGlvblJlcXVpcmVkKHZhbHVlOiBib29sZWFuKSB7XG4gICAgdGhpcy5zZXNzaW9uQ29uZmlndXJhdGlvbi51c2VyQWdlbnRWYWxpZGF0aW9uUmVxdWlyZWQgPSB2YWx1ZTtcbiAgfVxuXG4gIGdldCBiYXNpY1Rva2VuTGlmZXNwYW4oKSB7XG4gICAgcmV0dXJuIHRoaXMuYXV0aENvbmZpZ3VyYXRpb24udGVuYW50T3B0aW9uc1snb2F1dGguaW50ZXJuYWwnXVsnYmFzaWMtdG9rZW4ubGlmZXNwYW4uc2Vjb25kcyddO1xuICB9XG5cbiAgc2V0IGJhc2ljVG9rZW5MaWZlc3Bhbih2YWx1ZSkge1xuICAgIHRoaXMuYXV0aENvbmZpZ3VyYXRpb24udGVuYW50T3B0aW9uc1snb2F1dGguaW50ZXJuYWwnXVsnYmFzaWMtdG9rZW4ubGlmZXNwYW4uc2Vjb25kcyddID0gdmFsdWU7XG4gIH1cblxuICBnZXQgdXNlU2Vzc2lvbkNvbmZpZ3VyYXRpb24oKSB7XG4gICAgcmV0dXJuICEhdGhpcy5zZXNzaW9uQ29uZmlndXJhdGlvbjtcbiAgfVxuXG4gIHNldCB1c2VTZXNzaW9uQ29uZmlndXJhdGlvbih2YWx1ZSkge1xuICAgIHRoaXMuc2Vzc2lvbkNvbmZpZ3VyYXRpb24gPSB2YWx1ZSA/IGRlZmF1bHRzKHt9LCB0aGlzLm9yaWdpbmFsU2Vzc2lvbkNvbmZpZ3VyYXRpb24sIHtcbiAgICAgIGFic29sdXRlVGltZW91dE1pbGxpczogMTIwOTYwMDAwMCwgLy8gMTQgZGF5c1xuICAgICAgcmVuZXdhbFRpbWVvdXRNaWxsaXM6IDg2NDAwMDAwLCAvLyAxIGRheVxuICAgICAgbWF4aW11bU51bWJlck9mUGFyYWxsZWxTZXNzaW9uczogNSxcbiAgICAgIHVzZXJBZ2VudFZhbGlkYXRpb25SZXF1aXJlZDogZmFsc2VcbiAgICB9KSA6IG51bGw7XG4gICAgdGhpcy5iYXNpY1Rva2VuTGlmZXNwYW4gPSB0aGlzLnByZXZpb3VzVG9rZW5MaWZlc3BhbiB8fCAxNzI4MDA7IC8vIDIgZGF5c1xuICB9XG5cbiAgZ2V0IGFic29sdXRlVGltZW91dENvbnN0cmFpbnRzKCkge1xuICAgIHJldHVybiB7XG4gICAgICBtaW46IE1hdGgubWF4KHRoaXMuTUlOX0FCU09MVVRFX1RJTUVPVVQsIHRoaXMuYmFzaWNUb2tlbkxpZmVzcGFuICsgMSlcbiAgICB9O1xuICB9XG5cbiAgZ2V0IHJlbmV3YWxUaW1lb3V0Q29uc3RyYWludHMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG1pbjogdGhpcy5NSU5fQUJTT0xVVEVfVElNRU9VVCAvIDIsXG4gICAgICBtYXg6IHRoaXMuYmFzaWNUb2tlbkxpZmVzcGFuID8gdGhpcy5iYXNpY1Rva2VuTGlmZXNwYW4gLSAxIDogbnVsbFxuICAgIH07XG4gIH1cblxuICBnZXQgYmFzaWNUb2tlbkxpZmVzcGFuQ29uc3RyYWludHMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG1pbjogdGhpcy5yZW5ld2FsVGltZW91dFNlY29uZHMgPyB0aGlzLnJlbmV3YWxUaW1lb3V0U2Vjb25kcyArIDEgOiBudWxsLFxuICAgICAgbWF4OiB0aGlzLmFic29sdXRlVGltZW91dFNlY29uZHMgPyB0aGlzLmFic29sdXRlVGltZW91dFNlY29uZHMgLSAxIDogbnVsbFxuICAgIH07XG4gIH1cblxuICBnZXQgc2Vzc2lvbkNvbmZpZ3VyYXRpb24oKTogSVNlc3Npb25Db25maWd1cmF0aW9uIHtcbiAgICByZXR1cm4gdGhpcy5hdXRoQ29uZmlndXJhdGlvbi5sb2dpbk9wdGlvbnMuZmluZCh0aGlzLnRlbmFudFVpU2VydmljZS5pc09hdXRoSW50ZXJuYWwpXG4gICAgICAuc2Vzc2lvbkNvbmZpZ3VyYXRpb247XG4gIH1cblxuICBzZXQgc2Vzc2lvbkNvbmZpZ3VyYXRpb24odmFsdWU6IElTZXNzaW9uQ29uZmlndXJhdGlvbikge1xuICAgIHRoaXMuYXV0aENvbmZpZ3VyYXRpb24ubG9naW5PcHRpb25zLmZpbmQodGhpcy50ZW5hbnRVaVNlcnZpY2UuaXNPYXV0aEludGVybmFsKVxuICAgICAgLnNlc3Npb25Db25maWd1cmF0aW9uID0gdmFsdWU7XG4gIH1cblxuICBwcml2YXRlIGNvbnZlcnRUb01pbGxpcyhzZWNvbmRzOiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiBpc0Zpbml0ZShzZWNvbmRzKSA/IHNlY29uZHMgKiAxMDAwIDogbnVsbDtcbiAgfVxuXG4gIHByaXZhdGUgY29udmVydFRvU2Vjb25kcyhtaWxsaXNlY29uZHM6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIGlzRmluaXRlKG1pbGxpc2Vjb25kcykgPyBNYXRoLmNlaWwobWlsbGlzZWNvbmRzIC8gMTAwMCkgOiBudWxsO1xuICB9XG59XG4iXX0=