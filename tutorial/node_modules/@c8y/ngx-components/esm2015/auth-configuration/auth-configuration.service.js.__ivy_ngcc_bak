import { Injectable } from '@angular/core';
import { ApplicationService, GrantType, SystemOptionsService, TenantLoginOptionsService, TenantLoginOptionType, TenantOptionsService, UserManagementSource } from '@c8y/client';
import { catchError, map } from 'rxjs/operators';
import { forkJoin, from, of } from 'rxjs';
import { defaults, omit } from 'lodash-es';
import { TenantUiService } from '@c8y/ngx-components';
export class AuthConfigurationService {
    constructor(tenantLoginOptionsService, tenantOptionsService, systemOptionsService, applicationService, tenantUiService) {
        this.tenantLoginOptionsService = tenantLoginOptionsService;
        this.tenantOptionsService = tenantOptionsService;
        this.systemOptionsService = systemOptionsService;
        this.applicationService = applicationService;
        this.tenantUiService = tenantUiService;
        this.systemOptionsWithDefaultValue = [
            { category: 'password', key: 'limit.validity', value: null },
            { category: 'password', key: 'enforce.strength', value: 'false' },
            { category: 'two-factor-authentication', key: 'tenant-scope-settings.enabled', value: 'false' },
            { category: 'two-factor-authentication', key: 'enabled', value: 'false' },
            { category: 'two-factor-authentication', key: 'enforced', value: 'false' },
            { category: 'two-factor-authentication', key: 'enforced.group', value: '' }
        ];
        this.tenantOptionsWithDefaultValue = [
            { category: 'password', key: 'limit.validity', value: '0' },
            { category: 'password', key: 'strength.validity', value: 'false' },
            { category: 'two-factor-authentication', key: 'enabled', value: 'false' },
            { category: 'two-factor-authentication', key: 'token.validity', value: '43200' },
            { category: 'two-factor-authentication', key: 'pin.validity', value: '30' },
            { category: 'two-factor-authentication', key: 'enforced', value: 'false' },
            { category: 'two-factor-authentication', key: 'strategy', value: 'SMS' },
            { category: 'oauth.internal', key: 'basic-token.lifespan.seconds', value: null }
        ];
    }
    getAuthConfiguration$() {
        const loginOptions$ = this.getLoginOptions$();
        return forkJoin({
            loginOptions: loginOptions$,
            tenantOptions: this.getTenantOptions$(),
            systemOptions: this.getSystemOptions$(),
            smsGatewayAvailable: this.isSmsApplicationAvailable$(),
            preferredLoginOptionType: this.getPreferredLoginOptionType$(loginOptions$)
        });
    }
    save(newAuthConfiguration, previousAuthConfiguration) {
        const tenantOptions = this.prepareTenantOptions(newAuthConfiguration, previousAuthConfiguration);
        const updateTenantOptions = tenantOptions.map(tenantOption => this.tenantOptionsService.create(tenantOption));
        const basicLoginOption = this.prepareBasicLoginOption(newAuthConfiguration, previousAuthConfiguration);
        const oauthInternalLoginOption = this.prepareOauthInternalLoginOption(newAuthConfiguration, previousAuthConfiguration);
        return Promise.all([
            this.saveOrUpdateLoginOption(basicLoginOption),
            this.saveOrUpdateLoginOption(oauthInternalLoginOption),
            updateTenantOptions
        ]);
    }
    saveOrUpdateLoginOption(loginOption) {
        return loginOption.id
            ? this.tenantLoginOptionsService.update(loginOption)
            : this.tenantLoginOptionsService.create(loginOption);
    }
    prepareBasicLoginOption(newAuthConfiguration, previousAuthConfiguration) {
        let basicLoginOption = this.originalLoginOptionWithDefaults(previousAuthConfiguration, TenantLoginOptionType.BASIC);
        basicLoginOption.authenticationRestrictions =
            this.authenticationRestriction(newAuthConfiguration);
        basicLoginOption.visibleOnLoginPage = this.visibleOnLoginPage(newAuthConfiguration, TenantLoginOptionType.BASIC);
        basicLoginOption = this.removeReadOnlyFields(basicLoginOption);
        return basicLoginOption;
    }
    prepareOauthInternalLoginOption(newAuthConfiguration, previousAuthConfiguration) {
        let oauthInternalLoginOption = this.originalLoginOptionWithDefaults(previousAuthConfiguration, TenantLoginOptionType.OAUTH2_INTERNAL);
        const sessionConfiguration = this.sessionConfiguration(newAuthConfiguration);
        sessionConfiguration !== null
            ? (oauthInternalLoginOption.sessionConfiguration = sessionConfiguration)
            : delete oauthInternalLoginOption.sessionConfiguration;
        oauthInternalLoginOption.visibleOnLoginPage = this.visibleOnLoginPage(newAuthConfiguration, TenantLoginOptionType.OAUTH2_INTERNAL);
        oauthInternalLoginOption = this.removeReadOnlyFields(oauthInternalLoginOption);
        return oauthInternalLoginOption;
    }
    originalLoginOptionWithDefaults(previousAuthConfiguration, loginOptionType) {
        return defaults({}, previousAuthConfiguration.loginOptions.find(loginOption => loginOption.type === loginOptionType), this.getDefaultLoginOption(loginOptionType));
    }
    sessionConfiguration(authConfiguration) {
        return authConfiguration.loginOptions.find(this.tenantUiService.isOauthInternal)
            .sessionConfiguration;
    }
    authenticationRestriction(authConfiguration) {
        const authenticationRestrictions = authConfiguration.loginOptions.find(this.tenantUiService.isBasic).authenticationRestrictions;
        return {
            trustedUserAgents: authenticationRestrictions.trustedUserAgents.filter(value => value),
            forbiddenUserAgents: authenticationRestrictions.forbiddenUserAgents.filter(value => value),
            forbiddenClients: authenticationRestrictions.forbiddenClients.filter(value => value)
        };
    }
    visibleOnLoginPage(authConfiguration, loginOptionType) {
        return authConfiguration.preferredLoginOptionType === loginOptionType;
    }
    removeReadOnlyFields(tenantLoginOption) {
        return omit(tenantLoginOption, [
            'self',
            'strengthValidity',
            'tfaStrategy',
            'greenMinLength',
            'enforceStrength',
            'strengthValidity',
            '_type'
        ]);
    }
    prepareTenantOptions(newAuthConfiguration, previousAuthConfiguration) {
        const getValue = (authCfg, tenantOption) => authCfg.tenantOptions[tenantOption.category][tenantOption.key];
        const hasChanged = tenantOption => getValue(newAuthConfiguration, tenantOption) !==
            getValue(previousAuthConfiguration, tenantOption);
        return this.tenantOptionsWithDefaultValue
            .filter(tenantOption => getValue(newAuthConfiguration, tenantOption) !== null)
            .filter(tenantOption => hasChanged(tenantOption))
            .map(tenantOption => ({
            category: tenantOption.category,
            key: tenantOption.key,
            value: getValue(newAuthConfiguration, tenantOption).toString()
        }));
    }
    getLoginOptions$() {
        return from(this.tenantLoginOptionsService.listForCurrentTenant()).pipe(map(res => res.data), map(loginOptions => this.addDefaultLoginOptions(loginOptions)));
    }
    getPreferredLoginOptionType$(loginOptions$) {
        return loginOptions$.pipe(map(loginOptions => {
            return this.tenantUiService.getPreferredLoginOption(loginOptions).type;
        }));
    }
    addDefaultLoginOptions(loginOptions) {
        if (!loginOptions.find(this.tenantUiService.isBasic)) {
            loginOptions.push(this.getDefaultLoginOption(TenantLoginOptionType.BASIC));
        }
        if (!loginOptions.find(this.tenantUiService.isOauthInternal)) {
            loginOptions.push(this.getDefaultLoginOption(TenantLoginOptionType.OAUTH2_INTERNAL));
        }
        return loginOptions;
    }
    getTenantOptions$() {
        return forkJoin(this.tenantOptionsWithDefaultValue.map((option) => from(this.tenantOptionsService.detail(option)).pipe(map(res => res.data), catchError(() => of(option))))).pipe(map(options => this.getOptionsObject(options)));
    }
    getSystemOptions$() {
        return forkJoin(this.systemOptionsWithDefaultValue.map((option) => from(this.systemOptionsService.detail(option)).pipe(map(res => res.data), catchError(() => of(option))))).pipe(map(options => this.getOptionsObject(options)));
    }
    isSmsApplicationAvailable$() {
        return from(this.applicationService.isAvailable('sms-gateway')).pipe(map(res => res.data));
    }
    getOptionsObject(options) {
        return options.reduce((optionsObject, option) => {
            optionsObject[option.category] = optionsObject[option.category] || {};
            optionsObject[option.category][option.key] = this.getValue(option);
            return optionsObject;
        }, {});
    }
    getValue(option) {
        try {
            return JSON.parse(option.value);
        }
        catch (e) {
            return option.value;
        }
    }
    getDefaultLoginOption(tenantLoginOptionType) {
        return {
            userManagementSource: UserManagementSource.INTERNAL,
            grantType: GrantType.PASSWORD,
            providerName: 'Cumulocity',
            visibleOnLoginPage: false,
            type: tenantLoginOptionType
        };
    }
}
AuthConfigurationService.decorators = [
    { type: Injectable }
];
AuthConfigurationService.ctorParameters = () => [
    { type: TenantLoginOptionsService },
    { type: TenantOptionsService },
    { type: SystemOptionsService },
    { type: ApplicationService },
    { type: TenantUiService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1jb25maWd1cmF0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9hdXRoLWNvbmZpZ3VyYXRpb24vYXV0aC1jb25maWd1cmF0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQ0wsa0JBQWtCLEVBQ2xCLFNBQVMsRUFLVCxvQkFBb0IsRUFDcEIseUJBQXlCLEVBQ3pCLHFCQUFxQixFQUNyQixvQkFBb0IsRUFDcEIsb0JBQW9CLEVBQ3JCLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDakQsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBRTNDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUd0RCxNQUFNLE9BQU8sd0JBQXdCO0lBcUJuQyxZQUNVLHlCQUFvRCxFQUNwRCxvQkFBMEMsRUFDMUMsb0JBQTBDLEVBQzFDLGtCQUFzQyxFQUN0QyxlQUFnQztRQUpoQyw4QkFBeUIsR0FBekIseUJBQXlCLENBQTJCO1FBQ3BELHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFDMUMseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUMxQyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQXpCbEMsa0NBQTZCLEdBQW9CO1lBQ3ZELEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRTtZQUM1RCxFQUFFLFFBQVEsRUFBRSxVQUFVLEVB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LE1BQU0sRUFBRSxFQUFFO1lBQzlDLGFBQWEsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDdEUsYUFBYSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNuRSxPQUFPLGFBQWEsQ0FBQztRQUN2QixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDVCxDQUFDO0lBRU8sUUFBUSxDQUFDLE1BQXFDO1FBQ3BELElBQUk7WUFDRixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ2pDO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUM7U0FDckI7SUFDSCxDQUFDO0lBRU8scUJBQXFCLENBQUMscUJBQTRDO1FBQ3hFLE9BQU87WUFDTCxvQkFBb0IsRUFBRSxvQkFBb0IsQ0FBQyxRQUFRO1lBQ25ELFNBQVMsRUFBRSxTQUFTLENBQUMsUUFBUTtZQUM3QixZQUFZLEVBQUUsWUFBWTtZQUMxQixrQkFBa0IsRUFBRSxLQUFLO1lBQ3pCLElBQUksRUFBRSxxQkFBcUI7U0FDNUIsQ0FBQztJQUNKLENBQUM7OztZQTlQRixVQUFVOzs7WUFYVCx5QkFBeUI7WUFFekIsb0JBQW9CO1lBSHBCLG9CQUFvQjtZQU5wQixrQkFBa0I7WUFnQlgsZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEFwcGxpY2F0aW9uU2VydmljZSxcbiAgR3JhbnRUeXBlLCBJQXV0aGVudGljYXRpb25SZXN0cmljdGlvbnMsXG4gIElSZXN1bHQsIElTZXNzaW9uQ29uZmlndXJhdGlvbixcbiAgSVN5c3RlbU9wdGlvbixcbiAgSVRlbmFudExvZ2luT3B0aW9uLFxuICBJVGVuYW50T3B0aW9uLFxuICBTeXN0ZW1PcHRpb25zU2VydmljZSxcbiAgVGVuYW50TG9naW5PcHRpb25zU2VydmljZSxcbiAgVGVuYW50TG9naW5PcHRpb25UeXBlLFxuICBUZW5hbnRPcHRpb25zU2VydmljZSxcbiAgVXNlck1hbmFnZW1lbnRTb3VyY2Vcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgZm9ya0pvaW4sIGZyb20sIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWZhdWx0cywgb21pdCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBBdXRoQ29uZmlndXJhdGlvbiwgT3B0aW9ucyB9IGZyb20gJy4vYXV0aC1jb25maWd1cmF0aW9uLm1vZGVsJztcbmltcG9ydCB7IFRlbmFudFVpU2VydmljZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQXV0aENvbmZpZ3VyYXRpb25TZXJ2aWNlIHtcbiAgcHJpdmF0ZSBzeXN0ZW1PcHRpb25zV2l0aERlZmF1bHRWYWx1ZTogSVN5c3RlbU9wdGlvbltdID0gW1xuICAgIHsgY2F0ZWdvcnk6ICdwYXNzd29yZCcsIGtleTogJ2xpbWl0LnZhbGlkaXR5JywgdmFsdWU6IG51bGwgfSxcbiAgICB7IGNhdGVnb3J5OiAncGFzc3dvcmQnLCBrZXk6ICdlbmZvcmNlLnN0cmVuZ3RoJywgdmFsdWU6ICdmYWxzZScgfSxcbiAgICB7IGNhdGVnb3J5OiAndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsIGtleTogJ3RlbmFudC1zY29wZS1zZXR0aW5ncy5lbmFibGVkJywgdmFsdWU6ICdmYWxzZScgfSxcbiAgICB7IGNhdGVnb3J5OiAndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsIGtleTogJ2VuYWJsZWQnLCB2YWx1ZTogJ2ZhbHNlJyB9LFxuICAgIHsgY2F0ZWdvcnk6ICd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJywga2V5OiAnZW5mb3JjZWQnLCB2YWx1ZTogJ2ZhbHNlJyB9LFxuICAgIHsgY2F0ZWdvcnk6ICd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJywga2V5OiAnZW5mb3JjZWQuZ3JvdXAnLCB2YWx1ZTogJycgfVxuICBdO1xuXG4gIHByaXZhdGUgdGVuYW50T3B0aW9uc1dpdGhEZWZhdWx0VmFsdWU6IElUZW5hbnRPcHRpb25bXSA9IFtcbiAgICB7IGNhdGVnb3J5OiAncGFzc3dvcmQnLCBrZXk6ICdsaW1pdC52YWxpZGl0eScsIHZhbHVlOiAnMCcgfSxcbiAgICB7IGNhdGVnb3J5OiAncGFzc3dvcmQnLCBrZXk6ICdzdHJlbmd0aC52YWxpZGl0eScsIHZhbHVlOiAnZmFsc2UnIH0sXG4gICAgeyBjYXRlZ29yeTogJ3R3by1mYWN0b3ItYXV0aGVudGljYXRpb24nLCBrZXk6ICdlbmFibGVkJywgdmFsdWU6ICdmYWxzZScgfSxcbiAgICB7IGNhdGVnb3J5OiAndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsIGtleTogJ3Rva2VuLnZhbGlkaXR5JywgdmFsdWU6ICc0MzIwMCcgfSwgLy8gMzAgZGF5c1xuICAgIHsgY2F0ZWdvcnk6ICd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJywga2V5OiAncGluLnZhbGlkaXR5JywgdmFsdWU6ICczMCcgfSxcbiAgICB7IGNhdGVnb3J5OiAndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsIGtleTogJ2VuZm9yY2VkJywgdmFsdWU6ICdmYWxzZScgfSxcbiAgICB7IGNhdGVnb3J5OiAndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsIGtleTogJ3N0cmF0ZWd5JywgdmFsdWU6ICdTTVMnIH0sXG4gICAgeyBjYXRlZ29yeTogJ29hdXRoLmludGVybmFsJywga2V5OiAnYmFzaWMtdG9rZW4ubGlmZXNwYW4uc2Vjb25kcycsIHZhbHVlOiBudWxsIH1cbiAgXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHRlbmFudExvZ2luT3B0aW9uc1NlcnZpY2U6IFRlbmFudExvZ2luT3B0aW9uc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSB0ZW5hbnRPcHRpb25zU2VydmljZTogVGVuYW50T3B0aW9uc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBzeXN0ZW1PcHRpb25zU2VydmljZTogU3lzdGVtT3B0aW9uc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBhcHBsaWNhdGlvblNlcnZpY2U6IEFwcGxpY2F0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIHRlbmFudFVpU2VydmljZTogVGVuYW50VWlTZXJ2aWNlXG4gICkge31cblxuICBnZXRBdXRoQ29uZmlndXJhdGlvbiQoKTogT2JzZXJ2YWJsZTxBdXRoQ29uZmlndXJhdGlvbj4ge1xuICAgIGNvbnN0IGxvZ2luT3B0aW9ucyQgPSB0aGlzLmdldExvZ2luT3B0aW9ucyQoKTtcbiAgICByZXR1cm4gZm9ya0pvaW4oe1xuICAgICAgbG9naW5PcHRpb25zOiBsb2dpbk9wdGlvbnMkLFxuICAgICAgdGVuYW50T3B0aW9uczogdGhpcy5nZXRUZW5hbnRPcHRpb25zJCgpLFxuICAgICAgc3lzdGVtT3B0aW9uczogdGhpcy5nZXRTeXN0ZW1PcHRpb25zJCgpLFxuICAgICAgc21zR2F0ZXdheUF2YWlsYWJsZTogdGhpcy5pc1Ntc0FwcGxpY2F0aW9uQXZhaWxhYmxlJCgpLFxuICAgICAgcHJlZmVycmVkTG9naW5PcHRpb25UeXBlOiB0aGlzLmdldFByZWZlcnJlZExvZ2luT3B0aW9uVHlwZSQobG9naW5PcHRpb25zJClcbiAgICB9KTtcbiAgfVxuXG4gIHNhdmUobmV3QXV0aENvbmZpZ3VyYXRpb246IEF1dGhDb25maWd1cmF0aW9uLCBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvbikge1xuICAgIGNvbnN0IHRlbmFudE9wdGlvbnMgPSB0aGlzLnByZXBhcmVUZW5hbnRPcHRpb25zKFxuICAgICAgbmV3QXV0aENvbmZpZ3VyYXRpb24sXG4gICAgICBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uXG4gICAgKTtcbiAgICBjb25zdCB1cGRhdGVUZW5hbnRPcHRpb25zID0gdGVuYW50T3B0aW9ucy5tYXAoXG4gICAgICB0ZW5hbnRPcHRpb24gPT4gdGhpcy50ZW5hbnRPcHRpb25zU2VydmljZS5jcmVhdGUodGVuYW50T3B0aW9uKVxuICAgICk7XG4gICAgY29uc3QgYmFzaWNMb2dpbk9wdGlvbiA9IHRoaXMucHJlcGFyZUJhc2ljTG9naW5PcHRpb24oXG4gICAgICBuZXdBdXRoQ29uZmlndXJhdGlvbixcbiAgICAgIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb25cbiAgICApO1xuICAgIGNvbnN0IG9hdXRoSW50ZXJuYWxMb2dpbk9wdGlvbiA9IHRoaXMucHJlcGFyZU9hdXRoSW50ZXJuYWxMb2dpbk9wdGlvbihcbiAgICAgIG5ld0F1dGhDb25maWd1cmF0aW9uLFxuICAgICAgcHJldmlvdXNBdXRoQ29uZmlndXJhdGlvblxuICAgICk7XG5cbiAgICByZXR1cm4gUHJvbWlzZS5hbGwoW1xuICAgICAgdGhpcy5zYXZlT3JVcGRhdGVMb2dpbk9wdGlvbihiYXNpY0xvZ2luT3B0aW9uKSxcbiAgICAgIHRoaXMuc2F2ZU9yVXBkYXRlTG9naW5PcHRpb24ob2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uKSxcbiAgICAgIHVwZGF0ZVRlbmFudE9wdGlvbnNcbiAgICBdKTtcbiAgfVxuXG4gIHByaXZhdGUgc2F2ZU9yVXBkYXRlTG9naW5PcHRpb24oXG4gICAgbG9naW5PcHRpb246IElUZW5hbnRMb2dpbk9wdGlvblxuICApOiBQcm9taXNlPElSZXN1bHQ8SVRlbmFudExvZ2luT3B0aW9uPj4ge1xuICAgIHJldHVybiBsb2dpbk9wdGlvbi5pZFxuICAgICAgPyB0aGlzLnRlbmFudExvZ2luT3B0aW9uc1NlcnZpY2UudXBkYXRlKGxvZ2luT3B0aW9uKVxuICAgICAgOiB0aGlzLnRlbmFudExvZ2luT3B0aW9uc1NlcnZpY2UuY3JlYXRlKGxvZ2luT3B0aW9uKTtcbiAgfVxuXG4gIHByaXZhdGUgcHJlcGFyZUJhc2ljTG9naW5PcHRpb24oXG4gICAgbmV3QXV0aENvbmZpZ3VyYXRpb246IEF1dGhDb25maWd1cmF0aW9uLFxuICAgIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb246IEF1dGhDb25maWd1cmF0aW9uXG4gICk6IElUZW5hbnRMb2dpbk9wdGlvbiB7XG4gICAgbGV0IGJhc2ljTG9naW5PcHRpb24gPSB0aGlzLm9yaWdpbmFsTG9naW5PcHRpb25XaXRoRGVmYXVsdHMoXG4gICAgICBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uLFxuICAgICAgVGVuYW50TG9naW5PcHRpb25UeXBlLkJBU0lDXG4gICAgKTtcbiAgICBiYXNpY0xvZ2luT3B0aW9uLmF1dGhlbnRpY2F0aW9uUmVzdHJpY3Rpb25zID1cbiAgICAgIHRoaXMuYXV0aGVudGljYXRpb25SZXN0cmljdGlvbihuZXdBdXRoQ29uZmlndXJhdGlvbik7XG4gICAgYmFzaWNMb2dpbk9wdGlvbi52aXNpYmxlT25Mb2dpblBhZ2UgPSB0aGlzLnZpc2libGVPbkxvZ2luUGFnZShcbiAgICAgIG5ld0F1dGhDb25maWd1cmF0aW9uLFxuICAgICAgVGVuYW50TG9naW5PcHRpb25UeXBlLkJBU0lDXG4gICAgKTtcbiAgICBiYXNpY0xvZ2luT3B0aW9uID0gdGhpcy5yZW1vdmVSZWFkT25seUZpZWxkcyhiYXNpY0xvZ2luT3B0aW9uKTtcbiAgICByZXR1cm4gYmFzaWNMb2dpbk9wdGlvbjtcbiAgfVxuXG4gIHByaXZhdGUgcHJlcGFyZU9hdXRoSW50ZXJuYWxMb2dpbk9wdGlvbihcbiAgICBuZXdBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24sXG4gICAgcHJldmlvdXNBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb25cbiAgKTogSVRlbmFudExvZ2luT3B0aW9uIHtcbiAgICBsZXQgb2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uID0gdGhpcy5vcmlnaW5hbExvZ2luT3B0aW9uV2l0aERlZmF1bHRzKFxuICAgICAgcHJldmlvdXNBdXRoQ29uZmlndXJhdGlvbixcbiAgICAgIFRlbmFudExvZ2luT3B0aW9uVHlwZS5PQVVUSDJfSU5URVJOQUxcbiAgICApO1xuICAgIGNvbnN0IHNlc3Npb25Db25maWd1cmF0aW9uID0gdGhpcy5zZXNzaW9uQ29uZmlndXJhdGlvbihuZXdBdXRoQ29uZmlndXJhdGlvbik7XG4gICAgc2Vzc2lvbkNvbmZpZ3VyYXRpb24gIT09IG51bGxcbiAgICAgID8gKG9hdXRoSW50ZXJuYWxMb2dpbk9wdGlvbi5zZXNzaW9uQ29uZmlndXJhdGlvbiA9IHNlc3Npb25Db25maWd1cmF0aW9uKVxuICAgICAgOiBkZWxldGUgb2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uLnNlc3Npb25Db25maWd1cmF0aW9uO1xuICAgIG9hdXRoSW50ZXJuYWxMb2dpbk9wdGlvbi52aXNpYmxlT25Mb2dpblBhZ2UgPSB0aGlzLnZpc2libGVPbkxvZ2luUGFnZShcbiAgICAgIG5ld0F1dGhDb25maWd1cmF0aW9uLFxuICAgICAgVGVuYW50TG9naW5PcHRpb25UeXBlLk9BVVRIMl9JTlRFUk5BTFxuICAgICk7XG4gICAgb2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uID0gdGhpcy5yZW1vdmVSZWFkT25seUZpZWxkcyhvYXV0aEludGVybmFsTG9naW5PcHRpb24pO1xuICAgIHJldHVybiBvYXV0aEludGVybmFsTG9naW5PcHRpb247XG4gIH1cblxuICBwcml2YXRlIG9yaWdpbmFsTG9naW5PcHRpb25XaXRoRGVmYXVsdHMoXG4gICAgcHJldmlvdXNBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24sXG4gICAgbG9naW5PcHRpb25UeXBlOiBUZW5hbnRMb2dpbk9wdGlvblR5cGVcbiAgKTogSVRlbmFudExvZ2luT3B0aW9uIHtcbiAgICByZXR1cm4gZGVmYXVsdHMoXG4gICAgICB7fSxcbiAgICAgIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb24ubG9naW5PcHRpb25zLmZpbmQoXG4gICAgICAgIGxvZ2luT3B0aW9uID0+IGxvZ2luT3B0aW9uLnR5cGUgPT09IGxvZ2luT3B0aW9uVHlwZVxuICAgICAgKSxcbiAgICAgIHRoaXMuZ2V0RGVmYXVsdExvZ2luT3B0aW9uKGxvZ2luT3B0aW9uVHlwZSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXNzaW9uQ29uZmlndXJhdGlvbihhdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24pOiBJU2Vzc2lvbkNvbmZpZ3VyYXRpb24ge1xuICAgIHJldHVybiBhdXRoQ29uZmlndXJhdGlvbi5sb2dpbk9wdGlvbnMuZmluZCh0aGlzLnRlbmFudFVpU2VydmljZS5pc09hdXRoSW50ZXJuYWwpXG4gICAgICAuc2Vzc2lvbkNvbmZpZ3VyYXRpb247XG4gIH1cblxuICBwcml2YXRlIGF1dGhlbnRpY2F0aW9uUmVzdHJpY3Rpb24oYXV0aENvbmZpZ3VyYXRpb246IEF1dGhDb25maWd1cmF0aW9uKTogSUF1dGhlbnRpY2F0aW9uUmVzdHJpY3Rpb25zIHtcbiAgICBjb25zdCBhdXRoZW50aWNhdGlvblJlc3RyaWN0aW9ucyA9IGF1dGhDb25maWd1cmF0aW9uLmxvZ2luT3B0aW9ucy5maW5kKFxuICAgICAgdGhpcy50ZW5hbnRVaVNlcnZpY2UuaXNCYXNpY1xuICAgICkuYXV0aGVudGljYXRpb25SZXN0cmljdGlvbnM7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRydXN0ZWRVc2VyQWdlbnRzOiBhdXRoZW50aWNhdGlvblJlc3RyaWN0aW9ucy50cnVzdGVkVXNlckFnZW50cy5maWx0ZXIodmFsdWUgPT4gdmFsdWUpLFxuICAgICAgZm9yYmlkZGVuVXNlckFnZW50czogYXV0aGVudGljYXRpb25SZXN0cmljdGlvbnMuZm9yYmlkZGVuVXNlckFnZW50cy5maWx0ZXIodmFsdWUgPT4gdmFsdWUpLFxuICAgICAgZm9yYmlkZGVuQ2xpZW50czogYXV0aGVudGljYXRpb25SZXN0cmljdGlvbnMuZm9yYmlkZGVuQ2xpZW50cy5maWx0ZXIodmFsdWUgPT4gdmFsdWUpXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgdmlzaWJsZU9uTG9naW5QYWdlKFxuICAgIGF1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvbixcbiAgICBsb2dpbk9wdGlvblR5cGU6IFRlbmFudExvZ2luT3B0aW9uVHlwZVxuICApOiBib29sZWFuIHtcbiAgICByZXR1cm4gYXV0aENvbmZpZ3VyYXRpb24ucHJlZmVycmVkTG9naW5PcHRpb25UeXBlID09PSBsb2dpbk9wdGlvblR5cGU7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZVJlYWRPbmx5RmllbGRzKHRlbmFudExvZ2luT3B0aW9uOiBJVGVuYW50TG9naW5PcHRpb24pOiBJVGVuYW50TG9naW5PcHRpb24ge1xuICAgIHJldHVybiBvbWl0KHRlbmFudExvZ2luT3B0aW9uLCBbXG4gICAgICAnc2VsZicsXG4gICAgICAnc3RyZW5ndGhWYWxpZGl0eScsXG4gICAgICAndGZhU3RyYXRlZ3knLFxuICAgICAgJ2dyZWVuTWluTGVuZ3RoJyxcbiAgICAgICdlbmZvcmNlU3RyZW5ndGgnLFxuICAgICAgJ3N0cmVuZ3RoVmFsaWRpdHknLFxuICAgICAgJ190eXBlJ1xuICAgIF0pO1xuICB9XG5cbiAgcHJpdmF0ZSBwcmVwYXJlVGVuYW50T3B0aW9ucyhcbiAgICBuZXdBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24sXG4gICAgcHJldmlvdXNBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb25cbiAgKTogSVRlbmFudE9wdGlvbltdIHtcbiAgICBjb25zdCBnZXRWYWx1ZSA9IChhdXRoQ2ZnLCB0ZW5hbnRPcHRpb24pID0+XG4gICAgICBhdXRoQ2ZnLnRlbmFudE9wdGlvbnNbdGVuYW50T3B0aW9uLmNhdGVnb3J5XVt0ZW5hbnRPcHRpb24ua2V5XTtcbiAgICBjb25zdCBoYXNDaGFuZ2VkID0gdGVuYW50T3B0aW9uID0+XG4gICAgICBnZXRWYWx1ZShuZXdBdXRoQ29uZmlndXJhdGlvbiwgdGVuYW50T3B0aW9uKSAhPT1cbiAgICAgIGdldFZhbHVlKHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb24sIHRlbmFudE9wdGlvbik7XG5cbiAgICByZXR1cm4gdGhpcy50ZW5hbnRPcHRpb25zV2l0aERlZmF1bHRWYWx1ZVxuICAgICAgLmZpbHRlciggdGVuYW50T3B0aW9uID0+IGdldFZhbHVlKG5ld0F1dGhDb25maWd1cmF0aW9uLCB0ZW5hbnRPcHRpb24pICE9PSBudWxsKVxuICAgICAgLmZpbHRlcih0ZW5hbnRPcHRpb24gPT4gaGFzQ2hhbmdlZCh0ZW5hbnRPcHRpb24pKVxuICAgICAgLm1hcCh0ZW5hbnRPcHRpb24gPT4gKHtcbiAgICAgICAgY2F0ZWdvcnk6IHRlbmFudE9wdGlvbi5jYXRlZ29yeSxcbiAgICAgICAga2V5OiB0ZW5hbnRPcHRpb24ua2V5LFxuICAgICAgICB2YWx1ZTogZ2V0VmFsdWUobmV3QXV0aENvbmZpZ3VyYXRpb24sIHRlbmFudE9wdGlvbikudG9TdHJpbmcoKVxuICAgICAgfSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRMb2dpbk9wdGlvbnMkKCk6IE9ic2VydmFibGU8SVRlbmFudExvZ2luT3B0aW9uW10+IHtcbiAgICByZXR1cm4gZnJvbSh0aGlzLnRlbmFudExvZ2luT3B0aW9uc1NlcnZpY2UubGlzdEZvckN1cnJlbnRUZW5hbnQoKSkucGlwZShcbiAgICAgIG1hcChyZXMgPT4gcmVzLmRhdGEpLFxuICAgICAgbWFwKGxvZ2luT3B0aW9ucyA9PiB0aGlzLmFkZERlZmF1bHRMb2dpbk9wdGlvbnMobG9naW5PcHRpb25zKSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQcmVmZXJyZWRMb2dpbk9wdGlvblR5cGUkKGxvZ2luT3B0aW9ucyQ6IE9ic2VydmFibGU8SVRlbmFudExvZ2luT3B0aW9uW10+KTogT2JzZXJ2YWJsZTxUZW5hbnRMb2dpbk9wdGlvblR5cGU+IHtcbiAgICByZXR1cm4gbG9naW5PcHRpb25zJC5waXBlKFxuICAgICAgbWFwKGxvZ2luT3B0aW9ucyA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnRlbmFudFVpU2VydmljZS5nZXRQcmVmZXJyZWRMb2dpbk9wdGlvbihsb2dpbk9wdGlvbnMpLnR5cGU7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFkZERlZmF1bHRMb2dpbk9wdGlvbnMobG9naW5PcHRpb25zOiBJVGVuYW50TG9naW5PcHRpb25bXSkge1xuICAgIGlmICghbG9naW5PcHRpb25zLmZpbmQodGhpcy50ZW5hbnRVaVNlcnZpY2UuaXNCYXNpYykpIHtcbiAgICAgIGxvZ2luT3B0aW9ucy5wdXNoKHRoaXMuZ2V0RGVmYXVsdExvZ2luT3B0aW9uKFRlbmFudExvZ2luT3B0aW9uVHlwZS5CQVNJQykpO1xuICAgIH1cbiAgICBpZiAoIWxvZ2luT3B0aW9ucy5maW5kKHRoaXMudGVuYW50VWlTZXJ2aWNlLmlzT2F1dGhJbnRlcm5hbCkpIHtcbiAgICAgIGxvZ2luT3B0aW9ucy5wdXNoKHRoaXMuZ2V0RGVmYXVsdExvZ2luT3B0aW9uKFRlbmFudExvZ2luT3B0aW9uVHlwZS5PQVVUSDJfSU5URVJOQUwpKTtcbiAgICB9XG4gICAgcmV0dXJuIGxvZ2luT3B0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VGVuYW50T3B0aW9ucyQoKTogT2JzZXJ2YWJsZTxPcHRpb25zPiB7XG4gICAgcmV0dXJuIGZvcmtKb2luKFxuICAgICAgdGhpcy50ZW5hbnRPcHRpb25zV2l0aERlZmF1bHRWYWx1ZS5tYXAoKG9wdGlvbjogSVRlbmFudE9wdGlvbikgPT5cbiAgICAgICAgZnJvbSh0aGlzLnRlbmFudE9wdGlvbnNTZXJ2aWNlLmRldGFpbChvcHRpb24pKS5waXBlKFxuICAgICAgICAgIG1hcChyZXMgPT4gcmVzLmRhdGEpLFxuICAgICAgICAgIGNhdGNoRXJyb3IoKCkgPT4gb2Yob3B0aW9uKSlcbiAgICAgICAgKVxuICAgICAgKVxuICAgICkucGlwZShtYXAob3B0aW9ucyA9PiB0aGlzLmdldE9wdGlvbnNPYmplY3Qob3B0aW9ucykpKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U3lzdGVtT3B0aW9ucyQoKTogT2JzZXJ2YWJsZTxPcHRpb25zPiB7XG4gICAgcmV0dXJuIGZvcmtKb2luKFxuICAgICAgdGhpcy5zeXN0ZW1PcHRpb25zV2l0aERlZmF1bHRWYWx1ZS5tYXAoKG9wdGlvbjogSVN5c3RlbU9wdGlvbikgPT5cbiAgICAgICAgZnJvbSh0aGlzLnN5c3RlbU9wdGlvbnNTZXJ2aWNlLmRldGFpbChvcHRpb24pKS5waXBlKFxuICAgICAgICAgIG1hcChyZXMgPT4gcmVzLmRhdGEpLFxuICAgICAgICAgIGNhdGNoRXJyb3IoKCkgPT4gb2Yob3B0aW9uKSlcbiAgICAgICAgKVxuICAgICAgKVxuICAgICkucGlwZShtYXAob3B0aW9ucyA9PiB0aGlzLmdldE9wdGlvbnNPYmplY3Qob3B0aW9ucykpKTtcbiAgfVxuXG4gIHByaXZhdGUgaXNTbXNBcHBsaWNhdGlvbkF2YWlsYWJsZSQoKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIGZyb20odGhpcy5hcHBsaWNhdGlvblNlcnZpY2UuaXNBdmFpbGFibGUoJ3Ntcy1nYXRld2F5JykpLnBpcGUobWFwKHJlcyA9PiByZXMuZGF0YSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRPcHRpb25zT2JqZWN0KG9wdGlvbnM6IEFycmF5PElUZW5hbnRPcHRpb24gfCBJU3lzdGVtT3B0aW9uPikge1xuICAgIHJldHVybiBvcHRpb25zLnJlZHVjZSgob3B0aW9uc09iamVjdCwgb3B0aW9uKSA9PiB7XG4gICAgICBvcHRpb25zT2JqZWN0W29wdGlvbi5jYXRlZ29yeV0gPSBvcHRpb25zT2JqZWN0W29wdGlvbi5jYXRlZ29yeV0gfHwge307XG4gICAgICBvcHRpb25zT2JqZWN0W29wdGlvbi5jYXRlZ29yeV1bb3B0aW9uLmtleV0gPSB0aGlzLmdldFZhbHVlKG9wdGlvbik7XG4gICAgICByZXR1cm4gb3B0aW9uc09iamVjdDtcbiAgICB9LCB7fSk7XG4gIH1cblxuICBwcml2YXRlIGdldFZhbHVlKG9wdGlvbjogSVRlbmFudE9wdGlvbiB8IElTeXN0ZW1PcHRpb24pIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIEpTT04ucGFyc2Uob3B0aW9uLnZhbHVlKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gb3B0aW9uLnZhbHVlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGVmYXVsdExvZ2luT3B0aW9uKHRlbmFudExvZ2luT3B0aW9uVHlwZTogVGVuYW50TG9naW5PcHRpb25UeXBlKTogSVRlbmFudExvZ2luT3B0aW9uIHtcbiAgICByZXR1cm4ge1xuICAgICAgdXNlck1hbmFnZW1lbnRTb3VyY2U6IFVzZXJNYW5hZ2VtZW50U291cmNlLklOVEVSTkFMLFxuICAgICAgZ3JhbnRUeXBlOiBHcmFudFR5cGUuUEFTU1dPUkQsXG4gICAgICBwcm92aWRlck5hbWU6ICdDdW11bG9jaXR5JyxcbiAgICAgIHZpc2libGVPbkxvZ2luUGFnZTogZmFsc2UsXG4gICAgICB0eXBlOiB0ZW5hbnRMb2dpbk9wdGlvblR5cGVcbiAgICB9O1xuICB9XG59XG4iXX0=