import { Injectable } from '@angular/core';
import { ApplicationService, GrantType, SystemOptionsService, TenantLoginOptionsService, TenantLoginOptionType, TenantOptionsService, UserManagementSource } from '@c8y/client';
import { catchError, map } from 'rxjs/operators';
import { forkJoin, from, of } from 'rxjs';
import { defaults, omit } from 'lodash-es';
import { TenantUiService } from '@c8y/ngx-components';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/client';
import * as ɵngcc2 from '@c8y/ngx-components';
export class AuthConfigurationService {
    constructor(tenantLoginOptionsService, tenantOptionsService, systemOptionsService, applicationService, tenantUiService) {
        this.tenantLoginOptionsService = tenantLoginOptionsService;
        this.tenantOptionsService = tenantOptionsService;
        this.systemOptionsService = systemOptionsService;
        this.applicationService = applicationService;
        this.tenantUiService = tenantUiService;
        this.systemOptionsWithDefaultValue = [
            { category: 'password', key: 'limit.validity', value: null },
            { category: 'password', key: 'enforce.strength', value: 'false' },
            { category: 'two-factor-authentication', key: 'tenant-scope-settings.enabled', value: 'false' },
            { category: 'two-factor-authentication', key: 'enabled', value: 'false' },
            { category: 'two-factor-authentication', key: 'enforced', value: 'false' },
            { category: 'two-factor-authentication', key: 'enforced.group', value: '' }
        ];
        this.tenantOptionsWithDefaultValue = [
            { category: 'password', key: 'limit.validity', value: '0' },
            { category: 'password', key: 'strength.validity', value: 'false' },
            { category: 'two-factor-authentication', key: 'enabled', value: 'false' },
            { category: 'two-factor-authentication', key: 'token.validity', value: '43200' },
            { category: 'two-factor-authentication', key: 'pin.validity', value: '30' },
            { category: 'two-factor-authentication', key: 'enforced', value: 'false' },
            { category: 'two-factor-authentication', key: 'strategy', value: 'SMS' },
            { category: 'oauth.internal', key: 'basic-token.lifespan.seconds', value: null }
        ];
    }
    getAuthConfiguration$() {
        const loginOptions$ = this.getLoginOptions$();
        return forkJoin({
            loginOptions: loginOptions$,
            tenantOptions: this.getTenantOptions$(),
            systemOptions: this.getSystemOptions$(),
            smsGatewayAvailable: this.isSmsApplicationAvailable$(),
            preferredLoginOptionType: this.getPreferredLoginOptionType$(loginOptions$)
        });
    }
    save(newAuthConfiguration, previousAuthConfiguration) {
        const tenantOptions = this.prepareTenantOptions(newAuthConfiguration, previousAuthConfiguration);
        const updateTenantOptions = tenantOptions.map(tenantOption => this.tenantOptionsService.create(tenantOption));
        const basicLoginOption = this.prepareBasicLoginOption(newAuthConfiguration, previousAuthConfiguration);
        const oauthInternalLoginOption = this.prepareOauthInternalLoginOption(newAuthConfiguration, previousAuthConfiguration);
        return Promise.all([
            this.saveOrUpdateLoginOption(basicLoginOption),
            this.saveOrUpdateLoginOption(oauthInternalLoginOption),
            updateTenantOptions
        ]);
    }
    saveOrUpdateLoginOption(loginOption) {
        return loginOption.id
            ? this.tenantLoginOptionsService.update(loginOption)
            : this.tenantLoginOptionsService.create(loginOption);
    }
    prepareBasicLoginOption(newAuthConfiguration, previousAuthConfiguration) {
        let basicLoginOption = this.originalLoginOptionWithDefaults(previousAuthConfiguration, TenantLoginOptionType.BASIC);
        basicLoginOption.authenticationRestrictions =
            this.authenticationRestriction(newAuthConfiguration);
        basicLoginOption.visibleOnLoginPage = this.visibleOnLoginPage(newAuthConfiguration, TenantLoginOptionType.BASIC);
        basicLoginOption = this.removeReadOnlyFields(basicLoginOption);
        return basicLoginOption;
    }
    prepareOauthInternalLoginOption(newAuthConfiguration, previousAuthConfiguration) {
        let oauthInternalLoginOption = this.originalLoginOptionWithDefaults(previousAuthConfiguration, TenantLoginOptionType.OAUTH2_INTERNAL);
        const sessionConfiguration = this.sessionConfiguration(newAuthConfiguration);
        sessionConfiguration !== null
            ? (oauthInternalLoginOption.sessionConfiguration = sessionConfiguration)
            : delete oauthInternalLoginOption.sessionConfiguration;
        oauthInternalLoginOption.visibleOnLoginPage = this.visibleOnLoginPage(newAuthConfiguration, TenantLoginOptionType.OAUTH2_INTERNAL);
        oauthInternalLoginOption = this.removeReadOnlyFields(oauthInternalLoginOption);
        return oauthInternalLoginOption;
    }
    originalLoginOptionWithDefaults(previousAuthConfiguration, loginOptionType) {
        return defaults({}, previousAuthConfiguration.loginOptions.find(loginOption => loginOption.type === loginOptionType), this.getDefaultLoginOption(loginOptionType));
    }
    sessionConfiguration(authConfiguration) {
        return authConfiguration.loginOptions.find(this.tenantUiService.isOauthInternal)
            .sessionConfiguration;
    }
    authenticationRestriction(authConfiguration) {
        const authenticationRestrictions = authConfiguration.loginOptions.find(this.tenantUiService.isBasic).authenticationRestrictions;
        return {
            trustedUserAgents: authenticationRestrictions.trustedUserAgents.filter(value => value),
            forbiddenUserAgents: authenticationRestrictions.forbiddenUserAgents.filter(value => value),
            forbiddenClients: authenticationRestrictions.forbiddenClients.filter(value => value)
        };
    }
    visibleOnLoginPage(authConfiguration, loginOptionType) {
        return authConfiguration.preferredLoginOptionType === loginOptionType;
    }
    removeReadOnlyFields(tenantLoginOption) {
        return omit(tenantLoginOption, [
            'self',
            'strengthValidity',
            'tfaStrategy',
            'greenMinLength',
            'enforceStrength',
            'strengthValidity',
            '_type'
        ]);
    }
    prepareTenantOptions(newAuthConfiguration, previousAuthConfiguration) {
        const getValue = (authCfg, tenantOption) => authCfg.tenantOptions[tenantOption.category][tenantOption.key];
        const hasChanged = tenantOption => getValue(newAuthConfiguration, tenantOption) !==
            getValue(previousAuthConfiguration, tenantOption);
        return this.tenantOptionsWithDefaultValue
            .filter(tenantOption => getValue(newAuthConfiguration, tenantOption) !== null)
            .filter(tenantOption => hasChanged(tenantOption))
            .map(tenantOption => ({
            category: tenantOption.category,
            key: tenantOption.key,
            value: getValue(newAuthConfiguration, tenantOption).toString()
        }));
    }
    getLoginOptions$() {
        return from(this.tenantLoginOptionsService.listForCurrentTenant()).pipe(map(res => res.data), map(loginOptions => this.addDefaultLoginOptions(loginOptions)));
    }
    getPreferredLoginOptionType$(loginOptions$) {
        return loginOptions$.pipe(map(loginOptions => {
            return this.tenantUiService.getPreferredLoginOption(loginOptions).type;
        }));
    }
    addDefaultLoginOptions(loginOptions) {
        if (!loginOptions.find(this.tenantUiService.isBasic)) {
            loginOptions.push(this.getDefaultLoginOption(TenantLoginOptionType.BASIC));
        }
        if (!loginOptions.find(this.tenantUiService.isOauthInternal)) {
            loginOptions.push(this.getDefaultLoginOption(TenantLoginOptionType.OAUTH2_INTERNAL));
        }
        return loginOptions;
    }
    getTenantOptions$() {
        return forkJoin(this.tenantOptionsWithDefaultValue.map((option) => from(this.tenantOptionsService.detail(option)).pipe(map(res => res.data), catchError(() => of(option))))).pipe(map(options => this.getOptionsObject(options)));
    }
    getSystemOptions$() {
        return forkJoin(this.systemOptionsWithDefaultValue.map((option) => from(this.systemOptionsService.detail(option)).pipe(map(res => res.data), catchError(() => of(option))))).pipe(map(options => this.getOptionsObject(options)));
    }
    isSmsApplicationAvailable$() {
        return from(this.applicationService.isAvailable('sms-gateway')).pipe(map(res => res.data));
    }
    getOptionsObject(options) {
        return options.reduce((optionsObject, option) => {
            optionsObject[option.category] = optionsObject[option.category] || {};
            optionsObject[option.category][option.key] = this.getValue(option);
            return optionsObject;
        }, {});
    }
    getValue(option) {
        try {
            return JSON.parse(option.value);
        }
        catch (e) {
            return option.value;
        }
    }
    getDefaultLoginOption(tenantLoginOptionType) {
        return {
            userManagementSource: UserManagementSource.INTERNAL,
            grantType: GrantType.PASSWORD,
            providerName: 'Cumulocity',
            visibleOnLoginPage: false,
            type: tenantLoginOptionType
        };
    }
}
AuthConfigurationService.ɵfac = function AuthConfigurationService_Factory(t) { return new (t || AuthConfigurationService)(ɵngcc0.ɵɵinject(ɵngcc1.TenantLoginOptionsService), ɵngcc0.ɵɵinject(ɵngcc1.TenantOptionsService), ɵngcc0.ɵɵinject(ɵngcc1.SystemOptionsService), ɵngcc0.ɵɵinject(ɵngcc1.ApplicationService), ɵngcc0.ɵɵinject(ɵngcc2.TenantUiService)); };
AuthConfigurationService.ɵprov = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjectable({ token: AuthConfigurationService, factory: AuthConfigurationService.ɵfac });
AuthConfigurationService.ctorParameters = () => [
    { type: TenantLoginOptionsService },
    { type: TenantOptionsService },
    { type: SystemOptionsService },
    { type: ApplicationService },
    { type: TenantUiService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(AuthConfigurationService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.TenantLoginOptionsService }, { type: ɵngcc1.TenantOptionsService }, { type: ɵngcc1.SystemOptionsService }, { type: ɵngcc1.ApplicationService }, { type: ɵngcc2.TenantUiService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC1jb25maWd1cmF0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2F1dGgtY29uZmlndXJhdGlvbi9hdXRoLWNvbmZpZ3VyYXRpb24uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFDTCxrQkFBa0IsRUFDbEIsU0FBUyxFQUtULG9CQUFvQixFQUNwQix5QkFBeUIsRUFDekIscUJBQXFCLEVBQ3JCLG9CQUFvQixFQUNwQixvQkFBb0IsRUFDckIsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEQsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFM0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHFCQUFxQixDQUFDOzs7O0FBR3RELE1BQU0sT0FBTyx3QkFBd0I7QUFDckMsSUFvQkUsWUFDVSx5QkFBb0QsRUFDcEQsb0JBQTBDLEVBQzFDLG9CQUEwQyxFQUMxQyxrQkFBc0MsRUFDdEMsZUFBZ0M7QUFDekMsUUFMUyw4QkFBeUIsR0FBekIseUJBQXlCLENBQTJCO0FBQUMsUUFDckQseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtBQUFDLFFBQzNDLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7QUFBQyxRQUMzQyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO0FBQUMsUUFDdkMsb0JBQWUsR0FBZixlQUFlLENBQWlCO0FBQzVDLFFBMUJVLGtDQUE2QixHQUFvQjtBQUMzRCxZQUFJLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRTtB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ekUsWUFBTSxPQUFPLGFBQWEsQ0FBQztBQUMzQixRQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUNYLElBQUUsQ0FBQztBQUNILElBQ1UsUUFBUSxDQUFDLE1BQXFDO0FBQ3hELFFBQUksSUFBSTtBQUNSLFlBQU0sT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN0QyxTQUFLO0FBQUMsUUFBQSxPQUFPLENBQUMsRUFBRTtBQUNoQixZQUFNLE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQztBQUMxQixTQUFLO0FBQ0wsSUFBRSxDQUFDO0FBQ0gsSUFDVSxxQkFBcUIsQ0FBQyxxQkFBNEM7QUFBSSxRQUM1RSxPQUFPO0FBQ1gsWUFBTSxvQkFBb0IsRUFBRSxvQkFBb0IsQ0FBQyxRQUFRO0FBQ3pELFlBQU0sU0FBUyxFQUFFLFNBQVMsQ0FBQyxRQUFRO0FBQ25DLFlBQU0sWUFBWSxFQUFFLFlBQVk7QUFDaEMsWUFBTSxrQkFBa0IsRUFBRSxLQUFLO0FBQy9CLFlBQU0sSUFBSSxFQUFFLHFCQUFxQjtBQUNqQyxTQUFLLENBQUM7QUFDTixJQUFFLENBQUM7QUFDSDtvREEvUEMsVUFBVTtzSkFDVDtBQUFDO0FBQ1UsWUFiWCx5QkFBeUI7QUFDekIsWUFDQSxvQkFBb0I7QUFDcEIsWUFKQSxvQkFBb0I7QUFDcEIsWUFQQSxrQkFBa0I7QUFDbEIsWUFlTyxlQUFlO0FBQUc7OzsrT0FBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgQXBwbGljYXRpb25TZXJ2aWNlLFxuICBHcmFudFR5cGUsIElBdXRoZW50aWNhdGlvblJlc3RyaWN0aW9ucyxcbiAgSVJlc3VsdCwgSVNlc3Npb25Db25maWd1cmF0aW9uLFxuICBJU3lzdGVtT3B0aW9uLFxuICBJVGVuYW50TG9naW5PcHRpb24sXG4gIElUZW5hbnRPcHRpb24sXG4gIFN5c3RlbU9wdGlvbnNTZXJ2aWNlLFxuICBUZW5hbnRMb2dpbk9wdGlvbnNTZXJ2aWNlLFxuICBUZW5hbnRMb2dpbk9wdGlvblR5cGUsXG4gIFRlbmFudE9wdGlvbnNTZXJ2aWNlLFxuICBVc2VyTWFuYWdlbWVudFNvdXJjZVxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBjYXRjaEVycm9yLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBmb3JrSm9pbiwgZnJvbSwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlZmF1bHRzLCBvbWl0IH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IEF1dGhDb25maWd1cmF0aW9uLCBPcHRpb25zIH0gZnJvbSAnLi9hdXRoLWNvbmZpZ3VyYXRpb24ubW9kZWwnO1xuaW1wb3J0IHsgVGVuYW50VWlTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBBdXRoQ29uZmlndXJhdGlvblNlcnZpY2Uge1xuICBwcml2YXRlIHN5c3RlbU9wdGlvbnNXaXRoRGVmYXVsdFZhbHVlOiBJU3lzdGVtT3B0aW9uW10gPSBbXG4gICAgeyBjYXRlZ29yeTogJ3Bhc3N3b3JkJywga2V5OiAnbGltaXQudmFsaWRpdHknLCB2YWx1ZTogbnVsbCB9LFxuICAgIHsgY2F0ZWdvcnk6ICdwYXNzd29yZCcsIGtleTogJ2VuZm9yY2Uuc3RyZW5ndGgnLCB2YWx1ZTogJ2ZhbHNlJyB9LFxuICAgIHsgY2F0ZWdvcnk6ICd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJywga2V5OiAndGVuYW50LXNjb3BlLXNldHRpbmdzLmVuYWJsZWQnLCB2YWx1ZTogJ2ZhbHNlJyB9LFxuICAgIHsgY2F0ZWdvcnk6ICd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJywga2V5OiAnZW5hYmxlZCcsIHZhbHVlOiAnZmFsc2UnIH0sXG4gICAgeyBjYXRlZ29yeTogJ3R3by1mYWN0b3ItYXV0aGVudGljYXRpb24nLCBrZXk6ICdlbmZvcmNlZCcsIHZhbHVlOiAnZmFsc2UnIH0sXG4gICAgeyBjYXRlZ29yeTogJ3R3by1mYWN0b3ItYXV0aGVudGljYXRpb24nLCBrZXk6ICdlbmZvcmNlZC5ncm91cCcsIHZhbHVlOiAnJyB9XG4gIF07XG5cbiAgcHJpdmF0ZSB0ZW5hbnRPcHRpb25zV2l0aERlZmF1bHRWYWx1ZTogSVRlbmFudE9wdGlvbltdID0gW1xuICAgIHsgY2F0ZWdvcnk6ICdwYXNzd29yZCcsIGtleTogJ2xpbWl0LnZhbGlkaXR5JywgdmFsdWU6ICcwJyB9LFxuICAgIHsgY2F0ZWdvcnk6ICdwYXNzd29yZCcsIGtleTogJ3N0cmVuZ3RoLnZhbGlkaXR5JywgdmFsdWU6ICdmYWxzZScgfSxcbiAgICB7IGNhdGVnb3J5OiAndHdvLWZhY3Rvci1hdXRoZW50aWNhdGlvbicsIGtleTogJ2VuYWJsZWQnLCB2YWx1ZTogJ2ZhbHNlJyB9LFxuICAgIHsgY2F0ZWdvcnk6ICd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJywga2V5OiAndG9rZW4udmFsaWRpdHknLCB2YWx1ZTogJzQzMjAwJyB9LCAvLyAzMCBkYXlzXG4gICAgeyBjYXRlZ29yeTogJ3R3by1mYWN0b3ItYXV0aGVudGljYXRpb24nLCBrZXk6ICdwaW4udmFsaWRpdHknLCB2YWx1ZTogJzMwJyB9LFxuICAgIHsgY2F0ZWdvcnk6ICd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJywga2V5OiAnZW5mb3JjZWQnLCB2YWx1ZTogJ2ZhbHNlJyB9LFxuICAgIHsgY2F0ZWdvcnk6ICd0d28tZmFjdG9yLWF1dGhlbnRpY2F0aW9uJywga2V5OiAnc3RyYXRlZ3knLCB2YWx1ZTogJ1NNUycgfSxcbiAgICB7IGNhdGVnb3J5OiAnb2F1dGguaW50ZXJuYWwnLCBrZXk6ICdiYXNpYy10b2tlbi5saWZlc3Bhbi5zZWNvbmRzJywgdmFsdWU6IG51bGwgfVxuICBdO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdGVuYW50TG9naW5PcHRpb25zU2VydmljZTogVGVuYW50TG9naW5PcHRpb25zU2VydmljZSxcbiAgICBwcml2YXRlIHRlbmFudE9wdGlvbnNTZXJ2aWNlOiBUZW5hbnRPcHRpb25zU2VydmljZSxcbiAgICBwcml2YXRlIHN5c3RlbU9wdGlvbnNTZXJ2aWNlOiBTeXN0ZW1PcHRpb25zU2VydmljZSxcbiAgICBwcml2YXRlIGFwcGxpY2F0aW9uU2VydmljZTogQXBwbGljYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgdGVuYW50VWlTZXJ2aWNlOiBUZW5hbnRVaVNlcnZpY2VcbiAgKSB7fVxuXG4gIGdldEF1dGhDb25maWd1cmF0aW9uJCgpOiBPYnNlcnZhYmxlPEF1dGhDb25maWd1cmF0aW9uPiB7XG4gICAgY29uc3QgbG9naW5PcHRpb25zJCA9IHRoaXMuZ2V0TG9naW5PcHRpb25zJCgpO1xuICAgIHJldHVybiBmb3JrSm9pbih7XG4gICAgICBsb2dpbk9wdGlvbnM6IGxvZ2luT3B0aW9ucyQsXG4gICAgICB0ZW5hbnRPcHRpb25zOiB0aGlzLmdldFRlbmFudE9wdGlvbnMkKCksXG4gICAgICBzeXN0ZW1PcHRpb25zOiB0aGlzLmdldFN5c3RlbU9wdGlvbnMkKCksXG4gICAgICBzbXNHYXRld2F5QXZhaWxhYmxlOiB0aGlzLmlzU21zQXBwbGljYXRpb25BdmFpbGFibGUkKCksXG4gICAgICBwcmVmZXJyZWRMb2dpbk9wdGlvblR5cGU6IHRoaXMuZ2V0UHJlZmVycmVkTG9naW5PcHRpb25UeXBlJChsb2dpbk9wdGlvbnMkKVxuICAgIH0pO1xuICB9XG5cbiAgc2F2ZShuZXdBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24sIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb246IEF1dGhDb25maWd1cmF0aW9uKSB7XG4gICAgY29uc3QgdGVuYW50T3B0aW9ucyA9IHRoaXMucHJlcGFyZVRlbmFudE9wdGlvbnMoXG4gICAgICBuZXdBdXRoQ29uZmlndXJhdGlvbixcbiAgICAgIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb25cbiAgICApO1xuICAgIGNvbnN0IHVwZGF0ZVRlbmFudE9wdGlvbnMgPSB0ZW5hbnRPcHRpb25zLm1hcChcbiAgICAgIHRlbmFudE9wdGlvbiA9PiB0aGlzLnRlbmFudE9wdGlvbnNTZXJ2aWNlLmNyZWF0ZSh0ZW5hbnRPcHRpb24pXG4gICAgKTtcbiAgICBjb25zdCBiYXNpY0xvZ2luT3B0aW9uID0gdGhpcy5wcmVwYXJlQmFzaWNMb2dpbk9wdGlvbihcbiAgICAgIG5ld0F1dGhDb25maWd1cmF0aW9uLFxuICAgICAgcHJldmlvdXNBdXRoQ29uZmlndXJhdGlvblxuICAgICk7XG4gICAgY29uc3Qgb2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uID0gdGhpcy5wcmVwYXJlT2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uKFxuICAgICAgbmV3QXV0aENvbmZpZ3VyYXRpb24sXG4gICAgICBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uXG4gICAgKTtcblxuICAgIHJldHVybiBQcm9taXNlLmFsbChbXG4gICAgICB0aGlzLnNhdmVPclVwZGF0ZUxvZ2luT3B0aW9uKGJhc2ljTG9naW5PcHRpb24pLFxuICAgICAgdGhpcy5zYXZlT3JVcGRhdGVMb2dpbk9wdGlvbihvYXV0aEludGVybmFsTG9naW5PcHRpb24pLFxuICAgICAgdXBkYXRlVGVuYW50T3B0aW9uc1xuICAgIF0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzYXZlT3JVcGRhdGVMb2dpbk9wdGlvbihcbiAgICBsb2dpbk9wdGlvbjogSVRlbmFudExvZ2luT3B0aW9uXG4gICk6IFByb21pc2U8SVJlc3VsdDxJVGVuYW50TG9naW5PcHRpb24+PiB7XG4gICAgcmV0dXJuIGxvZ2luT3B0aW9uLmlkXG4gICAgICA/IHRoaXMudGVuYW50TG9naW5PcHRpb25zU2VydmljZS51cGRhdGUobG9naW5PcHRpb24pXG4gICAgICA6IHRoaXMudGVuYW50TG9naW5PcHRpb25zU2VydmljZS5jcmVhdGUobG9naW5PcHRpb24pO1xuICB9XG5cbiAgcHJpdmF0ZSBwcmVwYXJlQmFzaWNMb2dpbk9wdGlvbihcbiAgICBuZXdBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24sXG4gICAgcHJldmlvdXNBdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb25cbiAgKTogSVRlbmFudExvZ2luT3B0aW9uIHtcbiAgICBsZXQgYmFzaWNMb2dpbk9wdGlvbiA9IHRoaXMub3JpZ2luYWxMb2dpbk9wdGlvbldpdGhEZWZhdWx0cyhcbiAgICAgIHByZXZpb3VzQXV0aENvbmZpZ3VyYXRpb24sXG4gICAgICBUZW5hbnRMb2dpbk9wdGlvblR5cGUuQkFTSUNcbiAgICApO1xuICAgIGJhc2ljTG9naW5PcHRpb24uYXV0aGVudGljYXRpb25SZXN0cmljdGlvbnMgPVxuICAgICAgdGhpcy5hdXRoZW50aWNhdGlvblJlc3RyaWN0aW9uKG5ld0F1dGhDb25maWd1cmF0aW9uKTtcbiAgICBiYXNpY0xvZ2luT3B0aW9uLnZpc2libGVPbkxvZ2luUGFnZSA9IHRoaXMudmlzaWJsZU9uTG9naW5QYWdlKFxuICAgICAgbmV3QXV0aENvbmZpZ3VyYXRpb24sXG4gICAgICBUZW5hbnRMb2dpbk9wdGlvblR5cGUuQkFTSUNcbiAgICApO1xuICAgIGJhc2ljTG9naW5PcHRpb24gPSB0aGlzLnJlbW92ZVJlYWRPbmx5RmllbGRzKGJhc2ljTG9naW5PcHRpb24pO1xuICAgIHJldHVybiBiYXNpY0xvZ2luT3B0aW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBwcmVwYXJlT2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uKFxuICAgIG5ld0F1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvbixcbiAgICBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvblxuICApOiBJVGVuYW50TG9naW5PcHRpb24ge1xuICAgIGxldCBvYXV0aEludGVybmFsTG9naW5PcHRpb24gPSB0aGlzLm9yaWdpbmFsTG9naW5PcHRpb25XaXRoRGVmYXVsdHMoXG4gICAgICBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uLFxuICAgICAgVGVuYW50TG9naW5PcHRpb25UeXBlLk9BVVRIMl9JTlRFUk5BTFxuICAgICk7XG4gICAgY29uc3Qgc2Vzc2lvbkNvbmZpZ3VyYXRpb24gPSB0aGlzLnNlc3Npb25Db25maWd1cmF0aW9uKG5ld0F1dGhDb25maWd1cmF0aW9uKTtcbiAgICBzZXNzaW9uQ29uZmlndXJhdGlvbiAhPT0gbnVsbFxuICAgICAgPyAob2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uLnNlc3Npb25Db25maWd1cmF0aW9uID0gc2Vzc2lvbkNvbmZpZ3VyYXRpb24pXG4gICAgICA6IGRlbGV0ZSBvYXV0aEludGVybmFsTG9naW5PcHRpb24uc2Vzc2lvbkNvbmZpZ3VyYXRpb247XG4gICAgb2F1dGhJbnRlcm5hbExvZ2luT3B0aW9uLnZpc2libGVPbkxvZ2luUGFnZSA9IHRoaXMudmlzaWJsZU9uTG9naW5QYWdlKFxuICAgICAgbmV3QXV0aENvbmZpZ3VyYXRpb24sXG4gICAgICBUZW5hbnRMb2dpbk9wdGlvblR5cGUuT0FVVEgyX0lOVEVSTkFMXG4gICAgKTtcbiAgICBvYXV0aEludGVybmFsTG9naW5PcHRpb24gPSB0aGlzLnJlbW92ZVJlYWRPbmx5RmllbGRzKG9hdXRoSW50ZXJuYWxMb2dpbk9wdGlvbik7XG4gICAgcmV0dXJuIG9hdXRoSW50ZXJuYWxMb2dpbk9wdGlvbjtcbiAgfVxuXG4gIHByaXZhdGUgb3JpZ2luYWxMb2dpbk9wdGlvbldpdGhEZWZhdWx0cyhcbiAgICBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvbixcbiAgICBsb2dpbk9wdGlvblR5cGU6IFRlbmFudExvZ2luT3B0aW9uVHlwZVxuICApOiBJVGVuYW50TG9naW5PcHRpb24ge1xuICAgIHJldHVybiBkZWZhdWx0cyhcbiAgICAgIHt9LFxuICAgICAgcHJldmlvdXNBdXRoQ29uZmlndXJhdGlvbi5sb2dpbk9wdGlvbnMuZmluZChcbiAgICAgICAgbG9naW5PcHRpb24gPT4gbG9naW5PcHRpb24udHlwZSA9PT0gbG9naW5PcHRpb25UeXBlXG4gICAgICApLFxuICAgICAgdGhpcy5nZXREZWZhdWx0TG9naW5PcHRpb24obG9naW5PcHRpb25UeXBlKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHNlc3Npb25Db25maWd1cmF0aW9uKGF1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvbik6IElTZXNzaW9uQ29uZmlndXJhdGlvbiB7XG4gICAgcmV0dXJuIGF1dGhDb25maWd1cmF0aW9uLmxvZ2luT3B0aW9ucy5maW5kKHRoaXMudGVuYW50VWlTZXJ2aWNlLmlzT2F1dGhJbnRlcm5hbClcbiAgICAgIC5zZXNzaW9uQ29uZmlndXJhdGlvbjtcbiAgfVxuXG4gIHByaXZhdGUgYXV0aGVudGljYXRpb25SZXN0cmljdGlvbihhdXRoQ29uZmlndXJhdGlvbjogQXV0aENvbmZpZ3VyYXRpb24pOiBJQXV0aGVudGljYXRpb25SZXN0cmljdGlvbnMge1xuICAgIGNvbnN0IGF1dGhlbnRpY2F0aW9uUmVzdHJpY3Rpb25zID0gYXV0aENvbmZpZ3VyYXRpb24ubG9naW5PcHRpb25zLmZpbmQoXG4gICAgICB0aGlzLnRlbmFudFVpU2VydmljZS5pc0Jhc2ljXG4gICAgKS5hdXRoZW50aWNhdGlvblJlc3RyaWN0aW9ucztcbiAgICByZXR1cm4ge1xuICAgICAgdHJ1c3RlZFVzZXJBZ2VudHM6IGF1dGhlbnRpY2F0aW9uUmVzdHJpY3Rpb25zLnRydXN0ZWRVc2VyQWdlbnRzLmZpbHRlcih2YWx1ZSA9PiB2YWx1ZSksXG4gICAgICBmb3JiaWRkZW5Vc2VyQWdlbnRzOiBhdXRoZW50aWNhdGlvblJlc3RyaWN0aW9ucy5mb3JiaWRkZW5Vc2VyQWdlbnRzLmZpbHRlcih2YWx1ZSA9PiB2YWx1ZSksXG4gICAgICBmb3JiaWRkZW5DbGllbnRzOiBhdXRoZW50aWNhdGlvblJlc3RyaWN0aW9ucy5mb3JiaWRkZW5DbGllbnRzLmZpbHRlcih2YWx1ZSA9PiB2YWx1ZSlcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSB2aXNpYmxlT25Mb2dpblBhZ2UoXG4gICAgYXV0aENvbmZpZ3VyYXRpb246IEF1dGhDb25maWd1cmF0aW9uLFxuICAgIGxvZ2luT3B0aW9uVHlwZTogVGVuYW50TG9naW5PcHRpb25UeXBlXG4gICk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBhdXRoQ29uZmlndXJhdGlvbi5wcmVmZXJyZWRMb2dpbk9wdGlvblR5cGUgPT09IGxvZ2luT3B0aW9uVHlwZTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlUmVhZE9ubHlGaWVsZHModGVuYW50TG9naW5PcHRpb246IElUZW5hbnRMb2dpbk9wdGlvbik6IElUZW5hbnRMb2dpbk9wdGlvbiB7XG4gICAgcmV0dXJuIG9taXQodGVuYW50TG9naW5PcHRpb24sIFtcbiAgICAgICdzZWxmJyxcbiAgICAgICdzdHJlbmd0aFZhbGlkaXR5JyxcbiAgICAgICd0ZmFTdHJhdGVneScsXG4gICAgICAnZ3JlZW5NaW5MZW5ndGgnLFxuICAgICAgJ2VuZm9yY2VTdHJlbmd0aCcsXG4gICAgICAnc3RyZW5ndGhWYWxpZGl0eScsXG4gICAgICAnX3R5cGUnXG4gICAgXSk7XG4gIH1cblxuICBwcml2YXRlIHByZXBhcmVUZW5hbnRPcHRpb25zKFxuICAgIG5ld0F1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvbixcbiAgICBwcmV2aW91c0F1dGhDb25maWd1cmF0aW9uOiBBdXRoQ29uZmlndXJhdGlvblxuICApOiBJVGVuYW50T3B0aW9uW10ge1xuICAgIGNvbnN0IGdldFZhbHVlID0gKGF1dGhDZmcsIHRlbmFudE9wdGlvbikgPT5cbiAgICAgIGF1dGhDZmcudGVuYW50T3B0aW9uc1t0ZW5hbnRPcHRpb24uY2F0ZWdvcnldW3RlbmFudE9wdGlvbi5rZXldO1xuICAgIGNvbnN0IGhhc0NoYW5nZWQgPSB0ZW5hbnRPcHRpb24gPT5cbiAgICAgIGdldFZhbHVlKG5ld0F1dGhDb25maWd1cmF0aW9uLCB0ZW5hbnRPcHRpb24pICE9PVxuICAgICAgZ2V0VmFsdWUocHJldmlvdXNBdXRoQ29uZmlndXJhdGlvbiwgdGVuYW50T3B0aW9uKTtcblxuICAgIHJldHVybiB0aGlzLnRlbmFudE9wdGlvbnNXaXRoRGVmYXVsdFZhbHVlXG4gICAgICAuZmlsdGVyKCB0ZW5hbnRPcHRpb24gPT4gZ2V0VmFsdWUobmV3QXV0aENvbmZpZ3VyYXRpb24sIHRlbmFudE9wdGlvbikgIT09IG51bGwpXG4gICAgICAuZmlsdGVyKHRlbmFudE9wdGlvbiA9PiBoYXNDaGFuZ2VkKHRlbmFudE9wdGlvbikpXG4gICAgICAubWFwKHRlbmFudE9wdGlvbiA9PiAoe1xuICAgICAgICBjYXRlZ29yeTogdGVuYW50T3B0aW9uLmNhdGVnb3J5LFxuICAgICAgICBrZXk6IHRlbmFudE9wdGlvbi5rZXksXG4gICAgICAgIHZhbHVlOiBnZXRWYWx1ZShuZXdBdXRoQ29uZmlndXJhdGlvbiwgdGVuYW50T3B0aW9uKS50b1N0cmluZygpXG4gICAgICB9KSk7XG4gIH1cblxuICBwcml2YXRlIGdldExvZ2luT3B0aW9ucyQoKTogT2JzZXJ2YWJsZTxJVGVuYW50TG9naW5PcHRpb25bXT4ge1xuICAgIHJldHVybiBmcm9tKHRoaXMudGVuYW50TG9naW5PcHRpb25zU2VydmljZS5saXN0Rm9yQ3VycmVudFRlbmFudCgpKS5waXBlKFxuICAgICAgbWFwKHJlcyA9PiByZXMuZGF0YSksXG4gICAgICBtYXAobG9naW5PcHRpb25zID0+IHRoaXMuYWRkRGVmYXVsdExvZ2luT3B0aW9ucyhsb2dpbk9wdGlvbnMpKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldFByZWZlcnJlZExvZ2luT3B0aW9uVHlwZSQobG9naW5PcHRpb25zJDogT2JzZXJ2YWJsZTxJVGVuYW50TG9naW5PcHRpb25bXT4pOiBPYnNlcnZhYmxlPFRlbmFudExvZ2luT3B0aW9uVHlwZT4ge1xuICAgIHJldHVybiBsb2dpbk9wdGlvbnMkLnBpcGUoXG4gICAgICBtYXAobG9naW5PcHRpb25zID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGVuYW50VWlTZXJ2aWNlLmdldFByZWZlcnJlZExvZ2luT3B0aW9uKGxvZ2luT3B0aW9ucykudHlwZTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkRGVmYXVsdExvZ2luT3B0aW9ucyhsb2dpbk9wdGlvbnM6IElUZW5hbnRMb2dpbk9wdGlvbltdKSB7XG4gICAgaWYgKCFsb2dpbk9wdGlvbnMuZmluZCh0aGlzLnRlbmFudFVpU2VydmljZS5pc0Jhc2ljKSkge1xuICAgICAgbG9naW5PcHRpb25zLnB1c2godGhpcy5nZXREZWZhdWx0TG9naW5PcHRpb24oVGVuYW50TG9naW5PcHRpb25UeXBlLkJBU0lDKSk7XG4gICAgfVxuICAgIGlmICghbG9naW5PcHRpb25zLmZpbmQodGhpcy50ZW5hbnRVaVNlcnZpY2UuaXNPYXV0aEludGVybmFsKSkge1xuICAgICAgbG9naW5PcHRpb25zLnB1c2godGhpcy5nZXREZWZhdWx0TG9naW5PcHRpb24oVGVuYW50TG9naW5PcHRpb25UeXBlLk9BVVRIMl9JTlRFUk5BTCkpO1xuICAgIH1cbiAgICByZXR1cm4gbG9naW5PcHRpb25zO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRUZW5hbnRPcHRpb25zJCgpOiBPYnNlcnZhYmxlPE9wdGlvbnM+IHtcbiAgICByZXR1cm4gZm9ya0pvaW4oXG4gICAgICB0aGlzLnRlbmFudE9wdGlvbnNXaXRoRGVmYXVsdFZhbHVlLm1hcCgob3B0aW9uOiBJVGVuYW50T3B0aW9uKSA9PlxuICAgICAgICBmcm9tKHRoaXMudGVuYW50T3B0aW9uc1NlcnZpY2UuZGV0YWlsKG9wdGlvbikpLnBpcGUoXG4gICAgICAgICAgbWFwKHJlcyA9PiByZXMuZGF0YSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBvZihvcHRpb24pKVxuICAgICAgICApXG4gICAgICApXG4gICAgKS5waXBlKG1hcChvcHRpb25zID0+IHRoaXMuZ2V0T3B0aW9uc09iamVjdChvcHRpb25zKSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRTeXN0ZW1PcHRpb25zJCgpOiBPYnNlcnZhYmxlPE9wdGlvbnM+IHtcbiAgICByZXR1cm4gZm9ya0pvaW4oXG4gICAgICB0aGlzLnN5c3RlbU9wdGlvbnNXaXRoRGVmYXVsdFZhbHVlLm1hcCgob3B0aW9uOiBJU3lzdGVtT3B0aW9uKSA9PlxuICAgICAgICBmcm9tKHRoaXMuc3lzdGVtT3B0aW9uc1NlcnZpY2UuZGV0YWlsKG9wdGlvbikpLnBpcGUoXG4gICAgICAgICAgbWFwKHJlcyA9PiByZXMuZGF0YSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoKSA9PiBvZihvcHRpb24pKVxuICAgICAgICApXG4gICAgICApXG4gICAgKS5waXBlKG1hcChvcHRpb25zID0+IHRoaXMuZ2V0T3B0aW9uc09iamVjdChvcHRpb25zKSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc1Ntc0FwcGxpY2F0aW9uQXZhaWxhYmxlJCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gZnJvbSh0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5pc0F2YWlsYWJsZSgnc21zLWdhdGV3YXknKSkucGlwZShtYXAocmVzID0+IHJlcy5kYXRhKSk7XG4gIH1cblxuICBwcml2YXRlIGdldE9wdGlvbnNPYmplY3Qob3B0aW9uczogQXJyYXk8SVRlbmFudE9wdGlvbiB8IElTeXN0ZW1PcHRpb24+KSB7XG4gICAgcmV0dXJuIG9wdGlvbnMucmVkdWNlKChvcHRpb25zT2JqZWN0LCBvcHRpb24pID0+IHtcbiAgICAgIG9wdGlvbnNPYmplY3Rbb3B0aW9uLmNhdGVnb3J5XSA9IG9wdGlvbnNPYmplY3Rbb3B0aW9uLmNhdGVnb3J5XSB8fCB7fTtcbiAgICAgIG9wdGlvbnNPYmplY3Rbb3B0aW9uLmNhdGVnb3J5XVtvcHRpb24ua2V5XSA9IHRoaXMuZ2V0VmFsdWUob3B0aW9uKTtcbiAgICAgIHJldHVybiBvcHRpb25zT2JqZWN0O1xuICAgIH0sIHt9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VmFsdWUob3B0aW9uOiBJVGVuYW50T3B0aW9uIHwgSVN5c3RlbU9wdGlvbikge1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShvcHRpb24udmFsdWUpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiBvcHRpb24udmFsdWU7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXREZWZhdWx0TG9naW5PcHRpb24odGVuYW50TG9naW5PcHRpb25UeXBlOiBUZW5hbnRMb2dpbk9wdGlvblR5cGUpOiBJVGVuYW50TG9naW5PcHRpb24ge1xuICAgIHJldHVybiB7XG4gICAgICB1c2VyTWFuYWdlbWVudFNvdXJjZTogVXNlck1hbmFnZW1lbnRTb3VyY2UuSU5URVJOQUwsXG4gICAgICBncmFudFR5cGU6IEdyYW50VHlwZS5QQVNTV09SRCxcbiAgICAgIHByb3ZpZGVyTmFtZTogJ0N1bXVsb2NpdHknLFxuICAgICAgdmlzaWJsZU9uTG9naW5QYWdlOiBmYWxzZSxcbiAgICAgIHR5cGU6IHRlbmFudExvZ2luT3B0aW9uVHlwZVxuICAgIH07XG4gIH1cbn1cbiJdfQ==