import { __awaiter } from "tslib";
import { Component, ViewChild } from '@angular/core';
import { ApplicationService } from '@c8y/client';
import { gettext, WizardComponent } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
import { EcosystemService } from '../../ecosystem.service';
import { ApplicationPropertiesFormComponent } from '../../shared/application-properties-form.component';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../../ecosystem.service';
import * as ɵngcc2 from '@c8y/client';
import * as ɵngcc3 from '@c8y/ngx-components';
import * as ɵngcc4 from '@ngx-translate/core';
import * as ɵngcc5 from '@angular/common';
import * as ɵngcc6 from '../../shared/application-properties-form.component';

function DeployApplicationComponent_ng_container_7_p_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "p", 9);
    ɵngcc0.ɵɵtext(1);
    ɵngcc0.ɵɵpipe(2, "translate");
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r3 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(2, 1, ctx_r3.headerText), " ");
} }
function DeployApplicationComponent_ng_container_7_c8y_application_properties_form_3_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "c8y-application-properties-form", 10);
} if (rf & 2) {
    const ctx_r4 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵproperty("application", ctx_r4.newAppConfig);
} }
function DeployApplicationComponent_ng_container_7_c8y_progress_bar_4_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "c8y-progress-bar", 11);
    ɵngcc0.ɵɵpipe(1, "translate");
} if (rf & 2) {
    ɵngcc0.ɵɵproperty("message", ɵngcc0.ɵɵpipeBind1(1, 1, "Deploying\u2026"));
} }
function DeployApplicationComponent_ng_container_7_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵelementStart(1, "div", 5);
    ɵngcc0.ɵɵtemplate(2, DeployApplicationComponent_ng_container_7_p_2_Template, 3, 3, "p", 6);
    ɵngcc0.ɵɵtemplate(3, DeployApplicationComponent_ng_container_7_c8y_application_properties_form_3_Template, 1, 1, "c8y-application-properties-form", 7);
    ɵngcc0.ɵɵtemplate(4, DeployApplicationComponent_ng_container_7_c8y_progress_bar_4_Template, 2, 3, "c8y-progress-bar", 8);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("ngIf", !ctx_r0.inProgress);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", !ctx_r0.inProgress);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r0.inProgress);
} }
function DeployApplicationComponent_ng_container_8_div_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 14);
    ɵngcc0.ɵɵelementStart(1, "div", 15);
    ɵngcc0.ɵɵelement(2, "c8y-operation-result", 16);
    ɵngcc0.ɵɵpipe(3, "translate");
    ɵngcc0.ɵɵpipe(4, "translate");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r6 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵpropertyInterpolate3("text", "", ɵngcc0.ɵɵpipeBind1(3, 5, "Application"), " ", ctx_r6.package.name, " ", ɵngcc0.ɵɵpipeBind1(4, 7, "created"), "");
    ɵngcc0.ɵɵproperty("size", 84)("vertical", true);
} }
function DeployApplicationComponent_ng_container_8_ng_template_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 17);
    ɵngcc0.ɵɵelement(1, "c8y-operation-result", 18);
    ɵngcc0.ɵɵpipe(2, "translate");
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵpropertyInterpolate("text", ɵngcc0.ɵɵpipeBind1(2, 3, "Application creation failed"));
    ɵngcc0.ɵɵproperty("size", 84)("vertical", true);
} }
function DeployApplicationComponent_ng_container_8_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtemplate(1, DeployApplicationComponent_ng_container_8_div_1_Template, 5, 9, "div", 12);
    ɵngcc0.ɵɵtemplate(2, DeployApplicationComponent_ng_container_8_ng_template_2_Template, 3, 5, "ng-template", null, 13, ɵngcc0.ɵɵtemplateRefExtractor);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const _r7 = ɵngcc0.ɵɵreference(3);
    const ctx_r1 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r1.deployedWithSuccess)("ngIfElse", _r7);
} }
const _c0 = function (a0) { return { "btn-pending": a0 }; };
function DeployApplicationComponent_button_14_Template(rf, ctx) { if (rf & 1) {
    const _r10 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "button", 19);
    ɵngcc0.ɵɵlistener("click", function DeployApplicationComponent_button_14_Template_button_click_0_listener() { ɵngcc0.ɵɵrestoreView(_r10); const ctx_r9 = ɵngcc0.ɵɵnextContext(); return ctx_r9.deployApp(); });
    ɵngcc0.ɵɵpipe(1, "translate");
    ɵngcc0.ɵɵtext(2);
    ɵngcc0.ɵɵpipe(3, "translate");
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r2 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(1, 4, "Deploy"));
    ɵngcc0.ɵɵproperty("disabled", ctx_r2.inProgress)("ngClass", ɵngcc0.ɵɵpureFunction1(8, _c0, ctx_r2.inProgress));
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(3, 6, "Deploy"), " ");
} }
export class DeployApplicationComponent {
    constructor(ecosystemService, applicationService, wizardComponent, translate) {
        this.ecosystemService = ecosystemService;
        this.applicationService = applicationService;
        this.wizardComponent = wizardComponent;
        this.translate = translate;
        this.inProgress = true;
        this.isDeployed = false;
        this.deployedWithSuccess = false;
        this.descriptionTemplate = gettext('Deploy application using "{{ packageName }}" package');
    }
    ngOnInit() {
        return __awaiter(this, void 0, void 0, function* () {
            this.package = this.wizardComponent.package;
            const apps = (yield this.ecosystemService.getApplications()).data;
            this.newAppConfig = this.ecosystemService.getUniqueAppConfig(this.package, apps);
            this.headerText = this.getHeaderText();
            this.inProgress = false;
        });
    }
    deployApp() {
        return __awaiter(this, void 0, void 0, function* () {
            const formGroupValue = this.applicationPropertiesForm.formGroup.getRawValue();
            this.inProgress = true;
            const { data: clonedPkg } = yield this.applicationService.clone(this.package);
            const config = this.ecosystemService.createConfig(clonedPkg, formGroupValue);
            try {
                const { data: updatedApp } = yield this.ecosystemService.updateApp(config, true);
                if (updatedApp) {
                    yield this.ecosystemService.updateAppManifest(updatedApp, this.package);
                }
                this.deployedWithSuccess = true;
            }
            catch (error) {
                this.markAsDeployed();
                yield this.applicationService.delete(clonedPkg.id);
            }
            this.markAsDeployed();
        });
    }
    cancel() {
        this.wizardComponent.close();
    }
    markAsDeployed() {
        this.isDeployed = true;
        this.inProgress = false;
    }
    getHeaderText() {
        return this.translate.instant(this.descriptionTemplate, {
            packageName: this.package.name
        });
    }
}
DeployApplicationComponent.ɵfac = function DeployApplicationComponent_Factory(t) { return new (t || DeployApplicationComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.EcosystemService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.ApplicationService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.WizardComponent), ɵngcc0.ɵɵdirectiveInject(ɵngcc4.TranslateService)); };
DeployApplicationComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: DeployApplicationComponent, selectors: [["c8y-deploy-application"]], viewQuery: function DeployApplicationComponent_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵviewQuery(ApplicationPropertiesFormComponent, 5);
    } if (rf & 2) {
        let _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.applicationPropertiesForm = _t.first);
    } }, decls: 15, vars: 12, consts: [[1, "modal-header", "dialog-header"], ["c8yIcon", "output"], [4, "ngIf"], ["type", "button", 1, "btn", "btn-default", 3, "title", "click"], ["class", "btn btn-primary", "type", "button", 3, "disabled", "ngClass", "title", "click", 4, "ngIf"], [1, "fadeIn", "animated", "d-flex", "a-i-center", "j-c-center", "d-col", 2, "min-height", "309px"], ["class", "bg-white fit-w p-16 text-center text-medium sticky-top bg-white separator-bottom", 4, "ngIf"], ["class", "d-block fit-w bg-gray-white", 3, "application", 4, "ngIf"], ["class", "text-center", 3, "message", 4, "ngIf"], [1, "bg-white", "fit-w", "p-16", "text-center", "text-medium", "sticky-top", "bg-white", "separator-bottom"], [1, "d-block", "fit-w", "bg-gray-white", 3, "application"], [1, "text-center", 3, "message"], ["class", "modal-body fadeIn animated", "style", "min-height: 309px", 4, "ngIf", "ngIfElse"], ["failedDeploy", ""], [1, "modal-body", "fadeIn", "animated", 2, "min-height", "309px"], [1, "d-flex", "a-i-center", "j-c-center", "d-col"], ["type", "success", 1, "lead", "d-block", "m-b-16", 3, "size", "vertical", "text"], [1, "modal-body", "fadeIn", "animated", "text-center", 2, "min-height", "257px"], ["type", "error", 1, "lead", 3, "size", "vertical", "text"], ["type", "button", 1, "btn", "btn-primary", 3, "disabled", "ngClass", "title", "click"]], template: function DeployApplicationComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "c8y-wizard-header");
        ɵngcc0.ɵɵelementStart(1, "div", 0);
        ɵngcc0.ɵɵelement(2, "h1", 1);
        ɵngcc0.ɵɵelementStart(3, "h4");
        ɵngcc0.ɵɵtext(4);
        ɵngcc0.ɵɵpipe(5, "translate");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(6, "c8y-wizard-body");
        ɵngcc0.ɵɵtemplate(7, DeployApplicationComponent_ng_container_7_Template, 5, 3, "ng-container", 2);
        ɵngcc0.ɵɵtemplate(8, DeployApplicationComponent_ng_container_8_Template, 4, 2, "ng-container", 2);
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(9, "c8y-wizard-footer");
        ɵngcc0.ɵɵelementStart(10, "button", 3);
        ɵngcc0.ɵɵlistener("click", function DeployApplicationComponent_Template_button_click_10_listener() { return ctx.cancel(); });
        ɵngcc0.ɵɵpipe(11, "translate");
        ɵngcc0.ɵɵtext(12);
        ɵngcc0.ɵɵpipe(13, "translate");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵtemplate(14, DeployApplicationComponent_button_14_Template, 4, 10, "button", 4);
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵadvance(4);
        ɵngcc0.ɵɵtextInterpolate(ɵngcc0.ɵɵpipeBind1(5, 6, "Deploy application"));
        ɵngcc0.ɵɵadvance(3);
        ɵngcc0.ɵɵproperty("ngIf", !ctx.isDeployed);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.isDeployed);
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵpropertyInterpolate("title", ctx.isDeployed && ctx.deployedWithSuccess ? "Done" : ɵngcc0.ɵɵpipeBind1(11, 8, "Cancel"));
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵtextInterpolate1(" ", ctx.isDeployed && ctx.deployedWithSuccess ? "Done" : ɵngcc0.ɵɵpipeBind1(13, 10, "Cancel"), " ");
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("ngIf", !ctx.isDeployed);
    } }, directives: [ɵngcc3.WizardHeaderComponent, ɵngcc3.IconDirective, ɵngcc3.WizardBodyComponent, ɵngcc5.NgIf, ɵngcc3.WizardFooterComponent, ɵngcc6.ApplicationPropertiesFormComponent, ɵngcc3.ProgressBarComponent, ɵngcc3.ɵe, ɵngcc5.NgClass], pipes: [ɵngcc3.C8yTranslatePipe], encapsulation: 2 });
DeployApplicationComponent.ctorParameters = () => [
    { type: EcosystemService },
    { type: ApplicationService },
    { type: WizardComponent },
    { type: TranslateService }
];
DeployApplicationComponent.propDecorators = {
    applicationPropertiesForm: [{ type: ViewChild, args: [ApplicationPropertiesFormComponent,] }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(DeployApplicationComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-deploy-application',
                template: "<c8y-wizard-header>\n  <div class=\"modal-header dialog-header\">\n    <h1 c8yIcon=\"output\"></h1>\n    <h4>{{ 'Deploy application' | translate }}</h4>\n  </div>\n</c8y-wizard-header>\n\n<c8y-wizard-body>\n  <ng-container *ngIf=\"!isDeployed\">\n    <div class=\"fadeIn animated d-flex a-i-center j-c-center d-col\" style=\"min-height: 309px\">\n      <p\n        class=\"bg-white fit-w p-16 text-center text-medium sticky-top bg-white separator-bottom\"\n        *ngIf=\"!inProgress\"\n      >\n        {{ headerText | translate }}\n      </p>\n      <c8y-application-properties-form\n        *ngIf=\"!inProgress\"\n        [application]=\"newAppConfig\"\n        class=\"d-block fit-w bg-gray-white\"\n      ></c8y-application-properties-form>\n\n      <c8y-progress-bar\n        *ngIf=\"inProgress\"\n        [message]=\"'Deploying\u2026' | translate\"\n        class=\"text-center\"\n      ></c8y-progress-bar>\n    </div>\n  </ng-container>\n\n  <ng-container *ngIf=\"isDeployed\">\n    <div\n      *ngIf=\"deployedWithSuccess; else failedDeploy\"\n      class=\"modal-body fadeIn animated\"\n      style=\"min-height: 309px\"\n    >\n      <div class=\"d-flex a-i-center j-c-center d-col\">\n        <c8y-operation-result\n          type=\"success\"\n          [size]=\"84\"\n          [vertical]=\"true\"\n          text=\"{{ 'Application' | translate }} {{ package.name }} {{ 'created' | translate }}\"\n          class=\"lead d-block m-b-16\"\n        ></c8y-operation-result>\n      </div>\n    </div>\n    <ng-template #failedDeploy>\n      <div class=\"modal-body fadeIn animated text-center\" style=\"min-height: 257px\">\n        <c8y-operation-result\n          type=\"error\"\n          [size]=\"84\"\n          [vertical]=\"true\"\n          text=\"{{ 'Application creation failed' | translate }}\"\n          class=\"lead\"\n        ></c8y-operation-result>\n      </div>\n    </ng-template>\n  </ng-container>\n</c8y-wizard-body>\n\n<c8y-wizard-footer>\n  <button\n    (click)=\"cancel()\"\n    type=\"button\"\n    class=\"btn btn-default\"\n    title=\"{{ isDeployed && deployedWithSuccess ? 'Done' : ('Cancel' | translate) }}\"\n  >\n    {{ isDeployed && deployedWithSuccess ? 'Done' : ('Cancel' | translate) }}\n  </button>\n\n  <button\n    (click)=\"deployApp()\"\n    *ngIf=\"!isDeployed\"\n    [disabled]=\"inProgress\"\n    [ngClass]=\"{ 'btn-pending': inProgress }\"\n    class=\"btn btn-primary\"\n    type=\"button\"\n    title=\"{{ 'Deploy' | translate }}\"\n  >\n    {{ 'Deploy' | translate }}\n  </button>\n</c8y-wizard-footer>\n"
            }]
    }], function () { return [{ type: ɵngcc1.EcosystemService }, { type: ɵngcc2.ApplicationService }, { type: ɵngcc3.WizardComponent }, { type: ɵngcc4.TranslateService }]; }, { applicationPropertiesForm: [{
            type: ViewChild,
            args: [ApplicationPropertiesFormComponent]
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVwbG95LWFwcGxpY2F0aW9uLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vZWNvc3lzdGVtL3BhY2thZ2VzL2RlcGxveS1hcHBsaWNhdGlvbi9kZXBsb3ktYXBwbGljYXRpb24uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RCxPQUFPLEVBQUUsa0JBQWtCLEVBQWdCLE1BQU0sYUFBYSxDQUFDO0FBQy9ELE9BQU8sRUFBRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDL0QsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDM0QsT0FBTyxFQUFFLGtDQUFrQyxFQUFFLE1BQU0sb0RBQW9ELENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQU14RyxNQUFNLE9BQU8sMEJBQTBCO0FBQUcsSUFleEMsWUFDVSxnQkFBa0MsRUFDbEMsa0JBQXNDLEVBQ3RDLGVBQWdDLEVBQ2hDLFNBQTJCO0FBQ3BDLFFBSlMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtBQUFDLFFBQ25DLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7QUFBQyxRQUN2QyxvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7QUFBQyxRQUNqQyxjQUFTLEdBQVQsU0FBUyxDQUFrQjtBQUN2QyxRQW5CRSxlQUFVLEdBQVksSUFBSSxDQUFDO0FBQzdCLFFBQ0UsZUFBVSxHQUFZLEtBQUssQ0FBQztBQUM5QixRQUFFLHdCQUFtQixHQUFZLEtBQUssQ0FBQztBQUN2QyxRQUtXLHdCQUFtQixHQUFXLE9B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QUM1QixnQkFBZ0I7QUFBRztBQUFHO0FBQ1Ysd0NBY2xCLFNBQVMsU0FBQyxrQ0FBa0M7QUFDM0M7Ozs7Ozs7Ozs7b0JBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFwcGxpY2F0aW9uU2VydmljZSwgSUFwcGxpY2F0aW9uIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgZ2V0dGV4dCwgV2l6YXJkQ29tcG9uZW50IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQgeyBFY29zeXN0ZW1TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vZWNvc3lzdGVtLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXBwbGljYXRpb25Qcm9wZXJ0aWVzRm9ybUNvbXBvbmVudCB9IGZyb20gJy4uLy4uL3NoYXJlZC9hcHBsaWNhdGlvbi1wcm9wZXJ0aWVzLWZvcm0uY29tcG9uZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWRlcGxveS1hcHBsaWNhdGlvbicsXG4gIHRlbXBsYXRlVXJsOiAnLi9kZXBsb3ktYXBwbGljYXRpb24uY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIERlcGxveUFwcGxpY2F0aW9uQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgaW5Qcm9ncmVzczogYm9vbGVhbiA9IHRydWU7XG4gIHBhY2thZ2U6IElBcHBsaWNhdGlvbjtcbiAgaXNEZXBsb3llZDogYm9vbGVhbiA9IGZhbHNlO1xuICBkZXBsb3llZFdpdGhTdWNjZXNzOiBib29sZWFuID0gZmFsc2U7XG4gIG5ld0FwcENvbmZpZzogSUFwcGxpY2F0aW9uO1xuXG4gIEBWaWV3Q2hpbGQoQXBwbGljYXRpb25Qcm9wZXJ0aWVzRm9ybUNvbXBvbmVudClcbiAgYXBwbGljYXRpb25Qcm9wZXJ0aWVzRm9ybTogQXBwbGljYXRpb25Qcm9wZXJ0aWVzRm9ybUNvbXBvbmVudDtcblxuICByZWFkb25seSBkZXNjcmlwdGlvblRlbXBsYXRlOiBzdHJpbmcgPSBnZXR0ZXh0KFxuICAgICdEZXBsb3kgYXBwbGljYXRpb24gdXNpbmcgXCJ7eyBwYWNrYWdlTmFtZSB9fVwiIHBhY2thZ2UnXG4gICk7XG4gIGhlYWRlclRleHQ6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGVjb3N5c3RlbVNlcnZpY2U6IEVjb3N5c3RlbVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhcHBsaWNhdGlvblNlcnZpY2U6IEFwcGxpY2F0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIHdpemFyZENvbXBvbmVudDogV2l6YXJkQ29tcG9uZW50LFxuICAgIHByaXZhdGUgdHJhbnNsYXRlOiBUcmFuc2xhdGVTZXJ2aWNlXG4gICkge31cblxuICBhc3luYyBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnBhY2thZ2UgPSAodGhpcy53aXphcmRDb21wb25lbnQgYXMgYW55KS5wYWNrYWdlO1xuICAgIGNvbnN0IGFwcHMgPSAoYXdhaXQgdGhpcy5lY29zeXN0ZW1TZXJ2aWNlLmdldEFwcGxpY2F0aW9ucygpKS5kYXRhO1xuICAgIHRoaXMubmV3QXBwQ29uZmlnID0gdGhpcy5lY29zeXN0ZW1TZXJ2aWNlLmdldFVuaXF1ZUFwcENvbmZpZyh0aGlzLnBhY2thZ2UsIGFwcHMpO1xuICAgIHRoaXMuaGVhZGVyVGV4dCA9IHRoaXMuZ2V0SGVhZGVyVGV4dCgpO1xuICAgIHRoaXMuaW5Qcm9ncmVzcyA9IGZhbHNlO1xuICB9XG5cbiAgYXN5bmMgZGVwbG95QXBwKCkge1xuICAgIGNvbnN0IGZvcm1Hcm91cFZhbHVlID0gdGhpcy5hcHBsaWNhdGlvblByb3BlcnRpZXNGb3JtLmZvcm1Hcm91cC5nZXRSYXdWYWx1ZSgpO1xuXG4gICAgdGhpcy5pblByb2dyZXNzID0gdHJ1ZTtcblxuICAgIGNvbnN0IHsgZGF0YTogY2xvbmVkUGtnIH0gPSBhd2FpdCB0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5jbG9uZSh0aGlzLnBhY2thZ2UpO1xuICAgIGNvbnN0IGNvbmZpZyA9IHRoaXMuZWNvc3lzdGVtU2VydmljZS5jcmVhdGVDb25maWcoY2xvbmVkUGtnLCBmb3JtR3JvdXBWYWx1ZSk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBkYXRhOiB1cGRhdGVkQXBwIH0gPSBhd2FpdCB0aGlzLmVjb3N5c3RlbVNlcnZpY2UudXBkYXRlQXBwKGNvbmZpZywgdHJ1ZSk7XG5cbiAgICAgIGlmICh1cGRhdGVkQXBwKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuZWNvc3lzdGVtU2VydmljZS51cGRhdGVBcHBNYW5pZmVzdCh1cGRhdGVkQXBwLCB0aGlzLnBhY2thZ2UpO1xuICAgICAgfVxuICAgICAgdGhpcy5kZXBsb3llZFdpdGhTdWNjZXNzID0gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5tYXJrQXNEZXBsb3llZCgpO1xuICAgICAgYXdhaXQgdGhpcy5hcHBsaWNhdGlvblNlcnZpY2UuZGVsZXRlKGNsb25lZFBrZy5pZCk7XG4gICAgfVxuICAgIHRoaXMubWFya0FzRGVwbG95ZWQoKTtcbiAgfVxuXG4gIGNhbmNlbCgpIHtcbiAgICB0aGlzLndpemFyZENvbXBvbmVudC5jbG9zZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBtYXJrQXNEZXBsb3llZCgpIHtcbiAgICB0aGlzLmlzRGVwbG95ZWQgPSB0cnVlO1xuICAgIHRoaXMuaW5Qcm9ncmVzcyA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRIZWFkZXJUZXh0KCkge1xuICAgIHJldHVybiB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KHRoaXMuZGVzY3JpcHRpb25UZW1wbGF0ZSwge1xuICAgICAgcGFja2FnZU5hbWU6IHRoaXMucGFja2FnZS5uYW1lXG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==