import { __awaiter } from "tslib";
import { Component } from '@angular/core';
import { BehaviorSubject, combineLatest } from 'rxjs';
import { ActivatedRoute } from '@angular/router';
import { EcosystemService } from '../../ecosystem.service';
import { BsModalService } from 'ngx-bootstrap/modal';
import { InstallPluginComponent } from './install-plugin.component';
import { AlertService, gettext, ModalService, PluginsService, Status } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
import { map, shareReplay } from 'rxjs/operators';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/router';
import * as ɵngcc2 from '../../ecosystem.service';
import * as ɵngcc3 from 'ngx-bootstrap/modal';
import * as ɵngcc4 from '@c8y/ngx-components';
import * as ɵngcc5 from '@ngx-translate/core';
import * as ɵngcc6 from './plugin-list.component';
import * as ɵngcc7 from '@angular/common';

const _c0 = function (a0) { return { "btn-pending": a0 }; };
export class ApplicationPluginsComponent {
    constructor(activatedRoute, ecosystemService, bsModalService, modal, translateService, pluginsService, alertService) {
        this.activatedRoute = activatedRoute;
        this.ecosystemService = ecosystemService;
        this.bsModalService = bsModalService;
        this.modal = modal;
        this.translateService = translateService;
        this.pluginsService = pluginsService;
        this.alertService = alertService;
        this.exportedPlugins$ = new BehaviorSubject([]);
        this.remotePlugins$ = new BehaviorSubject({});
        this.allAvailablePlugins$ = new BehaviorSubject([]);
        this.installedPlugins$ = combineLatest([
            this.remotePlugins$.pipe(map((remotes) => this.getRemotePluginsList(remotes))),
            this.allAvailablePlugins$
        ]).pipe(map(([remotePlugins, allPlugins]) => allPlugins.filter((p) => remotePlugins.includes(p.id))), shareReplay(1));
        this.pluginsToDelete = [];
        this.archives = [];
    }
    ngOnInit() {
        return __awaiter(this, void 0, void 0, function* () {
            const { id } = this.activatedRoute.snapshot.parent.data.contextData;
            this.app = yield this.ecosystemService.getApplication(id);
            this.archives = yield this.ecosystemService.listArchives(this.app.id);
            this.archives.sort((a, b) => {
                return new Date(b.created) - new Date(a.created);
            });
            const manifest = this.app.manifest;
            if (manifest) {
                const exports = manifest.exports || [];
                this.exportedPlugins$.next(this.extendPluginList(exports, this.app.contextPath));
                const remotes = manifest.remotes || {};
                this.remotePlugins$.next(remotes);
            }
            this.allAvailablePlugins$.next(yield this.getAllPlugins());
        });
    }
    installPlugins() {
        return __awaiter(this, void 0, void 0, function* () {
            const initialState = {
                plugins$: combineLatest([
                    this.allAvailablePlugins$,
                    this.installedPlugins$.pipe(map((plugins) => plugins.map((p) => p.id))),
                    this.exportedPlugins$.pipe(map((plugins) => plugins.map((p) => p.id)))
                ]).pipe(map(([allPlugins, installedPlugins, exportedPluginNames]) => {
                    const plugins = [];
                    allPlugins
                        .filter((p) => !exportedPluginNames.includes(p.id))
                        .forEach((p) => plugins.push(Object.assign(Object.assign({}, p), { installed: !!installedPlugins.includes(p.id) })));
                    return plugins;
                }), shareReplay(1))
            };
            try {
                const pluginsToAdd = (yield this.bsModalService.show(InstallPluginComponent, {
                    class: 'modal-md',
                    initialState,
                    ignoreBackdropClick: true
                }).content.result);
                const currentRemotes = Object.assign({}, this.remotePlugins$.value);
                pluginsToAdd.forEach((pluginId) => {
                    const { contextPath, name } = this.parsePluginId(pluginId);
                    (currentRemotes[contextPath] = currentRemotes[contextPath] || []).push(name);
                });
                if (this.archives.length === 6) {
                    yield this.ecosystemService.removeOldestArchive(this.app, this.archives);
                }
                this.updateApplicationRemotes(currentRemotes);
            }
            catch (ex) {
                // intended empty
            }
        });
    }
    removePlugins() {
        return __awaiter(this, void 0, void 0, function* () {
            const humanizedAppName = yield this.ecosystemService.getHumanizedAppName(this.app);
            try {
                yield this.modal.confirm(gettext('Remove plugins'), this.translateService.instant(gettext(`You are about to remove plugins from application "{{ humanizedAppName }}". The operation may take several minutes. During this time the application may be unavailable. Do you want to proceed?`), { humanizedAppName }), Status.DANGER, {
                    ok: gettext('Remove'),
                    cancel: gettext('Cancel')
                });
                const remotes = Object.assign({}, this.remotePlugins$.value);
                this.pluginsToDelete.forEach((pluginId) => {
                    const { contextPath, name } = this.parsePluginId(pluginId);
                    remotes[contextPath] = remotes[contextPath].filter((p) => p !== name);
                });
                this.updateApplicationRemotes(remotes);
            }
            catch (ex) {
                // do nothing
            }
        });
    }
    getAllPlugins() {
        return __awaiter(this, void 0, void 0, function* () {
            const plugins = [];
            const packages = yield this.ecosystemService.getPackageApplications();
            const apps = [...packages, this.app];
            apps.forEach((app) => {
                const exports = (app.manifest && app.manifest.exports) || [];
                plugins.push(...this.extendPluginList(exports, app.contextPath));
            });
            return plugins;
        });
    }
    updateApplicationRemotes(remotes) {
        return __awaiter(this, void 0, void 0, function* () {
            this.isLoading = true;
            try {
                yield this.pluginsService.updateRemotesInCumulocityJson(this.app, remotes);
                this.remotePlugins$.next(remotes);
            }
            catch (ex) {
                this.alertService.danger(ex);
            }
            finally {
                this.isLoading = false;
            }
        });
    }
    getRemotePluginsList(remotes) {
        const importContextPaths = Object.keys(remotes);
        const plugins = [];
        importContextPaths.forEach((contextPath) => {
            const moduleNames = remotes[contextPath];
            plugins.push(...moduleNames.map((module) => this.createPluginId(contextPath, module)));
        });
        return plugins;
    }
    extendPluginList(plugins, contextPath) {
        const extendedPlugins = [];
        plugins.map((p) => {
            extendedPlugins.push(Object.assign(Object.assign({}, p), { id: this.createPluginId(contextPath, p.name, p.module), contextPath }));
        });
        return extendedPlugins;
    }
    createPluginId(contextPath, pluginName, pluginModuleName) {
        return `${contextPath}/${pluginModuleName || pluginName}`;
    }
    parsePluginId(id) {
        const [contextPath, name] = id.split('/');
        return { contextPath, name };
    }
}
ApplicationPluginsComponent.ɵfac = function ApplicationPluginsComponent_Factory(t) { return new (t || ApplicationPluginsComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ActivatedRoute), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.EcosystemService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.BsModalService), ɵngcc0.ɵɵdirectiveInject(ɵngcc4.ModalService), ɵngcc0.ɵɵdirectiveInject(ɵngcc5.TranslateService), ɵngcc0.ɵɵdirectiveInject(ɵngcc4.PluginsService), ɵngcc0.ɵɵdirectiveInject(ɵngcc4.AlertService)); };
ApplicationPluginsComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: ApplicationPluginsComponent, selectors: [["c8y-app-plugins"]], decls: 47, vars: 46, consts: [[3, "icon", "label"], [3, "icon", "label", "path"], [3, "label"], [1, "card", "content-fullpage", "d-grid", "grid__col--6-6--md"], [1, "inner-scroll", "bg-gray-white"], [1, "card-header", "large-padding", "separator", "sticky-top"], ["translate", "", 1, "card-title"], [1, "card-block", "large-padding"], [1, "d-flex", "a-i-start", "p-b-16"], ["c8yIcon", "info-circle", 1, "text-info", "m-r-8", "icon-20"], ["translate", ""], [1, "separator-top", "d-block", 3, "emptyListText", "plugins$"], [1, "content-fullpage", "d-flex", "d-col"], [1, "card-header", "large-padding", "separator"], [1, "inner-scroll", "flex-grow"], [1, "separator-top", "d-block", 3, "emptyListText", "plugins$", "selectable", "selectedItems"], [1, "card-footer", "large-padding", "separator"], ["translate", "", 1, "btn", "btn-default", 3, "disabled", "title", "click"], ["translate", "", 1, "btn", "btn-default", 3, "ngClass", "title", "click"]], template: function ApplicationPluginsComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "c8y-title");
        ɵngcc0.ɵɵtext(1);
        ɵngcc0.ɵɵpipe(2, "async");
        ɵngcc0.ɵɵpipe(3, "humanizeAppName");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(4, "c8y-breadcrumb");
        ɵngcc0.ɵɵelement(5, "c8y-breadcrumb-item", 0);
        ɵngcc0.ɵɵpipe(6, "translate");
        ɵngcc0.ɵɵelement(7, "c8y-breadcrumb-item", 1);
        ɵngcc0.ɵɵpipe(8, "translate");
        ɵngcc0.ɵɵelement(9, "c8y-breadcrumb-item", 1);
        ɵngcc0.ɵɵpipe(10, "translate");
        ɵngcc0.ɵɵelement(11, "c8y-breadcrumb-item", 2);
        ɵngcc0.ɵɵpipe(12, "async");
        ɵngcc0.ɵɵpipe(13, "humanizeAppName");
        ɵngcc0.ɵɵelement(14, "c8y-breadcrumb-item", 2);
        ɵngcc0.ɵɵpipe(15, "translate");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(16, "div", 3);
        ɵngcc0.ɵɵelementStart(17, "div", 4);
        ɵngcc0.ɵɵelementStart(18, "div", 5);
        ɵngcc0.ɵɵelementStart(19, "h4", 6);
        ɵngcc0.ɵɵtext(20, "Included plugins");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(21, "div", 7);
        ɵngcc0.ɵɵelementStart(22, "p", 8);
        ɵngcc0.ɵɵelement(23, "i", 9);
        ɵngcc0.ɵɵelementStart(24, "span", 10);
        ɵngcc0.ɵɵtext(25, " Plugins included with the application. These plugins are required for running the application and cannot be removed. ");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelement(26, "c8y-plugin-list", 11);
        ɵngcc0.ɵɵpipe(27, "translate");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(28, "div", 12);
        ɵngcc0.ɵɵelementStart(29, "div", 13);
        ɵngcc0.ɵɵelementStart(30, "h4", 6);
        ɵngcc0.ɵɵtext(31, "Installed plugins");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(32, "div", 14);
        ɵngcc0.ɵɵelementStart(33, "div", 7);
        ɵngcc0.ɵɵelementStart(34, "p", 8);
        ɵngcc0.ɵɵelement(35, "i", 9);
        ɵngcc0.ɵɵelementStart(36, "span", 10);
        ɵngcc0.ɵɵtext(37, " Plugins currently installed for this application. Upgrading the application won't change any of these plugins. ");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(38, "c8y-plugin-list", 15);
        ɵngcc0.ɵɵlistener("selectedItems", function ApplicationPluginsComponent_Template_c8y_plugin_list_selectedItems_38_listener($event) { return ctx.pluginsToDelete = $event; });
        ɵngcc0.ɵɵpipe(39, "translate");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(40, "div", 16);
        ɵngcc0.ɵɵelementStart(41, "button", 17);
        ɵngcc0.ɵɵlistener("click", function ApplicationPluginsComponent_Template_button_click_41_listener() { return ctx.removePlugins(); });
        ɵngcc0.ɵɵpipe(42, "translate");
        ɵngcc0.ɵɵtext(43, " Remove plugins ");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(44, "button", 18);
        ɵngcc0.ɵɵlistener("click", function ApplicationPluginsComponent_Template_button_click_44_listener() { return ctx.installPlugins(); });
        ɵngcc0.ɵɵpipe(45, "translate");
        ɵngcc0.ɵɵtext(46, " Install plugins ");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵtextInterpolate(ɵngcc0.ɵɵpipeBind1(2, 20, ɵngcc0.ɵɵpipeBind1(3, 22, ctx.app)));
        ɵngcc0.ɵɵadvance(4);
        ɵngcc0.ɵɵproperty("icon", "c8y-atom")("label", ɵngcc0.ɵɵpipeBind1(6, 24, "Ecosystem"));
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("icon", "c8y-modules")("label", ɵngcc0.ɵɵpipeBind1(8, 26, "Applications"))("path", "ecosystem/applications");
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("icon", "c8y-modules")("label", ɵngcc0.ɵɵpipeBind1(10, 28, "All applications"))("path", "ecosystem/applications");
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("label", ɵngcc0.ɵɵpipeBind1(12, 30, ɵngcc0.ɵɵpipeBind1(13, 32, ctx.app)));
        ɵngcc0.ɵɵadvance(3);
        ɵngcc0.ɵɵproperty("label", ɵngcc0.ɵɵpipeBind1(15, 34, "Plugins"));
        ɵngcc0.ɵɵadvance(12);
        ɵngcc0.ɵɵproperty("emptyListText", ɵngcc0.ɵɵpipeBind1(27, 36, "This application doesn't contain plugins."))("plugins$", ctx.exportedPlugins$);
        ɵngcc0.ɵɵadvance(12);
        ɵngcc0.ɵɵproperty("emptyListText", ɵngcc0.ɵɵpipeBind1(39, 38, "No plugins installed"))("plugins$", ctx.installedPlugins$)("selectable", true);
        ɵngcc0.ɵɵadvance(3);
        ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(42, 40, "Remove plugins"));
        ɵngcc0.ɵɵproperty("disabled", ctx.pluginsToDelete.length === 0 || ctx.isLoading);
        ɵngcc0.ɵɵadvance(3);
        ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(45, 42, "Install plugins"));
        ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction1(44, _c0, ctx.isLoading));
    } }, directives: [ɵngcc4.TitleComponent, ɵngcc4.BreadcrumbComponent, ɵngcc4.BreadcrumbItemComponent, ɵngcc4.C8yTranslateDirective, ɵngcc4.IconDirective, ɵngcc6.PluginListComponent, ɵngcc7.NgClass], pipes: [ɵngcc7.AsyncPipe, ɵngcc4.HumanizeAppNamePipe, ɵngcc4.C8yTranslatePipe], encapsulation: 2 });
ApplicationPluginsComponent.ctorParameters = () => [
    { type: ActivatedRoute },
    { type: EcosystemService },
    { type: BsModalService },
    { type: ModalService },
    { type: TranslateService },
    { type: PluginsService },
    { type: AlertService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(ApplicationPluginsComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-app-plugins',
                template: "<c8y-title>{{ app | humanizeAppName | async }}</c8y-title>\n\n<c8y-breadcrumb>\n  <c8y-breadcrumb-item [icon]=\"'c8y-atom'\" [label]=\"'Ecosystem' | translate\"></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item\n    [icon]=\"'c8y-modules'\"\n    [label]=\"'Applications' | translate\"\n    [path]=\"'ecosystem/applications'\"\n  ></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item\n    [icon]=\"'c8y-modules'\"\n    [label]=\"'All applications' | translate\"\n    [path]=\"'ecosystem/applications'\"\n  ></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item [label]=\"app | humanizeAppName | async\"></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item [label]=\"'Plugins' | translate\"></c8y-breadcrumb-item>\n</c8y-breadcrumb>\n\n<div class=\"card content-fullpage d-grid grid__col--6-6--md\">\n  <div class=\"inner-scroll bg-gray-white\">\n    <div class=\"card-header large-padding separator sticky-top\">\n      <h4 class=\"card-title\" translate>Included plugins</h4>\n    </div>\n    <div class=\"card-block large-padding\">\n      <p class=\"d-flex a-i-start p-b-16\">\n        <i c8yIcon=\"info-circle\" class=\"text-info m-r-8 icon-20\"></i>\n        <span translate>\n          Plugins included with the application. These plugins are required for running the\n          application and cannot be removed.\n        </span>\n      </p>\n      <c8y-plugin-list\n        [emptyListText]=\"'This application doesn\\'t contain plugins.' | translate\"\n        [plugins$]=\"exportedPlugins$\"\n        class=\"separator-top d-block\"\n      ></c8y-plugin-list>\n    </div>\n  </div>\n\n  <div class=\"content-fullpage d-flex d-col\">\n    <div class=\"card-header large-padding separator\">\n      <h4 class=\"card-title\" translate>Installed plugins</h4>\n    </div>\n    <div class=\"inner-scroll flex-grow\">\n      <div class=\"card-block large-padding\">\n        <p class=\"d-flex a-i-start p-b-16\">\n          <i c8yIcon=\"info-circle\" class=\"text-info m-r-8 icon-20\"></i>\n          <span translate>\n            Plugins currently installed for this application. Upgrading the application won't change\n            any of these plugins.\n          </span>\n        </p>\n        <c8y-plugin-list\n          (selectedItems)=\"pluginsToDelete = $event\"\n          [emptyListText]=\"'No plugins installed' | translate\"\n          [plugins$]=\"installedPlugins$\"\n          [selectable]=\"true\"\n          class=\"separator-top d-block\"\n        ></c8y-plugin-list>\n      </div>\n    </div>\n\n    <div class=\"card-footer large-padding separator\">\n      <button\n        (click)=\"removePlugins()\"\n        [disabled]=\"pluginsToDelete.length === 0 || isLoading\"\n        class=\"btn btn-default\"\n        title=\"{{ 'Remove plugins' | translate }}\"\n        translate\n      >\n        Remove plugins\n      </button>\n      <button\n        (click)=\"installPlugins()\"\n        [ngClass]=\"{ 'btn-pending': isLoading }\"\n        class=\"btn btn-default\"\n        title=\"{{ 'Install plugins' | translate }}\"\n        translate\n      >\n        Install plugins\n      </button>\n    </div>\n  </div>\n</div>\n"
            }]
    }], function () { return [{ type: ɵngcc1.ActivatedRoute }, { type: ɵngcc2.EcosystemService }, { type: ɵngcc3.BsModalService }, { type: ɵngcc4.ModalService }, { type: ɵngcc5.TranslateService }, { type: ɵngcc4.PluginsService }, { type: ɵngcc4.AlertService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24tcGx1Z2lucy5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2Vjb3N5c3RlbS9hcHBsaWNhdGlvbnMvYXBwbGljYXRpb24tcGx1Z2lucy9hcHBsaWNhdGlvbi1wbHVnaW5zLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUNsRCxPQUFPLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUVsRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDakQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFFM0QsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxjQUFjLEVBQUUsTUFBTSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbEcsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7Ozs7Ozs7QUFNbEQsTUFBTSxPQUFPLDJCQUEyQjtBQUFHLElBaUJ6QyxZQUNVLGNBQThCLEVBQzlCLGdCQUFrQyxFQUNsQyxjQUE4QixFQUM5QixLQUFtQixFQUNuQixnQkFBa0MsRUFDbEMsY0FBOEIsRUFDOUIsWUFBMEI7QUFDbkMsUUFQUyxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7QUFBQyxRQUMvQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO0FBQUMsUUFDbkMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO0FBQUMsUUFDL0IsVUFBSyxHQUFMLEtBQUssQ0FBYztBQUFDLFFBQ3BCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7QUFBQyxRQUNuQyxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7QUFBQyxRQUMvQixpQkFBWSxHQUFaLFlBQVksQ0FBYztBQUN0QyxRQXhCRSxxQkFBZ0IsR0FBeUMsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDbkYsUUFBRSxtQkFBYyxHQUE4QyxJQUFJLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN0RixRQUFFLHlCQUFvQixHQUF5QyxJQUFJLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN2RixRQUNFLHNCQUFpQixHQUFvQyxhQUFhLENBQUM7QUFDckUsWUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0FBQ2xGLFlBQUksSUFBSSxDQUFDLG9CQUFvQjtBQUM3QixTQUFHLENBQUMsQ0FBQyxJQUFJLENBQ0wsR0FBRyxDQUFDLENBQUMsQ0FBQyxhQUFhLEVBQUUsVUFBVSxDQUFDLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFDNUYsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUNmLENBQUM7QUFDSixRQUVFLG9CQUFlLEdBQWEsRUFBRSxDQUFDO0FBQ2pDLFFBQUUsYUFBUSxHQUF5QixFQUFFLENBQUM7QUFDdEMsSUFTSyxDQUFDO0FBQ04sSUFDUSxRQUFRO0FBQ2hCO0FBQThELFlBQTFELE1BQU0sRUFBRSxFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQztBQUN4RSxZQUFJLElBQUksQ0FBQyxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzlELFlBQUksSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUMxRSxZQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQ2hDLGdCQUFNLE9BQVEsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBUyxHQUFJLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQVMsQ0FBQztBQUN6RSxZQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ1AsWUFBSSxNQUFNLFFBQVEsR0FBdUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUM7QUFDM0QsWUFBSSxJQUFJLFFBQVEsRUFBRTtBQUNsQixnQkFBTSxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQztBQUM3QyxnQkFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO0FBQ3ZGLGdCQUFNLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDO0FBQzdDLGdCQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ3hDLGFBQUs7QUFDTCxZQUFJLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQztBQUMvRCxRQUFFLENBQUM7QUFFRixLQUZFO0FBQ0gsSUFDUSxjQUFjO0FBQ3RCO0FBQzhCLFlBRDFCLE1BQU0sWUFBWSxHQUFRO0FBQzlCLGdCQUFNLFFBQVEsRUFBRSxhQUFhLENBQUM7QUFDOUIsb0JBQVEsSUFBSSxDQUFDLG9CQUFvQjtBQUNqQyxvQkFBUSxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7QUFDL0Usb0JBQVEsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzlFLGlCQUFPLENBQUMsQ0FBQyxJQUFJLENBQ0wsR0FBRyxDQUFDLENBQUMsQ0FBQyxVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsbUJBQW1CLENBQUMsRUFBRSxFQUFFO0FBQ3BFLG9CQUFVLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQztBQUM3QixvQkFBVSxVQUFVO0FBQ3BCLHlCQUFhLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQy9ELHlCQUFhLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksaUNBQU0sQ0FBQyxLQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBRyxDQUFDLENBQUM7QUFDbEcsb0JBQVUsT0FBTyxPQUFPLENBQUM7QUFDekIsZ0JBQVEsQ0FBQyxDQUFDLEVBQ0YsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUNmO0FBQ1AsYUFBSyxDQUFDO0FBQ04sWUFDSSxJQUFJO0FBQ1IsZ0JBQU0sTUFBTSxZQUFZLEdBQWEsQ0FBQyxNQUM5QixJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsRUFBRTtBQUN6RCxvQkFBVSxLQUFLLEVBQUUsVUFBVTtBQUMzQixvQkFBVSxZQUFZO0FBQ3RCLG9CQUFVLG1CQUFtQixFQUFFLElBQUk7QUFDbkMsaUJBQVMsQ0FBQyxDQUFDLE9BQ0osQ0FBQyxNQUFNLENBQW9CLENBQUM7QUFDbkMsZ0JBQ00sTUFBTSxjQUFjLHFCQUFRLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFFLENBQUM7QUFDOUQsZ0JBQU0sWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFO0FBQ3hDLG9CQUFRLE1BQU0sRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNuRSxvQkFBUSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsR0FBRyxjQUFjLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3JGLGdCQUFNLENBQUMsQ0FBQyxDQUFDO0FBQ1QsZ0JBQU0sSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7QUFDdEMsb0JBQVEsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDakYsaUJBQU87QUFDUCxnQkFBTSxJQUFJLENBQUMsd0JBQXdCLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDcEQsYUFBSztBQUFDLFlBQUEsT0FBTyxFQUFFLEVBQUU7QUFDakIsZ0JBQU0saUJBQWlCO0FBQ3ZCLGFBQUs7QUFDTCxRQUFFLENBQUM7QUFFRixLQUZFO0FBQ0gsSUFDUSxhQUFhO0FBQ3JCO0FBQThELFlBQTFELE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3ZGLFlBQUksSUFBSTtBQUNSLGdCQUFNLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQ3RCLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxFQUN6QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUMzQixPQUFPLENBQ0wsaU1BQWlNLENBQ2xNLEVBQ0QsRUFBRSxnQkFBZ0IsRUFBRSxDQUNyQixFQUNELE1BQU0sQ0FBQyxNQUFNLEVBQ2I7QUFDUixvQkFBVSxFQUFFLEVBQUUsT0FBTyxDQUFDLFFBQVEsQ0FBQztBQUMvQixvQkFBVSxNQUFNLEVBQUUsT0FBTyxDQUFDLFFBQVEsQ0FBQztBQUNuQyxpQkFBUyxDQUNGLENBQUM7QUFDUixnQkFDTSxNQUFNLE9BQU8scUJBQVEsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUUsQ0FBQztBQUN2RCxnQkFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFO0FBQ2hELG9CQUFRLE1BQU0sRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNuRSxvQkFBUSxPQUFPLENBQUMsV0FBVyxDQUFDLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDO0FBQzlFLGdCQUFNLENBQUMsQ0FBQyxDQUFDO0FBQ1QsZ0JBQU0sSUFBSSxDQUFDLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzdDLGFBQUs7QUFBQyxZQUFBLE9BQU8sRUFBRSxFQUFFO0FBQ2pCLGdCQUFNLGFBQWE7QUFDbkIsYUFBSztBQUNMLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSCxJQUNnQixhQUFhO0FBQUs7QUFFMUIsWUFESixNQUFNLE9BQU8sR0FBRyxFQUFFLENBQUM7QUFDdkIsWUFBSSxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO0FBQzFFLFlBQUksTUFBTSxJQUFJLEdBQUcsQ0FBQyxHQUFHLFFBQVEsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDekMsWUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7QUFDekIsZ0JBQU0sTUFBTSxPQUFPLEdBQUcsQ0FBQyxHQUFHLENBQUMsUUFBUSxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ25FLGdCQUFNLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO0FBQ3ZFLFlBQUksQ0FBQyxDQUFDLENBQUM7QUFDUCxZQUFJLE9BQU8sT0FBTyxDQUFDO0FBQ25CLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSCxJQUNnQix3QkFBd0IsQ0FBQyxPQUFpQztBQUFJO0FBR3BFLFlBRk4sSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7QUFDMUIsWUFBSSxJQUFJO0FBQ1IsZ0JBQU0sTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLDZCQUE2QixDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDakYsZ0JBQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDeEMsYUFBSztBQUFDLFlBQUEsT0FBTyxFQUFFLEVBQUU7QUFDakIsZ0JBQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDbkMsYUFBSztBQUFDLG9CQUFRO0FBQ2QsZ0JBQU0sSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7QUFDN0IsYUFBSztBQUNMLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSCxJQUNVLG9CQUFvQixDQUFDLE9BQWlDO0FBQUksUUFDaEUsTUFBTSxrQkFBa0IsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ3BELFFBQUksTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDO0FBQ3ZCLFFBQUksa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUMsV0FBVyxFQUFFLEVBQUU7QUFDL0MsWUFBTSxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDL0MsWUFBTSxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzdGLFFBQUksQ0FBQyxDQUFDLENBQUM7QUFDUCxRQUFJLE9BQU8sT0FBTyxDQUFDO0FBQ25CLElBQUUsQ0FBQztBQUNILElBQ1UsZ0JBQWdCLENBQUMsT0FBNEIsRUFBRSxXQUFtQjtBQUFJLFFBQzVFLE1BQU0sZUFBZSxHQUFHLEVBQUUsQ0FBQztBQUMvQixRQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtBQUN0QixZQUFNLGVBQWUsQ0FBQyxJQUFJLGlDQUNmLENBQUMsS0FDSixFQUFFLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQ3RELFdBQVcsSUFDWCxDQUFDO0FBQ1QsUUFBSSxDQUFDLENBQUMsQ0FBQztBQUNQLFFBQUksT0FBTyxlQUFlLENBQUM7QUFDM0IsSUFBRSxDQUFDO0FBQ0gsSUFDVSxjQUFjLENBQUMsV0FBbUIsRUFBRSxVQUFrQixFQUFFLGdCQUF5QjtBQUFJLFFBQzNGLE9BQU8sR0FBRyxXQUFXLElBQUksZ0JBQWdCLElBQUksVUFBVSxFQUFFLENBQUM7QUFDOUQsSUFBRSxDQUFDO0FBQ0gsSUFDVSxhQUFhLENBQUMsRUFBVTtBQUFJLFFBQ2xDLE1BQU0sQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUM5QyxRQUFJLE9BQU8sRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLENBQUM7QUFDakMsSUFBRSxDQUFDO0FBQ0g7dURBM0tDLFNBQVMsU0FBQyxrQkFDVCxRQUFRLEVBQUUsaUJBQWlCLGtCQUMzQjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7S0FBbUQsY0FDcEQ7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs4U0FDSTtBQUFDO0FBQXFELFlBYmxELGNBQWM7QUFBSSxZQUNsQixnQkFBZ0I7QUFBSSxZQUVwQixjQUFjO0FBQUksWUFFSyxZQUFZO0FBQUksWUFDdkMsZ0JBQWdCO0FBQUksWUFEaUIsY0FBYztBQUFJLFlBQXZELFlBQVk7QUFBRzs7Ozs7OztxUkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQXBwbGljYXRpb25SZW1vdGVQbHVnaW5zLCBJQXBwbGljYXRpb24sIElBcHBsaWNhdGlvbkJpbmFyeSwgSU1hbmlmZXN0IH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgRWNvc3lzdGVtU2VydmljZSB9IGZyb20gJy4uLy4uL2Vjb3N5c3RlbS5zZXJ2aWNlJztcbmltcG9ydCB7IEFwcGxpY2F0aW9uUGx1Z2luIH0gZnJvbSAnLi4vLi4vZWNvc3lzdGVtLm1vZGVsJztcbmltcG9ydCB7IEJzTW9kYWxTZXJ2aWNlIH0gZnJvbSAnbmd4LWJvb3RzdHJhcC9tb2RhbCc7XG5pbXBvcnQgeyBJbnN0YWxsUGx1Z2luQ29tcG9uZW50IH0gZnJvbSAnLi9pbnN0YWxsLXBsdWdpbi5jb21wb25lbnQnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlLCBnZXR0ZXh0LCBNb2RhbFNlcnZpY2UsIFBsdWdpbnNTZXJ2aWNlLCBTdGF0dXMgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IG1hcCwgc2hhcmVSZXBsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1hcHAtcGx1Z2lucycsXG4gIHRlbXBsYXRlVXJsOiAnLi9hcHBsaWNhdGlvbi1wbHVnaW5zLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBBcHBsaWNhdGlvblBsdWdpbnNDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBleHBvcnRlZFBsdWdpbnMkOiBCZWhhdmlvclN1YmplY3Q8QXBwbGljYXRpb25QbHVnaW5bXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcbiAgcmVtb3RlUGx1Z2lucyQ6IEJlaGF2aW9yU3ViamVjdDxBcHBsaWNhdGlvblJlbW90ZVBsdWdpbnM+ID0gbmV3IEJlaGF2aW9yU3ViamVjdCh7fSk7XG4gIGFsbEF2YWlsYWJsZVBsdWdpbnMkOiBCZWhhdmlvclN1YmplY3Q8QXBwbGljYXRpb25QbHVnaW5bXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcblxuICBpbnN0YWxsZWRQbHVnaW5zJDogT2JzZXJ2YWJsZTxBcHBsaWNhdGlvblBsdWdpbltdPiA9IGNvbWJpbmVMYXRlc3QoW1xuICAgIHRoaXMucmVtb3RlUGx1Z2lucyQucGlwZShtYXAoKHJlbW90ZXMpID0+IHRoaXMuZ2V0UmVtb3RlUGx1Z2luc0xpc3QocmVtb3RlcykpKSxcbiAgICB0aGlzLmFsbEF2YWlsYWJsZVBsdWdpbnMkXG4gIF0pLnBpcGUoXG4gICAgbWFwKChbcmVtb3RlUGx1Z2lucywgYWxsUGx1Z2luc10pID0+IGFsbFBsdWdpbnMuZmlsdGVyKChwKSA9PiByZW1vdGVQbHVnaW5zLmluY2x1ZGVzKHAuaWQpKSksXG4gICAgc2hhcmVSZXBsYXkoMSlcbiAgKTtcbiAgYXBwOiBJQXBwbGljYXRpb247XG4gIGlzTG9hZGluZzogYm9vbGVhbjtcbiAgcGx1Z2luc1RvRGVsZXRlOiBzdHJpbmdbXSA9IFtdO1xuICBhcmNoaXZlczogSUFwcGxpY2F0aW9uQmluYXJ5W10gPSBbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSxcbiAgICBwcml2YXRlIGVjb3N5c3RlbVNlcnZpY2U6IEVjb3N5c3RlbVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBic01vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBtb2RhbDogTW9kYWxTZXJ2aWNlLFxuICAgIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRlU2VydmljZSxcbiAgICBwcml2YXRlIHBsdWdpbnNTZXJ2aWNlOiBQbHVnaW5zU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlXG4gICkge31cblxuICBhc3luYyBuZ09uSW5pdCgpIHtcbiAgICBjb25zdCB7IGlkIH0gPSB0aGlzLmFjdGl2YXRlZFJvdXRlLnNuYXBzaG90LnBhcmVudC5kYXRhLmNvbnRleHREYXRhO1xuICAgIHRoaXMuYXBwID0gYXdhaXQgdGhpcy5lY29zeXN0ZW1TZXJ2aWNlLmdldEFwcGxpY2F0aW9uKGlkKTtcbiAgICB0aGlzLmFyY2hpdmVzID0gYXdhaXQgdGhpcy5lY29zeXN0ZW1TZXJ2aWNlLmxpc3RBcmNoaXZlcyh0aGlzLmFwcC5pZCk7XG4gICAgdGhpcy5hcmNoaXZlcy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICByZXR1cm4gKG5ldyBEYXRlKGIuY3JlYXRlZCkgYXMgYW55KSAtIChuZXcgRGF0ZShhLmNyZWF0ZWQpIGFzIGFueSk7XG4gICAgfSk7XG4gICAgY29uc3QgbWFuaWZlc3Q6IFBhcnRpYWw8SU1hbmlmZXN0PiA9IHRoaXMuYXBwLm1hbmlmZXN0O1xuICAgIGlmIChtYW5pZmVzdCkge1xuICAgICAgY29uc3QgZXhwb3J0cyA9IG1hbmlmZXN0LmV4cG9ydHMgfHwgW107XG4gICAgICB0aGlzLmV4cG9ydGVkUGx1Z2lucyQubmV4dCh0aGlzLmV4dGVuZFBsdWdpbkxpc3QoZXhwb3J0cywgdGhpcy5hcHAuY29udGV4dFBhdGgpKTtcbiAgICAgIGNvbnN0IHJlbW90ZXMgPSBtYW5pZmVzdC5yZW1vdGVzIHx8IHt9O1xuICAgICAgdGhpcy5yZW1vdGVQbHVnaW5zJC5uZXh0KHJlbW90ZXMpO1xuICAgIH1cbiAgICB0aGlzLmFsbEF2YWlsYWJsZVBsdWdpbnMkLm5leHQoYXdhaXQgdGhpcy5nZXRBbGxQbHVnaW5zKCkpO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFsbFBsdWdpbnMoKSB7XG4gICAgY29uc3QgaW5pdGlhbFN0YXRlOiBhbnkgPSB7XG4gICAgICBwbHVnaW5zJDogY29tYmluZUxhdGVzdChbXG4gICAgICAgIHRoaXMuYWxsQXZhaWxhYmxlUGx1Z2lucyQsXG4gICAgICAgIHRoaXMuaW5zdGFsbGVkUGx1Z2lucyQucGlwZShtYXAoKHBsdWdpbnMpID0+IHBsdWdpbnMubWFwKChwKSA9PiBwLmlkKSkpLFxuICAgICAgICB0aGlzLmV4cG9ydGVkUGx1Z2lucyQucGlwZShtYXAoKHBsdWdpbnMpID0+IHBsdWdpbnMubWFwKChwKSA9PiBwLmlkKSkpXG4gICAgICBdKS5waXBlKFxuICAgICAgICBtYXAoKFthbGxQbHVnaW5zLCBpbnN0YWxsZWRQbHVnaW5zLCBleHBvcnRlZFBsdWdpbk5hbWVzXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHBsdWdpbnMgPSBbXTtcbiAgICAgICAgICBhbGxQbHVnaW5zXG4gICAgICAgICAgICAuZmlsdGVyKChwKSA9PiAhZXhwb3J0ZWRQbHVnaW5OYW1lcy5pbmNsdWRlcyhwLmlkKSlcbiAgICAgICAgICAgIC5mb3JFYWNoKChwKSA9PiBwbHVnaW5zLnB1c2goeyAuLi5wLCBpbnN0YWxsZWQ6ICEhaW5zdGFsbGVkUGx1Z2lucy5pbmNsdWRlcyhwLmlkKSB9KSk7XG4gICAgICAgICAgcmV0dXJuIHBsdWdpbnM7XG4gICAgICAgIH0pLFxuICAgICAgICBzaGFyZVJlcGxheSgxKVxuICAgICAgKVxuICAgIH07XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcGx1Z2luc1RvQWRkOiBzdHJpbmdbXSA9IChhd2FpdCAoXG4gICAgICAgIHRoaXMuYnNNb2RhbFNlcnZpY2Uuc2hvdyhJbnN0YWxsUGx1Z2luQ29tcG9uZW50LCB7XG4gICAgICAgICAgY2xhc3M6ICdtb2RhbC1tZCcsXG4gICAgICAgICAgaW5pdGlhbFN0YXRlLFxuICAgICAgICAgIGlnbm9yZUJhY2tkcm9wQ2xpY2s6IHRydWVcbiAgICAgICAgfSkuY29udGVudCBhcyBJbnN0YWxsUGx1Z2luQ29tcG9uZW50XG4gICAgICApLnJlc3VsdCkgYXMgYW55IGFzIHN0cmluZ1tdO1xuXG4gICAgICBjb25zdCBjdXJyZW50UmVtb3RlcyA9IHsgLi4udGhpcy5yZW1vdGVQbHVnaW5zJC52YWx1ZSB9O1xuICAgICAgcGx1Z2luc1RvQWRkLmZvckVhY2goKHBsdWdpbklkKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgY29udGV4dFBhdGgsIG5hbWUgfSA9IHRoaXMucGFyc2VQbHVnaW5JZChwbHVnaW5JZCk7XG4gICAgICAgIChjdXJyZW50UmVtb3Rlc1tjb250ZXh0UGF0aF0gPSBjdXJyZW50UmVtb3Rlc1tjb250ZXh0UGF0aF0gfHwgW10pLnB1c2gobmFtZSk7XG4gICAgICB9KTtcbiAgICAgIGlmICh0aGlzLmFyY2hpdmVzLmxlbmd0aCA9PT0gNikge1xuICAgICAgICBhd2FpdCB0aGlzLmVjb3N5c3RlbVNlcnZpY2UucmVtb3ZlT2xkZXN0QXJjaGl2ZSh0aGlzLmFwcCwgdGhpcy5hcmNoaXZlcyk7XG4gICAgICB9XG4gICAgICB0aGlzLnVwZGF0ZUFwcGxpY2F0aW9uUmVtb3RlcyhjdXJyZW50UmVtb3Rlcyk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIC8vIGludGVuZGVkIGVtcHR5XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVtb3ZlUGx1Z2lucygpIHtcbiAgICBjb25zdCBodW1hbml6ZWRBcHBOYW1lID0gYXdhaXQgdGhpcy5lY29zeXN0ZW1TZXJ2aWNlLmdldEh1bWFuaXplZEFwcE5hbWUodGhpcy5hcHApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLm1vZGFsLmNvbmZpcm0oXG4gICAgICAgIGdldHRleHQoJ1JlbW92ZSBwbHVnaW5zJyksXG4gICAgICAgIHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KFxuICAgICAgICAgIGdldHRleHQoXG4gICAgICAgICAgICBgWW91IGFyZSBhYm91dCB0byByZW1vdmUgcGx1Z2lucyBmcm9tIGFwcGxpY2F0aW9uIFwie3sgaHVtYW5pemVkQXBwTmFtZSB9fVwiLiBUaGUgb3BlcmF0aW9uIG1heSB0YWtlIHNldmVyYWwgbWludXRlcy4gRHVyaW5nIHRoaXMgdGltZSB0aGUgYXBwbGljYXRpb24gbWF5IGJlIHVuYXZhaWxhYmxlLiBEbyB5b3Ugd2FudCB0byBwcm9jZWVkP2BcbiAgICAgICAgICApLFxuICAgICAgICAgIHsgaHVtYW5pemVkQXBwTmFtZSB9XG4gICAgICAgICksXG4gICAgICAgIFN0YXR1cy5EQU5HRVIsXG4gICAgICAgIHtcbiAgICAgICAgICBvazogZ2V0dGV4dCgnUmVtb3ZlJyksXG4gICAgICAgICAgY2FuY2VsOiBnZXR0ZXh0KCdDYW5jZWwnKVxuICAgICAgICB9XG4gICAgICApO1xuXG4gICAgICBjb25zdCByZW1vdGVzID0geyAuLi50aGlzLnJlbW90ZVBsdWdpbnMkLnZhbHVlIH07XG4gICAgICB0aGlzLnBsdWdpbnNUb0RlbGV0ZS5mb3JFYWNoKChwbHVnaW5JZCkgPT4ge1xuICAgICAgICBjb25zdCB7IGNvbnRleHRQYXRoLCBuYW1lIH0gPSB0aGlzLnBhcnNlUGx1Z2luSWQocGx1Z2luSWQpO1xuICAgICAgICByZW1vdGVzW2NvbnRleHRQYXRoXSA9IHJlbW90ZXNbY29udGV4dFBhdGhdLmZpbHRlcigocCkgPT4gcCAhPT0gbmFtZSk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMudXBkYXRlQXBwbGljYXRpb25SZW1vdGVzKHJlbW90ZXMpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAvLyBkbyBub3RoaW5nXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRBbGxQbHVnaW5zKCk6IFByb21pc2U8QXBwbGljYXRpb25QbHVnaW5bXT4ge1xuICAgIGNvbnN0IHBsdWdpbnMgPSBbXTtcbiAgICBjb25zdCBwYWNrYWdlcyA9IGF3YWl0IHRoaXMuZWNvc3lzdGVtU2VydmljZS5nZXRQYWNrYWdlQXBwbGljYXRpb25zKCk7XG4gICAgY29uc3QgYXBwcyA9IFsuLi5wYWNrYWdlcywgdGhpcy5hcHBdO1xuICAgIGFwcHMuZm9yRWFjaCgoYXBwKSA9PiB7XG4gICAgICBjb25zdCBleHBvcnRzID0gKGFwcC5tYW5pZmVzdCAmJiBhcHAubWFuaWZlc3QuZXhwb3J0cykgfHwgW107XG4gICAgICBwbHVnaW5zLnB1c2goLi4udGhpcy5leHRlbmRQbHVnaW5MaXN0KGV4cG9ydHMsIGFwcC5jb250ZXh0UGF0aCkpO1xuICAgIH0pO1xuICAgIHJldHVybiBwbHVnaW5zO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB1cGRhdGVBcHBsaWNhdGlvblJlbW90ZXMocmVtb3RlczogQXBwbGljYXRpb25SZW1vdGVQbHVnaW5zKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5pc0xvYWRpbmcgPSB0cnVlO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnBsdWdpbnNTZXJ2aWNlLnVwZGF0ZVJlbW90ZXNJbkN1bXVsb2NpdHlKc29uKHRoaXMuYXBwLCByZW1vdGVzKTtcbiAgICAgIHRoaXMucmVtb3RlUGx1Z2lucyQubmV4dChyZW1vdGVzKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuZGFuZ2VyKGV4KTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldFJlbW90ZVBsdWdpbnNMaXN0KHJlbW90ZXM6IEFwcGxpY2F0aW9uUmVtb3RlUGx1Z2lucyk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBpbXBvcnRDb250ZXh0UGF0aHMgPSBPYmplY3Qua2V5cyhyZW1vdGVzKTtcbiAgICBjb25zdCBwbHVnaW5zID0gW107XG4gICAgaW1wb3J0Q29udGV4dFBhdGhzLmZvckVhY2goKGNvbnRleHRQYXRoKSA9PiB7XG4gICAgICBjb25zdCBtb2R1bGVOYW1lcyA9IHJlbW90ZXNbY29udGV4dFBhdGhdO1xuICAgICAgcGx1Z2lucy5wdXNoKC4uLm1vZHVsZU5hbWVzLm1hcCgobW9kdWxlKSA9PiB0aGlzLmNyZWF0ZVBsdWdpbklkKGNvbnRleHRQYXRoLCBtb2R1bGUpKSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHBsdWdpbnM7XG4gIH1cblxuICBwcml2YXRlIGV4dGVuZFBsdWdpbkxpc3QocGx1Z2luczogQXBwbGljYXRpb25QbHVnaW5bXSwgY29udGV4dFBhdGg6IHN0cmluZyk6IEFwcGxpY2F0aW9uUGx1Z2luW10ge1xuICAgIGNvbnN0IGV4dGVuZGVkUGx1Z2lucyA9IFtdO1xuICAgIHBsdWdpbnMubWFwKChwKSA9PiB7XG4gICAgICBleHRlbmRlZFBsdWdpbnMucHVzaCh7XG4gICAgICAgIC4uLnAsXG4gICAgICAgIGlkOiB0aGlzLmNyZWF0ZVBsdWdpbklkKGNvbnRleHRQYXRoLCBwLm5hbWUsIHAubW9kdWxlKSxcbiAgICAgICAgY29udGV4dFBhdGhcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiBleHRlbmRlZFBsdWdpbnM7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVBsdWdpbklkKGNvbnRleHRQYXRoOiBzdHJpbmcsIHBsdWdpbk5hbWU6IHN0cmluZywgcGx1Z2luTW9kdWxlTmFtZT86IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGAke2NvbnRleHRQYXRofS8ke3BsdWdpbk1vZHVsZU5hbWUgfHwgcGx1Z2luTmFtZX1gO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZVBsdWdpbklkKGlkOiBzdHJpbmcpOiB7IGNvbnRleHRQYXRoOiBzdHJpbmc7IG5hbWU6IHN0cmluZyB9IHtcbiAgICBjb25zdCBbY29udGV4dFBhdGgsIG5hbWVdID0gaWQuc3BsaXQoJy8nKTtcbiAgICByZXR1cm4geyBjb250ZXh0UGF0aCwgbmFtZSB9O1xuICB9XG59XG4iXX0=