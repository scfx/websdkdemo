import { __awaiter } from "tslib";
import { Component } from '@angular/core';
import { BehaviorSubject, combineLatest } from 'rxjs';
import { ActivatedRoute } from '@angular/router';
import { EcosystemService } from '../../ecosystem.service';
import { BsModalService } from 'ngx-bootstrap/modal';
import { InstallPluginComponent } from './install-plugin.component';
import { AlertService, gettext, ModalService, PluginsService, Status } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
import { map, shareReplay } from 'rxjs/operators';
export class ApplicationPluginsComponent {
    constructor(activatedRoute, ecosystemService, bsModalService, modal, translateService, pluginsService, alertService) {
        this.activatedRoute = activatedRoute;
        this.ecosystemService = ecosystemService;
        this.bsModalService = bsModalService;
        this.modal = modal;
        this.translateService = translateService;
        this.pluginsService = pluginsService;
        this.alertService = alertService;
        this.exportedPlugins$ = new BehaviorSubject([]);
        this.remotePlugins$ = new BehaviorSubject({});
        this.allAvailablePlugins$ = new BehaviorSubject([]);
        this.installedPlugins$ = combineLatest([
            this.remotePlugins$.pipe(map((remotes) => this.getRemotePluginsList(remotes))),
            this.allAvailablePlugins$
        ]).pipe(map(([remotePlugins, allPlugins]) => allPlugins.filter((p) => remotePlugins.includes(p.id))), shareReplay(1));
        this.pluginsToDelete = [];
        this.archives = [];
    }
    ngOnInit() {
        return __awaiter(this, void 0, void 0, function* () {
            const { id } = this.activatedRoute.snapshot.parent.data.contextData;
            this.app = yield this.ecosystemService.getApplication(id);
            this.archives = yield this.ecosystemService.listArchives(this.app.id);
            this.archives.sort((a, b) => {
                return new Date(b.created) - new Date(a.created);
            });
            const manifest = this.app.manifest;
            if (manifest) {
                const exports = manifest.exports || [];
                this.exportedPlugins$.next(this.extendPluginList(exports, this.app.contextPath));
                const remotes = manifest.remotes || {};
                this.remotePlugins$.next(remotes);
            }
            this.allAvailablePlugins$.next(yield this.getAllPlugins());
        });
    }
    installPlugins() {
        return __awaiter(this, void 0, void 0, function* () {
            const initialState = {
                plugins$: combineLatest([
                    this.allAvailablePlugins$,
                    this.installedPlugins$.pipe(map((plugins) => plugins.map((p) => p.id))),
                    this.exportedPlugins$.pipe(map((plugins) => plugins.map((p) => p.id)))
                ]).pipe(map(([allPlugins, installedPlugins, exportedPluginNames]) => {
                    const plugins = [];
                    allPlugins
                        .filter((p) => !exportedPluginNames.includes(p.id))
                        .forEach((p) => plugins.push(Object.assign(Object.assign({}, p), { installed: !!installedPlugins.includes(p.id) })));
                    return plugins;
                }), shareReplay(1))
            };
            try {
                const pluginsToAdd = (yield this.bsModalService.show(InstallPluginComponent, {
                    class: 'modal-md',
                    initialState,
                    ignoreBackdropClick: true
                }).content.result);
                const currentRemotes = Object.assign({}, this.remotePlugins$.value);
                pluginsToAdd.forEach((pluginId) => {
                    const { contextPath, name } = this.parsePluginId(pluginId);
                    (currentRemotes[contextPath] = currentRemotes[contextPath] || []).push(name);
                });
                if (this.archives.length === 6) {
                    yield this.ecosystemService.removeOldestArchive(this.app, this.archives);
                }
                this.updateApplicationRemotes(currentRemotes);
            }
            catch (ex) {
                // intended empty
            }
        });
    }
    removePlugins() {
        return __awaiter(this, void 0, void 0, function* () {
            const humanizedAppName = yield this.ecosystemService.getHumanizedAppName(this.app);
            try {
                yield this.modal.confirm(gettext('Remove plugins'), this.translateService.instant(gettext(`You are about to remove plugins from application "{{ humanizedAppName }}". The operation may take several minutes. During this time the application may be unavailable. Do you want to proceed?`), { humanizedAppName }), Status.DANGER, {
                    ok: gettext('Remove'),
                    cancel: gettext('Cancel')
                });
                const remotes = Object.assign({}, this.remotePlugins$.value);
                this.pluginsToDelete.forEach((pluginId) => {
                    const { contextPath, name } = this.parsePluginId(pluginId);
                    remotes[contextPath] = remotes[contextPath].filter((p) => p !== name);
                });
                this.updateApplicationRemotes(remotes);
            }
            catch (ex) {
                // do nothing
            }
        });
    }
    getAllPlugins() {
        return __awaiter(this, void 0, void 0, function* () {
            const plugins = [];
            const packages = yield this.ecosystemService.getPackageApplications();
            const apps = [...packages, this.app];
            apps.forEach((app) => {
                const exports = (app.manifest && app.manifest.exports) || [];
                plugins.push(...this.extendPluginList(exports, app.contextPath));
            });
            return plugins;
        });
    }
    updateApplicationRemotes(remotes) {
        return __awaiter(this, void 0, void 0, function* () {
            this.isLoading = true;
            try {
                yield this.pluginsService.updateRemotesInCumulocityJson(this.app, remotes);
                this.remotePlugins$.next(remotes);
            }
            catch (ex) {
                this.alertService.danger(ex);
            }
            finally {
                this.isLoading = false;
            }
        });
    }
    getRemotePluginsList(remotes) {
        const importContextPaths = Object.keys(remotes);
        const plugins = [];
        importContextPaths.forEach((contextPath) => {
            const moduleNames = remotes[contextPath];
            plugins.push(...moduleNames.map((module) => this.createPluginId(contextPath, module)));
        });
        return plugins;
    }
    extendPluginList(plugins, contextPath) {
        const extendedPlugins = [];
        plugins.map((p) => {
            extendedPlugins.push(Object.assign(Object.assign({}, p), { id: this.createPluginId(contextPath, p.name, p.module), contextPath }));
        });
        return extendedPlugins;
    }
    createPluginId(contextPath, pluginName, pluginModuleName) {
        return `${contextPath}/${pluginModuleName || pluginName}`;
    }
    parsePluginId(id) {
        const [contextPath, name] = id.split('/');
        return { contextPath, name };
    }
}
ApplicationPluginsComponent.decorators = [
    { type: Component, args: [{
                selector: 'c8y-app-plugins',
                template: "<c8y-title>{{ app | humanizeAppName | async }}</c8y-title>\n\n<c8y-breadcrumb>\n  <c8y-breadcrumb-item [icon]=\"'c8y-atom'\" [label]=\"'Ecosystem' | translate\"></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item\n    [icon]=\"'c8y-modules'\"\n    [label]=\"'Applications' | translate\"\n    [path]=\"'ecosystem/applications'\"\n  ></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item\n    [icon]=\"'c8y-modules'\"\n    [label]=\"'All applications' | translate\"\n    [path]=\"'ecosystem/applications'\"\n  ></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item [label]=\"app | humanizeAppName | async\"></c8y-breadcrumb-item>\n  <c8y-breadcrumb-item [label]=\"'Plugins' | translate\"></c8y-breadcrumb-item>\n</c8y-breadcrumb>\n\n<div class=\"card content-fullpage d-grid grid__col--6-6--md\">\n  <div class=\"inner-scroll bg-gray-white\">\n    <div class=\"card-header large-padding separator sticky-top\">\n      <h4 class=\"card-title\" translate>Included plugins</h4>\n    </div>\n    <div class=\"card-block large-padding\">\n      <p class=\"d-flex a-i-start p-b-16\">\n        <i c8yIcon=\"info-circle\" class=\"text-info m-r-8 icon-20\"></i>\n        <span translate>\n          Plugins included with the application. These plugins are required for running the\n          application and cannot be removed.\n        </span>\n      </p>\n      <c8y-plugin-list\n        [emptyListText]=\"'This application doesn\\'t contain plugins.' | translate\"\n        [plugins$]=\"exportedPlugins$\"\n        class=\"separator-top d-block\"\n      ></c8y-plugin-list>\n    </div>\n  </div>\n\n  <div class=\"content-fullpage d-flex d-col\">\n    <div class=\"card-header large-padding separator\">\n      <h4 class=\"card-title\" translate>Installed plugins</h4>\n    </div>\n    <div class=\"inner-scroll flex-grow\">\n      <div class=\"card-block large-padding\">\n        <p class=\"d-flex a-i-start p-b-16\">\n          <i c8yIcon=\"info-circle\" class=\"text-info m-r-8 icon-20\"></i>\n          <span translate>\n            Plugins currently installed for this application. Upgrading the application won't change\n            any of these plugins.\n          </span>\n        </p>\n        <c8y-plugin-list\n          (selectedItems)=\"pluginsToDelete = $event\"\n          [emptyListText]=\"'No plugins installed' | translate\"\n          [plugins$]=\"installedPlugins$\"\n          [selectable]=\"true\"\n          class=\"separator-top d-block\"\n        ></c8y-plugin-list>\n      </div>\n    </div>\n\n    <div class=\"card-footer large-padding separator\">\n      <button\n        (click)=\"removePlugins()\"\n        [disabled]=\"pluginsToDelete.length === 0 || isLoading\"\n        class=\"btn btn-default\"\n        title=\"{{ 'Remove plugins' | translate }}\"\n        translate\n      >\n        Remove plugins\n      </button>\n      <button\n        (click)=\"installPlugins()\"\n        [ngClass]=\"{ 'btn-pending': isLoading }\"\n        class=\"btn btn-default\"\n        title=\"{{ 'Install plugins' | translate }}\"\n        translate\n      >\n        Install plugins\n      </button>\n    </div>\n  </div>\n</div>\n"
            },] }
];
ApplicationPluginsComponent.ctorParameters = () => [
    { type: ActivatedRoute },
    { type: EcosystemService },
    { type: BsModalService },
    { type: ModalService },
    { type: TranslateService },
    { type: PluginsService },
    { type: AlertService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwbGljYXRpb24tcGx1Z2lucy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9lY29zeXN0ZW0vYXBwbGljYXRpb25zL2FwcGxpY2F0aW9uLXBsdWdpbnMvYXBwbGljYXRpb24tcGx1Z2lucy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDbEQsT0FBTyxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFFbEUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRTNELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUNwRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsY0FBYyxFQUFFLE1BQU0sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2xHLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZELE9BQU8sRUFBRSxHQUFHLEVBQUUsV0FBVyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFNbEQsTUFBTSxPQUFPLDJCQUEyQjtJQWlCdEMsWUFDVSxjQUE4QixFQUM5QixnQkFBa0MsRUFDbEMsY0FBOEIsRUFDOUIsS0FBbUIsRUFDbkIsZ0JBQWtDLEVBQ2xDLGNBQThCLEVBQzlCLFlBQTBCO1FBTjFCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5QixVQUFLLEdBQUwsS0FBSyxDQUFjO1FBQ25CLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBdkJwQyxxQkFBZ0IsR0FBeUMsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDakYsbUJBQWMsR0FBOEMsSUFBSSxlQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDcEYseUJBQW9CLEdBQXlDLElBQUksZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRXJGLHNCQUFpQixHQUFvQyxhQUFhLENBQUM7WUFDakUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztZQUM5RSxJQUFJLENBQUMsb0JBQW9CO1NBQzFCLENBQUMsQ0FBQyxJQUFJLENBQ0wsR0FBRyxDQUFDLENBQUMsQ0FBQyxhQUFhLEVBQUUsVUFBVSxDQUFDLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFDNUYsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUNmLENBQUM7UUFHRixvQkFBZSxHQUFhLEVBQUUsQ0FBQztRQUMvQixhQUFRLEdBQXlCLEVBQUUsQ0FBQztJQVVqQyxDQUFDO0lBRUUsUUFBUTs7WUFDWixNQUFNLEVBQUUsRUFBRSxFQUFFLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUM7WUFDcEUsSUFBSSxDQUFDLEdBQUcsR0FBRyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDMUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN0RSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtnQkFDMUIsT0FBUSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFTLEdBQUksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBUyxDQUFDO1lBQ3JFLENBQUMsQ0FBQyxDQUFDO1lBQ0gsTUFBTSxRQUFRLEdBQXVCLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDO1lBQ3ZELElBQUksUUFBUSxFQUFFO2dCQUNaLE1BQU0sT0FBTyxHQUFHLFFBQVEsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDO2dCQUN2QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO2dCQUNqRixNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQztnQkFDdkMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDbkM7WUFDRCxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUM7UUFDN0QsQ0FBQztLQUFBO0lBRUssY0FBYzs7WUFDbEIsTUFBTSxZQUFZLEdBQVE7Z0JBQ3hCLFFBQVEsRUFBRSxhQUFhLENBQUM7b0JBQ3RCLElBQUksQ0FBQyxvQkFBb0I7b0JBQ3pCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDdkUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2lCQUN2RSxDQUFDLENBQUMsSUFBSSxDQUNMLEdBQUcsQ0FBQyxDQUFDLENBQUMsVUFBVSxFQUFFLGdCQUFnQixFQUFFLG1CQUFtQixDQUFDLEVBQUUsRUFBRTtvQkFDMUQsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDO29CQUNuQixVQUFVO3lCQUNQLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO3lCQUNsRCxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLGlDQUFNLENBQUMsS0FBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUcsQ0FBQyxDQUFDO29CQUN4RixPQUFPLE9BQU8sQ0FBQztnQkFDakIsQ0FBQyxDQUFDLEVBQ0YsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUNmO2FBQ0YsQ0FBQztZQUVGLElBQUk7Z0JBQ0YsTUFBTSxZQUFZLEdBQWEsQ0FBQyxNQUM5QixJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxzQkFBc0IsRUFBRTtvQkFDL0MsS0FBSyxFQUFFLFVBQVU7b0JBQ2pCLFlBQVk7b0JBQ1osbUJBQW1CLEVBQUUsSUFBSTtpQkFDMUIsQ0FBQyxDQUFDLE9BQ0osQ0FBQyxNQUFNLENBQW9CLENBQUM7Z0JBRTdCLE1BQU0sY0FBYyxxQkFBUSxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBRSxDQUFDO2dCQUN4RCxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7b0JBQ2hDLE1BQU0sRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztvQkFDM0QsQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLEdBQUcsY0FBYyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDL0UsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7b0JBQzlCLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2lCQUMxRTtnQkFDRCxJQUFJLENBQUMsd0JBQXdCLENBQUMsY0FBYyxDQUFDLENBQUM7YUFDL0M7WUFBQyxPQUFPLEVBQUUsRUFBRTtnQkFDWCxpQkFBaUI7YUFDbEI7UUFDSCxDQUFDO0tBQUE7SUFFSyxhQUFhOztZQUNqQixNQUFNLGdCQUFnQixHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNuRixJQUFJO2dCQUNGLE1BQU0sSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQ3RCLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxFQUN6QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUMzQixPQUFPLENBQ0wsaU1BQWlNLENBQ2xNLEVBQ0QsRUFBRSxnQkFBZ0IsRUFBRSxDQUNyQixFQUNELE1BQU0sQ0FBQyxNQUFNLEVBQ2I7b0JBQ0UsRUFBRSxFQUFFLE9BQU8sQ0FBQyxRQUFRLENBQUM7b0JBQ3JCLE1BQU0sRUFBRSxPQUFPLENBQUMsUUFBUSxDQUFDO2lCQUMxQixDQUNGLENBQUM7Z0JBRUYsTUFBTSxPQUFPLHFCQUFRLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFFLENBQUM7Z0JBQ2pELElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUU7b0JBQ3hDLE1BQU0sRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztvQkFDM0QsT0FBTyxDQUFDLFdBQVcsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQztnQkFDeEUsQ0FBQyxDQUFDLENBQUM7Z0JBQ0gsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3hDO1lBQUMsT0FBTyxFQUFFLEVBQUU7Z0JBQ1gsYUFBYTthQUNkO1FBQ0gsQ0FBQztLQUFBO0lBRWEsYUFBYTs7WUFDekIsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDO1lBQ25CLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLHNCQUFzQixFQUFFLENBQUM7WUFDdEUsTUFBTSxJQUFJLEdBQUcsQ0FBQyxHQUFHLFFBQVEsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDckMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUNuQixNQUFNLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxRQUFRLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQzdELE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDO1lBQ25FLENBQUMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxPQUFPLENBQUM7UUFDakIsQ0FBQztLQUFBO0lBRWEsd0JBQXdCLENBQUMsT0FBaUM7O1lBQ3RFLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1lBQ3RCLElBQUk7Z0JBQ0YsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDLDZCQUE2QixDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBQzNFLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ25DO1lBQUMsT0FBTyxFQUFFLEVBQUU7Z0JBQ1gsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDOUI7b0JBQVM7Z0JBQ1IsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7YUFDeEI7UUFDSCxDQUFDO0tBQUE7SUFFTyxvQkFBb0IsQ0FBQyxPQUFpQztRQUM1RCxNQUFNLGtCQUFrQixHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDaEQsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ25CLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFO1lBQ3pDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUN6QyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3pGLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVPLGdCQUFnQixDQUFDLE9BQTRCLEVBQUUsV0FBbUI7UUFDeEUsTUFBTSxlQUFlLEdBQUcsRUFBRSxDQUFDO1FBQzNCLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtZQUNoQixlQUFlLENBQUMsSUFBSSxpQ0FDZixDQUFDLEtBQ0osRUFBRSxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUN0RCxXQUFXLElBQ1gsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxlQUFlLENBQUM7SUFDekIsQ0FBQztJQUVPLGNBQWMsQ0FBQyxXQUFtQixFQUFFLFVBQWtCLEVBQUUsZ0JBQXlCO1FBQ3ZGLE9BQU8sR0FBRyxXQUFXLElBQUksZ0JBQWdCLElBQUksVUFBVSxFQUFFLENBQUM7SUFDNUQsQ0FBQztJQUVPLGFBQWEsQ0FBQyxFQUFVO1FBQzlCLE1BQU0sQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMxQyxPQUFPLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxDQUFDO0lBQy9CLENBQUM7OztZQTFLRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLGlCQUFpQjtnQkFDM0IsNmpHQUFtRDthQUNwRDs7O1lBWlEsY0FBYztZQUNkLGdCQUFnQjtZQUVoQixjQUFjO1lBRVMsWUFBWTtZQUNuQyxnQkFBZ0I7WUFEcUIsY0FBYztZQUFuRCxZQUFZIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgQXBwbGljYXRpb25SZW1vdGVQbHVnaW5zLCBJQXBwbGljYXRpb24sIElBcHBsaWNhdGlvbkJpbmFyeSwgSU1hbmlmZXN0IH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgRWNvc3lzdGVtU2VydmljZSB9IGZyb20gJy4uLy4uL2Vjb3N5c3RlbS5zZXJ2aWNlJztcbmltcG9ydCB7IEFwcGxpY2F0aW9uUGx1Z2luIH0gZnJvbSAnLi4vLi4vZWNvc3lzdGVtLm1vZGVsJztcbmltcG9ydCB7IEJzTW9kYWxTZXJ2aWNlIH0gZnJvbSAnbmd4LWJvb3RzdHJhcC9tb2RhbCc7XG5pbXBvcnQgeyBJbnN0YWxsUGx1Z2luQ29tcG9uZW50IH0gZnJvbSAnLi9pbnN0YWxsLXBsdWdpbi5jb21wb25lbnQnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlLCBnZXR0ZXh0LCBNb2RhbFNlcnZpY2UsIFBsdWdpbnNTZXJ2aWNlLCBTdGF0dXMgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IG1hcCwgc2hhcmVSZXBsYXkgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1hcHAtcGx1Z2lucycsXG4gIHRlbXBsYXRlVXJsOiAnLi9hcHBsaWNhdGlvbi1wbHVnaW5zLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBBcHBsaWNhdGlvblBsdWdpbnNDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBleHBvcnRlZFBsdWdpbnMkOiBCZWhhdmlvclN1YmplY3Q8QXBwbGljYXRpb25QbHVnaW5bXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcbiAgcmVtb3RlUGx1Z2lucyQ6IEJlaGF2aW9yU3ViamVjdDxBcHBsaWNhdGlvblJlbW90ZVBsdWdpbnM+ID0gbmV3IEJlaGF2aW9yU3ViamVjdCh7fSk7XG4gIGFsbEF2YWlsYWJsZVBsdWdpbnMkOiBCZWhhdmlvclN1YmplY3Q8QXBwbGljYXRpb25QbHVnaW5bXT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcblxuICBpbnN0YWxsZWRQbHVnaW5zJDogT2JzZXJ2YWJsZTxBcHBsaWNhdGlvblBsdWdpbltdPiA9IGNvbWJpbmVMYXRlc3QoW1xuICAgIHRoaXMucmVtb3RlUGx1Z2lucyQucGlwZShtYXAoKHJlbW90ZXMpID0+IHRoaXMuZ2V0UmVtb3RlUGx1Z2luc0xpc3QocmVtb3RlcykpKSxcbiAgICB0aGlzLmFsbEF2YWlsYWJsZVBsdWdpbnMkXG4gIF0pLnBpcGUoXG4gICAgbWFwKChbcmVtb3RlUGx1Z2lucywgYWxsUGx1Z2luc10pID0+IGFsbFBsdWdpbnMuZmlsdGVyKChwKSA9PiByZW1vdGVQbHVnaW5zLmluY2x1ZGVzKHAuaWQpKSksXG4gICAgc2hhcmVSZXBsYXkoMSlcbiAgKTtcbiAgYXBwOiBJQXBwbGljYXRpb247XG4gIGlzTG9hZGluZzogYm9vbGVhbjtcbiAgcGx1Z2luc1RvRGVsZXRlOiBzdHJpbmdbXSA9IFtdO1xuICBhcmNoaXZlczogSUFwcGxpY2F0aW9uQmluYXJ5W10gPSBbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFjdGl2YXRlZFJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSxcbiAgICBwcml2YXRlIGVjb3N5c3RlbVNlcnZpY2U6IEVjb3N5c3RlbVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBic01vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBtb2RhbDogTW9kYWxTZXJ2aWNlLFxuICAgIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRlU2VydmljZSxcbiAgICBwcml2YXRlIHBsdWdpbnNTZXJ2aWNlOiBQbHVnaW5zU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlXG4gICkge31cblxuICBhc3luYyBuZ09uSW5pdCgpIHtcbiAgICBjb25zdCB7IGlkIH0gPSB0aGlzLmFjdGl2YXRlZFJvdXRlLnNuYXBzaG90LnBhcmVudC5kYXRhLmNvbnRleHREYXRhO1xuICAgIHRoaXMuYXBwID0gYXdhaXQgdGhpcy5lY29zeXN0ZW1TZXJ2aWNlLmdldEFwcGxpY2F0aW9uKGlkKTtcbiAgICB0aGlzLmFyY2hpdmVzID0gYXdhaXQgdGhpcy5lY29zeXN0ZW1TZXJ2aWNlLmxpc3RBcmNoaXZlcyh0aGlzLmFwcC5pZCk7XG4gICAgdGhpcy5hcmNoaXZlcy5zb3J0KChhLCBiKSA9PiB7XG4gICAgICByZXR1cm4gKG5ldyBEYXRlKGIuY3JlYXRlZCkgYXMgYW55KSAtIChuZXcgRGF0ZShhLmNyZWF0ZWQpIGFzIGFueSk7XG4gICAgfSk7XG4gICAgY29uc3QgbWFuaWZlc3Q6IFBhcnRpYWw8SU1hbmlmZXN0PiA9IHRoaXMuYXBwLm1hbmlmZXN0O1xuICAgIGlmIChtYW5pZmVzdCkge1xuICAgICAgY29uc3QgZXhwb3J0cyA9IG1hbmlmZXN0LmV4cG9ydHMgfHwgW107XG4gICAgICB0aGlzLmV4cG9ydGVkUGx1Z2lucyQubmV4dCh0aGlzLmV4dGVuZFBsdWdpbkxpc3QoZXhwb3J0cywgdGhpcy5hcHAuY29udGV4dFBhdGgpKTtcbiAgICAgIGNvbnN0IHJlbW90ZXMgPSBtYW5pZmVzdC5yZW1vdGVzIHx8IHt9O1xuICAgICAgdGhpcy5yZW1vdGVQbHVnaW5zJC5uZXh0KHJlbW90ZXMpO1xuICAgIH1cbiAgICB0aGlzLmFsbEF2YWlsYWJsZVBsdWdpbnMkLm5leHQoYXdhaXQgdGhpcy5nZXRBbGxQbHVnaW5zKCkpO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFsbFBsdWdpbnMoKSB7XG4gICAgY29uc3QgaW5pdGlhbFN0YXRlOiBhbnkgPSB7XG4gICAgICBwbHVnaW5zJDogY29tYmluZUxhdGVzdChbXG4gICAgICAgIHRoaXMuYWxsQXZhaWxhYmxlUGx1Z2lucyQsXG4gICAgICAgIHRoaXMuaW5zdGFsbGVkUGx1Z2lucyQucGlwZShtYXAoKHBsdWdpbnMpID0+IHBsdWdpbnMubWFwKChwKSA9PiBwLmlkKSkpLFxuICAgICAgICB0aGlzLmV4cG9ydGVkUGx1Z2lucyQucGlwZShtYXAoKHBsdWdpbnMpID0+IHBsdWdpbnMubWFwKChwKSA9PiBwLmlkKSkpXG4gICAgICBdKS5waXBlKFxuICAgICAgICBtYXAoKFthbGxQbHVnaW5zLCBpbnN0YWxsZWRQbHVnaW5zLCBleHBvcnRlZFBsdWdpbk5hbWVzXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHBsdWdpbnMgPSBbXTtcbiAgICAgICAgICBhbGxQbHVnaW5zXG4gICAgICAgICAgICAuZmlsdGVyKChwKSA9PiAhZXhwb3J0ZWRQbHVnaW5OYW1lcy5pbmNsdWRlcyhwLmlkKSlcbiAgICAgICAgICAgIC5mb3JFYWNoKChwKSA9PiBwbHVnaW5zLnB1c2goeyAuLi5wLCBpbnN0YWxsZWQ6ICEhaW5zdGFsbGVkUGx1Z2lucy5pbmNsdWRlcyhwLmlkKSB9KSk7XG4gICAgICAgICAgcmV0dXJuIHBsdWdpbnM7XG4gICAgICAgIH0pLFxuICAgICAgICBzaGFyZVJlcGxheSgxKVxuICAgICAgKVxuICAgIH07XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcGx1Z2luc1RvQWRkOiBzdHJpbmdbXSA9IChhd2FpdCAoXG4gICAgICAgIHRoaXMuYnNNb2RhbFNlcnZpY2Uuc2hvdyhJbnN0YWxsUGx1Z2luQ29tcG9uZW50LCB7XG4gICAgICAgICAgY2xhc3M6ICdtb2RhbC1tZCcsXG4gICAgICAgICAgaW5pdGlhbFN0YXRlLFxuICAgICAgICAgIGlnbm9yZUJhY2tkcm9wQ2xpY2s6IHRydWVcbiAgICAgICAgfSkuY29udGVudCBhcyBJbnN0YWxsUGx1Z2luQ29tcG9uZW50XG4gICAgICApLnJlc3VsdCkgYXMgYW55IGFzIHN0cmluZ1tdO1xuXG4gICAgICBjb25zdCBjdXJyZW50UmVtb3RlcyA9IHsgLi4udGhpcy5yZW1vdGVQbHVnaW5zJC52YWx1ZSB9O1xuICAgICAgcGx1Z2luc1RvQWRkLmZvckVhY2goKHBsdWdpbklkKSA9PiB7XG4gICAgICAgIGNvbnN0IHsgY29udGV4dFBhdGgsIG5hbWUgfSA9IHRoaXMucGFyc2VQbHVnaW5JZChwbHVnaW5JZCk7XG4gICAgICAgIChjdXJyZW50UmVtb3Rlc1tjb250ZXh0UGF0aF0gPSBjdXJyZW50UmVtb3Rlc1tjb250ZXh0UGF0aF0gfHwgW10pLnB1c2gobmFtZSk7XG4gICAgICB9KTtcbiAgICAgIGlmICh0aGlzLmFyY2hpdmVzLmxlbmd0aCA9PT0gNikge1xuICAgICAgICBhd2FpdCB0aGlzLmVjb3N5c3RlbVNlcnZpY2UucmVtb3ZlT2xkZXN0QXJjaGl2ZSh0aGlzLmFwcCwgdGhpcy5hcmNoaXZlcyk7XG4gICAgICB9XG4gICAgICB0aGlzLnVwZGF0ZUFwcGxpY2F0aW9uUmVtb3RlcyhjdXJyZW50UmVtb3Rlcyk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIC8vIGludGVuZGVkIGVtcHR5XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVtb3ZlUGx1Z2lucygpIHtcbiAgICBjb25zdCBodW1hbml6ZWRBcHBOYW1lID0gYXdhaXQgdGhpcy5lY29zeXN0ZW1TZXJ2aWNlLmdldEh1bWFuaXplZEFwcE5hbWUodGhpcy5hcHApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLm1vZGFsLmNvbmZpcm0oXG4gICAgICAgIGdldHRleHQoJ1JlbW92ZSBwbHVnaW5zJyksXG4gICAgICAgIHRoaXMudHJhbnNsYXRlU2VydmljZS5pbnN0YW50KFxuICAgICAgICAgIGdldHRleHQoXG4gICAgICAgICAgICBgWW91IGFyZSBhYm91dCB0byByZW1vdmUgcGx1Z2lucyBmcm9tIGFwcGxpY2F0aW9uIFwie3sgaHVtYW5pemVkQXBwTmFtZSB9fVwiLiBUaGUgb3BlcmF0aW9uIG1heSB0YWtlIHNldmVyYWwgbWludXRlcy4gRHVyaW5nIHRoaXMgdGltZSB0aGUgYXBwbGljYXRpb24gbWF5IGJlIHVuYXZhaWxhYmxlLiBEbyB5b3Ugd2FudCB0byBwcm9jZWVkP2BcbiAgICAgICAgICApLFxuICAgICAgICAgIHsgaHVtYW5pemVkQXBwTmFtZSB9XG4gICAgICAgICksXG4gICAgICAgIFN0YXR1cy5EQU5HRVIsXG4gICAgICAgIHtcbiAgICAgICAgICBvazogZ2V0dGV4dCgnUmVtb3ZlJyksXG4gICAgICAgICAgY2FuY2VsOiBnZXR0ZXh0KCdDYW5jZWwnKVxuICAgICAgICB9XG4gICAgICApO1xuXG4gICAgICBjb25zdCByZW1vdGVzID0geyAuLi50aGlzLnJlbW90ZVBsdWdpbnMkLnZhbHVlIH07XG4gICAgICB0aGlzLnBsdWdpbnNUb0RlbGV0ZS5mb3JFYWNoKChwbHVnaW5JZCkgPT4ge1xuICAgICAgICBjb25zdCB7IGNvbnRleHRQYXRoLCBuYW1lIH0gPSB0aGlzLnBhcnNlUGx1Z2luSWQocGx1Z2luSWQpO1xuICAgICAgICByZW1vdGVzW2NvbnRleHRQYXRoXSA9IHJlbW90ZXNbY29udGV4dFBhdGhdLmZpbHRlcigocCkgPT4gcCAhPT0gbmFtZSk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMudXBkYXRlQXBwbGljYXRpb25SZW1vdGVzKHJlbW90ZXMpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAvLyBkbyBub3RoaW5nXG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRBbGxQbHVnaW5zKCk6IFByb21pc2U8QXBwbGljYXRpb25QbHVnaW5bXT4ge1xuICAgIGNvbnN0IHBsdWdpbnMgPSBbXTtcbiAgICBjb25zdCBwYWNrYWdlcyA9IGF3YWl0IHRoaXMuZWNvc3lzdGVtU2VydmljZS5nZXRQYWNrYWdlQXBwbGljYXRpb25zKCk7XG4gICAgY29uc3QgYXBwcyA9IFsuLi5wYWNrYWdlcywgdGhpcy5hcHBdO1xuICAgIGFwcHMuZm9yRWFjaCgoYXBwKSA9PiB7XG4gICAgICBjb25zdCBleHBvcnRzID0gKGFwcC5tYW5pZmVzdCAmJiBhcHAubWFuaWZlc3QuZXhwb3J0cykgfHwgW107XG4gICAgICBwbHVnaW5zLnB1c2goLi4udGhpcy5leHRlbmRQbHVnaW5MaXN0KGV4cG9ydHMsIGFwcC5jb250ZXh0UGF0aCkpO1xuICAgIH0pO1xuICAgIHJldHVybiBwbHVnaW5zO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB1cGRhdGVBcHBsaWNhdGlvblJlbW90ZXMocmVtb3RlczogQXBwbGljYXRpb25SZW1vdGVQbHVnaW5zKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhpcy5pc0xvYWRpbmcgPSB0cnVlO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnBsdWdpbnNTZXJ2aWNlLnVwZGF0ZVJlbW90ZXNJbkN1bXVsb2NpdHlKc29uKHRoaXMuYXBwLCByZW1vdGVzKTtcbiAgICAgIHRoaXMucmVtb3RlUGx1Z2lucyQubmV4dChyZW1vdGVzKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuZGFuZ2VyKGV4KTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldFJlbW90ZVBsdWdpbnNMaXN0KHJlbW90ZXM6IEFwcGxpY2F0aW9uUmVtb3RlUGx1Z2lucyk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBpbXBvcnRDb250ZXh0UGF0aHMgPSBPYmplY3Qua2V5cyhyZW1vdGVzKTtcbiAgICBjb25zdCBwbHVnaW5zID0gW107XG4gICAgaW1wb3J0Q29udGV4dFBhdGhzLmZvckVhY2goKGNvbnRleHRQYXRoKSA9PiB7XG4gICAgICBjb25zdCBtb2R1bGVOYW1lcyA9IHJlbW90ZXNbY29udGV4dFBhdGhdO1xuICAgICAgcGx1Z2lucy5wdXNoKC4uLm1vZHVsZU5hbWVzLm1hcCgobW9kdWxlKSA9PiB0aGlzLmNyZWF0ZVBsdWdpbklkKGNvbnRleHRQYXRoLCBtb2R1bGUpKSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHBsdWdpbnM7XG4gIH1cblxuICBwcml2YXRlIGV4dGVuZFBsdWdpbkxpc3QocGx1Z2luczogQXBwbGljYXRpb25QbHVnaW5bXSwgY29udGV4dFBhdGg6IHN0cmluZyk6IEFwcGxpY2F0aW9uUGx1Z2luW10ge1xuICAgIGNvbnN0IGV4dGVuZGVkUGx1Z2lucyA9IFtdO1xuICAgIHBsdWdpbnMubWFwKChwKSA9PiB7XG4gICAgICBleHRlbmRlZFBsdWdpbnMucHVzaCh7XG4gICAgICAgIC4uLnAsXG4gICAgICAgIGlkOiB0aGlzLmNyZWF0ZVBsdWdpbklkKGNvbnRleHRQYXRoLCBwLm5hbWUsIHAubW9kdWxlKSxcbiAgICAgICAgY29udGV4dFBhdGhcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiBleHRlbmRlZFBsdWdpbnM7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVBsdWdpbklkKGNvbnRleHRQYXRoOiBzdHJpbmcsIHBsdWdpbk5hbWU6IHN0cmluZywgcGx1Z2luTW9kdWxlTmFtZT86IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGAke2NvbnRleHRQYXRofS8ke3BsdWdpbk1vZHVsZU5hbWUgfHwgcGx1Z2luTmFtZX1gO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZVBsdWdpbklkKGlkOiBzdHJpbmcpOiB7IGNvbnRleHRQYXRoOiBzdHJpbmc7IG5hbWU6IHN0cmluZyB9IHtcbiAgICBjb25zdCBbY29udGV4dFBhdGgsIG5hbWVdID0gaWQuc3BsaXQoJy8nKTtcbiAgICByZXR1cm4geyBjb250ZXh0UGF0aCwgbmFtZSB9O1xuICB9XG59XG4iXX0=