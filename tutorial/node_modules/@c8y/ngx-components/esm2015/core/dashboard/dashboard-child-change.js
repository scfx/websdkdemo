import { sortBy } from 'lodash-es';
import { pipe } from 'rxjs';
import { distinctUntilChanged, expand, filter, map, tap } from 'rxjs/operators';
export class DashboardChildChange {
    constructor(childToChange) {
        this.MIN_WIDTH = 2;
        this.MIN_HEIGHT = 1;
        this.PIXEL_SIZE_THRESHOLD = 10;
        this.diffX = 0;
        this.diffY = 0;
        this.dashboard = childToChange.dashboard;
        this.children = childToChange.dashboard.children
            ? childToChange.dashboard.children.filter(child => childToChange !== child)
            : [];
        this.child = childToChange;
    }
    get resize$() {
        return this.child.dragSource.moved.pipe(map(move => this.getPixelSize(move)), tap(resizeDimension => this.setPixelSize(resizeDimension)), map(resizeDimension => this.getDimensionSize(resizeDimension)), distinctUntilChanged((prev, next) => prev.width === next.width && prev.height === next.height), map(dimension => this.setDimension(dimension)), this.arrangePipe());
    }
    get drag$() {
        return this.child.dragSource.moved.pipe(map(move => this.getDimensionPosition(move)), filter(dimension => dimension.x >= 0 &&
            dimension.x <= this.dashboard.columns - this.child.width &&
            dimension.y >= 0), distinctUntilChanged((prev, next) => prev.x === next.x && prev.y === next.y), this.arrangePipe());
    }
    findFreeDimension() {
        let y = -1;
        let x = 0;
        let found = false;
        const { width, height } = this.child;
        if (width > this.dashboard.columns) {
            throw new Error('The child does not fit on the current dashboard.');
        }
        do {
            x = 0;
            y++;
            while (x + width <= this.dashboard.columns) {
                if (this.getCollided({ x, y, width, height }).length === 0) {
                    found = true;
                    break;
                }
                x++;
            }
        } while (!found);
        return { x, y, width, height };
    }
    collapseUpAll() {
        return sortBy([this.child, ...this.children], ['y']).forEach(w => {
            const ds = new DashboardChildChange(w);
            const newPosition = ds.collapseUp(w);
            ds.setDimension(newPosition);
        });
    }
    arrangeAll(arrange) {
        const { current, scan, spacing, origin } = arrange;
        const collided = this.getCollided(current, sortBy(scan, ['y']));
        return collided.map(child => {
            const ds = new DashboardChildChange(child);
            ds.setDimension(Object.assign(Object.assign({}, child), { y: spacing }));
            return {
                current: child,
                scan: scan.filter(w => w !== child),
                spacing: child.y + child.height,
                origin
            };
        });
    }
    arrangePipe() {
        return pipe(map((dimension) => ({
            current: dimension,
            scan: this.children,
            spacing: dimension.y + dimension.height,
            origin: Object.assign({}, dimension)
        })), expand((dimensions) => this.arrangeAll(dimensions)), map(({ origin }) => origin), map(dimension => this.setDimension(dimension, true)), tap(() => this.collapseUpAll()));
    }
    collapseUp(dimension) {
        let { y } = dimension;
        while (y > 0) {
            if (this.getCollided(Object.assign(Object.assign({}, dimension), { y: y - 1 })).length !== 0) {
                break;
            }
            y--;
        }
        return Object.assign(Object.assign({}, dimension), { y });
    }
    setDimension(dimension, notIfColliding = false) {
        if (notIfColliding && this.getCollided(dimension).length > 0) {
            return;
        }
        this.child.x = dimension.x;
        this.child.y = dimension.y;
        if (dimension.width >= this.MIN_WIDTH &&
            dimension.x + dimension.width <= this.dashboard.columns) {
            this.child.width = dimension.width;
        }
        else if (dimension.width < this.MIN_WIDTH) {
            dimension.width = this.MIN_WIDTH;
        }
        else {
            dimension.width = this.dashboard.columns - dimension.x;
        }
        if (dimension.height >= this.MIN_HEIGHT) {
            this.child.height = dimension.height;
        }
        else {
            dimension.height = this.MIN_WIDTH;
        }
        return dimension;
    }
    setPixelSize({ width, height }) {
        if (width >= this.dashboard.columnSize * this.MIN_WIDTH - this.dashboard.gap) {
            this.child.pxWidth = width + this.PIXEL_SIZE_THRESHOLD;
        }
        if (height >= this.dashboard.rowSize * this.MIN_HEIGHT - this.dashboard.gap) {
            this.child.pxHeight = height + this.PIXEL_SIZE_THRESHOLD;
        }
    }
    getPixelSize(moveEvent) {
        const draggedElement = this.child.element.nativeElement;
        if (!this.diffX) {
            const rect = draggedElement.getBoundingClientRect();
            this.diffX = rect.left;
            this.diffY = rect.top;
        }
        const { x, y } = moveEvent.pointerPosition;
        const width = Math.round(x - this.diffX);
        const height = Math.round(y - this.diffY);
        return { width, height, pointer: { x, y } };
    }
    getDimensionSize(resizePosition) {
        const { x, y } = this.child;
        const ds = this.dashboard.dashboardRect;
        const column = this.dashboard.columnSize;
        const row = this.dashboard.rowSize + this.dashboard.gap;
        const width = Math.round((resizePosition.pointer.x - ds.left + this.dashboard.gap) / column) - x;
        const height = Math.round((resizePosition.pointer.y - ds.top + this.dashboard.gap) / row) - y;
        return { x, y, width, height };
    }
    getDimensionPosition(moveEvent) {
        const draggedElement = moveEvent.source.element.nativeElement.nextElementSibling;
        if (!this.diffX) {
            const rect = draggedElement.getBoundingClientRect();
            this.diffX = moveEvent.pointerPosition.x - rect.left;
            this.diffY = moveEvent.pointerPosition.y - rect.top;
        }
        const left = moveEvent.pointerPosition.x - this.diffX;
        const top = moveEvent.pointerPosition.y - this.diffY;
        const { width, height } = this.child;
        const ds = this.dashboard.dashboardRect;
        const column = this.dashboard.columnSize;
        const row = this.dashboard.rowSize + this.dashboard.gap / 2;
        const x = Math.round((left - ds.left) / column);
        const y = Math.round((top - ds.top) / row);
        return { x, y, width, height };
    }
    doesCollide(a, b) {
        if (b.x === undefined) {
            return false;
        }
        return !(a.y + a.height - 1 < b.y ||
            a.y > b.y + b.height - 1 ||
            a.x + a.width - 1 < b.x ||
            a.x > b.x + b.width - 1);
    }
    getCollided(currentDimension, dimensions = this.children) {
        const collided = dimensions.filter(dimension => this.doesCollide(currentDimension, dimension));
        return collided;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGJvYXJkLWNoaWxkLWNoYW5nZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvZGFzaGJvYXJkL2Rhc2hib2FyZC1jaGlsZC1jaGFuZ2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNuQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVCLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQVNoRixNQUFNLE9BQU8sb0JBQW9CO0lBWS9CLFlBQVksYUFBc0M7UUFQakMsY0FBUyxHQUFHLENBQUMsQ0FBQztRQUN2QixlQUFVLEdBQUcsQ0FBQyxDQUFDO1FBQ04seUJBQW9CLEdBQUcsRUFBRSxDQUFDO1FBRW5DLFVBQUssR0FBRyxDQUFDLENBQUM7UUFDVixVQUFLLEdBQUcsQ0FBQyxDQUFDO1FBR2hCLElBQUksQ0FBQyxTQUFTLEdBQUcsYUFBYSxDQUFDLFNBQVMsQ0FBQztRQUN6QyxJQUFJLENBQUMsUUFBUSxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsUUFBUTtZQUM5QyxDQUFDLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsYUFBYSxLQUFLLEtBQUssQ0FBQztZQUMzRSxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ1AsSUFBSSxDQUFDLEtBQUssR0FBRyxhQUFhLENBQUM7SUFDN0IsQ0FBQztJQUVELElBQUksT0FBTztRQUNULE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUksQ0FDckMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUNwQyxHQUFHLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxDQUFDLEVBQzFELEdBQUcsQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUM5RCxvQkFBb0IsQ0FDbEIsQ0FBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxLQUFLLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsTUFBTSxDQUN6RSxFQUNELEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUMsRUFDOUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUNuQixDQUFDO0lBQ0osQ0FBQztJQUVELElBQUksS0FBSztRQUNQLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUksQ0FDckMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxDQUFDLEVBQzVDLE1BQU0sQ0FDSixTQUFTLENBQUMsRUFBRSxDQUNWLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNoQixTQUFTLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSztZQUN4RCxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FDbkIsRUFDRCxvQkFBb0IsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsRUFDNUUsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUNuQixDQUFDO0lBQ0osQ0FBQztJQUVELGlCQUFpQjtRQUNmLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ1gsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ1YsSUFBSSxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ2xCLE1BQU0sRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNyQyxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRTtZQUNsQyxNQUFNLElBQUksS0FBSyxDQUFDLGtEQUFrRCxDQUFDLENBQUM7U0FDckU7UUFDRCxHQUFHO1lBQ0QsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNOLENBQUMsRUFBRSxDQUFDO1lBQ0osT0FBTyxDQUFDLEdBQUcsS0FBSyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFO2dCQUMxQyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7b0JBQzFELEtBQUssR0FBRyxJQUFJLENBQUM7b0JBQ2IsTUFBTTtpQkFDUDtnQkFDRCxDQUFDLEVBQUUsQ0FBQzthQUNMO1NBQ0YsUUFBUSxDQUFDLEtBQUssRUFBRTtRQUNqQixPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUE2QixDQUFDO0lBQzVELENBQUM7SUFFRCxhQUFhO1FBQ1gsT0FBTyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDL0QsTUFBTSxFQUFFLEdBQUcsSUFBSSxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN2QyxNQUFNLFdBQVcsR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JDLEVBQUUsQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDL0IsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsVUFBVSxDQUFDLE9BQWtDO1FBQzNDLE1BQU0sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxPQUFPLENBQUM7UUFDbkQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNoRSxPQUFPLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDMUIsTUFBTSxFQUFFLEdBQUcsSUFBSSxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMzQyxFQUFFLENBQUMsWUFBWSxpQ0FBTSxLQUFLLEtBQUUsQ0FBQyxFQUFFLE9BQU8sSUFBRyxDQUFDO1lBQzFDLE9BQU87Z0JBQ0wsT0FBTyxFQUFFLEtBQUs7Z0JBQ2QsSUFBSSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssS0FBSyxDQUFDO2dCQUNuQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTTtnQkFDL0IsTUFBTTthQUNQLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyxXQUFXO1FBQ2pCLE9BQU8sSUFBSSxDQUNULEdBQUcsQ0FDRCxDQUFDLFNBQWtDLEVBQUUsRUFBRSxDQUNyQyxDQUFDO1lBQ0MsT0FBTyxFQUFFLFNBQVM7WUFDbEIsSUFBSSxFQUFFLElBQUksQ0FBQyxRQUFRO1lBQ25CLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNO1lBQ3ZDLE1BQU0sb0JBQU8sU0FBUyxDQUFFO1NBQ0ssQ0FBQSxDQUNsQyxFQUNELE1BQU0sQ0FBQyxDQUFDLFVBQXFDLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUMsRUFDOUUsR0FBRyxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQzNCLEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDLEVBQ3BELEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FDaEMsQ0FBQztJQUNKLENBQUM7SUFFTyxVQUFVLENBQUMsU0FBa0M7UUFDbkQsSUFBSSxFQUFFLENBQUMsRUFBRSxHQUFHLFNBQVMsQ0FBQztRQUN0QixPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUU7WUFDWixJQUFJLElBQUksQ0FBQyxXQUFXLGlDQUFNLFNBQVMsS0FBRSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBRyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQzdELE1BQU07YUFDUDtZQUNELENBQUMsRUFBRSxDQUFDO1NBQ0w7UUFDRCx1Q0FBWSxTQUFTLEtBQUUsQ0FBQyxJQUFHO0lBQzdCLENBQUM7SUFFTyxZQUFZLENBQUMsU0FBa0MsRUFBRSxjQUFjLEdBQUcsS0FBSztRQUM3RSxJQUFJLGNBQWMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDNUQsT0FBTztTQUNSO1FBRUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUMzQixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQzNCLElBQ0UsU0FBUyxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsU0FBUztZQUNqQyxTQUFTLENBQUMsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQ3ZEO1lBQ0EsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQztTQUNwQzthQUFNLElBQUksU0FBUyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQzNDLFNBQVMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztTQUNsQzthQUFNO1lBQ0wsU0FBUyxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDO1NBQ3hEO1FBQ0QsSUFBSSxTQUFTLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDdkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQztTQUN0QzthQUFNO1lBQ0wsU0FBUyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1NBQ25DO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVPLFlBQVksQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUU7UUFDcEMsSUFBSSxLQUFLLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtZQUM1RSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxLQUFLLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDO1NBQ3hEO1FBQ0QsSUFBSSxNQUFNLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtZQUMzRSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxNQUFNLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDO1NBQzFEO0lBQ0gsQ0FBQztJQUVPLFlBQVksQ0FBQyxTQUFzQjtRQUN6QyxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUM7UUFDeEQsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDZixNQUFNLElBQUksR0FBRyxjQUFjLENBQUMscUJBQXFCLEVBQUUsQ0FBQztZQUNwRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDdkIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO1NBQ3ZCO1FBQ0QsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsR0FBRyxTQUFTLENBQUMsZUFBZSxDQUFDO1FBQzNDLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN6QyxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDMUMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFtQyxDQUFDO0lBQy9FLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxjQUE2QztRQUNwRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDNUIsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUM7UUFDeEMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUM7UUFDekMsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUM7UUFDeEQsTUFBTSxLQUFLLEdBQ1QsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDckYsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDOUYsT0FBTyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBNkIsQ0FBQztJQUM1RCxDQUFDO0lBRU8sb0JBQW9CLENBQUMsU0FBc0I7UUFDakQsTUFBTSxjQUFjLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLGtCQUFrQixDQUFDO1FBQ2pGLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ2YsTUFBTSxJQUFJLEdBQUcsY0FBYyxDQUFDLHFCQUFxQixFQUFFLENBQUM7WUFDcEQsSUFBSSxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUMsZUFBZSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO1lBQ3JELElBQUksQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDLGVBQWUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQztTQUNyRDtRQUVELE1BQU0sSUFBSSxHQUFHLFNBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDdEQsTUFBTSxHQUFHLEdBQUcsU0FBUyxDQUFDLGVBQWUsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNyRCxNQUFNLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDckMsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUM7UUFDeEMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUM7UUFDekMsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBQzVELE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxDQUFDO1FBQ2hELE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBQzNDLE9BQU8sRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQTZCLENBQUM7SUFDNUQsQ0FBQztJQUVPLFdBQVcsQ0FBQyxDQUEwQixFQUFFLENBQTBCO1FBQ3hFLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxTQUFTLEVBQUU7WUFDckIsT0FBTyxLQUFLLENBQUM7U0FDZDtRQUNELE9BQU8sQ0FBQyxDQUNOLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDeEIsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQztZQUN4QixDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3ZCLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FDeEIsQ0FBQztJQUNKLENBQUM7SUFFTyxXQUFXLENBQUMsZ0JBQXlDLEVBQUUsVUFBVSxHQUFHLElBQUksQ0FBQyxRQUFRO1FBQ3ZGLE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDL0YsT0FBTyxRQUFRLENBQUM7SUFDbEIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2RrRHJhZ01vdmUgfSBmcm9tICdAYW5ndWxhci9jZGsvZHJhZy1kcm9wJztcbmltcG9ydCB7IHNvcnRCeSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBwaXBlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZXhwYW5kLCBmaWx0ZXIsIG1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRGFzaGJvYXJkQ29tcG9uZW50IH0gZnJvbSAnLi9kYXNoYm9hcmQuY29tcG9uZW50JztcbmltcG9ydCB7XG4gIERhc2hib2FyZENoaWxkRGltZW5zaW9uLFxuICBEYXNoYm9hcmRDaGlsZFJlc2l6ZURpbWVuc2lvbixcbiAgRGFzaGJvYXJkQ2hpbGRBcnJhbmdlbWVudFxufSBmcm9tICcuL2Rhc2hib2FyZC5tb2RlbCc7XG5pbXBvcnQgeyBEYXNoYm9hcmRDaGlsZENvbXBvbmVudCB9IGZyb20gJy4vZGFzaGJvYXJkLWNoaWxkLmNvbXBvbmVudCc7XG5cbmV4cG9ydCBjbGFzcyBEYXNoYm9hcmRDaGlsZENoYW5nZSB7XG4gIGNoaWxkOiBEYXNoYm9hcmRDaGlsZENvbXBvbmVudDtcbiAgY2hpbGRyZW46IERhc2hib2FyZENoaWxkQ29tcG9uZW50W107XG4gIHByaXZhdGUgZGFzaGJvYXJkOiBEYXNoYm9hcmRDb21wb25lbnQ7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBNSU5fV0lEVEggPSAyO1xuICBwcml2YXRlIE1JTl9IRUlHSFQgPSAxO1xuICBwcml2YXRlIHJlYWRvbmx5IFBJWEVMX1NJWkVfVEhSRVNIT0xEID0gMTA7XG5cbiAgcHJpdmF0ZSBkaWZmWCA9IDA7XG4gIHByaXZhdGUgZGlmZlkgPSAwO1xuXG4gIGNvbnN0cnVjdG9yKGNoaWxkVG9DaGFuZ2U6IERhc2hib2FyZENoaWxkQ29tcG9uZW50KSB7XG4gICAgdGhpcy5kYXNoYm9hcmQgPSBjaGlsZFRvQ2hhbmdlLmRhc2hib2FyZDtcbiAgICB0aGlzLmNoaWxkcmVuID0gY2hpbGRUb0NoYW5nZS5kYXNoYm9hcmQuY2hpbGRyZW5cbiAgICAgID8gY2hpbGRUb0NoYW5nZS5kYXNoYm9hcmQuY2hpbGRyZW4uZmlsdGVyKGNoaWxkID0+IGNoaWxkVG9DaGFuZ2UgIT09IGNoaWxkKVxuICAgICAgOiBbXTtcbiAgICB0aGlzLmNoaWxkID0gY2hpbGRUb0NoYW5nZTtcbiAgfVxuXG4gIGdldCByZXNpemUkKCkge1xuICAgIHJldHVybiB0aGlzLmNoaWxkLmRyYWdTb3VyY2UubW92ZWQucGlwZShcbiAgICAgIG1hcChtb3ZlID0+IHRoaXMuZ2V0UGl4ZWxTaXplKG1vdmUpKSxcbiAgICAgIHRhcChyZXNpemVEaW1lbnNpb24gPT4gdGhpcy5zZXRQaXhlbFNpemUocmVzaXplRGltZW5zaW9uKSksXG4gICAgICBtYXAocmVzaXplRGltZW5zaW9uID0+IHRoaXMuZ2V0RGltZW5zaW9uU2l6ZShyZXNpemVEaW1lbnNpb24pKSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKFxuICAgICAgICAocHJldiwgbmV4dCkgPT4gcHJldi53aWR0aCA9PT0gbmV4dC53aWR0aCAmJiBwcmV2LmhlaWdodCA9PT0gbmV4dC5oZWlnaHRcbiAgICAgICksXG4gICAgICBtYXAoZGltZW5zaW9uID0+IHRoaXMuc2V0RGltZW5zaW9uKGRpbWVuc2lvbikpLFxuICAgICAgdGhpcy5hcnJhbmdlUGlwZSgpXG4gICAgKTtcbiAgfVxuXG4gIGdldCBkcmFnJCgpIHtcbiAgICByZXR1cm4gdGhpcy5jaGlsZC5kcmFnU291cmNlLm1vdmVkLnBpcGUoXG4gICAgICBtYXAobW92ZSA9PiB0aGlzLmdldERpbWVuc2lvblBvc2l0aW9uKG1vdmUpKSxcbiAgICAgIGZpbHRlcihcbiAgICAgICAgZGltZW5zaW9uID0+XG4gICAgICAgICAgZGltZW5zaW9uLnggPj0gMCAmJlxuICAgICAgICAgIGRpbWVuc2lvbi54IDw9IHRoaXMuZGFzaGJvYXJkLmNvbHVtbnMgLSB0aGlzLmNoaWxkLndpZHRoICYmXG4gICAgICAgICAgZGltZW5zaW9uLnkgPj0gMFxuICAgICAgKSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKChwcmV2LCBuZXh0KSA9PiBwcmV2LnggPT09IG5leHQueCAmJiBwcmV2LnkgPT09IG5leHQueSksXG4gICAgICB0aGlzLmFycmFuZ2VQaXBlKClcbiAgICApO1xuICB9XG5cbiAgZmluZEZyZWVEaW1lbnNpb24oKSB7XG4gICAgbGV0IHkgPSAtMTtcbiAgICBsZXQgeCA9IDA7XG4gICAgbGV0IGZvdW5kID0gZmFsc2U7XG4gICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSB0aGlzLmNoaWxkO1xuICAgIGlmICh3aWR0aCA+IHRoaXMuZGFzaGJvYXJkLmNvbHVtbnMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIGNoaWxkIGRvZXMgbm90IGZpdCBvbiB0aGUgY3VycmVudCBkYXNoYm9hcmQuJyk7XG4gICAgfVxuICAgIGRvIHtcbiAgICAgIHggPSAwO1xuICAgICAgeSsrO1xuICAgICAgd2hpbGUgKHggKyB3aWR0aCA8PSB0aGlzLmRhc2hib2FyZC5jb2x1bW5zKSB7XG4gICAgICAgIGlmICh0aGlzLmdldENvbGxpZGVkKHsgeCwgeSwgd2lkdGgsIGhlaWdodCB9KS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICBmb3VuZCA9IHRydWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgeCsrO1xuICAgICAgfVxuICAgIH0gd2hpbGUgKCFmb3VuZCk7XG4gICAgcmV0dXJuIHsgeCwgeSwgd2lkdGgsIGhlaWdodCB9IGFzIERhc2hib2FyZENoaWxkRGltZW5zaW9uO1xuICB9XG5cbiAgY29sbGFwc2VVcEFsbCgpOiB2b2lkIHtcbiAgICByZXR1cm4gc29ydEJ5KFt0aGlzLmNoaWxkLCAuLi50aGlzLmNoaWxkcmVuXSwgWyd5J10pLmZvckVhY2godyA9PiB7XG4gICAgICBjb25zdCBkcyA9IG5ldyBEYXNoYm9hcmRDaGlsZENoYW5nZSh3KTtcbiAgICAgIGNvbnN0IG5ld1Bvc2l0aW9uID0gZHMuY29sbGFwc2VVcCh3KTtcbiAgICAgIGRzLnNldERpbWVuc2lvbihuZXdQb3NpdGlvbik7XG4gICAgfSk7XG4gIH1cblxuICBhcnJhbmdlQWxsKGFycmFuZ2U6IERhc2hib2FyZENoaWxkQXJyYW5nZW1lbnQpIHtcbiAgICBjb25zdCB7IGN1cnJlbnQsIHNjYW4sIHNwYWNpbmcsIG9yaWdpbiB9ID0gYXJyYW5nZTtcbiAgICBjb25zdCBjb2xsaWRlZCA9IHRoaXMuZ2V0Q29sbGlkZWQoY3VycmVudCwgc29ydEJ5KHNjYW4sIFsneSddKSk7XG4gICAgcmV0dXJuIGNvbGxpZGVkLm1hcChjaGlsZCA9PiB7XG4gICAgICBjb25zdCBkcyA9IG5ldyBEYXNoYm9hcmRDaGlsZENoYW5nZShjaGlsZCk7XG4gICAgICBkcy5zZXREaW1lbnNpb24oeyAuLi5jaGlsZCwgeTogc3BhY2luZyB9KTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGN1cnJlbnQ6IGNoaWxkLFxuICAgICAgICBzY2FuOiBzY2FuLmZpbHRlcih3ID0+IHcgIT09IGNoaWxkKSxcbiAgICAgICAgc3BhY2luZzogY2hpbGQueSArIGNoaWxkLmhlaWdodCxcbiAgICAgICAgb3JpZ2luXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhcnJhbmdlUGlwZSgpIHtcbiAgICByZXR1cm4gcGlwZShcbiAgICAgIG1hcChcbiAgICAgICAgKGRpbWVuc2lvbjogRGFzaGJvYXJkQ2hpbGREaW1lbnNpb24pID0+XG4gICAgICAgICAgKHtcbiAgICAgICAgICAgIGN1cnJlbnQ6IGRpbWVuc2lvbixcbiAgICAgICAgICAgIHNjYW46IHRoaXMuY2hpbGRyZW4sXG4gICAgICAgICAgICBzcGFjaW5nOiBkaW1lbnNpb24ueSArIGRpbWVuc2lvbi5oZWlnaHQsXG4gICAgICAgICAgICBvcmlnaW46IHsgLi4uZGltZW5zaW9uIH1cbiAgICAgICAgICB9IGFzIERhc2hib2FyZENoaWxkQXJyYW5nZW1lbnQpXG4gICAgICApLFxuICAgICAgZXhwYW5kKChkaW1lbnNpb25zOiBEYXNoYm9hcmRDaGlsZEFycmFuZ2VtZW50KSA9PiB0aGlzLmFycmFuZ2VBbGwoZGltZW5zaW9ucykpLFxuICAgICAgbWFwKCh7IG9yaWdpbiB9KSA9PiBvcmlnaW4pLFxuICAgICAgbWFwKGRpbWVuc2lvbiA9PiB0aGlzLnNldERpbWVuc2lvbihkaW1lbnNpb24sIHRydWUpKSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLmNvbGxhcHNlVXBBbGwoKSlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjb2xsYXBzZVVwKGRpbWVuc2lvbjogRGFzaGJvYXJkQ2hpbGREaW1lbnNpb24pIHtcbiAgICBsZXQgeyB5IH0gPSBkaW1lbnNpb247XG4gICAgd2hpbGUgKHkgPiAwKSB7XG4gICAgICBpZiAodGhpcy5nZXRDb2xsaWRlZCh7IC4uLmRpbWVuc2lvbiwgeTogeSAtIDEgfSkubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgeS0tO1xuICAgIH1cbiAgICByZXR1cm4geyAuLi5kaW1lbnNpb24sIHkgfTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0RGltZW5zaW9uKGRpbWVuc2lvbjogRGFzaGJvYXJkQ2hpbGREaW1lbnNpb24sIG5vdElmQ29sbGlkaW5nID0gZmFsc2UpIHtcbiAgICBpZiAobm90SWZDb2xsaWRpbmcgJiYgdGhpcy5nZXRDb2xsaWRlZChkaW1lbnNpb24pLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmNoaWxkLnggPSBkaW1lbnNpb24ueDtcbiAgICB0aGlzLmNoaWxkLnkgPSBkaW1lbnNpb24ueTtcbiAgICBpZiAoXG4gICAgICBkaW1lbnNpb24ud2lkdGggPj0gdGhpcy5NSU5fV0lEVEggJiZcbiAgICAgIGRpbWVuc2lvbi54ICsgZGltZW5zaW9uLndpZHRoIDw9IHRoaXMuZGFzaGJvYXJkLmNvbHVtbnNcbiAgICApIHtcbiAgICAgIHRoaXMuY2hpbGQud2lkdGggPSBkaW1lbnNpb24ud2lkdGg7XG4gICAgfSBlbHNlIGlmIChkaW1lbnNpb24ud2lkdGggPCB0aGlzLk1JTl9XSURUSCkge1xuICAgICAgZGltZW5zaW9uLndpZHRoID0gdGhpcy5NSU5fV0lEVEg7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRpbWVuc2lvbi53aWR0aCA9IHRoaXMuZGFzaGJvYXJkLmNvbHVtbnMgLSBkaW1lbnNpb24ueDtcbiAgICB9XG4gICAgaWYgKGRpbWVuc2lvbi5oZWlnaHQgPj0gdGhpcy5NSU5fSEVJR0hUKSB7XG4gICAgICB0aGlzLmNoaWxkLmhlaWdodCA9IGRpbWVuc2lvbi5oZWlnaHQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRpbWVuc2lvbi5oZWlnaHQgPSB0aGlzLk1JTl9XSURUSDtcbiAgICB9XG4gICAgcmV0dXJuIGRpbWVuc2lvbjtcbiAgfVxuXG4gIHByaXZhdGUgc2V0UGl4ZWxTaXplKHsgd2lkdGgsIGhlaWdodCB9KSB7XG4gICAgaWYgKHdpZHRoID49IHRoaXMuZGFzaGJvYXJkLmNvbHVtblNpemUgKiB0aGlzLk1JTl9XSURUSCAtIHRoaXMuZGFzaGJvYXJkLmdhcCkge1xuICAgICAgdGhpcy5jaGlsZC5weFdpZHRoID0gd2lkdGggKyB0aGlzLlBJWEVMX1NJWkVfVEhSRVNIT0xEO1xuICAgIH1cbiAgICBpZiAoaGVpZ2h0ID49IHRoaXMuZGFzaGJvYXJkLnJvd1NpemUgKiB0aGlzLk1JTl9IRUlHSFQgLSB0aGlzLmRhc2hib2FyZC5nYXApIHtcbiAgICAgIHRoaXMuY2hpbGQucHhIZWlnaHQgPSBoZWlnaHQgKyB0aGlzLlBJWEVMX1NJWkVfVEhSRVNIT0xEO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0UGl4ZWxTaXplKG1vdmVFdmVudDogQ2RrRHJhZ01vdmUpIHtcbiAgICBjb25zdCBkcmFnZ2VkRWxlbWVudCA9IHRoaXMuY2hpbGQuZWxlbWVudC5uYXRpdmVFbGVtZW50O1xuICAgIGlmICghdGhpcy5kaWZmWCkge1xuICAgICAgY29uc3QgcmVjdCA9IGRyYWdnZWRFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgICAgdGhpcy5kaWZmWCA9IHJlY3QubGVmdDtcbiAgICAgIHRoaXMuZGlmZlkgPSByZWN0LnRvcDtcbiAgICB9XG4gICAgY29uc3QgeyB4LCB5IH0gPSBtb3ZlRXZlbnQucG9pbnRlclBvc2l0aW9uO1xuICAgIGNvbnN0IHdpZHRoID0gTWF0aC5yb3VuZCh4IC0gdGhpcy5kaWZmWCk7XG4gICAgY29uc3QgaGVpZ2h0ID0gTWF0aC5yb3VuZCh5IC0gdGhpcy5kaWZmWSk7XG4gICAgcmV0dXJuIHsgd2lkdGgsIGhlaWdodCwgcG9pbnRlcjogeyB4LCB5IH0gfSBhcyBEYXNoYm9hcmRDaGlsZFJlc2l6ZURpbWVuc2lvbjtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGltZW5zaW9uU2l6ZShyZXNpemVQb3NpdGlvbjogRGFzaGJvYXJkQ2hpbGRSZXNpemVEaW1lbnNpb24pIHtcbiAgICBjb25zdCB7IHgsIHkgfSA9IHRoaXMuY2hpbGQ7XG4gICAgY29uc3QgZHMgPSB0aGlzLmRhc2hib2FyZC5kYXNoYm9hcmRSZWN0O1xuICAgIGNvbnN0IGNvbHVtbiA9IHRoaXMuZGFzaGJvYXJkLmNvbHVtblNpemU7XG4gICAgY29uc3Qgcm93ID0gdGhpcy5kYXNoYm9hcmQucm93U2l6ZSArIHRoaXMuZGFzaGJvYXJkLmdhcDtcbiAgICBjb25zdCB3aWR0aCA9XG4gICAgICBNYXRoLnJvdW5kKChyZXNpemVQb3NpdGlvbi5wb2ludGVyLnggLSBkcy5sZWZ0ICsgdGhpcy5kYXNoYm9hcmQuZ2FwKSAvIGNvbHVtbikgLSB4O1xuICAgIGNvbnN0IGhlaWdodCA9IE1hdGgucm91bmQoKHJlc2l6ZVBvc2l0aW9uLnBvaW50ZXIueSAtIGRzLnRvcCArIHRoaXMuZGFzaGJvYXJkLmdhcCkgLyByb3cpIC0geTtcbiAgICByZXR1cm4geyB4LCB5LCB3aWR0aCwgaGVpZ2h0IH0gYXMgRGFzaGJvYXJkQ2hpbGREaW1lbnNpb247XG4gIH1cblxuICBwcml2YXRlIGdldERpbWVuc2lvblBvc2l0aW9uKG1vdmVFdmVudDogQ2RrRHJhZ01vdmUpIHtcbiAgICBjb25zdCBkcmFnZ2VkRWxlbWVudCA9IG1vdmVFdmVudC5zb3VyY2UuZWxlbWVudC5uYXRpdmVFbGVtZW50Lm5leHRFbGVtZW50U2libGluZztcbiAgICBpZiAoIXRoaXMuZGlmZlgpIHtcbiAgICAgIGNvbnN0IHJlY3QgPSBkcmFnZ2VkRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICAgIHRoaXMuZGlmZlggPSBtb3ZlRXZlbnQucG9pbnRlclBvc2l0aW9uLnggLSByZWN0LmxlZnQ7XG4gICAgICB0aGlzLmRpZmZZID0gbW92ZUV2ZW50LnBvaW50ZXJQb3NpdGlvbi55IC0gcmVjdC50b3A7XG4gICAgfVxuXG4gICAgY29uc3QgbGVmdCA9IG1vdmVFdmVudC5wb2ludGVyUG9zaXRpb24ueCAtIHRoaXMuZGlmZlg7XG4gICAgY29uc3QgdG9wID0gbW92ZUV2ZW50LnBvaW50ZXJQb3NpdGlvbi55IC0gdGhpcy5kaWZmWTtcbiAgICBjb25zdCB7IHdpZHRoLCBoZWlnaHQgfSA9IHRoaXMuY2hpbGQ7XG4gICAgY29uc3QgZHMgPSB0aGlzLmRhc2hib2FyZC5kYXNoYm9hcmRSZWN0O1xuICAgIGNvbnN0IGNvbHVtbiA9IHRoaXMuZGFzaGJvYXJkLmNvbHVtblNpemU7XG4gICAgY29uc3Qgcm93ID0gdGhpcy5kYXNoYm9hcmQucm93U2l6ZSArIHRoaXMuZGFzaGJvYXJkLmdhcCAvIDI7XG4gICAgY29uc3QgeCA9IE1hdGgucm91bmQoKGxlZnQgLSBkcy5sZWZ0KSAvIGNvbHVtbik7XG4gICAgY29uc3QgeSA9IE1hdGgucm91bmQoKHRvcCAtIGRzLnRvcCkgLyByb3cpO1xuICAgIHJldHVybiB7IHgsIHksIHdpZHRoLCBoZWlnaHQgfSBhcyBEYXNoYm9hcmRDaGlsZERpbWVuc2lvbjtcbiAgfVxuXG4gIHByaXZhdGUgZG9lc0NvbGxpZGUoYTogRGFzaGJvYXJkQ2hpbGREaW1lbnNpb24sIGI6IERhc2hib2FyZENoaWxkRGltZW5zaW9uKSB7XG4gICAgaWYgKGIueCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiAhKFxuICAgICAgYS55ICsgYS5oZWlnaHQgLSAxIDwgYi55IHx8XG4gICAgICBhLnkgPiBiLnkgKyBiLmhlaWdodCAtIDEgfHxcbiAgICAgIGEueCArIGEud2lkdGggLSAxIDwgYi54IHx8XG4gICAgICBhLnggPiBiLnggKyBiLndpZHRoIC0gMVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldENvbGxpZGVkKGN1cnJlbnREaW1lbnNpb246IERhc2hib2FyZENoaWxkRGltZW5zaW9uLCBkaW1lbnNpb25zID0gdGhpcy5jaGlsZHJlbikge1xuICAgIGNvbnN0IGNvbGxpZGVkID0gZGltZW5zaW9ucy5maWx0ZXIoZGltZW5zaW9uID0+IHRoaXMuZG9lc0NvbGxpZGUoY3VycmVudERpbWVuc2lvbiwgZGltZW5zaW9uKSk7XG4gICAgcmV0dXJuIGNvbGxpZGVkO1xuICB9XG59XG4iXX0=