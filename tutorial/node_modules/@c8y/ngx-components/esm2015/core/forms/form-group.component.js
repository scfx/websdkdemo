import { Component, ContentChild, HostBinding, Input } from '@angular/core';
import { NgModel } from '@angular/forms';
import { timer, merge } from 'rxjs';
import { debounce, filter } from 'rxjs/operators';
import { MessagesComponent } from './messages.component';
/**
 * A form group helps to validate an input of a form element.
 *
 * ## Example:
 *
 * ```html
 *  <c8y-form-group [hasWarning]="user.email.length === 0">
 *   <label translate for="userEmail">Email</label>
 *   <input
 *     id="userEmail"
 *     class="form-control"
 *     type="email"
 *     name="email"
 *     [maxlength]="254"
 *     autocomplete="off"
 *     placeholder="{{'e.g. joe.doe@example.com' | translate}}"
 *     [(ngModel)]="user.email"
 *     email
 *     required
 *   >
 *   <c8y-messages>
 *     <c8y-message *ngIf="user.email.length === 0" translate></c8y-message>
 *     <c8y-message name="required" text="The E-Mail is SUPER required"></c8y-message>
 *   </c8y-messages>
 *  </c8y-form-group>
 * ```
 *
 * @param status The current status could be error, warning or success.
 * @param hasError Set this to true to display a error.
 * @param hasWarning Set this to true to display a warning.
 * @param hasSuccess Set this to true to display a success.
 * @param novalidation Set this to true to disable automatic validation by this component.
 */
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/common';
import * as ɵngcc2 from './messages.component';

function FormGroupComponent_c8y_messages_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "c8y-messages", 1);
} if (rf & 2) {
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵproperty("show", ctx_r0.errors);
} }
const _c0 = ["*"];
export class FormGroupComponent {
    constructor() {
        this.hasError = false;
        this.hasWarning = false;
        this.hasSuccess = false;
        this.novalidation = false;
        this.VALIDATION_DEBOUNCE_MS = 1000;
    }
    get error() {
        return this.status === 'error' || this.hasError;
    }
    get warning() {
        return this.status === 'warning' || this.hasWarning;
    }
    get success() {
        return this.status === 'success' || this.hasSuccess;
    }
    ngAfterContentInit() {
        this.initNgModel();
    }
    initNgModel() {
        if (this.model) {
            this.model.valueAccessor.registerOnTouched(() => {
                if (this.model.control && !this.model.control.dirty) {
                    this.model.control.markAsDirty();
                    this.model.control.updateValueAndValidity({ onlySelf: true });
                }
            });
            this.subscription = merge(this.model.valueChanges, this.model.statusChanges)
                .pipe(filter(() => this.model.dirty && !this.novalidation), debounce(() => (this.hasError ? timer(10) : timer(this.VALIDATION_DEBOUNCE_MS))))
                .subscribe(() => this.update());
        }
    }
    update() {
        this.hasError = this.model.status === 'INVALID';
        if (this.customErrorMessage) {
            this.customErrorMessage.changVisibility(this.model.errors);
        }
        else {
            this.errors = this.model.errors;
        }
    }
    ngOnDestroy() {
        if (this.subscription) {
            this.subscription.unsubscribe();
        }
    }
}
FormGroupComponent.ɵfac = function FormGroupComponent_Factory(t) { return new (t || FormGroupComponent)(); };
FormGroupComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: FormGroupComponent, selectors: [["c8y-form-group"]], contentQueries: function FormGroupComponent_ContentQueries(rf, ctx, dirIndex) { if (rf & 1) {
        ɵngcc0.ɵɵcontentQuery(dirIndex, MessagesComponent, 5);
        ɵngcc0.ɵɵcontentQuery(dirIndex, NgModel, 7);
    } if (rf & 2) {
        let _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.customErrorMessage = _t.first);
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.model = _t.first);
    } }, hostAttrs: [1, "form-group"], hostVars: 6, hostBindings: function FormGroupComponent_HostBindings(rf, ctx) { if (rf & 2) {
        ɵngcc0.ɵɵclassProp("has-error", ctx.error)("has-warning", ctx.warning)("has-success", ctx.success);
    } }, inputs: { hasError: "hasError", hasWarning: "hasWarning", hasSuccess: "hasSuccess", novalidation: "novalidation", status: "status" }, ngContentSelectors: _c0, decls: 2, vars: 1, consts: [[3, "show", 4, "ngIf"], [3, "show"]], template: function FormGroupComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵprojectionDef();
        ɵngcc0.ɵɵprojection(0);
        ɵngcc0.ɵɵtemplate(1, FormGroupComponent_c8y_messages_1_Template, 1, 1, "c8y-messages", 0);
    } if (rf & 2) {
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", !ctx.customErrorMessage);
    } }, directives: [ɵngcc1.NgIf, ɵngcc2.MessagesComponent], encapsulation: 2 });
FormGroupComponent.propDecorators = {
    hasError: [{ type: Input }],
    hasWarning: [{ type: Input }],
    hasSuccess: [{ type: Input }],
    novalidation: [{ type: Input }],
    status: [{ type: Input }],
    error: [{ type: HostBinding, args: ['class.has-error',] }],
    warning: [{ type: HostBinding, args: ['class.has-warning',] }],
    success: [{ type: HostBinding, args: ['class.has-success',] }],
    customErrorMessage: [{ type: ContentChild, args: [MessagesComponent, { static: false },] }],
    model: [{ type: ContentChild, args: [NgModel, { static: true },] }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(FormGroupComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-form-group',
                template: "<ng-content></ng-content>\n<c8y-messages *ngIf=\"!customErrorMessage\" [show]=\"errors\"></c8y-messages>\n",
                host: {
                    class: 'form-group'
                }
            }]
    }], function () { return []; }, { hasError: [{
            type: Input
        }], hasWarning: [{
            type: Input
        }], hasSuccess: [{
            type: Input
        }], novalidation: [{
            type: Input
        }], error: [{
            type: HostBinding,
            args: ['class.has-error']
        }], warning: [{
            type: HostBinding,
            args: ['class.has-warning']
        }], success: [{
            type: HostBinding,
            args: ['class.has-success']
        }], status: [{
            type: Input
        }], customErrorMessage: [{
            type: ContentChild,
            args: [MessagesComponent, { static: false }]
        }], model: [{
            type: ContentChild,
            args: [NgModel, { static: true }]
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZm9ybS1ncm91cC5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvZm9ybXMvZm9ybS1ncm91cC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1RSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekMsT0FBTyxFQUFnQixLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2xELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDekQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBQUc7Ozs7Ozs7Ozs7OztBQVFILE1BQU0sT0FBTyxrQkFBa0I7QUFDL0IsSUFSQTtBQUNHLFFBT1EsYUFBUSxHQUFHLEtBQUssQ0FBQztBQUM1QixRQUFXLGVBQVUsR0FBRyxLQUFLLENBQUM7QUFDOUIsUUFBVyxlQUFVLEdBQUcsS0FBSyxDQUFDO0FBQzlCLFFBQVcsaUJBQVksR0FBRyxLQUFLLENBQUM7QUFDaEMsUUFlbUIsMkJBQXNCLEdBQUcsSUFBSSxDQUFDO0FBQ2pELElBb0NBLENBQUM7QUFDRCxJQXBERSxJQUFvQyxLQUFLO0FBQzNDLFFBQUksT0FBTyxJQUFJLENBQUMsTUFBTSxLQUFLLE9BQU8sSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDO0FBQ3BELElBQUUsQ0FBQztBQUNILElBQUUsSUFBc0MsT0FBTztBQUMvQyxRQUFJLE9BQU8sSUFBSSxDQUFDLE1BQU0sS0FBSyxTQUFTLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQztBQUN4RCxJQUFFLENBQUM7QUFDSCxJQUFFLElBQXNDLE9BQU87QUFDL0MsUUFBSSxPQUFPLElBQUksQ0FBQyxNQUFNLEtBQUssU0FBUyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUM7QUFDeEQsSUFBRSxDQUFDO0FBQ0gsSUFPRSxrQkFBa0I7QUFBSyxRQUNyQixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7QUFDdkIsSUFBRSxDQUFDO0FBQ0gsSUFDRSxXQUFXO0FBQ2IsUUFBSSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7QUFDcEIsWUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUU7QUFDdEQsZ0JBQVEsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRTtBQUM3RCxvQkFBVSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztBQUMzQyxvQkFBVSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxFQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO0FBQ3RFLGlCQUFTO0FBQ1QsWUFBTSxDQUFDLENBQUMsQ0FBQztBQUNULFlBQU0sSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUM7QUFDbEYsaUJBQVMsSUFBSSxDQUNILE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsRUFDcEQsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQyxDQUNqRjtBQUNULGlCQUFTLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztBQUN4QyxTQUFLO0FBQ0wsSUFBRSxDQUFDO0FBQ0gsSUFDRSxNQUFNO0FBQ1IsUUFBSSxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQztBQUNwRCxRQUFJLElBQUksSUFBSSxDQUFDLGtCQUFrQixFQUFFO0FBQ2pDLFlBQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ2pFLFNBQUs7QUFBQyxhQUFLO0FBQ1gsWUFBTSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDO0FBQ3RDLFNBQUs7QUFDTCxJQUFFLENBQUM7QUFDSCxJQUNFLFdBQVc7QUFDYixRQUFJLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtBQUMzQixZQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7QUFDdEMsU0FBSztBQUNMLElBQUUsQ0FBQztBQUNIOzhDQWhFQyxTQUFTLFNBQUMsa0JBQ1QsUUFBUSxFQUFFLGdCQUFnQjtnQkFDMUIsc0hBQTBDLGtCQUMxQyxJQUFJLEVBQUUsc0JBQ0osS0FBSyxFQUFFLFlBQVksa0JBQ3BCO1dBQ0Y7Ozs7Ozs7Ozs7Ozs7OztrRkFDSTtBQUFDO0FBQ0ksdUJBQVAsS0FBSztBQUFLLHlCQUNWLEtBQUs7QUFBSyx5QkFDVixLQUFLO0FBQUssMkJBQ1YsS0FBSztBQUFLLHFCQUNWLEtBQUs7QUFBSyxvQkFDVixXQUFXLFNBQUMsaUJBQWlCO0FBQU8sc0JBR3BDLFdBQVcsU0FBQyxtQkFBbUI7QUFBTyxzQkFHdEMsV0FBVyxTQUFDLG1CQUFtQjtBQUFPLGlDQUd0QyxZQUFZLFNBQUMsaUJBQWlCLEVBQUUsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFO0FBQU8sb0JBQ3hELFlBQVksU0FBQyxPQUFPLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO0FBQU07Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O29CQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIENvbnRlbnRDaGlsZCwgSG9zdEJpbmRpbmcsIElucHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOZ01vZGVsIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uLCB0aW1lciwgbWVyZ2UgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlYm91bmNlLCBmaWx0ZXIgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBNZXNzYWdlc0NvbXBvbmVudCB9IGZyb20gJy4vbWVzc2FnZXMuY29tcG9uZW50Jztcbi8qKlxuICogQSBmb3JtIGdyb3VwIGhlbHBzIHRvIHZhbGlkYXRlIGFuIGlucHV0IG9mIGEgZm9ybSBlbGVtZW50LlxuICpcbiAqICMjIEV4YW1wbGU6XG4gKlxuICogYGBgaHRtbFxuICogIDxjOHktZm9ybS1ncm91cCBbaGFzV2FybmluZ109XCJ1c2VyLmVtYWlsLmxlbmd0aCA9PT0gMFwiPlxuICogICA8bGFiZWwgdHJhbnNsYXRlIGZvcj1cInVzZXJFbWFpbFwiPkVtYWlsPC9sYWJlbD5cbiAqICAgPGlucHV0XG4gKiAgICAgaWQ9XCJ1c2VyRW1haWxcIlxuICogICAgIGNsYXNzPVwiZm9ybS1jb250cm9sXCJcbiAqICAgICB0eXBlPVwiZW1haWxcIlxuICogICAgIG5hbWU9XCJlbWFpbFwiXG4gKiAgICAgW21heGxlbmd0aF09XCIyNTRcIlxuICogICAgIGF1dG9jb21wbGV0ZT1cIm9mZlwiXG4gKiAgICAgcGxhY2Vob2xkZXI9XCJ7eydlLmcuIGpvZS5kb2VAZXhhbXBsZS5jb20nIHwgdHJhbnNsYXRlfX1cIlxuICogICAgIFsobmdNb2RlbCldPVwidXNlci5lbWFpbFwiXG4gKiAgICAgZW1haWxcbiAqICAgICByZXF1aXJlZFxuICogICA+XG4gKiAgIDxjOHktbWVzc2FnZXM+XG4gKiAgICAgPGM4eS1tZXNzYWdlICpuZ0lmPVwidXNlci5lbWFpbC5sZW5ndGggPT09IDBcIiB0cmFuc2xhdGU+PC9jOHktbWVzc2FnZT5cbiAqICAgICA8Yzh5LW1lc3NhZ2UgbmFtZT1cInJlcXVpcmVkXCIgdGV4dD1cIlRoZSBFLU1haWwgaXMgU1VQRVIgcmVxdWlyZWRcIj48L2M4eS1tZXNzYWdlPlxuICogICA8L2M4eS1tZXNzYWdlcz5cbiAqICA8L2M4eS1mb3JtLWdyb3VwPlxuICogYGBgXG4gKlxuICogQHBhcmFtIHN0YXR1cyBUaGUgY3VycmVudCBzdGF0dXMgY291bGQgYmUgZXJyb3IsIHdhcm5pbmcgb3Igc3VjY2Vzcy5cbiAqIEBwYXJhbSBoYXNFcnJvciBTZXQgdGhpcyB0byB0cnVlIHRvIGRpc3BsYXkgYSBlcnJvci5cbiAqIEBwYXJhbSBoYXNXYXJuaW5nIFNldCB0aGlzIHRvIHRydWUgdG8gZGlzcGxheSBhIHdhcm5pbmcuXG4gKiBAcGFyYW0gaGFzU3VjY2VzcyBTZXQgdGhpcyB0byB0cnVlIHRvIGRpc3BsYXkgYSBzdWNjZXNzLlxuICogQHBhcmFtIG5vdmFsaWRhdGlvbiBTZXQgdGhpcyB0byB0cnVlIHRvIGRpc2FibGUgYXV0b21hdGljIHZhbGlkYXRpb24gYnkgdGhpcyBjb21wb25lbnQuXG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1mb3JtLWdyb3VwJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2Zvcm0tZ3JvdXAuY29tcG9uZW50Lmh0bWwnLFxuICBob3N0OiB7XG4gICAgY2xhc3M6ICdmb3JtLWdyb3VwJ1xuICB9XG59KVxuZXhwb3J0IGNsYXNzIEZvcm1Hcm91cENvbXBvbmVudCB7XG4gIEBJbnB1dCgpIGhhc0Vycm9yID0gZmFsc2U7XG4gIEBJbnB1dCgpIGhhc1dhcm5pbmcgPSBmYWxzZTtcbiAgQElucHV0KCkgaGFzU3VjY2VzcyA9IGZhbHNlO1xuICBASW5wdXQoKSBub3ZhbGlkYXRpb24gPSBmYWxzZTtcbiAgQElucHV0KCkgc3RhdHVzOiBzdHJpbmc7XG4gIEBIb3N0QmluZGluZygnY2xhc3MuaGFzLWVycm9yJykgZ2V0IGVycm9yKCkge1xuICAgIHJldHVybiB0aGlzLnN0YXR1cyA9PT0gJ2Vycm9yJyB8fCB0aGlzLmhhc0Vycm9yO1xuICB9XG4gIEBIb3N0QmluZGluZygnY2xhc3MuaGFzLXdhcm5pbmcnKSBnZXQgd2FybmluZygpIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0dXMgPT09ICd3YXJuaW5nJyB8fCB0aGlzLmhhc1dhcm5pbmc7XG4gIH1cbiAgQEhvc3RCaW5kaW5nKCdjbGFzcy5oYXMtc3VjY2VzcycpIGdldCBzdWNjZXNzKCkge1xuICAgIHJldHVybiB0aGlzLnN0YXR1cyA9PT0gJ3N1Y2Nlc3MnIHx8IHRoaXMuaGFzU3VjY2VzcztcbiAgfVxuICBAQ29udGVudENoaWxkKE1lc3NhZ2VzQ29tcG9uZW50LCB7IHN0YXRpYzogZmFsc2UgfSkgY3VzdG9tRXJyb3JNZXNzYWdlOiBNZXNzYWdlc0NvbXBvbmVudDtcbiAgQENvbnRlbnRDaGlsZChOZ01vZGVsLCB7IHN0YXRpYzogdHJ1ZSB9KSBtb2RlbDogTmdNb2RlbDtcblxuICBlcnJvcnM6IHt9O1xuICBwcml2YXRlIHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICBwcml2YXRlIHJlYWRvbmx5IFZBTElEQVRJT05fREVCT1VOQ0VfTVMgPSAxMDAwO1xuXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLmluaXROZ01vZGVsKCk7XG4gIH1cblxuICBpbml0TmdNb2RlbCgpIHtcbiAgICBpZiAodGhpcy5tb2RlbCkge1xuICAgICAgdGhpcy5tb2RlbC52YWx1ZUFjY2Vzc29yLnJlZ2lzdGVyT25Ub3VjaGVkKCgpID0+IHtcbiAgICAgICAgaWYgKHRoaXMubW9kZWwuY29udHJvbCAmJiAhdGhpcy5tb2RlbC5jb250cm9sLmRpcnR5KSB7XG4gICAgICAgICAgdGhpcy5tb2RlbC5jb250cm9sLm1hcmtBc0RpcnR5KCk7XG4gICAgICAgICAgdGhpcy5tb2RlbC5jb250cm9sLnVwZGF0ZVZhbHVlQW5kVmFsaWRpdHkoe29ubHlTZWxmOiB0cnVlfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb24gPSBtZXJnZSh0aGlzLm1vZGVsLnZhbHVlQ2hhbmdlcywgdGhpcy5tb2RlbC5zdGF0dXNDaGFuZ2VzKVxuICAgICAgICAucGlwZShcbiAgICAgICAgICBmaWx0ZXIoKCkgPT4gdGhpcy5tb2RlbC5kaXJ0eSAmJiAhdGhpcy5ub3ZhbGlkYXRpb24pLFxuICAgICAgICAgIGRlYm91bmNlKCgpID0+ICh0aGlzLmhhc0Vycm9yID8gdGltZXIoMTApIDogdGltZXIodGhpcy5WQUxJREFUSU9OX0RFQk9VTkNFX01TKSkpXG4gICAgICAgIClcbiAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLnVwZGF0ZSgpKTtcbiAgICB9XG4gIH1cblxuICB1cGRhdGUoKSB7XG4gICAgdGhpcy5oYXNFcnJvciA9IHRoaXMubW9kZWwuc3RhdHVzID09PSAnSU5WQUxJRCc7XG4gICAgaWYgKHRoaXMuY3VzdG9tRXJyb3JNZXNzYWdlKSB7XG4gICAgICB0aGlzLmN1c3RvbUVycm9yTWVzc2FnZS5jaGFuZ1Zpc2liaWxpdHkodGhpcy5tb2RlbC5lcnJvcnMpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmVycm9ycyA9IHRoaXMubW9kZWwuZXJyb3JzO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==