import { __awaiter } from "tslib";
import { Component, Input, ViewChild, ComponentFactoryResolver, ViewContainerRef } from '@angular/core';
import { DynamicComponentService } from './dynamic-component.service';
import { of, isObservable } from 'rxjs';
import { isUndefined } from 'lodash-es';
/**
 * C8y dynamic component.
 * ## Example:
 *
 * register component in HOOK in module:
 * ```typescript
 *  import { HOOK_COMPONENT } from '@c8y/ngx-components';
 *
 * @NgModule({
 *  ...,
 *  providers: [{
 *      provide: HOOK_COMPONENT,
 *      multi: true,
 *      useValue: [{
 *          id: 'test-component',
 *          label: 'My test component',
 *          description: 'this is test component',
 *          component: TestComponent
 *      }],
 *  ...
 *  }]
 *
 * ```
 * Showing dynamic component:
 * ```html
 * <c8y-dynamic-component [componentId]="'test-component'" [config]="config"></c8y-dynamic-component>
 * ```
 */
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './dynamic-component.service';
import * as ɵngcc2 from '@angular/common';
import * as ɵngcc3 from 'ngx-bootstrap/collapse';
import * as ɵngcc4 from '../i18n/c8y-translate.directive';
import * as ɵngcc5 from '../i18n/c8y-translate.pipe';

const _c0 = ["host"];
function DynamicComponentComponent_ng_template_0_Template(rf, ctx) { }
function DynamicComponentComponent_div_2_span_7_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "span", 9);
    ɵngcc0.ɵɵtext(1, "Show details");
    ɵngcc0.ɵɵelementEnd();
} }
function DynamicComponentComponent_div_2_span_8_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "span", 9);
    ɵngcc0.ɵɵtext(1, "Hide details");
    ɵngcc0.ɵɵelementEnd();
} }
function DynamicComponentComponent_div_2_Template(rf, ctx) { if (rf & 1) {
    const _r6 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "div", 2);
    ɵngcc0.ɵɵelementStart(1, "strong", 3);
    ɵngcc0.ɵɵtext(2);
    ɵngcc0.ɵɵpipe(3, "translate");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(4, "p", 4);
    ɵngcc0.ɵɵelementStart(5, "button", 5);
    ɵngcc0.ɵɵlistener("click", function DynamicComponentComponent_div_2_Template_button_click_5_listener() { ɵngcc0.ɵɵrestoreView(_r6); const ctx_r5 = ɵngcc0.ɵɵnextContext(); return ctx_r5.expandErrorDetails = !ctx_r5.expandErrorDetails; });
    ɵngcc0.ɵɵelement(6, "i", 6);
    ɵngcc0.ɵɵtemplate(7, DynamicComponentComponent_div_2_span_7_Template, 2, 0, "span", 7);
    ɵngcc0.ɵɵtemplate(8, DynamicComponentComponent_div_2_span_8_Template, 2, 0, "span", 7);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(9, "div", 8);
    ɵngcc0.ɵɵelementStart(10, "pre");
    ɵngcc0.ɵɵtext(11);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r2 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate2(" ", ɵngcc0.ɵɵpipeBind1(3, 7, "This widget cannot be rendered because the current application does not support the following component:"), " ", ctx_r2.componentId, ". ");
    ɵngcc0.ɵɵadvance(5);
    ɵngcc0.ɵɵproperty("ngIf", !ctx_r2.expandErrorDetails);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r2.expandErrorDetails);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("collapse", !ctx_r2.expandErrorDetails)("isAnimated", true);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate1("      ", ctx_r2.error, "\n    ");
} }
export class DynamicComponentComponent {
    /**
     * @ignore only DI
     */
    constructor(componentFactoryResolver, dynamicComponentService) {
        this.componentFactoryResolver = componentFactoryResolver;
        this.dynamicComponentService = dynamicComponentService;
        /**
         * DynamicComponents can have two modes, an edit (config) and an view (component) mode.
         * By default it is shown in the component mode.
         */
        this.mode = 'component';
        /**
         * Disable this to hide the error that is shown if the component was not found.
         */
        this.notFoundError = true;
        /**
         * @ignore
         */
        this.expandErrorDetails = false;
    }
    /**
     * Calls the dynamic component life cycle hook. Currently only
     * supporting onBeforeSave, a hook which is called before a config component
     * is saved.
     */
    callLifeCycleHooks() {
        return this.callOnBeforeSaveHook();
    }
    /**
     * @ignore
     */
    ngOnChanges() {
        return __awaiter(this, void 0, void 0, function* () {
            const cmp = yield this.dynamicComponentService.getById(this.componentId);
            this.loadComponent(cmp);
        });
    }
    loadComponent(dynamicComponent) {
        try {
            this.error = undefined;
            const componentFactory = this.componentFactoryResolver.resolveComponentFactory(this.mode === 'component' ? dynamicComponent.component : dynamicComponent.configComponent);
            this.host.clear();
            this.componentRef = this.host.createComponent(componentFactory);
            this.componentRef.instance.config = this.config;
        }
        catch (ex) {
            this.error = ex;
        }
    }
    callOnBeforeSaveHook() {
        if (!this.componentRef) {
            return of(true);
        }
        const hook = this.componentRef.instance.onBeforeSave;
        if (hook) {
            const result = hook.call(this.componentRef.instance, this.config);
            if (isUndefined(result)) {
                return of(true);
            }
            return isObservable(result) ? result : of(result);
        }
        return of(true);
    }
}
DynamicComponentComponent.ɵfac = function DynamicComponentComponent_Factory(t) { return new (t || DynamicComponentComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ComponentFactoryResolver), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.DynamicComponentService)); };
DynamicComponentComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: DynamicComponentComponent, selectors: [["c8y-dynamic-component"]], viewQuery: function DynamicComponentComponent_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵviewQuery(_c0, 7, ViewContainerRef);
    } if (rf & 2) {
        let _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.host = _t.first);
    } }, inputs: { mode: "mode", notFoundError: "notFoundError", componentId: "componentId", config: "config" }, features: [ɵngcc0.ɵɵNgOnChangesFeature], decls: 3, vars: 1, consts: [["host", ""], ["class", "alert alert-warning m-8", "role", "alert", 4, "ngIf"], ["role", "alert", 1, "alert", "alert-warning", "m-8"], [1, "message"], [1, "text-muted", "m-t-8"], [1, "btn", "btn-clean", 3, "click"], ["c8yIcon", "chevron-down"], ["translate", "", 4, "ngIf"], [3, "collapse", "isAnimated"], ["translate", ""]], template: function DynamicComponentComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵtemplate(0, DynamicComponentComponent_ng_template_0_Template, 0, 0, "ng-template", null, 0, ɵngcc0.ɵɵtemplateRefExtractor);
        ɵngcc0.ɵɵtemplate(2, DynamicComponentComponent_div_2_Template, 12, 9, "div", 1);
    } if (rf & 2) {
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("ngIf", ctx.notFoundError && ctx.error);
    } }, directives: [ɵngcc2.NgIf, ɵngcc3.CollapseDirective, ɵngcc4.C8yTranslateDirective], pipes: [ɵngcc5.C8yTranslatePipe], encapsulation: 2 });
DynamicComponentComponent.ctorParameters = () => [
    { type: ComponentFactoryResolver },
    { type: DynamicComponentService }
];
DynamicComponentComponent.propDecorators = {
    componentId: [{ type: Input }],
    config: [{ type: Input }],
    mode: [{ type: Input }],
    notFoundError: [{ type: Input }],
    host: [{ type: ViewChild, args: ['host', { read: ViewContainerRef, static: true },] }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(DynamicComponentComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-dynamic-component',
                template: "<ng-template #host></ng-template>\n\n<div class=\"alert alert-warning m-8\" role=\"alert\" *ngIf=\"notFoundError && error\">\n  <strong class=\"message\">\n    {{\n      'This widget cannot be rendered because the current application does not support the following component:'\n        | translate\n    }}\n    {{ componentId }}.\n  </strong>\n  <p class=\"text-muted m-t-8\">\n    <button class=\"btn btn-clean\" (click)=\"expandErrorDetails = !expandErrorDetails\">\n      <i c8yIcon=\"chevron-down\"></i>\n      <span *ngIf=\"!expandErrorDetails\" translate>Show details</span>\n      <span *ngIf=\"expandErrorDetails\" translate>Hide details</span>\n    </button>\n  </p>\n  <div [collapse]=\"!expandErrorDetails\" [isAnimated]=\"true\">\n    <pre>\n      {{ error }}\n    </pre>\n  </div>\n</div>\n"
            }]
    }], function () { return [{ type: ɵngcc0.ComponentFactoryResolver }, { type: ɵngcc1.DynamicComponentService }]; }, { mode: [{
            type: Input
        }], notFoundError: [{
            type: Input
        }], componentId: [{
            type: Input
        }], config: [{
            type: Input
        }], host: [{
            type: ViewChild,
            args: ['host', { read: ViewContainerRef, static: true }]
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pYy1jb21wb25lbnQuY29tcG9uZW50LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9jb3JlL2R5bmFtaWMtY29tcG9uZW50L2R5bmFtaWMtY29tcG9uZW50LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsU0FBUyxFQUNULHdCQUF3QixFQUN4QixnQkFBZ0IsRUFFakIsTUFBTSxlQUFlLENBQUM7QUFNdkIsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDdEUsT0FBTyxFQUFFLEVBQUUsRUFBRSxZQUFZLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDcEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUV4QztBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxHQUFHOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFLSCxNQUFNLE9BQU8seUJBQXlCO0FBQ3RDLElBZ0NFO0FBQ0Y7QUFDRSxPQUFHO0FBQ0wsSUFBRSxZQUNVLHdCQUFrRCxFQUNsRCx1QkFBZ0Q7QUFDekQsUUFGUyw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTBCO0FBQUMsUUFDbkQsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtBQUM1RCxRQTdCRTtBQUNGO0FBQ007QUFFQSxXQUREO0FBQ0wsUUFBVyxTQUFJLEdBQTJCLFdBQVcsQ0FBQztBQUN0RCxRQUFFO0FBQ0Y7QUFFQSxXQURLO0FBQ0wsUUFBVyxrQkFBYSxHQUFHLElBQUksQ0FBQztBQUNoQyxRQVFFO0FBQ0Y7QUFFQSxXQURLO0FBQ0wsUUFBRSx1QkFBa0Is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bnQsXG4gIElucHV0LFxuICBWaWV3Q2hpbGQsXG4gIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgVmlld0NvbnRhaW5lclJlZixcbiAgQ29tcG9uZW50UmVmXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgRHluYW1pY0NvbXBvbmVudCxcbiAgRHluYW1pY0NvbXBvbmVudERlZmluaXRpb24sXG4gIE9uQmVmb3JlU2F2ZVxufSBmcm9tICcuL2R5bmFtaWMtY29tcG9uZW50Lm1vZGVsJztcbmltcG9ydCB7IER5bmFtaWNDb21wb25lbnRTZXJ2aWNlIH0gZnJvbSAnLi9keW5hbWljLWNvbXBvbmVudC5zZXJ2aWNlJztcbmltcG9ydCB7IG9mLCBpc09ic2VydmFibGUsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGlzVW5kZWZpbmVkIH0gZnJvbSAnbG9kYXNoLWVzJztcblxuLyoqXG4gKiBDOHkgZHluYW1pYyBjb21wb25lbnQuXG4gKiAjIyBFeGFtcGxlOlxuICpcbiAqIHJlZ2lzdGVyIGNvbXBvbmVudCBpbiBIT09LIGluIG1vZHVsZTpcbiAqIGBgYHR5cGVzY3JpcHRcbiAqICBpbXBvcnQgeyBIT09LX0NPTVBPTkVOVCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuICpcbiAqIEBOZ01vZHVsZSh7XG4gKiAgLi4uLFxuICogIHByb3ZpZGVyczogW3tcbiAqICAgICAgcHJvdmlkZTogSE9PS19DT01QT05FTlQsXG4gKiAgICAgIG11bHRpOiB0cnVlLFxuICogICAgICB1c2VWYWx1ZTogW3tcbiAqICAgICAgICAgIGlkOiAndGVzdC1jb21wb25lbnQnLFxuICogICAgICAgICAgbGFiZWw6ICdNeSB0ZXN0IGNvbXBvbmVudCcsXG4gKiAgICAgICAgICBkZXNjcmlwdGlvbjogJ3RoaXMgaXMgdGVzdCBjb21wb25lbnQnLFxuICogICAgICAgICAgY29tcG9uZW50OiBUZXN0Q29tcG9uZW50XG4gKiAgICAgIH1dLFxuICogIC4uLlxuICogIH1dXG4gKlxuICogYGBgXG4gKiBTaG93aW5nIGR5bmFtaWMgY29tcG9uZW50OlxuICogYGBgaHRtbFxuICogPGM4eS1keW5hbWljLWNvbXBvbmVudCBbY29tcG9uZW50SWRdPVwiJ3Rlc3QtY29tcG9uZW50J1wiIFtjb25maWddPVwiY29uZmlnXCI+PC9jOHktZHluYW1pYy1jb21wb25lbnQ+XG4gKiBgYGBcbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWR5bmFtaWMtY29tcG9uZW50JyxcbiAgdGVtcGxhdGVVcmw6ICcuL2R5bmFtaWMtY29tcG9uZW50LmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBEeW5hbWljQ29tcG9uZW50Q29tcG9uZW50IHtcbiAgLyoqXG4gICAqIFRoZSBJRCBvZiB0aGUgcmVnaXN0ZXJlZCBjb21wb25lbnQuIEl0IG5lZWRzIHRvIGJlIGEgY29tcG9uZW50IHRoYXQgaXMgaG9va2VkXG4gICAqIHdpdGggdGhlIEhPT0tfQ09NUE9ORU5UUyBleHRlbnNpb24gaG9vay5cbiAgICovXG4gIEBJbnB1dCgpIGNvbXBvbmVudElkOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBUaGUgY29uZmlndXJhdGlvbiB0byBwYXNzLlxuICAgKi9cbiAgQElucHV0KCkgY29uZmlnOiBhbnk7XG4gIC8qKlxuICAgKiBEeW5hbWljQ29tcG9uZW50cyBjYW4gaGF2ZSB0d28gbW9kZXMsIGFuIGVkaXQgKGNvbmZpZykgYW5kIGFuIHZpZXcgKGNvbXBvbmVudCkgbW9kZS5cbiAgICogQnkgZGVmYXVsdCBpdCBpcyBzaG93biBpbiB0aGUgY29tcG9uZW50IG1vZGUuXG4gICAqL1xuICBASW5wdXQoKSBtb2RlOiAnY29uZmlnJyB8ICdjb21wb25lbnQnID0gJ2NvbXBvbmVudCc7XG4gIC8qKlxuICAgKiBEaXNhYmxlIHRoaXMgdG8gaGlkZSB0aGUgZXJyb3IgdGhhdCBpcyBzaG93biBpZiB0aGUgY29tcG9uZW50IHdhcyBub3QgZm91bmQuXG4gICAqL1xuICBASW5wdXQoKSBub3RGb3VuZEVycm9yID0gdHJ1ZTtcbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIEBWaWV3Q2hpbGQoJ2hvc3QnLCB7IHJlYWQ6IFZpZXdDb250YWluZXJSZWYsIHN0YXRpYzogdHJ1ZSB9KSBob3N0OiBWaWV3Q29udGFpbmVyUmVmO1xuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgZXJyb3I6IGFueTtcbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIGV4cGFuZEVycm9yRGV0YWlscyA9IGZhbHNlO1xuICBwcml2YXRlIGNvbXBvbmVudFJlZjogQ29tcG9uZW50UmVmPENvbXBvbmVudD47XG5cbiAgLyoqXG4gICAqIEBpZ25vcmUgb25seSBESVxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBwcml2YXRlIGR5bmFtaWNDb21wb25lbnRTZXJ2aWNlOiBEeW5hbWljQ29tcG9uZW50U2VydmljZVxuICApIHt9XG5cbiAgLyoqXG4gICAqIENhbGxzIHRoZSBkeW5hbWljIGNvbXBvbmVudCBsaWZlIGN5Y2xlIGhvb2suIEN1cnJlbnRseSBvbmx5XG4gICAqIHN1cHBvcnRpbmcgb25CZWZvcmVTYXZlLCBhIGhvb2sgd2hpY2ggaXMgY2FsbGVkIGJlZm9yZSBhIGNvbmZpZyBjb21wb25lbnRcbiAgICogaXMgc2F2ZWQuXG4gICAqL1xuICBjYWxsTGlmZUN5Y2xlSG9va3MoKSB7XG4gICAgcmV0dXJuIHRoaXMuY2FsbE9uQmVmb3JlU2F2ZUhvb2soKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBhc3luYyBuZ09uQ2hhbmdlcygpIHtcbiAgICBjb25zdCBjbXAgPSBhd2FpdCB0aGlzLmR5bmFtaWNDb21wb25lbnRTZXJ2aWNlLmdldEJ5SWQodGhpcy5jb21wb25lbnRJZCk7XG4gICAgdGhpcy5sb2FkQ29tcG9uZW50KGNtcCk7XG4gIH1cblxuICBwcml2YXRlIGxvYWRDb21wb25lbnQoZHluYW1pY0NvbXBvbmVudDogRHluYW1pY0NvbXBvbmVudERlZmluaXRpb24pIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5lcnJvciA9IHVuZGVmaW5lZDtcbiAgICAgIGNvbnN0IGNvbXBvbmVudEZhY3RvcnkgPSB0aGlzLmNvbXBvbmVudEZhY3RvcnlSZXNvbHZlci5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShcbiAgICAgICAgdGhpcy5tb2RlID09PSAnY29tcG9uZW50JyA/IGR5bmFtaWNDb21wb25lbnQuY29tcG9uZW50IDogZHluYW1pY0NvbXBvbmVudC5jb25maWdDb21wb25lbnRcbiAgICAgICk7XG4gICAgICB0aGlzLmhvc3QuY2xlYXIoKTtcbiAgICAgIHRoaXMuY29tcG9uZW50UmVmID0gdGhpcy5ob3N0LmNyZWF0ZUNvbXBvbmVudChjb21wb25lbnRGYWN0b3J5KTtcbiAgICAgICh0aGlzLmNvbXBvbmVudFJlZi5pbnN0YW5jZSBhcyBEeW5hbWljQ29tcG9uZW50KS5jb25maWcgPSB0aGlzLmNvbmZpZztcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5lcnJvciA9IGV4O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2FsbE9uQmVmb3JlU2F2ZUhvb2soKSB7XG4gICAgaWYgKCF0aGlzLmNvbXBvbmVudFJlZikge1xuICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgIH1cbiAgICBjb25zdCBob29rID0gKHRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlIGFzIE9uQmVmb3JlU2F2ZSkub25CZWZvcmVTYXZlO1xuICAgIGlmIChob29rKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBob29rLmNhbGwodGhpcy5jb21wb25lbnRSZWYuaW5zdGFuY2UsIHRoaXMuY29uZmlnKTtcbiAgICAgIGlmIChpc1VuZGVmaW5lZChyZXN1bHQpKSB7XG4gICAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBpc09ic2VydmFibGUocmVzdWx0KSA/IHJlc3VsdCA6IChvZihyZXN1bHQpIGFzIE9ic2VydmFibGU8Ym9vbGVhbj4pO1xuICAgIH1cbiAgICByZXR1cm4gb2YodHJ1ZSk7XG4gIH1cbn1cbiJdfQ==