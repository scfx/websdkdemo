import { __awaiter, __decorate } from "tslib";
import { Injectable, isDevMode } from '@angular/core';
import { keys } from 'lodash-es';
import { BehaviorSubject } from 'rxjs';
import { scan, distinctUntilChanged, map, filter } from 'rxjs/operators';
import { StateService } from './state-service.abstract';
import { OptionsService } from './options.service';
import { FetchClient, TenantLoginOptionsService } from '@c8y/client';
import { ApplicationService } from '@c8y/client';
import { ApiService } from '@c8y/ngx-components/api';
import { throttle } from './throttle.decorator';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/client';
import * as ɵngcc2 from '@c8y/ngx-components/api';
import * as ɵngcc3 from './options.service';
export class AppStateService extends StateService {
    constructor(applicationService, apiService, options, fetchClient, tenantLoginOptionsService) {
        super();
        this.applicationService = applicationService;
        this.apiService = apiService;
        this.options = options;
        this.fetchClient = fetchClient;
        this.tenantLoginOptionsService = tenantLoginOptionsService;
        this.state$ = new BehaviorSubject({
            app: {
                name: this.options.name,
                contextPath: this.getCurrentContextPath() || this.options.contextPath
            },
            supportUrl: this.options.supportUrl,
            lang: this.options.get('defaultLanguage', 'en'),
            langs: this.getLangs(),
            langsDetail: this.options.languages,
            loginOptions: this.options.loginOptions,
            activateSupportUserAvailable: undefined,
            versions: {
                backend: undefined,
                ui: this.options.versions || { ngx: undefined }
            },
            hidePowered: this.options.hidePowered,
            isLoading: false,
            showRightDrawer: this.options.rightDrawer,
            loginExtraLink: this.options.get('login_extra_link'),
            newsletter: this.options.newsletter
        });
        this.currentSupportUserName = new BehaviorSubject(null);
        this.currentUser = new BehaviorSubject(null);
        this.currentTenant = new BehaviorSubject(null);
        this.apiService.calls
            .pipe(filter(({ url }) => !/notification\/realtime/.test(url)), map(({ phase }) => (phase === 'start' ? 1 : -1)), scan((count, item) => count + item, 0), map(count => count > 0), distinctUntilChanged())
            .subscribe(isLoading => (this.state.isLoading = isLoading));
        this.assignApplicationKeyToDefaultHeaders();
    }
    assignApplicationKeyToDefaultHeaders() {
        if (!isDevMode()) {
            this.fetchClient.defaultHeaders = Object.assign(Object.assign({}, (this.fetchClient.defaultHeaders || {})), { 'X-Cumulocity-Application-Key': this.options.key });
        }
    }
    /**
     * Returns the current state.
     */
    get state() {
        return this.state$.value;
    }
    getLangs() {
        const { languages } = this.options;
        return languages ? keys(languages).filter(k => languages[k]) : [];
    }
    /**
     * Returns the correct UI version. In hybrid mode for angular and ngx.
     */
    get uiVersion() {
        const version = this.state.versions.ui;
        return version.ngx || version.ng1;
    }
    /**
     * Loads the app manifest. If no access -> throw an error to verify app access.
     */
    loadManifest() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const { application } = (yield this.applicationService.detail(`${this.state.app.contextPath}/manifest`)).data;
                this.state.app.manifest = application;
                this.loadDefaultOptions();
            }
            catch (ex) {
                throw ex;
            }
        });
    }
    /**
     * When this function called, it refreshes the values of loginOptions stored within ui state object.
     * Function is throttled to execute the refresh once in a time specified by params of @throttled decorator,
     * it should be called on leading edge of the timeout.
     */
    refreshLoginOptions() {
        return __awaiter(this, void 0, void 0, function* () {
            const loginOptions = (yield this.tenantLoginOptionsService.listForCurrentTenant()).data;
            this.state$.next(Object.assign(Object.assign({}, this.state), { loginOptions }));
        });
    }
    /**
     * Checks current users application list and matches it against given application name.
     * Returns true if application is in the list.
     * @param name application name
     */
    isApplicationAvailable(name) {
        return __awaiter(this, void 0, void 0, function* () {
            const { data } = yield this.applicationService.listByUser(undefined, { pageSize: 100 });
            return data.some(app => app.name === name);
        });
    }
    /**
     * Sets current user (including support user).
     * @param userInfo Info about current user and support user to be set.
     */
    setUser(userInfo) {
        this.currentSupportUserName.next(userInfo.supportUserName || null);
        this.currentUser.next(userInfo.user);
    }
    getCurrentContextPath() {
        const match = window.location.pathname.match(/\/apps\/(public\/){0,1}(.+?)(\/|\?|#|$)/);
        return match && match[2];
    }
    loadDefaultOptions() {
        return __awaiter(this, void 0, void 0, function* () {
            this.state.supportUrl = yield this.options.getSupportUrl();
            this.state.activateSupportUserAvailable = yield this.options.getActivateSupportUser();
            this.state.versions.backend = yield this.options.getSystemOption('system', 'version');
            try {
                this.showIncompatibleVersionsError();
            }
            catch (ex) {
                // ignore this
            }
            this.emitNewState();
        });
    }
    showIncompatibleVersionsError() {
        const uiVersion = this.state.versions.ui.ngx;
        const backendVersion = this.state.versions.backend;
        const uiVersionArray = uiVersion
            .replace(/[^\d.]/g, '')
            .split('.')
            .map(Number);
        const beVersionArray = backendVersion
            .replace(/[^\d.]/g, '')
            .split('.')
            .map(Number);
        const multiplier = Math.pow(10, Math.ceil(Math.log10(Math.max(...uiVersionArray, ...beVersionArray) + 1)));
        const sumReducer = (acc, cur) => acc + cur;
        const calculateVersionMapper = (curr, idx) => curr * (multiplier / Math.pow(10, idx));
        const uiVersionNumber = uiVersionArray.map(calculateVersionMapper).reduce(sumReducer);
        const beVersionNumber = beVersionArray.map(calculateVersionMapper).reduce(sumReducer);
        const showError = uiVersionNumber > beVersionNumber;
        if (showError) {
            const errorContent = `You are running version ${uiVersion} of the UI and version ${backendVersion} of backend!`;
            console.log('%c ' + errorContent, 'font-weight: bold; font-size: 30px; color: red;');
        }
    }
}
AppStateService.ɵfac = function AppStateService_Factory(t) { return new (t || AppStateService)(ɵngcc0.ɵɵinject(ɵngcc1.ApplicationService), ɵngcc0.ɵɵinject(ɵngcc2.ApiService), ɵngcc0.ɵɵinject(ɵngcc3.OptionsService), ɵngcc0.ɵɵinject(ɵngcc1.FetchClient), ɵngcc0.ɵɵinject(ɵngcc1.TenantLoginOptionsService)); };
AppStateService.ɵprov = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjectable({ token: AppStateService, factory: AppStateService.ɵfac });
AppStateService.ctorParameters = () => [
    { type: ApplicationService },
    { type: ApiService },
    { type: OptionsService },
    { type: FetchClient },
    { type: TenantLoginOptionsService }
];
__decorate([
    throttle(600, { trailing: false })
], AppStateService.prototype, "refreshLoginOptions", null);
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(AppStateService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.ApplicationService }, { type: ɵngcc2.ApiService }, { type: ɵngcc3.OptionsService }, { type: ɵngcc1.FetchClient }, { type: ɵngcc1.TenantLoginOptionsService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidWktc3RhdGUuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9jb21tb24vdWktc3RhdGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdEQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNqQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3ZDLE9BQU8sRUFBRSxJQUFJLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN4RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbkQsT0FBTyxFQUFFLFdBQVcsRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUVyRSxPQUFPLEVBQUUsa0JBQWtCLEVBQXlCLE1BQU0sYUFBYSxDQUFDO0FBQ3hFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7Ozs7O0FBR2hELE1BQU0sT0FBTyxlQUFnQixTQUFRLFlBQVk7QUFDakQsSUF5QkUsWUFDVSxrQkFBc0MsRUFDdkMsVUFBc0IsRUFDckIsT0FBdUIsRUFDdkIsV0FBd0IsRUFDeEIseUJBQW9EO0FBQzdELFFBQ0MsS0FBSyxFQUFFLENBQUM7QUFDWixRQVBZLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7QUFBQyxRQUN4QyxlQUFVLEdBQVYsVUFBVSxDQUFZO0FBQUMsUUFDdEIsWUFBTyxHQUFQLE9BQU8sQ0FBZ0I7QUFBQyxRQUN4QixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtBQUFDLFFBQ3pCLDhCQUF5QixHQUF6Qix5QkFBeUIsQ0FB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MkNBcEtDLFVBQVU7MkhBQ1Q7QUFBQztBQUF5QyxZQUxuQyxrQkFBa0I7QUFBSSxZQUN0QixVQUFVO0FBQUksWUFKZCxjQUFjO0FBQUksWUFDbEIsV0FBVztBQUFJLFlBQUYseUJBQXlCO0FBQUc7QUF3R2hEO0FBQWEsSUFEWixRQUFRLENBQUMsR0FBRyxFQUFFLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDO0FBQ3JDLDBEQUdHOzs7Mk5BQ0g7QUFDQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIGlzRGV2TW9kZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsga2V5cyB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHNjYW4sIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAsIGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFN0YXRlU2VydmljZSB9IGZyb20gJy4vc3RhdGUtc2VydmljZS5hYnN0cmFjdCc7XG5pbXBvcnQgeyBPcHRpb25zU2VydmljZSB9IGZyb20gJy4vb3B0aW9ucy5zZXJ2aWNlJztcbmltcG9ydCB7IEZldGNoQ2xpZW50LCBUZW5hbnRMb2dpbk9wdGlvbnNTZXJ2aWNlIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuXG5pbXBvcnQgeyBBcHBsaWNhdGlvblNlcnZpY2UsIElVc2VyLCBJQ3VycmVudFRlbmFudCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEFwaVNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL2FwaSc7XG5pbXBvcnQgeyB0aHJvdHRsZSB9IGZyb20gJy4vdGhyb3R0bGUuZGVjb3JhdG9yJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEFwcFN0YXRlU2VydmljZSBleHRlbmRzIFN0YXRlU2VydmljZSB7XG4gIHN0YXRlJDogQmVoYXZpb3JTdWJqZWN0PGFueT4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGFueT4oe1xuICAgIGFwcDoge1xuICAgICAgbmFtZTogdGhpcy5vcHRpb25zLm5hbWUsXG4gICAgICBjb250ZXh0UGF0aDogdGhpcy5nZXRDdXJyZW50Q29udGV4dFBhdGgoKSB8fCB0aGlzLm9wdGlvbnMuY29udGV4dFBhdGhcbiAgICB9LFxuICAgIHN1cHBvcnRVcmw6IHRoaXMub3B0aW9ucy5zdXBwb3J0VXJsLFxuICAgIGxhbmc6IHRoaXMub3B0aW9ucy5nZXQoJ2RlZmF1bHRMYW5ndWFnZScsICdlbicpLFxuICAgIGxhbmdzOiB0aGlzLmdldExhbmdzKCksXG4gICAgbGFuZ3NEZXRhaWw6IHRoaXMub3B0aW9ucy5sYW5ndWFnZXMsXG4gICAgbG9naW5PcHRpb25zOiB0aGlzLm9wdGlvbnMubG9naW5PcHRpb25zLFxuICAgIGFjdGl2YXRlU3VwcG9ydFVzZXJBdmFpbGFibGU6IHVuZGVmaW5lZCxcbiAgICB2ZXJzaW9uczoge1xuICAgICAgYmFja2VuZDogdW5kZWZpbmVkLFxuICAgICAgdWk6IHRoaXMub3B0aW9ucy52ZXJzaW9ucyB8fCB7IG5neDogdW5kZWZpbmVkIH1cbiAgICB9LFxuICAgIGhpZGVQb3dlcmVkOiB0aGlzLm9wdGlvbnMuaGlkZVBvd2VyZWQsXG4gICAgaXNMb2FkaW5nOiBmYWxzZSxcbiAgICBzaG93UmlnaHREcmF3ZXI6IHRoaXMub3B0aW9ucy5yaWdodERyYXdlcixcbiAgICBsb2dpbkV4dHJhTGluazogdGhpcy5vcHRpb25zLmdldCgnbG9naW5fZXh0cmFfbGluaycpLFxuICAgIG5ld3NsZXR0ZXI6IHRoaXMub3B0aW9ucy5uZXdzbGV0dGVyXG4gIH0pO1xuICBjdXJyZW50U3VwcG9ydFVzZXJOYW1lOiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nIHwgbnVsbD4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KG51bGwpO1xuICBjdXJyZW50VXNlcjogQmVoYXZpb3JTdWJqZWN0PElVc2VyIHwgbnVsbD4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KG51bGwpO1xuICBjdXJyZW50VGVuYW50OiBCZWhhdmlvclN1YmplY3Q8SUN1cnJlbnRUZW5hbnQgfCBudWxsPiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhcHBsaWNhdGlvblNlcnZpY2U6IEFwcGxpY2F0aW9uU2VydmljZSxcbiAgICBwdWJsaWMgYXBpU2VydmljZTogQXBpU2VydmljZSxcbiAgICBwcml2YXRlIG9wdGlvbnM6IE9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgZmV0Y2hDbGllbnQ6IEZldGNoQ2xpZW50LFxuICAgIHByaXZhdGUgdGVuYW50TG9naW5PcHRpb25zU2VydmljZTogVGVuYW50TG9naW5PcHRpb25zU2VydmljZVxuICApIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuYXBpU2VydmljZS5jYWxsc1xuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcigoeyB1cmwgfSkgPT4gIS9ub3RpZmljYXRpb25cXC9yZWFsdGltZS8udGVzdCh1cmwpKSxcbiAgICAgICAgbWFwKCh7IHBoYXNlIH0pID0+IChwaGFzZSA9PT0gJ3N0YXJ0JyA/IDEgOiAtMSkpLFxuICAgICAgICBzY2FuKChjb3VudCwgaXRlbSkgPT4gY291bnQgKyBpdGVtLCAwKSxcbiAgICAgICAgbWFwKGNvdW50ID0+IGNvdW50ID4gMCksXG4gICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKClcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoaXNMb2FkaW5nID0+ICh0aGlzLnN0YXRlLmlzTG9hZGluZyA9IGlzTG9hZGluZykpO1xuXG4gICAgdGhpcy5hc3NpZ25BcHBsaWNhdGlvbktleVRvRGVmYXVsdEhlYWRlcnMoKTtcbiAgfVxuXG4gIGFzc2lnbkFwcGxpY2F0aW9uS2V5VG9EZWZhdWx0SGVhZGVycygpIHtcbiAgICBpZiAoIWlzRGV2TW9kZSgpKSB7XG4gICAgICB0aGlzLmZldGNoQ2xpZW50LmRlZmF1bHRIZWFkZXJzID0ge1xuICAgICAgICAuLi4odGhpcy5mZXRjaENsaWVudC5kZWZhdWx0SGVhZGVycyB8fCB7fSksXG4gICAgICAgICdYLUN1bXVsb2NpdHktQXBwbGljYXRpb24tS2V5JzogdGhpcy5vcHRpb25zLmtleVxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgY3VycmVudCBzdGF0ZS5cbiAgICovXG4gIGdldCBzdGF0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZSQudmFsdWU7XG4gIH1cblxuICBnZXRMYW5ncygpIHtcbiAgICBjb25zdCB7IGxhbmd1YWdlcyB9ID0gdGhpcy5vcHRpb25zO1xuICAgIHJldHVybiBsYW5ndWFnZXMgPyBrZXlzKGxhbmd1YWdlcykuZmlsdGVyKGsgPT4gbGFuZ3VhZ2VzW2tdKSA6IFtdO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIGNvcnJlY3QgVUkgdmVyc2lvbi4gSW4gaHlicmlkIG1vZGUgZm9yIGFuZ3VsYXIgYW5kIG5neC5cbiAgICovXG4gIGdldCB1aVZlcnNpb24oKSB7XG4gICAgY29uc3QgdmVyc2lvbiA9IHRoaXMuc3RhdGUudmVyc2lvbnMudWk7XG4gICAgcmV0dXJuIHZlcnNpb24ubmd4IHx8IHZlcnNpb24ubmcxO1xuICB9XG5cbiAgLyoqXG4gICAqIExvYWRzIHRoZSBhcHAgbWFuaWZlc3QuIElmIG5vIGFjY2VzcyAtPiB0aHJvdyBhbiBlcnJvciB0byB2ZXJpZnkgYXBwIGFjY2Vzcy5cbiAgICovXG4gIGFzeW5jIGxvYWRNYW5pZmVzdCgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBhcHBsaWNhdGlvbiB9ID0gKGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmRldGFpbChcbiAgICAgICAgYCR7dGhpcy5zdGF0ZS5hcHAuY29udGV4dFBhdGh9L21hbmlmZXN0YFxuICAgICAgKSkuZGF0YSBhcyBhbnk7XG4gICAgICB0aGlzLnN0YXRlLmFwcC5tYW5pZmVzdCA9IGFwcGxpY2F0aW9uO1xuICAgICAgdGhpcy5sb2FkRGVmYXVsdE9wdGlvbnMoKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhyb3cgZXg7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFdoZW4gdGhpcyBmdW5jdGlvbiBjYWxsZWQsIGl0IHJlZnJlc2hlcyB0aGUgdmFsdWVzIG9mIGxvZ2luT3B0aW9ucyBzdG9yZWQgd2l0aGluIHVpIHN0YXRlIG9iamVjdC5cbiAgICogRnVuY3Rpb24gaXMgdGhyb3R0bGVkIHRvIGV4ZWN1dGUgdGhlIHJlZnJlc2ggb25jZSBpbiBhIHRpbWUgc3BlY2lmaWVkIGJ5IHBhcmFtcyBvZiBAdGhyb3R0bGVkIGRlY29yYXRvcixcbiAgICogaXQgc2hvdWxkIGJlIGNhbGxlZCBvbiBsZWFkaW5nIGVkZ2Ugb2YgdGhlIHRpbWVvdXQuXG4gICAqL1xuICBAdGhyb3R0bGUoNjAwLCB7IHRyYWlsaW5nOiBmYWxzZSB9KVxuICBhc3luYyByZWZyZXNoTG9naW5PcHRpb25zKCkge1xuICAgIGNvbnN0IGxvZ2luT3B0aW9ucyA9IChhd2FpdCB0aGlzLnRlbmFudExvZ2luT3B0aW9uc1NlcnZpY2UubGlzdEZvckN1cnJlbnRUZW5hbnQoKSkuZGF0YTtcbiAgICB0aGlzLnN0YXRlJC5uZXh0KHsgLi4udGhpcy5zdGF0ZSwgbG9naW5PcHRpb25zIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrcyBjdXJyZW50IHVzZXJzIGFwcGxpY2F0aW9uIGxpc3QgYW5kIG1hdGNoZXMgaXQgYWdhaW5zdCBnaXZlbiBhcHBsaWNhdGlvbiBuYW1lLlxuICAgKiBSZXR1cm5zIHRydWUgaWYgYXBwbGljYXRpb24gaXMgaW4gdGhlIGxpc3QuXG4gICAqIEBwYXJhbSBuYW1lIGFwcGxpY2F0aW9uIG5hbWVcbiAgICovXG4gIGFzeW5jIGlzQXBwbGljYXRpb25BdmFpbGFibGUobmFtZTogc3RyaW5nKSB7XG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5saXN0QnlVc2VyKHVuZGVmaW5lZCwgeyBwYWdlU2l6ZTogMTAwIH0pO1xuICAgIHJldHVybiBkYXRhLnNvbWUoYXBwID0+IGFwcC5uYW1lID09PSBuYW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIGN1cnJlbnQgdXNlciAoaW5jbHVkaW5nIHN1cHBvcnQgdXNlcikuXG4gICAqIEBwYXJhbSB1c2VySW5mbyBJbmZvIGFib3V0IGN1cnJlbnQgdXNlciBhbmQgc3VwcG9ydCB1c2VyIHRvIGJlIHNldC5cbiAgICovXG4gIHNldFVzZXIodXNlckluZm86IHsgdXNlcjogSVVzZXI7IHN1cHBvcnRVc2VyTmFtZTogc3RyaW5nIH0pIHtcbiAgICB0aGlzLmN1cnJlbnRTdXBwb3J0VXNlck5hbWUubmV4dCh1c2VySW5mby5zdXBwb3J0VXNlck5hbWUgfHwgbnVsbCk7XG4gICAgdGhpcy5jdXJyZW50VXNlci5uZXh0KHVzZXJJbmZvLnVzZXIpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDdXJyZW50Q29udGV4dFBhdGgoKSB7XG4gICAgY29uc3QgbWF0Y2ggPSB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUubWF0Y2goL1xcL2FwcHNcXC8ocHVibGljXFwvKXswLDF9KC4rPykoXFwvfFxcP3wjfCQpLyk7XG4gICAgcmV0dXJuIG1hdGNoICYmIG1hdGNoWzJdO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkRGVmYXVsdE9wdGlvbnMoKSB7XG4gICAgdGhpcy5zdGF0ZS5zdXBwb3J0VXJsID0gYXdhaXQgdGhpcy5vcHRpb25zLmdldFN1cHBvcnRVcmwoKTtcbiAgICB0aGlzLnN0YXRlLmFjdGl2YXRlU3VwcG9ydFVzZXJBdmFpbGFibGUgPSBhd2FpdCB0aGlzLm9wdGlvbnMuZ2V0QWN0aXZhdGVTdXBwb3J0VXNlcigpO1xuICAgIHRoaXMuc3RhdGUudmVyc2lvbnMuYmFja2VuZCA9IGF3YWl0IHRoaXMub3B0aW9ucy5nZXRTeXN0ZW1PcHRpb24oJ3N5c3RlbScsICd2ZXJzaW9uJyk7XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuc2hvd0luY29tcGF0aWJsZVZlcnNpb25zRXJyb3IoKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgLy8gaWdub3JlIHRoaXNcbiAgICB9XG4gICAgdGhpcy5lbWl0TmV3U3RhdGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgc2hvd0luY29tcGF0aWJsZVZlcnNpb25zRXJyb3IoKSB7XG4gICAgY29uc3QgdWlWZXJzaW9uID0gdGhpcy5zdGF0ZS52ZXJzaW9ucy51aS5uZ3g7XG4gICAgY29uc3QgYmFja2VuZFZlcnNpb24gPSB0aGlzLnN0YXRlLnZlcnNpb25zLmJhY2tlbmQ7XG4gICAgY29uc3QgdWlWZXJzaW9uQXJyYXkgPSB1aVZlcnNpb25cbiAgICAgIC5yZXBsYWNlKC9bXlxcZC5dL2csICcnKVxuICAgICAgLnNwbGl0KCcuJylcbiAgICAgIC5tYXAoTnVtYmVyKTtcbiAgICBjb25zdCBiZVZlcnNpb25BcnJheSA9IGJhY2tlbmRWZXJzaW9uXG4gICAgICAucmVwbGFjZSgvW15cXGQuXS9nLCAnJylcbiAgICAgIC5zcGxpdCgnLicpXG4gICAgICAubWFwKE51bWJlcik7XG4gICAgY29uc3QgbXVsdGlwbGllciA9IE1hdGgucG93KFxuICAgICAgMTAsXG4gICAgICBNYXRoLmNlaWwoTWF0aC5sb2cxMChNYXRoLm1heCguLi51aVZlcnNpb25BcnJheSwgLi4uYmVWZXJzaW9uQXJyYXkpICsgMSkpXG4gICAgKTtcbiAgICBjb25zdCBzdW1SZWR1Y2VyID0gKGFjYywgY3VyKSA9PiBhY2MgKyBjdXI7XG4gICAgY29uc3QgY2FsY3VsYXRlVmVyc2lvbk1hcHBlciA9IChjdXJyLCBpZHgpID0+IGN1cnIgKiAobXVsdGlwbGllciAvIE1hdGgucG93KDEwLCBpZHgpKTtcbiAgICBjb25zdCB1aVZlcnNpb25OdW1iZXIgPSB1aVZlcnNpb25BcnJheS5tYXAoY2FsY3VsYXRlVmVyc2lvbk1hcHBlcikucmVkdWNlKHN1bVJlZHVjZXIpO1xuICAgIGNvbnN0IGJlVmVyc2lvbk51bWJlciA9IGJlVmVyc2lvbkFycmF5Lm1hcChjYWxjdWxhdGVWZXJzaW9uTWFwcGVyKS5yZWR1Y2Uoc3VtUmVkdWNlcik7XG4gICAgY29uc3Qgc2hvd0Vycm9yID0gdWlWZXJzaW9uTnVtYmVyID4gYmVWZXJzaW9uTnVtYmVyO1xuICAgIGlmIChzaG93RXJyb3IpIHtcbiAgICAgIGNvbnN0IGVycm9yQ29udGVudCA9IGBZb3UgYXJlIHJ1bm5pbmcgdmVyc2lvbiAke3VpVmVyc2lvbn0gb2YgdGhlIFVJIGFuZCB2ZXJzaW9uICR7YmFja2VuZFZlcnNpb259IG9mIGJhY2tlbmQhYDtcbiAgICAgIGNvbnNvbGUubG9nKCclYyAnICsgZXJyb3JDb250ZW50LCAnZm9udC13ZWlnaHQ6IGJvbGQ7IGZvbnQtc2l6ZTogMzBweDsgY29sb3I6IHJlZDsnKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==