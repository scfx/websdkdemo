import { __awaiter } from "tslib";
import { InjectionToken, Optional, Inject, Injectable } from '@angular/core';
import { camelCase, isUndefined } from 'lodash-es';
import { ApplicationOptions } from './ApplicationOptions';
import { SystemOptionsService, TenantOptionsService } from '@c8y/ngx-components/api';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/ngx-components/api';
export const HOOK_OPTIONS = new InjectionToken('App options');
/**
 * A service that allows to set or get application options
 * which configure the default behavior of the UI.
 */
export class OptionsService extends ApplicationOptions {
    constructor(options, systemOptionsService, tenantOptionService) {
        super();
        this.systemOptionsService = systemOptionsService;
        this.tenantOptionService = tenantOptionService;
        this.setupOptions(options);
    }
    /**
     * Returns an application option used to configure the UI.
     * @param optionKey The application options key.
     * @param defaultValue A value to return if non is set.
     */
    get(optionKey, defaultValue) {
        let value = this[optionKey];
        if (typeof value === 'undefined') {
            value = this[camelCase(optionKey)];
        }
        return typeof value !== 'undefined' ? value : defaultValue;
    }
    /**
     * Sets an application option.
     * @param key The key to set.
     * @param value The value to set.
     */
    set(key, value) {
        this[camelCase(key)] = value;
    }
    /**
     * Gets support url from tenant options.
     * If response returns '404 not found' it gets the support url from application options.
     * If the support link within application options is not provided the UI will use the system options.
     * Is the support link explicitly set to false it will be hidden.
     *
     * @returns Returns support url or false.
     */
    getSupportUrl() {
        return __awaiter(this, void 0, void 0, function* () {
            let url = yield this.getTenantOption('configuration', 'system.support.url');
            if (isUndefined(url)) {
                url = this.supportUrl;
            }
            this.supportUrl = isUndefined(url) ? (yield this.getSystemOption('support', 'url')) || false : url;
            return this.supportUrl;
        });
    }
    /**
     * Returns if the tenant allows to show the activate-support user menu entry.
     * Note: Only if system-level support-user/enabled is false we can activate it at tenant level.
     */
    getActivateSupportUser() {
        return __awaiter(this, void 0, void 0, function* () {
            const option = yield this.getSystemOption('support-user', 'enabled', true);
            return !option;
        });
    }
    /**
     * Gets a value from the system service and parses it.
     *
     * @param category The category for this option.
     * @param key The key for that option.
     * @param defaultValue The default if the option was not found.
     */
    getSystemOption(category, key, defaultValue) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.getOptionFromService(category, key, this.systemOptionsService, defaultValue);
        });
    }
    /**
     * Gets a value from the tenant service and parses it.
     *
     * @param category The category for this option.
     * @param key The key for that option.
     * @param defaultValue The default if the option was not found.
     */
    getTenantOption(category, key, defaultValue) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.getOptionFromService(category, key, this.tenantOptionService, defaultValue);
        });
    }
    setupOptions(options) {
        if (options) {
            if (!Array.isArray(options)) {
                options = [options];
            }
            options.forEach(optionMap => {
                if (optionMap) {
                    Object.keys(optionMap).forEach(key => {
                        this[camelCase(key)] = optionMap[key];
                    });
                }
            });
        }
    }
    getOptionFromService(category, key, service, defaultValue) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const { data } = yield service.detail({ category, key });
                return this.parseOptionRawValue(data.value, defaultValue);
            }
            catch (ex) {
                return defaultValue;
            }
        });
    }
    parseOptionRawValue(rawValue, defaultValue) {
        let value;
        try {
            value = JSON.parse(rawValue);
        }
        catch (e) {
            value = isUndefined(rawValue) ? defaultValue : rawValue;
        }
        return value;
    }
}
OptionsService.ɵfac = function OptionsService_Factory(t) { return new (t || OptionsService)(ɵngcc0.ɵɵinject(HOOK_OPTIONS, 8), ɵngcc0.ɵɵinject(ɵngcc1.SystemOptionsService), ɵngcc0.ɵɵinject(ɵngcc1.TenantOptionsService)); };
OptionsService.ɵprov = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjectable({ token: OptionsService, factory: OptionsService.ɵfac });
OptionsService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [HOOK_OPTIONS,] }] },
    { type: SystemOptionsService },
    { type: TenantOptionsService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(OptionsService, [{
        type: Injectable
    }], function () { return [{ type: undefined, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [HOOK_OPTIONS]
            }] }, { type: ɵngcc1.SystemOptionsService }, { type: ɵngcc1.TenantOptionsService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3B0aW9ucy5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9jb3JlL2NvbW1vbi9vcHRpb25zLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDN0UsT0FBTyxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbkQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFMUQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLG9CQUFvQixFQUFFLE1BQU0seUJBQXlCLENBQUM7OztBQUVyRixNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUcsSUFBSSxjQUFjLENBQXVDLGFBQWEsQ0FBQyxDQUFDO0FBRXBHO0FBQ0E7QUFDQTtBQUNBLEdBQUc7QUFFSCxNQUFNLE9BQU8sY0FBZSxTQUFRLGtCQUFrQjtBQUN0RCxJQUNFLFlBQ29DLE9BQU8sRUFDakMsb0JBQTBDLEVBQzFDLG1CQUF5QztBQUNsRCxRQUNDLEtBQUssRUFBRSxDQUFDO0FBQ1osUUFKWSx5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO0FBQUMsUUFDM0Msd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFzQjtBQUNyRCxRQUVJLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDL0IsSUFBRSxDQUFDO0FBQ0gsSUFDRTtBQUNGO0FBQ0U7QUFDRTtBQUVKLE9BREs7QUFDTCxJQUFFLEdBQUcsQ0FBQyxTQUErQixFQUFFLFlBQWtCO0FBQ3pELFFBQUksSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ2hDLFFBQUksSUFBSSxPQUFPLEtBQUssS0FBSyxXQUFXLEVBQUU7QUFDdEMsWUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFD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Q1QsU0FBSztBQUNMLElBQUUsQ0FBQztBQUNILElBQ2dCLG9CQUFvQixDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsT0FBTyxFQUFFLFlBQVk7QUFDekU7QUFDb0QsWUFEaEQsSUFBSTtBQUNSLGdCQUFNLE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztBQUMvRCxnQkFBTSxPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO0FBQ2hFLGFBQUs7QUFBQyxZQUFBLE9BQU8sRUFBRSxFQUFFO0FBQ2pCLGdCQUFNLE9BQU8sWUFBWSxDQUFDO0FBQzFCLGFBQUs7QUFDTCxRQUFFLENBQUM7QUFFRixLQUZFO0FBQ0gsSUFDVSxtQkFBbUIsQ0FBQyxRQUFRLEVBQUUsWUFBWTtBQUNwRCxRQUFJLElBQUksS0FBSyxDQUFDO0FBQ2QsUUFBSSxJQUFJO0FBQ1IsWUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNuQyxTQUFLO0FBQUMsUUFBQSxPQUFPLENBQUMsRUFBRTtBQUNoQixZQUFNLEtBQUssR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDO0FBQzlELFNBQUs7QUFDTCxRQUFJLE9BQU8sS0FBSyxDQUFDO0FBQ2pCLElBQUUsQ0FBQztBQUNIOzBDQW5IQyxVQUFVO3dIQUNUO0FBQUM7QUFBd0MsNENBR3RDLFFBQVEsWUFBSSxNQUFNLFNBQUMsWUFBWTtBQUFTLFlBWnBDLG9CQUFvQjtBQUFJLFlBQUYsb0JBQW9CO0FBQUc7Ozs7Ozs7O2dIQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3Rpb25Ub2tlbiwgT3B0aW9uYWwsIEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgY2FtZWxDYXNlLCBpc1VuZGVmaW5lZCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBBcHBsaWNhdGlvbk9wdGlvbnMgfSBmcm9tICcuL0FwcGxpY2F0aW9uT3B0aW9ucyc7XG5pbXBvcnQgeyBFeHRlbnNpb25GYWN0b3J5IH0gZnJvbSAnLi9leHRlbnNpb24taG9va3MnO1xuaW1wb3J0IHsgU3lzdGVtT3B0aW9uc1NlcnZpY2UsIFRlbmFudE9wdGlvbnNTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9hcGknO1xuXG5leHBvcnQgY29uc3QgSE9PS19PUFRJT05TID0gbmV3IEluamVjdGlvblRva2VuPEV4dGVuc2lvbkZhY3Rvcnk8QXBwbGljYXRpb25PcHRpb25zPj4oJ0FwcCBvcHRpb25zJyk7XG5cbi8qKlxuICogQSBzZXJ2aWNlIHRoYXQgYWxsb3dzIHRvIHNldCBvciBnZXQgYXBwbGljYXRpb24gb3B0aW9uc1xuICogd2hpY2ggY29uZmlndXJlIHRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIHRoZSBVSS5cbiAqL1xuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIE9wdGlvbnNTZXJ2aWNlIGV4dGVuZHMgQXBwbGljYXRpb25PcHRpb25zIHtcbiAgW2tleTogc3RyaW5nXTogYW55O1xuICBjb25zdHJ1Y3RvcihcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KEhPT0tfT1BUSU9OUykgb3B0aW9ucyxcbiAgICBwcml2YXRlIHN5c3RlbU9wdGlvbnNTZXJ2aWNlOiBTeXN0ZW1PcHRpb25zU2VydmljZSxcbiAgICBwcml2YXRlIHRlbmFudE9wdGlvblNlcnZpY2U6IFRlbmFudE9wdGlvbnNTZXJ2aWNlXG4gICkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5zZXR1cE9wdGlvbnMob3B0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbiBhcHBsaWNhdGlvbiBvcHRpb24gdXNlZCB0byBjb25maWd1cmUgdGhlIFVJLlxuICAgKiBAcGFyYW0gb3B0aW9uS2V5IFRoZSBhcHBsaWNhdGlvbiBvcHRpb25zIGtleS5cbiAgICogQHBhcmFtIGRlZmF1bHRWYWx1ZSBBIHZhbHVlIHRvIHJldHVybiBpZiBub24gaXMgc2V0LlxuICAgKi9cbiAgZ2V0KG9wdGlvbktleToga2V5b2YgT3B0aW9uc1NlcnZpY2UsIGRlZmF1bHRWYWx1ZT86IGFueSkge1xuICAgIGxldCB2YWx1ZSA9IHRoaXNbb3B0aW9uS2V5XTtcbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgdmFsdWUgPSB0aGlzW2NhbWVsQ2FzZShvcHRpb25LZXkpXTtcbiAgICB9XG4gICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcgPyB2YWx1ZSA6IGRlZmF1bHRWYWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIGFuIGFwcGxpY2F0aW9uIG9wdGlvbi5cbiAgICogQHBhcmFtIGtleSBUaGUga2V5IHRvIHNldC5cbiAgICogQHBhcmFtIHZhbHVlIFRoZSB2YWx1ZSB0byBzZXQuXG4gICAqL1xuICBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpIHtcbiAgICB0aGlzW2NhbWVsQ2FzZShrZXkpXSA9IHZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgc3VwcG9ydCB1cmwgZnJvbSB0ZW5hbnQgb3B0aW9ucy5cbiAgICogSWYgcmVzcG9uc2UgcmV0dXJucyAnNDA0IG5vdCBmb3VuZCcgaXQgZ2V0cyB0aGUgc3VwcG9ydCB1cmwgZnJvbSBhcHBsaWNhdGlvbiBvcHRpb25zLlxuICAgKiBJZiB0aGUgc3VwcG9ydCBsaW5rIHdpdGhpbiBhcHBsaWNhdGlvbiBvcHRpb25zIGlzIG5vdCBwcm92aWRlZCB0aGUgVUkgd2lsbCB1c2UgdGhlIHN5c3RlbSBvcHRpb25zLlxuICAgKiBJcyB0aGUgc3VwcG9ydCBsaW5rIGV4cGxpY2l0bHkgc2V0IHRvIGZhbHNlIGl0IHdpbGwgYmUgaGlkZGVuLlxuICAgKlxuICAgKiBAcmV0dXJucyBSZXR1cm5zIHN1cHBvcnQgdXJsIG9yIGZhbHNlLlxuICAgKi9cbiAgYXN5bmMgZ2V0U3VwcG9ydFVybCgpIHtcbiAgICBsZXQgdXJsID0gYXdhaXQgdGhpcy5nZXRUZW5hbnRPcHRpb24oJ2NvbmZpZ3VyYXRpb24nLCAnc3lzdGVtLnN1cHBvcnQudXJsJyk7XG4gICAgaWYgKGlzVW5kZWZpbmVkKHVybCkpIHtcbiAgICAgIHVybCA9IHRoaXMuc3VwcG9ydFVybDtcbiAgICB9XG4gICAgdGhpcy5zdXBwb3J0VXJsID0gaXNVbmRlZmluZWQodXJsKSA/IChhd2FpdCB0aGlzLmdldFN5c3RlbU9wdGlvbignc3VwcG9ydCcsICd1cmwnKSkgfHwgZmFsc2UgOiB1cmw7XG4gICAgcmV0dXJuIHRoaXMuc3VwcG9ydFVybDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGlmIHRoZSB0ZW5hbnQgYWxsb3dzIHRvIHNob3cgdGhlIGFjdGl2YXRlLXN1cHBvcnQgdXNlciBtZW51IGVudHJ5LlxuICAgKiBOb3RlOiBPbmx5IGlmIHN5c3RlbS1sZXZlbCBzdXBwb3J0LXVzZXIvZW5hYmxlZCBpcyBmYWxzZSB3ZSBjYW4gYWN0aXZhdGUgaXQgYXQgdGVuYW50IGxldmVsLlxuICAgKi9cbiAgYXN5bmMgZ2V0QWN0aXZhdGVTdXBwb3J0VXNlcigpIHtcbiAgICBjb25zdCBvcHRpb24gPSBhd2FpdCB0aGlzLmdldFN5c3RlbU9wdGlvbignc3VwcG9ydC11c2VyJywgJ2VuYWJsZWQnLCB0cnVlKTtcbiAgICByZXR1cm4gIW9wdGlvbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIGEgdmFsdWUgZnJvbSB0aGUgc3lzdGVtIHNlcnZpY2UgYW5kIHBhcnNlcyBpdC5cbiAgICpcbiAgICogQHBhcmFtIGNhdGVnb3J5IFRoZSBjYXRlZ29yeSBmb3IgdGhpcyBvcHRpb24uXG4gICAqIEBwYXJhbSBrZXkgVGhlIGtleSBmb3IgdGhhdCBvcHRpb24uXG4gICAqIEBwYXJhbSBkZWZhdWx0VmFsdWUgVGhlIGRlZmF1bHQgaWYgdGhlIG9wdGlvbiB3YXMgbm90IGZvdW5kLlxuICAgKi9cbiAgYXN5bmMgZ2V0U3lzdGVtT3B0aW9uKGNhdGVnb3J5OiBzdHJpbmcsIGtleTogc3RyaW5nLCBkZWZhdWx0VmFsdWU/OiBhbnkpIHtcbiAgICByZXR1cm4gdGhpcy5nZXRPcHRpb25Gcm9tU2VydmljZShjYXRlZ29yeSwga2V5LCB0aGlzLnN5c3RlbU9wdGlvbnNTZXJ2aWNlLCBkZWZhdWx0VmFsdWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgYSB2YWx1ZSBmcm9tIHRoZSB0ZW5hbnQgc2VydmljZSBhbmQgcGFyc2VzIGl0LlxuICAgKlxuICAgKiBAcGFyYW0gY2F0ZWdvcnkgVGhlIGNhdGVnb3J5IGZvciB0aGlzIG9wdGlvbi5cbiAgICogQHBhcmFtIGtleSBUaGUga2V5IGZvciB0aGF0IG9wdGlvbi5cbiAgICogQHBhcmFtIGRlZmF1bHRWYWx1ZSBUaGUgZGVmYXVsdCBpZiB0aGUgb3B0aW9uIHdhcyBub3QgZm91bmQuXG4gICAqL1xuICBhc3luYyBnZXRUZW5hbnRPcHRpb24oY2F0ZWdvcnk6IHN0cmluZywga2V5OiBzdHJpbmcsIGRlZmF1bHRWYWx1ZT86IGFueSkge1xuICAgIHJldHVybiB0aGlzLmdldE9wdGlvbkZyb21TZXJ2aWNlKGNhdGVnb3J5LCBrZXksIHRoaXMudGVuYW50T3B0aW9uU2VydmljZSwgZGVmYXVsdFZhbHVlKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0dXBPcHRpb25zKG9wdGlvbnM6IGFueVtdIHwgbnVsbCkge1xuICAgIGlmIChvcHRpb25zKSB7XG4gICAgICBpZiAoIUFycmF5LmlzQXJyYXkob3B0aW9ucykpIHtcbiAgICAgICAgb3B0aW9ucyA9IFtvcHRpb25zXTtcbiAgICAgIH1cbiAgICAgIG9wdGlvbnMuZm9yRWFjaChvcHRpb25NYXAgPT4ge1xuICAgICAgICBpZiAob3B0aW9uTWFwKSB7XG4gICAgICAgICAgT2JqZWN0LmtleXMob3B0aW9uTWFwKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgICB0aGlzW2NhbWVsQ2FzZShrZXkpXSA9IG9wdGlvbk1hcFtrZXldO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldE9wdGlvbkZyb21TZXJ2aWNlKGNhdGVnb3J5LCBrZXksIHNlcnZpY2UsIGRlZmF1bHRWYWx1ZSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHNlcnZpY2UuZGV0YWlsKHsgY2F0ZWdvcnksIGtleSB9KTtcbiAgICAgIHJldHVybiB0aGlzLnBhcnNlT3B0aW9uUmF3VmFsdWUoZGF0YS52YWx1ZSwgZGVmYXVsdFZhbHVlKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHBhcnNlT3B0aW9uUmF3VmFsdWUocmF3VmFsdWUsIGRlZmF1bHRWYWx1ZSkge1xuICAgIGxldCB2YWx1ZTtcbiAgICB0cnkge1xuICAgICAgdmFsdWUgPSBKU09OLnBhcnNlKHJhd1ZhbHVlKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB2YWx1ZSA9IGlzVW5kZWZpbmVkKHJhd1ZhbHVlKSA/IGRlZmF1bHRWYWx1ZSA6IHJhd1ZhbHVlO1xuICAgIH1cbiAgICByZXR1cm4gdmFsdWU7XG4gIH1cbn1cbiJdfQ==