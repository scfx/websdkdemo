import { __awaiter } from "tslib";
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { AddressSpaceService } from './address-space.service';
import { OpcuaService } from './opcuaService';
import { AlertService } from '@c8y/ngx-components';
import { DynamicDataSource } from './dynamic-data-source';
import { NestedTreeControl } from '@angular/cdk/tree';
import { clone } from 'lodash';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
export class OpcuaAddressSpaceTreeComponent {
    constructor(addressSpaceService, opcuaService, alertService) {
        this.addressSpaceService = addressSpaceService;
        this.opcuaService = opcuaService;
        this.alertService = alertService;
        this.focusEmitter = new EventEmitter();
        this.selectedNode = new EventEmitter();
        this.dataSource = null;
        this.loading = false;
        this.destroy$ = new Subject();
        this.getChildren = (node) => (node.expanded ? node.children : []);
        this.hasChild = (_, _nodeData) => this.addressSpaceService.childrenAvailable(_nodeData.references);
    }
    set moId(id) {
        this._moId = id || undefined;
    }
    ngOnInit() {
        this.initializeDataSet();
    }
    ngOnChanges(changes) {
        if (changes.moId && changes.moId.previousValue && (changes.moId.currentValue !== changes.moId.previousValue)) {
            this.initializeDataSet();
        }
    }
    initializeDataSet() {
        this.nodeNavDataSubscription = this.addressSpaceService
            .getNodeNavData$()
            .pipe(takeUntil(this.destroy$))
            .subscribe(nodeNavData => this.openNode(nodeNavData));
        this.subscriptionRef = this.focusEmitter.subscribe(node => {
            this.focused = this.isFocusedNode(node) ? undefined : node;
        });
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
        // clean up the address-space-tree
        this.addressSpaceService.resetTreeToRootNode();
        if (this.nodeNavDataSubscription && !this.nodeNavDataSubscription.closed) {
            this.nodeNavDataSubscription.unsubscribe();
        }
        if (this.subscriptionRef && !this.subscriptionRef.closed) {
            this.subscriptionRef.unsubscribe();
        }
    }
    openNode(nodeNavData) {
        return __awaiter(this, void 0, void 0, function* () {
            const { node, selectedAncestorIds } = nodeNavData;
            let nodeId;
            // We just set the nodeId when the selectedAncestorIds variable an empty array.
            // If selectedAncestorIds contain any id we assume that the tree should be travsersed beginning
            // from the root node.
            if (node && node.nodeId && selectedAncestorIds && selectedAncestorIds.length === 0) {
                nodeId = node.nodeId;
            }
            // Always recreate the tree when routing to a specific nested node,
            // because previous modifications to the tree-structure could cause errors
            // while traversing with 'old' tree-data
            // -----------------
            // setupTree is able to handle nodeId = undefined
            yield this.setupTree(nodeId);
            if (!selectedAncestorIds || selectedAncestorIds.length === 0) {
                return;
            }
            if (nodeNavData && this.dataSource) {
                const clonedAncestors = clone(selectedAncestorIds);
                clonedAncestors.shift();
                const n = yield this.dataSource.toggleNode(this.dataSource.data[0], true);
                this.setChildNodes(n.children, clonedAncestors);
                this.toggleFocusedNode(node);
            }
        });
    }
    setChildNodes(nodes, ids) {
        if (nodes) {
            ids.forEach((id) => __awaiter(this, void 0, void 0, function* () {
                const match = nodes.find(n => n.nodeId === id);
                if (match && ids.length > 0) {
                    const idx = ids.findIndex(value => value === id);
                    if (idx >= 0) {
                        ids.splice(idx, 1);
                    }
                    const toggledNode = yield this.dataSource.toggleNode(match, true);
                    this.setChildNodes(toggledNode.children, ids);
                }
            }));
        }
    }
    setupTree(nodeId) {
        return __awaiter(this, void 0, void 0, function* () {
            this.loading = true;
            if (!this._moId || this._moId.length === 0) {
                this._moId = this.opcuaService.getMoId();
            }
            // addressSpaceService.getNode returns either the root node of the server (moId)
            // or if nodeId !== undefined the node with given nodeId
            const res = yield this.addressSpaceService.getNode(this._moId, nodeId);
            if (res) {
                if (res.status !== 200) {
                    const data = res.json ? yield res.json() : undefined;
                    this.alertService.addServerFailure({ data, res });
                    this.dataSource = undefined;
                }
                else {
                    const rootNode = (yield res.json());
                    this.nestedTreeControl = new NestedTreeControl(this.getChildren);
                    this.dataSource = new DynamicDataSource(this.nestedTreeControl, this.addressSpaceService, this._moId);
                    this.dataSource.data = [rootNode];
                }
                this.loading = false;
            }
            else {
                this.loading = false;
            }
        });
    }
    getMoId() {
        if (!this._moId || this._moId.length === 0) {
            return this.opcuaService.getMoId();
        }
        return this._moId;
    }
    getIcon(nodeClassName) {
        return this.addressSpaceService.getIcon(nodeClassName);
    }
    toggleFocusedNode(node) {
        const relativePath = [];
        this.getRelativePath(node, relativePath);
        node.relativePath = relativePath;
        this.selectedNode.emit(node);
        this.focused = this.isFocusedNode(node) ? undefined : node;
    }
    isFocusedNode(node) {
        if (this.focused) {
            return node.nodeId === this.focused.nodeId;
        }
        return false;
    }
    getRelativePath(node, relativePath) {
        if (node.parentNode) {
            relativePath.unshift(node.browseName);
            this.getRelativePath(node.parentNode, relativePath);
        }
    }
}
OpcuaAddressSpaceTreeComponent.decorators = [
    { type: Component, args: [{
                selector: 'opcua-address-space-tree',
                template: "<div class=\"card-block\" *ngIf=\"dataSource && !loading\">\n  <cdk-tree [dataSource]=\"dataSource\" [treeControl]=\"nestedTreeControl\">\n    <!-- This is the tree node template for leaf nodes -->\n    <cdk-nested-tree-node\n      *cdkTreeNodeDef=\"let node\"\n      (click)=\"toggleFocusedNode(node)\"\n      [ngClass]=\"{ strong: isFocusedNode(node) }\"\n      class=\"interact\"\n    >\n      <span>\n        <i\n          class=\"m-r-4 interact\"\n          [c8yIcon]=\"getIcon(node.nodeClassName)\"\n          [ngClass]=\"{ strong: isFocusedNode(node) }\"\n        ></i>\n        {{ node.displayName }}\n      </span>\n    </cdk-nested-tree-node>\n    <!-- This is the tree node template for expandable nodes -->\n    <cdk-nested-tree-node *cdkTreeNodeDef=\"let node; when: hasChild\">\n      <div class=\"flex-row\">\n        <button\n          cdkTreeNodeToggle\n          class=\"btn-clean text-primary m-r-4\"\n          [disabled]=\"node.currentlyLoadingChildren\"\n        >\n          <i\n            [ngClass]=\"{ 'dlt-c8y-icon-plus-square': !node.expanded, 'dlt-c8y-icon-minus-square': node.expanded }\"\n          ></i>\n        </button>\n        <i\n          class=\"m-r-4 interact\"\n          [c8yIcon]=\"getIcon(node.nodeClassName)\"\n        ></i>\n        <span\n          (click)=\"toggleFocusedNode(node)\"\n          [ngClass]=\"{ strong: isFocusedNode(node) }\"\n          class=\"interact\"\n        >\n          {{ node.displayName }}\n        </span>\n        <span\n          class=\"m-l-4\"\n          [style.visibility]=\"node.currentlyLoadingChildren ? 'visible' : 'hidden'\"\n        >\n          <i class=\"dlt-c8y-icon-circle-o-notch icon-spin\"></i>\n        </span>\n      </div>\n      <ng-container cdkTreeNodeOutlet></ng-container>\n    </cdk-nested-tree-node>\n  </cdk-tree>\n</div>\n<div class=\"p-8\" *ngIf=\"loading\">\n  <div class=\"spinner p-relative\">\n    <div class=\"rect1\"></div>\n    <div class=\"rect2\"></div>\n    <div class=\"rect3\"></div>\n    <div class=\"rect4\"></div>\n    <div class=\"rect5\"></div>\n  </div>\n</div>\n<div class=\"alert alert-info m-t-16\" *ngIf=\"!dataSource && !loading\" translate>\n  No source data available to fetch address space.\n</div>\n"
            },] }
];
OpcuaAddressSpaceTreeComponent.ctorParameters = () => [
    { type: AddressSpaceService },
    { type: OpcuaService },
    { type: AlertService }
];
OpcuaAddressSpaceTreeComponent.propDecorators = {
    moId: [{ type: Input }],
    node: [{ type: Input }],
    focusEmitter: [{ type: Input }],
    selectedNode: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtYWRkcmVzcy1zcGFjZS10cmVlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3Byb3RvY29sLW9wY3VhL29wY3VhLWFkZHJlc3Mtc3BhY2UtdHJlZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFFTixZQUFZLEVBSWIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFvQixtQkFBbUIsRUFBc0IsTUFBTSx5QkFBeUIsQ0FBQztBQUNwRyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3RELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDL0IsT0FBTyxFQUFFLE9BQU8sRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDN0MsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBTTNDLE1BQU0sT0FBTyw4QkFBOEI7SUFrQnpDLFlBQ1UsbUJBQXdDLEVBQ3hDLFlBQTBCLEVBQzFCLFlBQTBCO1FBRjFCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFkM0IsaUJBQVksR0FBbUMsSUFBSSxZQUFZLEVBQW9CLENBQUM7UUFDbkYsaUJBQVksR0FBbUMsSUFBSSxZQUFZLEVBQW9CLENBQUM7UUFFOUYsZUFBVSxHQUFzQixJQUFJLENBQUM7UUFFckMsWUFBTyxHQUFZLEtBQUssQ0FBQztRQUlqQixhQUFRLEdBQWlCLElBQUks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LENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztTQUM1QztRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVPLGVBQWUsQ0FBQyxJQUFzQixFQUFFLFlBQXNCO1FBQ3BFLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNuQixZQUFZLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUN0QyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsWUFBWSxDQUFDLENBQUM7U0FDckQ7SUFDSCxDQUFDOzs7WUFsTEYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSwwQkFBMEI7Z0JBQ3BDLHFzRUFBd0Q7YUFDekQ7OztZQVowQixtQkFBbUI7WUFDckMsWUFBWTtZQUNaLFlBQVk7OzttQkFZbEIsS0FBSzttQkFLTCxLQUFLOzJCQUNMLEtBQUs7MkJBQ0wsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgT25Jbml0LFxuICBFdmVudEVtaXR0ZXIsXG4gIE9uRGVzdHJveSxcbiAgT25DaGFuZ2VzLFxuICBTaW1wbGVDaGFuZ2VzXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWRkcmVzc1NwYWNlTm9kZSwgQWRkcmVzc1NwYWNlU2VydmljZSwgTm9kZU5hdmlnYXRpb25EYXRhIH0gZnJvbSAnLi9hZGRyZXNzLXNwYWNlLnNlcnZpY2UnO1xuaW1wb3J0IHsgT3BjdWFTZXJ2aWNlIH0gZnJvbSAnLi9vcGN1YVNlcnZpY2UnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBEeW5hbWljRGF0YVNvdXJjZSB9IGZyb20gJy4vZHluYW1pYy1kYXRhLXNvdXJjZSc7XG5pbXBvcnQgeyBOZXN0ZWRUcmVlQ29udHJvbCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay90cmVlJztcbmltcG9ydCB7IGNsb25lIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdvcGN1YS1hZGRyZXNzLXNwYWNlLXRyZWUnLFxuICB0ZW1wbGF0ZVVybDogJy4vb3BjdWEtYWRkcmVzcy1zcGFjZS10cmVlLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBPcGN1YUFkZHJlc3NTcGFjZVRyZWVDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSwgT25DaGFuZ2VzIHtcbiAgQElucHV0KClcbiAgc2V0IG1vSWQoaWQ6IHN0cmluZykge1xuICAgIHRoaXMuX21vSWQgPSBpZCB8fCB1bmRlZmluZWQ7XG4gIH1cblxuICBASW5wdXQoKSBub2RlO1xuICBASW5wdXQoKSBmb2N1c0VtaXR0ZXI6IEV2ZW50RW1pdHRlcjxBZGRyZXNzU3BhY2VOb2RlPiA9IG5ldyBFdmVudEVtaXR0ZXI8QWRkcmVzc1NwYWNlTm9kZT4oKTtcbiAgQE91dHB1dCgpIHNlbGVjdGVkTm9kZTogRXZlbnRFbWl0dGVyPEFkZHJlc3NTcGFjZU5vZGU+ID0gbmV3IEV2ZW50RW1pdHRlcjxBZGRyZXNzU3BhY2VOb2RlPigpO1xuICBuZXN0ZWRUcmVlQ29udHJvbDogTmVzdGVkVHJlZUNvbnRyb2w8QWRkcmVzc1NwYWNlTm9kZT47XG4gIGRhdGFTb3VyY2U6IER5bmFtaWNEYXRhU291cmNlID0gbnVsbDtcbiAgZm9jdXNlZDogQWRkcmVzc1NwYWNlTm9kZTtcbiAgbG9hZGluZzogYm9vbGVhbiA9IGZhbHNlO1xuICBzdWJzY3JpcHRpb25SZWY6IFN1YnNjcmlwdGlvbjtcbiAgbm9kZU5hdkRhdGFTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgcHJpdmF0ZSBfbW9JZDogc3RyaW5nO1xuICBwcml2YXRlIGRlc3Ryb3kkOiBTdWJqZWN0PGFueT4gPSBuZXcgU3ViamVjdDxhbnk+KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhZGRyZXNzU3BhY2VTZXJ2aWNlOiBBZGRyZXNzU3BhY2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgb3BjdWFTZXJ2aWNlOiBPcGN1YVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhbGVydFNlcnZpY2U6IEFsZXJ0U2VydmljZVxuICApIHt9XG5cbiAgZ2V0Q2hpbGRyZW4gPSAobm9kZTogQWRkcmVzc1NwYWNlTm9kZSkgPT4gKG5vZGUuZXhwYW5kZWQgPyBub2RlLmNoaWxkcmVuIDogW10pO1xuICBoYXNDaGlsZCA9IChfOiBudW1iZXIsIF9ub2RlRGF0YTogQWRkcmVzc1NwYWNlTm9kZSkgPT5cbiAgICB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2UuY2hpbGRyZW5BdmFpbGFibGUoX25vZGVEYXRhLnJlZmVyZW5jZXMpXG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5pbml0aWFsaXplRGF0YVNldCgpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmIChjaGFuZ2VzLm1vSWQgJiYgY2hhbmdlcy5tb0lkLnByZXZpb3VzVmFsdWUgJiYgKGNoYW5nZXMubW9JZC5jdXJyZW50VmFsdWUgIT09IGNoYW5nZXMubW9JZC5wcmV2aW91c1ZhbHVlKSkge1xuICAgICAgdGhpcy5pbml0aWFsaXplRGF0YVNldCgpO1xuICAgIH1cbiAgfVxuXG4gIGluaXRpYWxpemVEYXRhU2V0KCkge1xuICAgIHRoaXMubm9kZU5hdkRhdGFTdWJzY3JpcHRpb24gPSB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2VcbiAgICAgIC5nZXROb2RlTmF2RGF0YSQoKVxuICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveSQpKVxuICAgICAgLnN1YnNjcmliZShub2RlTmF2RGF0YSA9PiB0aGlzLm9wZW5Ob2RlKG5vZGVOYXZEYXRhKSk7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25SZWYgPSB0aGlzLmZvY3VzRW1pdHRlci5zdWJzY3JpYmUobm9kZSA9PiB7XG4gICAgICB0aGlzLmZvY3VzZWQgPSB0aGlzLmlzRm9jdXNlZE5vZGUobm9kZSkgPyB1bmRlZmluZWQgOiBub2RlO1xuICAgIH0pO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5kZXN0cm95JC5uZXh0KCk7XG4gICAgdGhpcy5kZXN0cm95JC5jb21wbGV0ZSgpO1xuICAgIC8vIGNsZWFuIHVwIHRoZSBhZGRyZXNzLXNwYWNlLXRyZWVcbiAgICB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2UucmVzZXRUcmVlVG9Sb290Tm9kZSgpO1xuXG4gICAgaWYgKHRoaXMubm9kZU5hdkRhdGFTdWJzY3JpcHRpb24gJiYgIXRoaXMubm9kZU5hdkRhdGFTdWJzY3JpcHRpb24uY2xvc2VkKSB7XG4gICAgICB0aGlzLm5vZGVOYXZEYXRhU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9uUmVmICYmICF0aGlzLnN1YnNjcmlwdGlvblJlZi5jbG9zZWQpIHtcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9uUmVmLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgb3Blbk5vZGUobm9kZU5hdkRhdGE6IE5vZGVOYXZpZ2F0aW9uRGF0YSkge1xuICAgIGNvbnN0IHsgbm9kZSwgc2VsZWN0ZWRBbmNlc3RvcklkcyB9ID0gbm9kZU5hdkRhdGE7XG4gICAgbGV0IG5vZGVJZDtcblxuICAgIC8vIFdlIGp1c3Qgc2V0IHRoZSBub2RlSWQgd2hlbiB0aGUgc2VsZWN0ZWRBbmNlc3RvcklkcyB2YXJpYWJsZSBhbiBlbXB0eSBhcnJheS5cbiAgICAvLyBJZiBzZWxlY3RlZEFuY2VzdG9ySWRzIGNvbnRhaW4gYW55IGlkIHdlIGFzc3VtZSB0aGF0IHRoZSB0cmVlIHNob3VsZCBiZSB0cmF2c2Vyc2VkIGJlZ2lubmluZ1xuICAgIC8vIGZyb20gdGhlIHJvb3Qgbm9kZS5cbiAgICBpZiAobm9kZSAmJiBub2RlLm5vZGVJZCAmJiBzZWxlY3RlZEFuY2VzdG9ySWRzICYmIHNlbGVjdGVkQW5jZXN0b3JJZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICBub2RlSWQgPSBub2RlLm5vZGVJZDtcbiAgICB9XG4gICAgLy8gQWx3YXlzIHJlY3JlYXRlIHRoZSB0cmVlIHdoZW4gcm91dGluZyB0byBhIHNwZWNpZmljIG5lc3RlZCBub2RlLFxuICAgIC8vIGJlY2F1c2UgcHJldmlvdXMgbW9kaWZpY2F0aW9ucyB0byB0aGUgdHJlZS1zdHJ1Y3R1cmUgY291bGQgY2F1c2UgZXJyb3JzXG4gICAgLy8gd2hpbGUgdHJhdmVyc2luZyB3aXRoICdvbGQnIHRyZWUtZGF0YVxuICAgIC8vIC0tLS0tLS0tLS0tLS0tLS0tXG4gICAgLy8gc2V0dXBUcmVlIGlzIGFibGUgdG8gaGFuZGxlIG5vZGVJZCA9IHVuZGVmaW5lZFxuICAgIGF3YWl0IHRoaXMuc2V0dXBUcmVlKG5vZGVJZCk7XG5cbiAgICBpZiAoIXNlbGVjdGVkQW5jZXN0b3JJZHMgfHwgc2VsZWN0ZWRBbmNlc3Rvcklkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAobm9kZU5hdkRhdGEgJiYgdGhpcy5kYXRhU291cmNlKSB7XG4gICAgICBjb25zdCBjbG9uZWRBbmNlc3RvcnMgPSBjbG9uZShzZWxlY3RlZEFuY2VzdG9ySWRzKTtcbiAgICAgIGNsb25lZEFuY2VzdG9ycy5zaGlmdCgpO1xuXG4gICAgICBjb25zdCBuID0gYXdhaXQgdGhpcy5kYXRhU291cmNlLnRvZ2dsZU5vZGUodGhpcy5kYXRhU291cmNlLmRhdGFbMF0sIHRydWUpO1xuICAgICAgdGhpcy5zZXRDaGlsZE5vZGVzKG4uY2hpbGRyZW4sIGNsb25lZEFuY2VzdG9ycyk7XG5cbiAgICAgIHRoaXMudG9nZ2xlRm9jdXNlZE5vZGUobm9kZSk7XG4gICAgfVxuICB9XG5cbiAgc2V0Q2hpbGROb2Rlcyhub2RlczogQWRkcmVzc1NwYWNlTm9kZVtdLCBpZHM6IHN0cmluZ1tdKSB7XG4gICAgaWYgKG5vZGVzKSB7XG4gICAgICBpZHMuZm9yRWFjaChhc3luYyBpZCA9PiB7XG4gICAgICAgIGNvbnN0IG1hdGNoID0gbm9kZXMuZmluZChuID0+IG4ubm9kZUlkID09PSBpZCk7XG4gICAgICAgIGlmIChtYXRjaCAmJiBpZHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGNvbnN0IGlkeCA9IGlkcy5maW5kSW5kZXgodmFsdWUgPT4gdmFsdWUgPT09IGlkKTtcbiAgICAgICAgICBpZiAoaWR4ID49IDApIHtcbiAgICAgICAgICAgIGlkcy5zcGxpY2UoaWR4LCAxKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgY29uc3QgdG9nZ2xlZE5vZGUgPSBhd2FpdCB0aGlzLmRhdGFTb3VyY2UudG9nZ2xlTm9kZShtYXRjaCwgdHJ1ZSk7XG4gICAgICAgICAgdGhpcy5zZXRDaGlsZE5vZGVzKHRvZ2dsZWROb2RlLmNoaWxkcmVuLCBpZHMpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzZXR1cFRyZWUobm9kZUlkPzogc3RyaW5nKSB7XG4gICAgdGhpcy5sb2FkaW5nID0gdHJ1ZTtcblxuICAgIGlmICghdGhpcy5fbW9JZCB8fCB0aGlzLl9tb0lkLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhpcy5fbW9JZCA9IHRoaXMub3BjdWFTZXJ2aWNlLmdldE1vSWQoKTtcbiAgICB9XG5cbiAgICAvLyBhZGRyZXNzU3BhY2VTZXJ2aWNlLmdldE5vZGUgcmV0dXJucyBlaXRoZXIgdGhlIHJvb3Qgbm9kZSBvZiB0aGUgc2VydmVyIChtb0lkKVxuICAgIC8vIG9yIGlmIG5vZGVJZCAhPT0gdW5kZWZpbmVkIHRoZSBub2RlIHdpdGggZ2l2ZW4gbm9kZUlkXG4gICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5hZGRyZXNzU3BhY2VTZXJ2aWNlLmdldE5vZGUodGhpcy5fbW9JZCwgbm9kZUlkKTtcbiAgICBpZiAocmVzKSB7XG4gICAgICBpZiAocmVzLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSByZXMuanNvbiA/IGF3YWl0IHJlcy5qc29uKCkgOiB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoeyBkYXRhLCByZXMgfSk7XG4gICAgICAgIHRoaXMuZGF0YVNvdXJjZSA9IHVuZGVmaW5lZDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJvb3ROb2RlID0gKGF3YWl0IHJlcy5qc29uKCkpIGFzIEFkZHJlc3NTcGFjZU5vZGU7XG4gICAgICAgIHRoaXMubmVzdGVkVHJlZUNvbnRyb2wgPSBuZXcgTmVzdGVkVHJlZUNvbnRyb2w8QWRkcmVzc1NwYWNlTm9kZT4odGhpcy5nZXRDaGlsZHJlbik7XG4gICAgICAgIHRoaXMuZGF0YVNvdXJjZSA9IG5ldyBEeW5hbWljRGF0YVNvdXJjZShcbiAgICAgICAgICB0aGlzLm5lc3RlZFRyZWVDb250cm9sLFxuICAgICAgICAgIHRoaXMuYWRkcmVzc1NwYWNlU2VydmljZSxcbiAgICAgICAgICB0aGlzLl9tb0lkXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMuZGF0YVNvdXJjZS5kYXRhID0gW3Jvb3ROb2RlXTtcbiAgICAgIH1cbiAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBnZXRNb0lkKCkge1xuICAgIGlmICghdGhpcy5fbW9JZCB8fCB0aGlzLl9tb0lkLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHRoaXMub3BjdWFTZXJ2aWNlLmdldE1vSWQoKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuX21vSWQ7XG4gIH1cblxuICBnZXRJY29uKG5vZGVDbGFzc05hbWUpIHtcbiAgICByZXR1cm4gdGhpcy5hZGRyZXNzU3BhY2VTZXJ2aWNlLmdldEljb24obm9kZUNsYXNzTmFtZSk7XG4gIH1cblxuICB0b2dnbGVGb2N1c2VkTm9kZShub2RlKSB7XG4gICAgY29uc3QgcmVsYXRpdmVQYXRoID0gW107XG4gICAgdGhpcy5nZXRSZWxhdGl2ZVBhdGgobm9kZSwgcmVsYXRpdmVQYXRoKTtcbiAgICBub2RlLnJlbGF0aXZlUGF0aCA9IHJlbGF0aXZlUGF0aDtcblxuICAgIHRoaXMuc2VsZWN0ZWROb2RlLmVtaXQobm9kZSk7XG4gICAgdGhpcy5mb2N1c2VkID0gdGhpcy5pc0ZvY3VzZWROb2RlKG5vZGUpID8gdW5kZWZpbmVkIDogbm9kZTtcbiAgfVxuXG4gIGlzRm9jdXNlZE5vZGUobm9kZTogQWRkcmVzc1NwYWNlTm9kZSkge1xuICAgIGlmICh0aGlzLmZvY3VzZWQpIHtcbiAgICAgIHJldHVybiBub2RlLm5vZGVJZCA9PT0gdGhpcy5mb2N1c2VkLm5vZGVJZDtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSZWxhdGl2ZVBhdGgobm9kZTogQWRkcmVzc1NwYWNlTm9kZSwgcmVsYXRpdmVQYXRoOiBzdHJpbmdbXSkge1xuICAgIGlmIChub2RlLnBhcmVudE5vZGUpIHtcbiAgICAgIHJlbGF0aXZlUGF0aC51bnNoaWZ0KG5vZGUuYnJvd3NlTmFtZSk7XG4gICAgICB0aGlzLmdldFJlbGF0aXZlUGF0aChub2RlLnBhcmVudE5vZGUsIHJlbGF0aXZlUGF0aCk7XG4gICAgfVxuICB9XG59XG4iXX0=