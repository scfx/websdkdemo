import { __awaiter } from "tslib";
import { Component, Input, Output, EventEmitter, ViewChild } from '@angular/core';
import { gettext, DropAreaComponent } from '@c8y/ngx-components';
import { cloneDeep, has } from 'lodash-es';
import { OpcuaService } from './opcuaService';
export class OpcuaServerConfigComponent {
    constructor(opcuaService) {
        this.fileName = '';
        this.targetConnectionState = '1';
        this.minIntervalNumber = 1;
        this.connectionStatusLabel = '';
        this.canceled = new EventEmitter();
        this.removed = new EventEmitter();
        this.saved = new EventEmitter();
        this.changePassword = false;
        this.initialPasswordRequired = true;
        this.NONE = 'NONE';
        this.SIGN = 'SIGN';
        this.SIGN_ENC = 'SIGN_ENCRYPT';
        this.securityPolicies = {
            sign: [
                `BASIC256_${this.SIGN}`,
                `BASIC128RSA15_${this.SIGN}`,
                `BASIC256SHA256_${this.SIGN}`
            ],
            sign_enc: [
                `BASIC256_${this.SIGN_ENC}`,
                `BASIC128RSA15_${this.SIGN_ENC}`,
                `BASIC256SHA256_${this.SIGN_ENC}`,
            ]
        };
        this.ANONYM = {
            id: 1,
            value: gettext('Anonymous')
        };
        this.USER_PASSWORD = {
            id: 2,
            value: gettext('Username/Password')
        };
        this.KEY_BASED = {
            id: 3,
            value: gettext('Key-based Authentication')
        };
        this.initialKeystore = {
            lastModified: 0,
            name: '',
            type: '',
            slice: null,
            size: 0
        };
        this.keystore = this.initialKeystore;
        this.authSwitch = false;
        this.opcuaService = opcuaService;
    }
    set server(server) {
        if (server) {
            this._server = cloneDeep(server);
            this.model = cloneDeep(server);
            this.fileName = this.model.config.keystoreFilename;
            if (server.id && server.id === 'new') {
                // enabled connection state
                this.targetConnectionState = '1';
                this.model.config.targetConnectionState = 'enabled';
            }
            else {
                this.targetConnectionState = (this.model.config.targetConnectionState === 'enabled') ? '1' : '0';
            }
            this.updateConnectionStatusLabel(this._server);
            this.setNewPassword();
        }
    }
    get server() {
        return this._server;
    }
    ngOnInit() {
        return __awaiter(this, void 0, void 0, function* () {
            this.authSwitch = false;
            this.securityModes = [
                this.NONE,
                this.SIGN,
                this.SIGN_ENC
            ];
            this.authenticationModes = [
                this.ANONYM,
                this.USER_PASSWORD,
                this.KEY_BASED
            ];
            this.setCurrentAuthenticationMode();
            this.setCurrentSecurityMode();
        });
    }
    ngOnChanges() {
        this.setCurrentSecurityMode();
        this.setCurrentAuthenticationMode();
    }
    cancel() {
        this.canceled.emit(this.model);
        this._server = null;
    }
    remove() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.removeKeystore(this.model);
            this.removed.emit(this.model);
            this._server = null;
        });
    }
    save() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.keystore && this.keystore.size > 0 && this.keystore.name && this.keystore.name.length > 0) {
                const response = yield this.uploadKeystore(this.model.config.keystoreBinaryId);
                if (response && response.data && response.data.id) {
                    this.model.config.keystoreBinaryId = response.data.id;
                }
                // if the keystore was uploaded successful we can remove
                // the local keystore. This will prevent another request to binary api
                // when the user will edit other inputs in the form and hit save again.
                this.keystore = this.initialKeystore;
            }
            // will remove keystore (binary) when the user switched
            // authentication settings from key-based to anonymous or username/password
            if (this.authSwitch) {
                this.removeKeystore(this.server);
            }
            // when the user sets a new password, make sure to mark it as
            // "not encrypted" by setting passwordEncrypted to false
            const userPassword = this.getModelConfig('userPassword');
            if (userPassword && userPassword.length > 0) {
                this.model.config.passwordEncrypted = false;
            }
            this.saved.emit(this.model);
        });
    }
    uploadFile(droppedFiles) {
        if (droppedFiles.length === 1) {
            this.keystore = droppedFiles[0].file;
            this.fileName = this.keystore.name;
        }
        else {
            // dropped more than one file
            console.warn('Tried to import... Import aborted.');
        }
    }
    setPolicy(data) {
        if (data === this.NONE) {
            this.model.config.securityMode = this.NONE;
        }
        else if (data === this.SIGN) {
            this.model.config.securityMode = this.securityPolicies.sign[0];
        }
        else if (data === this.SIGN_ENC) {
            this.model.config.securityMode = this.securityPolicies.sign_enc[0];
        }
    }
    setServerConnection(data) {
        this.model.config.targetConnectionState = (data !== '0') ? 'enabled' : 'disabled';
    }
    updateAuthentication(data) {
        if (data && data.id) {
            switch (data.id) {
                // Anonymous
                case 1:
                    this.resetUserAuthentication();
                    this.resetKeyBasedAuthentication();
                    break;
                // User/Password
                case 2:
                    this.resetKeyBasedAuthentication();
                    this.restoreUserData();
                    this.setNewPassword();
                    break;
                // Key-based
                case 3:
                    this.resetUserAuthentication();
                    this.restoreKeyBasedData();
                    break;
                default:
                    console.warn('Invalid authentication id', data.id);
                    break;
            }
        }
    }
    updateConnectionStatusLabel(server) {
        const connected = server.c8y_Connection && server.c8y_Connection.status === 'CONNECTED';
        const label = connected ? gettext('Connected') : gettext('Disconnected');
        this.connectionStatusLabel = label;
    }
    setNewPassword() {
        const username = this.getModelConfig('userName');
        if (username && username.length > 0) {
            // userName is given, NO need to change the password because it is already set
            this.changePassword = false;
            this.initialPasswordRequired = false;
        }
        else {
            // no userName in response, so require the user to set the initial pw
            this.changePassword = true;
            this.initialPasswordRequired = true;
        }
    }
    toggleChangePassword() {
        this.changePassword = !this.changePassword;
        // When the user hides the pw-input field but has entered a
        // string to it before, we need to discard the changes reflected in the model
        // otherwise we PUT it with the model when user hits the save button
        if (!this.changePassword) {
            if (this.getModelConfig('userPassword')) {
                delete this.model.config.userPassword;
            }
        }
    }
    uploadKeystore(binaryId) {
        if (!binaryId) {
            return this.opcuaService.uploadKeystore(this.keystore);
        }
        else if (binaryId && binaryId.length > 0) {
            // update existing binary
            return this.opcuaService.updateKeystore(binaryId, this.keystore);
        }
    }
    removeKeystore(server) {
        if (server &&
            server.config &&
            server.config.keystoreBinaryId &&
            server.config.keystoreBinaryId.length > 0) {
            this.authSwitch = false;
            return this.opcuaService.removeKeystore(this.server.config.keystoreBinaryId);
        }
    }
    resetUserAuthentication() {
        this.model.config.userName = null;
        this.model.config.userPassword = null;
        this.model.config.userIdentityMode = 'none';
    }
    resetKeyBasedAuthentication() {
        this.authSwitch = true;
        this.model.config.keystorePass = null;
        this.model.config.certificatePass = null;
        this.model.config.keystoreBinaryId = '';
        this.model.config.keystoreFilename = '';
        this.model.config.userIdentityMode = 'none';
    }
    restoreUserData() {
        this.model.config.userName = this._server.config.userName;
        this.model.config.userIdentityMode = 'userAndPassword';
    }
    restoreKeyBasedData() {
        this.authSwitch = false;
        this.model.config.keystorePass = this._server.config.keystorePass;
        this.model.config.certificatePass = this._server.config.certificatePass;
        this.model.config.keystoreBinaryId = this._server.config.keystoreBinaryId;
        this.model.config.keystoreFilename = this._server.config.keystoreFilename;
        this.model.config.userIdentityMode = 'certificate';
    }
    getServerConfig() {
        let cfg = {
            securityMode: this.NONE,
            userIdentityMode: 'none'
        };
        if (this.server && this.server.config) {
            cfg = this.server.config;
        }
        return cfg;
    }
    setCurrentSecurityMode() {
        const { securityMode } = this.getServerConfig();
        if (securityMode) {
            const foundInSign = this.securityPolicies.sign.find((el) => el === securityMode);
            if (foundInSign) {
                this.currentSecMode = this.SIGN;
            }
            else {
                const foundInSignEncrypt = this.securityPolicies.sign_enc.find((el) => el === securityMode);
                foundInSignEncrypt ? this.currentSecMode = this.SIGN_ENC : this.currentSecMode = this.NONE;
            }
        }
    }
    setCurrentAuthenticationMode() {
        const { userIdentityMode } = this.getServerConfig();
        switch (userIdentityMode) {
            case 'certificate':
                this.authenticationMode = this.KEY_BASED;
                break;
            case 'userAndPassword':
                this.authenticationMode = this.USER_PASSWORD;
                break;
            case 'Anonymous':
                this.authenticationMode = this.ANONYM;
                break;
            case 'UserName':
                this.authenticationMode = this.USER_PASSWORD;
                break;
            case 'Certificate':
                this.authenticationMode = this.KEY_BASED;
                break;
            default:
                this.authenticationMode = this.ANONYM;
                break;
        }
    }
    getModelConfig(fragment) {
        if (this.model && this.model.config) {
            if (fragment && fragment.length > 0) {
                return has(this.model.config, fragment) ? this.model.config[`${fragment}`] : undefined;
            }
        }
        return undefined;
    }
}
OpcuaServerConfigComponent.decorators = [
    { type: Component, args: [{
                selector: 'opcua-server-config',
                template: "\n  <div class=\"c8y-empty-state m-t-24\"  ng-if=\"!vm.editInstruction.type\" *ngIf=\"!server\">\n    <h1 class=\"c8y-icon c8y-icon-duocolor\" c8yIcon=\"server\"></h1>\n    <div>\n      <h3>{{ 'No server to display.' | translate }}</h3>\n      <p>{{ 'Add or select a server.' | translate}}</p>\n    </div>\n  </div>\n\n\n<form #opcuaConfigForm=\"ngForm\" class=\"d-contents\" *ngIf=\"server\">\n  <div class=\"card-header large-padding separator sticky-top visible-sm visible-xs\" >\n    <button\n    class=\"btn btn-clean text-primary visible-sm visible-xs\"\n    title=\"{{ 'Back' | translate }}\"\n    (click)=\"cancel()\"\n    >\n      <i c8yIcon=\"chevron-left\"></i>\n      <span translate>Back</span>\n    </button>\n  </div>\n  <div class=\"flex-grow\">\n  <div class=\"card-block large-padding\">\n    <!-- SERVER NAME -->\n    <c8y-form-group class=\"m-b-8\">\n      <label>\n        {{ 'Server name' | translate }}\n      </label>\n      <input\n        type=\"text\"\n        class=\"form-control\"\n        placeholder=\"{{ 'e.g. My server' | translate }}\"\n        id=\"name\"\n        name=\"name\"\n        [(ngModel)]=\"model.name\"\n        required\n      />\n      <c8y-messages>\n        <c8y-message name=\"required\" text=\"{{ 'Server name is required' | translate }}\"></c8y-message>\n      </c8y-messages>\n    </c8y-form-group>\n  </div>\n\n    <div class=\"card-block large-padding bg-gray-lighter\">\n      <div class=\"tight-grid\">\n        <div class=\"col-sm-6\">\n          <label style=\"width: 100%;\" translate>Server connection</label>\n          <button\n            type=\"button\"\n            class=\"btn m-t-4\"\n            name=\"serverConnection\"\n            [(ngModel)]=\"targetConnectionState\"\n            (ngModelChange)=\"setServerConnection($event)\"\n            btnCheckbox\n            btnCheckboxTrue=\"1\"\n            btnCheckboxFalse=\"0\"\n          >\n            <span\n              title=\"{{ 'Enabled' | translate }}\"\n              [hidden]=\"targetConnectionState !== '1'\"\n              translate\n              >Enabled</span\n            >\n            <span\n              title=\"{{ 'Disabled' | translate }}\"\n              [hidden]=\"targetConnectionState !== '0'\"\n              translate\n              >Disabled</span\n            >\n          </button>\n        </div>\n        <div class=\"col-sm-6\">\n          <label translate>Connection status</label>\n          <div class=\"form-control-static\">\n            <device-status class=\"p-r-8\" [mo]=\"server\"></device-status>\n            <span>{{ connectionStatusLabel | translate }}</span>\n          </div>\n        </div>\n      </div>\n    </div>\n    <div class=\"card-block large-padding\">\n      <!-- SERVER URL-->\n      <c8y-form-group>\n        <label for=\"configServerUrl\" translate>Server URL</label>\n        <input\n          type=\"text\"\n          class=\"form-control\"\n          id=\"configServerUrl\"\n          name=\"serverUrl\"\n          [(ngModel)]=\"model.config.serverUrl\"\n          c8yDefaultValidation=\"opcuaBrowsePath\"\n          required\n        />\n      </c8y-form-group>\n\n      <!-- TIMEOUT & STATUS-CHECK-INTERVAL-->\n      <div class=\"content-flex-32\">\n        <div class=\"col-6\">\n          <c8y-form-group>\n            <label for=\"config.timeout\" translate>Timeout</label>\n            <div class=\"input-group\">\n              <input\n                type=\"number\"\n                class=\"form-control\"\n                id=\"config.timeout\"\n                name=\"timeout\"\n                [min]=\"minIntervalNumber\"\n                placeholder=\"{{ 'e.g.' | translate }} 30\"\n                [(ngModel)]=\"model.config.timeout\"\n                required\n              />\n              <span class=\"input-group-addon units\" translate>\n                seconds\n              </span>\n            </div>\n          </c8y-form-group>\n        </div>\n        <div class=\"col-6\">\n          <c8y-form-group>\n            <label for=\"config.statusCheckInterval\" translate>Status check interval</label>\n            <div class=\"input-group\">\n              <input\n                type=\"number\"\n                class=\"form-control\"\n                id=\"config.statusCheckInterval\"\n                name=\"statusCheckInterval\"\n                [min]=\"minIntervalNumber\"\n                placeholder=\"{{ 'e.g.' | translate }} 40\"\n                [(ngModel)]=\"model.config.statusCheckInterval\"\n                required\n              />\n              <span class=\"input-group-addon units\" translate>\n                seconds\n              </span>\n            </div>\n          </c8y-form-group>\n        </div>\n      </div>\n\n      <!-- SECURITY MODE -->\n      <div class=\"tight-grid\">\n        <div class=\"col-md-6\">\n          <div class=\"form-group\">\n            <!-- NONE, SIGN, SIGN & ENCRYPT-->\n            <label for=\"config.securityMode\" translate>Security mode</label>\n            <div class=\"c8y-select-wrapper\">\n              <select\n                class=\"form-control\"\n                id=\"config.securityMode\"\n                [(ngModel)]=\"currentSecMode\"\n                (ngModelChange)=\"setPolicy($event)\"\n                name=\"securityMode\"\n                required\n              >\n                <option *ngFor=\"let mode of securityModes\" [ngValue]=\"mode\">{{ mode }}</option>\n              </select>\n              <span></span>\n            </div>\n          </div>\n        </div>\n        <div *ngIf=\"currentSecMode === NONE\" class=\"col-md-6\">\n          <div class=\"form-group\">\n            <label for=\"config.securityPolicy\" translate>Security policy</label>\n            <input\n              type=\"text\"\n              class=\"form-control\"\n              id=\"config.securityPolicy\"\n              name=\"securityPolicy\"\n              [readonly]=\"true\"\n              [(ngModel)]=\"model.config.securityMode\"\n              required\n            />\n          </div>\n        </div>\n        <div *ngIf=\"currentSecMode !== NONE\" class=\"col-md-6\">\n          <div class=\"form-group\">\n            <label for=\"config.securityPolicy\" translate>Security policy</label>\n            <div class=\"c8y-select-wrapper\">\n              <select\n                *ngIf=\"currentSecMode === SIGN\"\n                class=\"form-control\"\n                id=\"config.securityPolicy\"\n                [(ngModel)]=\"model.config.securityMode\"\n                name=\"securityPolicy\"\n                required\n              >\n                <option *ngFor=\"let policy of securityPolicies.sign\" [ngValue]=\"policy\">{{\n                  policy\n                }}</option>\n              </select>\n              <select\n                *ngIf=\"currentSecMode === SIGN_ENC\"\n                class=\"form-control\"\n                id=\"config.securityPolicy\"\n                [(ngModel)]=\"model.config.securityMode\"\n                name=\"securityPolicy\"\n                required\n              >\n                <option *ngFor=\"let policy of securityPolicies.sign_enc\" [ngValue]=\"policy\">{{\n                  policy\n                }}</option>\n              </select>\n              <span></span>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <!-- AUTHENTICATION -->\n      <div class=\"form-group\">\n        <label for=\"config.authenticationMode\" translate>Authentication</label>\n        <div class=\"c8y-select-wrapper\">\n          <select\n            class=\"form-control\"\n            id=\"config.authenticationMode\"\n            [(ngModel)]=\"authenticationMode\"\n            name=\"authenticationMode\"\n            (ngModelChange)=\"updateAuthentication($event)\"\n            required\n          >\n            <option *ngFor=\"let auth of authenticationModes\" [ngValue]=\"auth\">{{\n              auth.value | translate\n            }}</option>\n          </select>\n          <span></span>\n        </div>\n      </div>\n\n      <!-- User/Pw-->\n      <div *ngIf=\"authenticationMode.id === 2\" class=\"tight-grid\">\n        <div class=\"col-md-12\">\n          <div class=\"form-group\">\n            <label for=\"config.userName\" translate>Username</label>\n            <input\n              type=\"text\"\n              class=\"form-control\"\n              id=\"config.userName\"\n              name=\"userName\"\n              placeholder=\"{{ 'e.g. joe.doe`LOCALIZE`' | translate }}\"\n              [(ngModel)]=\"model.config.userName\"\n              autocomplete=\"new-password\"\n              required\n            />\n          </div>\n        </div>\n        <!-- change password section BEGINS-->\n        <div class=\"col-md-6\">\n          <div class=\"form-group\" *ngIf=\"!initialPasswordRequired\">\n            <button type=\"button\" class=\"btn btn-default\" (click)=\"toggleChangePassword()\">\n              <ng-container *ngIf=\"!changePassword\">\n                {{ 'Change password' | translate }}\n              </ng-container>\n              <ng-container *ngIf=\"changePassword\">\n                {{ 'Cancel password change' | translate }}\n              </ng-container>\n            </button>\n          </div>\n\n          <div class=\"form-group\">\n            <div *ngIf=\"changePassword\">\n              <label for=\"config.password\" translate>Password</label>\n              <input\n                type=\"password\"\n                class=\"form-control\"\n                id=\"config.userPassword\"\n                name=\"password\"\n                [(ngModel)]=\"model.config.userPassword\"\n                autocomplete=\"new-password\"\n                required\n              />\n            </div>\n          </div>\n        </div>\n        <!-- change password section ENDS-->\n      </div>\n      <!-- Key-based -->\n      <div *ngIf=\"authenticationMode.id === 3\" class=\"tight-grid\">\n        <!-- KEYSTORE PASSWORD -->\n        <div class=\"col-md-6\">\n          <div class=\"form-group\">\n            <label for=\"config.keystorePass\" translate>Keystore password</label>\n            <input\n              type=\"password\"\n              class=\"form-control\"\n              id=\"config.keystorePass\"\n              name=\"keystorePass\"\n              [(ngModel)]=\"model.config.keystorePass\"\n              required\n            />\n          </div>\n        </div>\n        <div class=\"col-md-6\">\n          <div class=\"form-group\">\n            <label for=\"config.certificatePass\" translate>Certificate password</label>\n            <input\n              type=\"password\"\n              class=\"form-control\"\n              id=\"config.certificatePass\"\n              name=\"keystorePass\"\n              [(ngModel)]=\"model.config.certificatePass\"\n              required\n            />\n          </div>\n        </div>\n        <!-- UPLOAD KEYSTORE -->\n        <div class=\"col-md-12\">\n          <div class=\"form-group\">\n            <label for=\"certificateUpload\" translate>Upload keystore</label>\n            <input\n              type=\"text\"\n              [readonly]=\"true\"\n              name=\"certificateUpload\"\n              class=\"form-control m-b-8\"\n              [ngModel]=\"fileName\"\n              placeholder=\"{{ 'e.g.' | translate }} yourKeystore.jks\"\n              required\n            />\n            <c8y-drop-area\n              (dropped)=\"uploadFile($event)\"\n              [loadingMessage]=\"'Importing, please wait.' | translate\"\n              [title]=\"'Import keystore with jks file extension' | translate\"\n            >\n            </c8y-drop-area>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class=\"card-footer large-padding separator sticky-bottom\">\n    <button title=\"{{ 'Cancel' | translate }}\" class=\"btn btn-default\" (click)=\"cancel()\" translate>\n      Cancel\n    </button>\n    <button title=\"{{ 'Remove' | translate }}\" class=\"btn btn-danger\" (click)=\"remove()\" translate>\n      Remove\n    </button>\n    <!-- Add [disabled]=\"method()\" when form is invalid-->\n    <button\n      title=\"{{ 'Save' | translate }}\"\n      class=\"btn btn-primary\"\n      (click)=\"save()\"\n      [disabled]=\"!opcuaConfigForm.valid\"\n      translate\n    >\n      Save\n    </button>\n  </div> \n</form>\n"
            },] }
];
OpcuaServerConfigComponent.ctorParameters = () => [
    { type: OpcuaService }
];
OpcuaServerConfigComponent.propDecorators = {
    opcuaConfigForm: [{ type: ViewChild, args: ['opcuaConfigForm', { static: false },] }],
    dropArea: [{ type: ViewChild, args: [DropAreaComponent, { static: false },] }],
    canceled: [{ type: Output }],
    removed: [{ type: Output }],
    saved: [{ type: Output }],
    server: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtc2VydmVyLWNvbmZpZy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9wcm90b2NvbC1vcGN1YS9vcGN1YS1zZXJ2ZXItY29uZmlnLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQVUsTUFBTSxFQUFFLFlBQVksRUFBYSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDckcsT0FBTyxFQUFFLE9BQU8sRUFBZSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRTlFLE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFDLE1BQU0sV0FBVyxDQUFDO0FBQzFDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQU05QyxNQUFNLE9BQU8sMEJBQTBCO0lBOEVyQyxZQUFZLFlBQTBCO1FBNUV0QyxhQUFRLEdBQVcsRUFBRSxDQUFDO1FBQ3RCLDBCQUFxQixHQUFXLEdBQUcsQ0FBQztRQUNwQyxzQkFBaUIsR0FBVyxDQUFDLENBQUM7UUFDOUIsMEJBQXFCLEdBQVcsRUFBRSxDQUFDO1FBR3pCLGFBQVEsR0FBRyxJQUFJLFlBQVksRUFBZSxDQUFDO1FBQzNDLFlBQU8sR0FBRyxJQUFJLFlBQVksRUFBZSxDQUFDO1FBQzFDLFVBQUssR0FBRyxJQUFJLFlBQVksRUFBZSxDQUFDO1FBd0JsRCxtQkFBYyxHQUFZLEtBQUssQ0FBQztRQUNoQyw0QkFBdUIsR0FBWSxJQUFJLENBQUM7UUFJeEMsU0FBSSxHQUFXLE1BQU0sQ0FBQztRQUN0QixTQUFJLEdBQVcsTUFBTSxDQUFDO1FBQ3RCLGFBQVEsR0FBVyxjQUFjLENBQUM7UUFDbEMscUJBQWdCLEdBQVE7WUFDdEIsSUFBSSxFQUFFO2dCQUNKLFlBQVksSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDdkIsaUJBQWlCLElBQUksQ0FBQyxJQUFJLEVBQUU7Z0JBQzVCLGtCQUFr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QUFJLENBQUMsU0FBUyxDQUFDO2dCQUN6QyxNQUFNO1lBRVI7Z0JBQ0UsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7Z0JBQ3RDLE1BQU07U0FDVDtJQUNILENBQUM7SUFFTyxjQUFjLENBQUMsUUFBZ0I7UUFDckMsSUFBSSxJQUFJLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQ25DLElBQUksUUFBUSxJQUFJLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUNuQyxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7YUFDeEY7U0FDRjtRQUNELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7OztZQTNWRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLHFCQUFxQjtnQkFDL0IsMnNZQUFtRDthQUNwRDs7O1lBTFEsWUFBWTs7OzhCQVlsQixTQUFTLFNBQUMsaUJBQWlCLEVBQUUsRUFBQyxNQUFNLEVBQUUsS0FBSyxFQUFDO3VCQUM1QyxTQUFTLFNBQUMsaUJBQWlCLEVBQUUsRUFBQyxNQUFNLEVBQUUsS0FBSyxFQUFDO3VCQUM1QyxNQUFNO3NCQUNOLE1BQU07b0JBQ04sTUFBTTtxQkFDTixLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT25Jbml0LCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgT25DaGFuZ2VzLCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGdldHRleHQsIERyb3BwZWRGaWxlLCBEcm9wQXJlYUNvbXBvbmVudCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgT3BjdWFTZXJ2ZXIsIE9wY3VhU2VydmVyQ29uZmlnIH0gZnJvbSAnLi9vcGN1YS1zZXJ2ZXIuaW50ZXJmYWNlJztcbmltcG9ydCB7IGNsb25lRGVlcCwgaGFzfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgT3BjdWFTZXJ2aWNlIH0gZnJvbSAnLi9vcGN1YVNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdvcGN1YS1zZXJ2ZXItY29uZmlnJyxcbiAgdGVtcGxhdGVVcmw6ICcuL29wY3VhLXNlcnZlci1jb25maWcuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIE9wY3VhU2VydmVyQ29uZmlnQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMge1xuICBjdXJyZW50U2VjTW9kZTogc3RyaW5nO1xuICBmaWxlTmFtZTogc3RyaW5nID0gJyc7XG4gIHRhcmdldENvbm5lY3Rpb25TdGF0ZTogc3RyaW5nID0gJzEnO1xuICBtaW5JbnRlcnZhbE51bWJlcjogbnVtYmVyID0gMTtcbiAgY29ubmVjdGlvblN0YXR1c0xhYmVsOiBzdHJpbmcgPSAnJztcbiAgQFZpZXdDaGlsZCgnb3BjdWFDb25maWdGb3JtJywge3N0YXRpYzogZmFsc2V9KSBvcGN1YUNvbmZpZ0Zvcm06IGFueTtcbiAgQFZpZXdDaGlsZChEcm9wQXJlYUNvbXBvbmVudCwge3N0YXRpYzogZmFsc2V9KSBkcm9wQXJlYTogRHJvcEFyZWFDb21wb25lbnQ7XG4gIEBPdXRwdXQoKSBjYW5jZWxlZCA9IG5ldyBFdmVudEVtaXR0ZXI8T3BjdWFTZXJ2ZXI+KCk7XG4gIEBPdXRwdXQoKSByZW1vdmVkID0gbmV3IEV2ZW50RW1pdHRlcjxPcGN1YVNlcnZlcj4oKTtcbiAgQE91dHB1dCgpIHNhdmVkID0gbmV3IEV2ZW50RW1pdHRlcjxPcGN1YVNlcnZlcj4oKTtcbiAgQElucHV0KCkgc2V0IHNlcnZlcihzZXJ2ZXI6IE9wY3VhU2VydmVyKSB7XG4gICAgaWYgKHNlcnZlcikge1xuICAgICAgdGhpcy5fc2VydmVyID0gY2xvbmVEZWVwKHNlcnZlcik7XG4gICAgICB0aGlzLm1vZGVsID0gY2xvbmVEZWVwKHNlcnZlcik7XG4gICAgICB0aGlzLmZpbGVOYW1lID0gdGhpcy5tb2RlbC5jb25maWcua2V5c3RvcmVGaWxlbmFtZTtcblxuICAgICAgaWYgKHNlcnZlci5pZCAmJiBzZXJ2ZXIuaWQgPT09ICduZXcnKSB7XG4gICAgICAgIC8vIGVuYWJsZWQgY29ubmVjdGlvbiBzdGF0ZVxuICAgICAgICB0aGlzLnRhcmdldENvbm5lY3Rpb25TdGF0ZSA9ICcxJztcbiAgICAgICAgdGhpcy5tb2RlbC5jb25maWcudGFyZ2V0Q29ubmVjdGlvblN0YXRlID0gJ2VuYWJsZWQnO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy50YXJnZXRDb25uZWN0aW9uU3RhdGUgPSAodGhpcy5tb2RlbC5jb25maWcudGFyZ2V0Q29ubmVjdGlvblN0YXRlID09PSAnZW5hYmxlZCcpID8gJzEnIDogJzAnO1xuICAgICAgfVxuICAgICAgdGhpcy51cGRhdGVDb25uZWN0aW9uU3RhdHVzTGFiZWwodGhpcy5fc2VydmVyKTtcbiAgICAgIHRoaXMuc2V0TmV3UGFzc3dvcmQoKTtcbiAgICB9XG4gIH1cblxuICBnZXQgc2VydmVyKCk6IE9wY3VhU2VydmVyIHtcbiAgICByZXR1cm4gdGhpcy5fc2VydmVyO1xuICB9XG5cbiAgbW9kZWw6IE9wY3VhU2VydmVyO1xuICBjaGFuZ2VQYXNzd29yZDogYm9vbGVhbiA9IGZhbHNlO1xuICBpbml0aWFsUGFzc3dvcmRSZXF1aXJlZDogYm9vbGVhbiA9IHRydWU7XG4gIHNlY3VyaXR5TW9kZXM6IHN0cmluZ1tdO1xuICBhdXRoZW50aWNhdGlvbk1vZGU6IGFueTtcbiAgYXV0aGVudGljYXRpb25Nb2RlczogYW55W107XG4gIE5PTkU6IHN0cmluZyA9ICdOT05FJztcbiAgU0lHTjogc3RyaW5nID0gJ1NJR04nO1xuICBTSUdOX0VOQzogc3RyaW5nID0gJ1NJR05fRU5DUllQVCc7XG4gIHNlY3VyaXR5UG9saWNpZXM6IGFueSA9IHtcbiAgICBzaWduOiBbXG4gICAgICBgQkFTSUMyNTZfJHt0aGlzLlNJR059YCxcbiAgICAgIGBCQVNJQzEyOFJTQTE1XyR7dGhpcy5TSUdOfWAsXG4gICAgICBgQkFTSUMyNTZTSEEyNTZfJHt0aGlzLlNJR059YFxuICAgIF0sXG4gICAgc2lnbl9lbmM6IFtcbiAgICAgIGBCQVNJQzI1Nl8ke3RoaXMuU0lHTl9FTkN9YCxcbiAgICAgIGBCQVNJQzEyOFJTQTE1XyR7dGhpcy5TSUdOX0VOQ31gLFxuICAgICAgYEJBU0lDMjU2U0hBMjU2XyR7dGhpcy5TSUdOX0VOQ31gLFxuICAgIF1cbiAgfTtcbiAgcHJpdmF0ZSBBTk9OWU0gPSB7XG4gICAgaWQ6IDEsXG4gICAgdmFsdWU6IGdldHRleHQoJ0Fub255bW91cycpXG4gIH07XG4gIHByaXZhdGUgVVNFUl9QQVNTV09SRCA9IHtcbiAgICBpZDogMixcbiAgICB2YWx1ZTogZ2V0dGV4dCgnVXNlcm5hbWUvUGFzc3dvcmQnKVxuICB9O1xuICBwcml2YXRlIEtFWV9CQVNFRCA9IHtcbiAgICBpZDogMyxcbiAgICB2YWx1ZTogZ2V0dGV4dCgnS2V5LWJhc2VkIEF1dGhlbnRpY2F0aW9uJylcbiAgfTtcbiAgcHJpdmF0ZSBfc2VydmVyOiBPcGN1YVNlcnZlcjtcbiAgcHJpdmF0ZSBvcGN1YVNlcnZpY2U6IE9wY3VhU2VydmljZTtcbiAgcHJpdmF0ZSBpbml0aWFsS2V5c3RvcmUgPSB7XG4gICAgbGFzdE1vZGlmaWVkOiAwLFxuICAgIG5hbWU6ICcnLFxuICAgIHR5cGU6ICcnLFxuICAgIHNsaWNlOiBudWxsLFxuICAgIHNpemU6IDBcbiAgfSBhcyBGaWxlO1xuICBwcml2YXRlIGtleXN0b3JlOiBGaWxlID0gdGhpcy5pbml0aWFsS2V5c3RvcmU7XG4gIHByaXZhdGUgYXV0aFN3aXRjaDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKG9wY3VhU2VydmljZTogT3BjdWFTZXJ2aWNlKSB7XG4gICAgdGhpcy5vcGN1YVNlcnZpY2UgPSBvcGN1YVNlcnZpY2U7XG4gIH1cblxuICBhc3luYyBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmF1dGhTd2l0Y2ggPSBmYWxzZTtcblxuICAgIHRoaXMuc2VjdXJpdHlNb2RlcyA9IFtcbiAgICAgIHRoaXMuTk9ORSxcbiAgICAgIHRoaXMuU0lHTixcbiAgICAgIHRoaXMuU0lHTl9FTkNcbiAgICBdO1xuXG4gICAgdGhpcy5hdXRoZW50aWNhdGlvbk1vZGVzID0gW1xuICAgICAgdGhpcy5BTk9OWU0sXG4gICAgICB0aGlzLlVTRVJfUEFTU1dPUkQsXG4gICAgICB0aGlzLktFWV9CQVNFRFxuICAgIF07XG5cbiAgICB0aGlzLnNldEN1cnJlbnRBdXRoZW50aWNhdGlvbk1vZGUoKTtcbiAgICB0aGlzLnNldEN1cnJlbnRTZWN1cml0eU1vZGUoKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKCkge1xuICAgIHRoaXMuc2V0Q3VycmVudFNlY3VyaXR5TW9kZSgpO1xuICAgIHRoaXMuc2V0Q3VycmVudEF1dGhlbnRpY2F0aW9uTW9kZSgpO1xuICB9XG5cbiAgY2FuY2VsKCkge1xuICAgIHRoaXMuY2FuY2VsZWQuZW1pdCh0aGlzLm1vZGVsKTtcbiAgICB0aGlzLl9zZXJ2ZXIgPSBudWxsO1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlKCkge1xuICAgIGF3YWl0IHRoaXMucmVtb3ZlS2V5c3RvcmUodGhpcy5tb2RlbCk7XG4gICAgdGhpcy5yZW1vdmVkLmVtaXQodGhpcy5tb2RlbCk7XG4gICAgdGhpcy5fc2VydmVyID0gbnVsbDtcbiAgfVxuXG4gIGFzeW5jIHNhdmUoKSB7XG4gICAgaWYgKHRoaXMua2V5c3RvcmUgJiYgdGhpcy5rZXlzdG9yZS5zaXplID4gMCAmJiB0aGlzLmtleXN0b3JlLm5hbWUgJiYgdGhpcy5rZXlzdG9yZS5uYW1lLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy51cGxvYWRLZXlzdG9yZSh0aGlzLm1vZGVsLmNvbmZpZy5rZXlzdG9yZUJpbmFyeUlkKTtcblxuICAgICAgaWYgKHJlc3BvbnNlICYmIHJlc3BvbnNlLmRhdGEgJiYgcmVzcG9uc2UuZGF0YS5pZCkge1xuICAgICAgICB0aGlzLm1vZGVsLmNvbmZpZy5rZXlzdG9yZUJpbmFyeUlkID0gcmVzcG9uc2UuZGF0YS5pZDtcbiAgICAgIH1cblxuICAgICAgLy8gaWYgdGhlIGtleXN0b3JlIHdhcyB1cGxvYWRlZCBzdWNjZXNzZnVsIHdlIGNhbiByZW1vdmVcbiAgICAgIC8vIHRoZSBsb2NhbCBrZXlzdG9yZS4gVGhpcyB3aWxsIHByZXZlbnQgYW5vdGhlciByZXF1ZXN0IHRvIGJpbmFyeSBhcGlcbiAgICAgIC8vIHdoZW4gdGhlIHVzZXIgd2lsbCBlZGl0IG90aGVyIGlucHV0cyBpbiB0aGUgZm9ybSBhbmQgaGl0IHNhdmUgYWdhaW4uXG4gICAgICB0aGlzLmtleXN0b3JlID0gdGhpcy5pbml0aWFsS2V5c3RvcmU7XG4gICAgfVxuXG4gICAgLy8gd2lsbCByZW1vdmUga2V5c3RvcmUgKGJpbmFyeSkgd2hlbiB0aGUgdXNlciBzd2l0Y2hlZFxuICAgIC8vIGF1dGhlbnRpY2F0aW9uIHNldHRpbmdzIGZyb20ga2V5LWJhc2VkIHRvIGFub255bW91cyBvciB1c2VybmFtZS9wYXNzd29yZFxuICAgIGlmICh0aGlzLmF1dGhTd2l0Y2gpIHtcbiAgICAgIHRoaXMucmVtb3ZlS2V5c3RvcmUodGhpcy5zZXJ2ZXIpO1xuICAgIH1cblxuICAgIC8vIHdoZW4gdGhlIHVzZXIgc2V0cyBhIG5ldyBwYXNzd29yZCwgbWFrZSBzdXJlIHRvIG1hcmsgaXQgYXNcbiAgICAvLyBcIm5vdCBlbmNyeXB0ZWRcIiBieSBzZXR0aW5nIHBhc3N3b3JkRW5jcnlwdGVkIHRvIGZhbHNlXG4gICAgY29uc3QgdXNlclBhc3N3b3JkOiBzdHJpbmcgPSB0aGlzLmdldE1vZGVsQ29uZmlnKCd1c2VyUGFzc3dvcmQnKTtcbiAgICBpZiAodXNlclBhc3N3b3JkICYmIHVzZXJQYXNzd29yZC5sZW5ndGggPiAwKSB7XG4gICAgICAgIHRoaXMubW9kZWwuY29uZmlnLnBhc3N3b3JkRW5jcnlwdGVkID0gZmFsc2U7XG4gICAgfVxuXG4gICAgdGhpcy5zYXZlZC5lbWl0KHRoaXMubW9kZWwpO1xuICB9XG5cbiAgdXBsb2FkRmlsZShkcm9wcGVkRmlsZXM6IERyb3BwZWRGaWxlW10pIHtcbiAgICBpZiAoZHJvcHBlZEZpbGVzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgdGhpcy5rZXlzdG9yZSA9IGRyb3BwZWRGaWxlc1swXS5maWxlO1xuICAgICAgdGhpcy5maWxlTmFtZSA9IHRoaXMua2V5c3RvcmUubmFtZTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gZHJvcHBlZCBtb3JlIHRoYW4gb25lIGZpbGVcbiAgICAgIGNvbnNvbGUud2FybignVHJpZWQgdG8gaW1wb3J0Li4uIEltcG9ydCBhYm9ydGVkLicpO1xuICAgIH1cbiAgfVxuXG4gIHNldFBvbGljeShkYXRhOiBhbnkpIHtcbiAgICBpZiAoZGF0YSA9PT0gdGhpcy5OT05FKSB7XG4gICAgICB0aGlzLm1vZGVsLmNvbmZpZy5zZWN1cml0eU1vZGUgPSB0aGlzLk5PTkU7XG4gICAgfSBlbHNlIGlmIChkYXRhID09PSB0aGlzLlNJR04pIHtcbiAgICAgIHRoaXMubW9kZWwuY29uZmlnLnNlY3VyaXR5TW9kZSA9IHRoaXMuc2VjdXJpdHlQb2xpY2llcy5zaWduWzBdO1xuICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gdGhpcy5TSUdOX0VOQykge1xuICAgICAgdGhpcy5tb2RlbC5jb25maWcuc2VjdXJpdHlNb2RlID0gdGhpcy5zZWN1cml0eVBvbGljaWVzLnNpZ25fZW5jWzBdO1xuICAgIH1cbiAgfVxuXG4gIHNldFNlcnZlckNvbm5lY3Rpb24oZGF0YTogc3RyaW5nKSB7XG4gICAgdGhpcy5tb2RlbC5jb25maWcudGFyZ2V0Q29ubmVjdGlvblN0YXRlID0gKGRhdGEgIT09ICcwJykgPyAnZW5hYmxlZCcgOiAnZGlzYWJsZWQnO1xuICB9XG5cbiAgdXBkYXRlQXV0aGVudGljYXRpb24oZGF0YTogYW55KSB7XG4gICAgaWYgKGRhdGEgJiYgZGF0YS5pZCkge1xuICAgICAgc3dpdGNoIChkYXRhLmlkKSB7XG4gICAgICAgIC8vIEFub255bW91c1xuICAgICAgICBjYXNlIDE6XG4gICAgICAgICAgdGhpcy5yZXNldFVzZXJBdXRoZW50aWNhdGlvbigpO1xuICAgICAgICAgIHRoaXMucmVzZXRLZXlCYXNlZEF1dGhlbnRpY2F0aW9uKCk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgLy8gVXNlci9QYXNzd29yZFxuICAgICAgICBjYXNlIDI6XG4gICAgICAgICAgdGhpcy5yZXNldEtleUJhc2VkQXV0aGVudGljYXRpb24oKTtcbiAgICAgICAgICB0aGlzLnJlc3RvcmVVc2VyRGF0YSgpO1xuICAgICAgICAgIHRoaXMuc2V0TmV3UGFzc3dvcmQoKTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICAvLyBLZXktYmFzZWRcbiAgICAgICAgY2FzZSAzOlxuICAgICAgICAgIHRoaXMucmVzZXRVc2VyQXV0aGVudGljYXRpb24oKTtcbiAgICAgICAgICB0aGlzLnJlc3RvcmVLZXlCYXNlZERhdGEoKTtcbiAgICAgICAgICBicmVhaztcblxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIGNvbnNvbGUud2FybignSW52YWxpZCBhdXRoZW50aWNhdGlvbiBpZCcsIGRhdGEuaWQpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHVwZGF0ZUNvbm5lY3Rpb25TdGF0dXNMYWJlbChzZXJ2ZXIpIHtcbiAgICBjb25zdCBjb25uZWN0ZWQgPSBzZXJ2ZXIuYzh5X0Nvbm5lY3Rpb24gJiYgc2VydmVyLmM4eV9Db25uZWN0aW9uLnN0YXR1cyA9PT0gJ0NPTk5FQ1RFRCc7XG4gICAgY29uc3QgbGFiZWwgPSBjb25uZWN0ZWQgPyBnZXR0ZXh0KCdDb25uZWN0ZWQnKSA6IGdldHRleHQoJ0Rpc2Nvbm5lY3RlZCcpO1xuICAgIHRoaXMuY29ubmVjdGlvblN0YXR1c0xhYmVsID0gbGFiZWw7XG4gIH1cblxuICBzZXROZXdQYXNzd29yZCgpIHtcbiAgICBjb25zdCB1c2VybmFtZTogc3RyaW5nID0gdGhpcy5nZXRNb2RlbENvbmZpZygndXNlck5hbWUnKTtcbiAgICBpZiAodXNlcm5hbWUgJiYgdXNlcm5hbWUubGVuZ3RoID4gMCkge1xuICAgICAgLy8gdXNlck5hbWUgaXMgZ2l2ZW4sIE5PIG5lZWQgdG8gY2hhbmdlIHRoZSBwYXNzd29yZCBiZWNhdXNlIGl0IGlzIGFscmVhZHkgc2V0XG4gICAgICB0aGlzLmNoYW5nZVBhc3N3b3JkID0gZmFsc2U7XG4gICAgICB0aGlzLmluaXRpYWxQYXNzd29yZFJlcXVpcmVkID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIG5vIHVzZXJOYW1lIGluIHJlc3BvbnNlLCBzbyByZXF1aXJlIHRoZSB1c2VyIHRvIHNldCB0aGUgaW5pdGlhbCBwd1xuICAgICAgdGhpcy5jaGFuZ2VQYXNzd29yZCA9IHRydWU7XG4gICAgICB0aGlzLmluaXRpYWxQYXNzd29yZFJlcXVpcmVkID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICB0b2dnbGVDaGFuZ2VQYXNzd29yZCgpIHtcbiAgICB0aGlzLmNoYW5nZVBhc3N3b3JkID0gIXRoaXMuY2hhbmdlUGFzc3dvcmQ7XG4gICAgLy8gV2hlbiB0aGUgdXNlciBoaWRlcyB0aGUgcHctaW5wdXQgZmllbGQgYnV0IGhhcyBlbnRlcmVkIGFcbiAgICAvLyBzdHJpbmcgdG8gaXQgYmVmb3JlLCB3ZSBuZWVkIHRvIGRpc2NhcmQgdGhlIGNoYW5nZXMgcmVmbGVjdGVkIGluIHRoZSBtb2RlbFxuICAgIC8vIG90aGVyd2lzZSB3ZSBQVVQgaXQgd2l0aCB0aGUgbW9kZWwgd2hlbiB1c2VyIGhpdHMgdGhlIHNhdmUgYnV0dG9uXG4gICAgaWYgKCF0aGlzLmNoYW5nZVBhc3N3b3JkKSB7XG4gICAgICBpZiAodGhpcy5nZXRNb2RlbENvbmZpZygndXNlclBhc3N3b3JkJykpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMubW9kZWwuY29uZmlnLnVzZXJQYXNzd29yZDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwbG9hZEtleXN0b3JlKGJpbmFyeUlkPzogc3RyaW5nKSB7XG4gICAgaWYgKCFiaW5hcnlJZCkge1xuICAgICAgcmV0dXJuIHRoaXMub3BjdWFTZXJ2aWNlLnVwbG9hZEtleXN0b3JlKHRoaXMua2V5c3RvcmUpO1xuICAgIH0gZWxzZSBpZiAoYmluYXJ5SWQgJiYgYmluYXJ5SWQubGVuZ3RoID4gMCkge1xuICAgICAgLy8gdXBkYXRlIGV4aXN0aW5nIGJpbmFyeVxuICAgICAgcmV0dXJuIHRoaXMub3BjdWFTZXJ2aWNlLnVwZGF0ZUtleXN0b3JlKGJpbmFyeUlkLCB0aGlzLmtleXN0b3JlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUtleXN0b3JlKHNlcnZlcjogT3BjdWFTZXJ2ZXIpIHtcbiAgICBpZiAoc2VydmVyICYmXG4gICAgICBzZXJ2ZXIuY29uZmlnICYmXG4gICAgICBzZXJ2ZXIuY29uZmlnLmtleXN0b3JlQmluYXJ5SWQgJiZcbiAgICAgIHNlcnZlci5jb25maWcua2V5c3RvcmVCaW5hcnlJZC5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLmF1dGhTd2l0Y2ggPSBmYWxzZTtcbiAgICAgIHJldHVybiB0aGlzLm9wY3VhU2VydmljZS5yZW1vdmVLZXlzdG9yZSh0aGlzLnNlcnZlci5jb25maWcua2V5c3RvcmVCaW5hcnlJZCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZXNldFVzZXJBdXRoZW50aWNhdGlvbigpIHtcbiAgICB0aGlzLm1vZGVsLmNvbmZpZy51c2VyTmFtZSA9IG51bGw7XG4gICAgdGhpcy5tb2RlbC5jb25maWcudXNlclBhc3N3b3JkID0gbnVsbDtcbiAgICB0aGlzLm1vZGVsLmNvbmZpZy51c2VySWRlbnRpdHlNb2RlID0gJ25vbmUnO1xuICB9XG5cbiAgcHJpdmF0ZSByZXNldEtleUJhc2VkQXV0aGVudGljYXRpb24oKSB7XG4gICAgdGhpcy5hdXRoU3dpdGNoID0gdHJ1ZTtcblxuICAgIHRoaXMubW9kZWwuY29uZmlnLmtleXN0b3JlUGFzcyA9IG51bGw7XG4gICAgdGhpcy5tb2RlbC5jb25maWcuY2VydGlmaWNhdGVQYXNzID0gbnVsbDtcbiAgICB0aGlzLm1vZGVsLmNvbmZpZy5rZXlzdG9yZUJpbmFyeUlkID0gJyc7XG4gICAgdGhpcy5tb2RlbC5jb25maWcua2V5c3RvcmVGaWxlbmFtZSA9ICcnO1xuICAgIHRoaXMubW9kZWwuY29uZmlnLnVzZXJJZGVudGl0eU1vZGUgPSAnbm9uZSc7XG4gIH1cblxuICBwcml2YXRlIHJlc3RvcmVVc2VyRGF0YSgpIHtcbiAgICB0aGlzLm1vZGVsLmNvbmZpZy51c2VyTmFtZSA9IHRoaXMuX3NlcnZlci5jb25maWcudXNlck5hbWU7XG4gICAgdGhpcy5tb2RlbC5jb25maWcudXNlcklkZW50aXR5TW9kZSA9ICd1c2VyQW5kUGFzc3dvcmQnO1xuICB9XG5cbiAgcHJpdmF0ZSByZXN0b3JlS2V5QmFzZWREYXRhKCkge1xuICAgIHRoaXMuYXV0aFN3aXRjaCA9IGZhbHNlO1xuICAgIHRoaXMubW9kZWwuY29uZmlnLmtleXN0b3JlUGFzcyA9IHRoaXMuX3NlcnZlci5jb25maWcua2V5c3RvcmVQYXNzO1xuICAgIHRoaXMubW9kZWwuY29uZmlnLmNlcnRpZmljYXRlUGFzcyA9IHRoaXMuX3NlcnZlci5jb25maWcuY2VydGlmaWNhdGVQYXNzO1xuICAgIHRoaXMubW9kZWwuY29uZmlnLmtleXN0b3JlQmluYXJ5SWQgPSB0aGlzLl9zZXJ2ZXIuY29uZmlnLmtleXN0b3JlQmluYXJ5SWQ7XG4gICAgdGhpcy5tb2RlbC5jb25maWcua2V5c3RvcmVGaWxlbmFtZSA9IHRoaXMuX3NlcnZlci5jb25maWcua2V5c3RvcmVGaWxlbmFtZTtcbiAgICB0aGlzLm1vZGVsLmNvbmZpZy51c2VySWRlbnRpdHlNb2RlID0gJ2NlcnRpZmljYXRlJztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U2VydmVyQ29uZmlnKCk6IE9wY3VhU2VydmVyQ29uZmlnIHtcbiAgICBsZXQgY2ZnOiBPcGN1YVNlcnZlckNvbmZpZyA9IHtcbiAgICAgIHNlY3VyaXR5TW9kZTogdGhpcy5OT05FLFxuICAgICAgdXNlcklkZW50aXR5TW9kZTogJ25vbmUnXG4gICAgfTtcbiAgICBpZiAodGhpcy5zZXJ2ZXIgJiYgdGhpcy5zZXJ2ZXIuY29uZmlnKSB7XG4gICAgICBjZmcgPSB0aGlzLnNlcnZlci5jb25maWc7XG4gICAgfVxuICAgIHJldHVybiBjZmc7XG4gIH1cblxuICBwcml2YXRlIHNldEN1cnJlbnRTZWN1cml0eU1vZGUoKSB7XG4gICAgY29uc3QgeyBzZWN1cml0eU1vZGUgfSA9IHRoaXMuZ2V0U2VydmVyQ29uZmlnKCk7XG4gICAgaWYgKHNlY3VyaXR5TW9kZSkge1xuICAgICAgY29uc3QgZm91bmRJblNpZ24gPSB0aGlzLnNlY3VyaXR5UG9saWNpZXMuc2lnbi5maW5kKChlbCkgPT4gZWwgPT09IHNlY3VyaXR5TW9kZSk7XG4gICAgICBpZiAoZm91bmRJblNpZ24pIHtcbiAgICAgICAgdGhpcy5jdXJyZW50U2VjTW9kZSA9IHRoaXMuU0lHTjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGZvdW5kSW5TaWduRW5jcnlwdCA9IHRoaXMuc2VjdXJpdHlQb2xpY2llcy5zaWduX2VuYy5maW5kKChlbCkgPT4gZWwgPT09IHNlY3VyaXR5TW9kZSk7XG4gICAgICAgIGZvdW5kSW5TaWduRW5jcnlwdCA/IHRoaXMuY3VycmVudFNlY01vZGUgPSB0aGlzLlNJR05fRU5DIDogdGhpcy5jdXJyZW50U2VjTW9kZSA9IHRoaXMuTk9ORTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHNldEN1cnJlbnRBdXRoZW50aWNhdGlvbk1vZGUoKSB7XG4gICAgY29uc3Qge1xuICAgICAgdXNlcklkZW50aXR5TW9kZVxuICAgIH0gPSB0aGlzLmdldFNlcnZlckNvbmZpZygpO1xuXG4gICAgc3dpdGNoICh1c2VySWRlbnRpdHlNb2RlKSB7XG4gICAgICBjYXNlICdjZXJ0aWZpY2F0ZSc6XG4gICAgICAgIHRoaXMuYXV0aGVudGljYXRpb25Nb2RlID0gdGhpcy5LRVlfQkFTRUQ7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlICd1c2VyQW5kUGFzc3dvcmQnOlxuICAgICAgICB0aGlzLmF1dGhlbnRpY2F0aW9uTW9kZSA9IHRoaXMuVVNFUl9QQVNTV09SRDtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ0Fub255bW91cyc6XG4gICAgICAgIHRoaXMuYXV0aGVudGljYXRpb25Nb2RlID0gdGhpcy5BTk9OWU07XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlICdVc2VyTmFtZSc6XG4gICAgICAgIHRoaXMuYXV0aGVudGljYXRpb25Nb2RlID0gdGhpcy5VU0VSX1BBU1NXT1JEO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnQ2VydGlmaWNhdGUnOlxuICAgICAgICB0aGlzLmF1dGhlbnRpY2F0aW9uTW9kZSA9IHRoaXMuS0VZX0JBU0VEO1xuICAgICAgICBicmVhaztcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhpcy5hdXRoZW50aWNhdGlvbk1vZGUgPSB0aGlzLkFOT05ZTTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRNb2RlbENvbmZpZyhmcmFnbWVudDogc3RyaW5nKSB7XG4gICAgaWYgKHRoaXMubW9kZWwgJiYgdGhpcy5tb2RlbC5jb25maWcpIHtcbiAgICAgIGlmIChmcmFnbWVudCAmJiBmcmFnbWVudC5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJldHVybiBoYXModGhpcy5tb2RlbC5jb25maWcsIGZyYWdtZW50KSA/IHRoaXMubW9kZWwuY29uZmlnW2Ake2ZyYWdtZW50fWBdIDogdW5kZWZpbmVkO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG59XG4iXX0=