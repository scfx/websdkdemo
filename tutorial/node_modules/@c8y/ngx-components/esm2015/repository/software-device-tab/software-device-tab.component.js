import { __awaiter } from "tslib";
import { Component } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { BehaviorSubject } from 'rxjs';
import { map, switchMap } from 'rxjs/operators';
import { InventoryService, OperationStatus } from '@c8y/client';
import { RepositoryType } from '../repository.model';
import { RepositoryService } from '../repository.service';
import { AdvancedSoftwareService } from './advanced-software.service';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/router';
import * as ɵngcc2 from '../repository.service';
import * as ɵngcc3 from '@c8y/client';
import * as ɵngcc4 from './advanced-software.service';
import * as ɵngcc5 from '@c8y/ngx-components';
import * as ɵngcc6 from '@angular/common';
import * as ɵngcc7 from './installed-software.component';
import * as ɵngcc8 from './device-software-changes.component';

const _c0 = function (a0) { return { "icon-spin": a0 }; };
const _c1 = function (a0) { return { "split-view__detail--selected": a0 }; };
export class SoftwareDeviceTabComponent {
    constructor(route, repository, inventory, advancedSoftwareService) {
        this.route = route;
        this.repository = repository;
        this.inventory = inventory;
        this.advancedSoftwareService = advancedSoftwareService;
        this.deviceId = this.route.snapshot.parent.data.contextData.id;
        this.device$ = new BehaviorSubject(this.route.snapshot.parent.data.contextData);
        this.deviceTypeQuery$ = this.device$.pipe(map(device => this.repository.getDeviceTypeQuery(RepositoryType.SOFTWARE, device)));
        this.list$ = this.device$.pipe(switchMap(device => this.advancedSoftwareService
            .isASMAvailable()
            .then(isASMAvailable => ({ isASMAvailable, device }))), map(({ isASMAvailable, device }) => 
        // with ASM available software items will be retrieved directly in the
        // device-software-list component
        isASMAvailable ? undefined : this.repository.getDeviceSoftwareList(device)));
        this.changes$ = new BehaviorSubject([]);
        this.changesOperation$ = new BehaviorSubject(null);
        this.changesInProgress$ = this.changesOperation$.pipe(map(operation => this.isInProgress(operation)));
        this.reloading = false;
        this.showSoftwareChanges = false;
    }
    ngOnInit() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.loadDevice();
            yield this.loadOperation();
        });
    }
    addChanges(requestedChanges) {
        let stagedChanges = [...this.changes$.value];
        requestedChanges.forEach(requestedChange => {
            const alreadyStaged = stagedChanges.some(stagedChange => this.areSameChanges(stagedChange, requestedChange));
            if (!alreadyStaged) {
                stagedChanges = [...stagedChanges, requestedChange];
            }
        });
        this.changes$.next(stagedChanges);
    }
    dropChange(changeToBeDropped) {
        let stagedChanges = [...this.changes$.value];
        stagedChanges = stagedChanges.filter(stagedChange => !this.areSameChanges(stagedChange, changeToBeDropped));
        this.changes$.next(stagedChanges);
    }
    areSameChanges(change1, change2) {
        return change1.name === change2.name &&
            change1.version === change2.version &&
            change1.action === change2.action;
    }
    clearChanges() {
        this.changes$.next([]);
    }
    loadDevice() {
        return __awaiter(this, void 0, void 0, function* () {
            this.reloading = true;
            const device = (yield this.inventory.detail(this.deviceId, { withChildren: false })).data;
            this.device$.next(device);
            this.reloading = false;
        });
    }
    applyChanges() {
        return __awaiter(this, void 0, void 0, function* () {
            const operation = yield this.repository.createSoftwareUpdateOperation(this.device$.value, this.changes$.value);
            this.trackOperation(operation);
        });
    }
    loadOperation() {
        return __awaiter(this, void 0, void 0, function* () {
            const operation = yield this.repository.getLastSoftwareUpdateOperation(this.deviceId);
            this.trackOperation(operation);
        });
    }
    trackOperation(operation) {
        this.changesOperation$.next(operation);
        if (this.isInProgress(operation)) {
            this.displayChangesFromOperation(operation);
            this.repository.observeOperation(operation).subscribe(operationUpdate => {
                this.changesOperation$.next(operationUpdate);
                if (operationUpdate.status === OperationStatus.SUCCESSFUL) {
                    this.clearChanges();
                    this.loadDevice();
                }
            }, operationUpdate => {
                this.changesOperation$.next(operationUpdate);
            });
        }
    }
    displayChangesFromOperation(operation) {
        const changes = this.repository.getDeviceSoftwareChangesFromOperation(operation, this.device$.value);
        this.changes$.next(changes);
    }
    isInProgress(operation) {
        return (operation && [OperationStatus.PENDING, OperationStatus.EXECUTING].includes(operation.status));
    }
}
SoftwareDeviceTabComponent.ɵfac = function SoftwareDeviceTabComponent_Factory(t) { return new (t || SoftwareDeviceTabComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ActivatedRoute), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.RepositoryService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.InventoryService), ɵngcc0.ɵɵdirectiveInject(ɵngcc4.AdvancedSoftwareService)); };
SoftwareDeviceTabComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: SoftwareDeviceTabComponent, selectors: [["c8y-software-device-tab"]], decls: 17, vars: 37, consts: [[3, "placement"], [1, "btn", "btn-link", 3, "title", "click"], ["c8yIcon", "refresh", 3, "ngClass"], [1, "card", "split-view--8-4", "m-b-0"], [1, "split-view__list", 3, "device", "deviceTypeQuery", "softwareList", "deviceSoftwareChanges", "deviceSoftwareChangesOperation", "deviceSoftwareChangesInProgress", "changes", "showSoftwareChanges"], [1, "bg-gray-white", "split-view__detail", 3, "ngClass", "changes", "changesInProgress", "clear", "drop", "apply", "hideSoftwareChanges"]], template: function SoftwareDeviceTabComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "c8y-action-bar-item", 0);
        ɵngcc0.ɵɵelementStart(1, "button", 1);
        ɵngcc0.ɵɵlistener("click", function SoftwareDeviceTabComponent_Template_button_click_1_listener() { return ctx.loadDevice(); });
        ɵngcc0.ɵɵpipe(2, "translate");
        ɵngcc0.ɵɵelement(3, "i", 2);
        ɵngcc0.ɵɵtext(4);
        ɵngcc0.ɵɵpipe(5, "translate");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(6, "div", 3);
        ɵngcc0.ɵɵelementStart(7, "c8y-installed-software", 4);
        ɵngcc0.ɵɵlistener("changes", function SoftwareDeviceTabComponent_Template_c8y_installed_software_changes_7_listener($event) { return ctx.addChanges($event); })("showSoftwareChanges", function SoftwareDeviceTabComponent_Template_c8y_installed_software_showSoftwareChanges_7_listener() { return ctx.showSoftwareChanges = true; });
        ɵngcc0.ɵɵpipe(8, "async");
        ɵngcc0.ɵɵpipe(9, "async");
        ɵngcc0.ɵɵpipe(10, "async");
        ɵngcc0.ɵɵpipe(11, "async");
        ɵngcc0.ɵɵpipe(12, "async");
        ɵngcc0.ɵɵpipe(13, "async");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(14, "c8y-device-software-changes", 5);
        ɵngcc0.ɵɵlistener("clear", function SoftwareDeviceTabComponent_Template_c8y_device_software_changes_clear_14_listener() { return ctx.clearChanges(); })("drop", function SoftwareDeviceTabComponent_Template_c8y_device_software_changes_drop_14_listener($event) { return ctx.dropChange($event); })("apply", function SoftwareDeviceTabComponent_Template_c8y_device_software_changes_apply_14_listener() { return ctx.applyChanges(); })("hideSoftwareChanges", function SoftwareDeviceTabComponent_Template_c8y_device_software_changes_hideSoftwareChanges_14_listener() { return ctx.showSoftwareChanges = false; });
        ɵngcc0.ɵɵpipe(15, "async");
        ɵngcc0.ɵɵpipe(16, "async");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("placement", "right");
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(2, 13, "Reload"));
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction1(33, _c0, ctx.reloading));
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(5, 15, "Reload"), " ");
        ɵngcc0.ɵɵadvance(3);
        ɵngcc0.ɵɵproperty("device", ɵngcc0.ɵɵpipeBind1(8, 17, ctx.device$))("deviceTypeQuery", ɵngcc0.ɵɵpipeBind1(9, 19, ctx.deviceTypeQuery$))("softwareList", ɵngcc0.ɵɵpipeBind1(10, 21, ctx.list$))("deviceSoftwareChanges", ɵngcc0.ɵɵpipeBind1(11, 23, ctx.changes$))("deviceSoftwareChangesOperation", ɵngcc0.ɵɵpipeBind1(12, 25, ctx.changesOperation$))("deviceSoftwareChangesInProgress", ɵngcc0.ɵɵpipeBind1(13, 27, ctx.changesInProgress$));
        ɵngcc0.ɵɵadvance(7);
        ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction1(35, _c1, ctx.showSoftwareChanges))("changes", ɵngcc0.ɵɵpipeBind1(15, 29, ctx.changes$))("changesInProgress", ɵngcc0.ɵɵpipeBind1(16, 31, ctx.changesInProgress$));
    } }, directives: [ɵngcc5.ActionBarItemComponent, ɵngcc5.IconDirective, ɵngcc6.NgClass, ɵngcc7.InstalledSoftwareComponent, ɵngcc8.DeviceSoftwareChangesComponent], pipes: [ɵngcc5.C8yTranslatePipe, ɵngcc6.AsyncPipe], encapsulation: 2 });
SoftwareDeviceTabComponent.ctorParameters = () => [
    { type: ActivatedRoute },
    { type: RepositoryService },
    { type: InventoryService },
    { type: AdvancedSoftwareService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(SoftwareDeviceTabComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-software-device-tab',
                template: "<c8y-action-bar-item [placement]=\"'right'\">\n  <button class=\"btn btn-link\" title=\"{{ 'Reload' | translate }}\" (click)=\"loadDevice()\">\n    <i c8yIcon=\"refresh\" [ngClass]=\"{ 'icon-spin': reloading }\"></i>\n    {{ 'Reload' | translate }}\n  </button>\n</c8y-action-bar-item>\n\n<div class=\"card split-view--8-4 m-b-0\">\n  <c8y-installed-software\n    class=\"split-view__list\"\n    [device]=\"device$ | async\"\n    [deviceTypeQuery]=\"deviceTypeQuery$ | async\"\n    [softwareList]=\"list$ | async\"\n    [deviceSoftwareChanges]=\"changes$ | async\"\n    [deviceSoftwareChangesOperation]=\"changesOperation$ | async\"\n    [deviceSoftwareChangesInProgress]=\"changesInProgress$ | async\"\n    (changes)=\"addChanges($event)\"\n    (showSoftwareChanges)=\"showSoftwareChanges = true\"\n  ></c8y-installed-software>\n  <c8y-device-software-changes\n    class=\"bg-gray-white split-view__detail\"\n    [ngClass]=\"{ 'split-view__detail--selected': showSoftwareChanges }\"\n    [changes]=\"changes$ | async\"\n    [changesInProgress]=\"changesInProgress$ | async\"\n    (clear)=\"clearChanges()\"\n    (drop)=\"dropChange($event)\"\n    (apply)=\"applyChanges()\"\n    (hideSoftwareChanges)=\"showSoftwareChanges = false\"\n  ></c8y-device-software-changes>\n</div>\n"
            }]
    }], function () { return [{ type: ɵngcc1.ActivatedRoute }, { type: ɵngcc2.RepositoryService }, { type: ɵngcc3.InventoryService }, { type: ɵngcc4.AdvancedSoftwareService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29mdHdhcmUtZGV2aWNlLXRhYi5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3JlcG9zaXRvcnkvc29mdHdhcmUtZGV2aWNlLXRhYi9zb2Z0d2FyZS1kZXZpY2UtdGFiLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBVSxNQUFNLGVBQWUsQ0FBQztBQUNsRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDakQsT0FBTyxFQUFjLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNuRCxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBa0IsZ0JBQWdCLEVBQUUsZUFBZSxFQUFjLE1BQU0sYUFBYSxDQUFDO0FBQzVGLE9BQU8sRUFBd0MsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDM0YsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sNkJBQTZCLENBQUM7Ozs7Ozs7Ozs7Ozs7QUFNdEUsTUFBTSxPQUFPLDBCQUEwQjtBQUFHLElBMEJ4QyxZQUNVLEtBQXFCLEVBQ3JCLFVBQTZCLEVBQzdCLFNBQTJCLEVBQzNCLHVCQUFnRDtBQUN6RCxRQUpTLFVBQUssR0FBTCxLQUFLLENBQWdCO0FBQUMsUUFDdEIsZUFBVSxHQUFWLFVBQVUsQ0FBbUI7QUFBQyxRQUM5QixjQUFTLEdBQVQsU0FBUyxDQUFrQjtBQUFDLFFBQzVCLDRCQUF1QixHQUF2Qix1QkFBdUIsQ0FBeUI7QUFDNUQsUUE5QkUsYUFBUSxHQUFvQixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUM7QUFDN0UsUUFBRSxZQUFPLEdBQUcsSUFBSSxlQUFlLENBQWlCLElBQUksQ0FB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LFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDaEMsSUFBRSxDQUFDO0FBQ0gsSUFDVSxZQUFZLENBQUMsU0FBcUI7QUFDNUMsUUFBSSxPQUFPLENBQ0wsU0FBUyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sRUFBRSxlQUFlLENBQUMsU0FBUyxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FDN0YsQ0FBQztBQUNOLElBQUUsQ0FBQztBQUNIO3NEQTNIQyxTQUFTLFNBQUMsa0JBQ1QsUUFBUSxFQUFFLHlCQUF5QixrQkFDbkM7Ozs7Ozs7O0NBQWlELGNBQ2xEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzhPQUNJO0FBQUM7QUFBb0QsWUFaakQsY0FBYztBQUFJLFlBS2xCLGlCQUFpQjtBQUFJLFlBRkwsZ0JBQWdCO0FBQUksWUFHcEMsdUJBQXVCO0FBQUc7Ozs7Ozs7Z01BQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSU1hbmFnZWRPYmplY3QsIEludmVudG9yeVNlcnZpY2UsIE9wZXJhdGlvblN0YXR1cywgSU9wZXJhdGlvbiB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IERldmljZVNvZnR3YXJlLCBEZXZpY2VTb2Z0d2FyZUNoYW5nZSwgUmVwb3NpdG9yeVR5cGUgfSBmcm9tICcuLi9yZXBvc2l0b3J5Lm1vZGVsJztcbmltcG9ydCB7IFJlcG9zaXRvcnlTZXJ2aWNlIH0gZnJvbSAnLi4vcmVwb3NpdG9yeS5zZXJ2aWNlJztcbmltcG9ydCB7IEFkdmFuY2VkU29mdHdhcmVTZXJ2aWNlIH0gZnJvbSAnLi9hZHZhbmNlZC1zb2Z0d2FyZS5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXNvZnR3YXJlLWRldmljZS10YWInLFxuICB0ZW1wbGF0ZVVybDogJ3NvZnR3YXJlLWRldmljZS10YWIuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFNvZnR3YXJlRGV2aWNlVGFiQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgZGV2aWNlSWQ6IHN0cmluZyB8IG51bWJlciA9IHRoaXMucm91dGUuc25hcHNob3QucGFyZW50LmRhdGEuY29udGV4dERhdGEuaWQ7XG4gIGRldmljZSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PElNYW5hZ2VkT2JqZWN0Pih0aGlzLnJvdXRlLnNuYXBzaG90LnBhcmVudC5kYXRhLmNvbnRleHREYXRhKTtcbiAgZGV2aWNlVHlwZVF1ZXJ5JDogT2JzZXJ2YWJsZTxvYmplY3Q+ID0gdGhpcy5kZXZpY2UkLnBpcGUoXG4gICAgbWFwKGRldmljZSA9PiB0aGlzLnJlcG9zaXRvcnkuZ2V0RGV2aWNlVHlwZVF1ZXJ5KFJlcG9zaXRvcnlUeXBlLlNPRlRXQVJFLCBkZXZpY2UpKVxuICApO1xuICBsaXN0JDogT2JzZXJ2YWJsZTxEZXZpY2VTb2Z0d2FyZVtdPiA9IHRoaXMuZGV2aWNlJC5waXBlKFxuICAgIHN3aXRjaE1hcChkZXZpY2UgPT5cbiAgICAgIHRoaXMuYWR2YW5jZWRTb2Z0d2FyZVNlcnZpY2VcbiAgICAgICAgLmlzQVNNQXZhaWxhYmxlKClcbiAgICAgICAgLnRoZW4oaXNBU01BdmFpbGFibGUgPT4gKHsgaXNBU01BdmFpbGFibGUsIGRldmljZSB9KSlcbiAgICApLFxuICAgIG1hcCgoeyBpc0FTTUF2YWlsYWJsZSwgZGV2aWNlIH0pID0+XG4gICAgICAvLyB3aXRoIEFTTSBhdmFpbGFibGUgc29mdHdhcmUgaXRlbXMgd2lsbCBiZSByZXRyaWV2ZWQgZGlyZWN0bHkgaW4gdGhlXG4gICAgICAvLyBkZXZpY2Utc29mdHdhcmUtbGlzdCBjb21wb25lbnRcbiAgICAgIGlzQVNNQXZhaWxhYmxlID8gdW5kZWZpbmVkIDogdGhpcy5yZXBvc2l0b3J5LmdldERldmljZVNvZnR3YXJlTGlzdChkZXZpY2UpXG4gICAgKVxuICApO1xuICBjaGFuZ2VzJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8RGV2aWNlU29mdHdhcmVDaGFuZ2VbXT4oW10pO1xuICBjaGFuZ2VzT3BlcmF0aW9uJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8SU9wZXJhdGlvbj4obnVsbCk7XG4gIGNoYW5nZXNJblByb2dyZXNzJDogT2JzZXJ2YWJsZTxib29sZWFuPiA9IHRoaXMuY2hhbmdlc09wZXJhdGlvbiQucGlwZShcbiAgICBtYXAob3BlcmF0aW9uID0+IHRoaXMuaXNJblByb2dyZXNzKG9wZXJhdGlvbikpXG4gICk7XG4gIHJlbG9hZGluZzogYm9vbGVhbiA9IGZhbHNlO1xuICBzaG93U29mdHdhcmVDaGFuZ2VzOiBib29sZWFuID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByb3V0ZTogQWN0aXZhdGVkUm91dGUsXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5OiBSZXBvc2l0b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGFkdmFuY2VkU29mdHdhcmVTZXJ2aWNlOiBBZHZhbmNlZFNvZnR3YXJlU2VydmljZVxuICApIHt9XG5cbiAgYXN5bmMgbmdPbkluaXQoKSB7XG4gICAgYXdhaXQgdGhpcy5sb2FkRGV2aWNlKCk7XG4gICAgYXdhaXQgdGhpcy5sb2FkT3BlcmF0aW9uKCk7XG4gIH1cblxuICBhZGRDaGFuZ2VzKHJlcXVlc3RlZENoYW5nZXM6IERldmljZVNvZnR3YXJlQ2hhbmdlW10pIHtcbiAgICBsZXQgc3RhZ2VkQ2hhbmdlcyA9IFsuLi50aGlzLmNoYW5nZXMkLnZhbHVlXTtcbiAgICByZXF1ZXN0ZWRDaGFuZ2VzLmZvckVhY2gocmVxdWVzdGVkQ2hhbmdlID0+IHtcbiAgICAgIGNvbnN0IGFscmVhZHlTdGFnZWQgPSBzdGFnZWRDaGFuZ2VzLnNvbWUoc3RhZ2VkQ2hhbmdlID0+XG4gICAgICAgIHRoaXMuYXJlU2FtZUNoYW5nZXMoc3RhZ2VkQ2hhbmdlLCByZXF1ZXN0ZWRDaGFuZ2UpKTtcbiAgICAgIGlmICghYWxyZWFkeVN0YWdlZCkge1xuICAgICAgICBzdGFnZWRDaGFuZ2VzID0gWy4uLnN0YWdlZENoYW5nZXMsIHJlcXVlc3RlZENoYW5nZV07XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5jaGFuZ2VzJC5uZXh0KHN0YWdlZENoYW5nZXMpO1xuICB9XG5cbiAgZHJvcENoYW5nZShjaGFuZ2VUb0JlRHJvcHBlZDogRGV2aWNlU29mdHdhcmVDaGFuZ2UpIHtcbiAgICBsZXQgc3RhZ2VkQ2hhbmdlcyA9IFsuLi50aGlzLmNoYW5nZXMkLnZhbHVlXTtcbiAgICBzdGFnZWRDaGFuZ2VzID0gc3RhZ2VkQ2hhbmdlcy5maWx0ZXIoc3RhZ2VkQ2hhbmdlID0+ICF0aGlzLmFyZVNhbWVDaGFuZ2VzKHN0YWdlZENoYW5nZSwgY2hhbmdlVG9CZURyb3BwZWQpKTtcbiAgICB0aGlzLmNoYW5nZXMkLm5leHQoc3RhZ2VkQ2hhbmdlcyk7XG4gIH1cblxuICBhcmVTYW1lQ2hhbmdlcyhjaGFuZ2UxOiBEZXZpY2VTb2Z0d2FyZUNoYW5nZSwgY2hhbmdlMjogRGV2aWNlU29mdHdhcmVDaGFuZ2UpIHtcbiAgICByZXR1cm4gY2hhbmdlMS5uYW1lID09PSBjaGFuZ2UyLm5hbWUgJiZcbiAgICAgIGNoYW5nZTEudmVyc2lvbiA9PT0gY2hhbmdlMi52ZXJzaW9uICYmXG4gICAgICBjaGFuZ2UxLmFjdGlvbiA9PT0gY2hhbmdlMi5hY3Rpb247XG4gIH1cblxuICBjbGVhckNoYW5nZXMoKSB7XG4gICAgdGhpcy5jaGFuZ2VzJC5uZXh0KFtdKTtcbiAgfVxuXG4gIGFzeW5jIGxvYWREZXZpY2UoKSB7XG4gICAgdGhpcy5yZWxvYWRpbmcgPSB0cnVlO1xuICAgIGNvbnN0IGRldmljZSA9IChhd2FpdCB0aGlzLmludmVudG9yeS5kZXRhaWwodGhpcy5kZXZpY2VJZCwgeyB3aXRoQ2hpbGRyZW46IGZhbHNlIH0pKS5kYXRhO1xuICAgIHRoaXMuZGV2aWNlJC5uZXh0KGRldmljZSk7XG4gICAgdGhpcy5yZWxvYWRpbmcgPSBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIGFwcGx5Q2hhbmdlcygpIHtcbiAgICBjb25zdCBvcGVyYXRpb24gPSBhd2FpdCB0aGlzLnJlcG9zaXRvcnkuY3JlYXRlU29mdHdhcmVVcGRhdGVPcGVyYXRpb24oXG4gICAgICB0aGlzLmRldmljZSQudmFsdWUsXG4gICAgICB0aGlzLmNoYW5nZXMkLnZhbHVlXG4gICAgKTtcbiAgICB0aGlzLnRyYWNrT3BlcmF0aW9uKG9wZXJhdGlvbik7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGxvYWRPcGVyYXRpb24oKSB7XG4gICAgY29uc3Qgb3BlcmF0aW9uID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5LmdldExhc3RTb2Z0d2FyZVVwZGF0ZU9wZXJhdGlvbih0aGlzLmRldmljZUlkKTtcbiAgICB0aGlzLnRyYWNrT3BlcmF0aW9uKG9wZXJhdGlvbik7XG4gIH1cblxuICBwcml2YXRlIHRyYWNrT3BlcmF0aW9uKG9wZXJhdGlvbjogSU9wZXJhdGlvbikge1xuICAgIHRoaXMuY2hhbmdlc09wZXJhdGlvbiQubmV4dChvcGVyYXRpb24pO1xuXG4gICAgaWYgKHRoaXMuaXNJblByb2dyZXNzKG9wZXJhdGlvbikpIHtcbiAgICAgIHRoaXMuZGlzcGxheUNoYW5nZXNGcm9tT3BlcmF0aW9uKG9wZXJhdGlvbik7XG4gICAgICB0aGlzLnJlcG9zaXRvcnkub2JzZXJ2ZU9wZXJhdGlvbihvcGVyYXRpb24pLnN1YnNjcmliZShcbiAgICAgICAgb3BlcmF0aW9uVXBkYXRlID0+IHtcbiAgICAgICAgICB0aGlzLmNoYW5nZXNPcGVyYXRpb24kLm5leHQob3BlcmF0aW9uVXBkYXRlKTtcbiAgICAgICAgICBpZiAob3BlcmF0aW9uVXBkYXRlLnN0YXR1cyA9PT0gT3BlcmF0aW9uU3RhdHVzLlNVQ0NFU1NGVUwpIHtcbiAgICAgICAgICAgIHRoaXMuY2xlYXJDaGFuZ2VzKCk7XG4gICAgICAgICAgICB0aGlzLmxvYWREZXZpY2UoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIG9wZXJhdGlvblVwZGF0ZSA9PiB7XG4gICAgICAgICAgdGhpcy5jaGFuZ2VzT3BlcmF0aW9uJC5uZXh0KG9wZXJhdGlvblVwZGF0ZSk7XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBkaXNwbGF5Q2hhbmdlc0Zyb21PcGVyYXRpb24ob3BlcmF0aW9uOiBJT3BlcmF0aW9uKSB7XG4gICAgY29uc3QgY2hhbmdlcyA9IHRoaXMucmVwb3NpdG9yeS5nZXREZXZpY2VTb2Z0d2FyZUNoYW5nZXNGcm9tT3BlcmF0aW9uKFxuICAgICAgb3BlcmF0aW9uLFxuICAgICAgdGhpcy5kZXZpY2UkLnZhbHVlXG4gICAgKTtcbiAgICB0aGlzLmNoYW5nZXMkLm5leHQoY2hhbmdlcyk7XG4gIH1cblxuICBwcml2YXRlIGlzSW5Qcm9ncmVzcyhvcGVyYXRpb246IElPcGVyYXRpb24pIHtcbiAgICByZXR1cm4gKFxuICAgICAgb3BlcmF0aW9uICYmIFtPcGVyYXRpb25TdGF0dXMuUEVORElORywgT3BlcmF0aW9uU3RhdHVzLkVYRUNVVElOR10uaW5jbHVkZXMob3BlcmF0aW9uLnN0YXR1cylcbiAgICApO1xuICB9XG59XG4iXX0=