import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { EventBinaryService, EventService, InventoryBinaryService, InventoryService, OperationService, OperationStatus, QueriesUtil } from '@c8y/client';
import { AlertService, gettext, OperationRealtimeService } from '@c8y/ngx-components';
import { assign, cloneDeep, find, forEach, get, head, isNil, isString, isUndefined, map as _map, pick, remove, set } from 'lodash-es';
import { defer, from, merge, of, throwError } from 'rxjs';
import { filter, map, switchMap, take, takeWhile, withLatestFrom } from 'rxjs/operators';
import { RepositoryType, REPOSITORY_BINARY_TYPES } from './repository.model';
export class RepositoryService {
    constructor(inventory, inventoryBinary, operation, alert, event, operationRealtime, eventBinary) {
        this.inventory = inventory;
        this.inventoryBinary = inventoryBinary;
        this.operation = operation;
        this.alert = alert;
        this.event = event;
        this.operationRealtime = operationRealtime;
        this.eventBinary = eventBinary;
        this.dateFrom = new Date(0);
        this.dateTo = new Date(Date.now() + 86400000); // 1 day in the future
        this.queriesUtil = new QueriesUtil();
    }
    /**
     * Lists repository entries of given type.
     * @param type The type of repository entries to list.
     * @param options Extra listing options.
     */
    listRepositoryEntries(type, options) {
        const defaultOrder = [{ name: 1 }];
        const defaultFilters = { type };
        const legacyFilters = { __has: `url` };
        let filters = {};
        let fullQuery = (options && options.query) || {};
        if (!options || (options && !options.skipDefaultOrder)) {
            fullQuery = this.queriesUtil.addOrderbys(fullQuery, defaultOrder, 'prepend');
        }
        fullQuery = this.queriesUtil.addAndFilter(fullQuery, defaultFilters);
        if (options && options.partialTextFilter) {
            const { partialText, properties } = options.partialTextFilter;
            const orFilter = { __or: properties.map(property => ({ [property]: `*${partialText}*` })) };
            fullQuery = this.queriesUtil.addAndFilter(fullQuery, orFilter);
        }
        if (options && options.partialName) {
            // backwards compatibility if
            fullQuery = this.queriesUtil.addAndFilter(fullQuery, { name: `*${options.partialName}*` });
        }
        if (options && options.skipLegacy) {
            fullQuery = this.queriesUtil.addAndFilter(fullQuery, { __not: legacyFilters });
        }
        filters = Object.assign({ query: this.queriesUtil.buildQuery(fullQuery), pageSize: 50, withTotalPages: true }, ((options && options.params) || {}));
        return this.inventory.list(filters);
    }
    // TODO: merge with create()
    save(data, type, mo = {}) {
        return __awaiter(this, void 0, void 0, function* () {
            switch (type) {
                case RepositoryType.CONFIGURATION: {
                    Object.assign(mo, {
                        type: RepositoryType.CONFIGURATION,
                        configurationType: data.selected ? data.selected.configurationType : undefined,
                        name: data.version,
                        description: data.description,
                        deviceType: data.deviceType,
                        c8y_Global: {}
                    });
                    if (!data.deviceType && mo.id) {
                        mo.deviceType = null;
                    }
                    if (!data.selected && mo.id) {
                        mo.configurationType = null;
                    }
                    break;
                }
            }
            const existingUrl = mo.url;
            if (data.binary.url) {
                mo.url = data.binary.url;
            }
            else if (data.binary.file) {
                const response = yield this.inventoryBinary.create(data.binary.file, {
                    c8y_Global: {}
                });
                mo.url = response.data.self;
            }
            if (mo.id) {
                return this.updateEntry(mo, existingUrl);
            }
            return this.createEntry(mo);
        });
    }
    create(modal, type) {
        return __awaiter(this, void 0, void 0, function* () {
            switch (type) {
                case RepositoryType.FIRMWARE:
                case RepositoryType.SOFTWARE:
                    return this.createFirmwareOrSoftware(modal, type);
            }
        });
    }
    createFirmwareOrSoftware(modal, type) {
        return __awaiter(this, void 0, void 0, function* () {
            let binary;
            let binaryURL;
            let repositoryEntry;
            let repositoryBinary;
            const mos = [];
            const { selected: { id: selectedId }, binary: { file, url } } = modal;
            try {
                if (file) {
                    ({ data: binary } = yield this.saveBinary(file));
                    ({ self: binaryURL } = binary);
                    mos.push(binary);
                }
                else {
                    binaryURL = url;
                }
                ({ data: repositoryEntry } = yield this.createOrUpdateRepositoryEntry(modal, type));
                if (isNil(selectedId)) {
                    mos.push(repositoryEntry);
                }
                ({ data: repositoryBinary } = yield this.createRepositoryBinary(modal, binaryURL, type, repositoryEntry));
                mos.push(repositoryBinary);
                if (file) {
                    yield this.linkBinary(repositoryBinary, binary);
                }
                return repositoryEntry;
            }
            catch (error) {
                this.cleanUp(mos);
                this.errorMsg();
                // Propagate error
                throw error;
            }
        });
    }
    saveBinary(file) {
        return this.inventoryBinary.create(file, { c8y_Global: {} });
    }
    createOrUpdateRepositoryEntry(modal, type) {
        const { selected: { id, name }, description, deviceType } = modal;
        const mo = {
            id,
            name: id ? undefined : name,
            description,
            type: id ? undefined : type,
            c8y_Global: {}
        };
        if (deviceType) {
            set(mo, 'c8y_Filter.type', deviceType);
        }
        if (modal.softwareType) {
            set(mo, 'softwareType', modal.softwareType.softwareType);
        }
        return id
            ? this.inventory.update(mo)
            : this.inventory.create(mo);
    }
    createRepositoryBinary(modal, binaryURL, type, parent) {
        const mo = this.prepareRepositoryBinaryMO(modal, binaryURL, type);
        return this.inventory.childAdditionsCreate(mo, parent);
    }
    prepareRepositoryBinaryMO(modal, binaryURL, type) {
        const { version, patchVersion, dependency } = modal;
        const result = {
            type: REPOSITORY_BINARY_TYPES[type],
            [type]: {
                url: binaryURL
            },
            c8y_Global: {}
        };
        if (dependency) {
            set(result, [type, 'version'], patchVersion);
            assign(result, {
                c8y_Patch: {
                    dependency: dependency.c8y_Firmware.version
                }
            });
        }
        else {
            set(result, [type, 'version'], version);
        }
        return result;
    }
    linkBinary(repositoryBinary, binary) {
        return __awaiter(this, void 0, void 0, function* () {
            const { id: repositoryBinaryId } = repositoryBinary;
            if (binary) {
                const { id: binaryId } = binary;
                return this.inventory.childAdditionsAdd(binaryId, repositoryBinaryId);
            }
        });
    }
    cleanUp(mosToDelete) {
        mosToDelete.forEach(mo => {
            const { c8y_IsBinary } = mo;
            isUndefined(c8y_IsBinary) ? this.delete(mo) : this.inventoryBinary.delete(mo);
        });
    }
    delete(entity) {
        return this.inventory.delete(entity, { forceCascade: true });
    }
    errorMsg() {
        const msg = gettext('Failed to save');
        this.alert.danger(msg);
    }
    getBaseVersionsCount$(entry) {
        if (this.isLegacyEntry(entry)) {
            return of(1);
        }
        return from(this.listBaseVersions(entry, { pageSize: 1, withTotalPages: true })).pipe(map(({ paging }) => paging.totalPages));
    }
    getBaseVersionFromMO(mo) {
        return this.isPatch(mo) ? get(mo, 'c8y_Patch.dependency') : get(mo, 'c8y_Firmware.version');
    }
    isPatch(mo) {
        return !!get(mo, 'c8y_Patch.dependency');
    }
    getPatchVersionsCount$(entry, baseVersion) {
        if (this.isLegacyEntry(baseVersion)) {
            return of(0);
        }
        return from(this.listPatchVersions(entry, baseVersion, { pageSize: 1, withTotalPages: true })).pipe(map(({ paging }) => paging.totalPages));
    }
    isLegacyEntry(entry) {
        return Boolean(entry.url);
    }
    /**
     * Lists all versions (base and patch ones) of given top level entry.
     * Versions are ordered by creation time (assuming the earlier created, the older the version).
     * @param entry Top level repository entry.
     * @param params Additional query params.
     */
    listAllVersions(entry, params = {}) {
        if (this.isLegacyEntry(entry)) {
            return this.getBaseVersionResultListForLegacyEntry(entry);
        }
        const VERSION_FILTER_ORDER = {
            __filter: {},
            __orderby: [{ 'creationTime.date': -1 }, { creationTime: -1 }]
        };
        return this.listChildren(entry, VERSION_FILTER_ORDER, params);
    }
    /**
     * Lists base versions of given top level entry.
     * Versions are ordered by creation time (assuming the earlier created, the older the version).
     * @param entry Top level repository entry.
     * @param params Additional query params.
     */
    listBaseVersions(entry, params = {}) {
        if (this.isLegacyEntry(entry)) {
            return this.getBaseVersionResultListForLegacyEntry(entry);
        }
        const NO_PATCH_FILTER_ORDER = {
            __filter: {
                __not: { __has: 'c8y_Patch' }
            },
            __orderby: [{ 'creationTime.date': -1 }, { creationTime: -1 }]
        };
        return this.listChildren(entry, NO_PATCH_FILTER_ORDER, params);
    }
    /**
     * Lists patch versions of given base version under the entry.
     * Versions are ordered by creation time (assuming the earlier created, the older the version).
     * @param entry Top level repository entry.
     * @param baseVersion Base version.
     * @param params Additional query params.
     */
    listPatchVersions(entry, baseVersion, params = {}) {
        const version = isString(baseVersion) ? baseVersion : get(baseVersion, 'c8y_Firmware.version');
        const PATCH_FILTER_ORDER = {
            __filter: {
                'c8y_Patch.dependency': version
            },
            __orderby: [{ 'creationTime.date': -1 }, { creationTime: -1 }]
        };
        return this.listChildren(entry, PATCH_FILTER_ORDER, params);
    }
    /**
     * Lists patch versions of given base version under the entry including the base version.
     * Versions are ordered by creation time (assuming the earlier created, the older the version).
     * In terms of legacy base version the entry gets transformed to fit the needed data model.
     * @param entry Top level repository entry.
     * @param baseVersion Base version.
     * @param params Additional query params.
     */
    listBaseVersionAndPatches(entry, baseVersion, params = {}) {
        if (this.isLegacyEntry(entry)) {
            return Promise.resolve({
                data: [
                    Object.assign({
                        c8y_Firmware: {
                            version: entry.version,
                            url: entry.url
                        }
                    }, entry)
                ]
            });
        }
        const PATCH_FILTER_ORDER = {
            __filter: {
                __or: {
                    'c8y_Patch.dependency': baseVersion.c8y_Firmware.version,
                    'c8y_Firmware.version': baseVersion.c8y_Firmware.version
                }
            },
            __orderby: [{ 'c8y_Patch.dependency': 1 }, { 'c8y_Firmware.version': 1 }]
        };
        return this.listChildren(entry, PATCH_FILTER_ORDER, params);
    }
    listChildren(entry, filters = {}, params = {}) {
        const childrenFilters = { __bygroupid: entry.id };
        const query = this.queriesUtil.addAndFilter(filters, childrenFilters);
        // FIXME: needed because of issue in forOf directive (...)
        params.withTotalPages = true;
        return this.inventory.listQuery(query, params);
    }
    /**
     * Fetches all items from the list starting with the provided page.
     * @param firstPage The first page of the list to fetch all items for.
     */
    fetchAllItemsFromList(firstPage) {
        return __awaiter(this, void 0, void 0, function* () {
            let allItems;
            if (!firstPage.then) {
                allItems = [...firstPage];
            }
            else {
                let { paging, data: items } = yield firstPage;
                allItems = [...items];
                while (paging && paging.nextPage) {
                    ({ paging, data: items } = yield paging.next());
                    allItems = [...allItems, ...items];
                }
            }
            return allItems;
        });
    }
    /**
     * Gets top level repository entry managed object for base or patch version.
     * @param mo Base or patch version managed object with parents.
     */
    getRepositoryEntryMO$(mo) {
        if (!mo) {
            return of(undefined);
        }
        const [reference] = get(mo, 'additionParents.references');
        const id = get(reference, 'managedObject.id');
        return id
            ? from(this.inventory.detail(id, { withChildren: false })).pipe(map(({ data }) => data))
            : of(undefined);
    }
    /**
     * Gets base or patch version managed object.
     * @param deviceRepositoryFragment Device repository fragment.
     * @param type Top level repository entry type.
     * @param configuration Configuration object with options:
     * - **skipLegacy** - `boolean` - Exclude legacy entries.
     * - **filters** - `object` - Filter object.
     *
     * @deprecated as it doesn't support 'missing url' case
     */
    getRepositoryBinaryMoByVersion(deviceRepositoryFragment, type, { skipLegacy = false, filters = {} } = {}) {
        const { version, url, name } = deviceRepositoryFragment;
        const repositoryBinaryType = REPOSITORY_BINARY_TYPES[type];
        let query;
        const newModelBaseVersionQuery = {
            [`${type}.version`]: version,
            [`${type}.url`]: url,
            type: repositoryBinaryType
        };
        const legacyVersionQuery = { url, type, name };
        filters = Object.assign({ withChildren: false, withParents: true }, filters);
        if (skipLegacy) {
            query = {
                __and: Object.assign({}, newModelBaseVersionQuery)
            };
        }
        else {
            query = {
                __or: [{ __and: Object.assign({}, newModelBaseVersionQuery) }, { __and: Object.assign({}, legacyVersionQuery) }]
            };
        }
        return this.inventory.listQuery(query, filters).then(({ data }) => head(data));
    }
    getBinaryName$(binaryUrl) {
        if (!binaryUrl) {
            return of('---');
        }
        const binaryId = this.inventoryBinary.getIdFromUrl(binaryUrl);
        if (!binaryId) {
            return of(binaryUrl);
        }
        return defer(() => this.inventory.detail(binaryId).then(result => result.data)).pipe(map(mo => mo.name));
    }
    /**
     * Generates an inventory query object which can be used to find
     * repository entries of specified type matching the type of provided device.
     * @param repositoryType The type of repository entries which will be queried with the generated query.
     * @param device The device for which matching repository entries will be queried with the generated query.
     */
    getDeviceTypeQuery(repositoryType, device) {
        let result = { type: repositoryType };
        if (repositoryType === RepositoryType.CONFIGURATION) {
            if (device.type) {
                result = this.queriesUtil.addAndFilter(result, {
                    __or: [{ deviceType: device.type }, { __not: { __has: `deviceType` } }]
                });
            }
        }
        else {
            result = this.queriesUtil.addAndFilter(result, {
                __or: [
                    { 'c8y_Filter.type': device.type },
                    { 'c8y_Filter.type': '' },
                    { __not: { __has: `c8y_Filter.type` } }
                ]
            });
        }
        return result;
    }
    /**
     * Generates an inventory query object which can be used to find configuration repository entries
     * matching the type of provided device and specified configuration type.
     * @param device The device for which matching repository entries will be queried with the generated query.
     * @param configurationType Configuration type for which matching repository entries will be queried with the generated query.
     */
    getConfigurationTypeQuery(device, configurationType) {
        const query = this.getDeviceTypeQuery(RepositoryType.CONFIGURATION, device);
        return this.queriesUtil.addAndFilter(query, {
            __or: [
                { configurationType },
                { configurationType: '' },
                { __not: { __has: `configurationType` } }
            ]
        });
    }
    /**
     * Gets the list of software installed in the device in the uniform format.
     * Supports c8y_SoftwareList and c8y_Software fragments.
     * @param device The device whose software list should be returned.
     */
    getDeviceSoftwareList(device) {
        if (device.c8y_SoftwareList) {
            return cloneDeep(device.c8y_SoftwareList);
        }
        if (device.c8y_Software) {
            return _map(device.c8y_Software, (version, name) => ({ name, version }));
        }
        return [];
    }
    /**
     * Prepares a software update operation for given device and the list of changes, and sends it to the device.
     * @param device The device which the operation should be prepared for and sent to.
     * @param changes The list of software changes which should be applied.
     */
    createSoftwareUpdateOperation(device, changes) {
        return __awaiter(this, void 0, void 0, function* () {
            const operation = this.getSoftwareUpdateOperation(device, changes);
            return (yield this.operation.create(operation)).data;
        });
    }
    /**
     * Prepares a software update operation for given device and changes.
     * Returned operation type depends on device's supported operations.
     * Supports c8y_SoftwareUpdate, c8y_SoftwareList, and c8y_Software operations.
     * @param device The device for which operation should be prepared.
     * @param changes The list of software changes which should be applied.
     */
    getSoftwareUpdateOperation(device, changes) {
        const operation = {
            deviceId: device.id,
            description: `Apply software changes: ${changes
                .map(change => `${change.action} "${change.name}"${change.version ? ` (version: ${change.version})` : ''}`)
                .join(', ')}`
        };
        if (device.c8y_SupportedOperations.includes('c8y_SoftwareUpdate')) {
            operation.c8y_SoftwareUpdate = cloneDeep(changes);
        }
        else if (device.c8y_SupportedOperations.includes('c8y_SoftwareList')) {
            operation.c8y_SoftwareList = cloneDeep(device.c8y_SoftwareList) || [];
            changes.forEach(change => {
                const deviceSoftware = pick(change, ['name', 'version', 'url']);
                if (change.action === 'delete') {
                    remove(operation.c8y_SoftwareList, deviceSoftware);
                }
                if (change.action === 'install') {
                    operation.c8y_SoftwareList.push(deviceSoftware);
                }
            });
        }
        else if (device.c8y_SupportedOperations.includes('c8y_Software')) {
            operation.c8y_Software = cloneDeep(device.c8y_Software) || {};
            changes.forEach(change => {
                if (change.action === 'delete') {
                    delete operation.c8y_Software[change.name];
                }
                if (change.action === 'install') {
                    operation.c8y_Software[change.name] = change.version;
                }
            });
        }
        return operation;
    }
    /**
     * Extracts the list of device software changes from given operation in the context of given device.
     * @param operation The operation from which the list should be extracted.
     * @param device The target device of the operation.
     */
    getDeviceSoftwareChangesFromOperation(operation, device) {
        if (operation.c8y_SoftwareUpdate) {
            return cloneDeep(operation.c8y_SoftwareUpdate);
        }
        if (operation.c8y_SoftwareList) {
            return this.getDeviceSoftwareChangesFromSoftwareListOperation(operation, device);
        }
        if (operation.c8y_Software) {
            return this.getDeviceSoftwareChangesFromSoftwareOperation(operation, device);
        }
        return [];
    }
    /**
     * Prepares a firmware update operation for given device and the selected repository binary, and sends it to the device.
     * @param device The device which the operation should be prepared for and sent to.
     * @param selectedOption The selected repository binary option.
     */
    createFirmwareUpdateOperation(device, selectedOption) {
        return __awaiter(this, void 0, void 0, function* () {
            const operation = this.getFirmwareUpdateOperation(device, selectedOption);
            return (yield this.operation.create(operation)).data;
        });
    }
    /**
     * Prepares a firmware update operation for given device and selected version.
     * Supports c8y_Firmware operation.
     * @param device The device for which operation should be prepared.
     * @param selectedOption Selected firmware version.
     */
    getFirmwareUpdateOperation(device, selectedOption) {
        delete selectedOption.id;
        const operation = {
            deviceId: device.id,
            description: `Update firmware to: "${selectedOption.name}"${selectedOption.version ? ` (version: ${selectedOption.version})` : ''}`,
            c8y_Firmware: Object.assign({}, selectedOption)
        };
        return operation;
    }
    /**
     * Prepares a configuration file upload operation for given device and configuration type.
     * @param device The device for which operation should be prepared.
     * @param configurationType Selected configuration type.
     * @param isLegacy  A legacy operation is created without a configurationType.
     */
    getUploadConfigurationFileOperation(device, configurationType, isLegacy = false) {
        if (isLegacy) {
            return {
                deviceId: device.id,
                description: `Retrieve configuration snapshot from device ${device.name}`,
                c8y_UploadConfigFile: {}
            };
        }
        return {
            deviceId: device.id,
            description: `Retrieve ${configurationType} configuration snapshot from device ${device.name}`,
            c8y_UploadConfigFile: {
                type: configurationType
            }
        };
    }
    /**
     * Prepares a configuration file download operation for given device and configuration type.
     * @param device The device for which operation should be prepared.
     * @param configurationType Selected configuration type.
     * @param binaryUrl The url of a binary to be downloaded.
     * @param isLegacy A legacy operation is created without a configurationType.
     */
    getDownloadConfigurationFileOperation(device, configurationType, configSnapshot, isLegacy = false) {
        if (isLegacy) {
            return {
                deviceId: device.id,
                description: `Send configuration snapshot ${configSnapshot.name} to device ${device.name}`,
                c8y_DownloadConfigFile: {
                    url: configSnapshot.binaryUrl,
                    c8y_ConfigurationDump: {
                        id: configSnapshot.id
                    }
                }
            };
        }
        return {
            deviceId: device.id,
            description: `Send configuration snapshot ${configSnapshot.name} of configuration type ${configurationType} to device ${device.name}`,
            c8y_DownloadConfigFile: {
                url: configSnapshot.binaryUrl,
                type: configurationType
            }
        };
    }
    /**
     * Gets the last firmware update operation for given device.
     * Looks for c8y_Firmware operations.
     * @param deviceId The ID of the device to find an operation for.
     */
    getLastFirmwareUpdateOperation(deviceId) {
        return __awaiter(this, void 0, void 0, function* () {
            const filters = {
                deviceId,
                dateFrom: new Date(0).toISOString(),
                dateTo: new Date(Date.now()).toISOString(),
                revert: true,
                pageSize: 1
            };
            return this.getFirstMatchingOperation([Object.assign(Object.assign({}, filters), { fragmentType: 'c8y_Firmware' })]);
        });
    }
    /**
     * Gets the last software update operation for given device.
     * Looks for c8y_SoftwareUpdate, c8y_SoftwareList, or c8y_Software operations.
     * @param deviceId The ID of the device to find an operation for.
     */
    getLastSoftwareUpdateOperation(deviceId) {
        return __awaiter(this, void 0, void 0, function* () {
            const filters = {
                deviceId,
                dateFrom: new Date(0).toISOString(),
                dateTo: new Date(Date.now()).toISOString(),
                revert: true,
                pageSize: 1
            };
            return this.getFirstMatchingOperation([
                Object.assign(Object.assign({}, filters), { fragmentType: 'c8y_SoftwareUpdate' }),
                Object.assign(Object.assign({}, filters), { fragmentType: 'c8y_SoftwareList' }),
                Object.assign(Object.assign({}, filters), { fragmentType: 'c8y_Software' })
            ]);
        });
    }
    /**
     * Iterates over the list of filters and queries the operations.
     * If a query returns at least one operation, the first one will be returned.
     * Otherwise the next query will be performed.
     * If none of the queries returns any operation, null will be returned.
     * @param filtersList The list of filters for the queries.
     */
    getFirstMatchingOperation(filtersList) {
        return __awaiter(this, void 0, void 0, function* () {
            let matchingOperation = null;
            for (const filters of filtersList) {
                const operations = (yield this.operation.list(filters)).data;
                if (operations.length) {
                    matchingOperation = operations[0];
                    break;
                }
            }
            return matchingOperation;
        });
    }
    /**
     * Iterates over the list of filters and queries the operations.
     * It compares the operations retrieved by the queries by 'creationTime'
     * and return the latest one.
     * If none of the queries returns any operation, null will be returned.
     * @param filtersList The list of filters for the queries.
     */
    getLatestMatchingOperation(filtersList) {
        return __awaiter(this, void 0, void 0, function* () {
            let matchingOperation = null;
            for (const filters of filtersList) {
                const operations = (yield this.operation.list(filters)).data;
                if (operations.length) {
                    if (matchingOperation) {
                        matchingOperation =
                            new Date(matchingOperation.creationTime).getTime() <
                                new Date(operations[0].creationTime).getTime()
                                ? operations[0]
                                : matchingOperation;
                    }
                    else {
                        matchingOperation = operations[0];
                    }
                }
            }
            return matchingOperation;
        });
    }
    /**
     * Creates the operation and returns an observable to track its progress.
     * Fails the observable when the operation returns FAILED status.
     * Completes the observable when the operation returns SUCCESSFUL status.
     * @param operation The operation to create and track.
     */
    createObservedOperation(operation) {
        return from(this.operation.create(operation)).pipe(map(({ data }) => data), take(1), switchMap(createdOperation => this.observeOperation(createdOperation)));
    }
    /**
     * Returns an observable to track progress of given operation.
     * Fails the observable when the operation returns FAILED status.
     * Completes the observable when the operation returns SUCCESSFUL status.
     * @param operation The operation to be observed.
     */
    observeOperation(operation) {
        const observedOperation$ = of(operation);
        const operationUpdates$ = observedOperation$.pipe(switchMap(observedOperation => this.operationRealtime.onAll$(observedOperation.deviceId)), map(({ data }) => data), withLatestFrom(observedOperation$), filter(([operationUpdate, observedOperation]) => operationUpdate.id === observedOperation.id), switchMap(([operationUpdate]) => {
            if (operationUpdate.status === OperationStatus.FAILED) {
                return throwError(operationUpdate);
            }
            return of(operationUpdate);
        }), takeWhile(operationUpdate => operationUpdate.status !== OperationStatus.SUCCESSFUL, true));
        return merge(observedOperation$, operationUpdates$);
    }
    /**
     * Gets a single event with latest creationTime for the given device Id and event type.
     * @param deviceId The device Id for which the events should be queried.
     * @param type Event type.
     */
    getLatestConfigurationEvent(deviceId, type) {
        return __awaiter(this, void 0, void 0, function* () {
            const eventFilter = {
                source: deviceId,
                type,
                dateFrom: this.dateFrom.toISOString(),
                dateTo: this.dateTo.toISOString(),
                pageSize: 1
            };
            const { data } = yield this.event.list(eventFilter);
            return data[0];
        });
    }
    /**
     * Gets a list of operations for the given device Id, and operation type.
     * @param deviceId The device Id for which the operation should be queried.
     * @param operationType Operation type fragment.
     */
    getConfigFileOperationList(deviceId, operationType) {
        return __awaiter(this, void 0, void 0, function* () {
            const operationFilter = {
                deviceId,
                fragmentType: operationType,
                dateFrom: this.dateFrom.toISOString(),
                dateTo: this.dateTo.toISOString(),
                revert: true,
                pageSize: 2000
            };
            return (yield this.operation.list(operationFilter)).data;
        });
    }
    /**
     * Gets latest uploaded configuration snapshot for the given device, and configuration type.
     * @param device The device for which the configuration snapshot was uploaded.
     * @param configurationType Selected configuration type.
     */
    getConfigSnapshot(device, configurationType) {
        return __awaiter(this, void 0, void 0, function* () {
            const event = yield this.getLatestConfigurationEvent(device.id, configurationType);
            let configSnapshot;
            if (event) {
                configSnapshot = {
                    time: event.time,
                    name: event.text,
                    deviceType: device.type,
                    configurationType
                };
                try {
                    configSnapshot.binary = yield (yield this.eventBinary.download(event)).text();
                    if (event.c8y_IsBinary) {
                        configSnapshot.binaryType = event.c8y_IsBinary.type;
                    }
                }
                catch (ex) {
                    const msg = gettext('Could not get the binary.');
                    this.alert.danger(msg);
                }
            }
            return configSnapshot;
        });
    }
    getLegacyConfigSnapshot(deviceId) {
        return __awaiter(this, void 0, void 0, function* () {
            let configSnapshot;
            let mo;
            const device = (yield this.inventory.detail(deviceId, { withChildren: false })).data;
            const snapshotId = device.c8y_ConfigurationDump && device.c8y_ConfigurationDump.id;
            if (!snapshotId) {
                return;
            }
            try {
                mo = (yield this.inventory.detail(snapshotId)).data;
            }
            catch (ex) {
                // do nothing
            }
            if (mo) {
                configSnapshot = {
                    time: mo.creationTime,
                    name: mo.name
                };
                configSnapshot.binary = yield this.getBinaryText(mo.url, { allowExternal: false });
            }
            return configSnapshot;
        });
    }
    /**
     * Returns a binary object as text.
     * @param binaryUrl The URL to find binary
     * @param options The object with additional options:
     * - **allowExternal** - `boolean` - allows downloading external binary file
     * - **noAlerts** - `boolean` - do not display an alert message; defaults to `false`
     */
    getBinaryText(binaryUrl, options) {
        return __awaiter(this, void 0, void 0, function* () {
            const binaryId = this.inventoryBinary.getIdFromUrl(binaryUrl);
            let res;
            if (!binaryId && options.allowExternal) {
                res = yield this.getExternalBinaryResponse(binaryUrl, options);
            }
            else {
                res = yield this.getInternalBinaryResponse(binaryId, options);
            }
            if (!res) {
                return null;
            }
            return res.text();
        });
    }
    /**
     * Returns a binary object as File.
     * @param binaryUrl The URL to find binary
     * @param options The object with additional options:
     * - **allowExternal** - `boolean` - allows downloading external binary file
     */
    getBinaryFile(binaryUrl, options) {
        return __awaiter(this, void 0, void 0, function* () {
            const binaryId = this.inventoryBinary.getIdFromUrl(binaryUrl);
            if (!binaryId && !options.allowExternal) {
                return null;
            }
            // @TODO: note that it doesn't solve issue with external binary here, such url won't have binaryId, so we won't know the name or contentType to use in File constructor, let's add a @FIXME comment for now?
            const { name, contentType } = (yield this.inventory.detail(binaryId)).data;
            const res = !!binaryId
                ? yield this.getInternalBinaryResponse(binaryId)
                : yield this.getExternalBinaryResponse(binaryUrl);
            const arrayBuffer = yield res.arrayBuffer();
            return new File([arrayBuffer], name, { type: contentType });
        });
    }
    /**
     * Gets the last configuration update operation for given device.
     * Looks for c8y_Configuration and c8y_SendConfiguration operations.
     * @param deviceId The ID of the device to find an operation for.
     */
    getLastConfigUpdateOperation(deviceId) {
        return __awaiter(this, void 0, void 0, function* () {
            const filters = {
                deviceId,
                dateFrom: new Date(0).toISOString(),
                dateTo: new Date(Date.now()).toISOString(),
                revert: true,
                pageSize: 1
            };
            return this.getLatestMatchingOperation([
                Object.assign(Object.assign({}, filters), { fragmentType: 'c8y_Configuration' }),
                Object.assign(Object.assign({}, filters), { fragmentType: 'c8y_SendConfiguration' })
            ]);
        });
    }
    /**
     * Prepares a configuration download operation for given device and its current configuration.
     * Supports c8y_SendConfiguration operation.
     * @param device The device for which operation should be prepared.
     */
    createTextBasedConfigurationReloadOperation(device) {
        return {
            deviceId: device.id,
            description: gettext('Requested current configuration'),
            c8y_SendConfiguration: {}
        };
    }
    /**
     * Prepares a configuration update operation for the given device.
     * Supports c8y_Configuration operation.
     * @param device The device for which operation should be prepared.
     * @param config The configuration which will update the existing one.
     */
    createTextBasedConfigurationUpdateOperation(device, config) {
        return {
            deviceId: device.id,
            description: gettext('Configuration update'),
            c8y_Configuration: {
                config
            }
        };
    }
    getBinary(binaryId) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                return yield this.inventoryBinary.download(binaryId);
            }
            catch (ex) {
                const msg = gettext('Could not get the binary.');
                this.alert.danger(msg);
            }
        });
    }
    /**
     * Gets all available snapshots from the repository for the given device.
     * @param device The device for which the snapshots should be prepared.
     * @param configurationType Selected configuration type.
     */
    getSnapshotsFromRepository(device, configurationType) {
        return __awaiter(this, void 0, void 0, function* () {
            const searchQuery = this.getConfigurationTypeQuery(device, configurationType);
            const res = yield this.listRepositoryEntries(RepositoryType.CONFIGURATION, {
                query: searchQuery,
                params: { pageSize: 100 }
            });
            return res.data;
        });
    }
    /**
     * Returns a binary object.
     * @param binaryId binary ID
     * @param options The object with additional options:
     * - **noAlerts** - `boolean` - do not display an alert message; defaults to `false`
     */
    getInternalBinaryResponse(binaryId, options = {}) {
        return __awaiter(this, void 0, void 0, function* () {
            let res;
            try {
                res = yield this.inventoryBinary.download(binaryId);
            }
            catch (ex) {
                if (!options.noAlerts) {
                    const msg = gettext('Could not get the binary.');
                    this.alert.danger(msg);
                }
            }
            return res;
        });
    }
    /**
     * Returns a binary object.
     * @param binaryUrl The URL to find binary
     * @param options The object with additional options:
     * - **noAlerts** - `boolean` - do not display an alert message; defaults to `false`
     */
    getExternalBinaryResponse(binaryUrl, options = {}) {
        return __awaiter(this, void 0, void 0, function* () {
            let res;
            try {
                const fetchRes = yield fetch(binaryUrl);
                if (fetchRes.status >= 400) {
                    throw res;
                }
                res = fetchRes;
            }
            catch (_a) {
                if (!options.noAlerts) {
                    const msg = gettext('Could not get the external binary');
                    this.alert.danger(msg);
                }
            }
            return res;
        });
    }
    createEntry(mo) {
        return __awaiter(this, void 0, void 0, function* () {
            const binaryId = yield this.inventoryBinary.getIdFromUrl(mo.url);
            const newMo = yield this.inventory.create(mo);
            if (binaryId) {
                yield this.inventory.childAdditionsAdd(binaryId, newMo.data);
            }
            return newMo;
        });
    }
    updateEntry(mo, url) {
        return __awaiter(this, void 0, void 0, function* () {
            const existingBinaryId = yield this.inventoryBinary.getIdFromUrl(url);
            const newBinaryId = yield this.inventoryBinary.getIdFromUrl(mo.url);
            if (existingBinaryId && existingBinaryId !== newBinaryId) {
                const id = this.inventoryBinary.getIdFromUrl(url);
                yield this.inventoryBinary.delete(id);
            }
            if (newBinaryId) {
                yield this.inventory.childAdditionsAdd(newBinaryId, mo);
            }
            return this.inventory.update(mo);
        });
    }
    getBaseVersionResultListForLegacyEntry(entry) {
        return Promise.resolve({
            res: {},
            data: [
                Object.assign(Object.assign({}, entry), { [entry.type]: {
                        version: entry.version,
                        url: entry.url
                    } })
            ]
        });
    }
    getDeviceSoftwareChangesFromSoftwareListOperation(operation, device) {
        const changes = [];
        forEach(device.c8y_SoftwareList, deviceSoftware => {
            const operationSoftware = find(operation.c8y_SoftwareList, { name: deviceSoftware.name });
            if ((operationSoftware && operationSoftware.version) !==
                (deviceSoftware && deviceSoftware.version)) {
                changes.push(Object.assign(Object.assign({}, deviceSoftware), { action: 'delete' }));
            }
        });
        forEach(operation.c8y_SoftwareList, operationSoftware => {
            const deviceSoftware = find(device.c8y_SoftwareList, { name: operationSoftware.name });
            if ((operationSoftware && operationSoftware.version) !==
                (deviceSoftware && deviceSoftware.version)) {
                changes.push(Object.assign(Object.assign({}, operationSoftware), { action: 'install' }));
            }
        });
        return changes;
    }
    getDeviceSoftwareChangesFromSoftwareOperation(operation, device) {
        const changes = [];
        forEach(device.c8y_Software, (deviceSoftwareVersion, deviceSoftwareName) => {
            if (operation.c8y_Software[deviceSoftwareName] !== deviceSoftwareVersion) {
                changes.push({
                    name: deviceSoftwareName,
                    version: deviceSoftwareVersion,
                    action: 'delete'
                });
            }
        });
        forEach(operation.c8y_Software, (operationSoftwareVersion, operationSoftwareName) => {
            const deviceSoftwareVersion = device.c8y_Software && device.c8y_Software[operationSoftwareName];
            if (deviceSoftwareVersion !== operationSoftwareVersion) {
                changes.push({
                    name: operationSoftwareName,
                    version: operationSoftwareVersion,
                    action: 'install'
                });
            }
        });
        return changes;
    }
}
RepositoryService.decorators = [
    { type: Injectable }
];
RepositoryService.ctorParameters = () => [
    { type: InventoryService },
    { type: InventoryBinaryService },
    { type: OperationService },
    { type: AlertService },
    { type: EventService },
    { type: OperationRealtimeService },
    { type: EventBinaryService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3NpdG9yeS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vcmVwb3NpdG9yeS9yZXBvc2l0b3J5LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUNMLGtCQUFrQixFQUNsQixZQUFZLEVBT1osc0JBQXNCLEVBQ3RCLGdCQUFnQixFQUloQixnQkFBZ0IsRUFDaEIsZUFBZSxFQUNmLFdBQVcsRUFDWixNQUFNLGFBQWEsQ0FBQztBQUNyQixPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RGLE9BQU8sRUFDTCxNQUFNLEVBQ04sU0FBUyxFQUNULElBQUksRUFDSixPQUFPLEVBQ1AsR0FBRyxFQUNILElBQUksRUFDSixLQUFLLEVBQ0wsUUFBUSxFQUNSLFdBQVcsRUFDWCxHQUFHLElBQUksSUFBSSxFQUNYLElBQUksRUFDSixNQUFNLEVBQ04sR0FBRyxFQUNKLE1BQU0sV0FBVyxDQUFDO0FBQ25CLE9BQU8sRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBYyxFQUFFLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RFLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pGLE9BQU8sRUFVTCxjQUFjLEVBQ2QsdUJBQXVCLEVBR3hCLE1BQU0sb0JBQW9CLENBQUM7QUFHNUIsTUFBTSxPQUFPLGlCQUFpQjtJQUs1QixZQUNVLFNBQTJCLEVBQzNCLGVBQXVDLEVBQ3ZDLFNBQTJCLEVBQzNCLEtBQW1CLEVBQ25CLEtBQW1CLEVBQ25CLGlCQUEyQyxFQUMzQyxXQUErQjtRQU4vQixjQUFTLEdBQVQsU0FBUyxDQUFrQjtR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Qyx3QkFBd0IsRUFBRSxxQkFBcUIsRUFBRSxFQUFFO1lBQ2xGLE1BQU0scUJBQXFCLEdBQ3pCLE1BQU0sQ0FBQyxZQUFZLElBQUksTUFBTSxDQUFDLFlBQVksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1lBQ3BFLElBQUkscUJBQXFCLEtBQUssd0JBQXdCLEVBQUU7Z0JBQ3RELE9BQU8sQ0FBQyxJQUFJLENBQUM7b0JBQ1gsSUFBSSxFQUFFLHFCQUFxQjtvQkFDM0IsT0FBTyxFQUFFLHdCQUF3QjtvQkFDakMsTUFBTSxFQUFFLFNBQVM7aUJBQ00sQ0FBQyxDQUFDO2FBQzVCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDOzs7WUF0ckNGLFVBQVU7OztZQTFDVCxnQkFBZ0I7WUFEaEIsc0JBQXNCO1lBS3RCLGdCQUFnQjtZQUlULFlBQVk7WUFoQm5CLFlBQVk7WUFnQmtCLHdCQUF3QjtZQWpCdEQsa0JBQWtCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgRXZlbnRCaW5hcnlTZXJ2aWNlLFxuICBFdmVudFNlcnZpY2UsXG4gIElkUmVmZXJlbmNlLFxuICBJRXZlbnQsXG4gIElGZXRjaFJlc3BvbnNlLFxuICBJSWRlbnRpZmllZCxcbiAgSU1hbmFnZWRPYmplY3QsXG4gIElNYW5hZ2VkT2JqZWN0QmluYXJ5LFxuICBJbnZlbnRvcnlCaW5hcnlTZXJ2aWNlLFxuICBJbnZlbnRvcnlTZXJ2aWNlLFxuICBJT3BlcmF0aW9uLFxuICBJUmVzdWx0LFxuICBJUmVzdWx0TGlzdCxcbiAgT3BlcmF0aW9uU2VydmljZSxcbiAgT3BlcmF0aW9uU3RhdHVzLFxuICBRdWVyaWVzVXRpbFxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UsIGdldHRleHQsIE9wZXJhdGlvblJlYWx0aW1lU2VydmljZSB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHtcbiAgYXNzaWduLFxuICBjbG9uZURlZXAsXG4gIGZpbmQsXG4gIGZvckVhY2gsXG4gIGdldCxcbiAgaGVhZCxcbiAgaXNOaWwsXG4gIGlzU3RyaW5nLFxuICBpc1VuZGVmaW5lZCxcbiAgbWFwIGFzIF9tYXAsXG4gIHBpY2ssXG4gIHJlbW92ZSxcbiAgc2V0XG59IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBkZWZlciwgZnJvbSwgbWVyZ2UsIE9ic2VydmFibGUsIG9mLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCwgc3dpdGNoTWFwLCB0YWtlLCB0YWtlV2hpbGUsIHdpdGhMYXRlc3RGcm9tIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtcbiAgQ29uZmlndXJhdGlvblNuYXBzaG90LFxuICBEZXZpY2VGaXJtd2FyZSxcbiAgRGV2aWNlU29mdHdhcmUsXG4gIERldmljZVNvZnR3YXJlQ2hhbmdlLFxuICBGaXJtd2FyZUJpbmFyeSxcbiAgRmlybXdhcmVQYXRjaEJpbmFyeSxcbiAgTW9kYWxNb2RlbCxcbiAgUmVwb3NpdG9yeUJpbmFyeSxcbiAgUmVwb3NpdG9yeUNhdGVnb3J5LFxuICBSZXBvc2l0b3J5VHlwZSxcbiAgUkVQT1NJVE9SWV9CSU5BUllfVFlQRVMsXG4gIFNlbGVjdGVkUmVwb3NpdG9yeUJpbmFyeSxcbiAgU29mdHdhcmVCaW5hcnlcbn0gZnJvbSAnLi9yZXBvc2l0b3J5Lm1vZGVsJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFJlcG9zaXRvcnlTZXJ2aWNlIHtcbiAgcmVhZG9ubHkgZGF0ZUZyb20gPSBuZXcgRGF0ZSgwKTtcbiAgcmVhZG9ubHkgZGF0ZVRvID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIDg2NDAwMDAwKTsgLy8gMSBkYXkgaW4gdGhlIGZ1dHVyZVxuICBwcml2YXRlIHF1ZXJpZXNVdGlsOiBRdWVyaWVzVXRpbDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGludmVudG9yeTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeUJpbmFyeTogSW52ZW50b3J5QmluYXJ5U2VydmljZSxcbiAgICBwcml2YXRlIG9wZXJhdGlvbjogT3BlcmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0OiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBldmVudDogRXZlbnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgb3BlcmF0aW9uUmVhbHRpbWU6IE9wZXJhdGlvblJlYWx0aW1lU2VydmljZSxcbiAgICBwcml2YXRlIGV2ZW50QmluYXJ5OiBFdmVudEJpbmFyeVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5xdWVyaWVzVXRpbCA9IG5ldyBRdWVyaWVzVXRpbCgpO1xuICB9XG5cbiAgLyoqXG4gICAqIExpc3RzIHJlcG9zaXRvcnkgZW50cmllcyBvZiBnaXZlbiB0eXBlLlxuICAgKiBAcGFyYW0gdHlwZSBUaGUgdHlwZSBvZiByZXBvc2l0b3J5IGVudHJpZXMgdG8gbGlzdC5cbiAgICogQHBhcmFtIG9wdGlvbnMgRXh0cmEgbGlzdGluZyBvcHRpb25zLlxuICAgKi9cbiAgbGlzdFJlcG9zaXRvcnlFbnRyaWVzKFxuICAgIHR5cGU6IFJlcG9zaXRvcnlUeXBlLFxuICAgIG9wdGlvbnM/OiB7XG4gICAgICAvKiogQWRkaXRpb25hbCBxdWVyeS4gKi9cbiAgICAgIHF1ZXJ5PzogYW55O1xuICAgICAgLyoqIChkZXByZWNhdGVkIC0gdG8gYmUgcmVtb3ZlZCkgT25seSBpbmNsdWRlIGVudHJpZXMgd2l0aCBtYXRjaGluZyBwYXJ0aWFsIG5hbWVzLiAqL1xuICAgICAgcGFydGlhbE5hbWU/OiBzdHJpbmc7XG4gICAgICAvKiogSW5jbHVkZSBlbnRyaWVzIHdpdGggbWF0Y2hpbmcgcGFydGlhbCB0ZXh0IGluIHRoZSBzcGVjaWZpZWQgcHJvcGVydGllcy4gKi9cbiAgICAgIHBhcnRpYWxUZXh0RmlsdGVyPzogeyBwYXJ0aWFsVGV4dDogc3RyaW5nOyBwcm9wZXJ0aWVzOiBzdHJpbmdbXSB9O1xuICAgICAgLyoqIEV4Y2x1ZGUgbGVnYWN5IGVudHJpZXMuICovXG4gICAgICBza2lwTGVnYWN5PzogYm9vbGVhbjtcbiAgICAgIC8qKiBFeGNsdWRlIGRlZmF1bHQgb3JkZXJpbmcuICovXG4gICAgICBza2lwRGVmYXVsdE9yZGVyPzogYm9vbGVhbjtcbiAgICAgIC8qKiBPdGhlciByZXF1ZXN0IHBhcmFtcy4gKi9cbiAgICAgIHBhcmFtcz86IGFueTtcbiAgICB9XG4gICkge1xuICAgIGNvbnN0IGRlZmF1bHRPcmRlciA9IFt7IG5hbWU6IDEgfV07XG4gICAgY29uc3QgZGVmYXVsdEZpbHRlcnMgPSB7IHR5cGUgfTtcbiAgICBjb25zdCBsZWdhY3lGaWx0ZXJzID0geyBfX2hhczogYHVybGAgfTtcbiAgICBsZXQgZmlsdGVycyA9IHt9O1xuXG4gICAgbGV0IGZ1bGxRdWVyeSA9IChvcHRpb25zICYmIG9wdGlvbnMucXVlcnkpIHx8IHt9O1xuICAgIGlmICghb3B0aW9ucyB8fCAob3B0aW9ucyAmJiAhb3B0aW9ucy5za2lwRGVmYXVsdE9yZGVyKSkge1xuICAgICAgZnVsbFF1ZXJ5ID0gdGhpcy5xdWVyaWVzVXRpbC5hZGRPcmRlcmJ5cyhmdWxsUXVlcnksIGRlZmF1bHRPcmRlciwgJ3ByZXBlbmQnKTtcbiAgICB9XG5cbiAgICBmdWxsUXVlcnkgPSB0aGlzLnF1ZXJpZXNVdGlsLmFkZEFuZEZpbHRlcihmdWxsUXVlcnksIGRlZmF1bHRGaWx0ZXJzKTtcblxuICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucGFydGlhbFRleHRGaWx0ZXIpIHtcbiAgICAgIGNvbnN0IHsgcGFydGlhbFRleHQsIHByb3BlcnRpZXMgfSA9IG9wdGlvbnMucGFydGlhbFRleHRGaWx0ZXI7XG4gICAgICBjb25zdCBvckZpbHRlciA9IHsgX19vcjogcHJvcGVydGllcy5tYXAocHJvcGVydHkgPT4gKHsgW3Byb3BlcnR5XTogYCoke3BhcnRpYWxUZXh0fSpgIH0pKSB9O1xuICAgICAgZnVsbFF1ZXJ5ID0gdGhpcy5xdWVyaWVzVXRpbC5hZGRBbmRGaWx0ZXIoZnVsbFF1ZXJ5LCBvckZpbHRlcik7XG4gICAgfVxuXG4gICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5wYXJ0aWFsTmFtZSkge1xuICAgICAgLy8gYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgaWZcbiAgICAgIGZ1bGxRdWVyeSA9IHRoaXMucXVlcmllc1V0aWwuYWRkQW5kRmlsdGVyKGZ1bGxRdWVyeSwgeyBuYW1lOiBgKiR7b3B0aW9ucy5wYXJ0aWFsTmFtZX0qYCB9KTtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnNraXBMZWdhY3kpIHtcbiAgICAgIGZ1bGxRdWVyeSA9IHRoaXMucXVlcmllc1V0aWwuYWRkQW5kRmlsdGVyKGZ1bGxRdWVyeSwgeyBfX25vdDogbGVnYWN5RmlsdGVycyB9KTtcbiAgICB9XG5cbiAgICBmaWx0ZXJzID0ge1xuICAgICAgcXVlcnk6IHRoaXMucXVlcmllc1V0aWwuYnVpbGRRdWVyeShmdWxsUXVlcnkpLFxuICAgICAgcGFnZVNpemU6IDUwLFxuICAgICAgd2l0aFRvdGFsUGFnZXM6IHRydWUsXG4gICAgICAuLi4oKG9wdGlvbnMgJiYgb3B0aW9ucy5wYXJhbXMpIHx8IHt9KVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5Lmxpc3QoZmlsdGVycyk7XG4gIH1cblxuICAvLyBUT0RPOiBtZXJnZSB3aXRoIGNyZWF0ZSgpXG4gIGFzeW5jIHNhdmUoZGF0YTogTW9kYWxNb2RlbCwgdHlwZTogUmVwb3NpdG9yeVR5cGUsIG1vOiBQYXJ0aWFsPElNYW5hZ2VkT2JqZWN0PiA9IHt9KSB7XG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlIFJlcG9zaXRvcnlUeXBlLkNPTkZJR1VSQVRJT046IHtcbiAgICAgICAgT2JqZWN0LmFzc2lnbihtbywge1xuICAgICAgICAgIHR5cGU6IFJlcG9zaXRvcnlUeXBlLkNPTkZJR1VSQVRJT04sXG4gICAgICAgICAgY29uZmlndXJhdGlvblR5cGU6IGRhdGEuc2VsZWN0ZWQgPyBkYXRhLnNlbGVjdGVkLmNvbmZpZ3VyYXRpb25UeXBlIDogdW5kZWZpbmVkLFxuICAgICAgICAgIG5hbWU6IGRhdGEudmVyc2lvbixcbiAgICAgICAgICBkZXNjcmlwdGlvbjogZGF0YS5kZXNjcmlwdGlvbixcbiAgICAgICAgICBkZXZpY2VUeXBlOiBkYXRhLmRldmljZVR5cGUsXG4gICAgICAgICAgYzh5X0dsb2JhbDoge31cbiAgICAgICAgfSk7XG4gICAgICAgIGlmICghZGF0YS5kZXZpY2VUeXBlICYmIG1vLmlkKSB7XG4gICAgICAgICAgbW8uZGV2aWNlVHlwZSA9IG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFkYXRhLnNlbGVjdGVkICYmIG1vLmlkKSB7XG4gICAgICAgICAgbW8uY29uZmlndXJhdGlvblR5cGUgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGV4aXN0aW5nVXJsID0gbW8udXJsO1xuICAgIGlmIChkYXRhLmJpbmFyeS51cmwpIHtcbiAgICAgIG1vLnVybCA9IGRhdGEuYmluYXJ5LnVybDtcbiAgICB9IGVsc2UgaWYgKGRhdGEuYmluYXJ5LmZpbGUpIHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlCaW5hcnkuY3JlYXRlKGRhdGEuYmluYXJ5LmZpbGUsIHtcbiAgICAgICAgYzh5X0dsb2JhbDoge31cbiAgICAgIH0gYXMgUGFydGlhbDxJTWFuYWdlZE9iamVjdD4pO1xuICAgICAgbW8udXJsID0gcmVzcG9uc2UuZGF0YS5zZWxmO1xuICAgIH1cblxuICAgIGlmIChtby5pZCkge1xuICAgICAgcmV0dXJuIHRoaXMudXBkYXRlRW50cnkobW8sIGV4aXN0aW5nVXJsKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlRW50cnkobW8pO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlKG1vZGFsOiBNb2RhbE1vZGVsLCB0eXBlOiBSZXBvc2l0b3J5VHlwZSkge1xuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSBSZXBvc2l0b3J5VHlwZS5GSVJNV0FSRTpcbiAgICAgIGNhc2UgUmVwb3NpdG9yeVR5cGUuU09GVFdBUkU6XG4gICAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUZpcm13YXJlT3JTb2Z0d2FyZShtb2RhbCwgdHlwZSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgY3JlYXRlRmlybXdhcmVPclNvZnR3YXJlKFxuICAgIG1vZGFsOiBNb2RhbE1vZGVsLFxuICAgIHR5cGU6IFJlcG9zaXRvcnlUeXBlXG4gICk6IFByb21pc2U8UmVwb3NpdG9yeUNhdGVnb3J5PiB7XG4gICAgbGV0IGJpbmFyeTogSU1hbmFnZWRPYmplY3RCaW5hcnk7XG4gICAgbGV0IGJpbmFyeVVSTDogc3RyaW5nO1xuICAgIGxldCByZXBvc2l0b3J5RW50cnk6IFJlcG9zaXRvcnlDYXRlZ29yeTtcbiAgICBsZXQgcmVwb3NpdG9yeUJpbmFyeTogRmlybXdhcmVCaW5hcnkgfCBTb2Z0d2FyZUJpbmFyeTtcbiAgICBjb25zdCBtb3MgPSBbXTtcbiAgICBjb25zdCB7XG4gICAgICBzZWxlY3RlZDogeyBpZDogc2VsZWN0ZWRJZCB9LFxuICAgICAgYmluYXJ5OiB7IGZpbGUsIHVybCB9XG4gICAgfSA9IG1vZGFsO1xuICAgIHRyeSB7XG4gICAgICBpZiAoZmlsZSkge1xuICAgICAgICAoeyBkYXRhOiBiaW5hcnkgfSA9IGF3YWl0IHRoaXMuc2F2ZUJpbmFyeShmaWxlKSk7XG4gICAgICAgICh7IHNlbGY6IGJpbmFyeVVSTCB9ID0gYmluYXJ5KTtcbiAgICAgICAgbW9zLnB1c2goYmluYXJ5KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGJpbmFyeVVSTCA9IHVybDtcbiAgICAgIH1cblxuICAgICAgKHsgZGF0YTogcmVwb3NpdG9yeUVudHJ5IH0gPSBhd2FpdCB0aGlzLmNyZWF0ZU9yVXBkYXRlUmVwb3NpdG9yeUVudHJ5KG1vZGFsLCB0eXBlKSk7XG4gICAgICBpZiAoaXNOaWwoc2VsZWN0ZWRJZCkpIHtcbiAgICAgICAgbW9zLnB1c2gocmVwb3NpdG9yeUVudHJ5KTtcbiAgICAgIH1cblxuICAgICAgKHsgZGF0YTogcmVwb3NpdG9yeUJpbmFyeSB9ID0gYXdhaXQgdGhpcy5jcmVhdGVSZXBvc2l0b3J5QmluYXJ5KFxuICAgICAgICBtb2RhbCxcbiAgICAgICAgYmluYXJ5VVJMLFxuICAgICAgICB0eXBlLFxuICAgICAgICByZXBvc2l0b3J5RW50cnlcbiAgICAgICkpO1xuICAgICAgbW9zLnB1c2gocmVwb3NpdG9yeUJpbmFyeSk7XG5cbiAgICAgIGlmIChmaWxlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMubGlua0JpbmFyeShyZXBvc2l0b3J5QmluYXJ5LCBiaW5hcnkpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVwb3NpdG9yeUVudHJ5O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmNsZWFuVXAobW9zKTtcbiAgICAgIHRoaXMuZXJyb3JNc2coKTtcblxuICAgICAgLy8gUHJvcGFnYXRlIGVycm9yXG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICBzYXZlQmluYXJ5KGZpbGU6IEZpbGUpOiBQcm9taXNlPElSZXN1bHQ8SU1hbmFnZWRPYmplY3RCaW5hcnk+PiB7XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5QmluYXJ5LmNyZWF0ZShmaWxlLCB7IGM4eV9HbG9iYWw6IHt9IH0gYXMgUGFydGlhbDxJTWFuYWdlZE9iamVjdD4pO1xuICB9XG5cbiAgY3JlYXRlT3JVcGRhdGVSZXBvc2l0b3J5RW50cnkoXG4gICAgbW9kYWw6IE1vZGFsTW9kZWwsXG4gICAgdHlwZTogUmVwb3NpdG9yeVR5cGVcbiAgKTogUHJvbWlzZTxJUmVzdWx0PFJlcG9zaXRvcnlDYXRlZ29yeT4+IHtcbiAgICBjb25zdCB7XG4gICAgICBzZWxlY3RlZDogeyBpZCwgbmFtZSB9LFxuICAgICAgZGVzY3JpcHRpb24sXG4gICAgICBkZXZpY2VUeXBlXG4gICAgfSA9IG1vZGFsO1xuXG4gICAgY29uc3QgbW8gPSB7XG4gICAgICBpZCxcbiAgICAgIG5hbWU6IGlkID8gdW5kZWZpbmVkIDogbmFtZSxcbiAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgdHlwZTogaWQgPyB1bmRlZmluZWQgOiB0eXBlLFxuICAgICAgYzh5X0dsb2JhbDoge31cbiAgICB9O1xuXG4gICAgaWYgKGRldmljZVR5cGUpIHtcbiAgICAgIHNldChtbywgJ2M4eV9GaWx0ZXIudHlwZScsIGRldmljZVR5cGUpO1xuICAgIH1cblxuICAgIGlmIChtb2RhbC5zb2Z0d2FyZVR5cGUpIHtcbiAgICAgIHNldChtbywgJ3NvZnR3YXJlVHlwZScsIG1vZGFsLnNvZnR3YXJlVHlwZS5zb2Z0d2FyZVR5cGUpO1xuICAgIH1cblxuICAgIHJldHVybiBpZFxuICAgICAgPyAodGhpcy5pbnZlbnRvcnkudXBkYXRlKG1vKSBhcyBQcm9taXNlPElSZXN1bHQ8UmVwb3NpdG9yeUNhdGVnb3J5Pj4pXG4gICAgICA6ICh0aGlzLmludmVudG9yeS5jcmVhdGUobW8pIGFzIFByb21pc2U8SVJlc3VsdDxSZXBvc2l0b3J5Q2F0ZWdvcnk+Pik7XG4gIH1cblxuICBjcmVhdGVSZXBvc2l0b3J5QmluYXJ5KFxuICAgIG1vZGFsOiBNb2RhbE1vZGVsLFxuICAgIGJpbmFyeVVSTDogc3RyaW5nLFxuICAgIHR5cGU6IFJlcG9zaXRvcnlUeXBlLFxuICAgIHBhcmVudDogUmVwb3NpdG9yeUNhdGVnb3J5XG4gICk6IFByb21pc2U8SVJlc3VsdDxGaXJtd2FyZUJpbmFyeSB8IFNvZnR3YXJlQmluYXJ5IHwgRmlybXdhcmVQYXRjaEJpbmFyeT4+IHtcbiAgICBjb25zdCBtbyA9IHRoaXMucHJlcGFyZVJlcG9zaXRvcnlCaW5hcnlNTyhtb2RhbCwgYmluYXJ5VVJMLCB0eXBlKTtcblxuICAgIHJldHVybiB0aGlzLmludmVudG9yeS5jaGlsZEFkZGl0aW9uc0NyZWF0ZShtbywgcGFyZW50KSBhcyBQcm9taXNlPFxuICAgICAgSVJlc3VsdDxGaXJtd2FyZUJpbmFyeSB8IFNvZnR3YXJlQmluYXJ5IHwgRmlybXdhcmVQYXRjaEJpbmFyeT5cbiAgICA+O1xuICB9XG5cbiAgcHJlcGFyZVJlcG9zaXRvcnlCaW5hcnlNTyhtb2RhbDogTW9kYWxNb2RlbCwgYmluYXJ5VVJMOiBzdHJpbmcsIHR5cGU6IFJlcG9zaXRvcnlUeXBlKSB7XG4gICAgY29uc3QgeyB2ZXJzaW9uLCBwYXRjaFZlcnNpb24sIGRlcGVuZGVuY3kgfSA9IG1vZGFsO1xuICAgIGNvbnN0IHJlc3VsdCA9IHtcbiAgICAgIHR5cGU6IFJFUE9TSVRPUllfQklOQVJZX1RZUEVTW3R5cGVdLFxuICAgICAgW3R5cGVdOiB7XG4gICAgICAgIHVybDogYmluYXJ5VVJMXG4gICAgICB9LFxuICAgICAgYzh5X0dsb2JhbDoge31cbiAgICB9O1xuXG4gICAgaWYgKGRlcGVuZGVuY3kpIHtcbiAgICAgIHNldChyZXN1bHQsIFt0eXBlLCAndmVyc2lvbiddLCBwYXRjaFZlcnNpb24pO1xuICAgICAgYXNzaWduKHJlc3VsdCwge1xuICAgICAgICBjOHlfUGF0Y2g6IHtcbiAgICAgICAgICBkZXBlbmRlbmN5OiBkZXBlbmRlbmN5LmM4eV9GaXJtd2FyZS52ZXJzaW9uXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZXQocmVzdWx0LCBbdHlwZSwgJ3ZlcnNpb24nXSwgdmVyc2lvbik7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBhc3luYyBsaW5rQmluYXJ5KFxuICAgIHJlcG9zaXRvcnlCaW5hcnk6IEZpcm13YXJlQmluYXJ5IHwgU29mdHdhcmVCaW5hcnksXG4gICAgYmluYXJ5OiBJTWFuYWdlZE9iamVjdEJpbmFyeVxuICApIHtcbiAgICBjb25zdCB7IGlkOiByZXBvc2l0b3J5QmluYXJ5SWQgfSA9IHJlcG9zaXRvcnlCaW5hcnk7XG4gICAgaWYgKGJpbmFyeSkge1xuICAgICAgY29uc3QgeyBpZDogYmluYXJ5SWQgfSA9IGJpbmFyeTtcbiAgICAgIHJldHVybiB0aGlzLmludmVudG9yeS5jaGlsZEFkZGl0aW9uc0FkZChiaW5hcnlJZCwgcmVwb3NpdG9yeUJpbmFyeUlkKTtcbiAgICB9XG4gIH1cblxuICBjbGVhblVwKG1vc1RvRGVsZXRlOiBJSWRlbnRpZmllZFtdKSB7XG4gICAgbW9zVG9EZWxldGUuZm9yRWFjaChtbyA9PiB7XG4gICAgICBjb25zdCB7IGM4eV9Jc0JpbmFyeSB9ID0gbW87XG4gICAgICBpc1VuZGVmaW5lZChjOHlfSXNCaW5hcnkpID8gdGhpcy5kZWxldGUobW8pIDogdGhpcy5pbnZlbnRvcnlCaW5hcnkuZGVsZXRlKG1vKTtcbiAgICB9KTtcbiAgfVxuXG4gIGRlbGV0ZShlbnRpdHk6IElJZGVudGlmaWVkKTogUHJvbWlzZTxJUmVzdWx0PG51bGw+PiB7XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5LmRlbGV0ZShlbnRpdHksIHsgZm9yY2VDYXNjYWRlOiB0cnVlIH0pO1xuICB9XG5cbiAgZXJyb3JNc2coKSB7XG4gICAgY29uc3QgbXNnID0gZ2V0dGV4dCgnRmFpbGVkIHRvIHNhdmUnKTtcbiAgICB0aGlzLmFsZXJ0LmRhbmdlcihtc2cpO1xuICB9XG5cbiAgZ2V0QmFzZVZlcnNpb25zQ291bnQkKGVudHJ5OiBJTWFuYWdlZE9iamVjdCk6IE9ic2VydmFibGU8bnVtYmVyPiB7XG4gICAgaWYgKHRoaXMuaXNMZWdhY3lFbnRyeShlbnRyeSkpIHtcbiAgICAgIHJldHVybiBvZigxKTtcbiAgICB9XG4gICAgcmV0dXJuIGZyb20odGhpcy5saXN0QmFzZVZlcnNpb25zKGVudHJ5LCB7IHBhZ2VTaXplOiAxLCB3aXRoVG90YWxQYWdlczogdHJ1ZSB9KSkucGlwZShcbiAgICAgIG1hcCgoeyBwYWdpbmcgfSkgPT4gcGFnaW5nLnRvdGFsUGFnZXMpXG4gICAgKTtcbiAgfVxuXG4gIGdldEJhc2VWZXJzaW9uRnJvbU1PKG1vOiBSZXBvc2l0b3J5QmluYXJ5KTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5pc1BhdGNoKG1vKSA/IGdldChtbywgJ2M4eV9QYXRjaC5kZXBlbmRlbmN5JykgOiBnZXQobW8sICdjOHlfRmlybXdhcmUudmVyc2lvbicpO1xuICB9XG5cbiAgaXNQYXRjaChtbzogUmVwb3NpdG9yeUJpbmFyeSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhIWdldChtbywgJ2M4eV9QYXRjaC5kZXBlbmRlbmN5Jyk7XG4gIH1cblxuICBnZXRQYXRjaFZlcnNpb25zQ291bnQkKGVudHJ5OiBJTWFuYWdlZE9iamVjdCwgYmFzZVZlcnNpb246IEZpcm13YXJlQmluYXJ5KTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICBpZiAodGhpcy5pc0xlZ2FjeUVudHJ5KGJhc2VWZXJzaW9uKSkge1xuICAgICAgcmV0dXJuIG9mKDApO1xuICAgIH1cbiAgICByZXR1cm4gZnJvbShcbiAgICAgIHRoaXMubGlzdFBhdGNoVmVyc2lvbnMoZW50cnksIGJhc2VWZXJzaW9uLCB7IHBhZ2VTaXplOiAxLCB3aXRoVG90YWxQYWdlczogdHJ1ZSB9KVxuICAgICkucGlwZShtYXAoKHsgcGFnaW5nIH0pID0+IHBhZ2luZy50b3RhbFBhZ2VzKSk7XG4gIH1cblxuICBpc0xlZ2FjeUVudHJ5KGVudHJ5OiBQYXJ0aWFsPElNYW5hZ2VkT2JqZWN0Pik6IGJvb2xlYW4ge1xuICAgIHJldHVybiBCb29sZWFuKGVudHJ5LnVybCk7XG4gIH1cblxuICAvKipcbiAgICogTGlzdHMgYWxsIHZlcnNpb25zIChiYXNlIGFuZCBwYXRjaCBvbmVzKSBvZiBnaXZlbiB0b3AgbGV2ZWwgZW50cnkuXG4gICAqIFZlcnNpb25zIGFyZSBvcmRlcmVkIGJ5IGNyZWF0aW9uIHRpbWUgKGFzc3VtaW5nIHRoZSBlYXJsaWVyIGNyZWF0ZWQsIHRoZSBvbGRlciB0aGUgdmVyc2lvbikuXG4gICAqIEBwYXJhbSBlbnRyeSBUb3AgbGV2ZWwgcmVwb3NpdG9yeSBlbnRyeS5cbiAgICogQHBhcmFtIHBhcmFtcyBBZGRpdGlvbmFsIHF1ZXJ5IHBhcmFtcy5cbiAgICovXG4gIGxpc3RBbGxWZXJzaW9ucyhlbnRyeTogUGFydGlhbDxJTWFuYWdlZE9iamVjdD4sIHBhcmFtcyA9IHt9KSB7XG4gICAgaWYgKHRoaXMuaXNMZWdhY3lFbnRyeShlbnRyeSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldEJhc2VWZXJzaW9uUmVzdWx0TGlzdEZvckxlZ2FjeUVudHJ5KGVudHJ5KTtcbiAgICB9XG5cbiAgICBjb25zdCBWRVJTSU9OX0ZJTFRFUl9PUkRFUiA9IHtcbiAgICAgIF9fZmlsdGVyOiB7fSxcbiAgICAgIF9fb3JkZXJieTogW3sgJ2NyZWF0aW9uVGltZS5kYXRlJzogLTEgfSwgeyBjcmVhdGlvblRpbWU6IC0xIH1dXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5saXN0Q2hpbGRyZW4oZW50cnksIFZFUlNJT05fRklMVEVSX09SREVSLCBwYXJhbXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIExpc3RzIGJhc2UgdmVyc2lvbnMgb2YgZ2l2ZW4gdG9wIGxldmVsIGVudHJ5LlxuICAgKiBWZXJzaW9ucyBhcmUgb3JkZXJlZCBieSBjcmVhdGlvbiB0aW1lIChhc3N1bWluZyB0aGUgZWFybGllciBjcmVhdGVkLCB0aGUgb2xkZXIgdGhlIHZlcnNpb24pLlxuICAgKiBAcGFyYW0gZW50cnkgVG9wIGxldmVsIHJlcG9zaXRvcnkgZW50cnkuXG4gICAqIEBwYXJhbSBwYXJhbXMgQWRkaXRpb25hbCBxdWVyeSBwYXJhbXMuXG4gICAqL1xuICBsaXN0QmFzZVZlcnNpb25zKGVudHJ5OiBQYXJ0aWFsPElNYW5hZ2VkT2JqZWN0PiwgcGFyYW1zID0ge30pIHtcbiAgICBpZiAodGhpcy5pc0xlZ2FjeUVudHJ5KGVudHJ5KSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0QmFzZVZlcnNpb25SZXN1bHRMaXN0Rm9yTGVnYWN5RW50cnkoZW50cnkpO1xuICAgIH1cblxuICAgIGNvbnN0IE5PX1BBVENIX0ZJTFRFUl9PUkRFUiA9IHtcbiAgICAgIF9fZmlsdGVyOiB7XG4gICAgICAgIF9fbm90OiB7IF9faGFzOiAnYzh5X1BhdGNoJyB9XG4gICAgICB9LFxuICAgICAgX19vcmRlcmJ5OiBbeyAnY3JlYXRpb25UaW1lLmRhdGUnOiAtMSB9LCB7IGNyZWF0aW9uVGltZTogLTEgfV1cbiAgICB9O1xuICAgIHJldHVybiB0aGlzLmxpc3RDaGlsZHJlbihlbnRyeSwgTk9fUEFUQ0hfRklMVEVSX09SREVSLCBwYXJhbXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIExpc3RzIHBhdGNoIHZlcnNpb25zIG9mIGdpdmVuIGJhc2UgdmVyc2lvbiB1bmRlciB0aGUgZW50cnkuXG4gICAqIFZlcnNpb25zIGFyZSBvcmRlcmVkIGJ5IGNyZWF0aW9uIHRpbWUgKGFzc3VtaW5nIHRoZSBlYXJsaWVyIGNyZWF0ZWQsIHRoZSBvbGRlciB0aGUgdmVyc2lvbikuXG4gICAqIEBwYXJhbSBlbnRyeSBUb3AgbGV2ZWwgcmVwb3NpdG9yeSBlbnRyeS5cbiAgICogQHBhcmFtIGJhc2VWZXJzaW9uIEJhc2UgdmVyc2lvbi5cbiAgICogQHBhcmFtIHBhcmFtcyBBZGRpdGlvbmFsIHF1ZXJ5IHBhcmFtcy5cbiAgICovXG4gIGxpc3RQYXRjaFZlcnNpb25zKGVudHJ5OiBJTWFuYWdlZE9iamVjdCwgYmFzZVZlcnNpb246IEZpcm13YXJlQmluYXJ5IHwgc3RyaW5nLCBwYXJhbXMgPSB7fSkge1xuICAgIGNvbnN0IHZlcnNpb24gPSBpc1N0cmluZyhiYXNlVmVyc2lvbikgPyBiYXNlVmVyc2lvbiA6IGdldChiYXNlVmVyc2lvbiwgJ2M4eV9GaXJtd2FyZS52ZXJzaW9uJyk7XG4gICAgY29uc3QgUEFUQ0hfRklMVEVSX09SREVSID0ge1xuICAgICAgX19maWx0ZXI6IHtcbiAgICAgICAgJ2M4eV9QYXRjaC5kZXBlbmRlbmN5JzogdmVyc2lvblxuICAgICAgfSxcbiAgICAgIF9fb3JkZXJieTogW3sgJ2NyZWF0aW9uVGltZS5kYXRlJzogLTEgfSwgeyBjcmVhdGlvblRpbWU6IC0xIH1dXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5saXN0Q2hpbGRyZW4oZW50cnksIFBBVENIX0ZJTFRFUl9PUkRFUiwgcGFyYW1zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMaXN0cyBwYXRjaCB2ZXJzaW9ucyBvZiBnaXZlbiBiYXNlIHZlcnNpb24gdW5kZXIgdGhlIGVudHJ5IGluY2x1ZGluZyB0aGUgYmFzZSB2ZXJzaW9uLlxuICAgKiBWZXJzaW9ucyBhcmUgb3JkZXJlZCBieSBjcmVhdGlvbiB0aW1lIChhc3N1bWluZyB0aGUgZWFybGllciBjcmVhdGVkLCB0aGUgb2xkZXIgdGhlIHZlcnNpb24pLlxuICAgKiBJbiB0ZXJtcyBvZiBsZWdhY3kgYmFzZSB2ZXJzaW9uIHRoZSBlbnRyeSBnZXRzIHRyYW5zZm9ybWVkIHRvIGZpdCB0aGUgbmVlZGVkIGRhdGEgbW9kZWwuXG4gICAqIEBwYXJhbSBlbnRyeSBUb3AgbGV2ZWwgcmVwb3NpdG9yeSBlbnRyeS5cbiAgICogQHBhcmFtIGJhc2VWZXJzaW9uIEJhc2UgdmVyc2lvbi5cbiAgICogQHBhcmFtIHBhcmFtcyBBZGRpdGlvbmFsIHF1ZXJ5IHBhcmFtcy5cbiAgICovXG4gIGxpc3RCYXNlVmVyc2lvbkFuZFBhdGNoZXMoZW50cnk6IElNYW5hZ2VkT2JqZWN0LCBiYXNlVmVyc2lvbjogSU1hbmFnZWRPYmplY3QsIHBhcmFtcyA9IHt9KSB7XG4gICAgaWYgKHRoaXMuaXNMZWdhY3lFbnRyeShlbnRyeSkpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe1xuICAgICAgICBkYXRhOiBbXG4gICAgICAgICAgT2JqZWN0LmFzc2lnbihcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgYzh5X0Zpcm13YXJlOiB7XG4gICAgICAgICAgICAgICAgdmVyc2lvbjogZW50cnkudmVyc2lvbixcbiAgICAgICAgICAgICAgICB1cmw6IGVudHJ5LnVybFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZW50cnlcbiAgICAgICAgICApXG4gICAgICAgIF1cbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IFBBVENIX0ZJTFRFUl9PUkRFUiA9IHtcbiAgICAgIF9fZmlsdGVyOiB7XG4gICAgICAgIF9fb3I6IHtcbiAgICAgICAgICAnYzh5X1BhdGNoLmRlcGVuZGVuY3knOiBiYXNlVmVyc2lvbi5jOHlfRmlybXdhcmUudmVyc2lvbixcbiAgICAgICAgICAnYzh5X0Zpcm13YXJlLnZlcnNpb24nOiBiYXNlVmVyc2lvbi5jOHlfRmlybXdhcmUudmVyc2lvblxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgX19vcmRlcmJ5OiBbeyAnYzh5X1BhdGNoLmRlcGVuZGVuY3knOiAxIH0sIHsgJ2M4eV9GaXJtd2FyZS52ZXJzaW9uJzogMSB9XVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMubGlzdENoaWxkcmVuKGVudHJ5LCBQQVRDSF9GSUxURVJfT1JERVIsIHBhcmFtcyk7XG4gIH1cblxuICBsaXN0Q2hpbGRyZW4oZW50cnk6IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+LCBmaWx0ZXJzID0ge30sIHBhcmFtczogYW55ID0ge30pIHtcbiAgICBjb25zdCBjaGlsZHJlbkZpbHRlcnMgPSB7IF9fYnlncm91cGlkOiBlbnRyeS5pZCB9O1xuICAgIGNvbnN0IHF1ZXJ5ID0gdGhpcy5xdWVyaWVzVXRpbC5hZGRBbmRGaWx0ZXIoZmlsdGVycywgY2hpbGRyZW5GaWx0ZXJzKTtcbiAgICAvLyBGSVhNRTogbmVlZGVkIGJlY2F1c2Ugb2YgaXNzdWUgaW4gZm9yT2YgZGlyZWN0aXZlICguLi4pXG4gICAgcGFyYW1zLndpdGhUb3RhbFBhZ2VzID0gdHJ1ZTtcbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnkubGlzdFF1ZXJ5KHF1ZXJ5LCBwYXJhbXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIEZldGNoZXMgYWxsIGl0ZW1zIGZyb20gdGhlIGxpc3Qgc3RhcnRpbmcgd2l0aCB0aGUgcHJvdmlkZWQgcGFnZS5cbiAgICogQHBhcmFtIGZpcnN0UGFnZSBUaGUgZmlyc3QgcGFnZSBvZiB0aGUgbGlzdCB0byBmZXRjaCBhbGwgaXRlbXMgZm9yLlxuICAgKi9cbiAgYXN5bmMgZmV0Y2hBbGxJdGVtc0Zyb21MaXN0KGZpcnN0UGFnZSkge1xuICAgIGxldCBhbGxJdGVtcztcblxuICAgIGlmICghZmlyc3RQYWdlLnRoZW4pIHtcbiAgICAgIGFsbEl0ZW1zID0gWy4uLmZpcnN0UGFnZV07XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCB7IHBhZ2luZywgZGF0YTogaXRlbXMgfSA9IGF3YWl0IGZpcnN0UGFnZTtcbiAgICAgIGFsbEl0ZW1zID0gWy4uLml0ZW1zXTtcblxuICAgICAgd2hpbGUgKHBhZ2luZyAmJiBwYWdpbmcubmV4dFBhZ2UpIHtcbiAgICAgICAgKHsgcGFnaW5nLCBkYXRhOiBpdGVtcyB9ID0gYXdhaXQgcGFnaW5nLm5leHQoKSk7XG4gICAgICAgIGFsbEl0ZW1zID0gWy4uLmFsbEl0ZW1zLCAuLi5pdGVtc107XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGFsbEl0ZW1zO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgdG9wIGxldmVsIHJlcG9zaXRvcnkgZW50cnkgbWFuYWdlZCBvYmplY3QgZm9yIGJhc2Ugb3IgcGF0Y2ggdmVyc2lvbi5cbiAgICogQHBhcmFtIG1vIEJhc2Ugb3IgcGF0Y2ggdmVyc2lvbiBtYW5hZ2VkIG9iamVjdCB3aXRoIHBhcmVudHMuXG4gICAqL1xuICBnZXRSZXBvc2l0b3J5RW50cnlNTyQobW86IElNYW5hZ2VkT2JqZWN0KTogT2JzZXJ2YWJsZTxJTWFuYWdlZE9iamVjdCB8IHVuZGVmaW5lZD4ge1xuICAgIGlmICghbW8pIHtcbiAgICAgIHJldHVybiBvZih1bmRlZmluZWQpO1xuICAgIH1cbiAgICBjb25zdCBbcmVmZXJlbmNlXSA9IGdldChtbywgJ2FkZGl0aW9uUGFyZW50cy5yZWZlcmVuY2VzJyk7XG4gICAgY29uc3QgaWQgPSBnZXQocmVmZXJlbmNlLCAnbWFuYWdlZE9iamVjdC5pZCcpO1xuICAgIHJldHVybiBpZFxuICAgICAgPyBmcm9tKHRoaXMuaW52ZW50b3J5LmRldGFpbChpZCwgeyB3aXRoQ2hpbGRyZW46IGZhbHNlIH0pKS5waXBlKG1hcCgoeyBkYXRhIH0pID0+IGRhdGEpKVxuICAgICAgOiBvZih1bmRlZmluZWQpO1xuICB9XG4gIC8qKlxuICAgKiBHZXRzIGJhc2Ugb3IgcGF0Y2ggdmVyc2lvbiBtYW5hZ2VkIG9iamVjdC5cbiAgICogQHBhcmFtIGRldmljZVJlcG9zaXRvcnlGcmFnbWVudCBEZXZpY2UgcmVwb3NpdG9yeSBmcmFnbWVudC5cbiAgICogQHBhcmFtIHR5cGUgVG9wIGxldmVsIHJlcG9zaXRvcnkgZW50cnkgdHlwZS5cbiAgICogQHBhcmFtIGNvbmZpZ3VyYXRpb24gQ29uZmlndXJhdGlvbiBvYmplY3Qgd2l0aCBvcHRpb25zOlxuICAgKiAtICoqc2tpcExlZ2FjeSoqIC0gYGJvb2xlYW5gIC0gRXhjbHVkZSBsZWdhY3kgZW50cmllcy5cbiAgICogLSAqKmZpbHRlcnMqKiAtIGBvYmplY3RgIC0gRmlsdGVyIG9iamVjdC5cbiAgICpcbiAgICogQGRlcHJlY2F0ZWQgYXMgaXQgZG9lc24ndCBzdXBwb3J0ICdtaXNzaW5nIHVybCcgY2FzZVxuICAgKi9cbiAgZ2V0UmVwb3NpdG9yeUJpbmFyeU1vQnlWZXJzaW9uKFxuICAgIGRldmljZVJlcG9zaXRvcnlGcmFnbWVudDogRGV2aWNlRmlybXdhcmUgfCBEZXZpY2VTb2Z0d2FyZSxcbiAgICB0eXBlOiBSZXBvc2l0b3J5VHlwZSxcbiAgICB7IHNraXBMZWdhY3kgPSBmYWxzZSwgZmlsdGVycyA9IHt9IH06IHsgc2tpcExlZ2FjeT86IGJvb2xlYW47IGZpbHRlcnM/OiBvYmplY3QgfSA9IHt9XG4gICk6IFByb21pc2U8SU1hbmFnZWRPYmplY3Q+IHtcbiAgICBjb25zdCB7IHZlcnNpb24sIHVybCwgbmFtZSB9ID0gZGV2aWNlUmVwb3NpdG9yeUZyYWdtZW50O1xuICAgIGNvbnN0IHJlcG9zaXRvcnlCaW5hcnlUeXBlID0gUkVQT1NJVE9SWV9CSU5BUllfVFlQRVNbdHlwZV07XG4gICAgbGV0IHF1ZXJ5O1xuICAgIGNvbnN0IG5ld01vZGVsQmFzZVZlcnNpb25RdWVyeSA9IHtcbiAgICAgIFtgJHt0eXBlfS52ZXJzaW9uYF06IHZlcnNpb24sXG4gICAgICBbYCR7dHlwZX0udXJsYF06IHVybCxcbiAgICAgIHR5cGU6IHJlcG9zaXRvcnlCaW5hcnlUeXBlXG4gICAgfTtcbiAgICBjb25zdCBsZWdhY3lWZXJzaW9uUXVlcnkgPSB7IHVybCwgdHlwZSwgbmFtZSB9O1xuICAgIGZpbHRlcnMgPSB7IHdpdGhDaGlsZHJlbjogZmFsc2UsIHdpdGhQYXJlbnRzOiB0cnVlLCAuLi5maWx0ZXJzIH07XG5cbiAgICBpZiAoc2tpcExlZ2FjeSkge1xuICAgICAgcXVlcnkgPSB7XG4gICAgICAgIF9fYW5kOiB7XG4gICAgICAgICAgLi4ubmV3TW9kZWxCYXNlVmVyc2lvblF1ZXJ5XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHF1ZXJ5ID0ge1xuICAgICAgICBfX29yOiBbeyBfX2FuZDogeyAuLi5uZXdNb2RlbEJhc2VWZXJzaW9uUXVlcnkgfSB9LCB7IF9fYW5kOiB7IC4uLmxlZ2FjeVZlcnNpb25RdWVyeSB9IH1dXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmludmVudG9yeS5saXN0UXVlcnkocXVlcnksIGZpbHRlcnMpLnRoZW4oKHsgZGF0YSB9KSA9PiBoZWFkKGRhdGEpKTtcbiAgfVxuXG4gIGdldEJpbmFyeU5hbWUkKGJpbmFyeVVybDogc3RyaW5nKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICBpZiAoIWJpbmFyeVVybCkge1xuICAgICAgcmV0dXJuIG9mKCctLS0nKTtcbiAgICB9XG5cbiAgICBjb25zdCBiaW5hcnlJZCA9IHRoaXMuaW52ZW50b3J5QmluYXJ5LmdldElkRnJvbVVybChiaW5hcnlVcmwpO1xuICAgIGlmICghYmluYXJ5SWQpIHtcbiAgICAgIHJldHVybiBvZihiaW5hcnlVcmwpO1xuICAgIH1cbiAgICByZXR1cm4gZGVmZXIoKCkgPT4gdGhpcy5pbnZlbnRvcnkuZGV0YWlsKGJpbmFyeUlkKS50aGVuKHJlc3VsdCA9PiByZXN1bHQuZGF0YSkpLnBpcGUoXG4gICAgICBtYXAobW8gPT4gbW8ubmFtZSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlcyBhbiBpbnZlbnRvcnkgcXVlcnkgb2JqZWN0IHdoaWNoIGNhbiBiZSB1c2VkIHRvIGZpbmRcbiAgICogcmVwb3NpdG9yeSBlbnRyaWVzIG9mIHNwZWNpZmllZCB0eXBlIG1hdGNoaW5nIHRoZSB0eXBlIG9mIHByb3ZpZGVkIGRldmljZS5cbiAgICogQHBhcmFtIHJlcG9zaXRvcnlUeXBlIFRoZSB0eXBlIG9mIHJlcG9zaXRvcnkgZW50cmllcyB3aGljaCB3aWxsIGJlIHF1ZXJpZWQgd2l0aCB0aGUgZ2VuZXJhdGVkIHF1ZXJ5LlxuICAgKiBAcGFyYW0gZGV2aWNlIFRoZSBkZXZpY2UgZm9yIHdoaWNoIG1hdGNoaW5nIHJlcG9zaXRvcnkgZW50cmllcyB3aWxsIGJlIHF1ZXJpZWQgd2l0aCB0aGUgZ2VuZXJhdGVkIHF1ZXJ5LlxuICAgKi9cblxuICBnZXREZXZpY2VUeXBlUXVlcnkocmVwb3NpdG9yeVR5cGU6IFJlcG9zaXRvcnlUeXBlLCBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0KTogb2JqZWN0IHtcbiAgICBsZXQgcmVzdWx0ID0geyB0eXBlOiByZXBvc2l0b3J5VHlwZSB9O1xuICAgIGlmIChyZXBvc2l0b3J5VHlwZSA9PT0gUmVwb3NpdG9yeVR5cGUuQ09ORklHVVJBVElPTikge1xuICAgICAgaWYgKGRldmljZS50eXBlKSB7XG4gICAgICAgIHJlc3VsdCA9IHRoaXMucXVlcmllc1V0aWwuYWRkQW5kRmlsdGVyKHJlc3VsdCwge1xuICAgICAgICAgIF9fb3I6IFt7IGRldmljZVR5cGU6IGRldmljZS50eXBlIH0sIHsgX19ub3Q6IHsgX19oYXM6IGBkZXZpY2VUeXBlYCB9IH1dXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXN1bHQgPSB0aGlzLnF1ZXJpZXNVdGlsLmFkZEFuZEZpbHRlcihyZXN1bHQsIHtcbiAgICAgICAgX19vcjogW1xuICAgICAgICAgIHsgJ2M4eV9GaWx0ZXIudHlwZSc6IGRldmljZS50eXBlIH0sXG4gICAgICAgICAgeyAnYzh5X0ZpbHRlci50eXBlJzogJycgfSxcbiAgICAgICAgICB7IF9fbm90OiB7IF9faGFzOiBgYzh5X0ZpbHRlci50eXBlYCB9IH1cbiAgICAgICAgXVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGVzIGFuIGludmVudG9yeSBxdWVyeSBvYmplY3Qgd2hpY2ggY2FuIGJlIHVzZWQgdG8gZmluZCBjb25maWd1cmF0aW9uIHJlcG9zaXRvcnkgZW50cmllc1xuICAgKiBtYXRjaGluZyB0aGUgdHlwZSBvZiBwcm92aWRlZCBkZXZpY2UgYW5kIHNwZWNpZmllZCBjb25maWd1cmF0aW9uIHR5cGUuXG4gICAqIEBwYXJhbSBkZXZpY2UgVGhlIGRldmljZSBmb3Igd2hpY2ggbWF0Y2hpbmcgcmVwb3NpdG9yeSBlbnRyaWVzIHdpbGwgYmUgcXVlcmllZCB3aXRoIHRoZSBnZW5lcmF0ZWQgcXVlcnkuXG4gICAqIEBwYXJhbSBjb25maWd1cmF0aW9uVHlwZSBDb25maWd1cmF0aW9uIHR5cGUgZm9yIHdoaWNoIG1hdGNoaW5nIHJlcG9zaXRvcnkgZW50cmllcyB3aWxsIGJlIHF1ZXJpZWQgd2l0aCB0aGUgZ2VuZXJhdGVkIHF1ZXJ5LlxuICAgKi9cbiAgZ2V0Q29uZmlndXJhdGlvblR5cGVRdWVyeShkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LCBjb25maWd1cmF0aW9uVHlwZTogc3RyaW5nKTogb2JqZWN0IHtcbiAgICBjb25zdCBxdWVyeSA9IHRoaXMuZ2V0RGV2aWNlVHlwZVF1ZXJ5KFJlcG9zaXRvcnlUeXBlLkNPTkZJR1VSQVRJT04sIGRldmljZSk7XG4gICAgcmV0dXJuIHRoaXMucXVlcmllc1V0aWwuYWRkQW5kRmlsdGVyKHF1ZXJ5LCB7XG4gICAgICBfX29yOiBbXG4gICAgICAgIHsgY29uZmlndXJhdGlvblR5cGUgfSxcbiAgICAgICAgeyBjb25maWd1cmF0aW9uVHlwZTogJycgfSxcbiAgICAgICAgeyBfX25vdDogeyBfX2hhczogYGNvbmZpZ3VyYXRpb25UeXBlYCB9IH1cbiAgICAgIF1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBsaXN0IG9mIHNvZnR3YXJlIGluc3RhbGxlZCBpbiB0aGUgZGV2aWNlIGluIHRoZSB1bmlmb3JtIGZvcm1hdC5cbiAgICogU3VwcG9ydHMgYzh5X1NvZnR3YXJlTGlzdCBhbmQgYzh5X1NvZnR3YXJlIGZyYWdtZW50cy5cbiAgICogQHBhcmFtIGRldmljZSBUaGUgZGV2aWNlIHdob3NlIHNvZnR3YXJlIGxpc3Qgc2hvdWxkIGJlIHJldHVybmVkLlxuICAgKi9cbiAgZ2V0RGV2aWNlU29mdHdhcmVMaXN0KGRldmljZTogSU1hbmFnZWRPYmplY3QpOiBEZXZpY2VTb2Z0d2FyZVtdIHtcbiAgICBpZiAoZGV2aWNlLmM4eV9Tb2Z0d2FyZUxpc3QpIHtcbiAgICAgIHJldHVybiBjbG9uZURlZXAoZGV2aWNlLmM4eV9Tb2Z0d2FyZUxpc3QpO1xuICAgIH1cbiAgICBpZiAoZGV2aWNlLmM4eV9Tb2Z0d2FyZSkge1xuICAgICAgcmV0dXJuIF9tYXAoZGV2aWNlLmM4eV9Tb2Z0d2FyZSwgKHZlcnNpb24sIG5hbWUpID0+ICh7IG5hbWUsIHZlcnNpb24gfSkpO1xuICAgIH1cbiAgICByZXR1cm4gW107XG4gIH1cblxuICAvKipcbiAgICogUHJlcGFyZXMgYSBzb2Z0d2FyZSB1cGRhdGUgb3BlcmF0aW9uIGZvciBnaXZlbiBkZXZpY2UgYW5kIHRoZSBsaXN0IG9mIGNoYW5nZXMsIGFuZCBzZW5kcyBpdCB0byB0aGUgZGV2aWNlLlxuICAgKiBAcGFyYW0gZGV2aWNlIFRoZSBkZXZpY2Ugd2hpY2ggdGhlIG9wZXJhdGlvbiBzaG91bGQgYmUgcHJlcGFyZWQgZm9yIGFuZCBzZW50IHRvLlxuICAgKiBAcGFyYW0gY2hhbmdlcyBUaGUgbGlzdCBvZiBzb2Z0d2FyZSBjaGFuZ2VzIHdoaWNoIHNob3VsZCBiZSBhcHBsaWVkLlxuICAgKi9cbiAgYXN5bmMgY3JlYXRlU29mdHdhcmVVcGRhdGVPcGVyYXRpb24oXG4gICAgZGV2aWNlOiBJTWFuYWdlZE9iamVjdCxcbiAgICBjaGFuZ2VzOiBEZXZpY2VTb2Z0d2FyZUNoYW5nZVtdXG4gICk6IFByb21pc2U8SU9wZXJhdGlvbj4ge1xuICAgIGNvbnN0IG9wZXJhdGlvbiA9IHRoaXMuZ2V0U29mdHdhcmVVcGRhdGVPcGVyYXRpb24oZGV2aWNlLCBjaGFuZ2VzKTtcbiAgICByZXR1cm4gKGF3YWl0IHRoaXMub3BlcmF0aW9uLmNyZWF0ZShvcGVyYXRpb24pKS5kYXRhO1xuICB9XG5cbiAgLyoqXG4gICAqIFByZXBhcmVzIGEgc29mdHdhcmUgdXBkYXRlIG9wZXJhdGlvbiBmb3IgZ2l2ZW4gZGV2aWNlIGFuZCBjaGFuZ2VzLlxuICAgKiBSZXR1cm5lZCBvcGVyYXRpb24gdHlwZSBkZXBlbmRzIG9uIGRldmljZSdzIHN1cHBvcnRlZCBvcGVyYXRpb25zLlxuICAgKiBTdXBwb3J0cyBjOHlfU29mdHdhcmVVcGRhdGUsIGM4eV9Tb2Z0d2FyZUxpc3QsIGFuZCBjOHlfU29mdHdhcmUgb3BlcmF0aW9ucy5cbiAgICogQHBhcmFtIGRldmljZSBUaGUgZGV2aWNlIGZvciB3aGljaCBvcGVyYXRpb24gc2hvdWxkIGJlIHByZXBhcmVkLlxuICAgKiBAcGFyYW0gY2hhbmdlcyBUaGUgbGlzdCBvZiBzb2Z0d2FyZSBjaGFuZ2VzIHdoaWNoIHNob3VsZCBiZSBhcHBsaWVkLlxuICAgKi9cbiAgZ2V0U29mdHdhcmVVcGRhdGVPcGVyYXRpb24oZGV2aWNlOiBJTWFuYWdlZE9iamVjdCwgY2hhbmdlczogRGV2aWNlU29mdHdhcmVDaGFuZ2VbXSk6IElPcGVyYXRpb24ge1xuICAgIGNvbnN0IG9wZXJhdGlvbjogSU9wZXJhdGlvbiA9IHtcbiAgICAgIGRldmljZUlkOiBkZXZpY2UuaWQsXG4gICAgICBkZXNjcmlwdGlvbjogYEFwcGx5IHNvZnR3YXJlIGNoYW5nZXM6ICR7Y2hhbmdlc1xuICAgICAgICAubWFwKFxuICAgICAgICAgIGNoYW5nZSA9PlxuICAgICAgICAgICAgYCR7Y2hhbmdlLmFjdGlvbn0gXCIke2NoYW5nZS5uYW1lfVwiJHtcbiAgICAgICAgICAgICAgY2hhbmdlLnZlcnNpb24gPyBgICh2ZXJzaW9uOiAke2NoYW5nZS52ZXJzaW9ufSlgIDogJydcbiAgICAgICAgICAgIH1gXG4gICAgICAgIClcbiAgICAgICAgLmpvaW4oJywgJyl9YFxuICAgIH07XG4gICAgaWYgKGRldmljZS5jOHlfU3VwcG9ydGVkT3BlcmF0aW9ucy5pbmNsdWRlcygnYzh5X1NvZnR3YXJlVXBkYXRlJykpIHtcbiAgICAgIG9wZXJhdGlvbi5jOHlfU29mdHdhcmVVcGRhdGUgPSBjbG9uZURlZXAoY2hhbmdlcyk7XG4gICAgfSBlbHNlIGlmIChkZXZpY2UuYzh5X1N1cHBvcnRlZE9wZXJhdGlvbnMuaW5jbHVkZXMoJ2M4eV9Tb2Z0d2FyZUxpc3QnKSkge1xuICAgICAgb3BlcmF0aW9uLmM4eV9Tb2Z0d2FyZUxpc3QgPSBjbG9uZURlZXAoZGV2aWNlLmM4eV9Tb2Z0d2FyZUxpc3QpIHx8IFtdO1xuICAgICAgY2hhbmdlcy5mb3JFYWNoKGNoYW5nZSA9PiB7XG4gICAgICAgIGNvbnN0IGRldmljZVNvZnR3YXJlOiBEZXZpY2VTb2Z0d2FyZSA9IHBpY2soY2hhbmdlLCBbJ25hbWUnLCAndmVyc2lvbicsICd1cmwnXSk7XG4gICAgICAgIGlmIChjaGFuZ2UuYWN0aW9uID09PSAnZGVsZXRlJykge1xuICAgICAgICAgIHJlbW92ZShvcGVyYXRpb24uYzh5X1NvZnR3YXJlTGlzdCwgZGV2aWNlU29mdHdhcmUpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjaGFuZ2UuYWN0aW9uID09PSAnaW5zdGFsbCcpIHtcbiAgICAgICAgICBvcGVyYXRpb24uYzh5X1NvZnR3YXJlTGlzdC5wdXNoKGRldmljZVNvZnR3YXJlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIGlmIChkZXZpY2UuYzh5X1N1cHBvcnRlZE9wZXJhdGlvbnMuaW5jbHVkZXMoJ2M4eV9Tb2Z0d2FyZScpKSB7XG4gICAgICBvcGVyYXRpb24uYzh5X1NvZnR3YXJlID0gY2xvbmVEZWVwKGRldmljZS5jOHlfU29mdHdhcmUpIHx8IHt9O1xuICAgICAgY2hhbmdlcy5mb3JFYWNoKGNoYW5nZSA9PiB7XG4gICAgICAgIGlmIChjaGFuZ2UuYWN0aW9uID09PSAnZGVsZXRlJykge1xuICAgICAgICAgIGRlbGV0ZSBvcGVyYXRpb24uYzh5X1NvZnR3YXJlW2NoYW5nZS5uYW1lXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY2hhbmdlLmFjdGlvbiA9PT0gJ2luc3RhbGwnKSB7XG4gICAgICAgICAgb3BlcmF0aW9uLmM4eV9Tb2Z0d2FyZVtjaGFuZ2UubmFtZV0gPSBjaGFuZ2UudmVyc2lvbjtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBvcGVyYXRpb247XG4gIH1cblxuICAvKipcbiAgICogRXh0cmFjdHMgdGhlIGxpc3Qgb2YgZGV2aWNlIHNvZnR3YXJlIGNoYW5nZXMgZnJvbSBnaXZlbiBvcGVyYXRpb24gaW4gdGhlIGNvbnRleHQgb2YgZ2l2ZW4gZGV2aWNlLlxuICAgKiBAcGFyYW0gb3BlcmF0aW9uIFRoZSBvcGVyYXRpb24gZnJvbSB3aGljaCB0aGUgbGlzdCBzaG91bGQgYmUgZXh0cmFjdGVkLlxuICAgKiBAcGFyYW0gZGV2aWNlIFRoZSB0YXJnZXQgZGV2aWNlIG9mIHRoZSBvcGVyYXRpb24uXG4gICAqL1xuICBnZXREZXZpY2VTb2Z0d2FyZUNoYW5nZXNGcm9tT3BlcmF0aW9uKFxuICAgIG9wZXJhdGlvbjogSU9wZXJhdGlvbixcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0XG4gICk6IERldmljZVNvZnR3YXJlQ2hhbmdlW10ge1xuICAgIGlmIChvcGVyYXRpb24uYzh5X1NvZnR3YXJlVXBkYXRlKSB7XG4gICAgICByZXR1cm4gY2xvbmVEZWVwKG9wZXJhdGlvbi5jOHlfU29mdHdhcmVVcGRhdGUpO1xuICAgIH1cbiAgICBpZiAob3BlcmF0aW9uLmM4eV9Tb2Z0d2FyZUxpc3QpIHtcbiAgICAgIHJldHVybiB0aGlzLmdldERldmljZVNvZnR3YXJlQ2hhbmdlc0Zyb21Tb2Z0d2FyZUxpc3RPcGVyYXRpb24ob3BlcmF0aW9uLCBkZXZpY2UpO1xuICAgIH1cbiAgICBpZiAob3BlcmF0aW9uLmM4eV9Tb2Z0d2FyZSkge1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0RGV2aWNlU29mdHdhcmVDaGFuZ2VzRnJvbVNvZnR3YXJlT3BlcmF0aW9uKG9wZXJhdGlvbiwgZGV2aWNlKTtcbiAgICB9XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgLyoqXG4gICAqIFByZXBhcmVzIGEgZmlybXdhcmUgdXBkYXRlIG9wZXJhdGlvbiBmb3IgZ2l2ZW4gZGV2aWNlIGFuZCB0aGUgc2VsZWN0ZWQgcmVwb3NpdG9yeSBiaW5hcnksIGFuZCBzZW5kcyBpdCB0byB0aGUgZGV2aWNlLlxuICAgKiBAcGFyYW0gZGV2aWNlIFRoZSBkZXZpY2Ugd2hpY2ggdGhlIG9wZXJhdGlvbiBzaG91bGQgYmUgcHJlcGFyZWQgZm9yIGFuZCBzZW50IHRvLlxuICAgKiBAcGFyYW0gc2VsZWN0ZWRPcHRpb24gVGhlIHNlbGVjdGVkIHJlcG9zaXRvcnkgYmluYXJ5IG9wdGlvbi5cbiAgICovXG4gIGFzeW5jIGNyZWF0ZUZpcm13YXJlVXBkYXRlT3BlcmF0aW9uKFxuICAgIGRldmljZTogSU1hbmFnZWRPYmplY3QsXG4gICAgc2VsZWN0ZWRPcHRpb246IFNlbGVjdGVkUmVwb3NpdG9yeUJpbmFyeVxuICApOiBQcm9taXNlPElPcGVyYXRpb24+IHtcbiAgICBjb25zdCBvcGVyYXRpb24gPSB0aGlzLmdldEZpcm13YXJlVXBkYXRlT3BlcmF0aW9uKGRldmljZSwgc2VsZWN0ZWRPcHRpb24pO1xuICAgIHJldHVybiAoYXdhaXQgdGhpcy5vcGVyYXRpb24uY3JlYXRlKG9wZXJhdGlvbikpLmRhdGE7XG4gIH1cblxuICAvKipcbiAgICogUHJlcGFyZXMgYSBmaXJtd2FyZSB1cGRhdGUgb3BlcmF0aW9uIGZvciBnaXZlbiBkZXZpY2UgYW5kIHNlbGVjdGVkIHZlcnNpb24uXG4gICAqIFN1cHBvcnRzIGM4eV9GaXJtd2FyZSBvcGVyYXRpb24uXG4gICAqIEBwYXJhbSBkZXZpY2UgVGhlIGRldmljZSBmb3Igd2hpY2ggb3BlcmF0aW9uIHNob3VsZCBiZSBwcmVwYXJlZC5cbiAgICogQHBhcmFtIHNlbGVjdGVkT3B0aW9uIFNlbGVjdGVkIGZpcm13YXJlIHZlcnNpb24uXG4gICAqL1xuICBnZXRGaXJtd2FyZVVwZGF0ZU9wZXJhdGlvbihcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LFxuICAgIHNlbGVjdGVkT3B0aW9uOiBTZWxlY3RlZFJlcG9zaXRvcnlCaW5hcnlcbiAgKTogSU9wZXJhdGlvbiB7XG4gICAgZGVsZXRlIHNlbGVjdGVkT3B0aW9uLmlkO1xuXG4gICAgY29uc3Qgb3BlcmF0aW9uOiBJT3BlcmF0aW9uID0ge1xuICAgICAgZGV2aWNlSWQ6IGRldmljZS5pZCxcbiAgICAgIGRlc2NyaXB0aW9uOiBgVXBkYXRlIGZpcm13YXJlIHRvOiBcIiR7c2VsZWN0ZWRPcHRpb24ubmFtZX1cIiR7XG4gICAgICAgIHNlbGVjdGVkT3B0aW9uLnZlcnNpb24gPyBgICh2ZXJzaW9uOiAke3NlbGVjdGVkT3B0aW9uLnZlcnNpb259KWAgOiAnJ1xuICAgICAgfWAsXG4gICAgICBjOHlfRmlybXdhcmU6IHsgLi4uc2VsZWN0ZWRPcHRpb24gfVxuICAgIH07XG5cbiAgICByZXR1cm4gb3BlcmF0aW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIFByZXBhcmVzIGEgY29uZmlndXJhdGlvbiBmaWxlIHVwbG9hZCBvcGVyYXRpb24gZm9yIGdpdmVuIGRldmljZSBhbmQgY29uZmlndXJhdGlvbiB0eXBlLlxuICAgKiBAcGFyYW0gZGV2aWNlIFRoZSBkZXZpY2UgZm9yIHdoaWNoIG9wZXJhdGlvbiBzaG91bGQgYmUgcHJlcGFyZWQuXG4gICAqIEBwYXJhbSBjb25maWd1cmF0aW9uVHlwZSBTZWxlY3RlZCBjb25maWd1cmF0aW9uIHR5cGUuXG4gICAqIEBwYXJhbSBpc0xlZ2FjeSAgQSBsZWdhY3kgb3BlcmF0aW9uIGlzIGNyZWF0ZWQgd2l0aG91dCBhIGNvbmZpZ3VyYXRpb25UeXBlLlxuICAgKi9cbiAgZ2V0VXBsb2FkQ29uZmlndXJhdGlvbkZpbGVPcGVyYXRpb24oXG4gICAgZGV2aWNlOiBJTWFuYWdlZE9iamVjdCxcbiAgICBjb25maWd1cmF0aW9uVHlwZTogc3RyaW5nLFxuICAgIGlzTGVnYWN5OiBib29sZWFuID0gZmFsc2VcbiAgKTogSU9wZXJhdGlvbiB7XG4gICAgaWYgKGlzTGVnYWN5KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBkZXZpY2VJZDogZGV2aWNlLmlkLFxuICAgICAgICBkZXNjcmlwdGlvbjogYFJldHJpZXZlIGNvbmZpZ3VyYXRpb24gc25hcHNob3QgZnJvbSBkZXZpY2UgJHtkZXZpY2UubmFtZX1gLFxuICAgICAgICBjOHlfVXBsb2FkQ29uZmlnRmlsZToge31cbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBkZXZpY2VJZDogZGV2aWNlLmlkLFxuICAgICAgZGVzY3JpcHRpb246IGBSZXRyaWV2ZSAke2NvbmZpZ3VyYXRpb25UeXBlfSBjb25maWd1cmF0aW9uIHNuYXBzaG90IGZyb20gZGV2aWNlICR7ZGV2aWNlLm5hbWV9YCxcbiAgICAgIGM4eV9VcGxvYWRDb25maWdGaWxlOiB7XG4gICAgICAgIHR5cGU6IGNvbmZpZ3VyYXRpb25UeXBlXG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcmVwYXJlcyBhIGNvbmZpZ3VyYXRpb24gZmlsZSBkb3dubG9hZCBvcGVyYXRpb24gZm9yIGdpdmVuIGRldmljZSBhbmQgY29uZmlndXJhdGlvbiB0eXBlLlxuICAgKiBAcGFyYW0gZGV2aWNlIFRoZSBkZXZpY2UgZm9yIHdoaWNoIG9wZXJhdGlvbiBzaG91bGQgYmUgcHJlcGFyZWQuXG4gICAqIEBwYXJhbSBjb25maWd1cmF0aW9uVHlwZSBTZWxlY3RlZCBjb25maWd1cmF0aW9uIHR5cGUuXG4gICAqIEBwYXJhbSBiaW5hcnlVcmwgVGhlIHVybCBvZiBhIGJpbmFyeSB0byBiZSBkb3dubG9hZGVkLlxuICAgKiBAcGFyYW0gaXNMZWdhY3kgQSBsZWdhY3kgb3BlcmF0aW9uIGlzIGNyZWF0ZWQgd2l0aG91dCBhIGNvbmZpZ3VyYXRpb25UeXBlLlxuICAgKi9cbiAgZ2V0RG93bmxvYWRDb25maWd1cmF0aW9uRmlsZU9wZXJhdGlvbihcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LFxuICAgIGNvbmZpZ3VyYXRpb25UeXBlOiBzdHJpbmcsXG4gICAgY29uZmlnU25hcHNob3Q6IENvbmZpZ3VyYXRpb25TbmFwc2hvdCxcbiAgICBpc0xlZ2FjeTogYm9vbGVhbiA9IGZhbHNlXG4gICk6IElPcGVyYXRpb24ge1xuICAgIGlmIChpc0xlZ2FjeSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZGV2aWNlSWQ6IGRldmljZS5pZCxcbiAgICAgICAgZGVzY3JpcHRpb246IGBTZW5kIGNvbmZpZ3VyYXRpb24gc25hcHNob3QgJHtjb25maWdTbmFwc2hvdC5uYW1lfSB0byBkZXZpY2UgJHtkZXZpY2UubmFtZX1gLFxuICAgICAgICBjOHlfRG93bmxvYWRDb25maWdGaWxlOiB7XG4gICAgICAgICAgdXJsOiBjb25maWdTbmFwc2hvdC5iaW5hcnlVcmwsXG4gICAgICAgICAgYzh5X0NvbmZpZ3VyYXRpb25EdW1wOiB7XG4gICAgICAgICAgICBpZDogY29uZmlnU25hcHNob3QuaWRcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICAgIHJldHVybiB7XG4gICAgICBkZXZpY2VJZDogZGV2aWNlLmlkLFxuICAgICAgZGVzY3JpcHRpb246IGBTZW5kIGNvbmZpZ3VyYXRpb24gc25hcHNob3QgJHtjb25maWdTbmFwc2hvdC5uYW1lfSBvZiBjb25maWd1cmF0aW9uIHR5cGUgJHtjb25maWd1cmF0aW9uVHlwZX0gdG8gZGV2aWNlICR7ZGV2aWNlLm5hbWV9YCxcbiAgICAgIGM4eV9Eb3dubG9hZENvbmZpZ0ZpbGU6IHtcbiAgICAgICAgdXJsOiBjb25maWdTbmFwc2hvdC5iaW5hcnlVcmwsXG4gICAgICAgIHR5cGU6IGNvbmZpZ3VyYXRpb25UeXBlXG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBsYXN0IGZpcm13YXJlIHVwZGF0ZSBvcGVyYXRpb24gZm9yIGdpdmVuIGRldmljZS5cbiAgICogTG9va3MgZm9yIGM4eV9GaXJtd2FyZSBvcGVyYXRpb25zLlxuICAgKiBAcGFyYW0gZGV2aWNlSWQgVGhlIElEIG9mIHRoZSBkZXZpY2UgdG8gZmluZCBhbiBvcGVyYXRpb24gZm9yLlxuICAgKi9cbiAgYXN5bmMgZ2V0TGFzdEZpcm13YXJlVXBkYXRlT3BlcmF0aW9uKGRldmljZUlkOiBzdHJpbmcgfCBudW1iZXIpOiBQcm9taXNlPElPcGVyYXRpb24+IHtcbiAgICBjb25zdCBmaWx0ZXJzID0ge1xuICAgICAgZGV2aWNlSWQsXG4gICAgICBkYXRlRnJvbTogbmV3IERhdGUoMCkudG9JU09TdHJpbmcoKSxcbiAgICAgIGRhdGVUbzogbmV3IERhdGUoRGF0ZS5ub3coKSkudG9JU09TdHJpbmcoKSxcbiAgICAgIHJldmVydDogdHJ1ZSxcbiAgICAgIHBhZ2VTaXplOiAxXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5nZXRGaXJzdE1hdGNoaW5nT3BlcmF0aW9uKFt7IC4uLmZpbHRlcnMsIGZyYWdtZW50VHlwZTogJ2M4eV9GaXJtd2FyZScgfV0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIGxhc3Qgc29mdHdhcmUgdXBkYXRlIG9wZXJhdGlvbiBmb3IgZ2l2ZW4gZGV2aWNlLlxuICAgKiBMb29rcyBmb3IgYzh5X1NvZnR3YXJlVXBkYXRlLCBjOHlfU29mdHdhcmVMaXN0LCBvciBjOHlfU29mdHdhcmUgb3BlcmF0aW9ucy5cbiAgICogQHBhcmFtIGRldmljZUlkIFRoZSBJRCBvZiB0aGUgZGV2aWNlIHRvIGZpbmQgYW4gb3BlcmF0aW9uIGZvci5cbiAgICovXG4gIGFzeW5jIGdldExhc3RTb2Z0d2FyZVVwZGF0ZU9wZXJhdGlvbihkZXZpY2VJZDogc3RyaW5nIHwgbnVtYmVyKTogUHJvbWlzZTxJT3BlcmF0aW9uPiB7XG4gICAgY29uc3QgZmlsdGVycyA9IHtcbiAgICAgIGRldmljZUlkLFxuICAgICAgZGF0ZUZyb206IG5ldyBEYXRlKDApLnRvSVNPU3RyaW5nKCksXG4gICAgICBkYXRlVG86IG5ldyBEYXRlKERhdGUubm93KCkpLnRvSVNPU3RyaW5nKCksXG4gICAgICByZXZlcnQ6IHRydWUsXG4gICAgICBwYWdlU2l6ZTogMVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuZ2V0Rmlyc3RNYXRjaGluZ09wZXJhdGlvbihbXG4gICAgICB7IC4uLmZpbHRlcnMsIGZyYWdtZW50VHlwZTogJ2M4eV9Tb2Z0d2FyZVVwZGF0ZScgfSxcbiAgICAgIHsgLi4uZmlsdGVycywgZnJhZ21lbnRUeXBlOiAnYzh5X1NvZnR3YXJlTGlzdCcgfSxcbiAgICAgIHsgLi4uZmlsdGVycywgZnJhZ21lbnRUeXBlOiAnYzh5X1NvZnR3YXJlJyB9XG4gICAgXSk7XG4gIH1cblxuICAvKipcbiAgICogSXRlcmF0ZXMgb3ZlciB0aGUgbGlzdCBvZiBmaWx0ZXJzIGFuZCBxdWVyaWVzIHRoZSBvcGVyYXRpb25zLlxuICAgKiBJZiBhIHF1ZXJ5IHJldHVybnMgYXQgbGVhc3Qgb25lIG9wZXJhdGlvbiwgdGhlIGZpcnN0IG9uZSB3aWxsIGJlIHJldHVybmVkLlxuICAgKiBPdGhlcndpc2UgdGhlIG5leHQgcXVlcnkgd2lsbCBiZSBwZXJmb3JtZWQuXG4gICAqIElmIG5vbmUgb2YgdGhlIHF1ZXJpZXMgcmV0dXJucyBhbnkgb3BlcmF0aW9uLCBudWxsIHdpbGwgYmUgcmV0dXJuZWQuXG4gICAqIEBwYXJhbSBmaWx0ZXJzTGlzdCBUaGUgbGlzdCBvZiBmaWx0ZXJzIGZvciB0aGUgcXVlcmllcy5cbiAgICovXG4gIGFzeW5jIGdldEZpcnN0TWF0Y2hpbmdPcGVyYXRpb24oZmlsdGVyc0xpc3Q6IGFueVtdKTogUHJvbWlzZTxJT3BlcmF0aW9uPiB7XG4gICAgbGV0IG1hdGNoaW5nT3BlcmF0aW9uID0gbnVsbDtcblxuICAgIGZvciAoY29uc3QgZmlsdGVycyBvZiBmaWx0ZXJzTGlzdCkge1xuICAgICAgY29uc3Qgb3BlcmF0aW9ucyA9IChhd2FpdCB0aGlzLm9wZXJhdGlvbi5saXN0KGZpbHRlcnMpKS5kYXRhO1xuICAgICAgaWYgKG9wZXJhdGlvbnMubGVuZ3RoKSB7XG4gICAgICAgIG1hdGNoaW5nT3BlcmF0aW9uID0gb3BlcmF0aW9uc1swXTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG1hdGNoaW5nT3BlcmF0aW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIEl0ZXJhdGVzIG92ZXIgdGhlIGxpc3Qgb2YgZmlsdGVycyBhbmQgcXVlcmllcyB0aGUgb3BlcmF0aW9ucy5cbiAgICogSXQgY29tcGFyZXMgdGhlIG9wZXJhdGlvbnMgcmV0cmlldmVkIGJ5IHRoZSBxdWVyaWVzIGJ5ICdjcmVhdGlvblRpbWUnXG4gICAqIGFuZCByZXR1cm4gdGhlIGxhdGVzdCBvbmUuXG4gICAqIElmIG5vbmUgb2YgdGhlIHF1ZXJpZXMgcmV0dXJucyBhbnkgb3BlcmF0aW9uLCBudWxsIHdpbGwgYmUgcmV0dXJuZWQuXG4gICAqIEBwYXJhbSBmaWx0ZXJzTGlzdCBUaGUgbGlzdCBvZiBmaWx0ZXJzIGZvciB0aGUgcXVlcmllcy5cbiAgICovXG4gIGFzeW5jIGdldExhdGVzdE1hdGNoaW5nT3BlcmF0aW9uKGZpbHRlcnNMaXN0OiBhbnlbXSk6IFByb21pc2U8SU9wZXJhdGlvbj4ge1xuICAgIGxldCBtYXRjaGluZ09wZXJhdGlvbjogSU9wZXJhdGlvbiA9IG51bGw7XG5cbiAgICBmb3IgKGNvbnN0IGZpbHRlcnMgb2YgZmlsdGVyc0xpc3QpIHtcbiAgICAgIGNvbnN0IG9wZXJhdGlvbnM6IElPcGVyYXRpb25bXSA9IChhd2FpdCB0aGlzLm9wZXJhdGlvbi5saXN0KGZpbHRlcnMpKS5kYXRhO1xuICAgICAgaWYgKG9wZXJhdGlvbnMubGVuZ3RoKSB7XG4gICAgICAgIGlmIChtYXRjaGluZ09wZXJhdGlvbikge1xuICAgICAgICAgIG1hdGNoaW5nT3BlcmF0aW9uID1cbiAgICAgICAgICAgIG5ldyBEYXRlKG1hdGNoaW5nT3BlcmF0aW9uLmNyZWF0aW9uVGltZSkuZ2V0VGltZSgpIDxcbiAgICAgICAgICAgIG5ldyBEYXRlKG9wZXJhdGlvbnNbMF0uY3JlYXRpb25UaW1lKS5nZXRUaW1lKClcbiAgICAgICAgICAgICAgPyBvcGVyYXRpb25zWzBdXG4gICAgICAgICAgICAgIDogbWF0Y2hpbmdPcGVyYXRpb247XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbWF0Y2hpbmdPcGVyYXRpb24gPSBvcGVyYXRpb25zWzBdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG1hdGNoaW5nT3BlcmF0aW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgdGhlIG9wZXJhdGlvbiBhbmQgcmV0dXJucyBhbiBvYnNlcnZhYmxlIHRvIHRyYWNrIGl0cyBwcm9ncmVzcy5cbiAgICogRmFpbHMgdGhlIG9ic2VydmFibGUgd2hlbiB0aGUgb3BlcmF0aW9uIHJldHVybnMgRkFJTEVEIHN0YXR1cy5cbiAgICogQ29tcGxldGVzIHRoZSBvYnNlcnZhYmxlIHdoZW4gdGhlIG9wZXJhdGlvbiByZXR1cm5zIFNVQ0NFU1NGVUwgc3RhdHVzLlxuICAgKiBAcGFyYW0gb3BlcmF0aW9uIFRoZSBvcGVyYXRpb24gdG8gY3JlYXRlIGFuZCB0cmFjay5cbiAgICovXG4gIGNyZWF0ZU9ic2VydmVkT3BlcmF0aW9uKG9wZXJhdGlvbjogSU9wZXJhdGlvbik6IE9ic2VydmFibGU8SU9wZXJhdGlvbj4ge1xuICAgIHJldHVybiBmcm9tKHRoaXMub3BlcmF0aW9uLmNyZWF0ZShvcGVyYXRpb24pKS5waXBlKFxuICAgICAgbWFwKCh7IGRhdGEgfSkgPT4gZGF0YSksXG4gICAgICB0YWtlKDEpLFxuICAgICAgc3dpdGNoTWFwKGNyZWF0ZWRPcGVyYXRpb24gPT4gdGhpcy5vYnNlcnZlT3BlcmF0aW9uKGNyZWF0ZWRPcGVyYXRpb24pKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbiBvYnNlcnZhYmxlIHRvIHRyYWNrIHByb2dyZXNzIG9mIGdpdmVuIG9wZXJhdGlvbi5cbiAgICogRmFpbHMgdGhlIG9ic2VydmFibGUgd2hlbiB0aGUgb3BlcmF0aW9uIHJldHVybnMgRkFJTEVEIHN0YXR1cy5cbiAgICogQ29tcGxldGVzIHRoZSBvYnNlcnZhYmxlIHdoZW4gdGhlIG9wZXJhdGlvbiByZXR1cm5zIFNVQ0NFU1NGVUwgc3RhdHVzLlxuICAgKiBAcGFyYW0gb3BlcmF0aW9uIFRoZSBvcGVyYXRpb24gdG8gYmUgb2JzZXJ2ZWQuXG4gICAqL1xuICBvYnNlcnZlT3BlcmF0aW9uKG9wZXJhdGlvbjogSU9wZXJhdGlvbik6IE9ic2VydmFibGU8SU9wZXJhdGlvbj4ge1xuICAgIGNvbnN0IG9ic2VydmVkT3BlcmF0aW9uJCA9IG9mKG9wZXJhdGlvbik7XG4gICAgY29uc3Qgb3BlcmF0aW9uVXBkYXRlcyQgPSBvYnNlcnZlZE9wZXJhdGlvbiQucGlwZShcbiAgICAgIHN3aXRjaE1hcChvYnNlcnZlZE9wZXJhdGlvbiA9PiB0aGlzLm9wZXJhdGlvblJlYWx0aW1lLm9uQWxsJChvYnNlcnZlZE9wZXJhdGlvbi5kZXZpY2VJZCkpLFxuICAgICAgbWFwKCh7IGRhdGEgfSkgPT4gZGF0YSBhcyBJT3BlcmF0aW9uKSxcbiAgICAgIHdpdGhMYXRlc3RGcm9tKG9ic2VydmVkT3BlcmF0aW9uJCksXG4gICAgICBmaWx0ZXIoKFtvcGVyYXRpb25VcGRhdGUsIG9ic2VydmVkT3BlcmF0aW9uXSkgPT4gb3BlcmF0aW9uVXBkYXRlLmlkID09PSBvYnNlcnZlZE9wZXJhdGlvbi5pZCksXG4gICAgICBzd2l0Y2hNYXAoKFtvcGVyYXRpb25VcGRhdGVdKSA9PiB7XG4gICAgICAgIGlmIChvcGVyYXRpb25VcGRhdGUuc3RhdHVzID09PSBPcGVyYXRpb25TdGF0dXMuRkFJTEVEKSB7XG4gICAgICAgICAgcmV0dXJuIHRocm93RXJyb3Iob3BlcmF0aW9uVXBkYXRlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gb2Yob3BlcmF0aW9uVXBkYXRlKTtcbiAgICAgIH0pLFxuICAgICAgdGFrZVdoaWxlKG9wZXJhdGlvblVwZGF0ZSA9PiBvcGVyYXRpb25VcGRhdGUuc3RhdHVzICE9PSBPcGVyYXRpb25TdGF0dXMuU1VDQ0VTU0ZVTCwgdHJ1ZSlcbiAgICApO1xuICAgIHJldHVybiBtZXJnZShvYnNlcnZlZE9wZXJhdGlvbiQsIG9wZXJhdGlvblVwZGF0ZXMkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIGEgc2luZ2xlIGV2ZW50IHdpdGggbGF0ZXN0IGNyZWF0aW9uVGltZSBmb3IgdGhlIGdpdmVuIGRldmljZSBJZCBhbmQgZXZlbnQgdHlwZS5cbiAgICogQHBhcmFtIGRldmljZUlkIFRoZSBkZXZpY2UgSWQgZm9yIHdoaWNoIHRoZSBldmVudHMgc2hvdWxkIGJlIHF1ZXJpZWQuXG4gICAqIEBwYXJhbSB0eXBlIEV2ZW50IHR5cGUuXG4gICAqL1xuICBhc3luYyBnZXRMYXRlc3RDb25maWd1cmF0aW9uRXZlbnQoXG4gICAgZGV2aWNlSWQ6IHN0cmluZyB8IG51bWJlcixcbiAgICB0eXBlOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxJRXZlbnQgfCB1bmRlZmluZWQ+IHtcbiAgICBjb25zdCBldmVudEZpbHRlcjogb2JqZWN0ID0ge1xuICAgICAgc291cmNlOiBkZXZpY2VJZCxcbiAgICAgIHR5cGUsXG4gICAgICBkYXRlRnJvbTogdGhpcy5kYXRlRnJvbS50b0lTT1N0cmluZygpLFxuICAgICAgZGF0ZVRvOiB0aGlzLmRhdGVUby50b0lTT1N0cmluZygpLFxuICAgICAgcGFnZVNpemU6IDFcbiAgICB9O1xuXG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmV2ZW50Lmxpc3QoZXZlbnRGaWx0ZXIpO1xuICAgIHJldHVybiBkYXRhWzBdO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgYSBsaXN0IG9mIG9wZXJhdGlvbnMgZm9yIHRoZSBnaXZlbiBkZXZpY2UgSWQsIGFuZCBvcGVyYXRpb24gdHlwZS5cbiAgICogQHBhcmFtIGRldmljZUlkIFRoZSBkZXZpY2UgSWQgZm9yIHdoaWNoIHRoZSBvcGVyYXRpb24gc2hvdWxkIGJlIHF1ZXJpZWQuXG4gICAqIEBwYXJhbSBvcGVyYXRpb25UeXBlIE9wZXJhdGlvbiB0eXBlIGZyYWdtZW50LlxuICAgKi9cbiAgYXN5bmMgZ2V0Q29uZmlnRmlsZU9wZXJhdGlvbkxpc3QoXG4gICAgZGV2aWNlSWQ6IHN0cmluZyB8IG51bWJlcixcbiAgICBvcGVyYXRpb25UeXBlOiBzdHJpbmdcbiAgKTogUHJvbWlzZTxJT3BlcmF0aW9uW10+IHtcbiAgICBjb25zdCBvcGVyYXRpb25GaWx0ZXI6IG9iamVjdCA9IHtcbiAgICAgIGRldmljZUlkLFxuICAgICAgZnJhZ21lbnRUeXBlOiBvcGVyYXRpb25UeXBlLFxuICAgICAgZGF0ZUZyb206IHRoaXMuZGF0ZUZyb20udG9JU09TdHJpbmcoKSxcbiAgICAgIGRhdGVUbzogdGhpcy5kYXRlVG8udG9JU09TdHJpbmcoKSxcbiAgICAgIHJldmVydDogdHJ1ZSxcbiAgICAgIHBhZ2VTaXplOiAyMDAwXG4gICAgfTtcblxuICAgIHJldHVybiAoYXdhaXQgdGhpcy5vcGVyYXRpb24ubGlzdChvcGVyYXRpb25GaWx0ZXIpKS5kYXRhO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgbGF0ZXN0IHVwbG9hZGVkIGNvbmZpZ3VyYXRpb24gc25hcHNob3QgZm9yIHRoZSBnaXZlbiBkZXZpY2UsIGFuZCBjb25maWd1cmF0aW9uIHR5cGUuXG4gICAqIEBwYXJhbSBkZXZpY2UgVGhlIGRldmljZSBmb3Igd2hpY2ggdGhlIGNvbmZpZ3VyYXRpb24gc25hcHNob3Qgd2FzIHVwbG9hZGVkLlxuICAgKiBAcGFyYW0gY29uZmlndXJhdGlvblR5cGUgU2VsZWN0ZWQgY29uZmlndXJhdGlvbiB0eXBlLlxuICAgKi9cbiAgYXN5bmMgZ2V0Q29uZmlnU25hcHNob3QoXG4gICAgZGV2aWNlOiBJTWFuYWdlZE9iamVjdCxcbiAgICBjb25maWd1cmF0aW9uVHlwZTogc3RyaW5nXG4gICk6IFByb21pc2U8Q29uZmlndXJhdGlvblNuYXBzaG90IHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgZXZlbnQ6IElFdmVudCA9IGF3YWl0IHRoaXMuZ2V0TGF0ZXN0Q29uZmlndXJhdGlvbkV2ZW50KGRldmljZS5pZCwgY29uZmlndXJhdGlvblR5cGUpO1xuICAgIGxldCBjb25maWdTbmFwc2hvdDogQ29uZmlndXJhdGlvblNuYXBzaG90O1xuICAgIGlmIChldmVudCkge1xuICAgICAgY29uZmlnU25hcHNob3QgPSB7XG4gICAgICAgIHRpbWU6IGV2ZW50LnRpbWUsXG4gICAgICAgIG5hbWU6IGV2ZW50LnRleHQsXG4gICAgICAgIGRldmljZVR5cGU6IGRldmljZS50eXBlLFxuICAgICAgICBjb25maWd1cmF0aW9uVHlwZVxuICAgICAgfTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbmZpZ1NuYXBzaG90LmJpbmFyeSA9IGF3YWl0IChhd2FpdCB0aGlzLmV2ZW50QmluYXJ5LmRvd25sb2FkKGV2ZW50KSkudGV4dCgpO1xuICAgICAgICBpZiAoZXZlbnQuYzh5X0lzQmluYXJ5KSB7XG4gICAgICAgICAgY29uZmlnU25hcHNob3QuYmluYXJ5VHlwZSA9IGV2ZW50LmM4eV9Jc0JpbmFyeS50eXBlO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChleCkge1xuICAgICAgICBjb25zdCBtc2cgPSBnZXR0ZXh0KCdDb3VsZCBub3QgZ2V0IHRoZSBiaW5hcnkuJyk7XG4gICAgICAgIHRoaXMuYWxlcnQuZGFuZ2VyKG1zZyk7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBjb25maWdTbmFwc2hvdDtcbiAgfVxuXG4gIGFzeW5jIGdldExlZ2FjeUNvbmZpZ1NuYXBzaG90KGRldmljZUlkKSB7XG4gICAgbGV0IGNvbmZpZ1NuYXBzaG90OiBDb25maWd1cmF0aW9uU25hcHNob3Q7XG4gICAgbGV0IG1vO1xuICAgIGNvbnN0IGRldmljZSA9IChhd2FpdCB0aGlzLmludmVudG9yeS5kZXRhaWwoZGV2aWNlSWQsIHsgd2l0aENoaWxkcmVuOiBmYWxzZSB9KSkuZGF0YTtcbiAgICBjb25zdCBzbmFwc2hvdElkID0gZGV2aWNlLmM4eV9Db25maWd1cmF0aW9uRHVtcCAmJiBkZXZpY2UuYzh5X0NvbmZpZ3VyYXRpb25EdW1wLmlkO1xuICAgIGlmICghc25hcHNob3RJZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBtbyA9IChhd2FpdCB0aGlzLmludmVudG9yeS5kZXRhaWwoc25hcHNob3RJZCkpLmRhdGE7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICB9XG4gICAgaWYgKG1vKSB7XG4gICAgICBjb25maWdTbmFwc2hvdCA9IHtcbiAgICAgICAgdGltZTogbW8uY3JlYXRpb25UaW1lLFxuICAgICAgICBuYW1lOiBtby5uYW1lXG4gICAgICB9O1xuICAgICAgY29uZmlnU25hcHNob3QuYmluYXJ5ID0gYXdhaXQgdGhpcy5nZXRCaW5hcnlUZXh0KG1vLnVybCwgeyBhbGxvd0V4dGVybmFsOiBmYWxzZSB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbmZpZ1NuYXBzaG90O1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYSBiaW5hcnkgb2JqZWN0IGFzIHRleHQuXG4gICAqIEBwYXJhbSBiaW5hcnlVcmwgVGhlIFVSTCB0byBmaW5kIGJpbmFyeVxuICAgKiBAcGFyYW0gb3B0aW9ucyBUaGUgb2JqZWN0IHdpdGggYWRkaXRpb25hbCBvcHRpb25zOlxuICAgKiAtICoqYWxsb3dFeHRlcm5hbCoqIC0gYGJvb2xlYW5gIC0gYWxsb3dzIGRvd25sb2FkaW5nIGV4dGVybmFsIGJpbmFyeSBmaWxlXG4gICAqIC0gKipub0FsZXJ0cyoqIC0gYGJvb2xlYW5gIC0gZG8gbm90IGRpc3BsYXkgYW4gYWxlcnQgbWVzc2FnZTsgZGVmYXVsdHMgdG8gYGZhbHNlYFxuICAgKi9cbiAgYXN5bmMgZ2V0QmluYXJ5VGV4dChcbiAgICBiaW5hcnlVcmw6IHN0cmluZyxcbiAgICBvcHRpb25zOiB7IGFsbG93RXh0ZXJuYWw6IGJvb2xlYW47IG5vQWxlcnRzPzogYm9vbGVhbiB9XG4gICk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgYmluYXJ5SWQgPSB0aGlzLmludmVudG9yeUJpbmFyeS5nZXRJZEZyb21VcmwoYmluYXJ5VXJsKTtcbiAgICBsZXQgcmVzO1xuICAgIGlmICghYmluYXJ5SWQgJiYgb3B0aW9ucy5hbGxvd0V4dGVybmFsKSB7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLmdldEV4dGVybmFsQmluYXJ5UmVzcG9uc2UoYmluYXJ5VXJsLCBvcHRpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy5nZXRJbnRlcm5hbEJpbmFyeVJlc3BvbnNlKGJpbmFyeUlkLCBvcHRpb25zKTtcbiAgICB9XG4gICAgaWYgKCFyZXMpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gcmVzLnRleHQoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGEgYmluYXJ5IG9iamVjdCBhcyBGaWxlLlxuICAgKiBAcGFyYW0gYmluYXJ5VXJsIFRoZSBVUkwgdG8gZmluZCBiaW5hcnlcbiAgICogQHBhcmFtIG9wdGlvbnMgVGhlIG9iamVjdCB3aXRoIGFkZGl0aW9uYWwgb3B0aW9uczpcbiAgICogLSAqKmFsbG93RXh0ZXJuYWwqKiAtIGBib29sZWFuYCAtIGFsbG93cyBkb3dubG9hZGluZyBleHRlcm5hbCBiaW5hcnkgZmlsZVxuICAgKi9cbiAgYXN5bmMgZ2V0QmluYXJ5RmlsZShiaW5hcnlVcmw6IHN0cmluZywgb3B0aW9uczogeyBhbGxvd0V4dGVybmFsOiBib29sZWFuIH0pOiBQcm9taXNlPEZpbGU+IHtcbiAgICBjb25zdCBiaW5hcnlJZCA9IHRoaXMuaW52ZW50b3J5QmluYXJ5LmdldElkRnJvbVVybChiaW5hcnlVcmwpO1xuICAgIGlmICghYmluYXJ5SWQgJiYgIW9wdGlvbnMuYWxsb3dFeHRlcm5hbCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIC8vIEBUT0RPOiBub3RlIHRoYXQgaXQgZG9lc24ndCBzb2x2ZSBpc3N1ZSB3aXRoIGV4dGVybmFsIGJpbmFyeSBoZXJlLCBzdWNoIHVybCB3b24ndCBoYXZlIGJpbmFyeUlkLCBzbyB3ZSB3b24ndCBrbm93IHRoZSBuYW1lIG9yIGNvbnRlbnRUeXBlIHRvIHVzZSBpbiBGaWxlIGNvbnN0cnVjdG9yLCBsZXQncyBhZGQgYSBARklYTUUgY29tbWVudCBmb3Igbm93P1xuICAgIGNvbnN0IHsgbmFtZSwgY29udGVudFR5cGUgfSA9IChhd2FpdCB0aGlzLmludmVudG9yeS5kZXRhaWwoYmluYXJ5SWQpKS5kYXRhO1xuICAgIGNvbnN0IHJlcyA9ICEhYmluYXJ5SWRcbiAgICAgID8gYXdhaXQgdGhpcy5nZXRJbnRlcm5hbEJpbmFyeVJlc3BvbnNlKGJpbmFyeUlkKVxuICAgICAgOiBhd2FpdCB0aGlzLmdldEV4dGVybmFsQmluYXJ5UmVzcG9uc2UoYmluYXJ5VXJsKTtcbiAgICBjb25zdCBhcnJheUJ1ZmZlciA9IGF3YWl0IHJlcy5hcnJheUJ1ZmZlcigpO1xuICAgIHJldHVybiBuZXcgRmlsZShbYXJyYXlCdWZmZXJdLCBuYW1lLCB7IHR5cGU6IGNvbnRlbnRUeXBlIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgdGhlIGxhc3QgY29uZmlndXJhdGlvbiB1cGRhdGUgb3BlcmF0aW9uIGZvciBnaXZlbiBkZXZpY2UuXG4gICAqIExvb2tzIGZvciBjOHlfQ29uZmlndXJhdGlvbiBhbmQgYzh5X1NlbmRDb25maWd1cmF0aW9uIG9wZXJhdGlvbnMuXG4gICAqIEBwYXJhbSBkZXZpY2VJZCBUaGUgSUQgb2YgdGhlIGRldmljZSB0byBmaW5kIGFuIG9wZXJhdGlvbiBmb3IuXG4gICAqL1xuICBhc3luYyBnZXRMYXN0Q29uZmlnVXBkYXRlT3BlcmF0aW9uKGRldmljZUlkOiBzdHJpbmcgfCBudW1iZXIpOiBQcm9taXNlPElPcGVyYXRpb24+IHtcbiAgICBjb25zdCBmaWx0ZXJzID0ge1xuICAgICAgZGV2aWNlSWQsXG4gICAgICBkYXRlRnJvbTogbmV3IERhdGUoMCkudG9JU09TdHJpbmcoKSxcbiAgICAgIGRhdGVUbzogbmV3IERhdGUoRGF0ZS5ub3coKSkudG9JU09TdHJpbmcoKSxcbiAgICAgIHJldmVydDogdHJ1ZSxcbiAgICAgIHBhZ2VTaXplOiAxXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5nZXRMYXRlc3RNYXRjaGluZ09wZXJhdGlvbihbXG4gICAgICB7IC4uLmZpbHRlcnMsIGZyYWdtZW50VHlwZTogJ2M4eV9Db25maWd1cmF0aW9uJyB9LFxuICAgICAgeyAuLi5maWx0ZXJzLCBmcmFnbWVudFR5cGU6ICdjOHlfU2VuZENvbmZpZ3VyYXRpb24nIH1cbiAgICBdKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcmVwYXJlcyBhIGNvbmZpZ3VyYXRpb24gZG93bmxvYWQgb3BlcmF0aW9uIGZvciBnaXZlbiBkZXZpY2UgYW5kIGl0cyBjdXJyZW50IGNvbmZpZ3VyYXRpb24uXG4gICAqIFN1cHBvcnRzIGM4eV9TZW5kQ29uZmlndXJhdGlvbiBvcGVyYXRpb24uXG4gICAqIEBwYXJhbSBkZXZpY2UgVGhlIGRldmljZSBmb3Igd2hpY2ggb3BlcmF0aW9uIHNob3VsZCBiZSBwcmVwYXJlZC5cbiAgICovXG4gIGNyZWF0ZVRleHRCYXNlZENvbmZpZ3VyYXRpb25SZWxvYWRPcGVyYXRpb24oZGV2aWNlOiBJTWFuYWdlZE9iamVjdCk6IElPcGVyYXRpb24ge1xuICAgIHJldHVybiB7XG4gICAgICBkZXZpY2VJZDogZGV2aWNlLmlkLFxuICAgICAgZGVzY3JpcHRpb246IGdldHRleHQoJ1JlcXVlc3RlZCBjdXJyZW50IGNvbmZpZ3VyYXRpb24nKSxcbiAgICAgIGM4eV9TZW5kQ29uZmlndXJhdGlvbjoge31cbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFByZXBhcmVzIGEgY29uZmlndXJhdGlvbiB1cGRhdGUgb3BlcmF0aW9uIGZvciB0aGUgZ2l2ZW4gZGV2aWNlLlxuICAgKiBTdXBwb3J0cyBjOHlfQ29uZmlndXJhdGlvbiBvcGVyYXRpb24uXG4gICAqIEBwYXJhbSBkZXZpY2UgVGhlIGRldmljZSBmb3Igd2hpY2ggb3BlcmF0aW9uIHNob3VsZCBiZSBwcmVwYXJlZC5cbiAgICogQHBhcmFtIGNvbmZpZyBUaGUgY29uZmlndXJhdGlvbiB3aGljaCB3aWxsIHVwZGF0ZSB0aGUgZXhpc3Rpbmcgb25lLlxuICAgKi9cbiAgY3JlYXRlVGV4dEJhc2VkQ29uZmlndXJhdGlvblVwZGF0ZU9wZXJhdGlvbihkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LCBjb25maWc6IHN0cmluZyk6IElPcGVyYXRpb24ge1xuICAgIHJldHVybiB7XG4gICAgICBkZXZpY2VJZDogZGV2aWNlLmlkLFxuICAgICAgZGVzY3JpcHRpb246IGdldHRleHQoJ0NvbmZpZ3VyYXRpb24gdXBkYXRlJyksXG4gICAgICBjOHlfQ29uZmlndXJhdGlvbjoge1xuICAgICAgICBjb25maWdcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgZ2V0QmluYXJ5KGJpbmFyeUlkOiBJZFJlZmVyZW5jZSk6IFByb21pc2U8SUZldGNoUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuaW52ZW50b3J5QmluYXJ5LmRvd25sb2FkKGJpbmFyeUlkKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgY29uc3QgbXNnID0gZ2V0dGV4dCgnQ291bGQgbm90IGdldCB0aGUgYmluYXJ5LicpO1xuICAgICAgdGhpcy5hbGVydC5kYW5nZXIobXNnKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBhbGwgYXZhaWxhYmxlIHNuYXBzaG90cyBmcm9tIHRoZSByZXBvc2l0b3J5IGZvciB0aGUgZ2l2ZW4gZGV2aWNlLlxuICAgKiBAcGFyYW0gZGV2aWNlIFRoZSBkZXZpY2UgZm9yIHdoaWNoIHRoZSBzbmFwc2hvdHMgc2hvdWxkIGJlIHByZXBhcmVkLlxuICAgKiBAcGFyYW0gY29uZmlndXJhdGlvblR5cGUgU2VsZWN0ZWQgY29uZmlndXJhdGlvbiB0eXBlLlxuICAgKi9cbiAgYXN5bmMgZ2V0U25hcHNob3RzRnJvbVJlcG9zaXRvcnkoZGV2aWNlLCBjb25maWd1cmF0aW9uVHlwZSkge1xuICAgIGNvbnN0IHNlYXJjaFF1ZXJ5ID0gdGhpcy5nZXRDb25maWd1cmF0aW9uVHlwZVF1ZXJ5KGRldmljZSwgY29uZmlndXJhdGlvblR5cGUpO1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMubGlzdFJlcG9zaXRvcnlFbnRyaWVzKFJlcG9zaXRvcnlUeXBlLkNPTkZJR1VSQVRJT04sIHtcbiAgICAgIHF1ZXJ5OiBzZWFyY2hRdWVyeSxcbiAgICAgIHBhcmFtczogeyBwYWdlU2l6ZTogMTAwIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcmVzLmRhdGE7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhIGJpbmFyeSBvYmplY3QuXG4gICAqIEBwYXJhbSBiaW5hcnlJZCBiaW5hcnkgSURcbiAgICogQHBhcmFtIG9wdGlvbnMgVGhlIG9iamVjdCB3aXRoIGFkZGl0aW9uYWwgb3B0aW9uczpcbiAgICogLSAqKm5vQWxlcnRzKiogLSBgYm9vbGVhbmAgLSBkbyBub3QgZGlzcGxheSBhbiBhbGVydCBtZXNzYWdlOyBkZWZhdWx0cyB0byBgZmFsc2VgXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGdldEludGVybmFsQmluYXJ5UmVzcG9uc2UoXG4gICAgYmluYXJ5SWQ6IElkUmVmZXJlbmNlLFxuICAgIG9wdGlvbnM6IHsgbm9BbGVydHM/OiBib29sZWFuIH0gPSB7fVxuICApOiBQcm9taXNlPElGZXRjaFJlc3BvbnNlPiB7XG4gICAgbGV0IHJlcztcbiAgICB0cnkge1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlCaW5hcnkuZG93bmxvYWQoYmluYXJ5SWQpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICBpZiAoIW9wdGlvbnMubm9BbGVydHMpIHtcbiAgICAgICAgY29uc3QgbXNnID0gZ2V0dGV4dCgnQ291bGQgbm90IGdldCB0aGUgYmluYXJ5LicpO1xuICAgICAgICB0aGlzLmFsZXJ0LmRhbmdlcihtc2cpO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYSBiaW5hcnkgb2JqZWN0LlxuICAgKiBAcGFyYW0gYmluYXJ5VXJsIFRoZSBVUkwgdG8gZmluZCBiaW5hcnlcbiAgICogQHBhcmFtIG9wdGlvbnMgVGhlIG9iamVjdCB3aXRoIGFkZGl0aW9uYWwgb3B0aW9uczpcbiAgICogLSAqKm5vQWxlcnRzKiogLSBgYm9vbGVhbmAgLSBkbyBub3QgZGlzcGxheSBhbiBhbGVydCBtZXNzYWdlOyBkZWZhdWx0cyB0byBgZmFsc2VgXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGdldEV4dGVybmFsQmluYXJ5UmVzcG9uc2UoXG4gICAgYmluYXJ5VXJsOiBzdHJpbmcsXG4gICAgb3B0aW9uczogeyBub0FsZXJ0cz86IGJvb2xlYW4gfSA9IHt9XG4gICk6IFByb21pc2U8SUZldGNoUmVzcG9uc2U+IHtcbiAgICBsZXQgcmVzO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBmZXRjaFJlcyA9IGF3YWl0IGZldGNoKGJpbmFyeVVybCk7XG4gICAgICBpZiAoZmV0Y2hSZXMuc3RhdHVzID49IDQwMCkge1xuICAgICAgICB0aHJvdyByZXM7XG4gICAgICB9XG4gICAgICByZXMgPSBmZXRjaFJlcztcbiAgICB9IGNhdGNoIHtcbiAgICAgIGlmICghb3B0aW9ucy5ub0FsZXJ0cykge1xuICAgICAgICBjb25zdCBtc2cgPSBnZXR0ZXh0KCdDb3VsZCBub3QgZ2V0IHRoZSBleHRlcm5hbCBiaW5hcnknKTtcbiAgICAgICAgdGhpcy5hbGVydC5kYW5nZXIobXNnKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY3JlYXRlRW50cnkobW86IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+KSB7XG4gICAgY29uc3QgYmluYXJ5SWQgPSBhd2FpdCB0aGlzLmludmVudG9yeUJpbmFyeS5nZXRJZEZyb21VcmwobW8udXJsKTtcbiAgICBjb25zdCBuZXdNbyA9IGF3YWl0IHRoaXMuaW52ZW50b3J5LmNyZWF0ZShtbyk7XG4gICAgaWYgKGJpbmFyeUlkKSB7XG4gICAgICBhd2FpdCB0aGlzLmludmVudG9yeS5jaGlsZEFkZGl0aW9uc0FkZChiaW5hcnlJZCwgbmV3TW8uZGF0YSk7XG4gICAgfVxuICAgIHJldHVybiBuZXdNbztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdXBkYXRlRW50cnkobW86IFBhcnRpYWw8SU1hbmFnZWRPYmplY3Q+LCB1cmwpIHtcbiAgICBjb25zdCBleGlzdGluZ0JpbmFyeUlkID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlCaW5hcnkuZ2V0SWRGcm9tVXJsKHVybCk7XG4gICAgY29uc3QgbmV3QmluYXJ5SWQgPSBhd2FpdCB0aGlzLmludmVudG9yeUJpbmFyeS5nZXRJZEZyb21VcmwobW8udXJsKTtcbiAgICBpZiAoZXhpc3RpbmdCaW5hcnlJZCAmJiBleGlzdGluZ0JpbmFyeUlkICE9PSBuZXdCaW5hcnlJZCkge1xuICAgICAgY29uc3QgaWQgPSB0aGlzLmludmVudG9yeUJpbmFyeS5nZXRJZEZyb21VcmwodXJsKTtcbiAgICAgIGF3YWl0IHRoaXMuaW52ZW50b3J5QmluYXJ5LmRlbGV0ZShpZCk7XG4gICAgfVxuICAgIGlmIChuZXdCaW5hcnlJZCkge1xuICAgICAgYXdhaXQgdGhpcy5pbnZlbnRvcnkuY2hpbGRBZGRpdGlvbnNBZGQobmV3QmluYXJ5SWQsIG1vKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5LnVwZGF0ZShtbyk7XG4gIH1cblxuICBwcml2YXRlIGdldEJhc2VWZXJzaW9uUmVzdWx0TGlzdEZvckxlZ2FjeUVudHJ5KGVudHJ5KSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICByZXM6IHt9IGFzIElGZXRjaFJlc3BvbnNlLFxuICAgICAgZGF0YTogW1xuICAgICAgICB7XG4gICAgICAgICAgLi4uZW50cnksXG4gICAgICAgICAgW2VudHJ5LnR5cGVdOiB7XG4gICAgICAgICAgICB2ZXJzaW9uOiBlbnRyeS52ZXJzaW9uLFxuICAgICAgICAgICAgdXJsOiBlbnRyeS51cmxcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIF1cbiAgICB9IGFzIElSZXN1bHRMaXN0PElNYW5hZ2VkT2JqZWN0Pik7XG4gIH1cblxuICBwcml2YXRlIGdldERldmljZVNvZnR3YXJlQ2hhbmdlc0Zyb21Tb2Z0d2FyZUxpc3RPcGVyYXRpb24oXG4gICAgb3BlcmF0aW9uOiBJT3BlcmF0aW9uLFxuICAgIGRldmljZTogSU1hbmFnZWRPYmplY3RcbiAgKTogRGV2aWNlU29mdHdhcmVDaGFuZ2VbXSB7XG4gICAgY29uc3QgY2hhbmdlczogRGV2aWNlU29mdHdhcmVDaGFuZ2VbXSA9IFtdO1xuICAgIGZvckVhY2goZGV2aWNlLmM4eV9Tb2Z0d2FyZUxpc3QsIGRldmljZVNvZnR3YXJlID0+IHtcbiAgICAgIGNvbnN0IG9wZXJhdGlvblNvZnR3YXJlID0gZmluZChvcGVyYXRpb24uYzh5X1NvZnR3YXJlTGlzdCwgeyBuYW1lOiBkZXZpY2VTb2Z0d2FyZS5uYW1lIH0pO1xuICAgICAgaWYgKFxuICAgICAgICAob3BlcmF0aW9uU29mdHdhcmUgJiYgb3BlcmF0aW9uU29mdHdhcmUudmVyc2lvbikgIT09XG4gICAgICAgIChkZXZpY2VTb2Z0d2FyZSAmJiBkZXZpY2VTb2Z0d2FyZS52ZXJzaW9uKVxuICAgICAgKSB7XG4gICAgICAgIGNoYW5nZXMucHVzaCh7XG4gICAgICAgICAgLi4uZGV2aWNlU29mdHdhcmUsXG4gICAgICAgICAgYWN0aW9uOiAnZGVsZXRlJ1xuICAgICAgICB9IGFzIERldmljZVNvZnR3YXJlQ2hhbmdlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBmb3JFYWNoKG9wZXJhdGlvbi5jOHlfU29mdHdhcmVMaXN0LCBvcGVyYXRpb25Tb2Z0d2FyZSA9PiB7XG4gICAgICBjb25zdCBkZXZpY2VTb2Z0d2FyZSA9IGZpbmQoZGV2aWNlLmM4eV9Tb2Z0d2FyZUxpc3QsIHsgbmFtZTogb3BlcmF0aW9uU29mdHdhcmUubmFtZSB9KTtcbiAgICAgIGlmIChcbiAgICAgICAgKG9wZXJhdGlvblNvZnR3YXJlICYmIG9wZXJhdGlvblNvZnR3YXJlLnZlcnNpb24pICE9PVxuICAgICAgICAoZGV2aWNlU29mdHdhcmUgJiYgZGV2aWNlU29mdHdhcmUudmVyc2lvbilcbiAgICAgICkge1xuICAgICAgICBjaGFuZ2VzLnB1c2goe1xuICAgICAgICAgIC4uLm9wZXJhdGlvblNvZnR3YXJlLFxuICAgICAgICAgIGFjdGlvbjogJ2luc3RhbGwnXG4gICAgICAgIH0gYXMgRGV2aWNlU29mdHdhcmVDaGFuZ2UpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBjaGFuZ2VzO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREZXZpY2VTb2Z0d2FyZUNoYW5nZXNGcm9tU29mdHdhcmVPcGVyYXRpb24oXG4gICAgb3BlcmF0aW9uOiBJT3BlcmF0aW9uLFxuICAgIGRldmljZTogSU1hbmFnZWRPYmplY3RcbiAgKTogRGV2aWNlU29mdHdhcmVDaGFuZ2VbXSB7XG4gICAgY29uc3QgY2hhbmdlczogRGV2aWNlU29mdHdhcmVDaGFuZ2VbXSA9IFtdO1xuICAgIGZvckVhY2goZGV2aWNlLmM4eV9Tb2Z0d2FyZSwgKGRldmljZVNvZnR3YXJlVmVyc2lvbiwgZGV2aWNlU29mdHdhcmVOYW1lKSA9PiB7XG4gICAgICBpZiAob3BlcmF0aW9uLmM4eV9Tb2Z0d2FyZVtkZXZpY2VTb2Z0d2FyZU5hbWVdICE9PSBkZXZpY2VTb2Z0d2FyZVZlcnNpb24pIHtcbiAgICAgICAgY2hhbmdlcy5wdXNoKHtcbiAgICAgICAgICBuYW1lOiBkZXZpY2VTb2Z0d2FyZU5hbWUsXG4gICAgICAgICAgdmVyc2lvbjogZGV2aWNlU29mdHdhcmVWZXJzaW9uLFxuICAgICAgICAgIGFjdGlvbjogJ2RlbGV0ZSdcbiAgICAgICAgfSBhcyBEZXZpY2VTb2Z0d2FyZUNoYW5nZSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgZm9yRWFjaChvcGVyYXRpb24uYzh5X1NvZnR3YXJlLCAob3BlcmF0aW9uU29mdHdhcmVWZXJzaW9uLCBvcGVyYXRpb25Tb2Z0d2FyZU5hbWUpID0+IHtcbiAgICAgIGNvbnN0IGRldmljZVNvZnR3YXJlVmVyc2lvbiA9XG4gICAgICAgIGRldmljZS5jOHlfU29mdHdhcmUgJiYgZGV2aWNlLmM4eV9Tb2Z0d2FyZVtvcGVyYXRpb25Tb2Z0d2FyZU5hbWVdO1xuICAgICAgaWYgKGRldmljZVNvZnR3YXJlVmVyc2lvbiAhPT0gb3BlcmF0aW9uU29mdHdhcmVWZXJzaW9uKSB7XG4gICAgICAgIGNoYW5nZXMucHVzaCh7XG4gICAgICAgICAgbmFtZTogb3BlcmF0aW9uU29mdHdhcmVOYW1lLFxuICAgICAgICAgIHZlcnNpb246IG9wZXJhdGlvblNvZnR3YXJlVmVyc2lvbixcbiAgICAgICAgICBhY3Rpb246ICdpbnN0YWxsJ1xuICAgICAgICB9IGFzIERldmljZVNvZnR3YXJlQ2hhbmdlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gY2hhbmdlcztcbiAgfVxufVxuIl19