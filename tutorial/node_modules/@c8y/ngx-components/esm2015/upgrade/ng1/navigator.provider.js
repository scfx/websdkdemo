import { Subject, defer, of } from 'rxjs';
import { merge } from 'rxjs/operators';
import { pick, map, property, some, every } from 'lodash-es';
import { NavigatorNodeRootLegacy } from './navigator-node-root-legacy';
// Just to hook into the bridge service
export function c8yNavigatorProvider() {
    const root = new NavigatorNodeRootLegacy();
    const rootNodesSubject = new Subject();
    const conditionalNodes = [];
    const rootNodes$ = rootNodesSubject.pipe(merge(defer(() => of(root.children))));
    function addNavigation(nodes) {
        const nodeList = (Array.isArray(nodes) ? nodes : [nodes]);
        nodeList.forEach((node) => {
            if (isConditional(node)) {
                node.hidden = undefined;
                conditionalNodes.push(node);
            }
            node.navNode = root.addRoot(node);
        });
        rootNodesSubject.next(root.children);
    }
    function removeNavigation(node) {
        const found = root.find((n) => n === node);
        if (found) {
            found.parents.forEach((p) => p.remove(found));
            rootNodesSubject.next(root.children);
        }
    }
    function findNode(node) {
        return root.find(node);
    }
    function isConditional(node) {
        return node.showIf || node.showIfPermissions || node.showIfContainsVisibleViews;
    }
    function $get($q, $injector) {
        'ngInject';
        // This avoids the circular dependency
        setTimeout(() => conditionalNodes.forEach(processShowIf));
        function processShowIf(node) {
            const c8yUiUtil = $injector.get('c8yUiUtil');
            const visibilityPromises = [];
            const { showIf, showIfPermissions, showIfContainsVisibleViews } = node;
            if (showIf) {
                visibilityPromises.push($injector.invoke(showIf));
            }
            if (showIfContainsVisibleViews) {
                visibilityPromises.push(viewsConditionalVisibility(node));
            }
            c8yUiUtil.configureVisibility({
                showIf: () => $q.all(visibilityPromises).then(every),
                showIfPermissions
            }, 'visible')
                .then(({ visible }) => {
                if (visible) {
                    node.navNode.update({
                        hidden: false,
                        showIf: null,
                        showIfPermission: null,
                        showIfContainsVisibleViews: null
                    });
                }
                else {
                    node.navNode.update({
                        hidden: true
                    });
                }
            });
        }
        function viewsConditionalVisibility(node) {
            const c8yUiUtil = $injector.get('c8yUiUtil');
            const c8yViews = $injector.get('c8yViews');
            const views = c8yViews.getByPath(node.path);
            return $q.all(map(views, (view) => c8yUiUtil
                .configureVisibility(pick(view, ['showIf', 'showIfPermissions']), 'show', false)
                .then(property('show'))))
                .then(some);
        }
        return {
            rootNodes() {
                return root.children;
            },
            findNode,
            addNavigation,
            removeNavigation,
            rootNodes$
        };
    }
    return {
        $get,
        addNavigation,
        removeNavigation
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdG9yLnByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vdXBncmFkZS9uZzEvbmF2aWdhdG9yLnByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBYyxPQUFPLEVBQUUsS0FBSyxFQUFFLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdkMsT0FBTyxFQUFFLElBQUksRUFBRyxHQUFHLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDOUQsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFFdkUsdUNBQXVDO0FBQ3ZDLE1BQU0sVUFBVSxvQkFBb0I7SUFDbEMsTUFBTSxJQUFJLEdBQUcsSUFBSSx1QkFBdUIsRUFBRSxDQUFDO0lBQzNDLE1BQU0sZ0JBQWdCLEdBQTZCLElBQUksT0FBTyxFQUFFLENBQUM7SUFDakUsTUFBTSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7SUFDNUIsTUFBTSxVQUFVLEdBQWdDLGdCQUFnQixDQUFDLElBQUksQ0FDbkUsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FDdEMsQ0FBQztJQUVGLFNBQVMsYUFBYSxDQUFDLEtBQUs7UUFDMUIsTUFBTSxRQUFRLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUMxRCxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDeEIsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQ3ZCLElBQUksQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDO2dCQUN4QixnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDN0I7WUFDRCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEMsQ0FBQyxDQUFDLENBQUM7UUFDSCxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFRCxTQUFTLGdCQUFnQixDQUFDLElBQUk7UUFDNUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDO1FBQzNDLElBQUksS0FBSyxFQUFFO1lBQ1QsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUM5QyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3RDO0lBQ0gsQ0FBQztJQUVELFNBQVMsUUFBUSxDQUFDLElBQUk7UUFDcEIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3pCLENBQUM7SUFFRCxTQUFTLGFBQWEsQ0FBQyxJQUFJO1FBQ3pCLE9BQU8sSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLDBCQUEwQixDQUFDO0lBQ2xGLENBQUM7SUFFRCxTQUFTLElBQUksQ0FBQyxFQUFFLEVBQUUsU0FBUztRQUN6QixVQUFVLENBQUM7UUFFWCxzQ0FBc0M7UUFDdEMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1FBRTFELFNBQVMsYUFBYSxDQUFDLElBQUk7WUFDekIsTUFBTSxTQUFTLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUM3QyxNQUFNLGtCQUFrQixHQUFHLEVBQUUsQ0FBQztZQUM5QixNQUFNLEVBQ0osTUFBTSxFQUNOLGlCQUFpQixFQUNqQiwwQkFBMEIsRUFDM0IsR0FBRyxJQUFJLENBQUM7WUFFVCxJQUFJLE1BQU0sRUFBRTtnQkFDVixrQkFBa0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2FBQ25EO1lBQ0QsSUFBSSwwQkFBMEIsRUFBRTtnQkFDOUIsa0JBQWtCLENBQUMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7YUFDM0Q7WUFFRCxTQUFTLENBQUMsbUJBQW1CLENBQUM7Z0JBQzVCLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztnQkFDcEQsaUJBQWlCO2FBQ2xCLEVBQUUsU0FBUyxDQUFDO2lCQUNWLElBQUksQ0FBQyxDQUFDLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRTtnQkFDcEIsSUFBSSxPQUFPLEVBQUU7b0JBQ1gsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7d0JBQ2xCLE1BQU0sRUFBRSxLQUFLO3dCQUNiLE1BQU0sRUFBRSxJQUFJO3dCQUNaLGdCQUFnQixFQUFFLElBQUk7d0JBQ3RCLDBCQUEwQixFQUFFLElBQUk7cUJBQ2pDLENBQUMsQ0FBQztpQkFDSjtxQkFBTTtvQkFDTCxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQzt3QkFDbEIsTUFBTSxFQUFFLElBQUk7cUJBQ2IsQ0FBQyxDQUFDO2lCQUNKO1lBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDO1FBRUQsU0FBUywwQkFBMEIsQ0FBQyxJQUFJO1lBQ3RDLE1BQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDN0MsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUMzQyxNQUFNLEtBQUssR0FBRyxRQUFRLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM1QyxPQUFPLEVBQUUsQ0FBQyxHQUFHLENBQ1gsR0FBRyxDQUFDLEtBQUssRUFBRSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsU0FBUztpQkFDM0IsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLFFBQVEsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQztpQkFDL0UsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUN4QixDQUNGO2lCQUNBLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNkLENBQUM7UUFFRCxPQUFPO1lBQ0wsU0FBUztnQkFDUCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7WUFDdkIsQ0FBQztZQUNELFFBQVE7WUFDUixhQUFhO1lBQ2IsZ0JBQWdCO1lBQ2hCLFVBQVU7U0FDWCxDQUFDO0lBQ0osQ0FBQztJQUVELE9BQU87UUFDTCxJQUFJO1FBQ0osYUFBYTtRQUNiLGdCQUFnQjtLQUNqQixDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5hdmlnYXRvck5vZGUgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIGRlZmVyLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgbWVyZ2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBwaWNrLCAgbWFwLCBwcm9wZXJ0eSwgc29tZSwgZXZlcnkgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgTmF2aWdhdG9yTm9kZVJvb3RMZWdhY3kgfSBmcm9tICcuL25hdmlnYXRvci1ub2RlLXJvb3QtbGVnYWN5JztcblxuLy8gSnVzdCB0byBob29rIGludG8gdGhlIGJyaWRnZSBzZXJ2aWNlXG5leHBvcnQgZnVuY3Rpb24gYzh5TmF2aWdhdG9yUHJvdmlkZXIoKSB7XG4gIGNvbnN0IHJvb3QgPSBuZXcgTmF2aWdhdG9yTm9kZVJvb3RMZWdhY3koKTtcbiAgY29uc3Qgcm9vdE5vZGVzU3ViamVjdDogU3ViamVjdDxOYXZpZ2F0b3JOb2RlW10+ID0gbmV3IFN1YmplY3QoKTtcbiAgY29uc3QgY29uZGl0aW9uYWxOb2RlcyA9IFtdO1xuICBjb25zdCByb290Tm9kZXMkOiBPYnNlcnZhYmxlPE5hdmlnYXRvck5vZGVbXT4gPSByb290Tm9kZXNTdWJqZWN0LnBpcGUoXG4gICAgbWVyZ2UoZGVmZXIoKCkgPT4gb2Yocm9vdC5jaGlsZHJlbikpKSxcbiAgKTtcblxuICBmdW5jdGlvbiBhZGROYXZpZ2F0aW9uKG5vZGVzKSB7XG4gICAgY29uc3Qgbm9kZUxpc3QgPSAoQXJyYXkuaXNBcnJheShub2RlcykgPyBub2RlcyA6IFtub2Rlc10pO1xuICAgIG5vZGVMaXN0LmZvckVhY2goKG5vZGUpID0+IHtcbiAgICAgIGlmIChpc0NvbmRpdGlvbmFsKG5vZGUpKSB7XG4gICAgICAgIG5vZGUuaGlkZGVuID0gdW5kZWZpbmVkO1xuICAgICAgICBjb25kaXRpb25hbE5vZGVzLnB1c2gobm9kZSk7XG4gICAgICB9XG4gICAgICBub2RlLm5hdk5vZGUgPSByb290LmFkZFJvb3Qobm9kZSk7XG4gICAgfSk7XG4gICAgcm9vdE5vZGVzU3ViamVjdC5uZXh0KHJvb3QuY2hpbGRyZW4pO1xuICB9XG5cbiAgZnVuY3Rpb24gcmVtb3ZlTmF2aWdhdGlvbihub2RlKSB7XG4gICAgY29uc3QgZm91bmQgPSByb290LmZpbmQoKG4pID0+IG4gPT09IG5vZGUpO1xuICAgIGlmIChmb3VuZCkge1xuICAgICAgZm91bmQucGFyZW50cy5mb3JFYWNoKChwKSA9PiBwLnJlbW92ZShmb3VuZCkpO1xuICAgICAgcm9vdE5vZGVzU3ViamVjdC5uZXh0KHJvb3QuY2hpbGRyZW4pO1xuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIGZpbmROb2RlKG5vZGUpIHtcbiAgICByZXR1cm4gcm9vdC5maW5kKG5vZGUpO1xuICB9XG5cbiAgZnVuY3Rpb24gaXNDb25kaXRpb25hbChub2RlKSB7XG4gICAgcmV0dXJuIG5vZGUuc2hvd0lmIHx8IG5vZGUuc2hvd0lmUGVybWlzc2lvbnMgfHwgbm9kZS5zaG93SWZDb250YWluc1Zpc2libGVWaWV3cztcbiAgfVxuXG4gIGZ1bmN0aW9uICRnZXQoJHEsICRpbmplY3Rvcikge1xuICAgICduZ0luamVjdCc7XG5cbiAgICAvLyBUaGlzIGF2b2lkcyB0aGUgY2lyY3VsYXIgZGVwZW5kZW5jeVxuICAgIHNldFRpbWVvdXQoKCkgPT4gY29uZGl0aW9uYWxOb2Rlcy5mb3JFYWNoKHByb2Nlc3NTaG93SWYpKTtcblxuICAgIGZ1bmN0aW9uIHByb2Nlc3NTaG93SWYobm9kZSkge1xuICAgICAgY29uc3QgYzh5VWlVdGlsID0gJGluamVjdG9yLmdldCgnYzh5VWlVdGlsJyk7XG4gICAgICBjb25zdCB2aXNpYmlsaXR5UHJvbWlzZXMgPSBbXTtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgc2hvd0lmLFxuICAgICAgICBzaG93SWZQZXJtaXNzaW9ucyxcbiAgICAgICAgc2hvd0lmQ29udGFpbnNWaXNpYmxlVmlld3NcbiAgICAgIH0gPSBub2RlO1xuXG4gICAgICBpZiAoc2hvd0lmKSB7XG4gICAgICAgIHZpc2liaWxpdHlQcm9taXNlcy5wdXNoKCRpbmplY3Rvci5pbnZva2Uoc2hvd0lmKSk7XG4gICAgICB9XG4gICAgICBpZiAoc2hvd0lmQ29udGFpbnNWaXNpYmxlVmlld3MpIHtcbiAgICAgICAgdmlzaWJpbGl0eVByb21pc2VzLnB1c2godmlld3NDb25kaXRpb25hbFZpc2liaWxpdHkobm9kZSkpO1xuICAgICAgfVxuXG4gICAgICBjOHlVaVV0aWwuY29uZmlndXJlVmlzaWJpbGl0eSh7XG4gICAgICAgIHNob3dJZjogKCkgPT4gJHEuYWxsKHZpc2liaWxpdHlQcm9taXNlcykudGhlbihldmVyeSksXG4gICAgICAgIHNob3dJZlBlcm1pc3Npb25zXG4gICAgICB9LCAndmlzaWJsZScpXG4gICAgICAgIC50aGVuKCh7IHZpc2libGUgfSkgPT4ge1xuICAgICAgICAgIGlmICh2aXNpYmxlKSB7XG4gICAgICAgICAgICBub2RlLm5hdk5vZGUudXBkYXRlKHtcbiAgICAgICAgICAgICAgaGlkZGVuOiBmYWxzZSxcbiAgICAgICAgICAgICAgc2hvd0lmOiBudWxsLFxuICAgICAgICAgICAgICBzaG93SWZQZXJtaXNzaW9uOiBudWxsLFxuICAgICAgICAgICAgICBzaG93SWZDb250YWluc1Zpc2libGVWaWV3czogbnVsbFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5vZGUubmF2Tm9kZS51cGRhdGUoe1xuICAgICAgICAgICAgICBoaWRkZW46IHRydWVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gdmlld3NDb25kaXRpb25hbFZpc2liaWxpdHkobm9kZSkge1xuICAgICAgY29uc3QgYzh5VWlVdGlsID0gJGluamVjdG9yLmdldCgnYzh5VWlVdGlsJyk7XG4gICAgICBjb25zdCBjOHlWaWV3cyA9ICRpbmplY3Rvci5nZXQoJ2M4eVZpZXdzJyk7XG4gICAgICBjb25zdCB2aWV3cyA9IGM4eVZpZXdzLmdldEJ5UGF0aChub2RlLnBhdGgpO1xuICAgICAgcmV0dXJuICRxLmFsbChcbiAgICAgICAgbWFwKHZpZXdzLCAodmlldykgPT4gYzh5VWlVdGlsXG4gICAgICAgICAgLmNvbmZpZ3VyZVZpc2liaWxpdHkocGljayh2aWV3LCBbJ3Nob3dJZicsICdzaG93SWZQZXJtaXNzaW9ucyddKSwgJ3Nob3cnLCBmYWxzZSlcbiAgICAgICAgICAudGhlbihwcm9wZXJ0eSgnc2hvdycpKVxuICAgICAgICApXG4gICAgICApXG4gICAgICAudGhlbihzb21lKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgcm9vdE5vZGVzKCkge1xuICAgICAgICByZXR1cm4gcm9vdC5jaGlsZHJlbjtcbiAgICAgIH0sXG4gICAgICBmaW5kTm9kZSxcbiAgICAgIGFkZE5hdmlnYXRpb24sXG4gICAgICByZW1vdmVOYXZpZ2F0aW9uLFxuICAgICAgcm9vdE5vZGVzJFxuICAgIH07XG4gIH1cblxuICByZXR1cm4ge1xuICAgICRnZXQsXG4gICAgYWRkTmF2aWdhdGlvbixcbiAgICByZW1vdmVOYXZpZ2F0aW9uXG4gIH07XG59XG4iXX0=