import { Component, Input, Output, ViewChild, EventEmitter } from '@angular/core';
import { AppLogsService } from './app-logs.service';
import { fromEvent, Subject, of, interval, NEVER } from 'rxjs';
import { filter, catchError, tap, debounce, switchMap, takeUntil, finalize, delay, repeat, merge, scan } from 'rxjs/operators';
export class AppLogsAutoRefreshComponent {
    constructor(appLogsService) {
        this.appLogsService = appLogsService;
        this.cancel$ = new Subject();
        this.isAutoRefreshDisabled = false;
        this.logsToOutput = this.getEmptyLogsJson();
        this.isAutoRefreshOn = true;
        this.onNewLogs = new EventEmitter();
        this.isRealtimeEnabled = new EventEmitter();
        this.toggleState = currentState => !currentState;
    }
    set buttonsDisabled(areDisabled) {
        this.isAutoRefreshDisabled = areDisabled;
        if (areDisabled && this.isAutoRefreshOn) {
            this.isAutoRefreshOn = false;
            this.cancel$.next(false);
        }
    }
    ngAfterViewInit() {
        const clicks$ = fromEvent(this.button.nativeElement, 'click').pipe(merge(this.cancel$), debounce(() => interval(300)), scan(this.toggleState, false), tap(isAutoRefreshOn => this.setButtonState(isAutoRefreshOn)), switchMap(isOn => (isOn ? this.watchForNewLogs() : NEVER)));
        this.subscription = clicks$.subscribe();
    }
    ngOnDestroy() {
        if (this.subscription) {
            this.subscription.unsubscribe();
        }
    }
    setButtonState(isAutoRefreshOn) {
        this.isAutoRefreshOn = isAutoRefreshOn;
        this.isRealtimeEnabled.emit(isAutoRefreshOn);
    }
    watchForNewLogs() {
        return this.startPolling().pipe(takeUntil(this.cancel$.pipe(filter(isAutoRefreshOn => isAutoRefreshOn === false))), finalize(() => {
            this.isAutoRefreshOn = false;
        }));
    }
    startPolling() {
        return of(1).pipe(switchMap(() => this.getNewLogs().pipe(catchError(er => of(this.getEmptyLogsJson())))), tap(logs => this.updateLogsToOutput(logs)), delay(10000), repeat());
    }
    getNewLogs() {
        return this.appLogsService.getLogs$(this.getAppId(), this.getInstanceName());
    }
    getAppId() {
        return this.mo.applicationId;
    }
    getInstanceName() {
        return this.selectedInstance.name;
    }
    updateLogsToOutput(newLogs) {
        const { dateFrom, dateTo } = newLogs;
        if (dateFrom && dateTo) {
            this.logsToOutput = Object.assign({}, newLogs);
            this.onNewLogs.emit(this.logsToOutput);
        }
    }
    getEmptyLogsJson() {
        return {
            dateFrom: null,
            dateTo: null,
            logs: '',
            truncated: false
        };
    }
}
AppLogsAutoRefreshComponent.decorators = [
    { type: Component, args: [{
                selector: 'c8y-app-logs-auto-refresh',
                template: "<button #autoRefresh\n  type=\"button\"\n  class=\"btn btn-link c8y-realtime\"\n  [ngStyle]=\"{'width': 'auto'}\"\n  title=\"{{'Toggle auto refresh' | translate}}\"\n  [disabled]=\"isAutoRefreshDisabled\"\n>\n  <span class=\"c8y-pulse\" [ngClass]=\"isAutoRefreshOn ? 'active' : 'inactive'\"></span>\n  {{'Auto refresh' | translate}}\n</button>"
            },] }
];
AppLogsAutoRefreshComponent.ctorParameters = () => [
    { type: AppLogsService }
];
AppLogsAutoRefreshComponent.propDecorators = {
    selectedInstance: [{ type: Input }],
    mo: [{ type: Input }],
    buttonsDisabled: [{ type: Input }],
    onNewLogs: [{ type: Output }],
    isRealtimeEnabled: [{ type: Output }],
    button: [{ type: ViewChild, args: ['autoRefresh', { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLWxvZ3MtYXV0by1yZWZyZXNoLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2FwcC1sb2dzL2FwcC1sb2dzLWF1dG8tcmVmcmVzaC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQWMsTUFBTSxlQUFlLENBQUM7QUFFOUYsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3BELE9BQU8sRUFBYyxTQUFTLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUN6RixPQUFPLEVBQ0wsTUFBTSxFQUNOLFVBQVUsRUFDVixHQUFHLEVBQ0gsUUFBUSxFQUNSLFNBQVMsRUFDVCxTQUFTLEVBQ1QsUUFBUSxFQUNSLEtBQUssRUFDTCxNQUFNLEVBQ04sS0FBSyxFQUNMLElBQUksRUFDTCxNQUFNLGdCQUFnQixDQUFDO0FBTXhCLE1BQU0sT0FBTywyQkFBMkI7SUFxQnRDLFlBQW9CLGNBQThCO1FBQTlCLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQXBCbEQsWUFBTyxHQUFxQixJQUFJLE9BQU8sRUFBVyxDQUFDO1FBQ25ELDBCQUFxQixHQUFZLEtBQUssQ0FBQztRQUN2QyxpQkFBWSxHQUFhLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQ2pELG9CQUFlLEdBQVksSUFBSSxDQUFDO1FBV3RCLGNBQVMsR0FBRyxJQUFJLFlBQVksRUFBWSxDQUFDO1FBQ3pDLHNCQUFpQixHQUFHLElBQUksWUFBWSxFQUFXLENBQUM7UUF1QmxELGdCQUFXLEdBQUcsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQztJQWxCQyxDQUFDO0lBYnRELElBQWEsZUFBZSxDQUFDLFdBQW9CO1FBQy9DLElBQUksQ0FBQyxx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dEIsSUFBSSxDQUFDLFlBQVkscUJBQVEsT0FBTyxDQUFFLENBQUM7WUFDbkMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQ3hDO0lBQ0gsQ0FBQztJQUVPLGdCQUFnQjtRQUN0QixPQUFPO1lBQ0wsUUFBUSxFQUFFLElBQUk7WUFDZCxNQUFNLEVBQUUsSUFBSTtZQUNaLElBQUksRUFBRSxFQUFFO1lBQ1IsU0FBUyxFQUFFLEtBQUs7U0FDakIsQ0FBQztJQUNKLENBQUM7OztZQTlGRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLDJCQUEyQjtnQkFDckMsbVdBQXFEO2FBQ3REOzs7WUFuQlEsY0FBYzs7OytCQTBCcEIsS0FBSztpQkFDTCxLQUFLOzhCQUNMLEtBQUs7d0JBT0wsTUFBTTtnQ0FDTixNQUFNO3FCQUNOLFNBQVMsU0FBQyxhQUFhLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBJbnB1dCwgT3V0cHV0LCBWaWV3Q2hpbGQsIEV2ZW50RW1pdHRlciwgRWxlbWVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTG9nc0pTT04gfSBmcm9tICcuL2xvZ3MubW9kZWwnO1xuaW1wb3J0IHsgQXBwTG9nc1NlcnZpY2UgfSBmcm9tICcuL2FwcC1sb2dzLnNlcnZpY2UnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbUV2ZW50LCBTdWJqZWN0LCBvZiwgaW50ZXJ2YWwsIE5FVkVSLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGZpbHRlcixcbiAgY2F0Y2hFcnJvcixcbiAgdGFwLFxuICBkZWJvdW5jZSxcbiAgc3dpdGNoTWFwLFxuICB0YWtlVW50aWwsXG4gIGZpbmFsaXplLFxuICBkZWxheSxcbiAgcmVwZWF0LFxuICBtZXJnZSxcbiAgc2NhblxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1hcHAtbG9ncy1hdXRvLXJlZnJlc2gnLFxuICB0ZW1wbGF0ZVVybDogJy4vYXBwLWxvZ3MtYXV0by1yZWZyZXNoLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBBcHBMb2dzQXV0b1JlZnJlc2hDb21wb25lbnQge1xuICBjYW5jZWwkOiBTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcbiAgaXNBdXRvUmVmcmVzaERpc2FibGVkOiBib29sZWFuID0gZmFsc2U7XG4gIGxvZ3NUb091dHB1dDogTG9nc0pTT04gPSB0aGlzLmdldEVtcHR5TG9nc0pzb24oKTtcbiAgaXNBdXRvUmVmcmVzaE9uOiBib29sZWFuID0gdHJ1ZTtcblxuICBASW5wdXQoKSBzZWxlY3RlZEluc3RhbmNlOiBhbnk7XG4gIEBJbnB1dCgpIG1vOiBhbnk7XG4gIEBJbnB1dCgpIHNldCBidXR0b25zRGlzYWJsZWQoYXJlRGlzYWJsZWQ6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmlzQXV0b1JlZnJlc2hEaXNhYmxlZCA9IGFyZURpc2FibGVkO1xuICAgIGlmIChhcmVEaXNhYmxlZCAmJiB0aGlzLmlzQXV0b1JlZnJlc2hPbikge1xuICAgICAgdGhpcy5pc0F1dG9SZWZyZXNoT24gPSBmYWxzZTtcbiAgICAgIHRoaXMuY2FuY2VsJC5uZXh0KGZhbHNlKTtcbiAgICB9XG4gIH1cbiAgQE91dHB1dCgpIG9uTmV3TG9ncyA9IG5ldyBFdmVudEVtaXR0ZXI8TG9nc0pTT04+KCk7XG4gIEBPdXRwdXQoKSBpc1JlYWx0aW1lRW5hYmxlZCA9IG5ldyBFdmVudEVtaXR0ZXI8Ym9vbGVhbj4oKTtcbiAgQFZpZXdDaGlsZCgnYXV0b1JlZnJlc2gnLCB7IHN0YXRpYzogdHJ1ZSB9KSBidXR0b246IEVsZW1lbnRSZWY7XG5cbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcExvZ3NTZXJ2aWNlOiBBcHBMb2dzU2VydmljZSkge31cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgY29uc3QgY2xpY2tzJCA9IGZyb21FdmVudCh0aGlzLmJ1dHRvbi5uYXRpdmVFbGVtZW50LCAnY2xpY2snKS5waXBlKFxuICAgICAgbWVyZ2UodGhpcy5jYW5jZWwkKSxcbiAgICAgIGRlYm91bmNlKCgpID0+IGludGVydmFsKDMwMCkpLFxuICAgICAgc2Nhbih0aGlzLnRvZ2dsZVN0YXRlLCBmYWxzZSksXG4gICAgICB0YXAoaXNBdXRvUmVmcmVzaE9uID0+IHRoaXMuc2V0QnV0dG9uU3RhdGUoaXNBdXRvUmVmcmVzaE9uKSksXG4gICAgICBzd2l0Y2hNYXAoaXNPbiA9PiAoaXNPbiA/IHRoaXMud2F0Y2hGb3JOZXdMb2dzKCkgOiBORVZFUikpXG4gICAgKTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IGNsaWNrcyQuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5zdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG4gIHByaXZhdGUgdG9nZ2xlU3RhdGUgPSBjdXJyZW50U3RhdGUgPT4gIWN1cnJlbnRTdGF0ZTtcblxuICBwcml2YXRlIHNldEJ1dHRvblN0YXRlKGlzQXV0b1JlZnJlc2hPbjogYm9vbGVhbikge1xuICAgIHRoaXMuaXNBdXRvUmVmcmVzaE9uID0gaXNBdXRvUmVmcmVzaE9uO1xuICAgIHRoaXMuaXNSZWFsdGltZUVuYWJsZWQuZW1pdChpc0F1dG9SZWZyZXNoT24pO1xuICB9XG5cbiAgcHJpdmF0ZSB3YXRjaEZvck5ld0xvZ3MoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhcnRQb2xsaW5nKCkucGlwZShcbiAgICAgIHRha2VVbnRpbCh0aGlzLmNhbmNlbCQucGlwZShmaWx0ZXIoaXNBdXRvUmVmcmVzaE9uID0+IGlzQXV0b1JlZnJlc2hPbiA9PT0gZmFsc2UpKSksXG4gICAgICBmaW5hbGl6ZSgoKSA9PiB7XG4gICAgICAgIHRoaXMuaXNBdXRvUmVmcmVzaE9uID0gZmFsc2U7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHN0YXJ0UG9sbGluZygpIHtcbiAgICByZXR1cm4gb2YoMSkucGlwZShcbiAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmdldE5ld0xvZ3MoKS5waXBlKGNhdGNoRXJyb3IoZXIgPT4gb2YodGhpcy5nZXRFbXB0eUxvZ3NKc29uKCkpKSkpLFxuICAgICAgdGFwKGxvZ3MgPT4gdGhpcy51cGRhdGVMb2dzVG9PdXRwdXQobG9ncykpLFxuICAgICAgZGVsYXkoMTAwMDApLFxuICAgICAgcmVwZWF0KClcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXROZXdMb2dzKCk6IE9ic2VydmFibGU8TG9nc0pTT04+IHtcbiAgICByZXR1cm4gdGhpcy5hcHBMb2dzU2VydmljZS5nZXRMb2dzJCh0aGlzLmdldEFwcElkKCksIHRoaXMuZ2V0SW5zdGFuY2VOYW1lKCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRBcHBJZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLm1vLmFwcGxpY2F0aW9uSWQ7XG4gIH1cbiAgcHJpdmF0ZSBnZXRJbnN0YW5jZU5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5zZWxlY3RlZEluc3RhbmNlLm5hbWU7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUxvZ3NUb091dHB1dChuZXdMb2dzKSB7XG4gICAgY29uc3QgeyBkYXRlRnJvbSwgZGF0ZVRvIH0gPSBuZXdMb2dzO1xuICAgIGlmIChkYXRlRnJvbSAmJiBkYXRlVG8pIHtcbiAgICAgIHRoaXMubG9nc1RvT3V0cHV0ID0geyAuLi5uZXdMb2dzIH07XG4gICAgICB0aGlzLm9uTmV3TG9ncy5lbWl0KHRoaXMubG9nc1RvT3V0cHV0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEVtcHR5TG9nc0pzb24oKTogTG9nc0pTT04ge1xuICAgIHJldHVybiB7XG4gICAgICBkYXRlRnJvbTogbnVsbCxcbiAgICAgIGRhdGVUbzogbnVsbCxcbiAgICAgIGxvZ3M6ICcnLFxuICAgICAgdHJ1bmNhdGVkOiBmYWxzZVxuICAgIH07XG4gIH1cbn1cbiJdfQ==