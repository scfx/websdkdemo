import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { InventoryService, OperationService, OperationStatus, QueriesUtil } from '@c8y/client';
import { AlertService } from '@c8y/ngx-components';
import { sortBy, toArray, get } from 'lodash-es';
import { gettext } from '@c8y/ngx-components';
export class DeviceProfileService {
    constructor(inventoryService, operationService, alertService) {
        this.inventoryService = inventoryService;
        this.operationService = operationService;
        this.alertService = alertService;
        this.dateFrom = new Date(0);
        this.dateTo = new Date(Date.now() + 86400000); // 1 day in the future
        this.NOT_INSTALLED_WARNING = gettext('Not installed on the device');
        this.VERSION_MISSMATCH_WARNING = gettext('Version mismatch');
        this.SAME_URL_WARNING = gettext('Installed configuration has the same URL but different name or type than the one in the profile');
        this.queriesUtil = new QueriesUtil();
    }
    createDeviceProfile(deviceProfile) {
        if (get(deviceProfile, 'c8y_Filter.type') === '') {
            delete deviceProfile.c8y_Filter.type;
        }
        return this.inventoryService.create(deviceProfile);
    }
    getDeviceProfilesByDeviceType(deviceType) {
        const deviceTypeFilter = {
            __or: [
                { 'c8y_Filter.type': deviceType },
                { 'c8y_Filter.type': '' },
                { __not: { __has: 'c8y_Filter.type' } }
            ]
        };
        return this.getDeviceProfiles(deviceTypeFilter);
    }
    getDeviceProfiles(andQuery) {
        let query = {
            type: 'c8y_Profile'
        };
        const filter = {
            pageSize: 100,
            withTotalPages: true
        };
        query = this.queriesUtil.addAndFilter(query, andQuery || {});
        return this.inventoryService.listQuery(query, filter);
    }
    getProfileOperation(deviceId) {
        return __awaiter(this, void 0, void 0, function* () {
            const filter = {
                deviceId,
                fragmentType: 'c8y_DeviceProfile',
                dateFrom: this.dateFrom.toISOString(),
                dateTo: this.dateTo.toISOString(),
                revert: true,
                pageSize: 1
            };
            const operation = (yield this.operationService.list(filter)).data[0];
            return operation && operation.status !== OperationStatus.SUCCESSFUL ? operation : undefined;
        });
    }
    createProfileOperation(device, deviceProfile) {
        return __awaiter(this, void 0, void 0, function* () {
            let operation;
            const operationCfg = {
                deviceId: device.id,
                profileId: deviceProfile.id,
                profileName: deviceProfile.name,
                c8y_DeviceProfile: deviceProfile.c8y_DeviceProfile,
                description: `Assign device profile ${deviceProfile.name} to device ${device.name}`
            };
            try {
                const { data } = yield this.operationService.create(operationCfg);
                operation = data;
            }
            catch (ex) {
                this.alertService.addServerFailure(ex);
            }
            return operation;
        });
    }
    getFirmwareItems(device, selectedProfile) {
        const deviceFirmware = device.c8y_Firmware;
        const profileFirmware = get(selectedProfile, 'c8y_DeviceProfile.firmware');
        const deviceItems = [];
        const profileItems = [];
        if (deviceFirmware) {
            deviceItems.push(deviceFirmware);
        }
        if (profileFirmware) {
            profileItems.push(profileFirmware);
        }
        return this.createProfileComparison(deviceItems, profileItems, 'name', 'version', this.getAlert('firmware'));
    }
    getSoftwareItems(device, selectedProfile) {
        const deviceSoftware = device.c8y_SoftwareList;
        const profileSoftware = get(selectedProfile, 'c8y_DeviceProfile.software');
        return this.createProfileComparison(deviceSoftware, profileSoftware, 'name', 'version', this.getAlert('software'));
    }
    getConfigurationItems(device, selectedProfile) {
        const deviceConfiguration = [];
        Object.keys(device).forEach(key => {
            if (key.slice(0, 18) === 'c8y_Configuration_') {
                deviceConfiguration.push(device[key]);
            }
        });
        const profileConfiguration = get(selectedProfile, 'c8y_DeviceProfile.configuration');
        return this.createProfileComparison(deviceConfiguration, profileConfiguration, 'url', 'type', this.getAlert('configuration'));
    }
    getAlert(itemType) {
        const notInstalled = (comparisionResult) => {
            return !comparisionResult.device ? this.NOT_INSTALLED_WARNING : '';
        };
        switch (itemType) {
            case 'firmware':
            case 'software':
                return (comparisionResult) => {
                    return comparisionResult.device &&
                        comparisionResult.profile &&
                        comparisionResult.device.itemDetails !== comparisionResult.profile.itemDetails
                        ? this.VERSION_MISSMATCH_WARNING
                        : notInstalled(comparisionResult);
                };
            case 'configuration':
                return (comparisionResult) => {
                    return comparisionResult.device &&
                        comparisionResult.profile &&
                        (comparisionResult.device.itemName !== comparisionResult.profile.itemName ||
                            comparisionResult.device.itemDetails !== comparisionResult.profile.itemDetails)
                        ? this.SAME_URL_WARNING
                        : notInstalled(comparisionResult);
                };
            default:
                return notInstalled;
        }
    }
    createProfileComparison(deviceItems = [], profileItems = [], mergeByProperty, propertyNameWithDetails, getAlert) {
        const comparisonObj = this.createProfileComparisonFromDeviceItems(deviceItems, mergeByProperty, propertyNameWithDetails);
        const extendedComparisonObj = this.extendProfileComparisonWithProfileItems(comparisonObj, profileItems, mergeByProperty, propertyNameWithDetails, getAlert);
        return sortBy(toArray(extendedComparisonObj), 'name');
    }
    createProfileComparisonFromDeviceItems(deviceItems, mergeByProperty, propertyNameWithDetails) {
        return deviceItems.reduce((comapritionItem, deviceItem) => Object.assign(comapritionItem, {
            [deviceItem[mergeByProperty]]: {
                device: {
                    itemName: deviceItem.name,
                    itemDetails: deviceItem[propertyNameWithDetails],
                    itemUrl: deviceItem.url
                },
                profile: undefined
            }
        }), {});
    }
    extendProfileComparisonWithProfileItems(comparisonObj, profileItems, mergeByProperty, propertyNameWithDetails, getAlert) {
        profileItems.forEach(profileItem => {
            const comparisionResult = {
                profile: {
                    itemName: profileItem.name,
                    itemDetails: profileItem[propertyNameWithDetails],
                    itemUrl: profileItem.url
                },
                device: comparisonObj[profileItem[mergeByProperty]]
                    ? comparisonObj[profileItem[mergeByProperty]].device
                    : undefined
            };
            comparisionResult.comparisonAlert = getAlert(comparisionResult);
            comparisonObj[profileItem[mergeByProperty]] = comparisionResult;
        });
        return comparisonObj;
    }
}
DeviceProfileService.decorators = [
    { type: Injectable }
];
DeviceProfileService.ctorParameters = () => [
    { type: InventoryService },
    { type: OperationService },
    { type: AlertService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLXByb2ZpbGUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2RldmljZS1wcm9maWxlL2RldmljZS1wcm9maWxlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUVMLGdCQUFnQixFQUdoQixnQkFBZ0IsRUFDaEIsZUFBZSxFQUNmLFdBQVcsRUFDWixNQUFNLGFBQWEsQ0FBQztBQU9yQixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ2pELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUc5QyxNQUFNLE9BQU8sb0JBQW9CO0lBVy9CLFlBQ1UsZ0JBQWtDLEVBQ2xDLGdCQUFrQyxFQUNsQyxZQUEwQjtRQUYxQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFiM0IsYUFBUSxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZCLFdBQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxzQkFBc0I7UUFHakUsMEJBQXFCLEdBQUcsT0FBTyxDQUFDLDZCQUE2QixDQUFDLENBQUM7UUFDL0QsOEJBQXlCLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFDeEQscUJBQWdCLEdBQUcsT0FBTyxDQUNoQyxpR0FBaUcsQ0FDbEcsQ0FBQztRQU9BLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztJQUN2QyxDQUFDO0lBRUQs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QUM7SUFFTyx1Q0FBdUMsQ0FDN0MsYUFBcUIsRUFDckIsWUFBa0UsRUFDbEUsZUFBdUIsRUFDdkIsdUJBQStCLEVBQy9CLFFBQXlEO1FBRXpELFlBQVksQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDakMsTUFBTSxpQkFBaUIsR0FBcUI7Z0JBQzFDLE9BQU8sRUFBRTtvQkFDUCxRQUFRLEVBQUUsV0FBVyxDQUFDLElBQUk7b0JBQzFCLFdBQVcsRUFBRSxXQUFXLENBQUMsdUJBQXVCLENBQUM7b0JBQ2pELE9BQU8sRUFBRSxXQUFXLENBQUMsR0FBRztpQkFDekI7Z0JBQ0QsTUFBTSxFQUFFLGFBQWEsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLENBQUM7b0JBQ2pELENBQUMsQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsTUFBTTtvQkFDcEQsQ0FBQyxDQUFDLFNBQVM7YUFDZCxDQUFDO1lBQ0YsaUJBQWlCLENBQUMsZUFBZSxHQUFHLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1lBQ2hFLGFBQWEsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLENBQUMsR0FBRyxpQkFBaUIsQ0FBQztRQUNsRSxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sYUFBYSxDQUFDO0lBQ3ZCLENBQUM7OztZQTNPRixVQUFVOzs7WUFqQlQsZ0JBQWdCO1lBR2hCLGdCQUFnQjtZQVVULFlBQVkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBJTWFuYWdlZE9iamVjdCxcbiAgSW52ZW50b3J5U2VydmljZSxcbiAgSU9wZXJhdGlvbixcbiAgSVJlc3VsdExpc3QsXG4gIE9wZXJhdGlvblNlcnZpY2UsXG4gIE9wZXJhdGlvblN0YXR1cyxcbiAgUXVlcmllc1V0aWxcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHtcbiAgRGV2aWNlUHJvZmlsZSxcbiAgRGV2aWNlUHJvZmlsZUZpcm13YXJlLFxuICBEZXZpY2VQcm9maWxlU29mdHdhcmUsXG4gIENvbXBhcmlzb25SZXN1bHRcbn0gZnJvbSAnLi9kZXZpY2UtcHJvZmlsZS5tb2RlbCc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IHNvcnRCeSwgdG9BcnJheSwgZ2V0IH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IGdldHRleHQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIERldmljZVByb2ZpbGVTZXJ2aWNlIHtcbiAgcmVhZG9ubHkgZGF0ZUZyb20gPSBuZXcgRGF0ZSgwKTtcbiAgcmVhZG9ubHkgZGF0ZVRvID0gbmV3IERhdGUoRGF0ZS5ub3coKSArIDg2NDAwMDAwKTsgLy8gMSBkYXkgaW4gdGhlIGZ1dHVyZVxuICBwcml2YXRlIHF1ZXJpZXNVdGlsOiBRdWVyaWVzVXRpbDtcblxuICBwcml2YXRlIE5PVF9JTlNUQUxMRURfV0FSTklORyA9IGdldHRleHQoJ05vdCBpbnN0YWxsZWQgb24gdGhlIGRldmljZScpO1xuICBwcml2YXRlIFZFUlNJT05fTUlTU01BVENIX1dBUk5JTkcgPSBnZXR0ZXh0KCdWZXJzaW9uIG1pc21hdGNoJyk7XG4gIHByaXZhdGUgU0FNRV9VUkxfV0FSTklORyA9IGdldHRleHQoXG4gICAgJ0luc3RhbGxlZCBjb25maWd1cmF0aW9uIGhhcyB0aGUgc2FtZSBVUkwgYnV0IGRpZmZlcmVudCBuYW1lIG9yIHR5cGUgdGhhbiB0aGUgb25lIGluIHRoZSBwcm9maWxlJ1xuICApO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgaW52ZW50b3J5U2VydmljZTogSW52ZW50b3J5U2VydmljZSxcbiAgICBwcml2YXRlIG9wZXJhdGlvblNlcnZpY2U6IE9wZXJhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhbGVydFNlcnZpY2U6IEFsZXJ0U2VydmljZVxuICApIHtcbiAgICB0aGlzLnF1ZXJpZXNVdGlsID0gbmV3IFF1ZXJpZXNVdGlsKCk7XG4gIH1cblxuICBjcmVhdGVEZXZpY2VQcm9maWxlKGRldmljZVByb2ZpbGU6IFBhcnRpYWw8RGV2aWNlUHJvZmlsZT4pIHtcbiAgICBpZiAoZ2V0KGRldmljZVByb2ZpbGUsICdjOHlfRmlsdGVyLnR5cGUnKSA9PT0gJycpIHtcbiAgICAgIGRlbGV0ZSBkZXZpY2VQcm9maWxlLmM4eV9GaWx0ZXIudHlwZTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5U2VydmljZS5jcmVhdGUoZGV2aWNlUHJvZmlsZSBhcyBJTWFuYWdlZE9iamVjdCk7XG4gIH1cblxuICBnZXREZXZpY2VQcm9maWxlc0J5RGV2aWNlVHlwZShkZXZpY2VUeXBlOiBzdHJpbmcpOiBQcm9taXNlPElSZXN1bHRMaXN0PElNYW5hZ2VkT2JqZWN0Pj4ge1xuICAgIGNvbnN0IGRldmljZVR5cGVGaWx0ZXIgPSB7XG4gICAgICBfX29yOiBbXG4gICAgICAgIHsgJ2M4eV9GaWx0ZXIudHlwZSc6IGRldmljZVR5cGUgfSxcbiAgICAgICAgeyAnYzh5X0ZpbHRlci50eXBlJzogJycgfSxcbiAgICAgICAgeyBfX25vdDogeyBfX2hhczogJ2M4eV9GaWx0ZXIudHlwZScgfSB9XG4gICAgICBdXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5nZXREZXZpY2VQcm9maWxlcyhkZXZpY2VUeXBlRmlsdGVyKTtcbiAgfVxuXG4gIGdldERldmljZVByb2ZpbGVzKGFuZFF1ZXJ5PzogYW55KTogUHJvbWlzZTxJUmVzdWx0TGlzdDxJTWFuYWdlZE9iamVjdD4+IHtcbiAgICBsZXQgcXVlcnk6IG9iamVjdCA9IHtcbiAgICAgIHR5cGU6ICdjOHlfUHJvZmlsZSdcbiAgICB9O1xuICAgIGNvbnN0IGZpbHRlcjogb2JqZWN0ID0ge1xuICAgICAgcGFnZVNpemU6IDEwMCxcbiAgICAgIHdpdGhUb3RhbFBhZ2VzOiB0cnVlXG4gICAgfTtcbiAgICBxdWVyeSA9IHRoaXMucXVlcmllc1V0aWwuYWRkQW5kRmlsdGVyKHF1ZXJ5LCBhbmRRdWVyeSB8fCB7fSk7XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5U2VydmljZS5saXN0UXVlcnkocXVlcnksIGZpbHRlcik7XG4gIH1cblxuICBhc3luYyBnZXRQcm9maWxlT3BlcmF0aW9uKGRldmljZUlkOiBzdHJpbmcgfCBudW1iZXIpIHtcbiAgICBjb25zdCBmaWx0ZXI6IG9iamVjdCA9IHtcbiAgICAgIGRldmljZUlkLFxuICAgICAgZnJhZ21lbnRUeXBlOiAnYzh5X0RldmljZVByb2ZpbGUnLFxuICAgICAgZGF0ZUZyb206IHRoaXMuZGF0ZUZyb20udG9JU09TdHJpbmcoKSxcbiAgICAgIGRhdGVUbzogdGhpcy5kYXRlVG8udG9JU09TdHJpbmcoKSxcbiAgICAgIHJldmVydDogdHJ1ZSxcbiAgICAgIHBhZ2VTaXplOiAxXG4gICAgfTtcblxuICAgIGNvbnN0IG9wZXJhdGlvbiA9IChhd2FpdCB0aGlzLm9wZXJhdGlvblNlcnZpY2UubGlzdChmaWx0ZXIpKS5kYXRhWzBdO1xuICAgIHJldHVybiBvcGVyYXRpb24gJiYgb3BlcmF0aW9uLnN0YXR1cyAhPT0gT3BlcmF0aW9uU3RhdHVzLlNVQ0NFU1NGVUwgPyBvcGVyYXRpb24gOiB1bmRlZmluZWQ7XG4gIH1cblxuICBhc3luYyBjcmVhdGVQcm9maWxlT3BlcmF0aW9uKGRldmljZTogSU1hbmFnZWRPYmplY3QsIGRldmljZVByb2ZpbGU6IFBhcnRpYWw8RGV2aWNlUHJvZmlsZT4pIHtcbiAgICBsZXQgb3BlcmF0aW9uO1xuICAgIGNvbnN0IG9wZXJhdGlvbkNmZzogSU9wZXJhdGlvbiA9IHtcbiAgICAgIGRldmljZUlkOiBkZXZpY2UuaWQsXG4gICAgICBwcm9maWxlSWQ6IGRldmljZVByb2ZpbGUuaWQsXG4gICAgICBwcm9maWxlTmFtZTogZGV2aWNlUHJvZmlsZS5uYW1lLFxuICAgICAgYzh5X0RldmljZVByb2ZpbGU6IGRldmljZVByb2ZpbGUuYzh5X0RldmljZVByb2ZpbGUsXG4gICAgICBkZXNjcmlwdGlvbjogYEFzc2lnbiBkZXZpY2UgcHJvZmlsZSAke2RldmljZVByb2ZpbGUubmFtZX0gdG8gZGV2aWNlICR7ZGV2aWNlLm5hbWV9YFxuICAgIH07XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmNyZWF0ZShvcGVyYXRpb25DZmcpO1xuICAgICAgb3BlcmF0aW9uID0gZGF0YTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICAgIHJldHVybiBvcGVyYXRpb247XG4gIH1cblxuICBnZXRGaXJtd2FyZUl0ZW1zKFxuICAgIGRldmljZTogSU1hbmFnZWRPYmplY3QsXG4gICAgc2VsZWN0ZWRQcm9maWxlOiBQYXJ0aWFsPERldmljZVByb2ZpbGU+XG4gICk6IENvbXBhcmlzb25SZXN1bHRbXSB7XG4gICAgY29uc3QgZGV2aWNlRmlybXdhcmUgPSBkZXZpY2UuYzh5X0Zpcm13YXJlO1xuICAgIGNvbnN0IHByb2ZpbGVGaXJtd2FyZSA9IGdldChzZWxlY3RlZFByb2ZpbGUsICdjOHlfRGV2aWNlUHJvZmlsZS5maXJtd2FyZScpO1xuICAgIGNvbnN0IGRldmljZUl0ZW1zID0gW107XG4gICAgY29uc3QgcHJvZmlsZUl0ZW1zID0gW107XG5cbiAgICBpZiAoZGV2aWNlRmlybXdhcmUpIHtcbiAgICAgIGRldmljZUl0ZW1zLnB1c2goZGV2aWNlRmlybXdhcmUpO1xuICAgIH1cbiAgICBpZiAocHJvZmlsZUZpcm13YXJlKSB7XG4gICAgICBwcm9maWxlSXRlbXMucHVzaChwcm9maWxlRmlybXdhcmUpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5jcmVhdGVQcm9maWxlQ29tcGFyaXNvbihcbiAgICAgIGRldmljZUl0ZW1zLFxuICAgICAgcHJvZmlsZUl0ZW1zLFxuICAgICAgJ25hbWUnLFxuICAgICAgJ3ZlcnNpb24nLFxuICAgICAgdGhpcy5nZXRBbGVydCgnZmlybXdhcmUnKVxuICAgICk7XG4gIH1cblxuICBnZXRTb2Z0d2FyZUl0ZW1zKFxuICAgIGRldmljZTogSU1hbmFnZWRPYmplY3QsXG4gICAgc2VsZWN0ZWRQcm9maWxlOiBQYXJ0aWFsPERldmljZVByb2ZpbGU+XG4gICk6IENvbXBhcmlzb25SZXN1bHRbXSB7XG4gICAgY29uc3QgZGV2aWNlU29mdHdhcmUgPSBkZXZpY2UuYzh5X1NvZnR3YXJlTGlzdDtcbiAgICBjb25zdCBwcm9maWxlU29mdHdhcmUgPSBnZXQoc2VsZWN0ZWRQcm9maWxlLCAnYzh5X0RldmljZVByb2ZpbGUuc29mdHdhcmUnKTtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVQcm9maWxlQ29tcGFyaXNvbihcbiAgICAgIGRldmljZVNvZnR3YXJlLFxuICAgICAgcHJvZmlsZVNvZnR3YXJlLFxuICAgICAgJ25hbWUnLFxuICAgICAgJ3ZlcnNpb24nLFxuICAgICAgdGhpcy5nZXRBbGVydCgnc29mdHdhcmUnKVxuICAgICk7XG4gIH1cblxuICBnZXRDb25maWd1cmF0aW9uSXRlbXMoXG4gICAgZGV2aWNlOiBJTWFuYWdlZE9iamVjdCxcbiAgICBzZWxlY3RlZFByb2ZpbGU6IFBhcnRpYWw8RGV2aWNlUHJvZmlsZT5cbiAgKTogQ29tcGFyaXNvblJlc3VsdFtdIHtcbiAgICBjb25zdCBkZXZpY2VDb25maWd1cmF0aW9uID0gW107XG4gICAgT2JqZWN0LmtleXMoZGV2aWNlKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBpZiAoa2V5LnNsaWNlKDAsIDE4KSA9PT0gJ2M4eV9Db25maWd1cmF0aW9uXycpIHtcbiAgICAgICAgZGV2aWNlQ29uZmlndXJhdGlvbi5wdXNoKGRldmljZVtrZXldKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBjb25zdCBwcm9maWxlQ29uZmlndXJhdGlvbiA9IGdldChzZWxlY3RlZFByb2ZpbGUsICdjOHlfRGV2aWNlUHJvZmlsZS5jb25maWd1cmF0aW9uJyk7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlUHJvZmlsZUNvbXBhcmlzb24oXG4gICAgICBkZXZpY2VDb25maWd1cmF0aW9uLFxuICAgICAgcHJvZmlsZUNvbmZpZ3VyYXRpb24sXG4gICAgICAndXJsJyxcbiAgICAgICd0eXBlJyxcbiAgICAgIHRoaXMuZ2V0QWxlcnQoJ2NvbmZpZ3VyYXRpb24nKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldEFsZXJ0KGl0ZW1UeXBlOiBzdHJpbmcpOiAoY29tcGFyaXNpb25SZXN1bHQ6IENvbXBhcmlzb25SZXN1bHQpID0+IHN0cmluZyB7XG4gICAgY29uc3Qgbm90SW5zdGFsbGVkID0gKGNvbXBhcmlzaW9uUmVzdWx0OiBDb21wYXJpc29uUmVzdWx0KSA9PiB7XG4gICAgICByZXR1cm4gIWNvbXBhcmlzaW9uUmVzdWx0LmRldmljZSA/IHRoaXMuTk9UX0lOU1RBTExFRF9XQVJOSU5HIDogJyc7XG4gICAgfTtcblxuICAgIHN3aXRjaCAoaXRlbVR5cGUpIHtcbiAgICAgIGNhc2UgJ2Zpcm13YXJlJzpcbiAgICAgIGNhc2UgJ3NvZnR3YXJlJzpcbiAgICAgICAgcmV0dXJuIChjb21wYXJpc2lvblJlc3VsdDogQ29tcGFyaXNvblJlc3VsdCkgPT4ge1xuICAgICAgICAgIHJldHVybiBjb21wYXJpc2lvblJlc3VsdC5kZXZpY2UgJiZcbiAgICAgICAgICAgIGNvbXBhcmlzaW9uUmVzdWx0LnByb2ZpbGUgJiZcbiAgICAgICAgICAgIGNvbXBhcmlzaW9uUmVzdWx0LmRldmljZS5pdGVtRGV0YWlscyAhPT0gY29tcGFyaXNpb25SZXN1bHQucHJvZmlsZS5pdGVtRGV0YWlsc1xuICAgICAgICAgICAgPyB0aGlzLlZFUlNJT05fTUlTU01BVENIX1dBUk5JTkdcbiAgICAgICAgICAgIDogbm90SW5zdGFsbGVkKGNvbXBhcmlzaW9uUmVzdWx0KTtcbiAgICAgICAgfTtcbiAgICAgIGNhc2UgJ2NvbmZpZ3VyYXRpb24nOlxuICAgICAgICByZXR1cm4gKGNvbXBhcmlzaW9uUmVzdWx0OiBDb21wYXJpc29uUmVzdWx0KSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGNvbXBhcmlzaW9uUmVzdWx0LmRldmljZSAmJlxuICAgICAgICAgICAgY29tcGFyaXNpb25SZXN1bHQucHJvZmlsZSAmJlxuICAgICAgICAgICAgKGNvbXBhcmlzaW9uUmVzdWx0LmRldmljZS5pdGVtTmFtZSAhPT0gY29tcGFyaXNpb25SZXN1bHQucHJvZmlsZS5pdGVtTmFtZSB8fFxuICAgICAgICAgICAgICBjb21wYXJpc2lvblJlc3VsdC5kZXZpY2UuaXRlbURldGFpbHMgIT09IGNvbXBhcmlzaW9uUmVzdWx0LnByb2ZpbGUuaXRlbURldGFpbHMpXG4gICAgICAgICAgICA/IHRoaXMuU0FNRV9VUkxfV0FSTklOR1xuICAgICAgICAgICAgOiBub3RJbnN0YWxsZWQoY29tcGFyaXNpb25SZXN1bHQpO1xuICAgICAgICB9O1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIG5vdEluc3RhbGxlZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVByb2ZpbGVDb21wYXJpc29uKFxuICAgIGRldmljZUl0ZW1zOiBhbnlbXSA9IFtdLFxuICAgIHByb2ZpbGVJdGVtczogQXJyYXk8RGV2aWNlUHJvZmlsZVNvZnR3YXJlIHwgRGV2aWNlUHJvZmlsZUZpcm13YXJlPiA9IFtdLFxuICAgIG1lcmdlQnlQcm9wZXJ0eTogc3RyaW5nLFxuICAgIHByb3BlcnR5TmFtZVdpdGhEZXRhaWxzOiBzdHJpbmcsXG4gICAgZ2V0QWxlcnQ6IChjb21wYXJpc2lvblJlc3VsdDogQ29tcGFyaXNvblJlc3VsdCkgPT4gc3RyaW5nXG4gICk6IENvbXBhcmlzb25SZXN1bHRbXSB7XG4gICAgY29uc3QgY29tcGFyaXNvbk9iaiA9IHRoaXMuY3JlYXRlUHJvZmlsZUNvbXBhcmlzb25Gcm9tRGV2aWNlSXRlbXMoXG4gICAgICBkZXZpY2VJdGVtcyxcbiAgICAgIG1lcmdlQnlQcm9wZXJ0eSxcbiAgICAgIHByb3BlcnR5TmFtZVdpdGhEZXRhaWxzXG4gICAgKTtcbiAgICBjb25zdCBleHRlbmRlZENvbXBhcmlzb25PYmogPSB0aGlzLmV4dGVuZFByb2ZpbGVDb21wYXJpc29uV2l0aFByb2ZpbGVJdGVtcyhcbiAgICAgIGNvbXBhcmlzb25PYmosXG4gICAgICBwcm9maWxlSXRlbXMsXG4gICAgICBtZXJnZUJ5UHJvcGVydHksXG4gICAgICBwcm9wZXJ0eU5hbWVXaXRoRGV0YWlscyxcbiAgICAgIGdldEFsZXJ0XG4gICAgKTtcbiAgICByZXR1cm4gc29ydEJ5KHRvQXJyYXkoZXh0ZW5kZWRDb21wYXJpc29uT2JqKSwgJ25hbWUnKTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUHJvZmlsZUNvbXBhcmlzb25Gcm9tRGV2aWNlSXRlbXMoXG4gICAgZGV2aWNlSXRlbXM6IGFueVtdLFxuICAgIG1lcmdlQnlQcm9wZXJ0eTogc3RyaW5nLFxuICAgIHByb3BlcnR5TmFtZVdpdGhEZXRhaWxzOiBzdHJpbmdcbiAgKTogYW55IHtcbiAgICByZXR1cm4gZGV2aWNlSXRlbXMucmVkdWNlKFxuICAgICAgKGNvbWFwcml0aW9uSXRlbSwgZGV2aWNlSXRlbSkgPT5cbiAgICAgICAgT2JqZWN0LmFzc2lnbihjb21hcHJpdGlvbkl0ZW0sIHtcbiAgICAgICAgICBbZGV2aWNlSXRlbVttZXJnZUJ5UHJvcGVydHldXToge1xuICAgICAgICAgICAgZGV2aWNlOiB7XG4gICAgICAgICAgICAgIGl0ZW1OYW1lOiBkZXZpY2VJdGVtLm5hbWUsXG4gICAgICAgICAgICAgIGl0ZW1EZXRhaWxzOiBkZXZpY2VJdGVtW3Byb3BlcnR5TmFtZVdpdGhEZXRhaWxzXSxcbiAgICAgICAgICAgICAgaXRlbVVybDogZGV2aWNlSXRlbS51cmxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBwcm9maWxlOiB1bmRlZmluZWRcbiAgICAgICAgICB9XG4gICAgICAgIH0pLFxuICAgICAge31cbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBleHRlbmRQcm9maWxlQ29tcGFyaXNvbldpdGhQcm9maWxlSXRlbXMoXG4gICAgY29tcGFyaXNvbk9iajogb2JqZWN0LFxuICAgIHByb2ZpbGVJdGVtczogQXJyYXk8RGV2aWNlUHJvZmlsZVNvZnR3YXJlIHwgRGV2aWNlUHJvZmlsZUZpcm13YXJlPixcbiAgICBtZXJnZUJ5UHJvcGVydHk6IHN0cmluZyxcbiAgICBwcm9wZXJ0eU5hbWVXaXRoRGV0YWlsczogc3RyaW5nLFxuICAgIGdldEFsZXJ0OiAoY29tcGFyaXNpb25SZXN1bHQ6IENvbXBhcmlzb25SZXN1bHQpID0+IHN0cmluZ1xuICApIHtcbiAgICBwcm9maWxlSXRlbXMuZm9yRWFjaChwcm9maWxlSXRlbSA9PiB7XG4gICAgICBjb25zdCBjb21wYXJpc2lvblJlc3VsdDogQ29tcGFyaXNvblJlc3VsdCA9IHtcbiAgICAgICAgcHJvZmlsZToge1xuICAgICAgICAgIGl0ZW1OYW1lOiBwcm9maWxlSXRlbS5uYW1lLFxuICAgICAgICAgIGl0ZW1EZXRhaWxzOiBwcm9maWxlSXRlbVtwcm9wZXJ0eU5hbWVXaXRoRGV0YWlsc10sXG4gICAgICAgICAgaXRlbVVybDogcHJvZmlsZUl0ZW0udXJsXG4gICAgICAgIH0sXG4gICAgICAgIGRldmljZTogY29tcGFyaXNvbk9ialtwcm9maWxlSXRlbVttZXJnZUJ5UHJvcGVydHldXVxuICAgICAgICAgID8gY29tcGFyaXNvbk9ialtwcm9maWxlSXRlbVttZXJnZUJ5UHJvcGVydHldXS5kZXZpY2VcbiAgICAgICAgICA6IHVuZGVmaW5lZFxuICAgICAgfTtcbiAgICAgIGNvbXBhcmlzaW9uUmVzdWx0LmNvbXBhcmlzb25BbGVydCA9IGdldEFsZXJ0KGNvbXBhcmlzaW9uUmVzdWx0KTtcbiAgICAgIGNvbXBhcmlzb25PYmpbcHJvZmlsZUl0ZW1bbWVyZ2VCeVByb3BlcnR5XV0gPSBjb21wYXJpc2lvblJlc3VsdDtcbiAgICB9KTtcbiAgICByZXR1cm4gY29tcGFyaXNvbk9iajtcbiAgfVxufVxuIl19