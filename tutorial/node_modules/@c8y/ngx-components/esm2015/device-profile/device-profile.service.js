import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { InventoryService, OperationService, OperationStatus, QueriesUtil } from '@c8y/client';
import { AlertService } from '@c8y/ngx-components';
import { sortBy, toArray, get } from 'lodash-es';
import { gettext } from '@c8y/ngx-components';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/client';
import * as ɵngcc2 from '@c8y/ngx-components';
export class DeviceProfileService {
    constructor(inventoryService, operationService, alertService) {
        this.inventoryService = inventoryService;
        this.operationService = operationService;
        this.alertService = alertService;
        this.dateFrom = new Date(0);
        this.dateTo = new Date(Date.now() + 86400000); // 1 day in the future
        this.NOT_INSTALLED_WARNING = gettext('Not installed on the device');
        this.VERSION_MISSMATCH_WARNING = gettext('Version mismatch');
        this.SAME_URL_WARNING = gettext('Installed configuration has the same URL but different name or type than the one in the profile');
        this.queriesUtil = new QueriesUtil();
    }
    createDeviceProfile(deviceProfile) {
        if (get(deviceProfile, 'c8y_Filter.type') === '') {
            delete deviceProfile.c8y_Filter.type;
        }
        return this.inventoryService.create(deviceProfile);
    }
    getDeviceProfilesByDeviceType(deviceType) {
        const deviceTypeFilter = {
            __or: [
                { 'c8y_Filter.type': deviceType },
                { 'c8y_Filter.type': '' },
                { __not: { __has: 'c8y_Filter.type' } }
            ]
        };
        return this.getDeviceProfiles(deviceTypeFilter);
    }
    getDeviceProfiles(andQuery) {
        let query = {
            type: 'c8y_Profile'
        };
        const filter = {
            pageSize: 100,
            withTotalPages: true
        };
        query = this.queriesUtil.addAndFilter(query, andQuery || {});
        return this.inventoryService.listQuery(query, filter);
    }
    getProfileOperation(deviceId) {
        return __awaiter(this, void 0, void 0, function* () {
            const filter = {
                deviceId,
                fragmentType: 'c8y_DeviceProfile',
                dateFrom: this.dateFrom.toISOString(),
                dateTo: this.dateTo.toISOString(),
                revert: true,
                pageSize: 1
            };
            const operation = (yield this.operationService.list(filter)).data[0];
            return operation && operation.status !== OperationStatus.SUCCESSFUL ? operation : undefined;
        });
    }
    createProfileOperation(device, deviceProfile) {
        return __awaiter(this, void 0, void 0, function* () {
            let operation;
            const operationCfg = {
                deviceId: device.id,
                profileId: deviceProfile.id,
                profileName: deviceProfile.name,
                c8y_DeviceProfile: deviceProfile.c8y_DeviceProfile,
                description: `Assign device profile ${deviceProfile.name} to device ${device.name}`
            };
            try {
                const { data } = yield this.operationService.create(operationCfg);
                operation = data;
            }
            catch (ex) {
                this.alertService.addServerFailure(ex);
            }
            return operation;
        });
    }
    getFirmwareItems(device, selectedProfile) {
        const deviceFirmware = device.c8y_Firmware;
        const profileFirmware = get(selectedProfile, 'c8y_DeviceProfile.firmware');
        const deviceItems = [];
        const profileItems = [];
        if (deviceFirmware) {
            deviceItems.push(deviceFirmware);
        }
        if (profileFirmware) {
            profileItems.push(profileFirmware);
        }
        return this.createProfileComparison(deviceItems, profileItems, 'name', 'version', this.getAlert('firmware'));
    }
    getSoftwareItems(device, selectedProfile) {
        const deviceSoftware = device.c8y_SoftwareList;
        const profileSoftware = get(selectedProfile, 'c8y_DeviceProfile.software');
        return this.createProfileComparison(deviceSoftware, profileSoftware, 'name', 'version', this.getAlert('software'));
    }
    getConfigurationItems(device, selectedProfile) {
        const deviceConfiguration = [];
        Object.keys(device).forEach(key => {
            if (key.slice(0, 18) === 'c8y_Configuration_') {
                deviceConfiguration.push(device[key]);
            }
        });
        const profileConfiguration = get(selectedProfile, 'c8y_DeviceProfile.configuration');
        return this.createProfileComparison(deviceConfiguration, profileConfiguration, 'url', 'type', this.getAlert('configuration'));
    }
    getAlert(itemType) {
        const notInstalled = (comparisionResult) => {
            return !comparisionResult.device ? this.NOT_INSTALLED_WARNING : '';
        };
        switch (itemType) {
            case 'firmware':
            case 'software':
                return (comparisionResult) => {
                    return comparisionResult.device &&
                        comparisionResult.profile &&
                        comparisionResult.device.itemDetails !== comparisionResult.profile.itemDetails
                        ? this.VERSION_MISSMATCH_WARNING
                        : notInstalled(comparisionResult);
                };
            case 'configuration':
                return (comparisionResult) => {
                    return comparisionResult.device &&
                        comparisionResult.profile &&
                        (comparisionResult.device.itemName !== comparisionResult.profile.itemName ||
                            comparisionResult.device.itemDetails !== comparisionResult.profile.itemDetails)
                        ? this.SAME_URL_WARNING
                        : notInstalled(comparisionResult);
                };
            default:
                return notInstalled;
        }
    }
    createProfileComparison(deviceItems = [], profileItems = [], mergeByProperty, propertyNameWithDetails, getAlert) {
        const comparisonObj = this.createProfileComparisonFromDeviceItems(deviceItems, mergeByProperty, propertyNameWithDetails);
        const extendedComparisonObj = this.extendProfileComparisonWithProfileItems(comparisonObj, profileItems, mergeByProperty, propertyNameWithDetails, getAlert);
        return sortBy(toArray(extendedComparisonObj), 'name');
    }
    createProfileComparisonFromDeviceItems(deviceItems, mergeByProperty, propertyNameWithDetails) {
        return deviceItems.reduce((comapritionItem, deviceItem) => Object.assign(comapritionItem, {
            [deviceItem[mergeByProperty]]: {
                device: {
                    itemName: deviceItem.name,
                    itemDetails: deviceItem[propertyNameWithDetails],
                    itemUrl: deviceItem.url
                },
                profile: undefined
            }
        }), {});
    }
    extendProfileComparisonWithProfileItems(comparisonObj, profileItems, mergeByProperty, propertyNameWithDetails, getAlert) {
        profileItems.forEach(profileItem => {
            const comparisionResult = {
                profile: {
                    itemName: profileItem.name,
                    itemDetails: profileItem[propertyNameWithDetails],
                    itemUrl: profileItem.url
                },
                device: comparisonObj[profileItem[mergeByProperty]]
                    ? comparisonObj[profileItem[mergeByProperty]].device
                    : undefined
            };
            comparisionResult.comparisonAlert = getAlert(comparisionResult);
            comparisonObj[profileItem[mergeByProperty]] = comparisionResult;
        });
        return comparisonObj;
    }
}
DeviceProfileService.ɵfac = function DeviceProfileService_Factory(t) { return new (t || DeviceProfileService)(ɵngcc0.ɵɵinject(ɵngcc1.InventoryService), ɵngcc0.ɵɵinject(ɵngcc1.OperationService), ɵngcc0.ɵɵinject(ɵngcc2.AlertService)); };
DeviceProfileService.ɵprov = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjectable({ token: DeviceProfileService, factory: DeviceProfileService.ɵfac });
DeviceProfileService.ctorParameters = () => [
    { type: InventoryService },
    { type: OperationService },
    { type: AlertService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(DeviceProfileService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.InventoryService }, { type: ɵngcc1.OperationService }, { type: ɵngcc2.AlertService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLXByb2ZpbGUuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vZGV2aWNlLXByb2ZpbGUvZGV2aWNlLXByb2ZpbGUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBRUwsZ0JBQWdCLEVBR2hCLGdCQUFnQixFQUNoQixlQUFlLEVBQ2YsV0FBVyxFQUNaLE1BQU0sYUFBYSxDQUFDO0FBT3JCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUNuRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDakQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDOzs7O0FBRzlDLE1BQU0sT0FBTyxvQkFBb0I7QUFDakMsSUFVRSxZQUNVLGdCQUFrQyxFQUNsQyxnQkFBa0MsRUFDbEMsWUFBMEI7QUFDbkMsUUFIUyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO0FBQUMsUUFDbkMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtBQUFDLFFBQ25DLGlCQUFZLEdBQVosWUFBWSxDQUFjO0FBQ3RDLFFBZFcsYUFBUSxHQUFHLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2xDLFFBQVcsV0FBTSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLHNCQUFzQjtBQUMzRSxRQUVVLDBCQUFxQixHQUFHLE9BQU8sQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO0FBQ3pFLFFBQVUsOEJBQXlCLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDbEUsUUFBVSxxQkFBZ0IsR0FBRyxPQUFPLENBQ2hDLGlHQUFpRyxDQUNsRyxDQUFDO0FBQ0osUUFNSSxJQUFJLENBQUMsV0FBVyxHQUFH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QVUsUUFBUSxFQUFFLFdBQVcsQ0FBQyxJQUFJO0FBQ3BDLG9CQUFVLFdBQVcsRUFBRSxXQUFXLENBQUMsdUJBQXVCLENBQUM7QUFDM0Qsb0JBQVUsT0FBTyxFQUFFLFdBQVcsQ0FBQyxHQUFHO0FBQ2xDLGlCQUFTO0FBQ1QsZ0JBQVEsTUFBTSxFQUFFLGFBQWEsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDM0Qsb0JBQVUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxNQUFNO0FBQzlELG9CQUFVLENBQUMsQ0FBQyxTQUFTO0FBQ3JCLGFBQU8sQ0FBQztBQUNSLFlBQU0saUJBQWlCLENBQUMsZUFBZSxHQUFHLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3RFLFlBQU0sYUFBYSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxHQUFHLGlCQUFpQixDQUFDO0FBQ3RFLFFBQUksQ0FBQyxDQUFDLENBQUM7QUFDUCxRQUFJLE9BQU8sYUFBYSxDQUFDO0FBQ3pCLElBQUUsQ0FBQztBQUNIO2dEQTVPQyxVQUFVOzBJQUNUO0FBQUM7QUFDVSxZQW5CWCxnQkFBZ0I7QUFDaEIsWUFFQSxnQkFBZ0I7QUFDaEIsWUFTTyxZQUFZO0FBQUc7OzttSkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgSU1hbmFnZWRPYmplY3QsXG4gIEludmVudG9yeVNlcnZpY2UsXG4gIElPcGVyYXRpb24sXG4gIElSZXN1bHRMaXN0LFxuICBPcGVyYXRpb25TZXJ2aWNlLFxuICBPcGVyYXRpb25TdGF0dXMsXG4gIFF1ZXJpZXNVdGlsXG59IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7XG4gIERldmljZVByb2ZpbGUsXG4gIERldmljZVByb2ZpbGVGaXJtd2FyZSxcbiAgRGV2aWNlUHJvZmlsZVNvZnR3YXJlLFxuICBDb21wYXJpc29uUmVzdWx0XG59IGZyb20gJy4vZGV2aWNlLXByb2ZpbGUubW9kZWwnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBzb3J0QnksIHRvQXJyYXksIGdldCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBEZXZpY2VQcm9maWxlU2VydmljZSB7XG4gIHJlYWRvbmx5IGRhdGVGcm9tID0gbmV3IERhdGUoMCk7XG4gIHJlYWRvbmx5IGRhdGVUbyA9IG5ldyBEYXRlKERhdGUubm93KCkgKyA4NjQwMDAwMCk7IC8vIDEgZGF5IGluIHRoZSBmdXR1cmVcbiAgcHJpdmF0ZSBxdWVyaWVzVXRpbDogUXVlcmllc1V0aWw7XG5cbiAgcHJpdmF0ZSBOT1RfSU5TVEFMTEVEX1dBUk5JTkcgPSBnZXR0ZXh0KCdOb3QgaW5zdGFsbGVkIG9uIHRoZSBkZXZpY2UnKTtcbiAgcHJpdmF0ZSBWRVJTSU9OX01JU1NNQVRDSF9XQVJOSU5HID0gZ2V0dGV4dCgnVmVyc2lvbiBtaXNtYXRjaCcpO1xuICBwcml2YXRlIFNBTUVfVVJMX1dBUk5JTkcgPSBnZXR0ZXh0KFxuICAgICdJbnN0YWxsZWQgY29uZmlndXJhdGlvbiBoYXMgdGhlIHNhbWUgVVJMIGJ1dCBkaWZmZXJlbnQgbmFtZSBvciB0eXBlIHRoYW4gdGhlIG9uZSBpbiB0aGUgcHJvZmlsZSdcbiAgKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBvcGVyYXRpb25TZXJ2aWNlOiBPcGVyYXRpb25TZXJ2aWNlLFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5xdWVyaWVzVXRpbCA9IG5ldyBRdWVyaWVzVXRpbCgpO1xuICB9XG5cbiAgY3JlYXRlRGV2aWNlUHJvZmlsZShkZXZpY2VQcm9maWxlOiBQYXJ0aWFsPERldmljZVByb2ZpbGU+KSB7XG4gICAgaWYgKGdldChkZXZpY2VQcm9maWxlLCAnYzh5X0ZpbHRlci50eXBlJykgPT09ICcnKSB7XG4gICAgICBkZWxldGUgZGV2aWNlUHJvZmlsZS5jOHlfRmlsdGVyLnR5cGU7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UuY3JlYXRlKGRldmljZVByb2ZpbGUgYXMgSU1hbmFnZWRPYmplY3QpO1xuICB9XG5cbiAgZ2V0RGV2aWNlUHJvZmlsZXNCeURldmljZVR5cGUoZGV2aWNlVHlwZTogc3RyaW5nKTogUHJvbWlzZTxJUmVzdWx0TGlzdDxJTWFuYWdlZE9iamVjdD4+IHtcbiAgICBjb25zdCBkZXZpY2VUeXBlRmlsdGVyID0ge1xuICAgICAgX19vcjogW1xuICAgICAgICB7ICdjOHlfRmlsdGVyLnR5cGUnOiBkZXZpY2VUeXBlIH0sXG4gICAgICAgIHsgJ2M4eV9GaWx0ZXIudHlwZSc6ICcnIH0sXG4gICAgICAgIHsgX19ub3Q6IHsgX19oYXM6ICdjOHlfRmlsdGVyLnR5cGUnIH0gfVxuICAgICAgXVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuZ2V0RGV2aWNlUHJvZmlsZXMoZGV2aWNlVHlwZUZpbHRlcik7XG4gIH1cblxuICBnZXREZXZpY2VQcm9maWxlcyhhbmRRdWVyeT86IGFueSk6IFByb21pc2U8SVJlc3VsdExpc3Q8SU1hbmFnZWRPYmplY3Q+PiB7XG4gICAgbGV0IHF1ZXJ5OiBvYmplY3QgPSB7XG4gICAgICB0eXBlOiAnYzh5X1Byb2ZpbGUnXG4gICAgfTtcbiAgICBjb25zdCBmaWx0ZXI6IG9iamVjdCA9IHtcbiAgICAgIHBhZ2VTaXplOiAxMDAsXG4gICAgICB3aXRoVG90YWxQYWdlczogdHJ1ZVxuICAgIH07XG4gICAgcXVlcnkgPSB0aGlzLnF1ZXJpZXNVdGlsLmFkZEFuZEZpbHRlcihxdWVyeSwgYW5kUXVlcnkgfHwge30pO1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UubGlzdFF1ZXJ5KHF1ZXJ5LCBmaWx0ZXIpO1xuICB9XG5cbiAgYXN5bmMgZ2V0UHJvZmlsZU9wZXJhdGlvbihkZXZpY2VJZDogc3RyaW5nIHwgbnVtYmVyKSB7XG4gICAgY29uc3QgZmlsdGVyOiBvYmplY3QgPSB7XG4gICAgICBkZXZpY2VJZCxcbiAgICAgIGZyYWdtZW50VHlwZTogJ2M4eV9EZXZpY2VQcm9maWxlJyxcbiAgICAgIGRhdGVGcm9tOiB0aGlzLmRhdGVGcm9tLnRvSVNPU3RyaW5nKCksXG4gICAgICBkYXRlVG86IHRoaXMuZGF0ZVRvLnRvSVNPU3RyaW5nKCksXG4gICAgICByZXZlcnQ6IHRydWUsXG4gICAgICBwYWdlU2l6ZTogMVxuICAgIH07XG5cbiAgICBjb25zdCBvcGVyYXRpb24gPSAoYXdhaXQgdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmxpc3QoZmlsdGVyKSkuZGF0YVswXTtcbiAgICByZXR1cm4gb3BlcmF0aW9uICYmIG9wZXJhdGlvbi5zdGF0dXMgIT09IE9wZXJhdGlvblN0YXR1cy5TVUNDRVNTRlVMID8gb3BlcmF0aW9uIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlUHJvZmlsZU9wZXJhdGlvbihkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LCBkZXZpY2VQcm9maWxlOiBQYXJ0aWFsPERldmljZVByb2ZpbGU+KSB7XG4gICAgbGV0IG9wZXJhdGlvbjtcbiAgICBjb25zdCBvcGVyYXRpb25DZmc6IElPcGVyYXRpb24gPSB7XG4gICAgICBkZXZpY2VJZDogZGV2aWNlLmlkLFxuICAgICAgcHJvZmlsZUlkOiBkZXZpY2VQcm9maWxlLmlkLFxuICAgICAgcHJvZmlsZU5hbWU6IGRldmljZVByb2ZpbGUubmFtZSxcbiAgICAgIGM4eV9EZXZpY2VQcm9maWxlOiBkZXZpY2VQcm9maWxlLmM4eV9EZXZpY2VQcm9maWxlLFxuICAgICAgZGVzY3JpcHRpb246IGBBc3NpZ24gZGV2aWNlIHByb2ZpbGUgJHtkZXZpY2VQcm9maWxlLm5hbWV9IHRvIGRldmljZSAke2RldmljZS5uYW1lfWBcbiAgICB9O1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMub3BlcmF0aW9uU2VydmljZS5jcmVhdGUob3BlcmF0aW9uQ2ZnKTtcbiAgICAgIG9wZXJhdGlvbiA9IGRhdGE7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoZXgpO1xuICAgIH1cbiAgICByZXR1cm4gb3BlcmF0aW9uO1xuICB9XG5cbiAgZ2V0RmlybXdhcmVJdGVtcyhcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LFxuICAgIHNlbGVjdGVkUHJvZmlsZTogUGFydGlhbDxEZXZpY2VQcm9maWxlPlxuICApOiBDb21wYXJpc29uUmVzdWx0W10ge1xuICAgIGNvbnN0IGRldmljZUZpcm13YXJlID0gZGV2aWNlLmM4eV9GaXJtd2FyZTtcbiAgICBjb25zdCBwcm9maWxlRmlybXdhcmUgPSBnZXQoc2VsZWN0ZWRQcm9maWxlLCAnYzh5X0RldmljZVByb2ZpbGUuZmlybXdhcmUnKTtcbiAgICBjb25zdCBkZXZpY2VJdGVtcyA9IFtdO1xuICAgIGNvbnN0IHByb2ZpbGVJdGVtcyA9IFtdO1xuXG4gICAgaWYgKGRldmljZUZpcm13YXJlKSB7XG4gICAgICBkZXZpY2VJdGVtcy5wdXNoKGRldmljZUZpcm13YXJlKTtcbiAgICB9XG4gICAgaWYgKHByb2ZpbGVGaXJtd2FyZSkge1xuICAgICAgcHJvZmlsZUl0ZW1zLnB1c2gocHJvZmlsZUZpcm13YXJlKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlUHJvZmlsZUNvbXBhcmlzb24oXG4gICAgICBkZXZpY2VJdGVtcyxcbiAgICAgIHByb2ZpbGVJdGVtcyxcbiAgICAgICduYW1lJyxcbiAgICAgICd2ZXJzaW9uJyxcbiAgICAgIHRoaXMuZ2V0QWxlcnQoJ2Zpcm13YXJlJylcbiAgICApO1xuICB9XG5cbiAgZ2V0U29mdHdhcmVJdGVtcyhcbiAgICBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LFxuICAgIHNlbGVjdGVkUHJvZmlsZTogUGFydGlhbDxEZXZpY2VQcm9maWxlPlxuICApOiBDb21wYXJpc29uUmVzdWx0W10ge1xuICAgIGNvbnN0IGRldmljZVNvZnR3YXJlID0gZGV2aWNlLmM4eV9Tb2Z0d2FyZUxpc3Q7XG4gICAgY29uc3QgcHJvZmlsZVNvZnR3YXJlID0gZ2V0KHNlbGVjdGVkUHJvZmlsZSwgJ2M4eV9EZXZpY2VQcm9maWxlLnNvZnR3YXJlJyk7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlUHJvZmlsZUNvbXBhcmlzb24oXG4gICAgICBkZXZpY2VTb2Z0d2FyZSxcbiAgICAgIHByb2ZpbGVTb2Z0d2FyZSxcbiAgICAgICduYW1lJyxcbiAgICAgICd2ZXJzaW9uJyxcbiAgICAgIHRoaXMuZ2V0QWxlcnQoJ3NvZnR3YXJlJylcbiAgICApO1xuICB9XG5cbiAgZ2V0Q29uZmlndXJhdGlvbkl0ZW1zKFxuICAgIGRldmljZTogSU1hbmFnZWRPYmplY3QsXG4gICAgc2VsZWN0ZWRQcm9maWxlOiBQYXJ0aWFsPERldmljZVByb2ZpbGU+XG4gICk6IENvbXBhcmlzb25SZXN1bHRbXSB7XG4gICAgY29uc3QgZGV2aWNlQ29uZmlndXJhdGlvbiA9IFtdO1xuICAgIE9iamVjdC5rZXlzKGRldmljZSkuZm9yRWFjaChrZXkgPT4ge1xuICAgICAgaWYgKGtleS5zbGljZSgwLCAxOCkgPT09ICdjOHlfQ29uZmlndXJhdGlvbl8nKSB7XG4gICAgICAgIGRldmljZUNvbmZpZ3VyYXRpb24ucHVzaChkZXZpY2Vba2V5XSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgY29uc3QgcHJvZmlsZUNvbmZpZ3VyYXRpb24gPSBnZXQoc2VsZWN0ZWRQcm9maWxlLCAnYzh5X0RldmljZVByb2ZpbGUuY29uZmlndXJhdGlvbicpO1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZVByb2ZpbGVDb21wYXJpc29uKFxuICAgICAgZGV2aWNlQ29uZmlndXJhdGlvbixcbiAgICAgIHByb2ZpbGVDb25maWd1cmF0aW9uLFxuICAgICAgJ3VybCcsXG4gICAgICAndHlwZScsXG4gICAgICB0aGlzLmdldEFsZXJ0KCdjb25maWd1cmF0aW9uJylcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRBbGVydChpdGVtVHlwZTogc3RyaW5nKTogKGNvbXBhcmlzaW9uUmVzdWx0OiBDb21wYXJpc29uUmVzdWx0KSA9PiBzdHJpbmcge1xuICAgIGNvbnN0IG5vdEluc3RhbGxlZCA9IChjb21wYXJpc2lvblJlc3VsdDogQ29tcGFyaXNvblJlc3VsdCkgPT4ge1xuICAgICAgcmV0dXJuICFjb21wYXJpc2lvblJlc3VsdC5kZXZpY2UgPyB0aGlzLk5PVF9JTlNUQUxMRURfV0FSTklORyA6ICcnO1xuICAgIH07XG5cbiAgICBzd2l0Y2ggKGl0ZW1UeXBlKSB7XG4gICAgICBjYXNlICdmaXJtd2FyZSc6XG4gICAgICBjYXNlICdzb2Z0d2FyZSc6XG4gICAgICAgIHJldHVybiAoY29tcGFyaXNpb25SZXN1bHQ6IENvbXBhcmlzb25SZXN1bHQpID0+IHtcbiAgICAgICAgICByZXR1cm4gY29tcGFyaXNpb25SZXN1bHQuZGV2aWNlICYmXG4gICAgICAgICAgICBjb21wYXJpc2lvblJlc3VsdC5wcm9maWxlICYmXG4gICAgICAgICAgICBjb21wYXJpc2lvblJlc3VsdC5kZXZpY2UuaXRlbURldGFpbHMgIT09IGNvbXBhcmlzaW9uUmVzdWx0LnByb2ZpbGUuaXRlbURldGFpbHNcbiAgICAgICAgICAgID8gdGhpcy5WRVJTSU9OX01JU1NNQVRDSF9XQVJOSU5HXG4gICAgICAgICAgICA6IG5vdEluc3RhbGxlZChjb21wYXJpc2lvblJlc3VsdCk7XG4gICAgICAgIH07XG4gICAgICBjYXNlICdjb25maWd1cmF0aW9uJzpcbiAgICAgICAgcmV0dXJuIChjb21wYXJpc2lvblJlc3VsdDogQ29tcGFyaXNvblJlc3VsdCkgPT4ge1xuICAgICAgICAgIHJldHVybiBjb21wYXJpc2lvblJlc3VsdC5kZXZpY2UgJiZcbiAgICAgICAgICAgIGNvbXBhcmlzaW9uUmVzdWx0LnByb2ZpbGUgJiZcbiAgICAgICAgICAgIChjb21wYXJpc2lvblJlc3VsdC5kZXZpY2UuaXRlbU5hbWUgIT09IGNvbXBhcmlzaW9uUmVzdWx0LnByb2ZpbGUuaXRlbU5hbWUgfHxcbiAgICAgICAgICAgICAgY29tcGFyaXNpb25SZXN1bHQuZGV2aWNlLml0ZW1EZXRhaWxzICE9PSBjb21wYXJpc2lvblJlc3VsdC5wcm9maWxlLml0ZW1EZXRhaWxzKVxuICAgICAgICAgICAgPyB0aGlzLlNBTUVfVVJMX1dBUk5JTkdcbiAgICAgICAgICAgIDogbm90SW5zdGFsbGVkKGNvbXBhcmlzaW9uUmVzdWx0KTtcbiAgICAgICAgfTtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBub3RJbnN0YWxsZWQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVQcm9maWxlQ29tcGFyaXNvbihcbiAgICBkZXZpY2VJdGVtczogYW55W10gPSBbXSxcbiAgICBwcm9maWxlSXRlbXM6IEFycmF5PERldmljZVByb2ZpbGVTb2Z0d2FyZSB8IERldmljZVByb2ZpbGVGaXJtd2FyZT4gPSBbXSxcbiAgICBtZXJnZUJ5UHJvcGVydHk6IHN0cmluZyxcbiAgICBwcm9wZXJ0eU5hbWVXaXRoRGV0YWlsczogc3RyaW5nLFxuICAgIGdldEFsZXJ0OiAoY29tcGFyaXNpb25SZXN1bHQ6IENvbXBhcmlzb25SZXN1bHQpID0+IHN0cmluZ1xuICApOiBDb21wYXJpc29uUmVzdWx0W10ge1xuICAgIGNvbnN0IGNvbXBhcmlzb25PYmogPSB0aGlzLmNyZWF0ZVByb2ZpbGVDb21wYXJpc29uRnJvbURldmljZUl0ZW1zKFxuICAgICAgZGV2aWNlSXRlbXMsXG4gICAgICBtZXJnZUJ5UHJvcGVydHksXG4gICAgICBwcm9wZXJ0eU5hbWVXaXRoRGV0YWlsc1xuICAgICk7XG4gICAgY29uc3QgZXh0ZW5kZWRDb21wYXJpc29uT2JqID0gdGhpcy5leHRlbmRQcm9maWxlQ29tcGFyaXNvbldpdGhQcm9maWxlSXRlbXMoXG4gICAgICBjb21wYXJpc29uT2JqLFxuICAgICAgcHJvZmlsZUl0ZW1zLFxuICAgICAgbWVyZ2VCeVByb3BlcnR5LFxuICAgICAgcHJvcGVydHlOYW1lV2l0aERldGFpbHMsXG4gICAgICBnZXRBbGVydFxuICAgICk7XG4gICAgcmV0dXJuIHNvcnRCeSh0b0FycmF5KGV4dGVuZGVkQ29tcGFyaXNvbk9iaiksICduYW1lJyk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVByb2ZpbGVDb21wYXJpc29uRnJvbURldmljZUl0ZW1zKFxuICAgIGRldmljZUl0ZW1zOiBhbnlbXSxcbiAgICBtZXJnZUJ5UHJvcGVydHk6IHN0cmluZyxcbiAgICBwcm9wZXJ0eU5hbWVXaXRoRGV0YWlsczogc3RyaW5nXG4gICk6IGFueSB7XG4gICAgcmV0dXJuIGRldmljZUl0ZW1zLnJlZHVjZShcbiAgICAgIChjb21hcHJpdGlvbkl0ZW0sIGRldmljZUl0ZW0pID0+XG4gICAgICAgIE9iamVjdC5hc3NpZ24oY29tYXByaXRpb25JdGVtLCB7XG4gICAgICAgICAgW2RldmljZUl0ZW1bbWVyZ2VCeVByb3BlcnR5XV06IHtcbiAgICAgICAgICAgIGRldmljZToge1xuICAgICAgICAgICAgICBpdGVtTmFtZTogZGV2aWNlSXRlbS5uYW1lLFxuICAgICAgICAgICAgICBpdGVtRGV0YWlsczogZGV2aWNlSXRlbVtwcm9wZXJ0eU5hbWVXaXRoRGV0YWlsc10sXG4gICAgICAgICAgICAgIGl0ZW1Vcmw6IGRldmljZUl0ZW0udXJsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcHJvZmlsZTogdW5kZWZpbmVkXG4gICAgICAgICAgfVxuICAgICAgICB9KSxcbiAgICAgIHt9XG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZXh0ZW5kUHJvZmlsZUNvbXBhcmlzb25XaXRoUHJvZmlsZUl0ZW1zKFxuICAgIGNvbXBhcmlzb25PYmo6IG9iamVjdCxcbiAgICBwcm9maWxlSXRlbXM6IEFycmF5PERldmljZVByb2ZpbGVTb2Z0d2FyZSB8IERldmljZVByb2ZpbGVGaXJtd2FyZT4sXG4gICAgbWVyZ2VCeVByb3BlcnR5OiBzdHJpbmcsXG4gICAgcHJvcGVydHlOYW1lV2l0aERldGFpbHM6IHN0cmluZyxcbiAgICBnZXRBbGVydDogKGNvbXBhcmlzaW9uUmVzdWx0OiBDb21wYXJpc29uUmVzdWx0KSA9PiBzdHJpbmdcbiAgKSB7XG4gICAgcHJvZmlsZUl0ZW1zLmZvckVhY2gocHJvZmlsZUl0ZW0gPT4ge1xuICAgICAgY29uc3QgY29tcGFyaXNpb25SZXN1bHQ6IENvbXBhcmlzb25SZXN1bHQgPSB7XG4gICAgICAgIHByb2ZpbGU6IHtcbiAgICAgICAgICBpdGVtTmFtZTogcHJvZmlsZUl0ZW0ubmFtZSxcbiAgICAgICAgICBpdGVtRGV0YWlsczogcHJvZmlsZUl0ZW1bcHJvcGVydHlOYW1lV2l0aERldGFpbHNdLFxuICAgICAgICAgIGl0ZW1Vcmw6IHByb2ZpbGVJdGVtLnVybFxuICAgICAgICB9LFxuICAgICAgICBkZXZpY2U6IGNvbXBhcmlzb25PYmpbcHJvZmlsZUl0ZW1bbWVyZ2VCeVByb3BlcnR5XV1cbiAgICAgICAgICA/IGNvbXBhcmlzb25PYmpbcHJvZmlsZUl0ZW1bbWVyZ2VCeVByb3BlcnR5XV0uZGV2aWNlXG4gICAgICAgICAgOiB1bmRlZmluZWRcbiAgICAgIH07XG4gICAgICBjb21wYXJpc2lvblJlc3VsdC5jb21wYXJpc29uQWxlcnQgPSBnZXRBbGVydChjb21wYXJpc2lvblJlc3VsdCk7XG4gICAgICBjb21wYXJpc29uT2JqW3Byb2ZpbGVJdGVtW21lcmdlQnlQcm9wZXJ0eV1dID0gY29tcGFyaXNpb25SZXN1bHQ7XG4gICAgfSk7XG4gICAgcmV0dXJuIGNvbXBhcmlzb25PYmo7XG4gIH1cbn1cbiJdfQ==