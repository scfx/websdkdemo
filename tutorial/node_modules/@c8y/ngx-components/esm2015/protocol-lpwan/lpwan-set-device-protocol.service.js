import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { InventoryService, FetchClient, IdentityService } from '@c8y/client';
import { get } from 'lodash-es';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/client';
export class LpwanSetDeviceProtocolService {
    constructor(inventoryService, client, identityService) {
        this.inventoryService = inventoryService;
        this.client = client;
        this.identityService = identityService;
        this.supportedDevicesCfgs = [
            {
                name: 'lora',
                match: device => get(device, 'c8y_LpwanDevice.lpwanDeviceType') === 'Lora',
                protocolTypes: ['c8y_ActilityDeviceType', 'c8y_LoraDeviceType', 'c8y_LpwanDeviceType'],
                externalIdTypes: ['c8y_LoriotEUI', 'c8y_Serial']
            },
            {
                name: 'sigfox',
                match: device => get(device, 'c8y_LpwanDevice.serviceProvider') === 'Sigfox',
                protocolTypes: ['c8y_SigfoxDeviceType', 'c8y_LpwanDeviceType'],
                externalIdTypes: ['com.sigfox.deviceId']
            }
        ];
        this.header = { 'Content-Type': 'application/json' };
    }
    refreshCache(device) {
        return __awaiter(this, void 0, void 0, function* () {
            const externalId = yield this.getExternalId(device);
            if (externalId) {
                const url = `${this.getMicroserviceUrl(device)}/refreshCache/${externalId}`;
                const options = {
                    method: 'POST',
                    headers: this.header,
                    body: JSON.stringify({})
                };
                return this.client.fetch(url, options);
            }
        });
    }
    getMicroserviceUrl(device) {
        const { serviceProvider } = device.c8y_LpwanDevice;
        let serviceName = serviceProvider.toLowerCase();
        if (serviceProvider === 'Sigfox') {
            serviceName = 'sigfox-agent';
        }
        return `/service/${serviceName}`;
    }
    isSupportedDevice(device) {
        return this.supportedDevicesCfgs.some(({ match }) => match(device));
    }
    getCurrentProtocol(device) {
        return __awaiter(this, void 0, void 0, function* () {
            const lpwanDevice = device.c8y_LpwanDevice;
            let protocolId;
            if (lpwanDevice.typeExternalId) {
                const externalId = (yield this.identityService.detail(lpwanDevice.typeExternalId)).data;
                protocolId = externalId.managedObject.id;
            }
            if (!protocolId && lpwanDevice.type) {
                protocolId = lpwanDevice.type.split('/')[2];
            }
            if (!protocolId) {
                return null;
            }
            return (yield this.inventoryService.detail(protocolId)).data;
        });
    }
    applyProtocol(device, selectedProtocol) {
        return __awaiter(this, void 0, void 0, function* () {
            const [protocolExternalId] = (yield this.identityService.list(selectedProtocol.id)).data;
            const { externalId, type } = protocolExternalId;
            device.c8y_LpwanDevice.typeExternalId = { externalId, type };
            device.c8y_LpwanDevice.type = 'inventory/managedObjects/' + selectedProtocol.id;
            device.type = selectedProtocol.name;
            return this.inventoryService.update(device);
        });
    }
    getAvailableProtocols(device) {
        return __awaiter(this, void 0, void 0, function* () {
            const query = {
                __filter: {
                    type: { __in: this.getProtocolTypesMatchingDevice(device) }
                },
                __orderby: [{ name: 1 }]
            };
            return this.inventoryService.listQuery(query, { withTotalPages: true, pageSize: 5 });
        });
    }
    getProtocolTypesMatchingDevice(device) {
        const matchingCfg = this.supportedDevicesCfgs.find(({ match }) => match(device));
        return matchingCfg ? matchingCfg.protocolTypes : [];
    }
    getExternalId(device) {
        return __awaiter(this, void 0, void 0, function* () {
            const matchingCfg = this.supportedDevicesCfgs.find(({ match }) => match(device));
            const externalIds = (yield this.identityService.list(device.id)).data;
            const externalId = externalIds.find(({ type }) => matchingCfg.externalIdTypes.includes(type));
            return externalId ? externalId.externalId : null;
        });
    }
}
LpwanSetDeviceProtocolService.ɵfac = function LpwanSetDeviceProtocolService_Factory(t) { return new (t || LpwanSetDeviceProtocolService)(ɵngcc0.ɵɵinject(ɵngcc1.InventoryService), ɵngcc0.ɵɵinject(ɵngcc1.FetchClient), ɵngcc0.ɵɵinject(ɵngcc1.IdentityService)); };
LpwanSetDeviceProtocolService.ɵprov = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjectable({ token: LpwanSetDeviceProtocolService, factory: LpwanSetDeviceProtocolService.ɵfac });
LpwanSetDeviceProtocolService.ctorParameters = () => [
    { type: InventoryService },
    { type: FetchClient },
    { type: IdentityService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(LpwanSetDeviceProtocolService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.InventoryService }, { type: ɵngcc1.FetchClient }, { type: ɵngcc1.IdentityService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHB3YW4tc2V0LWRldmljZS1wcm90b2NvbC5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi9wcm90b2NvbC1scHdhbi9scHdhbi1zZXQtZGV2aWNlLXByb3RvY29sLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUVMLGdCQUFnQixFQUVoQixXQUFXLEVBRVgsZUFBZSxFQUNoQixNQUFNLGFBQWEsQ0FBQztBQUNyQixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDOzs7QUFHaEMsTUFBTSxPQUFPLDZCQUE2QjtBQUMxQyxJQWlCRSxZQUNVLGdCQUFrQyxFQUNsQyxNQUFtQixFQUNuQixlQUFnQztBQUN6QyxRQUhTLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7QUFBQyxRQUNuQyxXQUFNLEdBQU4sTUFBTSxDQUFhO0FBQUMsUUFDcEIsb0JBQWUsR0FBZixlQUFlLENBQWlCO0FBQzVDLFFBckJFLHlCQUFvQixHQUFHO0FBQ3pCLFlBQUk7QUFDSixnQkFBTSxJQUFJLEVBQUUsTUFBTTtBQUNsQixnQkFBTSxLQUFLLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLGlDQUFpQyxDQUFDLEtBQUssTUFBTTtBQUNoRixnQkFBTSxhQUFhLEVBQUUsQ0FBQyx3QkFBd0IsRUFBRSxvQkFBb0IsRUFBRSxxQkFBcUIsQ0FBQztBQUM1RixnQkFBTSxlQUFlLEVBQUUsQ0FBQyxlQUFlLEVBQUUsWUFBWSxDQUFDO0FBQ3RELGFBQUs7QUFDTCxZQUFJO0FBQ0osZ0JBQU0sSUFBSSxFQUFFLFFBQVE7QUFDcEIsZ0JBQU0sS0FBSyxFQUFFLE1BQU0sQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxpQ0FBaUMsQ0FBQyxLQUFLLFFBQVE7QUFDbEYsZ0JBQU0sYUFBYSxFQUFFLENBQUMsc0JBQXNCLEVB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QUFNLENBQUMsQ0FBQyxDQUFDO0FBQ3JGLFFBQUksT0FBTyxXQUFXLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztBQUN4RCxJQUFFLENBQUM7QUFDSCxJQUNnQixhQUFhLENBQUMsTUFBc0I7QUFBSTtBQUNYLFlBQXpDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztBQUNyRixZQUFJLE1BQU0sV0FBVyxHQUFHLENBQUMsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDMUUsWUFBSSxNQUFNLFVBQVUsR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztBQUNsRyxZQUFJLE9BQU8sVUFBVSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDckQsUUFBRSxDQUFDO0FBRUgsS0FGRztBQUNIO3lEQXZHQyxVQUFVO3FLQUNUO0FBQUM7QUFDVSxZQVZYLGdCQUFnQjtBQUNoQixZQUNBLFdBQVc7QUFDWCxZQUNBLGVBQWU7QUFDZjs7O2lKQUFFO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBJTWFuYWdlZE9iamVjdCxcbiAgSW52ZW50b3J5U2VydmljZSxcbiAgSVJlc3VsdExpc3QsXG4gIEZldGNoQ2xpZW50LFxuICBJRmV0Y2hPcHRpb25zLFxuICBJZGVudGl0eVNlcnZpY2Vcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgZ2V0IH0gZnJvbSAnbG9kYXNoLWVzJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIExwd2FuU2V0RGV2aWNlUHJvdG9jb2xTZXJ2aWNlIHtcbiAgc3VwcG9ydGVkRGV2aWNlc0NmZ3MgPSBbXG4gICAge1xuICAgICAgbmFtZTogJ2xvcmEnLFxuICAgICAgbWF0Y2g6IGRldmljZSA9PiBnZXQoZGV2aWNlLCAnYzh5X0xwd2FuRGV2aWNlLmxwd2FuRGV2aWNlVHlwZScpID09PSAnTG9yYScsXG4gICAgICBwcm90b2NvbFR5cGVzOiBbJ2M4eV9BY3RpbGl0eURldmljZVR5cGUnLCAnYzh5X0xvcmFEZXZpY2VUeXBlJywgJ2M4eV9McHdhbkRldmljZVR5cGUnXSxcbiAgICAgIGV4dGVybmFsSWRUeXBlczogWydjOHlfTG9yaW90RVVJJywgJ2M4eV9TZXJpYWwnXVxuICAgIH0sXG4gICAge1xuICAgICAgbmFtZTogJ3NpZ2ZveCcsXG4gICAgICBtYXRjaDogZGV2aWNlID0+IGdldChkZXZpY2UsICdjOHlfTHB3YW5EZXZpY2Uuc2VydmljZVByb3ZpZGVyJykgPT09ICdTaWdmb3gnLFxuICAgICAgcHJvdG9jb2xUeXBlczogWydjOHlfU2lnZm94RGV2aWNlVHlwZScsICdjOHlfTHB3YW5EZXZpY2VUeXBlJ10sXG4gICAgICBleHRlcm5hbElkVHlwZXM6IFsnY29tLnNpZ2ZveC5kZXZpY2VJZCddXG4gICAgfVxuICBdO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgaGVhZGVyOiBhbnkgPSB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBjbGllbnQ6IEZldGNoQ2xpZW50LFxuICAgIHByaXZhdGUgaWRlbnRpdHlTZXJ2aWNlOiBJZGVudGl0eVNlcnZpY2VcbiAgKSB7fVxuXG4gIGFzeW5jIHJlZnJlc2hDYWNoZShkZXZpY2UpIHtcbiAgICBjb25zdCBleHRlcm5hbElkID0gYXdhaXQgdGhpcy5nZXRFeHRlcm5hbElkKGRldmljZSk7XG4gICAgaWYgKGV4dGVybmFsSWQpIHtcbiAgICAgIGNvbnN0IHVybCA9IGAke3RoaXMuZ2V0TWljcm9zZXJ2aWNlVXJsKGRldmljZSl9L3JlZnJlc2hDYWNoZS8ke2V4dGVybmFsSWR9YDtcbiAgICAgIGNvbnN0IG9wdGlvbnM6IElGZXRjaE9wdGlvbnMgPSB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBoZWFkZXJzOiB0aGlzLmhlYWRlcixcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe30pXG4gICAgICB9O1xuICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmZldGNoKHVybCwgb3B0aW9ucyk7XG4gICAgfVxuICB9XG5cbiAgZ2V0TWljcm9zZXJ2aWNlVXJsKGRldmljZSkge1xuICAgIGNvbnN0IHsgc2VydmljZVByb3ZpZGVyIH0gPSBkZXZpY2UuYzh5X0xwd2FuRGV2aWNlO1xuXG4gICAgbGV0IHNlcnZpY2VOYW1lID0gc2VydmljZVByb3ZpZGVyLnRvTG93ZXJDYXNlKCk7XG4gICAgaWYgKHNlcnZpY2VQcm92aWRlciA9PT0gJ1NpZ2ZveCcpIHtcbiAgICAgIHNlcnZpY2VOYW1lID0gJ3NpZ2ZveC1hZ2VudCc7XG4gICAgfVxuXG4gICAgcmV0dXJuIGAvc2VydmljZS8ke3NlcnZpY2VOYW1lfWA7XG4gIH1cblxuICBpc1N1cHBvcnRlZERldmljZShkZXZpY2U6IElNYW5hZ2VkT2JqZWN0KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuc3VwcG9ydGVkRGV2aWNlc0NmZ3Muc29tZSgoeyBtYXRjaCB9KSA9PiBtYXRjaChkZXZpY2UpKTtcbiAgfVxuXG4gIGFzeW5jIGdldEN1cnJlbnRQcm90b2NvbChkZXZpY2U6IElNYW5hZ2VkT2JqZWN0KSB7XG4gICAgY29uc3QgbHB3YW5EZXZpY2UgPSBkZXZpY2UuYzh5X0xwd2FuRGV2aWNlO1xuICAgIGxldCBwcm90b2NvbElkO1xuXG4gICAgaWYgKGxwd2FuRGV2aWNlLnR5cGVFeHRlcm5hbElkKSB7XG4gICAgICBjb25zdCBleHRlcm5hbElkID0gKGF3YWl0IHRoaXMuaWRlbnRpdHlTZXJ2aWNlLmRldGFpbChscHdhbkRldmljZS50eXBlRXh0ZXJuYWxJZCkpLmRhdGE7XG4gICAgICBwcm90b2NvbElkID0gZXh0ZXJuYWxJZC5tYW5hZ2VkT2JqZWN0LmlkO1xuICAgIH1cblxuICAgIGlmICghcHJvdG9jb2xJZCAmJiBscHdhbkRldmljZS50eXBlKSB7XG4gICAgICBwcm90b2NvbElkID0gbHB3YW5EZXZpY2UudHlwZS5zcGxpdCgnLycpWzJdO1xuICAgIH1cblxuICAgIGlmICghcHJvdG9jb2xJZCkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLmludmVudG9yeVNlcnZpY2UuZGV0YWlsKHByb3RvY29sSWQpKS5kYXRhO1xuICB9XG5cbiAgYXN5bmMgYXBwbHlQcm90b2NvbChkZXZpY2U6IElNYW5hZ2VkT2JqZWN0LCBzZWxlY3RlZFByb3RvY29sOiBJTWFuYWdlZE9iamVjdCkge1xuICAgIGNvbnN0IFtwcm90b2NvbEV4dGVybmFsSWRdID0gKGF3YWl0IHRoaXMuaWRlbnRpdHlTZXJ2aWNlLmxpc3Qoc2VsZWN0ZWRQcm90b2NvbC5pZCkpLmRhdGE7XG4gICAgY29uc3QgeyBleHRlcm5hbElkLCB0eXBlIH0gPSBwcm90b2NvbEV4dGVybmFsSWQ7XG4gICAgZGV2aWNlLmM4eV9McHdhbkRldmljZS50eXBlRXh0ZXJuYWxJZCA9IHsgZXh0ZXJuYWxJZCwgdHlwZSB9O1xuICAgIGRldmljZS5jOHlfTHB3YW5EZXZpY2UudHlwZSA9ICdpbnZlbnRvcnkvbWFuYWdlZE9iamVjdHMvJyArIHNlbGVjdGVkUHJvdG9jb2wuaWQ7XG4gICAgZGV2aWNlLnR5cGUgPSBzZWxlY3RlZFByb3RvY29sLm5hbWU7XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5U2VydmljZS51cGRhdGUoZGV2aWNlKTtcbiAgfVxuXG4gIGFzeW5jIGdldEF2YWlsYWJsZVByb3RvY29scyhkZXZpY2U6IElNYW5hZ2VkT2JqZWN0KTogUHJvbWlzZTxJUmVzdWx0TGlzdDxJTWFuYWdlZE9iamVjdD4+IHtcbiAgICBjb25zdCBxdWVyeSA9IHtcbiAgICAgIF9fZmlsdGVyOiB7XG4gICAgICAgIHR5cGU6IHsgX19pbjogdGhpcy5nZXRQcm90b2NvbFR5cGVzTWF0Y2hpbmdEZXZpY2UoZGV2aWNlKSB9XG4gICAgICB9LFxuICAgICAgX19vcmRlcmJ5OiBbeyBuYW1lOiAxIH1dXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmxpc3RRdWVyeShxdWVyeSwgeyB3aXRoVG90YWxQYWdlczogdHJ1ZSwgcGFnZVNpemU6IDUgfSk7XG4gIH1cblxuICBwcml2YXRlIGdldFByb3RvY29sVHlwZXNNYXRjaGluZ0RldmljZShkZXZpY2U6IElNYW5hZ2VkT2JqZWN0KTogc3RyaW5nW10ge1xuICAgIGNvbnN0IG1hdGNoaW5nQ2ZnID0gdGhpcy5zdXBwb3J0ZWREZXZpY2VzQ2Zncy5maW5kKCh7IG1hdGNoIH0pID0+IG1hdGNoKGRldmljZSkpO1xuICAgIHJldHVybiBtYXRjaGluZ0NmZyA/IG1hdGNoaW5nQ2ZnLnByb3RvY29sVHlwZXMgOiBbXTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0RXh0ZXJuYWxJZChkZXZpY2U6IElNYW5hZ2VkT2JqZWN0KTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBtYXRjaGluZ0NmZyA9IHRoaXMuc3VwcG9ydGVkRGV2aWNlc0NmZ3MuZmluZCgoeyBtYXRjaCB9KSA9PiBtYXRjaChkZXZpY2UpKTtcbiAgICBjb25zdCBleHRlcm5hbElkcyA9IChhd2FpdCB0aGlzLmlkZW50aXR5U2VydmljZS5saXN0KGRldmljZS5pZCkpLmRhdGE7XG4gICAgY29uc3QgZXh0ZXJuYWxJZCA9IGV4dGVybmFsSWRzLmZpbmQoKHsgdHlwZSB9KSA9PiBtYXRjaGluZ0NmZy5leHRlcm5hbElkVHlwZXMuaW5jbHVkZXModHlwZSkpO1xuICAgIHJldHVybiBleHRlcm5hbElkID8gZXh0ZXJuYWxJZC5leHRlcm5hbElkIDogbnVsbDtcbiAgfVxufVxuIl19