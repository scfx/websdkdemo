import { __awaiter } from "tslib";
import { Injectable, Inject, Optional } from '@angular/core';
import { sortBy, cloneDeep, get } from 'lodash-es';
import { DynamicComponentService } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
import { CONTEXT_DASHBOARD_CONFIG } from './context-dashboard.model';
import * as i0 from "@angular/core";
import * as i1 from "@c8y/ngx-components";
import * as i2 from "@ngx-translate/core";
import * as i3 from "./context-dashboard.model";
export class WidgetService {
    constructor(dynamicComponentService, translateService, moduleConfig) {
        this.dynamicComponentService = dynamicComponentService;
        this.translateService = translateService;
        this.moduleConfig = moduleConfig;
        this.dynamicComponentService.items$.subscribe(widgets => {
            this.widgets = widgets;
        });
    }
    getWidgetDefinition(componentId) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.dynamicComponentService.getById(componentId);
        });
    }
    getWidgetDefinitions() {
        const translatedComponents = this.widgets.map(cmp => (Object.assign(Object.assign({}, cmp), { label: this.translateService.instant(cmp.label) })));
        return cloneDeep(sortBy(translatedComponents, 'label').filter(this.moduleConfig.widgetFilter));
    }
    mapLegacy(widget) {
        return __awaiter(this, void 0, void 0, function* () {
            const cmp = yield this.getWidgetDefinition(widget.componentId || widget.name);
            if (get(cmp, 'data.settings.upgrade')) {
                widget.widgetComponent = cmp.data.settings.widgetComponent;
                widget.configComponent = cmp.data.settings.configComponent;
                widget.templateUrl = cmp.data.settings.templateUrl;
                widget.configTemplateUrl = cmp.data.settings.configTemplateUrl;
                widget.transformConfigWithContext =
                    cmp.data.settings.componentTransformConfigWithContext ||
                        cmp.data.settings.transformConfigWithContext ||
                        widget.transformConfigWithContext;
            }
            else {
                delete widget.templateUrl;
                delete widget.configTemplateUrl;
            }
            return widget;
        });
    }
}
WidgetService.ɵprov = i0.ɵɵdefineInjectable({ factory: function WidgetService_Factory() { return new WidgetService(i0.ɵɵinject(i1.DynamicComponentService), i0.ɵɵinject(i2.TranslateService), i0.ɵɵinject(i3.CONTEXT_DASHBOARD_CONFIG, 8)); }, token: WidgetService, providedIn: "root" });
WidgetService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
WidgetService.ctorParameters = () => [
    { type: DynamicComponentService },
    { type: TranslateService },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [CONTEXT_DASHBOARD_CONFIG,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2lkZ2V0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9jb250ZXh0LWRhc2hib2FyZC93aWRnZXQuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNuRCxPQUFPLEVBQUUsdUJBQXVCLEVBQXNDLE1BQU0scUJBQXFCLENBQUM7QUFDbEcsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUEwQix3QkFBd0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDOzs7OztBQUs3RixNQUFNLE9BQU8sYUFBYTtJQUd4QixZQUNVLHVCQUFnRCxFQUNoRCxnQkFBa0MsRUFHbkMsWUFBb0M7UUFKbkMsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtRQUNoRCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBR25DLGlCQUFZLEdBQVosWUFBWSxDQUF3QjtRQUUzQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUN0RCxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFSyxtQkFBbUIsQ0FBQyxXQUFXOztZQUNuQyxPQUFPLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDM0QsQ0FBQztLQUFBO0lBRUQsb0JBQW9CO1FBQ2xCLE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxpQ0FDaEQsR0FBRyxLQUNOLEtBQUssRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFDL0MsQ0FBQyxDQUFDO1FBRUosT0FBTyxTQUFTLENBQUMsTUFBTSxDQUFDLG9CQUFvQixFQUFFLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7SUFDakcsQ0FBQztJQUVLLFNBQVMsQ0FBQyxNQUF1Qjs7WUFDckMsTUFBTSxHQUFHLEdBQUcsTUFBTSxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxDQUFDLFdBQVcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDOUUsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLHVCQUF1QixDQUFDLEVBQUU7Z0JBQ3JDLE1BQU0sQ0FBQyxlQUFlLEdBQUcsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDO2dCQUMzRCxNQUFNLENBQUMsZUFBZSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQztnQkFDM0QsTUFBTSxDQUFDLFdBQVcsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUM7Z0JBQ25ELE1BQU0sQ0FBQyxpQkFBaUIsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxpQkFBaUIsQ0FBQztnQkFDL0QsTUFBTSxDQUFDLDBCQUEwQjtvQkFDL0IsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsbUNBQW1DO3dCQUNyRCxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQywwQkFBMEI7d0JBQzVDLE1BQU0sQ0FBQywwQkFBMEIsQ0FBQzthQUNyQztpQkFBTTtnQkFDTCxPQUFPLE1BQU0sQ0FBQyxXQUFXLENBQUM7Z0JBQzFCLE9BQU8sTUFBTSxDQUFDLGlCQUFpQixDQUFDO2FBQ2pDO1lBQ0QsT0FBTyxNQUFnQixDQUFDO1FBQzFCLENBQUM7S0FBQTs7OztZQS9DRixVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7OztZQU5RLHVCQUF1QjtZQUN2QixnQkFBZ0I7NENBWXBCLFFBQVEsWUFDUixNQUFNLFNBQUMsd0JBQXdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0LCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgc29ydEJ5LCBjbG9uZURlZXAsIGdldCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBEeW5hbWljQ29tcG9uZW50U2VydmljZSwgRHluYW1pY0NvbXBvbmVudERlZmluaXRpb24sIFdpZGdldCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHsgQ29udGV4dERhc2hib2FyZENvbmZpZywgQ09OVEVYVF9EQVNIQk9BUkRfQ09ORklHIH0gZnJvbSAnLi9jb250ZXh0LWRhc2hib2FyZC5tb2RlbCc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIFdpZGdldFNlcnZpY2Uge1xuICB3aWRnZXRzOiBEeW5hbWljQ29tcG9uZW50RGVmaW5pdGlvbltdO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZHluYW1pY0NvbXBvbmVudFNlcnZpY2U6IER5bmFtaWNDb21wb25lbnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgdHJhbnNsYXRlU2VydmljZTogVHJhbnNsYXRlU2VydmljZSxcbiAgICBAT3B0aW9uYWwoKVxuICAgIEBJbmplY3QoQ09OVEVYVF9EQVNIQk9BUkRfQ09ORklHKVxuICAgIHB1YmxpYyBtb2R1bGVDb25maWc6IENvbnRleHREYXNoYm9hcmRDb25maWdcbiAgKSB7XG4gICAgdGhpcy5keW5hbWljQ29tcG9uZW50U2VydmljZS5pdGVtcyQuc3Vic2NyaWJlKHdpZGdldHMgPT4ge1xuICAgICAgdGhpcy53aWRnZXRzID0gd2lkZ2V0cztcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldFdpZGdldERlZmluaXRpb24oY29tcG9uZW50SWQpOiBQcm9taXNlPER5bmFtaWNDb21wb25lbnREZWZpbml0aW9uPiB7XG4gICAgcmV0dXJuIHRoaXMuZHluYW1pY0NvbXBvbmVudFNlcnZpY2UuZ2V0QnlJZChjb21wb25lbnRJZCk7XG4gIH1cblxuICBnZXRXaWRnZXREZWZpbml0aW9ucygpIHtcbiAgICBjb25zdCB0cmFuc2xhdGVkQ29tcG9uZW50cyA9IHRoaXMud2lkZ2V0cy5tYXAoY21wID0+ICh7XG4gICAgICAuLi5jbXAsXG4gICAgICBsYWJlbDogdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoY21wLmxhYmVsKVxuICAgIH0pKTtcblxuICAgIHJldHVybiBjbG9uZURlZXAoc29ydEJ5KHRyYW5zbGF0ZWRDb21wb25lbnRzLCAnbGFiZWwnKS5maWx0ZXIodGhpcy5tb2R1bGVDb25maWcud2lkZ2V0RmlsdGVyKSk7XG4gIH1cblxuICBhc3luYyBtYXBMZWdhY3kod2lkZ2V0OiBQYXJ0aWFsPFdpZGdldD4pOiBQcm9taXNlPFdpZGdldD4ge1xuICAgIGNvbnN0IGNtcCA9IGF3YWl0IHRoaXMuZ2V0V2lkZ2V0RGVmaW5pdGlvbih3aWRnZXQuY29tcG9uZW50SWQgfHwgd2lkZ2V0Lm5hbWUpO1xuICAgIGlmIChnZXQoY21wLCAnZGF0YS5zZXR0aW5ncy51cGdyYWRlJykpIHtcbiAgICAgIHdpZGdldC53aWRnZXRDb21wb25lbnQgPSBjbXAuZGF0YS5zZXR0aW5ncy53aWRnZXRDb21wb25lbnQ7XG4gICAgICB3aWRnZXQuY29uZmlnQ29tcG9uZW50ID0gY21wLmRhdGEuc2V0dGluZ3MuY29uZmlnQ29tcG9uZW50O1xuICAgICAgd2lkZ2V0LnRlbXBsYXRlVXJsID0gY21wLmRhdGEuc2V0dGluZ3MudGVtcGxhdGVVcmw7XG4gICAgICB3aWRnZXQuY29uZmlnVGVtcGxhdGVVcmwgPSBjbXAuZGF0YS5zZXR0aW5ncy5jb25maWdUZW1wbGF0ZVVybDtcbiAgICAgIHdpZGdldC50cmFuc2Zvcm1Db25maWdXaXRoQ29udGV4dCA9XG4gICAgICAgIGNtcC5kYXRhLnNldHRpbmdzLmNvbXBvbmVudFRyYW5zZm9ybUNvbmZpZ1dpdGhDb250ZXh0IHx8XG4gICAgICAgIGNtcC5kYXRhLnNldHRpbmdzLnRyYW5zZm9ybUNvbmZpZ1dpdGhDb250ZXh0IHx8XG4gICAgICAgIHdpZGdldC50cmFuc2Zvcm1Db25maWdXaXRoQ29udGV4dDtcbiAgICB9IGVsc2Uge1xuICAgICAgZGVsZXRlIHdpZGdldC50ZW1wbGF0ZVVybDtcbiAgICAgIGRlbGV0ZSB3aWRnZXQuY29uZmlnVGVtcGxhdGVVcmw7XG4gICAgfVxuICAgIHJldHVybiB3aWRnZXQgYXMgV2lkZ2V0O1xuICB9XG59XG4iXX0=