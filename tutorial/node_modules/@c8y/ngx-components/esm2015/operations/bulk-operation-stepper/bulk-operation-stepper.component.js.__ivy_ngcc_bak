import { __awaiter } from "tslib";
import { Component, ContentChildren, EventEmitter, Output, ViewChild } from '@angular/core';
import { AlertService, C8yStepper, gettext, ModalService, Status } from '@c8y/ngx-components';
import { get } from 'lodash-es';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { OperationDetailsComponent } from '@c8y/ngx-components/operations/details';
import { CustomStep } from './custom-step.directive';
import { BulkOperationsService } from '@c8y/ngx-components/operations/bulk-operations-service';
export class BulkOperationStepper {
    constructor(bulkOperationService, modal, alert) {
        this.bulkOperationService = bulkOperationService;
        this.modal = modal;
        this.alert = alert;
        this.selectionChange = new EventEmitter();
        this.steps = [];
        this.showStepper = false;
        this.showButtons = false;
        this.stepperButtonsLabels = { custom: gettext('Schedule bulk operation') };
        this.deviceTypesSubject$ = new Subject();
        this.endSubscriptions = new Subject();
        this.deviceTypes$ = this.deviceTypesSubject$.asObservable();
    }
    ngAfterViewInit() {
        setTimeout(() => {
            // wait for the next event loop turn as `steps` has already been checked in this CD cycle
            this.steps = this.customSteps.toArray();
            this.showStepper = true;
            setTimeout(() => {
                // postpone rendering of buttons for custom steps to the point where custom steps have already been rendered
                this.showButtons = true;
                if (this.stepper) {
                    this.stepper.selectionChange.pipe(takeUntil(this.endSubscriptions)).subscribe(event => {
                        this.selectionChange.next(event);
                    });
                    this.operationDetailsForm = this.operationDetailsComponent.fgOperationDescription;
                }
            });
        });
    }
    changeDeviceTypes(deviceTypes) {
        if (deviceTypes) {
            this.deviceTypesSubject$.next(Array.isArray(deviceTypes) ? deviceTypes : [deviceTypes]);
        }
        else {
            this.deviceTypesSubject$.next([]);
        }
    }
    confirmDeviceSelection($event) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.deviceQueryString) {
                try {
                    yield this.modal.confirm(gettext('All devices selected'), gettext('You are about to schedule the bulk operation to be executed for all devices. Do you want to proceed?'), Status.WARNING, { ok: gettext('Schedule for all devices'), cancel: gettext('Cancel and select devices') });
                    $event.step.completed = true;
                    $event.stepper.next();
                    this.operationDetails = this.retrieveOperationDetails
                        ? yield this.retrieveOperationDetails()
                        : undefined;
                }
                catch (ex) {
                    // Intentionally empty
                }
            }
            else {
                $event.step.completed = true;
                $event.stepper.next();
                this.operationDetails = this.retrieveOperationDetails
                    ? yield this.retrieveOperationDetails()
                    : undefined;
            }
            this.bulkOperationType = this.bulkOperationService.retrieveBulkOperationType(get(this.operationDetails, 'prototype'));
            if (this.operationDetailsForm &&
                get(this.operationDetailsForm, 'controls.description.pristine') &&
                this.operationDetails) {
                this.operationDetailsForm.patchValue({
                    description: get(this.operationDetails, 'prototype.description')
                });
            }
        });
    }
    cancel() {
        this.close();
    }
    scheduleBulkOperation() {
        return __awaiter(this, void 0, void 0, function* () {
            this.pendingStatus = true;
            try {
                this.operationDetails.prototype.description = get(this.operationDetailsForm, 'controls.description.value');
                this.operationDetails.note = get(this.operationDetailsForm, 'controls.note.value');
                this.operationDetails.schedule = get(this.operationDetailsForm, 'controls.schedule.value');
                yield this.bulkOperationService.scheduleBulkOperation(this.deviceQueryString, this.operationDetails);
                this.alert.success(gettext('New bulk operation scheduled.'));
                this.close();
            }
            catch (ex) {
                this.alert.addServerFailure(ex);
            }
            this.pendingStatus = false;
        });
    }
    ngOnDestroy() {
        this.endSubscriptions.next();
        this.endSubscriptions.complete();
    }
    close() {
        this.stepper.reset();
        this.bulkOperationService.returnToBulkOperationOverview();
    }
}
BulkOperationStepper.decorators = [
    { type: Component, args: [{
                selector: 'c8y-bulk-operation-stepper',
                template: "<div class=\"fit-h\">\n  <c8y-stepper\n    class=\"flex-col no-align-items fit-h c8y-stepper--no-btns\"\n    linear\n    [disableDefaultIcons]=\"{ edit: true, done: false }\"\n    [customClasses]=\"['col-md-6', 'col-md-offset-3', 'm-t-24', 'm-b-40', 'p-0', 'flex-no-shrink']\"\n    *ngIf=\"showStepper\"\n  >\n    <!-- CUSTOM STEPS 1 to N-2 -->\n    <cdk-step\n      *ngFor=\"let step of steps\"\n      [label]=\"step.label | translate\"\n      [completed]=\"step.completed\"\n    >\n      <ng-container *ngTemplateOutlet=\"step.templateRef\"></ng-container>\n      <c8y-stepper-buttons\n        class=\"d-block card-footer p-24 separator\"\n        *ngIf=\"showButtons\"\n        [disabled]=\"step.buttonsDisabled\"\n        (onNext)=\"step.onNext($event)\"\n        (onCancel)=\"cancel()\"\n      ></c8y-stepper-buttons>\n    </cdk-step>\n    <!-- STEP N-1 - Data-grid -->\n    <cdk-step [label]=\"'Select target devices' | translate\">\n      <div class=\"card-block p-t-0 flex-no-shrink separator-bottom col-xs-12\">\n        <div class=\"row p-b-16\">\n          <div class=\"col-md-6 col-md-offset-3 col-lg-4 col-lg-offset-4\">\n            <h4 class=\"text-center m-b-16\">\n              {{ 'Select target devices' | translate }}\n            </h4>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"col-xs-12 flex-grow no-gutter\">\n        <c8y-device-selector\n          [deviceTypes]=\"deviceTypes$\"\n          (onDeviceQueryStringChange)=\"deviceQueryString = $event\"\n        ></c8y-device-selector>\n      </div>\n      <c8y-stepper-buttons\n        class=\"d-block card-footer p-24 separator\"\n        *ngIf=\"showButtons\"\n        (onNext)=\"confirmDeviceSelection($event)\"\n        (onCancel)=\"cancel()\"\n      ></c8y-stepper-buttons>\n    </cdk-step>\n\n    <!-- STEP N - Scheduler -->\n    <cdk-step [label]=\"'Confirm and schedule bulk operation' | translate\">\n      <div class=\"card-block p-t-0 flex-no-shrink separator-bottom col-xs-12\">\n        <div class=\"row p-b-16\">\n          <div class=\"col-md-6 col-md-offset-3 col-lg-4 col-lg-offset-4\">\n            <h4 class=\"text-center m-b-16\">\n              {{ 'Confirm and schedule bulk operation' | translate }}\n            </h4>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"col-xs-12 flex-grow no-gutter\">\n        <div class=\"card-inner-scroll fit-h\">\n          <div class=\"card-block p-b-0\">\n            <div class=\"text-center p-b-16\">\n              <c8y-operation-summary\n                [name]=\"operationDetails?.name | translate\"\n                [description]=\"operationDetails?.description | translate\"\n                [deviceQueryString]=\"deviceQueryString\"\n              ></c8y-operation-summary>\n            </div>\n            <div class=\"row\">\n              <div class=\"col-md-4 col-md-offset-4\">\n                <c8y-operation-details\n                  [bulkOperationType]=\"bulkOperationType\"\n                ></c8y-operation-details>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      <c8y-stepper-buttons\n        class=\"d-block card-footer p-24 separator\"\n        *ngIf=\"showButtons\"\n        [labels]=\"stepperButtonsLabels\"\n        [pending]=\"pendingStatus\"\n        [disabled]=\"operationDetailsForm?.invalid\"\n        (onCancel)=\"cancel()\"\n        (onCustom)=\"scheduleBulkOperation()\"\n      >\n      </c8y-stepper-buttons>\n    </cdk-step>\n  </c8y-stepper>\n</div>\n"
            },] }
];
BulkOperationStepper.ctorParameters = () => [
    { type: BulkOperationsService },
    { type: ModalService },
    { type: AlertService }
];
BulkOperationStepper.propDecorators = {
    selectionChange: [{ type: Output }],
    customSteps: [{ type: ContentChildren, args: [CustomStep,] }],
    stepper: [{ type: ViewChild, args: [C8yStepper, { static: false },] }],
    operationDetailsComponent: [{ type: ViewChild, args: [OperationDetailsComponent, { static: false },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb24tc3RlcHBlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9vcGVyYXRpb25zL2J1bGstb3BlcmF0aW9uLXN0ZXBwZXIvYnVsay1vcGVyYXRpb24tc3RlcHBlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsZUFBZSxFQUNmLFlBQVksRUFFWixNQUFNLEVBRU4sU0FBUyxFQUNWLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDOUYsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNoQyxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUVuRixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDckQsT0FBTyxFQUdMLHFCQUFxQixFQUN0QixNQUFNLHdEQUF3RCxDQUFDO0FBTWhFLE1BQU0sT0FBTyxvQkFBb0I7SUF3Qi9CLFlBQ1Usb0JBQTJDLEVBQzNDLEtBQW1CLEVBQ25CLEtBQW1CO1FBRm5CLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBdUI7UUFDM0MsVUFBSyxHQUFMLEtBQUssQ0FBYztRQUNuQixVQUFLLEdBQUwsS0FBSyxDQUFjO1FBMUJuQixvQkFBZSxHQUF3QyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBT3BGLFVBQUssR0FBaUIsRUFBRSxDQUFDO1FBQ3pCLGdCQUFXLEdBQVksS0FBSyxDQUFDO1FBQzdCLGdCQUFXLEdBQVksS0FBSyxDQUFDO1FBRTdCLHlCQUFvQixH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QUFFLENBQUM7YUFDZDtZQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUNYLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDakM7WUFFRCxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztRQUM3QixDQUFDO0tBQUE7SUFFRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNuQyxDQUFDO0lBRU8sS0FBSztRQUNYLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLG9CQUFvQixDQUFDLDZCQUE2QixFQUFFLENBQUM7SUFDNUQsQ0FBQzs7O1lBM0lGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsNEJBQTRCO2dCQUN0Qyx5OEdBQW9EO2FBQ3JEOzs7WUFOQyxxQkFBcUI7WUFWcUIsWUFBWTtZQUEvQyxZQUFZOzs7OEJBa0JsQixNQUFNOzBCQUNOLGVBQWUsU0FBQyxVQUFVO3NCQUMxQixTQUFTLFNBQUMsVUFBVSxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRTt3Q0FFdkMsU0FBUyxTQUFDLHlCQUF5QixFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENka1N0ZXAsIFN0ZXBwZXJTZWxlY3Rpb25FdmVudCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9zdGVwcGVyJztcbmltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgQ29udGVudENoaWxkcmVuLFxuICBFdmVudEVtaXR0ZXIsXG4gIE9uRGVzdHJveSxcbiAgT3V0cHV0LFxuICBRdWVyeUxpc3QsXG4gIFZpZXdDaGlsZFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1Hcm91cCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSwgQzh5U3RlcHBlciwgZ2V0dGV4dCwgTW9kYWxTZXJ2aWNlLCBTdGF0dXMgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IGdldCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBPcGVyYXRpb25EZXRhaWxzQ29tcG9uZW50IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9vcGVyYXRpb25zL2RldGFpbHMnO1xuaW1wb3J0IHsgT3BlcmF0aW9uU2NoZWR1bGUgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvYnVsay1vcGVyYXRpb24tc2NoZWR1bGVyJztcbmltcG9ydCB7IEN1c3RvbVN0ZXAgfSBmcm9tICcuL2N1c3RvbS1zdGVwLmRpcmVjdGl2ZSc7XG5pbXBvcnQge1xuICBPcGVyYXRpb25EZXRhaWxzLFxuICBCdWxrT3BlcmF0aW9uVHlwZSxcbiAgQnVsa09wZXJhdGlvbnNTZXJ2aWNlXG59IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvb3BlcmF0aW9ucy9idWxrLW9wZXJhdGlvbnMtc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1idWxrLW9wZXJhdGlvbi1zdGVwcGVyJyxcbiAgdGVtcGxhdGVVcmw6ICdidWxrLW9wZXJhdGlvbi1zdGVwcGVyLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBCdWxrT3BlcmF0aW9uU3RlcHBlciBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIEBPdXRwdXQoKSBzZWxlY3Rpb25DaGFuZ2U6IEV2ZW50RW1pdHRlcjxTdGVwcGVyU2VsZWN0aW9uRXZlbnQ+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBAQ29udGVudENoaWxkcmVuKEN1c3RvbVN0ZXApIGN1c3RvbVN0ZXBzOiBRdWVyeUxpc3Q8Q3VzdG9tU3RlcD47XG4gIEBWaWV3Q2hpbGQoQzh5U3RlcHBlciwgeyBzdGF0aWM6IGZhbHNlIH0pXG4gIHN0ZXBwZXI6IEM4eVN0ZXBwZXI7XG4gIEBWaWV3Q2hpbGQoT3BlcmF0aW9uRGV0YWlsc0NvbXBvbmVudCwgeyBzdGF0aWM6IGZhbHNlIH0pXG4gIG9wZXJhdGlvbkRldGFpbHNDb21wb25lbnQ6IE9wZXJhdGlvbkRldGFpbHNDb21wb25lbnQ7XG5cbiAgc3RlcHM6IEN1c3RvbVN0ZXBbXSA9IFtdO1xuICBzaG93U3RlcHBlcjogYm9vbGVhbiA9IGZhbHNlO1xuICBzaG93QnV0dG9uczogYm9vbGVhbiA9IGZhbHNlO1xuICBwZW5kaW5nU3RhdHVzOiBib29sZWFuO1xuICBzdGVwcGVyQnV0dG9uc0xhYmVscyA9IHsgY3VzdG9tOiBnZXR0ZXh0KCdTY2hlZHVsZSBidWxrIG9wZXJhdGlvbicpIH07XG4gIGRldmljZVR5cGVzJDogT2JzZXJ2YWJsZTxzdHJpbmdbXT47XG4gIGRldmljZVF1ZXJ5U3RyaW5nOiBzdHJpbmc7XG4gIGJ1bGtPcGVyYXRpb25UeXBlOiBCdWxrT3BlcmF0aW9uVHlwZTtcbiAgc2NoZWR1bGVEYXRhOiBPcGVyYXRpb25TY2hlZHVsZTtcbiAgb3BlcmF0aW9uRGV0YWlsc0Zvcm06IEZvcm1Hcm91cDtcbiAgb3BlcmF0aW9uRGV0YWlsczogT3BlcmF0aW9uRGV0YWlscztcbiAgcmV0cmlldmVPcGVyYXRpb25EZXRhaWxzOiAoKSA9PiBPcGVyYXRpb25EZXRhaWxzIHwgUHJvbWlzZTxPcGVyYXRpb25EZXRhaWxzPjtcblxuICBwcml2YXRlIGRldmljZVR5cGVzU3ViamVjdCQ6IFN1YmplY3Q8c3RyaW5nW10+ID0gbmV3IFN1YmplY3QoKTtcbiAgcHJpdmF0ZSBlbmRTdWJzY3JpcHRpb25zOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3QoKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGJ1bGtPcGVyYXRpb25TZXJ2aWNlOiBCdWxrT3BlcmF0aW9uc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBtb2RhbDogTW9kYWxTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWxlcnQ6IEFsZXJ0U2VydmljZVxuICApIHtcbiAgICB0aGlzLmRldmljZVR5cGVzJCA9IHRoaXMuZGV2aWNlVHlwZXNTdWJqZWN0JC5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIC8vIHdhaXQgZm9yIHRoZSBuZXh0IGV2ZW50IGxvb3AgdHVybiBhcyBgc3RlcHNgIGhhcyBhbHJlYWR5IGJlZW4gY2hlY2tlZCBpbiB0aGlzIENEIGN5Y2xlXG4gICAgICB0aGlzLnN0ZXBzID0gdGhpcy5jdXN0b21TdGVwcy50b0FycmF5KCk7XG4gICAgICB0aGlzLnNob3dTdGVwcGVyID0gdHJ1ZTtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAvLyBwb3N0cG9uZSByZW5kZXJpbmcgb2YgYnV0dG9ucyBmb3IgY3VzdG9tIHN0ZXBzIHRvIHRoZSBwb2ludCB3aGVyZSBjdXN0b20gc3RlcHMgaGF2ZSBhbHJlYWR5IGJlZW4gcmVuZGVyZWRcbiAgICAgICAgdGhpcy5zaG93QnV0dG9ucyA9IHRydWU7XG4gICAgICAgIGlmICh0aGlzLnN0ZXBwZXIpIHtcbiAgICAgICAgICB0aGlzLnN0ZXBwZXIuc2VsZWN0aW9uQ2hhbmdlLnBpcGUodGFrZVVudGlsKHRoaXMuZW5kU3Vic2NyaXB0aW9ucykpLnN1YnNjcmliZShldmVudCA9PiB7XG4gICAgICAgICAgICB0aGlzLnNlbGVjdGlvbkNoYW5nZS5uZXh0KGV2ZW50KTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICB0aGlzLm9wZXJhdGlvbkRldGFpbHNGb3JtID0gdGhpcy5vcGVyYXRpb25EZXRhaWxzQ29tcG9uZW50LmZnT3BlcmF0aW9uRGVzY3JpcHRpb247XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgY2hhbmdlRGV2aWNlVHlwZXMoZGV2aWNlVHlwZXM6IHN0cmluZyB8IHN0cmluZ1tdKSB7XG4gICAgaWYgKGRldmljZVR5cGVzKSB7XG4gICAgICB0aGlzLmRldmljZVR5cGVzU3ViamVjdCQubmV4dChBcnJheS5pc0FycmF5KGRldmljZVR5cGVzKSA/IGRldmljZVR5cGVzIDogW2RldmljZVR5cGVzXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGV2aWNlVHlwZXNTdWJqZWN0JC5uZXh0KFtdKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjb25maXJtRGV2aWNlU2VsZWN0aW9uKCRldmVudDogeyBzdGVwcGVyOiBDOHlTdGVwcGVyOyBzdGVwOiBDZGtTdGVwIH0pIHtcbiAgICBpZiAoIXRoaXMuZGV2aWNlUXVlcnlTdHJpbmcpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMubW9kYWwuY29uZmlybShcbiAgICAgICAgICBnZXR0ZXh0KCdBbGwgZGV2aWNlcyBzZWxlY3RlZCcpLFxuICAgICAgICAgIGdldHRleHQoXG4gICAgICAgICAgICAnWW91IGFyZSBhYm91dCB0byBzY2hlZHVsZSB0aGUgYnVsayBvcGVyYXRpb24gdG8gYmUgZXhlY3V0ZWQgZm9yIGFsbCBkZXZpY2VzLiBEbyB5b3Ugd2FudCB0byBwcm9jZWVkPydcbiAgICAgICAgICApLFxuICAgICAgICAgIFN0YXR1cy5XQVJOSU5HLFxuICAgICAgICAgIHsgb2s6IGdldHRleHQoJ1NjaGVkdWxlIGZvciBhbGwgZGV2aWNlcycpLCBjYW5jZWw6IGdldHRleHQoJ0NhbmNlbCBhbmQgc2VsZWN0IGRldmljZXMnKSB9XG4gICAgICAgICk7XG4gICAgICAgICRldmVudC5zdGVwLmNvbXBsZXRlZCA9IHRydWU7XG4gICAgICAgICRldmVudC5zdGVwcGVyLm5leHQoKTtcbiAgICAgICAgdGhpcy5vcGVyYXRpb25EZXRhaWxzID0gdGhpcy5yZXRyaWV2ZU9wZXJhdGlvbkRldGFpbHNcbiAgICAgICAgICA/IGF3YWl0IHRoaXMucmV0cmlldmVPcGVyYXRpb25EZXRhaWxzKClcbiAgICAgICAgICA6IHVuZGVmaW5lZDtcbiAgICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAgIC8vIEludGVudGlvbmFsbHkgZW1wdHlcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgJGV2ZW50LnN0ZXAuY29tcGxldGVkID0gdHJ1ZTtcbiAgICAgICRldmVudC5zdGVwcGVyLm5leHQoKTtcbiAgICAgIHRoaXMub3BlcmF0aW9uRGV0YWlscyA9IHRoaXMucmV0cmlldmVPcGVyYXRpb25EZXRhaWxzXG4gICAgICAgID8gYXdhaXQgdGhpcy5yZXRyaWV2ZU9wZXJhdGlvbkRldGFpbHMoKVxuICAgICAgICA6IHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICB0aGlzLmJ1bGtPcGVyYXRpb25UeXBlID0gdGhpcy5idWxrT3BlcmF0aW9uU2VydmljZS5yZXRyaWV2ZUJ1bGtPcGVyYXRpb25UeXBlKFxuICAgICAgZ2V0KHRoaXMub3BlcmF0aW9uRGV0YWlscywgJ3Byb3RvdHlwZScpXG4gICAgKTtcbiAgICBpZiAoXG4gICAgICB0aGlzLm9wZXJhdGlvbkRldGFpbHNGb3JtICYmXG4gICAgICBnZXQodGhpcy5vcGVyYXRpb25EZXRhaWxzRm9ybSwgJ2NvbnRyb2xzLmRlc2NyaXB0aW9uLnByaXN0aW5lJykgJiZcbiAgICAgIHRoaXMub3BlcmF0aW9uRGV0YWlsc1xuICAgICkge1xuICAgICAgdGhpcy5vcGVyYXRpb25EZXRhaWxzRm9ybS5wYXRjaFZhbHVlKHtcbiAgICAgICAgZGVzY3JpcHRpb246IGdldCh0aGlzLm9wZXJhdGlvbkRldGFpbHMsICdwcm90b3R5cGUuZGVzY3JpcHRpb24nKVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgY2FuY2VsKCkge1xuICAgIHRoaXMuY2xvc2UoKTtcbiAgfVxuXG4gIGFzeW5jIHNjaGVkdWxlQnVsa09wZXJhdGlvbigpIHtcbiAgICB0aGlzLnBlbmRpbmdTdGF0dXMgPSB0cnVlO1xuXG4gICAgdHJ5IHtcbiAgICAgIHRoaXMub3BlcmF0aW9uRGV0YWlscy5wcm90b3R5cGUuZGVzY3JpcHRpb24gPSBnZXQoXG4gICAgICAgIHRoaXMub3BlcmF0aW9uRGV0YWlsc0Zvcm0sXG4gICAgICAgICdjb250cm9scy5kZXNjcmlwdGlvbi52YWx1ZSdcbiAgICAgICk7XG4gICAgICB0aGlzLm9wZXJhdGlvbkRldGFpbHMubm90ZSA9IGdldCh0aGlzLm9wZXJhdGlvbkRldGFpbHNGb3JtLCAnY29udHJvbHMubm90ZS52YWx1ZScpO1xuICAgICAgdGhpcy5vcGVyYXRpb25EZXRhaWxzLnNjaGVkdWxlID0gZ2V0KHRoaXMub3BlcmF0aW9uRGV0YWlsc0Zvcm0sICdjb250cm9scy5zY2hlZHVsZS52YWx1ZScpO1xuXG4gICAgICBhd2FpdCB0aGlzLmJ1bGtPcGVyYXRpb25TZXJ2aWNlLnNjaGVkdWxlQnVsa09wZXJhdGlvbihcbiAgICAgICAgdGhpcy5kZXZpY2VRdWVyeVN0cmluZyxcbiAgICAgICAgdGhpcy5vcGVyYXRpb25EZXRhaWxzXG4gICAgICApO1xuICAgICAgdGhpcy5hbGVydC5zdWNjZXNzKGdldHRleHQoJ05ldyBidWxrIG9wZXJhdGlvbiBzY2hlZHVsZWQuJykpO1xuICAgICAgdGhpcy5jbG9zZSgpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICB0aGlzLmFsZXJ0LmFkZFNlcnZlckZhaWx1cmUoZXgpO1xuICAgIH1cblxuICAgIHRoaXMucGVuZGluZ1N0YXR1cyA9IGZhbHNlO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5lbmRTdWJzY3JpcHRpb25zLm5leHQoKTtcbiAgICB0aGlzLmVuZFN1YnNjcmlwdGlvbnMuY29tcGxldGUoKTtcbiAgfVxuXG4gIHByaXZhdGUgY2xvc2UoKSB7XG4gICAgdGhpcy5zdGVwcGVyLnJlc2V0KCk7XG4gICAgdGhpcy5idWxrT3BlcmF0aW9uU2VydmljZS5yZXR1cm5Ub0J1bGtPcGVyYXRpb25PdmVydmlldygpO1xuICB9XG59XG4iXX0=