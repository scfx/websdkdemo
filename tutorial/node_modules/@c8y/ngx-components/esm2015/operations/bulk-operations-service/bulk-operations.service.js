import { __awaiter } from "tslib";
import { Location } from '@angular/common';
import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { flatten, has, isUndefined } from 'lodash-es';
import { Subject } from 'rxjs';
import { InventoryService, OperationBulkService, OperationService } from '@c8y/client';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/client';
import * as ɵngcc2 from '@angular/common';
export const baseUrl = 'devicecontrol/bulk/creation/';
export const HOOK_LIST_BULK_TYPE = new InjectionToken('LIST_BULK_TYPE');
export class BulkOperationsService {
    constructor(operationBulkService, operationService, inventoryService, location, bulkTypes) {
        this.operationBulkService = operationBulkService;
        this.operationService = operationService;
        this.inventoryService = inventoryService;
        this.location = location;
        this.DD_LOW_COUNT = 10;
        this.firmwareId = new Subject();
        this.bulkTypes = flatten(bulkTypes);
        this.bulkTypes = this.bulkTypes.map(type => {
            if (isUndefined(type.selected)) {
                type.selected = false;
            }
            return type;
        });
    }
    getBulkOperations(customFilter = {}) {
        const filter = Object.assign({ withTotalPages: true, withDeleted: true, pageSize: 50 }, customFilter);
        return this.operationBulkService.list(filter);
    }
    getBulkOperationById(bulkOperationId) {
        return this.operationBulkService.detail(bulkOperationId);
    }
    createBulkOperation(bulkOperation) {
        return this.operationBulkService.create(bulkOperation);
    }
    deleteBulkOperation(bulkOperationId) {
        return this.operationBulkService.delete(bulkOperationId);
    }
    updateBulkOperation(bulkOperation) {
        return this.operationBulkService.update(bulkOperation);
    }
    getOperation(id) {
        return this.operationService.detail(id);
    }
    returnToBulkOperationOverview() {
        this.location.back();
    }
    setBulkTypes(list) {
        this.bulkTypes = list;
    }
    getBulkTypes() {
        return this.bulkTypes;
    }
    setFirmwareId(id) {
        this.firmwareId.next(id);
    }
    createGroup(deviceQueryDataString) {
        const dynamicGroup = {
            name: 'Bulk operations group',
            type: 'c8y_DynamicGroup',
            c8y_IsDynamicGroup: { invisible: {} },
            c8y_DeviceQueryString: deviceQueryDataString
        };
        return this.inventoryService.create(dynamicGroup);
    }
    scheduleBulkOperation(deviceQueryString, details) {
        return __awaiter(this, void 0, void 0, function* () {
            const dynamicGroup = yield this.createGroup(deviceQueryString);
            const bulkOperation = {
                groupId: dynamicGroup.data.id,
                operationPrototype: details.prototype,
                creationRamp: details.schedule.delayInSeconds,
                startDate: details.schedule.scheduledDate.toISOString(),
                note: details.note
            };
            yield this.createBulkOperation(bulkOperation);
        });
    }
    getSingleOperationsByStatus(status, bulkOperationId) {
        const filter = {
            withTotalPages: true,
            bulkOperationId,
            status: (status && status.toUpperCase()) || ''
        };
        return this.operationService.list(filter);
    }
    createSingleOperation(operation) {
        return this.operationService.create(operation);
    }
    updateSingleOperation(partialUpdateObject) {
        return this.operationService.update(partialUpdateObject);
    }
    getManagedObject(deviceId) {
        return this.inventoryService.detail(deviceId);
    }
    retrieveBulkOperationType(operation) {
        let type;
        this.bulkTypes.some(t => {
            if (t.fragments.some(fragment => has(operation, fragment))) {
                type = t.type;
                return true;
            }
        });
        return type;
    }
}
BulkOperationsService.ɵfac = function BulkOperationsService_Factory(t) { return new (t || BulkOperationsService)(ɵngcc0.ɵɵinject(ɵngcc1.OperationBulkService), ɵngcc0.ɵɵinject(ɵngcc1.OperationService), ɵngcc0.ɵɵinject(ɵngcc1.InventoryService), ɵngcc0.ɵɵinject(ɵngcc2.Location), ɵngcc0.ɵɵinject(HOOK_LIST_BULK_TYPE, 8)); };
BulkOperationsService.ɵprov = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjectable({ token: BulkOperationsService, factory: BulkOperationsService.ɵfac });
BulkOperationsService.ctorParameters = () => [
    { type: OperationBulkService },
    { type: OperationService },
    { type: InventoryService },
    { type: Location },
    { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [HOOK_LIST_BULK_TYPE,] }] }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(BulkOperationsService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.OperationBulkService }, { type: ɵngcc1.OperationService }, { type: ɵngcc1.InventoryService }, { type: ɵngcc2.Location }, { type: Array, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [HOOK_LIST_BULK_TYPE]
            }] }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL29wZXJhdGlvbnMvYnVsay1vcGVyYXRpb25zLXNlcnZpY2UvYnVsay1vcGVyYXRpb25zLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxjQUFjLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdFLE9BQU8sRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUN0RCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRS9CLE9BQU8sRUFHTCxnQkFBZ0IsRUFJaEIsb0JBQW9CLEVBQ3BCLGdCQUFnQixFQUNqQixNQUFNLGFBQWEsQ0FBQzs7OztBQU1yQixNQUFNLENBQUMsTUFBTSxPQUFPLEdBQUcsOEJBQThCLENBQUM7QUFDdEQsTUFBTSxDQUFDLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxjQUFjLENBQ25ELGdCQUFnQixDQUNqQixDQUFDO0FBR0YsTUFBTSxPQUFPLHFCQUFxQjtBQUNsQyxJQUtFLFlBQ1Usb0JBQTBDLEVBQzFDLGdCQUFrQyxFQUNsQyxnQkFBa0MsRUFDbEMsUUFBa0IsRUFFZSxTQUFpRDtBQUMzRixRQU5TLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7QUFBQyxRQUMzQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO0FBQUMsUUFDbkMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtBQUFDLFFBQ25DLGFBQVEsR0FBUixRQUFRLENBQVU7QUFBQyxRQVRwQixpQkFBWSxHQUFXLEVBQUUsQ0FBQztBQUNyQyxRQUFFLGVBQVUsR0FBeUIsSUFBSSxPQUFPLEVBQWUsQ0FBQztBQUNoRSxRQVdJLElBQUksQ0FBQyxTQUFTLEdBQUcs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LHlCQUF5QixDQUFDLFNBQXFCO0FBQUksUUFDakQsSUFBSSxJQUF1QixDQUFDO0FBQ2hDLFFBQ0ksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUU7QUFDNUIsWUFBTSxJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQyxFQUFFO0FBQ2xFLGdCQUFRLElBQUksR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO0FBQ3RCLGdCQUFRLE9BQU8sSUFBSSxDQUFDO0FBQ3BCLGFBQU87QUFDUCxRQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ1AsUUFDSSxPQUFPLElBQUksQ0FBQztBQUNoQixJQUFFLENBQUM7QUFDSDtpREFuSUMsVUFBVTs2SUFDVDtBQUFDO0FBQ1UsWUFmWCxvQkFBb0I7QUFDcEIsWUFBQSxnQkFBZ0I7QUFDZixZQU5ELGdCQUFnQjtBQUNoQixZQVRPLFFBQVE7QUFBSSxZQXNDbUMsS0FBSyx1QkFBeEQsUUFBUSxZQUFJLE1BQU0sU0FBQyxtQkFBbUI7QUFBUTs7Ozs7Ozs7a0NBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvY2F0aW9uIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBmbGF0dGVuLCBoYXMsIGlzVW5kZWZpbmVkIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHtcbiAgSWRSZWZlcmVuY2UsXG4gIElNYW5hZ2VkT2JqZWN0LFxuICBJbnZlbnRvcnlTZXJ2aWNlLFxuICBJT3BlcmF0aW9uLFxuICBJT3BlcmF0aW9uQnVsayxcbiAgSVJlc3VsdCxcbiAgT3BlcmF0aW9uQnVsa1NlcnZpY2UsXG4gIE9wZXJhdGlvblNlcnZpY2Vcbn0gZnJvbSAnQGM4eS9jbGllbnQnO1xuXG5pbXBvcnQgeyBPcGVyYXRpb25EZXRhaWxzIH0gZnJvbSAnLi9vcGVyYXRpb24tZGV0YWlscy5tb2RlbCc7XG5pbXBvcnQgeyBPcGVyYXRpb25UeXBlIH0gZnJvbSAnLi9vcGVyYXRpb24tdHlwZS5tb2RlbCc7XG5pbXBvcnQgeyBCdWxrT3BlcmF0aW9uVHlwZSB9IGZyb20gJy4vYnVsay1vcGVyYXRpb24ubW9kZWwnO1xuXG5leHBvcnQgY29uc3QgYmFzZVVybCA9ICdkZXZpY2Vjb250cm9sL2J1bGsvY3JlYXRpb24vJztcbmV4cG9ydCBjb25zdCBIT09LX0xJU1RfQlVMS19UWVBFID0gbmV3IEluamVjdGlvblRva2VuPE9wZXJhdGlvblR5cGUgfCBPcGVyYXRpb25UeXBlW10+KFxuICAnTElTVF9CVUxLX1RZUEUnXG4pO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQnVsa09wZXJhdGlvbnNTZXJ2aWNlIHtcbiAgcmVhZG9ubHkgRERfTE9XX0NPVU5UOiBudW1iZXIgPSAxMDtcbiAgZmlybXdhcmVJZDogU3ViamVjdDxJZFJlZmVyZW5jZT4gPSBuZXcgU3ViamVjdDxJZFJlZmVyZW5jZT4oKTtcblxuICBwcml2YXRlIGJ1bGtUeXBlczogT3BlcmF0aW9uVHlwZVtdO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgb3BlcmF0aW9uQnVsa1NlcnZpY2U6IE9wZXJhdGlvbkJ1bGtTZXJ2aWNlLFxuICAgIHByaXZhdGUgb3BlcmF0aW9uU2VydmljZTogT3BlcmF0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGludmVudG9yeVNlcnZpY2U6IEludmVudG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBsb2NhdGlvbjogTG9jYXRpb24sXG5cbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KEhPT0tfTElTVF9CVUxLX1RZUEUpIGJ1bGtUeXBlczogQXJyYXk8T3BlcmF0aW9uVHlwZSB8IE9wZXJhdGlvblR5cGVbXT5cbiAgKSB7XG4gICAgdGhpcy5idWxrVHlwZXMgPSBmbGF0dGVuKGJ1bGtUeXBlcyk7XG5cbiAgICB0aGlzLmJ1bGtUeXBlcyA9IHRoaXMuYnVsa1R5cGVzLm1hcCh0eXBlID0+IHtcbiAgICAgIGlmIChpc1VuZGVmaW5lZCh0eXBlLnNlbGVjdGVkKSkge1xuICAgICAgICB0eXBlLnNlbGVjdGVkID0gZmFsc2U7XG4gICAgICB9XG4gICAgICByZXR1cm4gdHlwZTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldEJ1bGtPcGVyYXRpb25zKGN1c3RvbUZpbHRlciA9IHt9KSB7XG4gICAgY29uc3QgZmlsdGVyID0ge1xuICAgICAgd2l0aFRvdGFsUGFnZXM6IHRydWUsXG4gICAgICB3aXRoRGVsZXRlZDogdHJ1ZSxcbiAgICAgIHBhZ2VTaXplOiA1MCxcbiAgICAgIC4uLmN1c3RvbUZpbHRlclxuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS5saXN0KGZpbHRlcik7XG4gIH1cblxuICBnZXRCdWxrT3BlcmF0aW9uQnlJZChidWxrT3BlcmF0aW9uSWQ6IHN0cmluZyB8IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLmRldGFpbChidWxrT3BlcmF0aW9uSWQpO1xuICB9XG5cbiAgY3JlYXRlQnVsa09wZXJhdGlvbihidWxrT3BlcmF0aW9uOiBQYXJ0aWFsPElPcGVyYXRpb25CdWxrPikge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLmNyZWF0ZShidWxrT3BlcmF0aW9uKTtcbiAgfVxuXG4gIGRlbGV0ZUJ1bGtPcGVyYXRpb24oYnVsa09wZXJhdGlvbklkKSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UuZGVsZXRlKGJ1bGtPcGVyYXRpb25JZCk7XG4gIH1cblxuICB1cGRhdGVCdWxrT3BlcmF0aW9uKGJ1bGtPcGVyYXRpb246IFBhcnRpYWw8SU9wZXJhdGlvbkJ1bGs+KSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UudXBkYXRlKGJ1bGtPcGVyYXRpb24pO1xuICB9XG5cbiAgZ2V0T3BlcmF0aW9uKGlkOiBzdHJpbmcpOiBQcm9taXNlPElSZXN1bHQ8SU9wZXJhdGlvbj4+IHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmRldGFpbChpZCk7XG4gIH1cblxuICByZXR1cm5Ub0J1bGtPcGVyYXRpb25PdmVydmlldygpIHtcbiAgICB0aGlzLmxvY2F0aW9uLmJhY2soKTtcbiAgfVxuXG4gIHNldEJ1bGtUeXBlcyhsaXN0OiBPcGVyYXRpb25UeXBlW10pIHtcbiAgICB0aGlzLmJ1bGtUeXBlcyA9IGxpc3Q7XG4gIH1cblxuICBnZXRCdWxrVHlwZXMoKTogT3BlcmF0aW9uVHlwZVtdIHtcbiAgICByZXR1cm4gdGhpcy5idWxrVHlwZXM7XG4gIH1cblxuICBzZXRGaXJtd2FyZUlkKGlkOiBJZFJlZmVyZW5jZSkge1xuICAgIHRoaXMuZmlybXdhcmVJZC5uZXh0KGlkKTtcbiAgfVxuXG4gIGNyZWF0ZUdyb3VwKGRldmljZVF1ZXJ5RGF0YVN0cmluZzogc3RyaW5nKSB7XG4gICAgY29uc3QgZHluYW1pY0dyb3VwOiBQYXJ0aWFsPElNYW5hZ2VkT2JqZWN0PiA9IHtcbiAgICAgIG5hbWU6ICdCdWxrIG9wZXJhdGlvbnMgZ3JvdXAnLFxuICAgICAgdHlwZTogJ2M4eV9EeW5hbWljR3JvdXAnLFxuICAgICAgYzh5X0lzRHluYW1pY0dyb3VwOiB7IGludmlzaWJsZToge30gfSxcbiAgICAgIGM4eV9EZXZpY2VRdWVyeVN0cmluZzogZGV2aWNlUXVlcnlEYXRhU3RyaW5nXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UuY3JlYXRlKGR5bmFtaWNHcm91cCk7XG4gIH1cblxuICBhc3luYyBzY2hlZHVsZUJ1bGtPcGVyYXRpb24oZGV2aWNlUXVlcnlTdHJpbmc6IHN0cmluZywgZGV0YWlsczogT3BlcmF0aW9uRGV0YWlscykge1xuICAgIGNvbnN0IGR5bmFtaWNHcm91cCA9IGF3YWl0IHRoaXMuY3JlYXRlR3JvdXAoZGV2aWNlUXVlcnlTdHJpbmcpO1xuXG4gICAgY29uc3QgYnVsa09wZXJhdGlvbjogSU9wZXJhdGlvbkJ1bGsgPSB7XG4gICAgICBncm91cElkOiBkeW5hbWljR3JvdXAuZGF0YS5pZCxcbiAgICAgIG9wZXJhdGlvblByb3RvdHlwZTogZGV0YWlscy5wcm90b3R5cGUsXG4gICAgICBjcmVhdGlvblJhbXA6IGRldGFpbHMuc2NoZWR1bGUuZGVsYXlJblNlY29uZHMsXG4gICAgICBzdGFydERhdGU6IGRldGFpbHMuc2NoZWR1bGUuc2NoZWR1bGVkRGF0ZS50b0lTT1N0cmluZygpLFxuICAgICAgbm90ZTogZGV0YWlscy5ub3RlXG4gICAgfTtcblxuICAgIGF3YWl0IHRoaXMuY3JlYXRlQnVsa09wZXJhdGlvbihidWxrT3BlcmF0aW9uKTtcbiAgfVxuXG4gIGdldFNpbmdsZU9wZXJhdGlvbnNCeVN0YXR1cyhzdGF0dXMsIGJ1bGtPcGVyYXRpb25JZCkge1xuICAgIGNvbnN0IGZpbHRlciA9IHtcbiAgICAgIHdpdGhUb3RhbFBhZ2VzOiB0cnVlLFxuICAgICAgYnVsa09wZXJhdGlvbklkLFxuICAgICAgc3RhdHVzOiAoc3RhdHVzICYmIHN0YXR1cy50b1VwcGVyQ2FzZSgpKSB8fCAnJ1xuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmxpc3QoZmlsdGVyKTtcbiAgfVxuXG4gIGNyZWF0ZVNpbmdsZU9wZXJhdGlvbihvcGVyYXRpb246IElPcGVyYXRpb24pIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmNyZWF0ZShvcGVyYXRpb24pO1xuICB9XG5cbiAgdXBkYXRlU2luZ2xlT3BlcmF0aW9uKHBhcnRpYWxVcGRhdGVPYmplY3Q6IFBhcnRpYWw8SU9wZXJhdGlvbj4pIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25TZXJ2aWNlLnVwZGF0ZShwYXJ0aWFsVXBkYXRlT2JqZWN0KTtcbiAgfVxuXG4gIGdldE1hbmFnZWRPYmplY3QoZGV2aWNlSWQ6IElkUmVmZXJlbmNlKSB7XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5U2VydmljZS5kZXRhaWwoZGV2aWNlSWQpO1xuICB9XG5cbiAgcmV0cmlldmVCdWxrT3BlcmF0aW9uVHlwZShvcGVyYXRpb246IElPcGVyYXRpb24pOiBCdWxrT3BlcmF0aW9uVHlwZSB7XG4gICAgbGV0IHR5cGU6IEJ1bGtPcGVyYXRpb25UeXBlO1xuXG4gICAgdGhpcy5idWxrVHlwZXMuc29tZSh0ID0+IHtcbiAgICAgIGlmICh0LmZyYWdtZW50cy5zb21lKGZyYWdtZW50ID0+IGhhcyhvcGVyYXRpb24sIGZyYWdtZW50KSkpIHtcbiAgICAgICAgdHlwZSA9IHQudHlwZTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdHlwZTtcbiAgfVxufVxuIl19