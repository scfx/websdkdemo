{"version":3,"file":"c8y-ngx-components-operations-bulk-operations-service.js","sources":["../../operations/bulk-operations-service/bulk-operations.service.ts","../../operations/bulk-operations-service/bulk-operations-service.module.ts","../../operations/bulk-operations-service/bulk-operation.model.ts","../../operations/bulk-operations-service/c8y-ngx-components-operations-bulk-operations-service.ts"],"names":[],"mappings":"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","sourcesContent":["import { Location } from '@angular/common';\nimport { Inject, Injectable, InjectionToken, Optional } from '@angular/core';\nimport { flatten, has, isUndefined } from 'lodash-es';\nimport { Subject } from 'rxjs';\n\nimport {\n  IdReference,\n  IManagedObject,\n  InventoryService,\n  IOperation,\n  IOperationBulk,\n  IResult,\n  OperationBulkService,\n  OperationService\n} from '@c8y/client';\n\nimport { OperationDetails } from './operation-details.model';\nimport { OperationType } from './operation-type.model';\nimport { BulkOperationType } from './bulk-operation.model';\n\nexport const baseUrl = 'devicecontrol/bulk/creation/';\nexport const HOOK_LIST_BULK_TYPE = new InjectionToken<OperationType | OperationType[]>(\n  'LIST_BULK_TYPE'\n);\n\n@Injectable()\nexport class BulkOperationsService {\n  readonly DD_LOW_COUNT: number = 10;\n  firmwareId: Subject<IdReference> = new Subject<IdReference>();\n\n  private bulkTypes: OperationType[];\n\n  constructor(\n    private operationBulkService: OperationBulkService,\n    private operationService: OperationService,\n    private inventoryService: InventoryService,\n    private location: Location,\n\n    @Optional() @Inject(HOOK_LIST_BULK_TYPE) bulkTypes: Array<OperationType | OperationType[]>\n  ) {\n    this.bulkTypes = flatten(bulkTypes);\n\n    this.bulkTypes = this.bulkTypes.map(type => {\n      if (isUndefined(type.selected)) {\n        type.selected = false;\n      }\n      return type;\n    });\n  }\n\n  getBulkOperations(customFilter = {}) {\n    const filter = {\n      withTotalPages: true,\n      withDeleted: true,\n      pageSize: 50,\n      ...customFilter\n    };\n\n    return this.operationBulkService.list(filter);\n  }\n\n  getBulkOperationById(bulkOperationId: string | number) {\n    return this.operationBulkService.detail(bulkOperationId);\n  }\n\n  createBulkOperation(bulkOperation: Partial<IOperationBulk>) {\n    return this.operationBulkService.create(bulkOperation);\n  }\n\n  deleteBulkOperation(bulkOperationId) {\n    return this.operationBulkService.delete(bulkOperationId);\n  }\n\n  updateBulkOperation(bulkOperation: Partial<IOperationBulk>) {\n    return this.operationBulkService.update(bulkOperation);\n  }\n\n  getOperation(id: string): Promise<IResult<IOperation>> {\n    return this.operationService.detail(id);\n  }\n\n  returnToBulkOperationOverview() {\n    this.location.back();\n  }\n\n  setBulkTypes(list: OperationType[]) {\n    this.bulkTypes = list;\n  }\n\n  getBulkTypes(): OperationType[] {\n    return this.bulkTypes;\n  }\n\n  setFirmwareId(id: IdReference) {\n    this.firmwareId.next(id);\n  }\n\n  createGroup(deviceQueryDataString: string) {\n    const dynamicGroup: Partial<IManagedObject> = {\n      name: 'Bulk operations group',\n      type: 'c8y_DynamicGroup',\n      c8y_IsDynamicGroup: { invisible: {} },\n      c8y_DeviceQueryString: deviceQueryDataString\n    };\n\n    return this.inventoryService.create(dynamicGroup);\n  }\n\n  async scheduleBulkOperation(deviceQueryString: string, details: OperationDetails) {\n    const dynamicGroup = await this.createGroup(deviceQueryString);\n\n    const bulkOperation: IOperationBulk = {\n      groupId: dynamicGroup.data.id,\n      operationPrototype: details.prototype,\n      creationRamp: details.schedule.delayInSeconds,\n      startDate: details.schedule.scheduledDate.toISOString(),\n      note: details.note\n    };\n\n    await this.createBulkOperation(bulkOperation);\n  }\n\n  getSingleOperationsByStatus(status, bulkOperationId) {\n    const filter = {\n      withTotalPages: true,\n      bulkOperationId,\n      status: (status && status.toUpperCase()) || ''\n    };\n\n    return this.operationService.list(filter);\n  }\n\n  createSingleOperation(operation: IOperation) {\n    return this.operationService.create(operation);\n  }\n\n  updateSingleOperation(partialUpdateObject: Partial<IOperation>) {\n    return this.operationService.update(partialUpdateObject);\n  }\n\n  getManagedObject(deviceId: IdReference) {\n    return this.inventoryService.detail(deviceId);\n  }\n\n  retrieveBulkOperationType(operation: IOperation): BulkOperationType {\n    let type: BulkOperationType;\n\n    this.bulkTypes.some(t => {\n      if (t.fragments.some(fragment => has(operation, fragment))) {\n        type = t.type;\n        return true;\n      }\n    });\n\n    return type;\n  }\n}\n","import { NgModule } from '@angular/core';\n\nimport { BulkOperationsService } from './bulk-operations.service';\n\n/**\n * This module provides a shared bulk operations service.\n */\n@NgModule({\n  imports: [],\n  providers: [BulkOperationsService]\n})\nexport class BulkOperationsServiceModule {}\n","export enum BulkOperationType {\n  SOFTWARE = 'software',\n  FIRMWARE = 'firmware',\n  CONFIGURATION = 'configuration',\n  DEVICE_PROFILE = 'device-profile'\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"]}