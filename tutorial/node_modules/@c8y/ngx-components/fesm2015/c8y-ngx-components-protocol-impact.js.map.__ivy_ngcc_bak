{"version":3,"file":"c8y-ngx-components-protocol-impact.js","sources":["../../protocol-impact/impact-subscription.service.ts","../../protocol-impact/refresh-action.component.ts","../../protocol-impact/impact-action.factory.ts","../../protocol-impact/impact-protocol.module.ts","../../protocol-impact/c8y-ngx-components-protocol-impact.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { FetchClient, IFetchOptions, IFetchResponse } from '@c8y/client';\n\n@Injectable()\nexport class ImpactSubscriptionService {\n  private readonly microserviceUrl: string = '/service/impact';\n  private readonly header: any = { 'Content-Type': 'application/json' };\n\n  constructor(private client: FetchClient) {}\n\n  refreshDeviceResources(deviceId: string | number): Promise<IFetchResponse> {\n    const options: IFetchOptions = {\n      method: 'PUT',\n      headers: this.header\n    };\n    return this.client.fetch(`${this.microserviceUrl}/refresh/${deviceId}`, options);\n  }\n}\n","import { Component, OnInit, TemplateRef, ViewChild, ViewContainerRef } from '@angular/core';\nimport { Router } from '@angular/router';\nimport { IFetchResponse } from '@c8y/client';\nimport { AlertService, gettext } from '@c8y/ngx-components';\nimport { ImpactSubscriptionService } from './impact-subscription.service';\n\n@Component({\n  selector: 'c8y-impact-refresh-action',\n  templateUrl: './refresh-action.component.html'\n})\nexport class RefreshActionComponent implements OnInit {\n  @ViewChild('templateCopy', { read: TemplateRef, static: true }) templateCopy;\n  requestInProgress: boolean;\n\n  constructor(\n    private vcRef: ViewContainerRef,\n    private router: Router,\n    private impactService: ImpactSubscriptionService,\n    private alert: AlertService\n  ) {}\n\n  ngOnInit() {\n    this.vcRef.createEmbeddedView(this.templateCopy);\n  }\n\n  async refresh() {\n    // TODO This is only a dirty hack to retrieve deviceId from URL;\n    // In fact contextData should be provided for this component by a resolver?\n    const url: string =\n      this.router &&\n      this.router.routerState &&\n      this.router.routerState.snapshot &&\n      this.router.routerState.snapshot.url;\n    const deviceId: string = url && (/^\\/device\\/(\\d+)\\/.*$/gi.exec(url) || [])[1];\n\n    if (deviceId) {\n      this.requestInProgress = true;\n      try {\n        const res: IFetchResponse = await this.impactService.refreshDeviceResources(deviceId);\n        if (res && res.status !== 200) {\n          const data = res.json ? await res.json() : undefined;\n          this.alert.addServerFailure({ data, res });\n        } else {\n          this.alert.success(gettext('Device resource refresh scheduled.'));\n        }\n      } catch (ex) {\n        this.alert.addServerFailure(ex);\n      }\n      this.requestInProgress = false;\n    } else {\n      this.alert.danger(gettext('Could not find device ID in URL.'));\n    }\n  }\n}\n","import { Injectable } from '@angular/core';\nimport { ActivatedRoute } from '@angular/router';\nimport { ApplicationService } from '@c8y/client';\nimport { ActionBarFactory, ActionBarItem } from '@c8y/ngx-components';\nimport { get } from 'lodash-es';\nimport { RefreshActionComponent } from './refresh-action.component';\n\n@Injectable()\nexport class ImpactActionFactory implements ActionBarFactory {\n  private static readonly applicationName = 'impact';\n\n  constructor(private applicationService: ApplicationService) {}\n\n  async get(activeRoute?: ActivatedRoute) {\n    const actions: ActionBarItem[] = [];\n\n    const data =\n      !activeRoute.parent || activeRoute.snapshot.data.context\n        ? activeRoute.snapshot.data\n        : activeRoute.parent.snapshot.data;\n    const { contextData } = data;\n\n    const isDeviceInfoTab: boolean = get(activeRoute, 'snapshot.url[0].path') === 'device-info';\n\n    const showRefreshActionButton: boolean =\n      isDeviceInfoTab &&\n      contextData &&\n      contextData.c8y_ImpactResourceInfo &&\n      /* call application service only for relevant devices to reduce number of service calls! */\n      (await this.applicationService.isAvailable(ImpactActionFactory.applicationName)).data;\n\n    if (showRefreshActionButton) {\n      actions.push({\n        priority: 500,\n        placement: 'right',\n        template: RefreshActionComponent\n      } as ActionBarItem);\n    }\n\n    return actions;\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { CoreModule, HOOK_ACTION_BAR } from '@c8y/ngx-components';\nimport { ImpactActionFactory } from './impact-action.factory';\nimport { ImpactSubscriptionService } from './impact-subscription.service';\nimport { RefreshActionComponent } from './refresh-action.component';\n\n@NgModule({\n  declarations: [RefreshActionComponent],\n  imports: [CoreModule],\n  providers: [\n    ImpactSubscriptionService,\n    { provide: HOOK_ACTION_BAR, useClass: ImpactActionFactory, multi: true }\n  ],\n  entryComponents: [RefreshActionComponent]\n})\nexport class ImpactProtocolModule {}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}