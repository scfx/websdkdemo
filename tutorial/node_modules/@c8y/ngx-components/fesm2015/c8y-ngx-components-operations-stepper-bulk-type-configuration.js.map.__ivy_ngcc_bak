{"version":3,"file":"c8y-ngx-components-operations-stepper-bulk-type-configuration.js","sources":["../../operations/stepper-bulk-type-configuration/stepper-bulk-type-configuration.component.ts","../../operations/stepper-bulk-type-configuration/stepper-bulk-type-configuration.module.ts","../../operations/stepper-bulk-type-configuration/c8y-ngx-components-operations-stepper-bulk-type-configuration.ts"],"sourcesContent":["import { CdkStep } from '@angular/cdk/stepper';\nimport { Component } from '@angular/core';\nimport { IManagedObject, IOperation, IResultList } from '@c8y/client';\nimport { C8yStepper, gettext } from '@c8y/ngx-components';\nimport { RepositoryService, RepositoryType } from '@c8y/ngx-components/repository';\nimport { TranslateService } from '@ngx-translate/core';\nimport { get, isEqual, uniqWith } from 'lodash-es';\nimport { BehaviorSubject, combineLatest, from, Observable, Subscription } from 'rxjs';\nimport { debounceTime, distinctUntilChanged, shareReplay, switchMap } from 'rxjs/operators';\nimport { BaseStepperComponent } from '@c8y/ngx-components/operations/bulk-operation-stepper';\nimport {\n  BulkOperationsService,\n  OperationDetails\n} from '@c8y/ngx-components/operations/bulk-operations-service';\n\n@Component({\n  selector: 'c8y-stepper-bulk-type-configuration',\n  templateUrl: 'stepper-bulk-type-configuration.component.html'\n})\nexport class StepperBulkTypeConfigurationComponent extends BaseStepperComponent {\n  readonly NO_DEVICE_TYPE_AVAILABLE = gettext('Undefined`device type`');\n  selectedConfiguration: IManagedObject;\n  elementCount: number = 0;\n  DD_LOW_COUNT: number = 10;\n  textFilter$: BehaviorSubject<string> = new BehaviorSubject('');\n  configType$: BehaviorSubject<string> = new BehaviorSubject('');\n  configTypes = [];\n  selectedConfigType = { name: '' };\n  configurations$: Observable<IResultList<IManagedObject>> = combineLatest(\n    this.textFilter$,\n    this.configType$\n  ).pipe(\n    switchMap(([name, configType]) => this.getConfiguration(name, configType)),\n    shareReplay(1)\n  );\n  private configTypeSubscription: Subscription;\n\n  constructor(\n    private bulkOperationService: BulkOperationsService,\n    private repositoryService: RepositoryService,\n    private translate: TranslateService\n  ) {\n    super();\n    this.DD_LOW_COUNT = this.bulkOperationService.DD_LOW_COUNT;\n    this.loadConfigurationTypes();\n  }\n\n  loadConfigurationTypes() {\n    this.configTypeSubscription = this.configType$\n      .pipe(\n        debounceTime(300),\n        distinctUntilChanged(),\n        switchMap(searchStr => {\n          const query = { configurationType: `*${searchStr}*` };\n          return from(\n            this.repositoryService.listRepositoryEntries(RepositoryType.CONFIGURATION, { query })\n          );\n        })\n      )\n      .subscribe(result => {\n        const { data } = result;\n        this.configTypes = uniqWith(data.map(val => ({ name: val.configurationType })), isEqual);\n      });\n  }\n  ngOnDestroy(): void {\n    this.configTypeSubscription.unsubscribe();\n  }\n\n  selectConfiguration(configuration: IManagedObject) {\n    this.selectedConfiguration = configuration;\n  }\n\n  goToSecondStep($event: { stepper: C8yStepper; step: CdkStep }) {\n    $event.stepper.next();\n    this.getConfigBinary();\n    this.deviceTypes = this.selectedConfiguration.deviceType;\n  }\n\n  async getConfigBinary() {\n    if (this.selectedConfiguration.url) {\n      this.selectedConfiguration.binary = await this.repositoryService.getBinaryText(\n        this.selectedConfiguration.url,\n        { allowExternal: true, noAlerts: true }\n      );\n    }\n  }\n\n  getDeviceTypeTitle(configuration: IManagedObject): string {\n    return get(configuration, 'deviceType', this.translate.instant(this.NO_DEVICE_TYPE_AVAILABLE));\n  }\n\n  protected retrieveOperationPrototype(): OperationDetails {\n    const configuration = {\n      type: this.selectedConfiguration.configurationType,\n      url: this.selectedConfiguration.url\n    };\n\n    return {\n      name: gettext('Configuration update'),\n      description: get(this.selectedConfiguration, 'name'),\n      prototype: ({\n        description: `Update configuration to: ${this.selectedConfiguration.name}.`,\n        c8y_DownloadConfigFile: configuration\n      } as unknown) as IOperation\n    };\n  }\n\n  private getConfiguration(name?: string, configurationType?: string) {\n    const query: any = name ? { name: `*${name}*` } : {};\n    if (configurationType) {\n      query.__or = [{ configurationType }, { __not: { __has: `configurationType` } }];\n    }\n    return this.repositoryService.listRepositoryEntries(RepositoryType.CONFIGURATION, { query });\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { ReactiveFormsModule } from '@angular/forms';\n\nimport { CoreModule, FormsModule, gettext } from '@c8y/ngx-components';\nimport { RepositoryModule } from '@c8y/ngx-components/repository';\nimport { BulkOperationStepperModule } from '@c8y/ngx-components/operations/bulk-operation-stepper';\nimport {\n  HOOK_LIST_BULK_TYPE,\n  baseUrl,\n  BulkOperationType\n} from '@c8y/ngx-components/operations/bulk-operations-service';\n\nimport { StepperBulkTypeConfigurationComponent } from './stepper-bulk-type-configuration.component';\n\n/** Module for the 'Configuration update' operation type stepper */\n@NgModule({\n  declarations: [StepperBulkTypeConfigurationComponent],\n  imports: [\n    CoreModule,\n    FormsModule,\n    ReactiveFormsModule,\n    BulkOperationStepperModule,\n    RepositoryModule\n  ],\n  providers: [\n    {\n      provide: HOOK_LIST_BULK_TYPE,\n      useValue: {\n        type: BulkOperationType.CONFIGURATION,\n        c8yIcon: 'cogs',\n        name: gettext('Configuration update'),\n        path: `${baseUrl}configuration`,\n        component: StepperBulkTypeConfigurationComponent,\n        fragments: ['c8y_DownloadConfigFile', 'c8y_Configuration'],\n        selected: false\n      },\n      multi: true\n    }\n  ],\n  entryComponents: [StepperBulkTypeConfigurationComponent],\n  exports: [StepperBulkTypeConfigurationComponent]\n})\nexport class StepperBulkTypeConfigurationModule {}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}