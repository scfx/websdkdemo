import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { AlertService } from '@c8y/ngx-components';
import { orderBy, isEqual, remove, some } from 'lodash-es';
import { InventoryService, FetchClient } from '@c8y/client';
import { TranslateService } from '@ngx-translate/core';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/ngx-components';
import * as ɵngcc2 from '@c8y/client';
import * as ɵngcc3 from '@ngx-translate/core';
export class ReportsService {
    constructor(alertService, inventoryService, client, translateService) {
        this.alertService = alertService;
        this.inventoryService = inventoryService;
        this.client = client;
        this.translateService = translateService;
        this.microserviceUrl = '/service/reporting';
        this.headers = { 'Content-Type': 'application/json' };
        this.isReportAgentSubscribed = true;
        this.REPORT_AGENT_NOT_SUBSCRIBED_EXPECTED_ERROR_LOWER_CASE = 'microservice/not found';
    }
    getExport(exportId) {
        return __awaiter(this, void 0, void 0, function* () {
            let exp;
            const exportDetail = yield this.inventoryService.detail(exportId);
            const { data, res } = exportDetail;
            if (res.status !== 200) {
                this.alertService.addServerFailure({ data, res });
            }
            else {
                exp = data ? data : {};
            }
            return exp;
        });
    }
    getScheduleList(exportId) {
        return __awaiter(this, void 0, void 0, function* () {
            const exp = yield this.getExport(exportId);
            return this.extractScheduleListFromExport(exp);
        });
    }
    extractScheduleListFromExport(exp) {
        let scheduleList;
        if (exp) {
            scheduleList = exp.c8y_ScheduleConfiguration ? exp.c8y_ScheduleConfiguration : [];
        }
        return orderBy(scheduleList, ['timestamp'], ['desc']);
    }
    addSchedule(schedule, exportId) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.updateSchedules(exportId, [], [schedule]);
        });
    }
    updateSchedule(oldSchedule, schedule, exportId) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.updateSchedules(exportId, [oldSchedule], [schedule]);
        });
    }
    updateSchedules(exportId, schedulesToRemove = [], schedulesToAdd = []) {
        return __awaiter(this, void 0, void 0, function* () {
            let success = false;
            const exp = yield this.getExport(exportId);
            const schedules = this.extractScheduleListFromExport(exp);
            remove(schedules, (schedule) => some(schedulesToRemove, (scheduleToRemove) => isEqual(schedule, scheduleToRemove)));
            schedules.push.apply(schedules, schedulesToAdd);
            exp.c8y_ScheduleConfiguration = schedules;
            const { data, res } = yield this.inventoryService.update(exp);
            if (res.status === 200) {
                success = yield this.reschedule(exportId);
            }
            else {
                this.alertService.addServerFailure({ data, res });
            }
            return success;
        });
    }
    reschedule(exportId) {
        return __awaiter(this, void 0, void 0, function* () {
            const options = {
                method: 'PUT',
                headers: this.headers
            };
            const rescheduling = yield this.client.fetch(`${this.microserviceUrl}/schedule/${exportId}`, options);
            return rescheduling.status === 200;
        });
    }
    deleteSchedule(schedule, exportId) {
        return __awaiter(this, void 0, void 0, function* () {
            return yield this.updateSchedules(exportId, [schedule], []);
        });
    }
    /**
     * Removes report configuration.
     *
     * Note: fallback strategy is based on error code returned by backend
     * in case of missing subscription for report-agent microservice.
     * @param config entity of report configuration
     * @returns Response wrapped in [[IFetchResponse]]
     */
    removeConfiguration(config) {
        return __awaiter(this, void 0, void 0, function* () {
            let res;
            if (!this.isReportAgentSubscribed) {
                res = yield this.fallbackConfigurationRemoval(config);
            }
            else {
                res = yield this.normalConfigurationRemoval(config);
                if (res.status === 404) {
                    const data = yield res.json();
                    if (data && data.error && data.error.toLowerCase() === this.REPORT_AGENT_NOT_SUBSCRIBED_EXPECTED_ERROR_LOWER_CASE) {
                        res = yield this.fallbackConfigurationRemoval(config);
                        this.isReportAgentSubscribed = false;
                    }
                }
            }
            return res;
        });
    }
    normalConfigurationRemoval(config) {
        return __awaiter(this, void 0, void 0, function* () {
            const url = `${this.microserviceUrl}/config/${config.id}`;
            return yield this.client.fetch(url, { method: 'DELETE' });
        });
    }
    fallbackConfigurationRemoval(config) {
        return __awaiter(this, void 0, void 0, function* () {
            let res;
            try {
                res = (yield this.inventoryService.delete(config)).res;
            }
            catch (e) {
                // this could be an error related to not existing object or anything else which makes request return error status code
                // in case of concurrent removal everything is fine, therefor warning message. But it might not recover from some errors
                this.alertService.addServerFailure(e, 'warning');
            }
            return res;
        });
    }
}
ReportsService.ɵfac = function ReportsService_Factory(t) { return new (t || ReportsService)(ɵngcc0.ɵɵinject(ɵngcc1.AlertService), ɵngcc0.ɵɵinject(ɵngcc2.InventoryService), ɵngcc0.ɵɵinject(ɵngcc2.FetchClient), ɵngcc0.ɵɵinject(ɵngcc3.TranslateService)); };
ReportsService.ɵprov = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjectable({ token: ReportsService, factory: ReportsService.ɵfac });
ReportsService.ctorParameters = () => [
    { type: AlertService },
    { type: InventoryService },
    { type: FetchClient },
    { type: TranslateService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(ReportsService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.AlertService }, { type: ɵngcc2.InventoryService }, { type: ɵngcc2.FetchClient }, { type: ɵngcc3.TranslateService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3J0cy5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi9yZXBvcnRzL3JlcG9ydHMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsWUFBWSxFQUFXLE1BQU0scUJBQXFCLENBQUM7QUFDNUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUMzRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQTRDLFdBQVcsRUFBaUIsTUFBTSxhQUFhLENBQUM7QUFDckgsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7Ozs7O0FBR3ZELE1BQU0sT0FBTyxjQUFjO0FBQzNCLElBS0UsWUFDVSxZQUEwQixFQUMxQixnQkFBa0MsRUFDbEMsTUFBbUIsRUFDbkIsZ0JBQWtDO0FBQzNDLFFBSlMsaUJBQVksR0FBWixZQUFZLENBQWM7QUFBQyxRQUMzQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO0FBQUMsUUFDbkMsV0FBTSxHQUFOLE1BQU0sQ0FBYTtBQUFDLFFBQ3BCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7QUFDOUMsUUFDSSxJQUFJLENBQUMsZUFBZSxHQUFHLG9CQUFvQixDQUFDO0FBQ2hELFFBQUksSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsRUFBRSxDQUFDO0FBQzFELFFBQUksSUFBSSxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQztBQUN4QyxRQUFJLElBQUksQ0FBQyxxREFBcUQsR0FBRyx3QkFBd0IsQ0FBQztBQUMxRixJQUFFLENBQUM7QUFDSCxJQUNRLFNBQVMsQ0FBQyxRQUFxQjtBQUN2QztBQUN5QyxZQURyQyxJQUFJLEdBQVcsQ0FBQztBQUNwQixZQUFJLE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFD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LEdBQUcsQ0FBQztBQUM3RCxhQUFLO0FBQUMsWUFBQSxPQUFPLENBQUMsRUFBRTtBQUNoQixnQkFBTSxzSEFBc0g7QUFDNUgsZ0JBQU0sd0hBQXdIO0FBQzlILGdCQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBQ3ZELGFBQUs7QUFDTCxZQUFJLE9BQU8sR0FBRyxDQUFDO0FBQ2YsUUFBRSxDQUFDO0FBRUgsS0FGRztBQUNIOzBDQXBJQyxVQUFVO3dIQUNUO0FBQUM7QUFDVSxZQVBKLFlBQVk7QUFBSSxZQUVoQixnQkFBZ0I7QUFBSSxZQUF3QyxXQUFXO0FBQUksWUFDM0UsZ0JBQWdCO0FBQUc7OztpTEFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRXhwb3J0LCBTY2hlZHVsZSB9IGZyb20gJy4vZXhwb3J0LXNjaGVkdWxlcy5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlLCBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBvcmRlckJ5LCBpc0VxdWFsLCByZW1vdmUsIHNvbWUgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgSW52ZW50b3J5U2VydmljZSwgSWRSZWZlcmVuY2UsIElGZXRjaFJlc3BvbnNlLCBJSWRlbnRpZmllZCwgRmV0Y2hDbGllbnQsIElGZXRjaE9wdGlvbnMgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBSZXBvcnRzU2VydmljZSB7XG4gIG1pY3Jvc2VydmljZVVybDogc3RyaW5nO1xuICBoZWFkZXJzOiBhbnk7XG4gIGlzUmVwb3J0QWdlbnRTdWJzY3JpYmVkOiBib29sZWFuO1xuICBSRVBPUlRfQUdFTlRfTk9UX1NVQlNDUklCRURfRVhQRUNURURfRVJST1JfTE9XRVJfQ0FTRTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgY2xpZW50OiBGZXRjaENsaWVudCxcbiAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5taWNyb3NlcnZpY2VVcmwgPSAnL3NlcnZpY2UvcmVwb3J0aW5nJztcbiAgICB0aGlzLmhlYWRlcnMgPSB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfTtcbiAgICB0aGlzLmlzUmVwb3J0QWdlbnRTdWJzY3JpYmVkID0gdHJ1ZTtcbiAgICB0aGlzLlJFUE9SVF9BR0VOVF9OT1RfU1VCU0NSSUJFRF9FWFBFQ1RFRF9FUlJPUl9MT1dFUl9DQVNFID0gJ21pY3Jvc2VydmljZS9ub3QgZm91bmQnO1xuICB9XG5cbiAgYXN5bmMgZ2V0RXhwb3J0KGV4cG9ydElkOiBJZFJlZmVyZW5jZSkge1xuICAgIGxldCBleHA6IEV4cG9ydDtcbiAgICBjb25zdCBleHBvcnREZXRhaWwgPSBhd2FpdCB0aGlzLmludmVudG9yeVNlcnZpY2UuZGV0YWlsKGV4cG9ydElkKTtcbiAgICBjb25zdCB7IGRhdGEsIHJlcyB9ID0gZXhwb3J0RGV0YWlsO1xuICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoeyBkYXRhLCByZXMgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGV4cCA9IGRhdGEgPyAoKGRhdGEgYXMgdW5rbm93bikgYXMgRXhwb3J0KSA6ICh7fSBhcyBFeHBvcnQpO1xuICAgIH1cblxuICAgIHJldHVybiBleHA7XG4gIH1cblxuICBhc3luYyBnZXRTY2hlZHVsZUxpc3QoZXhwb3J0SWQ6IElkUmVmZXJlbmNlKSB7XG4gICAgY29uc3QgZXhwID0gYXdhaXQgdGhpcy5nZXRFeHBvcnQoZXhwb3J0SWQpO1xuXG4gICAgcmV0dXJuIHRoaXMuZXh0cmFjdFNjaGVkdWxlTGlzdEZyb21FeHBvcnQoZXhwKTtcbiAgfVxuXG4gIGV4dHJhY3RTY2hlZHVsZUxpc3RGcm9tRXhwb3J0KGV4cDogRXhwb3J0KSB7XG4gICAgbGV0IHNjaGVkdWxlTGlzdDogU2NoZWR1bGVbXTtcbiAgICBpZiAoZXhwKSB7XG4gICAgICBzY2hlZHVsZUxpc3QgPSBleHAuYzh5X1NjaGVkdWxlQ29uZmlndXJhdGlvbiA/IGV4cC5jOHlfU2NoZWR1bGVDb25maWd1cmF0aW9uIDogW107XG4gICAgfVxuICAgIHJldHVybiBvcmRlckJ5KHNjaGVkdWxlTGlzdCwgWyd0aW1lc3RhbXAnXSwgWydkZXNjJ10pO1xuICB9XG5cbiAgYXN5bmMgYWRkU2NoZWR1bGUoc2NoZWR1bGU6IFNjaGVkdWxlLCBleHBvcnRJZDogSWRSZWZlcmVuY2UpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51cGRhdGVTY2hlZHVsZXMoZXhwb3J0SWQsIFtdLCBbc2NoZWR1bGVdKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVNjaGVkdWxlKG9sZFNjaGVkdWxlOiBTY2hlZHVsZSwgc2NoZWR1bGU6IFNjaGVkdWxlLCBleHBvcnRJZDogSWRSZWZlcmVuY2UpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy51cGRhdGVTY2hlZHVsZXMoZXhwb3J0SWQsIFtvbGRTY2hlZHVsZV0sIFtzY2hlZHVsZV0pO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlU2NoZWR1bGVzKFxuICAgIGV4cG9ydElkOiBJZFJlZmVyZW5jZSxcbiAgICBzY2hlZHVsZXNUb1JlbW92ZTogU2NoZWR1bGVbXSA9IFtdLFxuICAgIHNjaGVkdWxlc1RvQWRkOiBTY2hlZHVsZVtdID0gW11cbiAgKSB7XG4gICAgbGV0IHN1Y2Nlc3M6IGJvb2xlYW4gPSBmYWxzZTtcbiAgICBjb25zdCBleHAgPSBhd2FpdCB0aGlzLmdldEV4cG9ydChleHBvcnRJZCk7XG4gICAgY29uc3Qgc2NoZWR1bGVzID0gdGhpcy5leHRyYWN0U2NoZWR1bGVMaXN0RnJvbUV4cG9ydChleHApO1xuXG4gICAgcmVtb3ZlKHNjaGVkdWxlcywgKHNjaGVkdWxlOiBTY2hlZHVsZSkgPT5cbiAgICAgIHNvbWUoc2NoZWR1bGVzVG9SZW1vdmUsIChzY2hlZHVsZVRvUmVtb3ZlOiBTY2hlZHVsZSkgPT4gaXNFcXVhbChzY2hlZHVsZSwgc2NoZWR1bGVUb1JlbW92ZSkpXG4gICAgKTtcbiAgICBzY2hlZHVsZXMucHVzaC5hcHBseShzY2hlZHVsZXMsIHNjaGVkdWxlc1RvQWRkKTtcbiAgICBleHAuYzh5X1NjaGVkdWxlQ29uZmlndXJhdGlvbiA9IHNjaGVkdWxlcztcbiAgICBjb25zdCB7IGRhdGEsIHJlcyB9ID0gYXdhaXQgdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLnVwZGF0ZShleHApO1xuICAgIGlmIChyZXMuc3RhdHVzID09PSAyMDApIHtcbiAgICAgIHN1Y2Nlc3MgPSBhd2FpdCB0aGlzLnJlc2NoZWR1bGUoZXhwb3J0SWQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKHsgZGF0YSwgcmVzIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBzdWNjZXNzO1xuICB9XG5cbiAgYXN5bmMgcmVzY2hlZHVsZShleHBvcnRJZDogSWRSZWZlcmVuY2UpIHtcbiAgICBjb25zdCBvcHRpb25zOiBJRmV0Y2hPcHRpb25zID0ge1xuICAgICAgbWV0aG9kOiAnUFVUJyxcbiAgICAgIGhlYWRlcnM6IHRoaXMuaGVhZGVyc1xuICAgIH07XG4gICAgY29uc3QgcmVzY2hlZHVsaW5nID0gYXdhaXQgdGhpcy5jbGllbnQuZmV0Y2goYCR7dGhpcy5taWNyb3NlcnZpY2VVcmx9L3NjaGVkdWxlLyR7ZXhwb3J0SWR9YCwgb3B0aW9ucyk7XG4gICAgcmV0dXJuIHJlc2NoZWR1bGluZy5zdGF0dXMgPT09IDIwMDtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNjaGVkdWxlKHNjaGVkdWxlOiBTY2hlZHVsZSwgZXhwb3J0SWQ6IElkUmVmZXJlbmNlKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudXBkYXRlU2NoZWR1bGVzKGV4cG9ydElkLCBbc2NoZWR1bGVdLCBbXSk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyByZXBvcnQgY29uZmlndXJhdGlvbi5cbiAgICpcbiAgICogTm90ZTogZmFsbGJhY2sgc3RyYXRlZ3kgaXMgYmFzZWQgb24gZXJyb3IgY29kZSByZXR1cm5lZCBieSBiYWNrZW5kXG4gICAqIGluIGNhc2Ugb2YgbWlzc2luZyBzdWJzY3JpcHRpb24gZm9yIHJlcG9ydC1hZ2VudCBtaWNyb3NlcnZpY2UuXG4gICAqIEBwYXJhbSBjb25maWcgZW50aXR5IG9mIHJlcG9ydCBjb25maWd1cmF0aW9uXG4gICAqIEByZXR1cm5zIFJlc3BvbnNlIHdyYXBwZWQgaW4gW1tJRmV0Y2hSZXNwb25zZV1dXG4gICAqL1xuICBhc3luYyByZW1vdmVDb25maWd1cmF0aW9uKGNvbmZpZzogSUlkZW50aWZpZWQpOiBQcm9taXNlPElGZXRjaFJlc3BvbnNlPiB7XG4gICAgbGV0IHJlczogSUZldGNoUmVzcG9uc2U7XG4gICAgaWYgKCF0aGlzLmlzUmVwb3J0QWdlbnRTdWJzY3JpYmVkKSB7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLmZhbGxiYWNrQ29uZmlndXJhdGlvblJlbW92YWwoY29uZmlnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVzID0gYXdhaXQgdGhpcy5ub3JtYWxDb25maWd1cmF0aW9uUmVtb3ZhbChjb25maWcpO1xuICAgICAgaWYgKHJlcy5zdGF0dXMgPT09IDQwNCkge1xuICAgICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzLmpzb24oKTtcbiAgICAgICAgaWYgKGRhdGEgJiYgZGF0YS5lcnJvciAmJiBkYXRhLmVycm9yLnRvTG93ZXJDYXNlKCkgPT09IHRoaXMuUkVQT1JUX0FHRU5UX05PVF9TVUJTQ1JJQkVEX0VYUEVDVEVEX0VSUk9SX0xPV0VSX0NBU0UpIHtcbiAgICAgICAgICByZXMgPSBhd2FpdCB0aGlzLmZhbGxiYWNrQ29uZmlndXJhdGlvblJlbW92YWwoY29uZmlnKTtcbiAgICAgICAgICB0aGlzLmlzUmVwb3J0QWdlbnRTdWJzY3JpYmVkID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlcztcbiAgfVxuXG4gIGFzeW5jIG5vcm1hbENvbmZpZ3VyYXRpb25SZW1vdmFsKGNvbmZpZzogSUlkZW50aWZpZWQpOiBQcm9taXNlPElGZXRjaFJlc3BvbnNlPiB7XG4gICAgY29uc3QgdXJsID0gYCR7dGhpcy5taWNyb3NlcnZpY2VVcmx9L2NvbmZpZy8ke2NvbmZpZy5pZH1gO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmNsaWVudC5mZXRjaCh1cmwsIHsgbWV0aG9kOiAnREVMRVRFJyB9KTtcbiAgfVxuXG4gIGFzeW5jIGZhbGxiYWNrQ29uZmlndXJhdGlvblJlbW92YWwoY29uZmlnOiBJSWRlbnRpZmllZCk6IFByb21pc2U8SUZldGNoUmVzcG9uc2U+IHtcbiAgICBsZXQgcmVzO1xuICAgIHRyeSB7XG4gICAgICByZXMgPSAoYXdhaXQgdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmRlbGV0ZShjb25maWcpKS5yZXM7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gdGhpcyBjb3VsZCBiZSBhbiBlcnJvciByZWxhdGVkIHRvIG5vdCBleGlzdGluZyBvYmplY3Qgb3IgYW55dGhpbmcgZWxzZSB3aGljaCBtYWtlcyByZXF1ZXN0IHJldHVybiBlcnJvciBzdGF0dXMgY29kZVxuICAgICAgLy8gaW4gY2FzZSBvZiBjb25jdXJyZW50IHJlbW92YWwgZXZlcnl0aGluZyBpcyBmaW5lLCB0aGVyZWZvciB3YXJuaW5nIG1lc3NhZ2UuIEJ1dCBpdCBtaWdodCBub3QgcmVjb3ZlciBmcm9tIHNvbWUgZXJyb3JzXG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGUsICd3YXJuaW5nJyk7XG4gICAgfVxuICAgIHJldHVybiByZXM7XG4gIH1cbn1cbiJdfQ==