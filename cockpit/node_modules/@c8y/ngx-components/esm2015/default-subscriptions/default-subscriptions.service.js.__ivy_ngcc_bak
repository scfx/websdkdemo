import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { isUndefined, sortBy } from 'lodash-es';
import { debounceTime, take } from 'rxjs/operators';
import { ApplicationType, ApplicationService, TenantService, TenantOptionsService } from '@c8y/client';
import { HumanizeAppNamePipe } from '@c8y/ngx-components';
import { DefaultSubscriptionsContext as DefaultSubscriptionsContextTenant } from './default-subscriptions.model';
export class DefaultSubscriptionsService {
    constructor(applicationService, tenantService, tenantOptionsService, humanizeAppNamePipe) {
        this.applicationService = applicationService;
        this.tenantService = tenantService;
        this.tenantOptionsService = tenantOptionsService;
        this.humanizeAppNamePipe = humanizeAppNamePipe;
    }
    /**
     * Gets the list of applications which can be used in default subscriptions, i.e.:
     * - current tenant's all own applications,
     * - inherited applications, which do not have the same names as current tenant's own apps.
     * The list is sorted alphabetically by humanized app name and contains up to 2000 items.
     * @returns The list of applications, which can be used in default subscriptions.
     */
    getSubscribableTenantApps() {
        return __awaiter(this, void 0, void 0, function* () {
            const currentTenant = (yield this.tenantService.current()).data;
            const allApps = (yield this.applicationService.listByTenant(null, { pageSize: 2000 })).data;
            const ownApps = allApps.filter(app => app.owner.tenant.id === currentTenant.name);
            const inheritedApps = allApps.filter(app => app.owner.tenant.id !== currentTenant.name);
            const filteredApps = [...ownApps];
            inheritedApps.forEach(inheritedApp => {
                if (!filteredApps.some(filteredApp => filteredApp.name === inheritedApp.name)) {
                    filteredApps.push(inheritedApp);
                }
            });
            const filteredAppsWithHumanizedNames = yield Promise.all(filteredApps.map((app) => __awaiter(this, void 0, void 0, function* () {
                const humanizedName = yield this.humanizeAppNamePipe
                    .transform(app.name)
                    .pipe(debounceTime(250), take(1))
                    .toPromise();
                return { app, humanizedName };
            })));
            const sortedAppsWithHumanizedNames = sortBy(filteredAppsWithHumanizedNames, ['humanizedName']);
            const sortedApps = sortedAppsWithHumanizedNames.map(({ app }) => app);
            return sortedApps;
        });
    }
    /**
     * Gets the default subscriptions configuration inherited from parent tenant.
     * @returns The default subscriptions object with settings from parent tenant.
     */
    getDefaultSubscriptionsEvaluatedFromParentTenant() {
        return __awaiter(this, void 0, void 0, function* () {
            return this.getDefaultSubscriptions(DefaultSubscriptionsContextTenant.PARENT_TENANT);
        });
    }
    /**
     * Gets the default subscriptions configuration from the current tenant.
     * @returns The default subscriptions object with settings from the current tenant.
     */
    getDefaultSubscriptionsFromCurrentTenant() {
        return __awaiter(this, void 0, void 0, function* () {
            return this.getDefaultSubscriptions(DefaultSubscriptionsContextTenant.CURRENT_TENANT);
        });
    }
    /**
     * Saves given default subscriptions configuration to the current tenant
     * (either sets, updates, or deletes corresponding tenant options).
     * @param defaultSubscriptions The default subscriptions configuration to be saved.
     */
    saveDefaultSubscriptionsToCurrentTenant(defaultSubscriptions) {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.saveOnCreationSubscriptions(defaultSubscriptions);
            yield this.saveOnUpgradeSubscriptions(defaultSubscriptions);
        });
    }
    /**
     * Gets default subscriptions in the context of current or parent tenant.
     * @param contextTenant Tells whether to use current or parent tenant as context.
     */
    getDefaultSubscriptions(contextTenant) {
        return __awaiter(this, void 0, void 0, function* () {
            let tenantOptionsParams;
            let overridable;
            switch (contextTenant) {
                case DefaultSubscriptionsContextTenant.CURRENT_TENANT:
                    tenantOptionsParams = { evaluate: 'current' };
                    overridable = true;
                    break;
                case DefaultSubscriptionsContextTenant.PARENT_TENANT:
                    tenantOptionsParams = { evaluate: 'inherited' };
                    overridable = false;
                    break;
            }
            const { onCreationApps, onCreationMicroservices, onUpgradeAppsEnabled, onUpgradeApps, onUpgradeMicroservicesEnabled, onUpgradeMicroservices } = yield this.getTenantOptions(tenantOptionsParams);
            const onCreationSubscriptions = this.namesToPartialApps({
                appsNamesStr: onCreationApps,
                microservicesNamesStr: onCreationMicroservices
            });
            const onUpgradeAppsDefault = overridable ? null : onCreationApps;
            const onUpgradeMicroservicesDefault = overridable ? null : onCreationMicroservices;
            const onUpgradeSubscriptions = this.namesToPartialApps({
                appsNamesStr: onUpgradeAppsEnabled ? onUpgradeApps : onUpgradeAppsDefault,
                microservicesNamesStr: onUpgradeMicroservicesEnabled
                    ? onUpgradeMicroservices
                    : onUpgradeMicroservicesDefault
            });
            const defaultSubscriptions = {
                onCreationSubscriptions,
                onUpgradeSubscriptions
            };
            if (overridable) {
                defaultSubscriptions.overrideOnCreationSubscriptions =
                    onCreationApps !== null || onCreationMicroservices !== null;
                defaultSubscriptions.overrideOnUpgradeSubscriptions =
                    onUpgradeAppsEnabled || onUpgradeMicroservicesEnabled;
            }
            return defaultSubscriptions;
        });
    }
    getTenantOptions(params = {}) {
        return __awaiter(this, void 0, void 0, function* () {
            return {
                onCreationApps: yield this.getTenantOption({
                    category: 'configuration',
                    key: 'default.tenant.applications'
                }, null, params),
                onCreationMicroservices: yield this.getTenantOption({
                    category: 'configuration',
                    key: 'default.tenant.microservices'
                }, null, params),
                onUpgradeAppsEnabled: yield this.getTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.applications.enabled'
                }, false, params),
                onUpgradeApps: yield this.getTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.applications'
                }, null, params),
                onUpgradeMicroservicesEnabled: yield this.getTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.microservices.enabled'
                }, false, params),
                onUpgradeMicroservices: yield this.getTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.microservices'
                }, null, params)
            };
        });
    }
    saveOnCreationSubscriptions(defaultSubscriptions) {
        return __awaiter(this, void 0, void 0, function* () {
            if (defaultSubscriptions.overrideOnCreationSubscriptions) {
                yield this.setTenantOption({
                    category: 'configuration',
                    key: 'default.tenant.applications',
                    value: this.partialAppsListToAppsNames(defaultSubscriptions.onCreationSubscriptions)
                });
                yield this.setTenantOption({
                    category: 'configuration',
                    key: 'default.tenant.microservices',
                    value: this.partialAppsToMicroservicesNames(defaultSubscriptions.onCreationSubscriptions)
                });
            }
            else {
                yield this.unsetTenantOption({
                    category: 'configuration',
                    key: 'default.tenant.applications'
                });
                yield this.unsetTenantOption({
                    category: 'configuration',
                    key: 'default.tenant.microservices'
                });
            }
        });
    }
    saveOnUpgradeSubscriptions(defaultSubscriptions) {
        return __awaiter(this, void 0, void 0, function* () {
            if (defaultSubscriptions.overrideOnUpgradeSubscriptions) {
                yield this.setTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.applications.enabled',
                    value: 'true'
                });
                yield this.setTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.microservices.enabled',
                    value: 'true'
                });
                yield this.setTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.applications',
                    value: this.partialAppsListToAppsNames(defaultSubscriptions.onUpgradeSubscriptions)
                });
                yield this.setTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.microservices',
                    value: this.partialAppsToMicroservicesNames(defaultSubscriptions.onUpgradeSubscriptions)
                });
            }
            else {
                yield this.unsetTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.applications.enabled'
                });
                yield this.unsetTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.microservices.enabled'
                });
                yield this.unsetTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.applications'
                });
                yield this.unsetTenantOption({
                    category: 'configuration',
                    key: 'on-update.tenant.microservices'
                });
            }
        });
    }
    getTenantOption(option, defaultValue = null, params = {}) {
        return __awaiter(this, void 0, void 0, function* () {
            let value;
            try {
                value = (yield this.tenantOptionsService.detail(option, params)).data.value;
                value = JSON.parse(value);
            }
            catch (ex) {
                value = !isUndefined(value) ? value : defaultValue;
            }
            return value;
        });
    }
    setTenantOption(option) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.tenantOptionsService.update(option);
        });
    }
    unsetTenantOption(option) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                yield this.tenantOptionsService.delete(option);
            }
            catch (ex) {
                if (!ex || !ex.res || ex.res.status !== 404) {
                    throw ex;
                }
            }
        });
    }
    namesToPartialApps({ appsNamesStr, microservicesNamesStr }) {
        if (appsNamesStr === null && microservicesNamesStr === null) {
            return null;
        }
        return [
            ...(appsNamesStr || '')
                .split(',')
                .filter(name => name.length)
                .map(name => ({ name: name.trim() })),
            ...(microservicesNamesStr || '')
                .split(',')
                .filter(name => name.length)
                .map(name => ({
                name: name.trim(),
                type: ApplicationType.MICROSERVICE
            }))
        ];
    }
    partialAppsListToAppsNames(apps) {
        return apps
            .filter(app => app.type !== ApplicationType.MICROSERVICE)
            .map(app => app.name)
            .join(',');
    }
    partialAppsToMicroservicesNames(apps) {
        return apps
            .filter(app => app.type === ApplicationType.MICROSERVICE)
            .map(app => app.name)
            .join(',');
    }
}
DefaultSubscriptionsService.decorators = [
    { type: Injectable }
];
DefaultSubscriptionsService.ctorParameters = () => [
    { type: ApplicationService },
    { type: TenantService },
    { type: TenantOptionsService },
    { type: HumanizeAppNamePipe }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1zdWJzY3JpcHRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9kZWZhdWx0LXN1YnNjcmlwdGlvbnMvZGVmYXVsdC1zdWJzY3JpcHRpb25zLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDaEQsT0FBTyxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVwRCxPQUFPLEVBRUwsZUFBZSxFQUNmLGtCQUFrQixFQUVsQixhQUFhLEVBQ2Isb0JBQW9CLEVBQ3JCLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRTFELE9BQU8sRUFHTCwyQkFBMkIsSUFBSSxpQ0FBaUMsRUFDakUsTUFBTSwrQkFBK0IsQ0FBQztBQUd2QyxNQUFNLE9BQU8sMkJBQTJCO0lBQ3RDLFlBQ1Usa0JBQXNDLEVBQ3RDLGFBQTRCLEVBQzVCLG9CQUEwQyxFQUMxQyxtQkFBd0M7UUFIeEMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1Qix5QkFBb0IsR0FBcEIsb0JBQW9CLENBQXNCO1FBQzFDLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7SUFDL0MsQ0FBQztJQUVKOzs7Ozs7T0FNRztJQUNHLHlCQUF5Qjs7WUFDN0IsTUFBTSxhQUFhLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUM7WUFFaEUsTUFBTSxPQUFPLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLEVBQUUsUUFB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Q0FBQztnQkFDWixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDakIsSUFBSSxFQUFFLGVBQWUsQ0FBQyxZQUFZO2FBQ25DLENBQUMsQ0FBQztTQUNOLENBQUM7SUFDSixDQUFDO0lBRU8sMEJBQTBCLENBQUMsSUFBcUI7UUFDdEQsT0FBTyxJQUFJO2FBQ1IsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksS0FBSyxlQUFlLENBQUMsWUFBWSxDQUFDO2FBQ3hELEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7YUFDcEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2YsQ0FBQztJQUVPLCtCQUErQixDQUFDLElBQXFCO1FBQzNELE9BQU8sSUFBSTthQUNSLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEtBQUssZUFBZSxDQUFDLFlBQVksQ0FBQzthQUN4RCxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDO2FBQ3BCLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNmLENBQUM7OztZQTVURixVQUFVOzs7WUFiVCxrQkFBa0I7WUFFbEIsYUFBYTtZQUNiLG9CQUFvQjtZQUViLG1CQUFtQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGlzVW5kZWZpbmVkLCBzb3J0QnkgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQge1xuICBJQXBwbGljYXRpb24sXG4gIEFwcGxpY2F0aW9uVHlwZSxcbiAgQXBwbGljYXRpb25TZXJ2aWNlLFxuICBJU3lzdGVtT3B0aW9uLFxuICBUZW5hbnRTZXJ2aWNlLFxuICBUZW5hbnRPcHRpb25zU2VydmljZVxufSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBIdW1hbml6ZUFwcE5hbWVQaXBlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5cbmltcG9ydCB7XG4gIFBhcnRpYWxBcHBzTGlzdCxcbiAgRGVmYXVsdFN1YnNjcmlwdGlvbnMsXG4gIERlZmF1bHRTdWJzY3JpcHRpb25zQ29udGV4dCBhcyBEZWZhdWx0U3Vic2NyaXB0aW9uc0NvbnRleHRUZW5hbnRcbn0gZnJvbSAnLi9kZWZhdWx0LXN1YnNjcmlwdGlvbnMubW9kZWwnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRGVmYXVsdFN1YnNjcmlwdGlvbnNTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhcHBsaWNhdGlvblNlcnZpY2U6IEFwcGxpY2F0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIHRlbmFudFNlcnZpY2U6IFRlbmFudFNlcnZpY2UsXG4gICAgcHJpdmF0ZSB0ZW5hbnRPcHRpb25zU2VydmljZTogVGVuYW50T3B0aW9uc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBodW1hbml6ZUFwcE5hbWVQaXBlOiBIdW1hbml6ZUFwcE5hbWVQaXBlXG4gICkge31cblxuICAvKipcbiAgICogR2V0cyB0aGUgbGlzdCBvZiBhcHBsaWNhdGlvbnMgd2hpY2ggY2FuIGJlIHVzZWQgaW4gZGVmYXVsdCBzdWJzY3JpcHRpb25zLCBpLmUuOlxuICAgKiAtIGN1cnJlbnQgdGVuYW50J3MgYWxsIG93biBhcHBsaWNhdGlvbnMsXG4gICAqIC0gaW5oZXJpdGVkIGFwcGxpY2F0aW9ucywgd2hpY2ggZG8gbm90IGhhdmUgdGhlIHNhbWUgbmFtZXMgYXMgY3VycmVudCB0ZW5hbnQncyBvd24gYXBwcy5cbiAgICogVGhlIGxpc3QgaXMgc29ydGVkIGFscGhhYmV0aWNhbGx5IGJ5IGh1bWFuaXplZCBhcHAgbmFtZSBhbmQgY29udGFpbnMgdXAgdG8gMjAwMCBpdGVtcy5cbiAgICogQHJldHVybnMgVGhlIGxpc3Qgb2YgYXBwbGljYXRpb25zLCB3aGljaCBjYW4gYmUgdXNlZCBpbiBkZWZhdWx0IHN1YnNjcmlwdGlvbnMuXG4gICAqL1xuICBhc3luYyBnZXRTdWJzY3JpYmFibGVUZW5hbnRBcHBzKCk6IFByb21pc2U8SUFwcGxpY2F0aW9uW10+IHtcbiAgICBjb25zdCBjdXJyZW50VGVuYW50ID0gKGF3YWl0IHRoaXMudGVuYW50U2VydmljZS5jdXJyZW50KCkpLmRhdGE7XG5cbiAgICBjb25zdCBhbGxBcHBzID0gKGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmxpc3RCeVRlbmFudChudWxsLCB7IHBhZ2VTaXplOiAyMDAwIH0pKS5kYXRhO1xuICAgIGNvbnN0IG93bkFwcHMgPSBhbGxBcHBzLmZpbHRlcihhcHAgPT4gYXBwLm93bmVyLnRlbmFudC5pZCA9PT0gY3VycmVudFRlbmFudC5uYW1lKTtcbiAgICBjb25zdCBpbmhlcml0ZWRBcHBzID0gYWxsQXBwcy5maWx0ZXIoYXBwID0+IGFwcC5vd25lci50ZW5hbnQuaWQgIT09IGN1cnJlbnRUZW5hbnQubmFtZSk7XG5cbiAgICBjb25zdCBmaWx0ZXJlZEFwcHM6IElBcHBsaWNhdGlvbltdID0gWy4uLm93bkFwcHNdO1xuICAgIGluaGVyaXRlZEFwcHMuZm9yRWFjaChpbmhlcml0ZWRBcHAgPT4ge1xuICAgICAgaWYgKCFmaWx0ZXJlZEFwcHMuc29tZShmaWx0ZXJlZEFwcCA9PiBmaWx0ZXJlZEFwcC5uYW1lID09PSBpbmhlcml0ZWRBcHAubmFtZSkpIHtcbiAgICAgICAgZmlsdGVyZWRBcHBzLnB1c2goaW5oZXJpdGVkQXBwKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGNvbnN0IGZpbHRlcmVkQXBwc1dpdGhIdW1hbml6ZWROYW1lcyA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgZmlsdGVyZWRBcHBzLm1hcChhc3luYyBhcHAgPT4ge1xuICAgICAgICBjb25zdCBodW1hbml6ZWROYW1lID0gYXdhaXQgdGhpcy5odW1hbml6ZUFwcE5hbWVQaXBlXG4gICAgICAgICAgLnRyYW5zZm9ybShhcHAubmFtZSlcbiAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgIGRlYm91bmNlVGltZSgyNTApLFxuICAgICAgICAgICAgdGFrZSgxKVxuICAgICAgICAgIClcbiAgICAgICAgICAudG9Qcm9taXNlKCk7XG4gICAgICAgIHJldHVybiB7IGFwcCwgaHVtYW5pemVkTmFtZSB9O1xuICAgICAgfSlcbiAgICApO1xuICAgIGNvbnN0IHNvcnRlZEFwcHNXaXRoSHVtYW5pemVkTmFtZXMgPSBzb3J0QnkoZmlsdGVyZWRBcHBzV2l0aEh1bWFuaXplZE5hbWVzLCBbJ2h1bWFuaXplZE5hbWUnXSk7XG4gICAgY29uc3Qgc29ydGVkQXBwcyA9IHNvcnRlZEFwcHNXaXRoSHVtYW5pemVkTmFtZXMubWFwKCh7IGFwcCB9KSA9PiBhcHApO1xuXG4gICAgcmV0dXJuIHNvcnRlZEFwcHM7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyB0aGUgZGVmYXVsdCBzdWJzY3JpcHRpb25zIGNvbmZpZ3VyYXRpb24gaW5oZXJpdGVkIGZyb20gcGFyZW50IHRlbmFudC5cbiAgICogQHJldHVybnMgVGhlIGRlZmF1bHQgc3Vic2NyaXB0aW9ucyBvYmplY3Qgd2l0aCBzZXR0aW5ncyBmcm9tIHBhcmVudCB0ZW5hbnQuXG4gICAqL1xuICBhc3luYyBnZXREZWZhdWx0U3Vic2NyaXB0aW9uc0V2YWx1YXRlZEZyb21QYXJlbnRUZW5hbnQoKTogUHJvbWlzZTxEZWZhdWx0U3Vic2NyaXB0aW9ucz4ge1xuICAgIHJldHVybiB0aGlzLmdldERlZmF1bHRTdWJzY3JpcHRpb25zKERlZmF1bHRTdWJzY3JpcHRpb25zQ29udGV4dFRlbmFudC5QQVJFTlRfVEVOQU5UKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBkZWZhdWx0IHN1YnNjcmlwdGlvbnMgY29uZmlndXJhdGlvbiBmcm9tIHRoZSBjdXJyZW50IHRlbmFudC5cbiAgICogQHJldHVybnMgVGhlIGRlZmF1bHQgc3Vic2NyaXB0aW9ucyBvYmplY3Qgd2l0aCBzZXR0aW5ncyBmcm9tIHRoZSBjdXJyZW50IHRlbmFudC5cbiAgICovXG4gIGFzeW5jIGdldERlZmF1bHRTdWJzY3JpcHRpb25zRnJvbUN1cnJlbnRUZW5hbnQoKTogUHJvbWlzZTxEZWZhdWx0U3Vic2NyaXB0aW9ucz4ge1xuICAgIHJldHVybiB0aGlzLmdldERlZmF1bHRTdWJzY3JpcHRpb25zKERlZmF1bHRTdWJzY3JpcHRpb25zQ29udGV4dFRlbmFudC5DVVJSRU5UX1RFTkFOVCk7XG4gIH1cblxuICAvKipcbiAgICogU2F2ZXMgZ2l2ZW4gZGVmYXVsdCBzdWJzY3JpcHRpb25zIGNvbmZpZ3VyYXRpb24gdG8gdGhlIGN1cnJlbnQgdGVuYW50XG4gICAqIChlaXRoZXIgc2V0cywgdXBkYXRlcywgb3IgZGVsZXRlcyBjb3JyZXNwb25kaW5nIHRlbmFudCBvcHRpb25zKS5cbiAgICogQHBhcmFtIGRlZmF1bHRTdWJzY3JpcHRpb25zIFRoZSBkZWZhdWx0IHN1YnNjcmlwdGlvbnMgY29uZmlndXJhdGlvbiB0byBiZSBzYXZlZC5cbiAgICovXG4gIGFzeW5jIHNhdmVEZWZhdWx0U3Vic2NyaXB0aW9uc1RvQ3VycmVudFRlbmFudChkZWZhdWx0U3Vic2NyaXB0aW9uczogRGVmYXVsdFN1YnNjcmlwdGlvbnMpIHtcbiAgICBhd2FpdCB0aGlzLnNhdmVPbkNyZWF0aW9uU3Vic2NyaXB0aW9ucyhkZWZhdWx0U3Vic2NyaXB0aW9ucyk7XG4gICAgYXdhaXQgdGhpcy5zYXZlT25VcGdyYWRlU3Vic2NyaXB0aW9ucyhkZWZhdWx0U3Vic2NyaXB0aW9ucyk7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBkZWZhdWx0IHN1YnNjcmlwdGlvbnMgaW4gdGhlIGNvbnRleHQgb2YgY3VycmVudCBvciBwYXJlbnQgdGVuYW50LlxuICAgKiBAcGFyYW0gY29udGV4dFRlbmFudCBUZWxscyB3aGV0aGVyIHRvIHVzZSBjdXJyZW50IG9yIHBhcmVudCB0ZW5hbnQgYXMgY29udGV4dC5cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbnMoXG4gICAgY29udGV4dFRlbmFudDogRGVmYXVsdFN1YnNjcmlwdGlvbnNDb250ZXh0VGVuYW50XG4gICk6IFByb21pc2U8RGVmYXVsdFN1YnNjcmlwdGlvbnM+IHtcbiAgICBsZXQgdGVuYW50T3B0aW9uc1BhcmFtczogb2JqZWN0O1xuICAgIGxldCBvdmVycmlkYWJsZTogYm9vbGVhbjtcblxuICAgIHN3aXRjaCAoY29udGV4dFRlbmFudCkge1xuICAgICAgY2FzZSBEZWZhdWx0U3Vic2NyaXB0aW9uc0NvbnRleHRUZW5hbnQuQ1VSUkVOVF9URU5BTlQ6XG4gICAgICAgIHRlbmFudE9wdGlvbnNQYXJhbXMgPSB7IGV2YWx1YXRlOiAnY3VycmVudCcgfTtcbiAgICAgICAgb3ZlcnJpZGFibGUgPSB0cnVlO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBEZWZhdWx0U3Vic2NyaXB0aW9uc0NvbnRleHRUZW5hbnQuUEFSRU5UX1RFTkFOVDpcbiAgICAgICAgdGVuYW50T3B0aW9uc1BhcmFtcyA9IHsgZXZhbHVhdGU6ICdpbmhlcml0ZWQnIH07XG4gICAgICAgIG92ZXJyaWRhYmxlID0gZmFsc2U7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cblxuICAgIGNvbnN0IHtcbiAgICAgIG9uQ3JlYXRpb25BcHBzLFxuICAgICAgb25DcmVhdGlvbk1pY3Jvc2VydmljZXMsXG4gICAgICBvblVwZ3JhZGVBcHBzRW5hYmxlZCxcbiAgICAgIG9uVXBncmFkZUFwcHMsXG4gICAgICBvblVwZ3JhZGVNaWNyb3NlcnZpY2VzRW5hYmxlZCxcbiAgICAgIG9uVXBncmFkZU1pY3Jvc2VydmljZXNcbiAgICB9ID0gYXdhaXQgdGhpcy5nZXRUZW5hbnRPcHRpb25zKHRlbmFudE9wdGlvbnNQYXJhbXMpO1xuXG4gICAgY29uc3Qgb25DcmVhdGlvblN1YnNjcmlwdGlvbnMgPSB0aGlzLm5hbWVzVG9QYXJ0aWFsQXBwcyh7XG4gICAgICBhcHBzTmFtZXNTdHI6IG9uQ3JlYXRpb25BcHBzLFxuICAgICAgbWljcm9zZXJ2aWNlc05hbWVzU3RyOiBvbkNyZWF0aW9uTWljcm9zZXJ2aWNlc1xuICAgIH0pO1xuXG4gICAgY29uc3Qgb25VcGdyYWRlQXBwc0RlZmF1bHQgPSBvdmVycmlkYWJsZSA/IG51bGwgOiBvbkNyZWF0aW9uQXBwcztcbiAgICBjb25zdCBvblVwZ3JhZGVNaWNyb3NlcnZpY2VzRGVmYXVsdCA9IG92ZXJyaWRhYmxlID8gbnVsbCA6IG9uQ3JlYXRpb25NaWNyb3NlcnZpY2VzO1xuICAgIGNvbnN0IG9uVXBncmFkZVN1YnNjcmlwdGlvbnMgPSB0aGlzLm5hbWVzVG9QYXJ0aWFsQXBwcyh7XG4gICAgICBhcHBzTmFtZXNTdHI6IG9uVXBncmFkZUFwcHNFbmFibGVkID8gb25VcGdyYWRlQXBwcyA6IG9uVXBncmFkZUFwcHNEZWZhdWx0LFxuICAgICAgbWljcm9zZXJ2aWNlc05hbWVzU3RyOiBvblVwZ3JhZGVNaWNyb3NlcnZpY2VzRW5hYmxlZFxuICAgICAgICA/IG9uVXBncmFkZU1pY3Jvc2VydmljZXNcbiAgICAgICAgOiBvblVwZ3JhZGVNaWNyb3NlcnZpY2VzRGVmYXVsdFxuICAgIH0pO1xuXG4gICAgY29uc3QgZGVmYXVsdFN1YnNjcmlwdGlvbnM6IERlZmF1bHRTdWJzY3JpcHRpb25zID0ge1xuICAgICAgb25DcmVhdGlvblN1YnNjcmlwdGlvbnMsXG4gICAgICBvblVwZ3JhZGVTdWJzY3JpcHRpb25zXG4gICAgfTtcblxuICAgIGlmIChvdmVycmlkYWJsZSkge1xuICAgICAgZGVmYXVsdFN1YnNjcmlwdGlvbnMub3ZlcnJpZGVPbkNyZWF0aW9uU3Vic2NyaXB0aW9ucyA9XG4gICAgICAgIG9uQ3JlYXRpb25BcHBzICE9PSBudWxsIHx8IG9uQ3JlYXRpb25NaWNyb3NlcnZpY2VzICE9PSBudWxsO1xuICAgICAgZGVmYXVsdFN1YnNjcmlwdGlvbnMub3ZlcnJpZGVPblVwZ3JhZGVTdWJzY3JpcHRpb25zID1cbiAgICAgICAgb25VcGdyYWRlQXBwc0VuYWJsZWQgfHwgb25VcGdyYWRlTWljcm9zZXJ2aWNlc0VuYWJsZWQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlZmF1bHRTdWJzY3JpcHRpb25zO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRUZW5hbnRPcHRpb25zKHBhcmFtcyA9IHt9KSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG9uQ3JlYXRpb25BcHBzOiBhd2FpdCB0aGlzLmdldFRlbmFudE9wdGlvbihcbiAgICAgICAge1xuICAgICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgICAga2V5OiAnZGVmYXVsdC50ZW5hbnQuYXBwbGljYXRpb25zJ1xuICAgICAgICB9LFxuICAgICAgICBudWxsLFxuICAgICAgICBwYXJhbXNcbiAgICAgICksXG4gICAgICBvbkNyZWF0aW9uTWljcm9zZXJ2aWNlczogYXdhaXQgdGhpcy5nZXRUZW5hbnRPcHRpb24oXG4gICAgICAgIHtcbiAgICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICAgIGtleTogJ2RlZmF1bHQudGVuYW50Lm1pY3Jvc2VydmljZXMnXG4gICAgICAgIH0sXG4gICAgICAgIG51bGwsXG4gICAgICAgIHBhcmFtc1xuICAgICAgKSxcbiAgICAgIG9uVXBncmFkZUFwcHNFbmFibGVkOiBhd2FpdCB0aGlzLmdldFRlbmFudE9wdGlvbihcbiAgICAgICAge1xuICAgICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5hcHBsaWNhdGlvbnMuZW5hYmxlZCdcbiAgICAgICAgfSxcbiAgICAgICAgZmFsc2UsXG4gICAgICAgIHBhcmFtc1xuICAgICAgKSxcbiAgICAgIG9uVXBncmFkZUFwcHM6IGF3YWl0IHRoaXMuZ2V0VGVuYW50T3B0aW9uKFxuICAgICAgICB7XG4gICAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAgICBrZXk6ICdvbi11cGRhdGUudGVuYW50LmFwcGxpY2F0aW9ucydcbiAgICAgICAgfSxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgcGFyYW1zXG4gICAgICApLFxuICAgICAgb25VcGdyYWRlTWljcm9zZXJ2aWNlc0VuYWJsZWQ6IGF3YWl0IHRoaXMuZ2V0VGVuYW50T3B0aW9uKFxuICAgICAgICB7XG4gICAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAgICBrZXk6ICdvbi11cGRhdGUudGVuYW50Lm1pY3Jvc2VydmljZXMuZW5hYmxlZCdcbiAgICAgICAgfSxcbiAgICAgICAgZmFsc2UsXG4gICAgICAgIHBhcmFtc1xuICAgICAgKSxcbiAgICAgIG9uVXBncmFkZU1pY3Jvc2VydmljZXM6IGF3YWl0IHRoaXMuZ2V0VGVuYW50T3B0aW9uKFxuICAgICAgICB7XG4gICAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAgICBrZXk6ICdvbi11cGRhdGUudGVuYW50Lm1pY3Jvc2VydmljZXMnXG4gICAgICAgIH0sXG4gICAgICAgIG51bGwsXG4gICAgICAgIHBhcmFtc1xuICAgICAgKVxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNhdmVPbkNyZWF0aW9uU3Vic2NyaXB0aW9ucyhkZWZhdWx0U3Vic2NyaXB0aW9uczogRGVmYXVsdFN1YnNjcmlwdGlvbnMpIHtcbiAgICBpZiAoZGVmYXVsdFN1YnNjcmlwdGlvbnMub3ZlcnJpZGVPbkNyZWF0aW9uU3Vic2NyaXB0aW9ucykge1xuICAgICAgYXdhaXQgdGhpcy5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdkZWZhdWx0LnRlbmFudC5hcHBsaWNhdGlvbnMnLFxuICAgICAgICB2YWx1ZTogdGhpcy5wYXJ0aWFsQXBwc0xpc3RUb0FwcHNOYW1lcyhkZWZhdWx0U3Vic2NyaXB0aW9ucy5vbkNyZWF0aW9uU3Vic2NyaXB0aW9ucylcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgdGhpcy5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdkZWZhdWx0LnRlbmFudC5taWNyb3NlcnZpY2VzJyxcbiAgICAgICAgdmFsdWU6IHRoaXMucGFydGlhbEFwcHNUb01pY3Jvc2VydmljZXNOYW1lcyhkZWZhdWx0U3Vic2NyaXB0aW9ucy5vbkNyZWF0aW9uU3Vic2NyaXB0aW9ucylcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICBhd2FpdCB0aGlzLnVuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnZGVmYXVsdC50ZW5hbnQuYXBwbGljYXRpb25zJ1xuICAgICAgfSk7XG4gICAgICBhd2FpdCB0aGlzLnVuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnZGVmYXVsdC50ZW5hbnQubWljcm9zZXJ2aWNlcydcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2F2ZU9uVXBncmFkZVN1YnNjcmlwdGlvbnMoZGVmYXVsdFN1YnNjcmlwdGlvbnM6IERlZmF1bHRTdWJzY3JpcHRpb25zKSB7XG4gICAgaWYgKGRlZmF1bHRTdWJzY3JpcHRpb25zLm92ZXJyaWRlT25VcGdyYWRlU3Vic2NyaXB0aW9ucykge1xuICAgICAgYXdhaXQgdGhpcy5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdvbi11cGRhdGUudGVuYW50LmFwcGxpY2F0aW9ucy5lbmFibGVkJyxcbiAgICAgICAgdmFsdWU6ICd0cnVlJ1xuICAgICAgfSk7XG4gICAgICBhd2FpdCB0aGlzLnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQubWljcm9zZXJ2aWNlcy5lbmFibGVkJyxcbiAgICAgICAgdmFsdWU6ICd0cnVlJ1xuICAgICAgfSk7XG4gICAgICBhd2FpdCB0aGlzLnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQuYXBwbGljYXRpb25zJyxcbiAgICAgICAgdmFsdWU6IHRoaXMucGFydGlhbEFwcHNMaXN0VG9BcHBzTmFtZXMoZGVmYXVsdFN1YnNjcmlwdGlvbnMub25VcGdyYWRlU3Vic2NyaXB0aW9ucylcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgdGhpcy5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdvbi11cGRhdGUudGVuYW50Lm1pY3Jvc2VydmljZXMnLFxuICAgICAgICB2YWx1ZTogdGhpcy5wYXJ0aWFsQXBwc1RvTWljcm9zZXJ2aWNlc05hbWVzKGRlZmF1bHRTdWJzY3JpcHRpb25zLm9uVXBncmFkZVN1YnNjcmlwdGlvbnMpXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy51bnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQuYXBwbGljYXRpb25zLmVuYWJsZWQnXG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHRoaXMudW5zZXRUZW5hbnRPcHRpb24oe1xuICAgICAgICBjYXRlZ29yeTogJ2NvbmZpZ3VyYXRpb24nLFxuICAgICAgICBrZXk6ICdvbi11cGRhdGUudGVuYW50Lm1pY3Jvc2VydmljZXMuZW5hYmxlZCdcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgdGhpcy51bnNldFRlbmFudE9wdGlvbih7XG4gICAgICAgIGNhdGVnb3J5OiAnY29uZmlndXJhdGlvbicsXG4gICAgICAgIGtleTogJ29uLXVwZGF0ZS50ZW5hbnQuYXBwbGljYXRpb25zJ1xuICAgICAgfSk7XG4gICAgICBhd2FpdCB0aGlzLnVuc2V0VGVuYW50T3B0aW9uKHtcbiAgICAgICAgY2F0ZWdvcnk6ICdjb25maWd1cmF0aW9uJyxcbiAgICAgICAga2V5OiAnb24tdXBkYXRlLnRlbmFudC5taWNyb3NlcnZpY2VzJ1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRUZW5hbnRPcHRpb24ob3B0aW9uOiBJU3lzdGVtT3B0aW9uLCBkZWZhdWx0VmFsdWUgPSBudWxsLCBwYXJhbXMgPSB7fSkge1xuICAgIGxldCB2YWx1ZTtcbiAgICB0cnkge1xuICAgICAgdmFsdWUgPSAoYXdhaXQgdGhpcy50ZW5hbnRPcHRpb25zU2VydmljZS5kZXRhaWwob3B0aW9uLCBwYXJhbXMpKS5kYXRhLnZhbHVlO1xuICAgICAgdmFsdWUgPSBKU09OLnBhcnNlKHZhbHVlKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdmFsdWUgPSAhaXNVbmRlZmluZWQodmFsdWUpID8gdmFsdWUgOiBkZWZhdWx0VmFsdWU7XG4gICAgfVxuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2V0VGVuYW50T3B0aW9uKG9wdGlvbjogSVN5c3RlbU9wdGlvbikge1xuICAgIHJldHVybiB0aGlzLnRlbmFudE9wdGlvbnNTZXJ2aWNlLnVwZGF0ZShvcHRpb24pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB1bnNldFRlbmFudE9wdGlvbihvcHRpb246IElTeXN0ZW1PcHRpb24pIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy50ZW5hbnRPcHRpb25zU2VydmljZS5kZWxldGUob3B0aW9uKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgaWYgKCFleCB8fCAhZXgucmVzIHx8IGV4LnJlcy5zdGF0dXMgIT09IDQwNCkge1xuICAgICAgICB0aHJvdyBleDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG5hbWVzVG9QYXJ0aWFsQXBwcyh7XG4gICAgYXBwc05hbWVzU3RyLFxuICAgIG1pY3Jvc2VydmljZXNOYW1lc1N0clxuICB9OiB7XG4gICAgYXBwc05hbWVzU3RyPzogc3RyaW5nO1xuICAgIG1pY3Jvc2VydmljZXNOYW1lc1N0cj86IHN0cmluZztcbiAgfSk6IFBhcnRpYWxBcHBzTGlzdCB7XG4gICAgaWYgKGFwcHNOYW1lc1N0ciA9PT0gbnVsbCAmJiBtaWNyb3NlcnZpY2VzTmFtZXNTdHIgPT09IG51bGwpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiBbXG4gICAgICAuLi4oYXBwc05hbWVzU3RyIHx8ICcnKVxuICAgICAgICAuc3BsaXQoJywnKVxuICAgICAgICAuZmlsdGVyKG5hbWUgPT4gbmFtZS5sZW5ndGgpXG4gICAgICAgIC5tYXAobmFtZSA9PiAoeyBuYW1lOiBuYW1lLnRyaW0oKSB9KSksXG4gICAgICAuLi4obWljcm9zZXJ2aWNlc05hbWVzU3RyIHx8ICcnKVxuICAgICAgICAuc3BsaXQoJywnKVxuICAgICAgICAuZmlsdGVyKG5hbWUgPT4gbmFtZS5sZW5ndGgpXG4gICAgICAgIC5tYXAobmFtZSA9PiAoe1xuICAgICAgICAgIG5hbWU6IG5hbWUudHJpbSgpLFxuICAgICAgICAgIHR5cGU6IEFwcGxpY2F0aW9uVHlwZS5NSUNST1NFUlZJQ0VcbiAgICAgICAgfSkpXG4gICAgXTtcbiAgfVxuXG4gIHByaXZhdGUgcGFydGlhbEFwcHNMaXN0VG9BcHBzTmFtZXMoYXBwczogUGFydGlhbEFwcHNMaXN0KTogc3RyaW5nIHtcbiAgICByZXR1cm4gYXBwc1xuICAgICAgLmZpbHRlcihhcHAgPT4gYXBwLnR5cGUgIT09IEFwcGxpY2F0aW9uVHlwZS5NSUNST1NFUlZJQ0UpXG4gICAgICAubWFwKGFwcCA9PiBhcHAubmFtZSlcbiAgICAgIC5qb2luKCcsJyk7XG4gIH1cblxuICBwcml2YXRlIHBhcnRpYWxBcHBzVG9NaWNyb3NlcnZpY2VzTmFtZXMoYXBwczogUGFydGlhbEFwcHNMaXN0KTogc3RyaW5nIHtcbiAgICByZXR1cm4gYXBwc1xuICAgICAgLmZpbHRlcihhcHAgPT4gYXBwLnR5cGUgPT09IEFwcGxpY2F0aW9uVHlwZS5NSUNST1NFUlZJQ0UpXG4gICAgICAubWFwKGFwcCA9PiBhcHAubmFtZSlcbiAgICAgIC5qb2luKCcsJyk7XG4gIH1cbn1cbiJdfQ==