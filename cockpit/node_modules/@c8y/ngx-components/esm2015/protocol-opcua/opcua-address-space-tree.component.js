import { __awaiter } from "tslib";
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { AddressSpaceService } from './address-space.service';
import { OpcuaService } from './opcuaService';
import { AlertService } from '@c8y/ngx-components';
import { DynamicDataSource } from './dynamic-data-source';
import { NestedTreeControl } from '@angular/cdk/tree';
import { clone } from 'lodash';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './address-space.service';
import * as ɵngcc2 from './opcuaService';
import * as ɵngcc3 from '@c8y/ngx-components';
import * as ɵngcc4 from '@angular/common';
import * as ɵngcc5 from '@angular/cdk/tree';

const _c0 = function (a0) { return { strong: a0 }; };
function OpcuaAddressSpaceTreeComponent_div_0_cdk_nested_tree_node_2_Template(rf, ctx) { if (rf & 1) {
    const _r7 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "cdk-nested-tree-node", 7);
    ɵngcc0.ɵɵlistener("click", function OpcuaAddressSpaceTreeComponent_div_0_cdk_nested_tree_node_2_Template_cdk_nested_tree_node_click_0_listener() { const restoredCtx = ɵngcc0.ɵɵrestoreView(_r7); const node_r5 = restoredCtx.$implicit; const ctx_r6 = ɵngcc0.ɵɵnextContext(2); return ctx_r6.toggleFocusedNode(node_r5); });
    ɵngcc0.ɵɵelementStart(1, "span");
    ɵngcc0.ɵɵelement(2, "i", 8);
    ɵngcc0.ɵɵtext(3);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const node_r5 = ctx.$implicit;
    const ctx_r3 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction1(4, _c0, ctx_r3.isFocusedNode(node_r5)));
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("c8yIcon", ctx_r3.getIcon(node_r5.nodeClassName))("ngClass", ɵngcc0.ɵɵpureFunction1(6, _c0, ctx_r3.isFocusedNode(node_r5)));
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate1(" ", node_r5.displayName, " ");
} }
const _c1 = function (a0, a1) { return { "dlt-c8y-icon-plus-square": a0, "dlt-c8y-icon-minus-square": a1 }; };
function OpcuaAddressSpaceTreeComponent_div_0_cdk_nested_tree_node_3_Template(rf, ctx) { if (rf & 1) {
    const _r10 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "cdk-nested-tree-node");
    ɵngcc0.ɵɵelementStart(1, "div", 9);
    ɵngcc0.ɵɵelementStart(2, "button", 10);
    ɵngcc0.ɵɵelement(3, "i", 11);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelement(4, "i", 12);
    ɵngcc0.ɵɵelementStart(5, "span", 7);
    ɵngcc0.ɵɵlistener("click", function OpcuaAddressSpaceTreeComponent_div_0_cdk_nested_tree_node_3_Template_span_click_5_listener() { const restoredCtx = ɵngcc0.ɵɵrestoreView(_r10); const node_r8 = restoredCtx.$implicit; const ctx_r9 = ɵngcc0.ɵɵnextContext(2); return ctx_r9.toggleFocusedNode(node_r8); });
    ɵngcc0.ɵɵtext(6);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(7, "span", 13);
    ɵngcc0.ɵɵelement(8, "i", 14);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementContainer(9, 15);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const node_r8 = ctx.$implicit;
    const ctx_r4 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("disabled", node_r8.currentlyLoadingChildren);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction2(7, _c1, !node_r8.expanded, node_r8.expanded));
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("c8yIcon", ctx_r4.getIcon(node_r8.nodeClassName));
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction1(10, _c0, ctx_r4.isFocusedNode(node_r8)));
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate1(" ", node_r8.displayName, " ");
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵstyleProp("visibility", node_r8.currentlyLoadingChildren ? "visible" : "hidden");
} }
function OpcuaAddressSpaceTreeComponent_div_0_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 3);
    ɵngcc0.ɵɵelementStart(1, "cdk-tree", 4);
    ɵngcc0.ɵɵtemplate(2, OpcuaAddressSpaceTreeComponent_div_0_cdk_nested_tree_node_2_Template, 4, 8, "cdk-nested-tree-node", 5);
    ɵngcc0.ɵɵtemplate(3, OpcuaAddressSpaceTreeComponent_div_0_cdk_nested_tree_node_3_Template, 10, 12, "cdk-nested-tree-node", 6);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("dataSource", ctx_r0.dataSource)("treeControl", ctx_r0.nestedTreeControl);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("cdkTreeNodeDefWhen", ctx_r0.hasChild);
} }
function OpcuaAddressSpaceTreeComponent_div_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 16);
    ɵngcc0.ɵɵelementStart(1, "div", 17);
    ɵngcc0.ɵɵelement(2, "div", 18);
    ɵngcc0.ɵɵelement(3, "div", 19);
    ɵngcc0.ɵɵelement(4, "div", 20);
    ɵngcc0.ɵɵelement(5, "div", 21);
    ɵngcc0.ɵɵelement(6, "div", 22);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} }
function OpcuaAddressSpaceTreeComponent_div_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 23);
    ɵngcc0.ɵɵtext(1, " No source data available to fetch address space.\n");
    ɵngcc0.ɵɵelementEnd();
} }
export class OpcuaAddressSpaceTreeComponent {
    constructor(addressSpaceService, opcuaService, alertService) {
        this.addressSpaceService = addressSpaceService;
        this.opcuaService = opcuaService;
        this.alertService = alertService;
        this.focusEmitter = new EventEmitter();
        this.selectedNode = new EventEmitter();
        this.dataSource = null;
        this.loading = false;
        this.destroy$ = new Subject();
        this.getChildren = (node) => (node.expanded ? node.children : []);
        this.hasChild = (_, _nodeData) => this.addressSpaceService.childrenAvailable(_nodeData.references);
    }
    set moId(id) {
        this._moId = id || undefined;
    }
    ngOnInit() {
        this.initializeDataSet();
    }
    ngOnChanges(changes) {
        if (changes.moId && changes.moId.previousValue && (changes.moId.currentValue !== changes.moId.previousValue)) {
            this.initializeDataSet();
        }
    }
    initializeDataSet() {
        this.nodeNavDataSubscription = this.addressSpaceService
            .getNodeNavData$()
            .pipe(takeUntil(this.destroy$))
            .subscribe(nodeNavData => this.openNode(nodeNavData));
        this.subscriptionRef = this.focusEmitter.subscribe(node => {
            this.focused = this.isFocusedNode(node) ? undefined : node;
        });
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
        // clean up the address-space-tree
        this.addressSpaceService.resetTreeToRootNode();
        if (this.nodeNavDataSubscription && !this.nodeNavDataSubscription.closed) {
            this.nodeNavDataSubscription.unsubscribe();
        }
        if (this.subscriptionRef && !this.subscriptionRef.closed) {
            this.subscriptionRef.unsubscribe();
        }
    }
    openNode(nodeNavData) {
        return __awaiter(this, void 0, void 0, function* () {
            const { node, selectedAncestorIds } = nodeNavData;
            let nodeId;
            // We just set the nodeId when the selectedAncestorIds variable an empty array.
            // If selectedAncestorIds contain any id we assume that the tree should be travsersed beginning
            // from the root node.
            if (node && node.nodeId && selectedAncestorIds && selectedAncestorIds.length === 0) {
                nodeId = node.nodeId;
            }
            // Always recreate the tree when routing to a specific nested node,
            // because previous modifications to the tree-structure could cause errors
            // while traversing with 'old' tree-data
            // -----------------
            // setupTree is able to handle nodeId = undefined
            yield this.setupTree(nodeId);
            if (!selectedAncestorIds || selectedAncestorIds.length === 0) {
                return;
            }
            if (nodeNavData && this.dataSource) {
                const clonedAncestors = clone(selectedAncestorIds);
                clonedAncestors.shift();
                const n = yield this.dataSource.toggleNode(this.dataSource.data[0], true);
                this.setChildNodes(n.children, clonedAncestors);
                this.toggleFocusedNode(node);
            }
        });
    }
    setChildNodes(nodes, ids) {
        if (nodes) {
            ids.forEach((id) => __awaiter(this, void 0, void 0, function* () {
                const match = nodes.find(n => n.nodeId === id);
                if (match && ids.length > 0) {
                    const idx = ids.findIndex(value => value === id);
                    if (idx >= 0) {
                        ids.splice(idx, 1);
                    }
                    const toggledNode = yield this.dataSource.toggleNode(match, true);
                    this.setChildNodes(toggledNode.children, ids);
                }
            }));
        }
    }
    setupTree(nodeId) {
        return __awaiter(this, void 0, void 0, function* () {
            this.loading = true;
            if (!this._moId || this._moId.length === 0) {
                this._moId = this.opcuaService.getMoId();
            }
            // addressSpaceService.getNode returns either the root node of the server (moId)
            // or if nodeId !== undefined the node with given nodeId
            const res = yield this.addressSpaceService.getNode(this._moId, nodeId);
            if (res) {
                if (res.status !== 200) {
                    const data = res.json ? yield res.json() : undefined;
                    this.alertService.addServerFailure({ data, res });
                    this.dataSource = undefined;
                }
                else {
                    const rootNode = (yield res.json());
                    this.nestedTreeControl = new NestedTreeControl(this.getChildren);
                    this.dataSource = new DynamicDataSource(this.nestedTreeControl, this.addressSpaceService, this._moId);
                    this.dataSource.data = [rootNode];
                }
                this.loading = false;
            }
            else {
                this.loading = false;
            }
        });
    }
    getMoId() {
        if (!this._moId || this._moId.length === 0) {
            return this.opcuaService.getMoId();
        }
        return this._moId;
    }
    getIcon(nodeClassName) {
        return this.addressSpaceService.getIcon(nodeClassName);
    }
    toggleFocusedNode(node) {
        const relativePath = [];
        this.getRelativePath(node, relativePath);
        node.relativePath = relativePath;
        this.selectedNode.emit(node);
        this.focused = this.isFocusedNode(node) ? undefined : node;
    }
    isFocusedNode(node) {
        if (this.focused) {
            return node.nodeId === this.focused.nodeId;
        }
        return false;
    }
    getRelativePath(node, relativePath) {
        if (node.parentNode) {
            relativePath.unshift(node.browseName);
            this.getRelativePath(node.parentNode, relativePath);
        }
    }
}
OpcuaAddressSpaceTreeComponent.ɵfac = function OpcuaAddressSpaceTreeComponent_Factory(t) { return new (t || OpcuaAddressSpaceTreeComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.AddressSpaceService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.OpcuaService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.AlertService)); };
OpcuaAddressSpaceTreeComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: OpcuaAddressSpaceTreeComponent, selectors: [["opcua-address-space-tree"]], inputs: { focusEmitter: "focusEmitter", moId: "moId", node: "node" }, outputs: { selectedNode: "selectedNode" }, features: [ɵngcc0.ɵɵNgOnChangesFeature], decls: 3, vars: 3, consts: [["class", "card-block", 4, "ngIf"], ["class", "p-8", 4, "ngIf"], ["class", "alert alert-info m-t-16", "translate", "", 4, "ngIf"], [1, "card-block"], [3, "dataSource", "treeControl"], ["class", "interact", 3, "ngClass", "click", 4, "cdkTreeNodeDef"], [4, "cdkTreeNodeDef", "cdkTreeNodeDefWhen"], [1, "interact", 3, "ngClass", "click"], [1, "m-r-4", "interact", 3, "c8yIcon", "ngClass"], [1, "flex-row"], ["cdkTreeNodeToggle", "", 1, "btn-clean", "text-primary", "m-r-4", 3, "disabled"], [3, "ngClass"], [1, "m-r-4", "interact", 3, "c8yIcon"], [1, "m-l-4"], [1, "dlt-c8y-icon-circle-o-notch", "icon-spin"], ["cdkTreeNodeOutlet", ""], [1, "p-8"], [1, "spinner", "p-relative"], [1, "rect1"], [1, "rect2"], [1, "rect3"], [1, "rect4"], [1, "rect5"], ["translate", "", 1, "alert", "alert-info", "m-t-16"]], template: function OpcuaAddressSpaceTreeComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵtemplate(0, OpcuaAddressSpaceTreeComponent_div_0_Template, 4, 3, "div", 0);
        ɵngcc0.ɵɵtemplate(1, OpcuaAddressSpaceTreeComponent_div_1_Template, 7, 0, "div", 1);
        ɵngcc0.ɵɵtemplate(2, OpcuaAddressSpaceTreeComponent_div_2_Template, 2, 0, "div", 2);
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("ngIf", ctx.dataSource && !ctx.loading);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.loading);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", !ctx.dataSource && !ctx.loading);
    } }, directives: [ɵngcc4.NgIf, ɵngcc5.CdkTree, ɵngcc5.CdkTreeNodeDef, ɵngcc5.CdkNestedTreeNode, ɵngcc4.NgClass, ɵngcc3.IconDirective, ɵngcc5.CdkTreeNodeToggle, ɵngcc5.CdkTreeNodeOutlet, ɵngcc3.C8yTranslateDirective], encapsulation: 2 });
OpcuaAddressSpaceTreeComponent.ctorParameters = () => [
    { type: AddressSpaceService },
    { type: OpcuaService },
    { type: AlertService }
];
OpcuaAddressSpaceTreeComponent.propDecorators = {
    moId: [{ type: Input }],
    node: [{ type: Input }],
    focusEmitter: [{ type: Input }],
    selectedNode: [{ type: Output }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(OpcuaAddressSpaceTreeComponent, [{
        type: Component,
        args: [{
                selector: 'opcua-address-space-tree',
                template: "<div class=\"card-block\" *ngIf=\"dataSource && !loading\">\n  <cdk-tree [dataSource]=\"dataSource\" [treeControl]=\"nestedTreeControl\">\n    <!-- This is the tree node template for leaf nodes -->\n    <cdk-nested-tree-node\n      *cdkTreeNodeDef=\"let node\"\n      (click)=\"toggleFocusedNode(node)\"\n      [ngClass]=\"{ strong: isFocusedNode(node) }\"\n      class=\"interact\"\n    >\n      <span>\n        <i\n          class=\"m-r-4 interact\"\n          [c8yIcon]=\"getIcon(node.nodeClassName)\"\n          [ngClass]=\"{ strong: isFocusedNode(node) }\"\n        ></i>\n        {{ node.displayName }}\n      </span>\n    </cdk-nested-tree-node>\n    <!-- This is the tree node template for expandable nodes -->\n    <cdk-nested-tree-node *cdkTreeNodeDef=\"let node; when: hasChild\">\n      <div class=\"flex-row\">\n        <button\n          cdkTreeNodeToggle\n          class=\"btn-clean text-primary m-r-4\"\n          [disabled]=\"node.currentlyLoadingChildren\"\n        >\n          <i\n            [ngClass]=\"{ 'dlt-c8y-icon-plus-square': !node.expanded, 'dlt-c8y-icon-minus-square': node.expanded }\"\n          ></i>\n        </button>\n        <i\n          class=\"m-r-4 interact\"\n          [c8yIcon]=\"getIcon(node.nodeClassName)\"\n        ></i>\n        <span\n          (click)=\"toggleFocusedNode(node)\"\n          [ngClass]=\"{ strong: isFocusedNode(node) }\"\n          class=\"interact\"\n        >\n          {{ node.displayName }}\n        </span>\n        <span\n          class=\"m-l-4\"\n          [style.visibility]=\"node.currentlyLoadingChildren ? 'visible' : 'hidden'\"\n        >\n          <i class=\"dlt-c8y-icon-circle-o-notch icon-spin\"></i>\n        </span>\n      </div>\n      <ng-container cdkTreeNodeOutlet></ng-container>\n    </cdk-nested-tree-node>\n  </cdk-tree>\n</div>\n<div class=\"p-8\" *ngIf=\"loading\">\n  <div class=\"spinner p-relative\">\n    <div class=\"rect1\"></div>\n    <div class=\"rect2\"></div>\n    <div class=\"rect3\"></div>\n    <div class=\"rect4\"></div>\n    <div class=\"rect5\"></div>\n  </div>\n</div>\n<div class=\"alert alert-info m-t-16\" *ngIf=\"!dataSource && !loading\" translate>\n  No source data available to fetch address space.\n</div>\n"
            }]
    }], function () { return [{ type: ɵngcc1.AddressSpaceService }, { type: ɵngcc2.OpcuaService }, { type: ɵngcc3.AlertService }]; }, { focusEmitter: [{
            type: Input
        }], selectedNode: [{
            type: Output
        }], moId: [{
            type: Input
        }], node: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtYWRkcmVzcy1zcGFjZS10cmVlLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vcHJvdG9jb2wtb3BjdWEvb3BjdWEtYWRkcmVzcy1zcGFjZS10cmVlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsTUFBTSxFQUVOLFlBQVksRUFJYixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQW9CLG1CQUFtQixFQUFzQixNQUFNLHlCQUF5QixDQUFDO0FBQ3BHLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDdEQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUMvQixPQUFPLEVBQUUsT0FBTyxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUM3QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBTTNDLE1BQU0sT0FBTyw4QkFBOEI7QUFBRyxJQWtCNUMsWUFDVSxtQkFBd0MsRUFDeEMsWUFBMEIsRUFDMUIsWUFBMEI7QUFDbkMsUUFIUyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO0FBQUMsUUFDekMsaUJBQVksR0FBWixZQUFZLENBQWM7QUFBQyxRQUMzQixpQkFBWSxHQUFaLFlBQVksQ0FBYztBQUN0QyxRQWZXLGlCQUFZLEdBQW1DLElBQUksWUFBWSxFQUFvQixDQUFDO0FBQy9GLFFBQVksaUJB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QUN6QixZQUFNLFlBQVksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQzVDLFlBQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLFlBQVksQ0FBQyxDQUFDO0FBQzFELFNBQUs7QUFDTCxJQUFFLENBQUM7QUFDSDswREFuTEMsU0FBUyxTQUFDLGtCQUNULFFBQVEsRUFBRSwwQkFBMEIsa0JBQ3BDOzs7Ozs7Ozs7OztpUEFFRztBQUFDO0FBQXdELFlBYm5DLG1CQUFtQjtDQVdZLGNBQ3pELGZBWmlELFlBQ3pDLFlBQVk7QUFBSSxZQUNoQixZQUFZO0FBQUc7QUFBRztBQUNGLG1CQVd0QixLQUFLO0FBQ04sbUJBSUMsS0FBSztBQUFLLDJCQUNWLEtBQUs7QUFBSywyQkFDVixNQUFNO0FBQUk7Ozs7Ozs7Ozs7Ozs7OztvQkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBPbkluaXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgT25EZXN0cm95LFxuICBPbkNoYW5nZXMsXG4gIFNpbXBsZUNoYW5nZXNcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBZGRyZXNzU3BhY2VOb2RlLCBBZGRyZXNzU3BhY2VTZXJ2aWNlLCBOb2RlTmF2aWdhdGlvbkRhdGEgfSBmcm9tICcuL2FkZHJlc3Mtc3BhY2Uuc2VydmljZSc7XG5pbXBvcnQgeyBPcGN1YVNlcnZpY2UgfSBmcm9tICcuL29wY3VhU2VydmljZSc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IER5bmFtaWNEYXRhU291cmNlIH0gZnJvbSAnLi9keW5hbWljLWRhdGEtc291cmNlJztcbmltcG9ydCB7IE5lc3RlZFRyZWVDb250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3RyZWUnO1xuaW1wb3J0IHsgY2xvbmUgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgU3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ29wY3VhLWFkZHJlc3Mtc3BhY2UtdHJlZScsXG4gIHRlbXBsYXRlVXJsOiAnLi9vcGN1YS1hZGRyZXNzLXNwYWNlLXRyZWUuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIE9wY3VhQWRkcmVzc1NwYWNlVHJlZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBPbkNoYW5nZXMge1xuICBASW5wdXQoKVxuICBzZXQgbW9JZChpZDogc3RyaW5nKSB7XG4gICAgdGhpcy5fbW9JZCA9IGlkIHx8IHVuZGVmaW5lZDtcbiAgfVxuXG4gIEBJbnB1dCgpIG5vZGU7XG4gIEBJbnB1dCgpIGZvY3VzRW1pdHRlcjogRXZlbnRFbWl0dGVyPEFkZHJlc3NTcGFjZU5vZGU+ID0gbmV3IEV2ZW50RW1pdHRlcjxBZGRyZXNzU3BhY2VOb2RlPigpO1xuICBAT3V0cHV0KCkgc2VsZWN0ZWROb2RlOiBFdmVudEVtaXR0ZXI8QWRkcmVzc1NwYWNlTm9kZT4gPSBuZXcgRXZlbnRFbWl0dGVyPEFkZHJlc3NTcGFjZU5vZGU+KCk7XG4gIG5lc3RlZFRyZWVDb250cm9sOiBOZXN0ZWRUcmVlQ29udHJvbDxBZGRyZXNzU3BhY2VOb2RlPjtcbiAgZGF0YVNvdXJjZTogRHluYW1pY0RhdGFTb3VyY2UgPSBudWxsO1xuICBmb2N1c2VkOiBBZGRyZXNzU3BhY2VOb2RlO1xuICBsb2FkaW5nOiBib29sZWFuID0gZmFsc2U7XG4gIHN1YnNjcmlwdGlvblJlZjogU3Vic2NyaXB0aW9uO1xuICBub2RlTmF2RGF0YVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICBwcml2YXRlIF9tb0lkOiBzdHJpbmc7XG4gIHByaXZhdGUgZGVzdHJveSQ6IFN1YmplY3Q8YW55PiA9IG5ldyBTdWJqZWN0PGFueT4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFkZHJlc3NTcGFjZVNlcnZpY2U6IEFkZHJlc3NTcGFjZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBvcGN1YVNlcnZpY2U6IE9wY3VhU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlXG4gICkge31cblxuICBnZXRDaGlsZHJlbiA9IChub2RlOiBBZGRyZXNzU3BhY2VOb2RlKSA9PiAobm9kZS5leHBhbmRlZCA/IG5vZGUuY2hpbGRyZW4gOiBbXSk7XG4gIGhhc0NoaWxkID0gKF86IG51bWJlciwgX25vZGVEYXRhOiBBZGRyZXNzU3BhY2VOb2RlKSA9PlxuICAgIHRoaXMuYWRkcmVzc1NwYWNlU2VydmljZS5jaGlsZHJlbkF2YWlsYWJsZShfbm9kZURhdGEucmVmZXJlbmNlcylcblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmluaXRpYWxpemVEYXRhU2V0KCk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgaWYgKGNoYW5nZXMubW9JZCAmJiBjaGFuZ2VzLm1vSWQucHJldmlvdXNWYWx1ZSAmJiAoY2hhbmdlcy5tb0lkLmN1cnJlbnRWYWx1ZSAhPT0gY2hhbmdlcy5tb0lkLnByZXZpb3VzVmFsdWUpKSB7XG4gICAgICB0aGlzLmluaXRpYWxpemVEYXRhU2V0KCk7XG4gICAgfVxuICB9XG5cbiAgaW5pdGlhbGl6ZURhdGFTZXQoKSB7XG4gICAgdGhpcy5ub2RlTmF2RGF0YVN1YnNjcmlwdGlvbiA9IHRoaXMuYWRkcmVzc1NwYWNlU2VydmljZVxuICAgICAgLmdldE5vZGVOYXZEYXRhJCgpXG4gICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95JCkpXG4gICAgICAuc3Vic2NyaWJlKG5vZGVOYXZEYXRhID0+IHRoaXMub3Blbk5vZGUobm9kZU5hdkRhdGEpKTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvblJlZiA9IHRoaXMuZm9jdXNFbWl0dGVyLnN1YnNjcmliZShub2RlID0+IHtcbiAgICAgIHRoaXMuZm9jdXNlZCA9IHRoaXMuaXNGb2N1c2VkTm9kZShub2RlKSA/IHVuZGVmaW5lZCA6IG5vZGU7XG4gICAgfSk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcbiAgICB0aGlzLmRlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gICAgLy8gY2xlYW4gdXAgdGhlIGFkZHJlc3Mtc3BhY2UtdHJlZVxuICAgIHRoaXMuYWRkcmVzc1NwYWNlU2VydmljZS5yZXNldFRyZWVUb1Jvb3ROb2RlKCk7XG5cbiAgICBpZiAodGhpcy5ub2RlTmF2RGF0YVN1YnNjcmlwdGlvbiAmJiAhdGhpcy5ub2RlTmF2RGF0YVN1YnNjcmlwdGlvbi5jbG9zZWQpIHtcbiAgICAgIHRoaXMubm9kZU5hdkRhdGFTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zdWJzY3JpcHRpb25SZWYgJiYgIXRoaXMuc3Vic2NyaXB0aW9uUmVmLmNsb3NlZCkge1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb25SZWYudW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBvcGVuTm9kZShub2RlTmF2RGF0YTogTm9kZU5hdmlnYXRpb25EYXRhKSB7XG4gICAgY29uc3QgeyBub2RlLCBzZWxlY3RlZEFuY2VzdG9ySWRzIH0gPSBub2RlTmF2RGF0YTtcbiAgICBsZXQgbm9kZUlkO1xuXG4gICAgLy8gV2UganVzdCBzZXQgdGhlIG5vZGVJZCB3aGVuIHRoZSBzZWxlY3RlZEFuY2VzdG9ySWRzIHZhcmlhYmxlIGFuIGVtcHR5IGFycmF5LlxuICAgIC8vIElmIHNlbGVjdGVkQW5jZXN0b3JJZHMgY29udGFpbiBhbnkgaWQgd2UgYXNzdW1lIHRoYXQgdGhlIHRyZWUgc2hvdWxkIGJlIHRyYXZzZXJzZWQgYmVnaW5uaW5nXG4gICAgLy8gZnJvbSB0aGUgcm9vdCBub2RlLlxuICAgIGlmIChub2RlICYmIG5vZGUubm9kZUlkICYmIHNlbGVjdGVkQW5jZXN0b3JJZHMgJiYgc2VsZWN0ZWRBbmNlc3Rvcklkcy5sZW5ndGggPT09IDApIHtcbiAgICAgIG5vZGVJZCA9IG5vZGUubm9kZUlkO1xuICAgIH1cbiAgICAvLyBBbHdheXMgcmVjcmVhdGUgdGhlIHRyZWUgd2hlbiByb3V0aW5nIHRvIGEgc3BlY2lmaWMgbmVzdGVkIG5vZGUsXG4gICAgLy8gYmVjYXVzZSBwcmV2aW91cyBtb2RpZmljYXRpb25zIHRvIHRoZSB0cmVlLXN0cnVjdHVyZSBjb3VsZCBjYXVzZSBlcnJvcnNcbiAgICAvLyB3aGlsZSB0cmF2ZXJzaW5nIHdpdGggJ29sZCcgdHJlZS1kYXRhXG4gICAgLy8gLS0tLS0tLS0tLS0tLS0tLS1cbiAgICAvLyBzZXR1cFRyZWUgaXMgYWJsZSB0byBoYW5kbGUgbm9kZUlkID0gdW5kZWZpbmVkXG4gICAgYXdhaXQgdGhpcy5zZXR1cFRyZWUobm9kZUlkKTtcblxuICAgIGlmICghc2VsZWN0ZWRBbmNlc3RvcklkcyB8fCBzZWxlY3RlZEFuY2VzdG9ySWRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChub2RlTmF2RGF0YSAmJiB0aGlzLmRhdGFTb3VyY2UpIHtcbiAgICAgIGNvbnN0IGNsb25lZEFuY2VzdG9ycyA9IGNsb25lKHNlbGVjdGVkQW5jZXN0b3JJZHMpO1xuICAgICAgY2xvbmVkQW5jZXN0b3JzLnNoaWZ0KCk7XG5cbiAgICAgIGNvbnN0IG4gPSBhd2FpdCB0aGlzLmRhdGFTb3VyY2UudG9nZ2xlTm9kZSh0aGlzLmRhdGFTb3VyY2UuZGF0YVswXSwgdHJ1ZSk7XG4gICAgICB0aGlzLnNldENoaWxkTm9kZXMobi5jaGlsZHJlbiwgY2xvbmVkQW5jZXN0b3JzKTtcblxuICAgICAgdGhpcy50b2dnbGVGb2N1c2VkTm9kZShub2RlKTtcbiAgICB9XG4gIH1cblxuICBzZXRDaGlsZE5vZGVzKG5vZGVzOiBBZGRyZXNzU3BhY2VOb2RlW10sIGlkczogc3RyaW5nW10pIHtcbiAgICBpZiAobm9kZXMpIHtcbiAgICAgIGlkcy5mb3JFYWNoKGFzeW5jIGlkID0+IHtcbiAgICAgICAgY29uc3QgbWF0Y2ggPSBub2Rlcy5maW5kKG4gPT4gbi5ub2RlSWQgPT09IGlkKTtcbiAgICAgICAgaWYgKG1hdGNoICYmIGlkcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgY29uc3QgaWR4ID0gaWRzLmZpbmRJbmRleCh2YWx1ZSA9PiB2YWx1ZSA9PT0gaWQpO1xuICAgICAgICAgIGlmIChpZHggPj0gMCkge1xuICAgICAgICAgICAgaWRzLnNwbGljZShpZHgsIDEpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCB0b2dnbGVkTm9kZSA9IGF3YWl0IHRoaXMuZGF0YVNvdXJjZS50b2dnbGVOb2RlKG1hdGNoLCB0cnVlKTtcbiAgICAgICAgICB0aGlzLnNldENoaWxkTm9kZXModG9nZ2xlZE5vZGUuY2hpbGRyZW4sIGlkcyk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHNldHVwVHJlZShub2RlSWQ/OiBzdHJpbmcpIHtcbiAgICB0aGlzLmxvYWRpbmcgPSB0cnVlO1xuXG4gICAgaWYgKCF0aGlzLl9tb0lkIHx8IHRoaXMuX21vSWQubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLl9tb0lkID0gdGhpcy5vcGN1YVNlcnZpY2UuZ2V0TW9JZCgpO1xuICAgIH1cblxuICAgIC8vIGFkZHJlc3NTcGFjZVNlcnZpY2UuZ2V0Tm9kZSByZXR1cm5zIGVpdGhlciB0aGUgcm9vdCBub2RlIG9mIHRoZSBzZXJ2ZXIgKG1vSWQpXG4gICAgLy8gb3IgaWYgbm9kZUlkICE9PSB1bmRlZmluZWQgdGhlIG5vZGUgd2l0aCBnaXZlbiBub2RlSWRcbiAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2UuZ2V0Tm9kZSh0aGlzLl9tb0lkLCBub2RlSWQpO1xuICAgIGlmIChyZXMpIHtcbiAgICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHtcbiAgICAgICAgY29uc3QgZGF0YSA9IHJlcy5qc29uID8gYXdhaXQgcmVzLmpzb24oKSA6IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZSh7IGRhdGEsIHJlcyB9KTtcbiAgICAgICAgdGhpcy5kYXRhU291cmNlID0gdW5kZWZpbmVkO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3Qgcm9vdE5vZGUgPSAoYXdhaXQgcmVzLmpzb24oKSkgYXMgQWRkcmVzc1NwYWNlTm9kZTtcbiAgICAgICAgdGhpcy5uZXN0ZWRUcmVlQ29udHJvbCA9IG5ldyBOZXN0ZWRUcmVlQ29udHJvbDxBZGRyZXNzU3BhY2VOb2RlPih0aGlzLmdldENoaWxkcmVuKTtcbiAgICAgICAgdGhpcy5kYXRhU291cmNlID0gbmV3IER5bmFtaWNEYXRhU291cmNlKFxuICAgICAgICAgIHRoaXMubmVzdGVkVHJlZUNvbnRyb2wsXG4gICAgICAgICAgdGhpcy5hZGRyZXNzU3BhY2VTZXJ2aWNlLFxuICAgICAgICAgIHRoaXMuX21vSWRcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5kYXRhU291cmNlLmRhdGEgPSBbcm9vdE5vZGVdO1xuICAgICAgfVxuICAgICAgdGhpcy5sb2FkaW5nID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubG9hZGluZyA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIGdldE1vSWQoKSB7XG4gICAgaWYgKCF0aGlzLl9tb0lkIHx8IHRoaXMuX21vSWQubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gdGhpcy5vcGN1YVNlcnZpY2UuZ2V0TW9JZCgpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fbW9JZDtcbiAgfVxuXG4gIGdldEljb24obm9kZUNsYXNzTmFtZSkge1xuICAgIHJldHVybiB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2UuZ2V0SWNvbihub2RlQ2xhc3NOYW1lKTtcbiAgfVxuXG4gIHRvZ2dsZUZvY3VzZWROb2RlKG5vZGUpIHtcbiAgICBjb25zdCByZWxhdGl2ZVBhdGggPSBbXTtcbiAgICB0aGlzLmdldFJlbGF0aXZlUGF0aChub2RlLCByZWxhdGl2ZVBhdGgpO1xuICAgIG5vZGUucmVsYXRpdmVQYXRoID0gcmVsYXRpdmVQYXRoO1xuXG4gICAgdGhpcy5zZWxlY3RlZE5vZGUuZW1pdChub2RlKTtcbiAgICB0aGlzLmZvY3VzZWQgPSB0aGlzLmlzRm9jdXNlZE5vZGUobm9kZSkgPyB1bmRlZmluZWQgOiBub2RlO1xuICB9XG5cbiAgaXNGb2N1c2VkTm9kZShub2RlOiBBZGRyZXNzU3BhY2VOb2RlKSB7XG4gICAgaWYgKHRoaXMuZm9jdXNlZCkge1xuICAgICAgcmV0dXJuIG5vZGUubm9kZUlkID09PSB0aGlzLmZvY3VzZWQubm9kZUlkO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGdldFJlbGF0aXZlUGF0aChub2RlOiBBZGRyZXNzU3BhY2VOb2RlLCByZWxhdGl2ZVBhdGg6IHN0cmluZ1tdKSB7XG4gICAgaWYgKG5vZGUucGFyZW50Tm9kZSkge1xuICAgICAgcmVsYXRpdmVQYXRoLnVuc2hpZnQobm9kZS5icm93c2VOYW1lKTtcbiAgICAgIHRoaXMuZ2V0UmVsYXRpdmVQYXRoKG5vZGUucGFyZW50Tm9kZSwgcmVsYXRpdmVQYXRoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==