import { __awaiter } from "tslib";
import { Component, ViewChildren, ChangeDetectorRef } from '@angular/core';
import { Router } from '@angular/router';
import { OpcuaService } from './opcuaService';
import { AlertService, gettext } from '@c8y/ngx-components';
import { find, assign, omit, findIndex, pick, get } from 'lodash';
import { OpcuaDeviceProtocolMapping } from './opcua-device-protocol-mapping.component';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './opcuaService';
import * as ɵngcc2 from '@c8y/ngx-components';
import * as ɵngcc3 from '@angular/router';
import * as ɵngcc4 from '@angular/common';
import * as ɵngcc5 from '@angular/forms';
import * as ɵngcc6 from './opcua-device-protocol-description.component';
import * as ɵngcc7 from './opcua-device-protocol-data-reporting.component';
import * as ɵngcc8 from './opcua-auto-apply-settings.component';
import * as ɵngcc9 from './opcua-device-protocol-mapping.component';

function OpcuaDeviceProtocolDetailComponent_c8y_title_0_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "c8y-title");
    ɵngcc0.ɵɵtext(1);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate(ctx_r0.model.name);
} }
function OpcuaDeviceProtocolDetailComponent_form_2_div_7_opcua_device_protocol_mapping_1_Template(rf, ctx) { if (rf & 1) {
    const _r9 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "opcua-device-protocol-mapping", 22);
    ɵngcc0.ɵɵlistener("onAction", function OpcuaDeviceProtocolDetailComponent_form_2_div_7_opcua_device_protocol_mapping_1_Template_opcua_device_protocol_mapping_onAction_0_listener($event) { ɵngcc0.ɵɵrestoreView(_r9); const ctx_r8 = ɵngcc0.ɵɵnextContext(3); return ctx_r8.actionHandler($event); });
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const resource_r6 = ctx.$implicit;
    const i_r7 = ctx.index;
    const ctx_r5 = ɵngcc0.ɵɵnextContext(3);
    ɵngcc0.ɵɵproperty("index", i_r7)("referencedServerId", ctx_r5.model.referencedServerId)("referencedRootNodeId", ctx_r5.model.referencedRootNodeId)("resource", ctx_r5.getStructuredResource(resource_r6))("getParentAttr", ctx_r5.getParentAttr);
} }
function OpcuaDeviceProtocolDetailComponent_form_2_div_7_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 20);
    ɵngcc0.ɵɵtemplate(1, OpcuaDeviceProtocolDetailComponent_form_2_div_7_opcua_device_protocol_mapping_1_Template, 1, 5, "opcua-device-protocol-mapping", 21);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r3 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngForOf", ctx_r3.getMapping())("ngForTrackBy", ctx_r3.trackByIndex);
} }
function OpcuaDeviceProtocolDetailComponent_form_2_div_9_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 23);
    ɵngcc0.ɵɵelement(1, "h1", 24);
    ɵngcc0.ɵɵelementStart(2, "p", 7);
    ɵngcc0.ɵɵtext(3, "No variables to display. Click below to add.");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} }
function OpcuaDeviceProtocolDetailComponent_form_2_Template(rf, ctx) { if (rf & 1) {
    const _r11 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "form", 2, 3);
    ɵngcc0.ɵɵelement(2, "opcua-device-protocol-description", 4);
    ɵngcc0.ɵɵelementStart(3, "div", 5);
    ɵngcc0.ɵɵelementStart(4, "div", 6);
    ɵngcc0.ɵɵelementStart(5, "h4", 7);
    ɵngcc0.ɵɵtext(6, "Variables");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵtemplate(7, OpcuaDeviceProtocolDetailComponent_form_2_div_7_Template, 2, 2, "div", 8);
    ɵngcc0.ɵɵelementStart(8, "div", 9);
    ɵngcc0.ɵɵtemplate(9, OpcuaDeviceProtocolDetailComponent_form_2_div_9_Template, 4, 0, "div", 10);
    ɵngcc0.ɵɵelementStart(10, "button", 11);
    ɵngcc0.ɵɵlistener("click", function OpcuaDeviceProtocolDetailComponent_form_2_Template_button_click_10_listener() { ɵngcc0.ɵɵrestoreView(_r11); const ctx_r10 = ɵngcc0.ɵɵnextContext(); return ctx_r10.addVariable(); });
    ɵngcc0.ɵɵpipe(11, "translate");
    ɵngcc0.ɵɵelement(12, "i", 12);
    ɵngcc0.ɵɵtext(13);
    ɵngcc0.ɵɵpipe(14, "translate");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(15, "div", 5);
    ɵngcc0.ɵɵelementStart(16, "div", 6);
    ɵngcc0.ɵɵelementStart(17, "h4", 7);
    ɵngcc0.ɵɵtext(18, "Data reporting");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(19, "div", 13);
    ɵngcc0.ɵɵelement(20, "opcua-device-protocol-data-reporting", 14);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(21, "div", 15);
    ɵngcc0.ɵɵelementStart(22, "div", 6);
    ɵngcc0.ɵɵelementStart(23, "h4", 7);
    ɵngcc0.ɵɵtext(24, "Auto apply constraints");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(25, "div", 16);
    ɵngcc0.ɵɵelement(26, "opcua-auto-apply", 4);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(27, "span");
    ɵngcc0.ɵɵelementStart(28, "div", 17);
    ɵngcc0.ɵɵelementStart(29, "div", 18);
    ɵngcc0.ɵɵelementStart(30, "button", 19);
    ɵngcc0.ɵɵlistener("click", function OpcuaDeviceProtocolDetailComponent_form_2_Template_button_click_30_listener() { ɵngcc0.ɵɵrestoreView(_r11); const ctx_r12 = ɵngcc0.ɵɵnextContext(); return ctx_r12.save(); });
    ɵngcc0.ɵɵpipe(31, "translate");
    ɵngcc0.ɵɵtext(32, " Save ");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const _r2 = ɵngcc0.ɵɵreference(1);
    const ctx_r1 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("model", ctx_r1.model);
    ɵngcc0.ɵɵadvance(5);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r1.model.mappings.length > 0);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r1.model.mappings.length === 0);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(11, 10, "Add variable"));
    ɵngcc0.ɵɵadvance(3);
    ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(14, 12, "Add variable"), " ");
    ɵngcc0.ɵɵadvance(7);
    ɵngcc0.ɵɵproperty("groupName", "subscription")("model", ctx_r1.model);
    ɵngcc0.ɵɵadvance(6);
    ɵngcc0.ɵɵproperty("model", ctx_r1.model);
    ɵngcc0.ɵɵadvance(4);
    ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(31, 14, "Save"));
    ɵngcc0.ɵɵproperty("disabled", ctx_r1.canSave(_r2));
} }
export class OpcuaDeviceProtocolDetailComponent {
    constructor(changeDetectorRef, opcuaService, alertService, router) {
        this.changeDetectorRef = changeDetectorRef;
        this.opcuaService = opcuaService;
        this.alertService = alertService;
        this.router = router;
        this.initialModel = {
            id: '',
            fieldbusType: 'opcuaV2',
            description: '',
            unit: '',
            fieldbusVersion: 4,
            name: '',
            referencedServerId: '',
            referencedRootNodeId: '',
            subscriptionType: {
                type: 'None'
            },
            mappings: [],
            overriddenSubscriptions: [],
            applyConstraints: {
                browsePathMatchesRegex: '',
                matchesNodeIds: [],
                serverObjectHasFragment: '',
                matchesServerIds: []
            },
            enabled: ''
        };
        this.isLoaded = true;
        this.getParentAttr = key => get(this.model, key);
    }
    ngAfterContentChecked() {
        this.changeDetectorRef.detectChanges();
    }
    getMapping() {
        return this.model.mappings;
    }
    getEmptyMappingObject() {
        return {
            id: 'new',
            browsePath: []
        };
    }
    getOverriddenSubscriptionsByPath(browsePath) {
        return find(this.model.overriddenSubscriptions, { browsePath });
    }
    getStructuredResource(resource) {
        const overriddenSubscriptions = this.getOverriddenSubscriptionsByPath(resource.browsePath);
        let result = assign({}, resource);
        if (overriddenSubscriptions) {
            result = assign({}, resource, { subscriptionType: overriddenSubscriptions.subscriptionType });
        }
        return result;
    }
    ngOnInit() {
        return __awaiter(this, void 0, void 0, function* () {
            const id = this.opcuaService.getId();
            if (id) {
                const res = yield this.opcuaService.getDeviceProtocol(id);
                if (res && res.status !== 200) {
                    const data = res.json ? yield res.json() : undefined;
                    this.alertService.addServerFailure({ data, res });
                    this.isLoaded = false;
                }
                else {
                    const data = yield res.json();
                    if (data && data.applyConstraints === null) {
                        delete data.applyConstraints;
                    }
                    if (data && data.subscriptionType === null) {
                        delete data.subscriptionType;
                    }
                    this.model = assign(this.initialModel, data);
                    if (!this.model.mappings) {
                        this.model.mappings = [];
                    }
                    this.model = assign(this.initialModel, this.updateViableMapping(data));
                    this.isLoaded = false;
                }
            }
        });
    }
    updateViableMapping(model) {
        const { mappings } = model;
        let result = [];
        if (mappings) {
            result = mappings.map((item, i) => {
                return assign(item, { id: i });
            });
        }
        return assign(model, { mappings: result });
    }
    trackByIndex(index) {
        return index;
    }
    addVariable() {
        this.model.mappings.push(this.getEmptyMappingObject());
    }
    updateVariable(mappingObject) {
        const { mappings } = this.model;
        const index = findIndex(mappings, { id: mappingObject.id });
        mappings.splice(index, 1);
        if (mappingObject.id === 'new') {
            mappingObject.id = mappings.length;
        }
        mappings.push(mappingObject);
    }
    removeVariable(mappingObject) {
        const { mappings } = this.model;
        const index = findIndex(mappings, { id: mappingObject.id });
        mappings.splice(index, 1);
    }
    actionHandler(actionObject) {
        switch (actionObject.action) {
            case 'save':
                this.updateVariable(actionObject.data);
                break;
            case 'delete':
                this.removeVariable(actionObject.data);
                break;
        }
    }
    extractOverridSubscriptionType(_mapping) {
        const overriddenSubscriptions = [];
        const variableMapping = [];
        _mapping.forEach(element => {
            if (element.id !== 'new') {
                if (element.subscriptionType) {
                    overriddenSubscriptions.push(assign({ browsePath: element.browsePath }, { subscriptionType: element.subscriptionType }));
                }
                variableMapping.push(omit(element, ['subscriptionType']));
            }
        });
        return [variableMapping, overriddenSubscriptions];
    }
    prepareRequestJson(_model) {
        let requestJson = {};
        const [mappings, overriddenSubscriptions] = this.extractOverridSubscriptionType(_model.mappings);
        requestJson = assign(requestJson, pick(_model, Object.keys(this.initialModel)), {
            mappings,
            overriddenSubscriptions
        });
        return requestJson;
    }
    save() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const res = yield this.opcuaService.updateDeviceProtocol(this.prepareRequestJson(this.model));
                const data = yield res.json();
                if (res && res.status === 200) {
                    this.router.navigate(['deviceprotocols']);
                    this.alertService.success(gettext('Device protocol saved.'));
                }
                else {
                    const { details } = data;
                    this.alertService.addServerFailure({ res, data: details });
                }
            }
            catch (ex) {
                this.alertService.danger(gettext('Failed to save. Try again.'));
            }
        });
    }
    canSave(deviceTypeForm) {
        if (this.instanceList) {
            const activeInstances = this.instanceList.filter(item => item.isActive());
            if (activeInstances.length > 0) {
                return true;
            }
        }
        return !deviceTypeForm.form.valid;
    }
}
OpcuaDeviceProtocolDetailComponent.ɵfac = function OpcuaDeviceProtocolDetailComponent_Factory(t) { return new (t || OpcuaDeviceProtocolDetailComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ChangeDetectorRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.OpcuaService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.AlertService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.Router)); };
OpcuaDeviceProtocolDetailComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: OpcuaDeviceProtocolDetailComponent, selectors: [["opcua-device-protocol-detail"]], viewQuery: function OpcuaDeviceProtocolDetailComponent_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵviewQuery(OpcuaDeviceProtocolMapping, 5);
    } if (rf & 2) {
        let _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.instanceList = _t);
    } }, decls: 3, vars: 2, consts: [[4, "ngIf"], ["name", "detailForm", 4, "ngIf"], ["name", "detailForm"], ["deviceTypeForm", "ngForm"], [3, "model"], [1, "card", "m-b-4"], [1, "card-header", "separator"], ["translate", ""], ["class", "list-group", "ngModelGroup", "variable", 4, "ngIf"], [1, "card-block"], ["class", "c8y-empty-state text-left", 4, "ngIf"], [1, "btn-add-block", "addVariableBtn", 3, "title", "click"], ["c8yIcon", "plus-circle"], ["ngModelGroup", "subscription", 1, "card-block"], [3, "groupName", "model"], [1, "card"], ["ngModelGroup", "autoApply", 1, "card-block", "overflow-visible"], [1, "text-center", "page-footer", "m-t-16"], [1, "btn-save-wrapper", "animated"], ["id", "deviceTypeSave", "translate", "", 1, "btn", "btn-primary", 3, "title", "disabled", "click"], ["ngModelGroup", "variable", 1, "list-group"], [3, "index", "referencedServerId", "referencedRootNodeId", "resource", "getParentAttr", "onAction", 4, "ngFor", "ngForOf", "ngForTrackBy"], [3, "index", "referencedServerId", "referencedRootNodeId", "resource", "getParentAttr", "onAction"], [1, "c8y-empty-state", "text-left"], ["c8yIcon", "sliders"]], template: function OpcuaDeviceProtocolDetailComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵtemplate(0, OpcuaDeviceProtocolDetailComponent_c8y_title_0_Template, 2, 1, "c8y-title", 0);
        ɵngcc0.ɵɵelementStart(1, "div");
        ɵngcc0.ɵɵtemplate(2, OpcuaDeviceProtocolDetailComponent_form_2_Template, 33, 16, "form", 1);
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("ngIf", !ctx.isLoaded);
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("ngIf", !ctx.isLoaded);
    } }, directives: [ɵngcc4.NgIf, ɵngcc2.TitleComponent, ɵngcc5.ɵNgNoValidate, ɵngcc5.NgControlStatusGroup, ɵngcc5.NgForm, ɵngcc6.OpcuaDeviceProtocolDescription, ɵngcc2.C8yTranslateDirective, ɵngcc2.IconDirective, ɵngcc5.NgModelGroup, ɵngcc7.OpcuaDeviceProtocolDataReportingComponent, ɵngcc8.OpcuaAutoApplySettingsComponent, ɵngcc4.NgForOf, ɵngcc9.OpcuaDeviceProtocolMapping], pipes: [ɵngcc2.C8yTranslatePipe], encapsulation: 2 });
OpcuaDeviceProtocolDetailComponent.ctorParameters = () => [
    { type: ChangeDetectorRef },
    { type: OpcuaService },
    { type: AlertService },
    { type: Router }
];
OpcuaDeviceProtocolDetailComponent.propDecorators = {
    instanceList: [{ type: ViewChildren, args: [OpcuaDeviceProtocolMapping,] }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(OpcuaDeviceProtocolDetailComponent, [{
        type: Component,
        args: [{
                selector: 'opcua-device-protocol-detail',
                template: "<c8y-title *ngIf=\"!isLoaded\">{{ model.name }}</c8y-title>\n<div>\n  <form #deviceTypeForm=\"ngForm\" name=\"detailForm\" *ngIf=\"!isLoaded\">\n    <opcua-device-protocol-description [model]=\"model\"></opcua-device-protocol-description>\n    <div class=\"card m-b-4\">\n      <div class=\"card-header separator\">\n        <h4 translate>Variables</h4>\n      </div>\n      <div class=\"list-group\" *ngIf=\"model.mappings.length > 0\" ngModelGroup=\"variable\">\n        <opcua-device-protocol-mapping\n          *ngFor=\"let resource of getMapping(); trackBy: trackByIndex; let i = index\"\n          [index]=\"i\"\n          [referencedServerId]=\"model.referencedServerId\"\n          [referencedRootNodeId]=\"model.referencedRootNodeId\"\n          [resource]=\"getStructuredResource(resource)\"\n          [getParentAttr]=\"getParentAttr\"\n          (onAction)=\"actionHandler($event)\"\n        >\n        </opcua-device-protocol-mapping>\n      </div>\n      <div class=\"card-block\">\n        <div class=\"c8y-empty-state text-left\" *ngIf=\"model.mappings.length === 0\">\n          <h1 c8yIcon=\"sliders\"></h1>\n          <p translate>No variables to display. Click below to add.</p>\n        </div>\n        <button\n          title=\"{{ 'Add variable' | translate }}\"\n          class=\"btn-add-block addVariableBtn\"\n          (click)=\"addVariable()\"\n        >\n          <i c8yIcon=\"plus-circle\"></i> {{ 'Add variable' | translate }}\n        </button>\n      </div>\n    </div>\n    <div class=\"card m-b-4\">\n      <div class=\"card-header separator\">\n        <h4 translate>Data reporting</h4>\n      </div>\n      <div class=\"card-block\" ngModelGroup=\"subscription\">\n        <opcua-device-protocol-data-reporting\n          [groupName]=\"'subscription'\"\n          [model]=\"model\"\n        ></opcua-device-protocol-data-reporting>\n      </div>\n    </div>\n    <div class=\"card\">\n      <div class=\"card-header separator\">\n        <h4 translate>Auto apply constraints</h4>\n      </div>\n      <div class=\"card-block overflow-visible\" ngModelGroup=\"autoApply\">\n        <opcua-auto-apply [model]=\"model\"></opcua-auto-apply>\n      </div>\n    </div>\n\n    <span>\n      <div class=\"text-center page-footer m-t-16\">\n        <div class=\"btn-save-wrapper animated\">\n          <button\n            title=\"{{ 'Save' | translate }}\"\n            id=\"deviceTypeSave\"\n            class=\"btn btn-primary\"\n            (click)=\"save()\"\n            [disabled]=\"canSave(deviceTypeForm)\"\n            translate\n          >\n            Save\n          </button>\n        </div>\n      </div>\n    </span>\n  </form>\n</div>\n"
            }]
    }], function () { return [{ type: ɵngcc0.ChangeDetectorRef }, { type: ɵngcc1.OpcuaService }, { type: ɵngcc2.AlertService }, { type: ɵngcc3.Router }]; }, { instanceList: [{
            type: ViewChildren,
            args: [OpcuaDeviceProtocolMapping]
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtZGV2aWNlLXByb3RvY29sLWRldGFpbC5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3Byb3RvY29sLW9wY3VhL29wY3VhLWRldmljZS1wcm90b2NvbC1kZXRhaWwuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUVULFlBQVksRUFPWixpQkFBaUIsRUFDbEIsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU5QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRTVELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFTLEdBQUcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUN6RSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQU12RixNQUFNLE9BQU8sa0NBQWtDO0FBQUcsSUErQmhELFlBQ1UsaUJBQW9DLEVBQ3BDLFlBQTBCLEVBQzFCLFlBQTBCLEVBQzFCLE1BQWM7QUFDdkIsUUFKUyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO0FBQUMsUUFDckMsaUJBQVksR0FBWixZQUFZLENBQWM7QUFBQyxRQUMzQixpQkFBWSxHQUFaLFlBQVksQ0FBYztBQUFDLFFBQzNCLFdBQU0sR0FBTixNQUFNLENBQVE7QUFDMUIsUUFqQ0UsaUJBQVksR0FBb0I7QUFDbEMsWUFBSSxFQUFFLEVBQUUsRUFBRTtBQUNWLFlB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SUFBSSxDQUFDO0FBQ2pDLG9CQUFRLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUM7QUFDbkUsaUJBQU87QUFDUCxhQUFLO0FBQUMsWUFBQSxPQUFPLEVBQUUsRUFBRTtBQUNqQixnQkFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsNEJBQTRCLENBQUMsQ0FBQyxDQUFDO0FBQ3RFLGFBQUs7QUFDTCxRQUFFLENBQUM7QUFFRixLQUZFO0FBQ0gsSUFDRSxPQUFPLENBQUMsY0FBYztBQUN4QixRQUFJLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtBQUMzQixZQUFNLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7QUFDaEYsWUFDTSxJQUFJLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO0FBQ3RDLGdCQUFRLE9BQU8sSUFBSSxDQUFDO0FBQ3BCLGFBQU87QUFDUCxTQUFLO0FBQ0wsUUFBSSxPQUFPLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7QUFDdEMsSUFBRSxDQUFDO0FBQ0g7OERBMU1DLFNBQVMsU0FBQyxrQkFDVCxRQUFRLEVBQUUsOEJBQThCLGtCQUN4Qzs7Ozs7Ozs7Ozs7Ozs7OzBaQUFrRCxjQUNuRCxRQUNJO0FBQUM7QUFBNEQsWUFkaEUsaUJBQWlCO0FBQ2hCLFlBRU0sWUFBWTtBQUFJLFlBRWhCLFlBQVk7QUFBSSxZQUhoQixNQUFNO0FBQUc7QUFBRztBQUNZLDJCQVk5QixZQUFZLFNBQUMsMEJBQTBCO0FBQU07Ozs7Ozs7Ozs7b0JBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgT25Jbml0LFxuICBWaWV3Q2hpbGRyZW4sXG4gIFF1ZXJ5TGlzdCxcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgRXZlbnRFbWl0dGVyLFxuICBWaWV3Q2hpbGQsXG4gIE9uQ2hhbmdlcyxcbiAgQ2hhbmdlRGV0ZWN0b3JSZWZcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgT3BjdWFTZXJ2aWNlIH0gZnJvbSAnLi9vcGN1YVNlcnZpY2UnO1xuaW1wb3J0IHsgTmdGb3JtIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlLCBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBPcGN1YURldmljZVR5cGUgfSBmcm9tICcuL29wY3VhLXByb3RvY29sLWRldmljZS10eXBlLmludGVyZmFjZSc7XG5pbXBvcnQgeyBmaW5kLCBhc3NpZ24sIG9taXQsIGZpbmRJbmRleCwgcGljaywgdW5zZXQsIGdldCB9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBPcGN1YURldmljZVByb3RvY29sTWFwcGluZyB9IGZyb20gJy4vb3BjdWEtZGV2aWNlLXByb3RvY29sLW1hcHBpbmcuY29tcG9uZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnb3BjdWEtZGV2aWNlLXByb3RvY29sLWRldGFpbCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9vcGN1YS1kZXZpY2UtcHJvdG9jb2wtZGV0YWlsLmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIE9wY3VhRGV2aWNlUHJvdG9jb2xEZXRhaWxDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBAVmlld0NoaWxkcmVuKE9wY3VhRGV2aWNlUHJvdG9jb2xNYXBwaW5nKSBpbnN0YW5jZUxpc3Q6IFF1ZXJ5TGlzdDxPcGN1YURldmljZVByb3RvY29sTWFwcGluZz47XG5cbiAgaW5pdGlhbE1vZGVsOiBPcGN1YURldmljZVR5cGUgPSB7XG4gICAgaWQ6ICcnLFxuICAgIGZpZWxkYnVzVHlwZTogJ29wY3VhVjInLFxuICAgIGRlc2NyaXB0aW9uOiAnJyxcbiAgICB1bml0OiAnJyxcbiAgICBmaWVsZGJ1c1ZlcnNpb246IDQsXG4gICAgbmFtZTogJycsXG4gICAgcmVmZXJlbmNlZFNlcnZlcklkOiAnJyxcbiAgICByZWZlcmVuY2VkUm9vdE5vZGVJZDogJycsXG4gICAgc3Vic2NyaXB0aW9uVHlwZToge1xuICAgICAgdHlwZTogJ05vbmUnXG4gICAgfSxcbiAgICBtYXBwaW5nczogW10sXG4gICAgb3ZlcnJpZGRlblN1YnNjcmlwdGlvbnM6IFtdLFxuICAgIGFwcGx5Q29uc3RyYWludHM6IHtcbiAgICAgIGJyb3dzZVBhdGhNYXRjaGVzUmVnZXg6ICcnLFxuICAgICAgbWF0Y2hlc05vZGVJZHM6IFtdLFxuICAgICAgc2VydmVyT2JqZWN0SGFzRnJhZ21lbnQ6ICcnLFxuICAgICAgbWF0Y2hlc1NlcnZlcklkczogW11cbiAgICB9LFxuICAgIGVuYWJsZWQ6ICcnXG4gIH07XG5cbiAgbW9kZWw6IGFueTtcbiAgc2VydmVyOiBhbnk7XG4gIHNlbGVjdGVkTm9kZTogYW55O1xuICBpc0xvYWRlZCA9IHRydWU7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjaGFuZ2VEZXRlY3RvclJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgcHJpdmF0ZSBvcGN1YVNlcnZpY2U6IE9wY3VhU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXJcbiAgKSB7fVxuXG4gIG5nQWZ0ZXJDb250ZW50Q2hlY2tlZCgpIHtcbiAgICB0aGlzLmNoYW5nZURldGVjdG9yUmVmLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIGdldFBhcmVudEF0dHIgPSBrZXkgPT4gZ2V0KHRoaXMubW9kZWwsIGtleSk7XG5cbiAgZ2V0TWFwcGluZygpIHtcbiAgICByZXR1cm4gdGhpcy5tb2RlbC5tYXBwaW5ncztcbiAgfVxuXG4gIGdldEVtcHR5TWFwcGluZ09iamVjdCgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgaWQ6ICduZXcnLFxuICAgICAgYnJvd3NlUGF0aDogW11cbiAgICB9O1xuICB9XG5cbiAgZ2V0T3ZlcnJpZGRlblN1YnNjcmlwdGlvbnNCeVBhdGgoYnJvd3NlUGF0aCkge1xuICAgIHJldHVybiBmaW5kKHRoaXMubW9kZWwub3ZlcnJpZGRlblN1YnNjcmlwdGlvbnMsIHsgYnJvd3NlUGF0aCB9KTtcbiAgfVxuXG4gIGdldFN0cnVjdHVyZWRSZXNvdXJjZShyZXNvdXJjZSkge1xuICAgIGNvbnN0IG92ZXJyaWRkZW5TdWJzY3JpcHRpb25zOiBhbnkgPSB0aGlzLmdldE92ZXJyaWRkZW5TdWJzY3JpcHRpb25zQnlQYXRoKHJlc291cmNlLmJyb3dzZVBhdGgpO1xuICAgIGxldCByZXN1bHQgPSBhc3NpZ24oe30sIHJlc291cmNlKTtcbiAgICBpZiAob3ZlcnJpZGRlblN1YnNjcmlwdGlvbnMpIHtcbiAgICAgIHJlc3VsdCA9IGFzc2lnbih7fSwgcmVzb3VyY2UsIHsgc3Vic2NyaXB0aW9uVHlwZTogb3ZlcnJpZGRlblN1YnNjcmlwdGlvbnMuc3Vic2NyaXB0aW9uVHlwZSB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxuXG4gIGFzeW5jIG5nT25Jbml0KCkge1xuICAgIGNvbnN0IGlkID0gdGhpcy5vcGN1YVNlcnZpY2UuZ2V0SWQoKTtcbiAgICBpZiAoaWQpIHtcbiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMub3BjdWFTZXJ2aWNlLmdldERldmljZVByb3RvY29sKGlkKTtcbiAgICAgIGlmIChyZXMgJiYgcmVzLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSByZXMuanNvbiA/IGF3YWl0IHJlcy5qc29uKCkgOiB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoeyBkYXRhLCByZXMgfSk7XG4gICAgICAgIHRoaXMuaXNMb2FkZWQgPSBmYWxzZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXMuanNvbigpO1xuICAgICAgICBpZiAoZGF0YSAmJiBkYXRhLmFwcGx5Q29uc3RyYWludHMgPT09IG51bGwpIHtcbiAgICAgICAgICBkZWxldGUgZGF0YS5hcHBseUNvbnN0cmFpbnRzO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhICYmIGRhdGEuc3Vic2NyaXB0aW9uVHlwZSA9PT0gbnVsbCkge1xuICAgICAgICAgIGRlbGV0ZSBkYXRhLnN1YnNjcmlwdGlvblR5cGU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5tb2RlbCA9IGFzc2lnbih0aGlzLmluaXRpYWxNb2RlbCwgZGF0YSk7XG4gICAgICAgIGlmICghdGhpcy5tb2RlbC5tYXBwaW5ncykge1xuICAgICAgICAgIHRoaXMubW9kZWwubWFwcGluZ3MgPSBbXTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLm1vZGVsID0gYXNzaWduKHRoaXMuaW5pdGlhbE1vZGVsLCB0aGlzLnVwZGF0ZVZpYWJsZU1hcHBpbmcoZGF0YSkpO1xuICAgICAgICB0aGlzLmlzTG9hZGVkID0gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgdXBkYXRlVmlhYmxlTWFwcGluZyhtb2RlbCkge1xuICAgIGNvbnN0IHsgbWFwcGluZ3MgfSA9IG1vZGVsO1xuICAgIGxldCByZXN1bHQgPSBbXTtcbiAgICBpZiAobWFwcGluZ3MpIHtcbiAgICAgIHJlc3VsdCA9IG1hcHBpbmdzLm1hcCgoaXRlbSwgaSkgPT4ge1xuICAgICAgICByZXR1cm4gYXNzaWduKGl0ZW0sIHsgaWQ6IGkgfSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGFzc2lnbihtb2RlbCwgeyBtYXBwaW5nczogcmVzdWx0IH0pO1xuICB9XG5cbiAgdHJhY2tCeUluZGV4KGluZGV4OiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiBpbmRleDtcbiAgfVxuXG4gIGFkZFZhcmlhYmxlKCkge1xuICAgIHRoaXMubW9kZWwubWFwcGluZ3MucHVzaCh0aGlzLmdldEVtcHR5TWFwcGluZ09iamVjdCgpKTtcbiAgfVxuXG4gIHVwZGF0ZVZhcmlhYmxlKG1hcHBpbmdPYmplY3QpIHtcbiAgICBjb25zdCB7IG1hcHBpbmdzIH0gPSB0aGlzLm1vZGVsO1xuICAgIGNvbnN0IGluZGV4ID0gZmluZEluZGV4KG1hcHBpbmdzLCB7IGlkOiBtYXBwaW5nT2JqZWN0LmlkIH0pO1xuICAgIG1hcHBpbmdzLnNwbGljZShpbmRleCwgMSk7XG4gICAgaWYgKG1hcHBpbmdPYmplY3QuaWQgPT09ICduZXcnKSB7XG4gICAgICBtYXBwaW5nT2JqZWN0LmlkID0gbWFwcGluZ3MubGVuZ3RoO1xuICAgIH1cbiAgICBtYXBwaW5ncy5wdXNoKG1hcHBpbmdPYmplY3QpO1xuICB9XG5cbiAgcmVtb3ZlVmFyaWFibGUobWFwcGluZ09iamVjdCkge1xuICAgIGNvbnN0IHsgbWFwcGluZ3MgfSA9IHRoaXMubW9kZWw7XG4gICAgY29uc3QgaW5kZXggPSBmaW5kSW5kZXgobWFwcGluZ3MsIHsgaWQ6IG1hcHBpbmdPYmplY3QuaWQgfSk7XG4gICAgbWFwcGluZ3Muc3BsaWNlKGluZGV4LCAxKTtcbiAgfVxuXG4gIGFjdGlvbkhhbmRsZXIoYWN0aW9uT2JqZWN0KSB7XG4gICAgc3dpdGNoIChhY3Rpb25PYmplY3QuYWN0aW9uKSB7XG4gICAgICBjYXNlICdzYXZlJzpcbiAgICAgICAgdGhpcy51cGRhdGVWYXJpYWJsZShhY3Rpb25PYmplY3QuZGF0YSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnZGVsZXRlJzpcbiAgICAgICAgdGhpcy5yZW1vdmVWYXJpYWJsZShhY3Rpb25PYmplY3QuZGF0YSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIGV4dHJhY3RPdmVycmlkU3Vic2NyaXB0aW9uVHlwZShfbWFwcGluZykge1xuICAgIGNvbnN0IG92ZXJyaWRkZW5TdWJzY3JpcHRpb25zID0gW107XG4gICAgY29uc3QgdmFyaWFibGVNYXBwaW5nID0gW107XG4gICAgX21hcHBpbmcuZm9yRWFjaChlbGVtZW50ID0+IHtcbiAgICAgIGlmIChlbGVtZW50LmlkICE9PSAnbmV3Jykge1xuICAgICAgICBpZiAoZWxlbWVudC5zdWJzY3JpcHRpb25UeXBlKSB7XG4gICAgICAgICAgb3ZlcnJpZGRlblN1YnNjcmlwdGlvbnMucHVzaChcbiAgICAgICAgICAgIGFzc2lnbihcbiAgICAgICAgICAgICAgeyBicm93c2VQYXRoOiBlbGVtZW50LmJyb3dzZVBhdGggfSxcbiAgICAgICAgICAgICAgeyBzdWJzY3JpcHRpb25UeXBlOiBlbGVtZW50LnN1YnNjcmlwdGlvblR5cGUgfVxuICAgICAgICAgICAgKVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyaWFibGVNYXBwaW5nLnB1c2gob21pdChlbGVtZW50LCBbJ3N1YnNjcmlwdGlvblR5cGUnXSkpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBbdmFyaWFibGVNYXBwaW5nLCBvdmVycmlkZGVuU3Vic2NyaXB0aW9uc107XG4gIH1cblxuICBwcmVwYXJlUmVxdWVzdEpzb24oX21vZGVsKSB7XG4gICAgbGV0IHJlcXVlc3RKc29uID0ge307XG4gICAgY29uc3QgW21hcHBpbmdzLCBvdmVycmlkZGVuU3Vic2NyaXB0aW9uc10gPSB0aGlzLmV4dHJhY3RPdmVycmlkU3Vic2NyaXB0aW9uVHlwZShcbiAgICAgIF9tb2RlbC5tYXBwaW5nc1xuICAgICk7XG4gICAgcmVxdWVzdEpzb24gPSBhc3NpZ24ocmVxdWVzdEpzb24sIHBpY2soX21vZGVsLCBPYmplY3Qua2V5cyh0aGlzLmluaXRpYWxNb2RlbCkpLCB7XG4gICAgICBtYXBwaW5ncyxcbiAgICAgIG92ZXJyaWRkZW5TdWJzY3JpcHRpb25zXG4gICAgfSk7XG4gICAgcmV0dXJuIHJlcXVlc3RKc29uO1xuICB9XG5cbiAgYXN5bmMgc2F2ZSgpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzID0gYXdhaXQgdGhpcy5vcGN1YVNlcnZpY2UudXBkYXRlRGV2aWNlUHJvdG9jb2wodGhpcy5wcmVwYXJlUmVxdWVzdEpzb24odGhpcy5tb2RlbCkpO1xuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7XG5cbiAgICAgIGlmIChyZXMgJiYgcmVzLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnZGV2aWNlcHJvdG9jb2xzJ10pO1xuICAgICAgICB0aGlzLmFsZXJ0U2VydmljZS5zdWNjZXNzKGdldHRleHQoJ0RldmljZSBwcm90b2NvbCBzYXZlZC4nKSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCB7IGRldGFpbHMgfSA9IGRhdGE7XG4gICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoeyByZXMsIGRhdGE6IGRldGFpbHMgfSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmRhbmdlcihnZXR0ZXh0KCdGYWlsZWQgdG8gc2F2ZS4gVHJ5IGFnYWluLicpKTtcbiAgICB9XG4gIH1cblxuICBjYW5TYXZlKGRldmljZVR5cGVGb3JtKSB7XG4gICAgaWYgKHRoaXMuaW5zdGFuY2VMaXN0KSB7XG4gICAgICBjb25zdCBhY3RpdmVJbnN0YW5jZXMgPSB0aGlzLmluc3RhbmNlTGlzdC5maWx0ZXIoaXRlbSA9PiBpdGVtLmlzQWN0aXZlKCkpO1xuXG4gICAgICBpZiAoYWN0aXZlSW5zdGFuY2VzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiAhZGV2aWNlVHlwZUZvcm0uZm9ybS52YWxpZDtcbiAgfVxufVxuIl19