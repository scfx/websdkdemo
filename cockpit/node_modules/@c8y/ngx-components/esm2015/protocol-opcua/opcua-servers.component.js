import { __awaiter } from "tslib";
import { Component, Optional } from '@angular/core';
import { AlertService, ContextRouteComponent, gettext } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
import { OpcuaService } from './opcuaService';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './opcuaService';
import * as ɵngcc2 from '@c8y/ngx-components';
import * as ɵngcc3 from '@ngx-translate/core';
import * as ɵngcc4 from 'ngx-bootstrap/popover';
import * as ɵngcc5 from './opcua-server-list.component';
import * as ɵngcc6 from './opcua-server-config.component';
import * as ɵngcc7 from '@angular/common';

const _c0 = function (a0) { return { "split-view__detail--selected": a0 }; };
export class OpcuaServersComponent {
    constructor(opcuaService, alertService, translateService, context) {
        this.opcuaService = opcuaService;
        this.alertService = alertService;
        this.translateService = translateService;
        this.context = context;
        this.serverObjectList = [];
        this.initialServerObject = {
            id: '',
            name: 'New Server',
            config: {
                securityMode: 'NONE',
                keystorePass: null,
                keystoreBinaryId: null,
                keystoreFilename: '',
                certificatePass: null,
                serverUrl: '',
                userName: '',
                userPassword: '',
                rescanCron: null,
                timeout: null,
                autoReconnect: true,
                statusCheckInterval: null,
                valid: true
            },
            quickInfo: {
                padlock: 'unlock',
                padlockMsg: ''
            },
            active: true
        };
        this.active = false;
        this.moId = '';
        this.NEW_SERVER_ID = 'new';
        this.initialServerObject.id = this.NEW_SERVER_ID;
    }
    ngOnInit() {
        return __awaiter(this, void 0, void 0, function* () {
            this.moId = this.opcuaService.getMoId();
            if (this.moId && this.moId.length > 0) {
                const res = yield this.opcuaService.getServers(this.moId);
                if (res && res.status !== 200) {
                    const data = res.json ? yield res.json() : undefined;
                    this.alertService.addServerFailure({ data, res });
                }
                else {
                    this.serverObjectList = (yield res.json());
                    this.serverObjectList.map(server => this.setQuickInfo(server));
                }
            }
        });
    }
    localServerObjectExist() {
        return !!this.serverObjectList.find(server => server.id === this.NEW_SERVER_ID);
    }
    addServer() {
        const server = this.initialServerObject;
        this.serverObjectList.push(server);
        this.onPresent(server);
    }
    onSaved(server) {
        if (server && server.id) {
            server.gatewayId = this.moId;
            if (server.id === this.NEW_SERVER_ID) {
                this.createServer(server);
            }
            else {
                this.updateServer(server);
            }
        }
    }
    reloadTabs() {
        if (this.context) {
            this.context.refreshTabs();
        }
    }
    onCanceled(server) {
        if (server && server.id && server.id === this.NEW_SERVER_ID) {
            this.removeServerObjectListById(server.id);
        }
        else {
            // update activity status for UI
            this.serverObjectList.forEach(item => {
                if (item.id === server.id) {
                    item.active = false;
                }
            });
            // When server id is not 'new' we just close the details
            delete this.server;
        }
    }
    onRemoved(server) {
        if (server.id === this.NEW_SERVER_ID) {
            this.onCanceled(server);
        }
        else {
            this.removeServer(server);
        }
    }
    getKeystore(binaryId) {
        return __awaiter(this, void 0, void 0, function* () {
            const { data } = yield this.opcuaService.getKeystore(binaryId);
            return data;
        });
    }
    onPresent(server) {
        return __awaiter(this, void 0, void 0, function* () {
            if (server &&
                server.id !== this.NEW_SERVER_ID &&
                server.config &&
                server.config.keystoreBinaryId) {
                try {
                    const mo = yield this.getKeystore(server.config.keystoreBinaryId);
                    server.config.keystoreFilename = mo.name;
                }
                catch (ex) {
                    this.server = Object.assign({}, server);
                    console.log('Could not get existing keystore:', ex);
                }
            }
            if (this.serverObjectList.length > 0) {
                this.serverObjectList.forEach(item => {
                    item.active = false;
                    if (item.id === server.id) {
                        item.active = true;
                        server.active = item.active;
                    }
                });
                this.setQuickInfo(server);
                this.server = Object.assign({}, server);
            }
        });
    }
    createServer(server) {
        return __awaiter(this, void 0, void 0, function* () {
            const response = yield this.opcuaService.createServer(server);
            const svr = (yield response.json());
            this.updateServerObjectListById(this.NEW_SERVER_ID, svr);
            this.reloadTabs();
        });
    }
    updateServer(server) {
        return __awaiter(this, void 0, void 0, function* () {
            const updatedServer = (yield this.opcuaService.updateServer(server));
            if (updatedServer) {
                this.updateServerObjectListById(updatedServer.id, updatedServer);
            }
        });
    }
    removeServer(server) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                yield this.opcuaService.removeServer(server);
                this.removeServerObjectListById(server.id);
                this.reloadTabs();
            }
            catch (ex) {
                console.log('Could not remove OPC UA server:', ex);
            }
        });
    }
    removeServerObjectListById(id) {
        this.serverObjectList.forEach((item, index) => {
            if (item.id === id) {
                this.serverObjectList.splice(index, 1);
                delete this.server;
            }
        });
    }
    updateServerObjectListById(id, server) {
        const idx = this.serverObjectList.findIndex(item => item.id === id);
        if (idx > -1) {
            this.setQuickInfo(server);
            this.serverObjectList[idx] = server;
        }
        delete this.server;
    }
    setQuickInfo(server) {
        server.quickInfo = {
            padlock: 'unlock',
            padlockMsg: ''
        };
        if (server && server.config) {
            if (server.config.securityMode) {
                server.quickInfo.padlock = server.config.securityMode !== 'NONE' ? 'lock' : 'unlock';
                server.quickInfo.padlockMsg = this.translateService.instant(gettext('The security policy is set to {{param}}.'), { param: server.config.securityMode });
            }
        }
    }
}
OpcuaServersComponent.ɵfac = function OpcuaServersComponent_Factory(t) { return new (t || OpcuaServersComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.OpcuaService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.AlertService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.TranslateService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.ContextRouteComponent, 8)); };
OpcuaServersComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: OpcuaServersComponent, selectors: [["opcua-servers"]], decls: 18, vars: 16, consts: [[1, "card", "content-fullpage", "split-view--5-7"], [1, "card-header", "grid__col--fullspan", "separator"], [1, "card-title"], ["placement", "right", "triggers", "focus", 1, "btn-clean", "m-l-4", 3, "popover"], ["c8yIcon", "question-circle-o", 1, "text-info"], [1, "inner-scroll", "split-view__list"], [1, "bg-gray-white", "flex-grow"], [1, "c8y-nav-stacked"], [3, "serverList", "present"], [1, "card-footer", "separator", "sticky-bottom"], [1, "btn", "btn-default", 3, "title", "disabled", "click"], [3, "c8yIcon"], [1, "inner-scroll", "split-view__detail", 3, "ngClass", "server", "canceled", "removed", "saved"]], template: function OpcuaServersComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "div", 0);
        ɵngcc0.ɵɵelementStart(1, "div", 1);
        ɵngcc0.ɵɵelementStart(2, "h4", 2);
        ɵngcc0.ɵɵtext(3, "OPC UA servers");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(4, "button", 3);
        ɵngcc0.ɵɵpipe(5, "translate");
        ɵngcc0.ɵɵelement(6, "i", 4);
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(7, "div", 5);
        ɵngcc0.ɵɵelementStart(8, "div", 6);
        ɵngcc0.ɵɵelementStart(9, "div", 7);
        ɵngcc0.ɵɵelementStart(10, "opcua-server-list", 8);
        ɵngcc0.ɵɵlistener("present", function OpcuaServersComponent_Template_opcua_server_list_present_10_listener($event) { return ctx.onPresent($event); });
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(11, "div", 9);
        ɵngcc0.ɵɵelementStart(12, "button", 10);
        ɵngcc0.ɵɵlistener("click", function OpcuaServersComponent_Template_button_click_12_listener() { return ctx.addServer(); });
        ɵngcc0.ɵɵpipe(13, "translate");
        ɵngcc0.ɵɵelement(14, "i", 11);
        ɵngcc0.ɵɵtext(15);
        ɵngcc0.ɵɵpipe(16, "translate");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(17, "opcua-server-config", 12);
        ɵngcc0.ɵɵlistener("canceled", function OpcuaServersComponent_Template_opcua_server_config_canceled_17_listener($event) { return ctx.onCanceled($event); })("removed", function OpcuaServersComponent_Template_opcua_server_config_removed_17_listener($event) { return ctx.onRemoved($event); })("saved", function OpcuaServersComponent_Template_opcua_server_config_saved_17_listener($event) { return ctx.onSaved($event); });
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵadvance(4);
        ɵngcc0.ɵɵpropertyInterpolate("popover", ɵngcc0.ɵɵpipeBind1(5, 8, "Below you can configure one or more OPC UA servers. The OPC UA agent will connect to these servers if they are enabled and the connection state is set to connected."));
        ɵngcc0.ɵɵadvance(6);
        ɵngcc0.ɵɵproperty("serverList", ctx.serverObjectList);
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(13, 10, "Add server"));
        ɵngcc0.ɵɵproperty("disabled", ctx.localServerObjectExist());
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("c8yIcon", "plus-circle");
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(16, 12, "Add server"), " ");
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction1(14, _c0, ctx.server))("server", ctx.server);
    } }, directives: [ɵngcc4.PopoverDirective, ɵngcc2.IconDirective, ɵngcc5.OpcuaServerListComponent, ɵngcc6.OpcuaServerConfigComponent, ɵngcc7.NgClass], pipes: [ɵngcc2.C8yTranslatePipe], encapsulation: 2 });
OpcuaServersComponent.ctorParameters = () => [
    { type: OpcuaService },
    { type: AlertService },
    { type: TranslateService },
    { type: ContextRouteComponent, decorators: [{ type: Optional }] }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(OpcuaServersComponent, [{
        type: Component,
        args: [{
                selector: 'opcua-servers',
                template: "<div class=\"card content-fullpage split-view--5-7\">\n  <div class=\"card-header grid__col--fullspan separator\">\n    <h4 class=\"card-title\">OPC UA servers</h4>\n    <button class=\"btn-clean m-l-4\"\n      popover=\"{{ 'Below you can configure one or more OPC UA servers. The OPC UA agent will connect to these servers if they are enabled and the connection state is set to connected.' | translate }}\"\n      placement=\"right\"\n      triggers=\"focus\"\n    >\n      <i c8yIcon=\"question-circle-o\" class=\"text-info \"></i>\n    </button>\n  </div>\n  <div class=\"inner-scroll split-view__list\">\n    <div class=\"bg-gray-white flex-grow\">\n      <div class=\"c8y-nav-stacked\">\n        <opcua-server-list [serverList]=\"serverObjectList\" (present)=\"onPresent($event)\">\n        </opcua-server-list>\n      </div>\n    </div>\n    <div class=\"card-footer separator sticky-bottom\">\n      <button\n        title=\"{{ 'Add server' | translate }}\"\n        class=\"btn btn-default\"\n        [disabled]=\"localServerObjectExist()\"\n        (click)=\"addServer()\"\n      >\n        <i [c8yIcon]=\"'plus-circle'\"></i>\n        {{ 'Add server' | translate }}\n      </button>\n    </div>\n  </div>\n\n  <opcua-server-config\n    class=\"inner-scroll split-view__detail\"\n    [ngClass]=\"{ 'split-view__detail--selected': server }\"\n    (canceled)=\"onCanceled($event)\"\n    (removed)=\"onRemoved($event)\"\n    (saved)=\"onSaved($event)\"\n    [server]=\"server\"\n  >\n  </opcua-server-config>\n</div>\n"
            }]
    }], function () { return [{ type: ɵngcc1.OpcuaService }, { type: ɵngcc2.AlertService }, { type: ɵngcc3.TranslateService }, { type: ɵngcc2.ContextRouteComponent, decorators: [{
                type: Optional
            }] }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtc2VydmVycy5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3Byb3RvY29sLW9wY3VhL29wY3VhLXNlcnZlcnMuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1RCxPQUFPLEVBQUUsWUFBWSxFQUFFLHFCQUFxQixFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ25GLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXZELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7Ozs7Ozs7QUFNOUMsTUFBTSxPQUFPLHFCQUFxQjtBQUFHLElBK0JuQyxZQUNVLFlBQTBCLEVBQzFCLFlBQTBCLEVBQzFCLGdCQUFrQyxFQUN0QixPQUE4QjtBQUNuRCxRQUpTLGlCQUFZLEdBQVosWUFBWSxDQUFjO0FBQUMsUUFDM0IsaUJBQVksR0FBWixZQUFZLENBQWM7QUFBQyxRQUMzQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO0FBQUMsUUFDdkIsWUFBTyxHQUFQLE9BQU8sQ0FBdUI7QUFDdEQsUUFuQ0UscUJBQWdCLEdBQWtCLEVBQUUsQ0FBQztBQUN2QyxRQUFFLHdCQUFtQixHQUFnQjtBQUNyQyxZQUFJLEVBQUUsRUFBRSxFQUFFO0FBQ1YsWUFBSSxJQUFJLEVBQUUsWUFBWTtBQUN0QixZQUFJLE1BQU0sRUFBRTtBQUNaLGdCQUFNLFlBQVksRUFBRSxNQUFNO0FBQzFCLGdCQUFNLFlBQVksRUFBRSxJQUFJO0FBQ3hCLGdCQUFNLGdCQUFnQixFQUFFLElBQUk7QUFDNUIsZ0JBQU0sZ0JBQWdCLEVBQUUsRUFBRTtBQUMxQixnQkFBTSxlQUFlLEVBQUUsSUFBSTtBQUMzQixnQkFBTSxTQUFTLEVBQUUsRUFBRTtBQUNuQixnQkFBTSxRQUFRLEVBQUUsRUFBRTtBQUNsQixnQkFB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b20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlLCBDb250ZXh0Um91dGVDb21wb25lbnQsIGdldHRleHQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IE9wY3VhU2VydmVyIH0gZnJvbSAnLi9vcGN1YS1zZXJ2ZXIuaW50ZXJmYWNlJztcbmltcG9ydCB7IE9wY3VhU2VydmljZSB9IGZyb20gJy4vb3BjdWFTZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnb3BjdWEtc2VydmVycycsXG4gIHRlbXBsYXRlVXJsOiAnLi9vcGN1YS1zZXJ2ZXJzLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBPcGN1YVNlcnZlcnNDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICBzZXJ2ZXJPYmplY3RMaXN0OiBPcGN1YVNlcnZlcltdID0gW107XG4gIGluaXRpYWxTZXJ2ZXJPYmplY3Q6IE9wY3VhU2VydmVyID0ge1xuICAgIGlkOiAnJyxcbiAgICBuYW1lOiAnTmV3IFNlcnZlcicsXG4gICAgY29uZmlnOiB7XG4gICAgICBzZWN1cml0eU1vZGU6ICdOT05FJyxcbiAgICAgIGtleXN0b3JlUGFzczogbnVsbCxcbiAgICAgIGtleXN0b3JlQmluYXJ5SWQ6IG51bGwsXG4gICAgICBrZXlzdG9yZUZpbGVuYW1lOiAnJyxcbiAgICAgIGNlcnRpZmljYXRlUGFzczogbnVsbCxcbiAgICAgIHNlcnZlclVybDogJycsXG4gICAgICB1c2VyTmFtZTogJycsXG4gICAgICB1c2VyUGFzc3dvcmQ6ICcnLFxuICAgICAgcmVzY2FuQ3JvbjogbnVsbCxcbiAgICAgIHRpbWVvdXQ6IG51bGwsXG4gICAgICBhdXRvUmVjb25uZWN0OiB0cnVlLFxuICAgICAgc3RhdHVzQ2hlY2tJbnRlcnZhbDogbnVsbCxcbiAgICAgIHZhbGlkOiB0cnVlXG4gICAgfSxcbiAgICBxdWlja0luZm86IHtcbiAgICAgIHBhZGxvY2s6ICd1bmxvY2snLFxuICAgICAgcGFkbG9ja01zZzogJydcbiAgICB9LFxuICAgIGFjdGl2ZTogdHJ1ZVxuICB9O1xuICBzZXJ2ZXI6IE9wY3VhU2VydmVyO1xuICBhY3RpdmU6IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBtb0lkOiBzdHJpbmc7XG4gIHByaXZhdGUgTkVXX1NFUlZFUl9JRDogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgb3BjdWFTZXJ2aWNlOiBPcGN1YVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhbGVydFNlcnZpY2U6IEFsZXJ0U2VydmljZSxcbiAgICBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBjb250ZXh0OiBDb250ZXh0Um91dGVDb21wb25lbnRcbiAgKSB7XG4gICAgdGhpcy5tb0lkID0gJyc7XG4gICAgdGhpcy5ORVdfU0VSVkVSX0lEID0gJ25ldyc7XG4gICAgdGhpcy5pbml0aWFsU2VydmVyT2JqZWN0LmlkID0gdGhpcy5ORVdfU0VSVkVSX0lEO1xuICB9XG5cbiAgYXN5bmMgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5tb0lkID0gdGhpcy5vcGN1YVNlcnZpY2UuZ2V0TW9JZCgpO1xuICAgIGlmICh0aGlzLm1vSWQgJiYgdGhpcy5tb0lkLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMub3BjdWFTZXJ2aWNlLmdldFNlcnZlcnModGhpcy5tb0lkKTtcbiAgICAgIGlmIChyZXMgJiYgcmVzLnN0YXR1cyAhPT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSByZXMuanNvbiA/IGF3YWl0IHJlcy5qc29uKCkgOiB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoeyBkYXRhLCByZXMgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnNlcnZlck9iamVjdExpc3QgPSAoYXdhaXQgcmVzLmpzb24oKSkgYXMgT3BjdWFTZXJ2ZXJbXTtcbiAgICAgICAgdGhpcy5zZXJ2ZXJPYmplY3RMaXN0Lm1hcChzZXJ2ZXIgPT4gdGhpcy5zZXRRdWlja0luZm8oc2VydmVyKSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgbG9jYWxTZXJ2ZXJPYmplY3RFeGlzdCgpIHtcbiAgICByZXR1cm4gISF0aGlzLnNlcnZlck9iamVjdExpc3QuZmluZChzZXJ2ZXIgPT4gc2VydmVyLmlkID09PSB0aGlzLk5FV19TRVJWRVJfSUQpO1xuICB9XG5cbiAgYWRkU2VydmVyKCkge1xuICAgIGNvbnN0IHNlcnZlcjogT3BjdWFTZXJ2ZXIgPSB0aGlzLmluaXRpYWxTZXJ2ZXJPYmplY3Q7XG4gICAgdGhpcy5zZXJ2ZXJPYmplY3RMaXN0LnB1c2goc2VydmVyKTtcbiAgICB0aGlzLm9uUHJlc2VudChzZXJ2ZXIpO1xuICB9XG5cbiAgb25TYXZlZChzZXJ2ZXI6IE9wY3VhU2VydmVyKSB7XG4gICAgaWYgKHNlcnZlciAmJiBzZXJ2ZXIuaWQpIHtcbiAgICAgIHNlcnZlci5nYXRld2F5SWQgPSB0aGlzLm1vSWQ7XG4gICAgICBpZiAoc2VydmVyLmlkID09PSB0aGlzLk5FV19TRVJWRVJfSUQpIHtcbiAgICAgICAgdGhpcy5jcmVhdGVTZXJ2ZXIoc2VydmVyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMudXBkYXRlU2VydmVyKHNlcnZlcik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmVsb2FkVGFicygpIHtcbiAgICBpZiAodGhpcy5jb250ZXh0KSB7XG4gICAgICB0aGlzLmNvbnRleHQucmVmcmVzaFRhYnMoKTtcbiAgICB9XG4gIH1cblxuICBvbkNhbmNlbGVkKHNlcnZlcjogT3BjdWFTZXJ2ZXIpIHtcbiAgICBpZiAoc2VydmVyICYmIHNlcnZlci5pZCAmJiBzZXJ2ZXIuaWQgPT09IHRoaXMuTkVXX1NFUlZFUl9JRCkge1xuICAgICAgdGhpcy5yZW1vdmVTZXJ2ZXJPYmplY3RMaXN0QnlJZChzZXJ2ZXIuaWQpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyB1cGRhdGUgYWN0aXZpdHkgc3RhdHVzIGZvciBVSVxuICAgICAgdGhpcy5zZXJ2ZXJPYmplY3RMaXN0LmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgIGlmIChpdGVtLmlkID09PSBzZXJ2ZXIuaWQpIHtcbiAgICAgICAgICBpdGVtLmFjdGl2ZSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIC8vIFdoZW4gc2VydmVyIGlkIGlzIG5vdCAnbmV3JyB3ZSBqdXN0IGNsb3NlIHRoZSBkZXRhaWxzXG4gICAgICBkZWxldGUgdGhpcy5zZXJ2ZXI7XG4gICAgfVxuICB9XG5cbiAgb25SZW1vdmVkKHNlcnZlcjogT3BjdWFTZXJ2ZXIpIHtcbiAgICBpZiAoc2VydmVyLmlkID09PSB0aGlzLk5FV19TRVJWRVJfSUQpIHtcbiAgICAgIHRoaXMub25DYW5jZWxlZChzZXJ2ZXIpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnJlbW92ZVNlcnZlcihzZXJ2ZXIpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldEtleXN0b3JlKGJpbmFyeUlkOiBzdHJpbmcpIHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMub3BjdWFTZXJ2aWNlLmdldEtleXN0b3JlKGJpbmFyeUlkKTtcbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuXG4gIGFzeW5jIG9uUHJlc2VudChzZXJ2ZXI6IE9wY3VhU2VydmVyKSB7XG4gICAgaWYgKFxuICAgICAgc2VydmVyICYmXG4gICAgICBzZXJ2ZXIuaWQgIT09IHRoaXMuTkVXX1NFUlZFUl9JRCAmJlxuICAgICAgc2VydmVyLmNvbmZpZyAmJlxuICAgICAgc2VydmVyLmNvbmZpZy5rZXlzdG9yZUJpbmFyeUlkXG4gICAgKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBtbyA9IGF3YWl0IHRoaXMuZ2V0S2V5c3RvcmUoc2VydmVyLmNvbmZpZy5rZXlzdG9yZUJpbmFyeUlkKTtcbiAgICAgICAgc2VydmVyLmNvbmZpZy5rZXlzdG9yZUZpbGVuYW1lID0gbW8ubmFtZTtcbiAgICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAgIHRoaXMuc2VydmVyID0gT2JqZWN0LmFzc2lnbih7fSwgc2VydmVyKTtcbiAgICAgICAgY29uc29sZS5sb2coJ0NvdWxkIG5vdCBnZXQgZXhpc3Rpbmcga2V5c3RvcmU6JywgZXgpO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAodGhpcy5zZXJ2ZXJPYmplY3RMaXN0Lmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuc2VydmVyT2JqZWN0TGlzdC5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICBpdGVtLmFjdGl2ZSA9IGZhbHNlO1xuXG4gICAgICAgIGlmIChpdGVtLmlkID09PSBzZXJ2ZXIuaWQpIHtcbiAgICAgICAgICBpdGVtLmFjdGl2ZSA9IHRydWU7XG4gICAgICAgICAgc2VydmVyLmFjdGl2ZSA9IGl0ZW0uYWN0aXZlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc2V0UXVpY2tJbmZvKHNlcnZlcik7XG4gICAgICB0aGlzLnNlcnZlciA9IE9iamVjdC5hc3NpZ24oe30sIHNlcnZlcik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjcmVhdGVTZXJ2ZXIoc2VydmVyOiBPcGN1YVNlcnZlcikge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5vcGN1YVNlcnZpY2UuY3JlYXRlU2VydmVyKHNlcnZlcik7XG4gICAgY29uc3Qgc3ZyID0gKGF3YWl0IHJlc3BvbnNlLmpzb24oKSkgYXMgT3BjdWFTZXJ2ZXI7XG4gICAgdGhpcy51cGRhdGVTZXJ2ZXJPYmplY3RMaXN0QnlJZCh0aGlzLk5FV19TRVJWRVJfSUQsIHN2cik7XG4gICAgdGhpcy5yZWxvYWRUYWJzKCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHVwZGF0ZVNlcnZlcihzZXJ2ZXI6IE9wY3VhU2VydmVyKSB7XG4gICAgY29uc3QgdXBkYXRlZFNlcnZlciA9IChhd2FpdCB0aGlzLm9wY3VhU2VydmljZS51cGRhdGVTZXJ2ZXIoc2VydmVyKSkgYXMgT3BjdWFTZXJ2ZXI7XG4gICAgaWYgKHVwZGF0ZWRTZXJ2ZXIpIHtcbiAgICAgIHRoaXMudXBkYXRlU2VydmVyT2JqZWN0TGlzdEJ5SWQodXBkYXRlZFNlcnZlci5pZCwgdXBkYXRlZFNlcnZlcik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZW1vdmVTZXJ2ZXIoc2VydmVyOiBPcGN1YVNlcnZlcikge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLm9wY3VhU2VydmljZS5yZW1vdmVTZXJ2ZXIoc2VydmVyKTtcbiAgICAgIHRoaXMucmVtb3ZlU2VydmVyT2JqZWN0TGlzdEJ5SWQoc2VydmVyLmlkKTtcbiAgICAgIHRoaXMucmVsb2FkVGFicygpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICBjb25zb2xlLmxvZygnQ291bGQgbm90IHJlbW92ZSBPUEMgVUEgc2VydmVyOicsIGV4KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZVNlcnZlck9iamVjdExpc3RCeUlkKGlkOiBzdHJpbmcpIHtcbiAgICB0aGlzLnNlcnZlck9iamVjdExpc3QuZm9yRWFjaCgoaXRlbSwgaW5kZXgpID0+IHtcbiAgICAgIGlmIChpdGVtLmlkID09PSBpZCkge1xuICAgICAgICB0aGlzLnNlcnZlck9iamVjdExpc3Quc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgZGVsZXRlIHRoaXMuc2VydmVyO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVTZXJ2ZXJPYmplY3RMaXN0QnlJZChpZDogc3RyaW5nLCBzZXJ2ZXI6IE9wY3VhU2VydmVyKSB7XG4gICAgY29uc3QgaWR4ID0gdGhpcy5zZXJ2ZXJPYmplY3RMaXN0LmZpbmRJbmRleChpdGVtID0+IGl0ZW0uaWQgPT09IGlkKTtcbiAgICBpZiAoaWR4ID4gLTEpIHtcbiAgICAgIHRoaXMuc2V0UXVpY2tJbmZvKHNlcnZlcik7XG4gICAgICB0aGlzLnNlcnZlck9iamVjdExpc3RbaWR4XSA9IHNlcnZlcjtcbiAgICB9XG4gICAgZGVsZXRlIHRoaXMuc2VydmVyO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRRdWlja0luZm8oc2VydmVyOiBPcGN1YVNlcnZlcikge1xuICAgIHNlcnZlci5xdWlja0luZm8gPSB7XG4gICAgICBwYWRsb2NrOiAndW5sb2NrJyxcbiAgICAgIHBhZGxvY2tNc2c6ICcnXG4gICAgfTtcblxuICAgIGlmIChzZXJ2ZXIgJiYgc2VydmVyLmNvbmZpZykge1xuICAgICAgaWYgKHNlcnZlci5jb25maWcuc2VjdXJpdHlNb2RlKSB7XG4gICAgICAgIHNlcnZlci5xdWlja0luZm8ucGFkbG9jayA9IHNlcnZlci5jb25maWcuc2VjdXJpdHlNb2RlICE9PSAnTk9ORScgPyAnbG9jaycgOiAndW5sb2NrJztcbiAgICAgICAgc2VydmVyLnF1aWNrSW5mby5wYWRsb2NrTXNnID0gdGhpcy50cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoXG4gICAgICAgICAgZ2V0dGV4dCgnVGhlIHNlY3VyaXR5IHBvbGljeSBpcyBzZXQgdG8ge3twYXJhbX19LicpLFxuICAgICAgICAgIHsgcGFyYW06IHNlcnZlci5jb25maWcuc2VjdXJpdHlNb2RlIH1cbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==