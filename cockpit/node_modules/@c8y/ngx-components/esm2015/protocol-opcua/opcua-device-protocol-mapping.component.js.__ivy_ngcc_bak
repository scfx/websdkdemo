import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { ControlContainer, NgModelGroup } from '@angular/forms';
import { AlertService } from '@c8y/ngx-components';
import { isEmpty, assign, unset, get, set, cloneDeep, isEqual } from 'lodash-es';
import { OpcuaDeviceProtocolObjectMapping } from './opcua-device-protocol-object-mapping.component';
import { AddressSpaceService } from './address-space.service';
export class OpcuaDeviceProtocolMapping {
    constructor(alertService, addressSpaceService) {
        this.alertService = alertService;
        this.addressSpaceService = addressSpaceService;
        this.onAction = new EventEmitter();
        this.isPathFocused = false;
        this.isBrowsePathUniq = true;
        this.dataReporting = 'default';
        this.isTreeOpen = false;
        this.isNew = false;
        this.resetModel = false;
        this.moId = '';
        this.getMappings = () => this.getParentAttr('mappings');
    }
    toggleDetail() {
        this.isDetailOpen = !this.isDetailOpen;
        if (this.resetModel) {
            this.initialFormSetup();
        }
    }
    ngOnInit() {
        this.dataReportingName = 'ReportingMode' + this.index;
        this.initialFormSetup();
    }
    ngOnChanges(changes) {
        if (changes._model.previousValue &&
            !isEqual(this._model, changes._model.previousValue.SimpleChange)) {
            if (this.mapping && this.mapping.name === this._model.name) {
                this.mapping.id = this._model.id;
            }
        }
    }
    initialFormSetup() {
        const mapping = {
            id: '',
            browsePath: [],
            name: '',
            subscriptionType: {
                type: 'None'
            }
        };
        const customAction = {
            headers: [{ key: 'Authorization', value: '' }, { key: 'Content-Type', value: '' }],
            bodyTemplate: '',
            type: 'HttpPost',
            endpoint: ''
        };
        this.mapping = assign({}, mapping, cloneDeep(this._model));
        if (isEmpty(this.mapping.browsePath)) {
            this.isNew = true;
            this.isDetailOpen = true;
        }
        else {
            this.browsePath = this.stringfyBrowsePath(this.mapping.browsePath);
            this.nodeDisplayName = this.mapping.name;
        }
        if (this.referencedRootNodeId) {
            this.referencedNode = { nodeId: this.referencedRootNodeId };
            this.addressSpaceService.triggerNodeToOpen({
                node: {
                    nodeId: this.referencedRootNodeId,
                    children: [],
                    expanded: false,
                    absolutePaths: [[]]
                },
                selectedAncestorIds: []
            });
        }
        else {
            this.referencedNode = { nodeId: '' };
        }
        if (get(this.mapping, 'customAction')) {
            this.customAction = assign(customAction, get(this.mapping, 'customAction'));
            this.customAction.headers = this.mapHeadersObjectToList(get(this.customAction, 'headers'));
        }
        else {
            this.customAction = assign({}, customAction);
        }
        unset(this.mapping, 'customAction');
        if (get(this._model, 'subscriptionType')) {
            this.dataReporting = 'custom';
        }
        else {
            this.dataReporting = 'default';
        }
        this.resetModel = false;
    }
    showAddressSpaceTree() {
        return !isEmpty(this.referencedServerId);
    }
    ngAfterViewInit() {
        if (get(this.mapping, 'subscriptionType') &&
            get(this.mapping, 'subscriptionType.type') !== 'None') {
            this.dataReporting = 'custom';
        }
    }
    mapHeadersObjectToList(headers) {
        if (Object.keys(headers).length > 0) {
            return Object.keys(headers).map(item => {
                return { key: item, value: headers[item] };
            });
        }
    }
    stringfyBrowsePath(path) {
        return JSON.stringify(path);
    }
    updateBrowsePath(node) {
        this.mapping.browsePath = node.relativePath;
        this.nodeDisplayName = node.displayName;
        this.mapping.name = this.nodeDisplayName;
        this.browsePath = this.stringfyBrowsePath(this.mapping.browsePath);
        this.browsePathModel.control.markAsDirty();
    }
    updateDisplayname() {
        this.mapping.name = this.nodeDisplayName;
    }
    updateBrowsePathInput() {
        if (this.browsePath) {
            try {
                this.mapping.browsePath = JSON.parse(this.browsePath);
            }
            catch (error) {
                return;
            }
        }
    }
    save() {
        if (this.dataReporting === 'default') {
            unset(this.mapping, 'subscriptionType');
        }
        if (get(this.mapping, 'measurementCreation')) {
            const { measurementCreation } = this.mapping;
            set(measurementCreation, 'fragmentName', get(measurementCreation, 'type'));
        }
        const { customAction } = this.subFormRef.value;
        let modifiedCustomAction;
        if (customAction.hasCustomAction) {
            const reducedHeaders = this.customAction.headers.reduce((result, item) => {
                result[item.key] = item.value;
                return result;
            }, {});
            modifiedCustomAction = assign({}, this.customAction, { headers: reducedHeaders });
        }
        this.onAction.emit({
            action: 'save',
            data: assign({}, this.mapping, { customAction: modifiedCustomAction })
        });
        this.isDetailOpen = false;
    }
    cancel() {
        this.isDetailOpen = false;
        this.resetModel = true;
        if (this.mapping.id === 'new') {
            this.onAction.emit({ action: 'delete', data: assign({}, this.mapping) });
        }
    }
    onDelete() {
        this.onAction.emit({ action: 'delete', data: this.mapping });
    }
    canSave(variableForm) {
        const areValid = () => variableForm.valid && this.objectMappingForm.$componentScope.mappingForm.$valid;
        const areDirty = () => variableForm.dirty || this.objectMappingForm.$componentScope.mappingForm.$dirty;
        return areValid() && areDirty();
    }
    isActive() {
        return this.isDetailOpen;
    }
    setTreeFromRefNode() {
        if (this.referencedRootNodeId) {
            this.addressSpaceService.triggerNodeToOpen({
                node: {
                    nodeId: this.referencedRootNodeId,
                    children: [],
                    expanded: false,
                    absolutePaths: [[]]
                },
                selectedAncestorIds: []
            });
        }
    }
}
OpcuaDeviceProtocolMapping.decorators = [
    { type: Component, args: [{
                selector: 'opcua-device-protocol-mapping',
                template: "<div class=\"list-group-item collapsible\" [ngClass]=\"{ expanded: isDetailOpen }\">\n  <div class=\"flex-row\" (click)=\"toggleDetail()\">\n    <div class=\"list-item-actions\">\n      <button class=\"btn btn-clean showOnHover flex-item-right\" title=\"{{ 'Delete' | translate }}\">\n        <i c8yIcon=\"minus-circle\" class=\"text-danger\" (click)=\"onDelete()\"></i>\n      </button>\n      <button\n        type=\"button\"\n        title=\"{{ 'Expand' | translate }}\"\n        class=\"collapse-btn\"\n        [ngClass]=\"{ active: isDetailOpen }\"\n      >\n        <i c8yIcon=\"chevron-down\"></i>\n      </button>\n    </div>\n\n    <div class=\"list-item-icon\">\n      <i c8yIcon=\"sliders\"></i>\n    </div>\n\n    <div class=\"list-item-body\">\n      <div class=\"row flex-row\">\n        <div class=\"col-sm-7 col-xs-12\">\n          <p>\n            {{ nodeDisplayName }}<br />\n            <small\n              *ngIf=\"mapping.browsePath.length > 0\"\n              class=\"text-muted text-truncate\"\n              title=\"{{ mapping.browsePath | json }}\"\n              >{{ mapping.browsePath | json }}</small\n            >\n          </p>\n          <p></p>\n        </div>\n        <div class=\"col-sm-4 col-xs-10\">\n          <div class=\"list-functionalities\">\n            <label class=\"small m-r-8 hidden-xs\" translate>Functionalities</label>&nbsp;\n            <c8y-object-mapping-status-icons [mapping]=\"mapping\"></c8y-object-mapping-status-icons>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class=\"detail\" [collapse]=\"!isDetailOpen\" [isAnimated]=\"true\">\n    <div class=\"form\" [ngModelGroup]=\"index\" #variableForm=\"ngModelGroup\" *ngIf=\"isDetailOpen\">\n      <div class=\"row p-t-8\">\n        <c8y-form-group class=\"col-md-4\" [status]=\"!isBrowsePathUniq ? 'error' : ''\">\n          <label translate>Path</label>\n          <div\n            class=\"dropdown\"\n            dropdown\n            #dropdown=\"bs-dropdown\"\n            [insideClick]=\"true\"\n            style=\"width:100%;\"\n          >\n            <input\n              class=\"form-control\"\n              c8yBrowsePathValidator\n              [getMappings]=\"getMappings\"\n              [model]=\"mapping\"\n              type=\"text\"\n              name=\"browsePath\"\n              dropdownToggle\n              placeholder=\"{{ 'e.g.' | translate }} {{ ['2:Node1', '2:SubNode1'] | json }}\"\n              [(ngModel)]=\"browsePath\"\n              (change)=\"updateBrowsePathInput()\"\n              (focus)=\"setTreeFromRefNode()\"\n              required\n              #browsePathModel=\"ngModel\"\n              autocomplete=\"off\"\n            />\n            <div\n              *dropdownMenu\n              class=\"dropdown-menu panel-inner-scroll\"\n              style=\"max-height:200px; width: 100%;\"\n            >\n              <opcua-address-space-tree\n                *ngIf=\"showAddressSpaceTree()\"\n                [node]=\"referencedNode\"\n                [moId]=\"referencedServerId\"\n                (selectedNode)=\"updateBrowsePath($event); dropdown.hide()\"\n              ></opcua-address-space-tree>\n            </div>\n          </div>\n          <c8y-messages>\n            <c8y-message\n              name=\"invalidBrowsePathNotation\"\n              text=\"{{ 'Must be a valid array of strings.' | translate }}\"\n            ></c8y-message>\n            <c8y-message\n              name=\"browsePathNotUnique\"\n              text=\"{{ 'Variable with this path is already added.' | translate }}\"\n            ></c8y-message>\n          </c8y-messages>\n        </c8y-form-group>\n\n        <c8y-form-group class=\"col-md-4\">\n          <label translate>Name</label>\n          <div class=\"input-group\">\n            <input\n              class=\"form-control\"\n              type=\"test\"\n              name=\"displayName\"\n              placeholder=\"{{ 'e.g. childDevice2' | translate }} \"\n              required\n              [(ngModel)]=\"nodeDisplayName\"\n              (change)=\"updateDisplayname()\"\n              autocomplete=\"off\"\n            />\n          </div>\n        </c8y-form-group>\n      </div>\n      <div class=\"row\" ngModelGroup=\"dataReportingSection\">\n        <c8y-form-group class=\"col-sm-4 col-md-3 col-lg-2\">\n          <label>\n            <span translate>Data reporting</span>\n          </label>\n          <div class=\"input-group\">\n            <label title=\"{{ 'Default' | translate }}\" class=\"c8y-radio radio-inline\">\n              <input\n                type=\"radio\"\n                [(ngModel)]=\"dataReporting\"\n                name=\"{{ dataReportingName }}\"\n                value=\"default\"\n              />\n              <span></span>\n              <span>{{ 'Default' | translate }}</span>\n            </label>\n            <label title=\"{{ 'Custom' | translate }}\" class=\"c8y-radio radio-inline\">\n              <input\n                type=\"radio\"\n                [(ngModel)]=\"dataReporting\"\n                name=\"{{ dataReportingName }}\"\n                value=\"custom\"\n              />\n              <span></span>\n              <span>{{ 'Custom' | translate }}</span>\n            </label>\n          </div>\n        </c8y-form-group>\n        <div\n          class=\"col-sm-8 col-md-9 col-lg-10\"\n          *ngIf=\"dataReporting === 'custom'\"\n          ngModelGroup=\"overriddenSubscription\"\n        >\n          <opcua-device-protocol-data-reporting\n            [model]=\"mapping\"\n          ></opcua-device-protocol-data-reporting>\n        </div>\n      </div>\n\n      <c8y-object-mapping [mapping]=\"mapping\" [hideAutoObserve]=\"true\"></c8y-object-mapping>\n      <div ngModelGroup=\"customAction\">\n        <opcua-device-protocol-mapping-customaction\n          [customAction]=\"customAction\"\n        ></opcua-device-protocol-mapping-customaction>\n      </div>\n      <button\n        title=\"{{ 'Cancel' | translate }}\"\n        id=\"cancelBtn\"\n        class=\"btn btn-default m-t-16 m-b-16\"\n        (click)=\"cancel()\"\n      >\n        {{ 'Cancel' | translate }}\n      </button>\n      <button\n        title=\"{{ 'Save' | translate }}\"\n        id=\"saveBtn\"\n        class=\"btn btn-primary m-t-16 m-b-16\"\n        (click)=\"save()\"\n        [disabled]=\"!canSave(variableForm)\"\n      >\n        {{ 'Save' | translate }}\n      </button>\n    </div>\n  </div>\n</div>\n",
                viewProviders: [{ provide: ControlContainer, useExisting: NgModelGroup }]
            },] }
];
OpcuaDeviceProtocolMapping.ctorParameters = () => [
    { type: AlertService },
    { type: AddressSpaceService }
];
OpcuaDeviceProtocolMapping.propDecorators = {
    objectMappingForm: [{ type: ViewChild, args: [OpcuaDeviceProtocolObjectMapping, { static: false },] }],
    subFormRef: [{ type: ViewChild, args: ['variableForm', { static: false },] }],
    browsePathModel: [{ type: ViewChild, args: ['browsePathModel', { static: false },] }],
    _model: [{ type: Input, args: ['resource',] }],
    index: [{ type: Input }],
    getParentAttr: [{ type: Input }],
    referencedServerId: [{ type: Input }],
    referencedRootNodeId: [{ type: Input }],
    onAction: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtZGV2aWNlLXByb3RvY29sLW1hcHBpbmcuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vcHJvdG9jb2wtb3BjdWEvb3BjdWEtZGV2aWNlLXByb3RvY29sLW1hcHBpbmcuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBRVQsWUFBWSxFQUNaLEtBQUssRUFDTCxNQUFNLEVBQ04sU0FBUyxFQUdWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBVSxnQkFBZ0IsRUFBZSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNyRixPQUFPLEVBQUUsWUFBWSxFQUFXLE1BQU0scUJBQXFCLENBQUM7QUFDNUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQWdCLFNBQVMsRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDL0YsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sa0RBQWtELENBQUM7QUFDcEcsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFPOUQsTUFBTSxPQUFPLDBCQUEwQjtJQTRCckMsWUFDVSxZQUEwQixFQUMxQixtQkFBd0M7UUFEeEMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQXBCeEMsYUFBUSxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBT2hFLGtCQUFhLEdBQUcsS0FBSyxDQUFDO1FBSXRCLHFCQUFnQixHQUFHLElBQUksQ0FBQztRQUN4QixrQkFBYSxHQUFHLFNBQVMsQ0FBQztRQUMxQixlQUFVLEdBQUcsS0FBSyxDQUFDO1FBQ25CLFVBQUssR0FBRyxLQUFLLENBQUM7UUFDZCxlQUFVLEdBQUcsS0FBSyxDQUFDO1FBRVgsU0FBSSxHQUFXLEVBQUUsQ0FBQztRQWExQixnQkFB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RUFBRSxDQUFDO2lCQUNwQjtnQkFDRCxtQkFBbUIsRUFBRSxFQUFFO2FBQ3hCLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQzs7O1lBeE9GLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsK0JBQStCO2dCQUN6Qyw0M01BQW1EO2dCQUNuRCxhQUFhLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLENBQUM7YUFDMUU7OztZQVRRLFlBQVk7WUFHWixtQkFBbUI7OztnQ0FRekIsU0FBUyxTQUFDLGdDQUFnQyxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRTt5QkFDN0QsU0FBUyxTQUFDLGNBQWMsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUU7OEJBQzNDLFNBQVMsU0FBQyxpQkFBaUIsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUU7cUJBRTlDLEtBQUssU0FBQyxVQUFVO29CQUNoQixLQUFLOzRCQUNMLEtBQUs7aUNBQ0wsS0FBSzttQ0FDTCxLQUFLO3VCQUNMLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDb21wb25lbnQsXG4gIE9uSW5pdCxcbiAgRXZlbnRFbWl0dGVyLFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBWaWV3Q2hpbGQsXG4gIE9uQ2hhbmdlcyxcbiAgU2ltcGxlQ2hhbmdlc1xufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5nRm9ybSwgQ29udHJvbENvbnRhaW5lciwgRm9ybUNvbnRyb2wsIE5nTW9kZWxHcm91cCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSwgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgaXNFbXB0eSwgYXNzaWduLCB1bnNldCwgZ2V0LCBzZXQsIHJlamVjdCwgZmluZCwgY2xvbmVEZWVwLCBpc0VxdWFsIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IE9wY3VhRGV2aWNlUHJvdG9jb2xPYmplY3RNYXBwaW5nIH0gZnJvbSAnLi9vcGN1YS1kZXZpY2UtcHJvdG9jb2wtb2JqZWN0LW1hcHBpbmcuY29tcG9uZW50JztcbmltcG9ydCB7IEFkZHJlc3NTcGFjZVNlcnZpY2UgfSBmcm9tICcuL2FkZHJlc3Mtc3BhY2Uuc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ29wY3VhLWRldmljZS1wcm90b2NvbC1tYXBwaW5nJyxcbiAgdGVtcGxhdGVVcmw6ICcuL29wY3VhLWRldmljZS1wcm90b2NvbC1tYXBwaW5nLmh0bWwnLFxuICB2aWV3UHJvdmlkZXJzOiBbeyBwcm92aWRlOiBDb250cm9sQ29udGFpbmVyLCB1c2VFeGlzdGluZzogTmdNb2RlbEdyb3VwIH1dXG59KVxuZXhwb3J0IGNsYXNzIE9wY3VhRGV2aWNlUHJvdG9jb2xNYXBwaW5nIGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMge1xuICBAVmlld0NoaWxkKE9wY3VhRGV2aWNlUHJvdG9jb2xPYmplY3RNYXBwaW5nLCB7IHN0YXRpYzogZmFsc2UgfSkgb2JqZWN0TWFwcGluZ0Zvcm06IGFueTtcbiAgQFZpZXdDaGlsZCgndmFyaWFibGVGb3JtJywgeyBzdGF0aWM6IGZhbHNlIH0pIHN1YkZvcm1SZWY6IGFueTtcbiAgQFZpZXdDaGlsZCgnYnJvd3NlUGF0aE1vZGVsJywgeyBzdGF0aWM6IGZhbHNlIH0pIGJyb3dzZVBhdGhNb2RlbDogYW55O1xuXG4gIEBJbnB1dCgncmVzb3VyY2UnKSBfbW9kZWw7XG4gIEBJbnB1dCgpIGluZGV4O1xuICBASW5wdXQoKSBnZXRQYXJlbnRBdHRyO1xuICBASW5wdXQoKSByZWZlcmVuY2VkU2VydmVySWQ7XG4gIEBJbnB1dCgpIHJlZmVyZW5jZWRSb290Tm9kZUlkO1xuICBAT3V0cHV0KCkgb25BY3Rpb246IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgbWFwcGluZztcblxuICBpc0RldGFpbE9wZW47XG4gIGN1c3RvbUFjdGlvbjtcbiAgcmVmZXJlbmNlZE5vZGU7XG4gIGlzUGF0aEZvY3VzZWQgPSBmYWxzZTtcbiAgZ3JvdXBOYW1lOiBzdHJpbmc7XG4gIGJyb3dzZVBhdGg6IHN0cmluZztcbiAgbm9kZURpc3BsYXlOYW1lOiBzdHJpbmc7XG4gIGlzQnJvd3NlUGF0aFVuaXEgPSB0cnVlO1xuICBkYXRhUmVwb3J0aW5nID0gJ2RlZmF1bHQnO1xuICBpc1RyZWVPcGVuID0gZmFsc2U7XG4gIGlzTmV3ID0gZmFsc2U7XG4gIHJlc2V0TW9kZWwgPSBmYWxzZTtcbiAgZGF0YVJlcG9ydGluZ05hbWU7XG4gIHByaXZhdGUgbW9JZDogc3RyaW5nID0gJyc7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhZGRyZXNzU3BhY2VTZXJ2aWNlOiBBZGRyZXNzU3BhY2VTZXJ2aWNlXG4gICkge31cblxuICB0b2dnbGVEZXRhaWwoKSB7XG4gICAgdGhpcy5pc0RldGFpbE9wZW4gPSAhdGhpcy5pc0RldGFpbE9wZW47XG4gICAgaWYgKHRoaXMucmVzZXRNb2RlbCkge1xuICAgICAgdGhpcy5pbml0aWFsRm9ybVNldHVwKCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0TWFwcGluZ3MgPSAoKSA9PiB0aGlzLmdldFBhcmVudEF0dHIoJ21hcHBpbmdzJyk7XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5kYXRhUmVwb3J0aW5nTmFtZSA9ICdSZXBvcnRpbmdNb2RlJyArIHRoaXMuaW5kZXg7XG4gICAgdGhpcy5pbml0aWFsRm9ybVNldHVwKCk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKSB7XG4gICAgaWYgKFxuICAgICAgY2hhbmdlcy5fbW9kZWwucHJldmlvdXNWYWx1ZSAmJlxuICAgICAgIWlzRXF1YWwodGhpcy5fbW9kZWwsIGNoYW5nZXMuX21vZGVsLnByZXZpb3VzVmFsdWUuU2ltcGxlQ2hhbmdlKVxuICAgICkge1xuICAgICAgaWYgKHRoaXMubWFwcGluZyAmJiB0aGlzLm1hcHBpbmcubmFtZSA9PT0gdGhpcy5fbW9kZWwubmFtZSkge1xuICAgICAgICB0aGlzLm1hcHBpbmcuaWQgPSB0aGlzLl9tb2RlbC5pZDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpbml0aWFsRm9ybVNldHVwKCkge1xuICAgIGNvbnN0IG1hcHBpbmcgPSB7XG4gICAgICBpZDogJycsXG4gICAgICBicm93c2VQYXRoOiBbXSxcbiAgICAgIG5hbWU6ICcnLFxuICAgICAgc3Vic2NyaXB0aW9uVHlwZToge1xuICAgICAgICB0eXBlOiAnTm9uZSdcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgY3VzdG9tQWN0aW9uID0ge1xuICAgICAgaGVhZGVyczogW3sga2V5OiAnQXV0aG9yaXphdGlvbicsIHZhbHVlOiAnJyB9LCB7IGtleTogJ0NvbnRlbnQtVHlwZScsIHZhbHVlOiAnJyB9XSxcbiAgICAgIGJvZHlUZW1wbGF0ZTogJycsXG4gICAgICB0eXBlOiAnSHR0cFBvc3QnLFxuICAgICAgZW5kcG9pbnQ6ICcnXG4gICAgfTtcblxuICAgIHRoaXMubWFwcGluZyA9IGFzc2lnbih7fSwgbWFwcGluZywgY2xvbmVEZWVwKHRoaXMuX21vZGVsKSk7XG5cbiAgICBpZiAoaXNFbXB0eSh0aGlzLm1hcHBpbmcuYnJvd3NlUGF0aCkpIHtcbiAgICAgIHRoaXMuaXNOZXcgPSB0cnVlO1xuICAgICAgdGhpcy5pc0RldGFpbE9wZW4gPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmJyb3dzZVBhdGggPSB0aGlzLnN0cmluZ2Z5QnJvd3NlUGF0aCh0aGlzLm1hcHBpbmcuYnJvd3NlUGF0aCk7XG4gICAgICB0aGlzLm5vZGVEaXNwbGF5TmFtZSA9IHRoaXMubWFwcGluZy5uYW1lO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnJlZmVyZW5jZWRSb290Tm9kZUlkKSB7XG4gICAgICB0aGlzLnJlZmVyZW5jZWROb2RlID0geyBub2RlSWQ6IHRoaXMucmVmZXJlbmNlZFJvb3ROb2RlSWQgfTtcbiAgICAgIHRoaXMuYWRkcmVzc1NwYWNlU2VydmljZS50cmlnZ2VyTm9kZVRvT3Blbih7XG4gICAgICAgIG5vZGU6IHtcbiAgICAgICAgICBub2RlSWQ6IHRoaXMucmVmZXJlbmNlZFJvb3ROb2RlSWQsXG4gICAgICAgICAgY2hpbGRyZW46IFtdLFxuICAgICAgICAgIGV4cGFuZGVkOiBmYWxzZSxcbiAgICAgICAgICBhYnNvbHV0ZVBhdGhzOiBbW11dXG4gICAgICAgIH0sXG4gICAgICAgIHNlbGVjdGVkQW5jZXN0b3JJZHM6IFtdXG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5yZWZlcmVuY2VkTm9kZSA9IHsgbm9kZUlkOiAnJyB9O1xuICAgIH1cblxuICAgIGlmIChnZXQodGhpcy5tYXBwaW5nLCAnY3VzdG9tQWN0aW9uJykpIHtcbiAgICAgIHRoaXMuY3VzdG9tQWN0aW9uID0gYXNzaWduKGN1c3RvbUFjdGlvbiwgZ2V0KHRoaXMubWFwcGluZywgJ2N1c3RvbUFjdGlvbicpKTtcbiAgICAgIHRoaXMuY3VzdG9tQWN0aW9uLmhlYWRlcnMgPSB0aGlzLm1hcEhlYWRlcnNPYmplY3RUb0xpc3QoZ2V0KHRoaXMuY3VzdG9tQWN0aW9uLCAnaGVhZGVycycpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jdXN0b21BY3Rpb24gPSBhc3NpZ24oe30sIGN1c3RvbUFjdGlvbik7XG4gICAgfVxuXG4gICAgdW5zZXQodGhpcy5tYXBwaW5nLCAnY3VzdG9tQWN0aW9uJyk7XG4gICAgaWYgKGdldCh0aGlzLl9tb2RlbCwgJ3N1YnNjcmlwdGlvblR5cGUnKSkge1xuICAgICAgdGhpcy5kYXRhUmVwb3J0aW5nID0gJ2N1c3RvbSc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGF0YVJlcG9ydGluZyA9ICdkZWZhdWx0JztcbiAgICB9XG4gICAgdGhpcy5yZXNldE1vZGVsID0gZmFsc2U7XG4gIH1cblxuICBzaG93QWRkcmVzc1NwYWNlVHJlZSgpIHtcbiAgICByZXR1cm4gIWlzRW1wdHkodGhpcy5yZWZlcmVuY2VkU2VydmVySWQpO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIGlmIChcbiAgICAgIGdldCh0aGlzLm1hcHBpbmcsICdzdWJzY3JpcHRpb25UeXBlJykgJiZcbiAgICAgIGdldCh0aGlzLm1hcHBpbmcsICdzdWJzY3JpcHRpb25UeXBlLnR5cGUnKSAhPT0gJ05vbmUnXG4gICAgKSB7XG4gICAgICB0aGlzLmRhdGFSZXBvcnRpbmcgPSAnY3VzdG9tJztcbiAgICB9XG4gIH1cblxuICBtYXBIZWFkZXJzT2JqZWN0VG9MaXN0KGhlYWRlcnMpIHtcbiAgICBpZiAoT2JqZWN0LmtleXMoaGVhZGVycykubGVuZ3RoID4gMCkge1xuICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKGhlYWRlcnMpLm1hcChpdGVtID0+IHtcbiAgICAgICAgcmV0dXJuIHsga2V5OiBpdGVtLCB2YWx1ZTogaGVhZGVyc1tpdGVtXSB9O1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgc3RyaW5nZnlCcm93c2VQYXRoKHBhdGgpIHtcbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkocGF0aCk7XG4gIH1cblxuICB1cGRhdGVCcm93c2VQYXRoKG5vZGUpIHtcbiAgICB0aGlzLm1hcHBpbmcuYnJvd3NlUGF0aCA9IG5vZGUucmVsYXRpdmVQYXRoO1xuICAgIHRoaXMubm9kZURpc3BsYXlOYW1lID0gbm9kZS5kaXNwbGF5TmFtZTtcbiAgICB0aGlzLm1hcHBpbmcubmFtZSA9IHRoaXMubm9kZURpc3BsYXlOYW1lO1xuICAgIHRoaXMuYnJvd3NlUGF0aCA9IHRoaXMuc3RyaW5nZnlCcm93c2VQYXRoKHRoaXMubWFwcGluZy5icm93c2VQYXRoKTtcbiAgICB0aGlzLmJyb3dzZVBhdGhNb2RlbC5jb250cm9sLm1hcmtBc0RpcnR5KCk7XG4gIH1cblxuICB1cGRhdGVEaXNwbGF5bmFtZSgpIHtcbiAgICB0aGlzLm1hcHBpbmcubmFtZSA9IHRoaXMubm9kZURpc3BsYXlOYW1lO1xuICB9XG5cbiAgdXBkYXRlQnJvd3NlUGF0aElucHV0KCkge1xuICAgIGlmICh0aGlzLmJyb3dzZVBhdGgpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHRoaXMubWFwcGluZy5icm93c2VQYXRoID0gSlNPTi5wYXJzZSh0aGlzLmJyb3dzZVBhdGgpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHNhdmUoKSB7XG4gICAgaWYgKHRoaXMuZGF0YVJlcG9ydGluZyA9PT0gJ2RlZmF1bHQnKSB7XG4gICAgICB1bnNldCh0aGlzLm1hcHBpbmcsICdzdWJzY3JpcHRpb25UeXBlJyk7XG4gICAgfVxuXG4gICAgaWYgKGdldCh0aGlzLm1hcHBpbmcsICdtZWFzdXJlbWVudENyZWF0aW9uJykpIHtcbiAgICAgIGNvbnN0IHsgbWVhc3VyZW1lbnRDcmVhdGlvbiB9ID0gdGhpcy5tYXBwaW5nO1xuICAgICAgc2V0KG1lYXN1cmVtZW50Q3JlYXRpb24sICdmcmFnbWVudE5hbWUnLCBnZXQobWVhc3VyZW1lbnRDcmVhdGlvbiwgJ3R5cGUnKSk7XG4gICAgfVxuXG4gICAgY29uc3QgeyBjdXN0b21BY3Rpb24gfSA9IHRoaXMuc3ViRm9ybVJlZi52YWx1ZTtcbiAgICBsZXQgbW9kaWZpZWRDdXN0b21BY3Rpb247XG4gICAgaWYgKGN1c3RvbUFjdGlvbi5oYXNDdXN0b21BY3Rpb24pIHtcbiAgICAgIGNvbnN0IHJlZHVjZWRIZWFkZXJzID0gdGhpcy5jdXN0b21BY3Rpb24uaGVhZGVycy5yZWR1Y2UoKHJlc3VsdCwgaXRlbSkgPT4ge1xuICAgICAgICByZXN1bHRbaXRlbS5rZXldID0gaXRlbS52YWx1ZTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH0sIHt9KTtcblxuICAgICAgbW9kaWZpZWRDdXN0b21BY3Rpb24gPSBhc3NpZ24oe30sIHRoaXMuY3VzdG9tQWN0aW9uLCB7IGhlYWRlcnM6IHJlZHVjZWRIZWFkZXJzIH0pO1xuICAgIH1cblxuICAgIHRoaXMub25BY3Rpb24uZW1pdCh7XG4gICAgICBhY3Rpb246ICdzYXZlJyxcbiAgICAgIGRhdGE6IGFzc2lnbih7fSwgdGhpcy5tYXBwaW5nLCB7IGN1c3RvbUFjdGlvbjogbW9kaWZpZWRDdXN0b21BY3Rpb24gfSlcbiAgICB9KTtcbiAgICB0aGlzLmlzRGV0YWlsT3BlbiA9IGZhbHNlO1xuICB9XG5cbiAgY2FuY2VsKCkge1xuICAgIHRoaXMuaXNEZXRhaWxPcGVuID0gZmFsc2U7XG4gICAgdGhpcy5yZXNldE1vZGVsID0gdHJ1ZTtcbiAgICBpZiAodGhpcy5tYXBwaW5nLmlkID09PSAnbmV3Jykge1xuICAgICAgdGhpcy5vbkFjdGlvbi5lbWl0KHsgYWN0aW9uOiAnZGVsZXRlJywgZGF0YTogYXNzaWduKHt9LCB0aGlzLm1hcHBpbmcpIH0pO1xuICAgIH1cbiAgfVxuXG4gIG9uRGVsZXRlKCkge1xuICAgIHRoaXMub25BY3Rpb24uZW1pdCh7IGFjdGlvbjogJ2RlbGV0ZScsIGRhdGE6IHRoaXMubWFwcGluZyB9KTtcbiAgfVxuXG4gIGNhblNhdmUodmFyaWFibGVGb3JtKSB7XG4gICAgY29uc3QgYXJlVmFsaWQgPSAoKSA9PlxuICAgICAgdmFyaWFibGVGb3JtLnZhbGlkICYmIHRoaXMub2JqZWN0TWFwcGluZ0Zvcm0uJGNvbXBvbmVudFNjb3BlLm1hcHBpbmdGb3JtLiR2YWxpZDtcbiAgICBjb25zdCBhcmVEaXJ0eSA9ICgpID0+XG4gICAgICB2YXJpYWJsZUZvcm0uZGlydHkgfHwgdGhpcy5vYmplY3RNYXBwaW5nRm9ybS4kY29tcG9uZW50U2NvcGUubWFwcGluZ0Zvcm0uJGRpcnR5O1xuICAgIHJldHVybiBhcmVWYWxpZCgpICYmIGFyZURpcnR5KCk7XG4gIH1cblxuICBpc0FjdGl2ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5pc0RldGFpbE9wZW47XG4gIH1cblxuICBzZXRUcmVlRnJvbVJlZk5vZGUoKSB7XG4gICAgaWYgKHRoaXMucmVmZXJlbmNlZFJvb3ROb2RlSWQpIHtcbiAgICAgIHRoaXMuYWRkcmVzc1NwYWNlU2VydmljZS50cmlnZ2VyTm9kZVRvT3Blbih7XG4gICAgICAgIG5vZGU6IHtcbiAgICAgICAgICBub2RlSWQ6IHRoaXMucmVmZXJlbmNlZFJvb3ROb2RlSWQsXG4gICAgICAgICAgY2hpbGRyZW46IFtdLFxuICAgICAgICAgIGV4cGFuZGVkOiBmYWxzZSxcbiAgICAgICAgICBhYnNvbHV0ZVBhdGhzOiBbW11dXG4gICAgICAgIH0sXG4gICAgICAgIHNlbGVjdGVkQW5jZXN0b3JJZHM6IFtdXG4gICAgICB9KTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==