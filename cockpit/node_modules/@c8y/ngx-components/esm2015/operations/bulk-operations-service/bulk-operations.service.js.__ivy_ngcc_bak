import { __awaiter } from "tslib";
import { Location } from '@angular/common';
import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { flatten, has, isUndefined } from 'lodash-es';
import { Subject } from 'rxjs';
import { InventoryService, OperationBulkService, OperationService } from '@c8y/client';
export const baseUrl = 'devicecontrol/bulk/creation/';
export const HOOK_LIST_BULK_TYPE = new InjectionToken('LIST_BULK_TYPE');
export class BulkOperationsService {
    constructor(operationBulkService, operationService, inventoryService, location, bulkTypes) {
        this.operationBulkService = operationBulkService;
        this.operationService = operationService;
        this.inventoryService = inventoryService;
        this.location = location;
        this.DD_LOW_COUNT = 10;
        this.firmwareId = new Subject();
        this.bulkTypes = flatten(bulkTypes);
        this.bulkTypes = this.bulkTypes.map(type => {
            if (isUndefined(type.selected)) {
                type.selected = false;
            }
            return type;
        });
    }
    getBulkOperations(customFilter = {}) {
        const filter = Object.assign({ withTotalPages: true, withDeleted: true, pageSize: 50 }, customFilter);
        return this.operationBulkService.list(filter);
    }
    getBulkOperationById(bulkOperationId) {
        return this.operationBulkService.detail(bulkOperationId);
    }
    createBulkOperation(bulkOperation) {
        return this.operationBulkService.create(bulkOperation);
    }
    deleteBulkOperation(bulkOperationId) {
        return this.operationBulkService.delete(bulkOperationId);
    }
    updateBulkOperation(bulkOperation) {
        return this.operationBulkService.update(bulkOperation);
    }
    getOperation(id) {
        return this.operationService.detail(id);
    }
    returnToBulkOperationOverview() {
        this.location.back();
    }
    setBulkTypes(list) {
        this.bulkTypes = list;
    }
    getBulkTypes() {
        return this.bulkTypes;
    }
    setFirmwareId(id) {
        this.firmwareId.next(id);
    }
    createGroup(deviceQueryDataString) {
        const dynamicGroup = {
            name: 'Bulk operations group',
            type: 'c8y_DynamicGroup',
            c8y_IsDynamicGroup: { invisible: {} },
            c8y_DeviceQueryString: deviceQueryDataString
        };
        return this.inventoryService.create(dynamicGroup);
    }
    scheduleBulkOperation(deviceQueryString, details) {
        return __awaiter(this, void 0, void 0, function* () {
            const dynamicGroup = yield this.createGroup(deviceQueryString);
            const bulkOperation = {
                groupId: dynamicGroup.data.id,
                operationPrototype: details.prototype,
                creationRamp: details.schedule.delayInSeconds,
                startDate: details.schedule.scheduledDate.toISOString(),
                note: details.note
            };
            yield this.createBulkOperation(bulkOperation);
        });
    }
    getSingleOperationsByStatus(status, bulkOperationId) {
        const filter = {
            withTotalPages: true,
            bulkOperationId,
            status: (status && status.toUpperCase()) || ''
        };
        return this.operationService.list(filter);
    }
    createSingleOperation(operation) {
        return this.operationService.create(operation);
    }
    updateSingleOperation(partialUpdateObject) {
        return this.operationService.update(partialUpdateObject);
    }
    getManagedObject(deviceId) {
        return this.inventoryService.detail(deviceId);
    }
    retrieveBulkOperationType(operation) {
        let type;
        this.bulkTypes.some(t => {
            if (t.fragments.some(fragment => has(operation, fragment))) {
                type = t.type;
                return true;
            }
        });
        return type;
    }
}
BulkOperationsService.decorators = [
    { type: Injectable }
];
BulkOperationsService.ctorParameters = () => [
    { type: OperationBulkService },
    { type: OperationService },
    { type: InventoryService },
    { type: Location },
    { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [HOOK_LIST_BULK_TYPE,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb25zLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9vcGVyYXRpb25zL2J1bGstb3BlcmF0aW9ucy1zZXJ2aWNlL2J1bGstb3BlcmF0aW9ucy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3RSxPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDdEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUvQixPQUFPLEVBR0wsZ0JBQWdCLEVBSWhCLG9CQUFvQixFQUNwQixnQkFBZ0IsRUFDakIsTUFBTSxhQUFhLENBQUM7QUFNckIsTUFBTSxDQUFDLE1BQU0sT0FBTyxHQUFHLDhCQUE4QixDQUFDO0FBQ3RELE1BQU0sQ0FBQyxNQUFNLG1CQUFtQixHQUFHLElBQUksY0FBYyxDQUNuRCxnQkFBZ0IsQ0FDakIsQ0FBQztBQUdGLE1BQU0sT0FBTyxxQkFBcUI7SUFNaEMsWUFDVSxvQkFBMEMsRUFDMUMsZ0JBQWtDLEVBQ2xDLGdCQUFrQyxFQUNsQyxRQUFrQixFQUVlLFNBQWlEO1FBTGxGLHlCQUFvQixHQUFwQixvQkFBb0IsQ0FBc0I7UUFDMUMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLGFBQVEsR0FBUixRQUFRLENBQVU7UUFUbkIsaUJBQVksR0FBVyxFQUFFLENBQUM7UUFDbkMsZUFBVSxHQUF5QixJQUFJLE9BQU8sRUFBZSxDQUFDO1FBWTVELElBQUksQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FB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Y2VzQ29udGVudCI6WyJpbXBvcnQgeyBMb2NhdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5pbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUsIEluamVjdGlvblRva2VuLCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZmxhdHRlbiwgaGFzLCBpc1VuZGVmaW5lZCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5cbmltcG9ydCB7XG4gIElkUmVmZXJlbmNlLFxuICBJTWFuYWdlZE9iamVjdCxcbiAgSW52ZW50b3J5U2VydmljZSxcbiAgSU9wZXJhdGlvbixcbiAgSU9wZXJhdGlvbkJ1bGssXG4gIElSZXN1bHQsXG4gIE9wZXJhdGlvbkJ1bGtTZXJ2aWNlLFxuICBPcGVyYXRpb25TZXJ2aWNlXG59IGZyb20gJ0BjOHkvY2xpZW50JztcblxuaW1wb3J0IHsgT3BlcmF0aW9uRGV0YWlscyB9IGZyb20gJy4vb3BlcmF0aW9uLWRldGFpbHMubW9kZWwnO1xuaW1wb3J0IHsgT3BlcmF0aW9uVHlwZSB9IGZyb20gJy4vb3BlcmF0aW9uLXR5cGUubW9kZWwnO1xuaW1wb3J0IHsgQnVsa09wZXJhdGlvblR5cGUgfSBmcm9tICcuL2J1bGstb3BlcmF0aW9uLm1vZGVsJztcblxuZXhwb3J0IGNvbnN0IGJhc2VVcmwgPSAnZGV2aWNlY29udHJvbC9idWxrL2NyZWF0aW9uLyc7XG5leHBvcnQgY29uc3QgSE9PS19MSVNUX0JVTEtfVFlQRSA9IG5ldyBJbmplY3Rpb25Ub2tlbjxPcGVyYXRpb25UeXBlIHwgT3BlcmF0aW9uVHlwZVtdPihcbiAgJ0xJU1RfQlVMS19UWVBFJ1xuKTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEJ1bGtPcGVyYXRpb25zU2VydmljZSB7XG4gIHJlYWRvbmx5IEREX0xPV19DT1VOVDogbnVtYmVyID0gMTA7XG4gIGZpcm13YXJlSWQ6IFN1YmplY3Q8SWRSZWZlcmVuY2U+ID0gbmV3IFN1YmplY3Q8SWRSZWZlcmVuY2U+KCk7XG5cbiAgcHJpdmF0ZSBidWxrVHlwZXM6IE9wZXJhdGlvblR5cGVbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG9wZXJhdGlvbkJ1bGtTZXJ2aWNlOiBPcGVyYXRpb25CdWxrU2VydmljZSxcbiAgICBwcml2YXRlIG9wZXJhdGlvblNlcnZpY2U6IE9wZXJhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgbG9jYXRpb246IExvY2F0aW9uLFxuXG4gICAgQE9wdGlvbmFsKCkgQEluamVjdChIT09LX0xJU1RfQlVMS19UWVBFKSBidWxrVHlwZXM6IEFycmF5PE9wZXJhdGlvblR5cGUgfCBPcGVyYXRpb25UeXBlW10+XG4gICkge1xuICAgIHRoaXMuYnVsa1R5cGVzID0gZmxhdHRlbihidWxrVHlwZXMpO1xuXG4gICAgdGhpcy5idWxrVHlwZXMgPSB0aGlzLmJ1bGtUeXBlcy5tYXAodHlwZSA9PiB7XG4gICAgICBpZiAoaXNVbmRlZmluZWQodHlwZS5zZWxlY3RlZCkpIHtcbiAgICAgICAgdHlwZS5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHR5cGU7XG4gICAgfSk7XG4gIH1cblxuICBnZXRCdWxrT3BlcmF0aW9ucyhjdXN0b21GaWx0ZXIgPSB7fSkge1xuICAgIGNvbnN0IGZpbHRlciA9IHtcbiAgICAgIHdpdGhUb3RhbFBhZ2VzOiB0cnVlLFxuICAgICAgd2l0aERlbGV0ZWQ6IHRydWUsXG4gICAgICBwYWdlU2l6ZTogNTAsXG4gICAgICAuLi5jdXN0b21GaWx0ZXJcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uQnVsa1NlcnZpY2UubGlzdChmaWx0ZXIpO1xuICB9XG5cbiAgZ2V0QnVsa09wZXJhdGlvbkJ5SWQoYnVsa09wZXJhdGlvbklkOiBzdHJpbmcgfCBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS5kZXRhaWwoYnVsa09wZXJhdGlvbklkKTtcbiAgfVxuXG4gIGNyZWF0ZUJ1bGtPcGVyYXRpb24oYnVsa09wZXJhdGlvbjogUGFydGlhbDxJT3BlcmF0aW9uQnVsaz4pIHtcbiAgICByZXR1cm4gdGhpcy5vcGVyYXRpb25CdWxrU2VydmljZS5jcmVhdGUoYnVsa09wZXJhdGlvbik7XG4gIH1cblxuICBkZWxldGVCdWxrT3BlcmF0aW9uKGJ1bGtPcGVyYXRpb25JZCkge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLmRlbGV0ZShidWxrT3BlcmF0aW9uSWQpO1xuICB9XG5cbiAgdXBkYXRlQnVsa09wZXJhdGlvbihidWxrT3BlcmF0aW9uOiBQYXJ0aWFsPElPcGVyYXRpb25CdWxrPikge1xuICAgIHJldHVybiB0aGlzLm9wZXJhdGlvbkJ1bGtTZXJ2aWNlLnVwZGF0ZShidWxrT3BlcmF0aW9uKTtcbiAgfVxuXG4gIGdldE9wZXJhdGlvbihpZDogc3RyaW5nKTogUHJvbWlzZTxJUmVzdWx0PElPcGVyYXRpb24+PiB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uU2VydmljZS5kZXRhaWwoaWQpO1xuICB9XG5cbiAgcmV0dXJuVG9CdWxrT3BlcmF0aW9uT3ZlcnZpZXcoKSB7XG4gICAgdGhpcy5sb2NhdGlvbi5iYWNrKCk7XG4gIH1cblxuICBzZXRCdWxrVHlwZXMobGlzdDogT3BlcmF0aW9uVHlwZVtdKSB7XG4gICAgdGhpcy5idWxrVHlwZXMgPSBsaXN0O1xuICB9XG5cbiAgZ2V0QnVsa1R5cGVzKCk6IE9wZXJhdGlvblR5cGVbXSB7XG4gICAgcmV0dXJuIHRoaXMuYnVsa1R5cGVzO1xuICB9XG5cbiAgc2V0RmlybXdhcmVJZChpZDogSWRSZWZlcmVuY2UpIHtcbiAgICB0aGlzLmZpcm13YXJlSWQubmV4dChpZCk7XG4gIH1cblxuICBjcmVhdGVHcm91cChkZXZpY2VRdWVyeURhdGFTdHJpbmc6IHN0cmluZykge1xuICAgIGNvbnN0IGR5bmFtaWNHcm91cDogUGFydGlhbDxJTWFuYWdlZE9iamVjdD4gPSB7XG4gICAgICBuYW1lOiAnQnVsayBvcGVyYXRpb25zIGdyb3VwJyxcbiAgICAgIHR5cGU6ICdjOHlfRHluYW1pY0dyb3VwJyxcbiAgICAgIGM4eV9Jc0R5bmFtaWNHcm91cDogeyBpbnZpc2libGU6IHt9IH0sXG4gICAgICBjOHlfRGV2aWNlUXVlcnlTdHJpbmc6IGRldmljZVF1ZXJ5RGF0YVN0cmluZ1xuICAgIH07XG5cbiAgICByZXR1cm4gdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmNyZWF0ZShkeW5hbWljR3JvdXApO1xuICB9XG5cbiAgYXN5bmMgc2NoZWR1bGVCdWxrT3BlcmF0aW9uKGRldmljZVF1ZXJ5U3RyaW5nOiBzdHJpbmcsIGRldGFpbHM6IE9wZXJhdGlvbkRldGFpbHMpIHtcbiAgICBjb25zdCBkeW5hbWljR3JvdXAgPSBhd2FpdCB0aGlzLmNyZWF0ZUdyb3VwKGRldmljZVF1ZXJ5U3RyaW5nKTtcblxuICAgIGNvbnN0IGJ1bGtPcGVyYXRpb246IElPcGVyYXRpb25CdWxrID0ge1xuICAgICAgZ3JvdXBJZDogZHluYW1pY0dyb3VwLmRhdGEuaWQsXG4gICAgICBvcGVyYXRpb25Qcm90b3R5cGU6IGRldGFpbHMucHJvdG90eXBlLFxuICAgICAgY3JlYXRpb25SYW1wOiBkZXRhaWxzLnNjaGVkdWxlLmRlbGF5SW5TZWNvbmRzLFxuICAgICAgc3RhcnREYXRlOiBkZXRhaWxzLnNjaGVkdWxlLnNjaGVkdWxlZERhdGUudG9JU09TdHJpbmcoKSxcbiAgICAgIG5vdGU6IGRldGFpbHMubm90ZVxuICAgIH07XG5cbiAgICBhd2FpdCB0aGlzLmNyZWF0ZUJ1bGtPcGVyYXRpb24oYnVsa09wZXJhdGlvbik7XG4gIH1cblxuICBnZXRTaW5nbGVPcGVyYXRpb25zQnlTdGF0dXMoc3RhdHVzLCBidWxrT3BlcmF0aW9uSWQpIHtcbiAgICBjb25zdCBmaWx0ZXIgPSB7XG4gICAgICB3aXRoVG90YWxQYWdlczogdHJ1ZSxcbiAgICAgIGJ1bGtPcGVyYXRpb25JZCxcbiAgICAgIHN0YXR1czogKHN0YXR1cyAmJiBzdGF0dXMudG9VcHBlckNhc2UoKSkgfHwgJydcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uU2VydmljZS5saXN0KGZpbHRlcik7XG4gIH1cblxuICBjcmVhdGVTaW5nbGVPcGVyYXRpb24ob3BlcmF0aW9uOiBJT3BlcmF0aW9uKSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uU2VydmljZS5jcmVhdGUob3BlcmF0aW9uKTtcbiAgfVxuXG4gIHVwZGF0ZVNpbmdsZU9wZXJhdGlvbihwYXJ0aWFsVXBkYXRlT2JqZWN0OiBQYXJ0aWFsPElPcGVyYXRpb24+KSB7XG4gICAgcmV0dXJuIHRoaXMub3BlcmF0aW9uU2VydmljZS51cGRhdGUocGFydGlhbFVwZGF0ZU9iamVjdCk7XG4gIH1cblxuICBnZXRNYW5hZ2VkT2JqZWN0KGRldmljZUlkOiBJZFJlZmVyZW5jZSkge1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UuZGV0YWlsKGRldmljZUlkKTtcbiAgfVxuXG4gIHJldHJpZXZlQnVsa09wZXJhdGlvblR5cGUob3BlcmF0aW9uOiBJT3BlcmF0aW9uKTogQnVsa09wZXJhdGlvblR5cGUge1xuICAgIGxldCB0eXBlOiBCdWxrT3BlcmF0aW9uVHlwZTtcblxuICAgIHRoaXMuYnVsa1R5cGVzLnNvbWUodCA9PiB7XG4gICAgICBpZiAodC5mcmFnbWVudHMuc29tZShmcmFnbWVudCA9PiBoYXMob3BlcmF0aW9uLCBmcmFnbWVudCkpKSB7XG4gICAgICAgIHR5cGUgPSB0LnR5cGU7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHR5cGU7XG4gIH1cbn1cbiJdfQ==