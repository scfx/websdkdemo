import { __awaiter } from "tslib";
import { Component, ViewChild } from '@angular/core';
import { gettext, ModalService, Status } from '@c8y/ngx-components';
import { TranslateService } from '@ngx-translate/core';
import { uniq } from 'lodash-es';
import { BaseStepperComponent } from '@c8y/ngx-components/operations/bulk-operation-stepper';
import { SelectSoftwareStepComponent } from './select-software-step.component';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/ngx-components';
import * as ɵngcc2 from '@ngx-translate/core';
import * as ɵngcc3 from '@c8y/ngx-components/operations/bulk-operation-stepper';
import * as ɵngcc4 from './select-software-step.component';
import * as ɵngcc5 from './confirm-software-selection-step.component';

function StepperBulkTypeSoftwareComponent_ng_container_1_Template(rf, ctx) { if (rf & 1) {
    const _r3 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵelementStart(1, "c8y-select-software-step", 2);
    ɵngcc0.ɵɵlistener("software", function StepperBulkTypeSoftwareComponent_ng_container_1_Template_c8y_select_software_step_software_1_listener($event) { ɵngcc0.ɵɵrestoreView(_r3); const ctx_r2 = ɵngcc0.ɵɵnextContext(); return ctx_r2.onSoftwareSelected($event); });
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementContainerEnd();
} }
function StepperBulkTypeSoftwareComponent_ng_container_3_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵelement(1, "c8y-confirm-software-selection-step", 3);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const ctx_r1 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("selectedItems", ctx_r1.selectedSoftware);
} }
export class StepperBulkTypeSoftwareComponent extends BaseStepperComponent {
    constructor(modal, translate) {
        super();
        this.modal = modal;
        this.translate = translate;
        this.descriptionTemplateSingle = gettext('Update software to: {{ name }} (version {{ version }})');
        this.descriptionTemplateOneOther = gettext('Update software to: {{ name }} (version {{ version }}) and one other');
        this.descriptionTemplateMultiple = gettext('Update software to: {{ name }} (version {{ version }}) and {{ count }} others');
        this.selectedSoftware = [];
    }
    onSoftwareSelected(selectedItem) {
        this.selectedSoftware = this.selectedSoftware.filter(item => item.software.id !== selectedItem.software.id);
        this.selectedSoftware.push(selectedItem);
    }
    confirmSoftwareSelection($event) {
        return __awaiter(this, void 0, void 0, function* () {
            const deviceTypes = this.getUniqueDeviceTypes();
            this.deviceTypes = deviceTypes;
            if (deviceTypes.length > 1) {
                try {
                    yield this.modal.confirm(gettext('Selected software for various device types'), gettext('Operation may fail due to unsupported software. Do you want to proceed?'), Status.WARNING, { ok: gettext('Confirm'), cancel: gettext('Cancel') });
                    $event.stepper.next();
                }
                catch (ex) {
                    this.selectedSoftware = [];
                    this.selectSoftware.resetSelection();
                }
            }
            else {
                $event.stepper.next();
            }
        });
    }
    retrieveOperationPrototype() {
        const softwareList = this.selectedSoftware.map(item => ({
            name: item.software.name,
            version: item.version.c8y_Software.version,
            url: item.version.c8y_Software.url,
            action: item.action
        }));
        const interpolationParams = {
            name: softwareList[0].name,
            version: softwareList[0].version,
            count: softwareList.length - 1
        };
        let description;
        switch (softwareList.length) {
            case 1:
                description = this.translate.instant(this.descriptionTemplateSingle, interpolationParams);
                break;
            case 2:
                description = this.translate.instant(this.descriptionTemplateOneOther, interpolationParams);
                break;
            default:
                description = this.translate.instant(this.descriptionTemplateMultiple, interpolationParams);
        }
        return {
            name: gettext('Software update'),
            prototype: {
                description,
                c8y_SoftwareUpdate: softwareList
            }
        };
    }
    getUniqueDeviceTypes() {
        return uniq(this.selectedSoftware
            .map(item => item.software.c8y_Filter && item.software.c8y_Filter.type)
            .filter(type => !!type));
    }
}
StepperBulkTypeSoftwareComponent.ɵfac = function StepperBulkTypeSoftwareComponent_Factory(t) { return new (t || StepperBulkTypeSoftwareComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.ModalService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.TranslateService)); };
StepperBulkTypeSoftwareComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: StepperBulkTypeSoftwareComponent, selectors: [["c8y-stepper-bulk-type-software"]], viewQuery: function StepperBulkTypeSoftwareComponent_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵviewQuery(SelectSoftwareStepComponent, 5);
    } if (rf & 2) {
        let _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.selectSoftware = _t.first);
    } }, features: [ɵngcc0.ɵɵInheritDefinitionFeature], decls: 5, vars: 9, consts: [[4, "customStep", "customStepCompleted", "customStepButtonsDisabled", "customStepOnNext"], [4, "customStep"], [1, "d-contents", 3, "software"], [1, "d-contents", 3, "selectedItems"]], template: function StepperBulkTypeSoftwareComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "c8y-bulk-operation-stepper");
        ɵngcc0.ɵɵtemplate(1, StepperBulkTypeSoftwareComponent_ng_container_1_Template, 2, 0, "ng-container", 0);
        ɵngcc0.ɵɵpipe(2, "translate");
        ɵngcc0.ɵɵtemplate(3, StepperBulkTypeSoftwareComponent_ng_container_3_Template, 2, 1, "ng-container", 1);
        ɵngcc0.ɵɵpipe(4, "translate");
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("customStep", ɵngcc0.ɵɵpipeBind1(2, 5, "Select software"))("customStepCompleted", !!ctx.selectedSoftware.length)("customStepButtonsDisabled", !ctx.selectedSoftware.length)("customStepOnNext", ctx.confirmSoftwareSelection.bind(ctx));
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("customStep", ɵngcc0.ɵɵpipeBind1(4, 7, "Confirm selected software"));
    } }, directives: [ɵngcc3.BulkOperationStepper, ɵngcc3.CustomStep, ɵngcc4.SelectSoftwareStepComponent, ɵngcc5.ConfirmSoftwareSelectionStepComponent], pipes: [ɵngcc1.C8yTranslatePipe], encapsulation: 2 });
StepperBulkTypeSoftwareComponent.ctorParameters = () => [
    { type: ModalService },
    { type: TranslateService }
];
StepperBulkTypeSoftwareComponent.propDecorators = {
    selectSoftware: [{ type: ViewChild, args: [SelectSoftwareStepComponent, { static: false },] }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(StepperBulkTypeSoftwareComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-stepper-bulk-type-software',
                template: "<c8y-bulk-operation-stepper>\n  <ng-container\n    *customStep=\"\n      'Select software' | translate; \n      completed: !!selectedSoftware.length;\n      buttonsDisabled: !selectedSoftware.length; \n      onNext: confirmSoftwareSelection.bind(this)\"\n  >\n    <c8y-select-software-step\n      (software)=\"onSoftwareSelected($event)\"\n      class=\"d-contents\"\n    ></c8y-select-software-step>\n  </ng-container>\n  <ng-container *customStep=\"'Confirm selected software' | translate\">\n    <c8y-confirm-software-selection-step\n      class=\"d-contents\"\n      [selectedItems]=\"selectedSoftware\"\n    ></c8y-confirm-software-selection-step>\n  </ng-container>\n</c8y-bulk-operation-stepper>\n"
            }]
    }], function () { return [{ type: ɵngcc1.ModalService }, { type: ɵngcc2.TranslateService }]; }, { selectSoftware: [{
            type: ViewChild,
            args: [SelectSoftwareStepComponent, { static: false }]
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RlcHBlci1idWxrLXR5cGUtc29mdHdhcmUuY29tcG9uZW50LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9vcGVyYXRpb25zL3N0ZXBwZXItYnVsay10eXBlLXNvZnR3YXJlL3N0ZXBwZXItYnVsay10eXBlLXNvZnR3YXJlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckQsT0FBTyxFQUFjLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDaEYsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDdkQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNqQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx1REFBdUQsQ0FBQztBQUU3RixPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQU8vRSxNQUFNLE9BQU8sZ0NBQWlDLFNBQVEsb0JBQW9CO0FBQzFFLElBY0UsWUFBb0IsS0FBbUIsRUFBVSxTQUEyQjtBQUM5RSxRQUFJLEtBQUssRUFBRSxDQUFDO0FBQ1osUUFGc0IsVUFBSyxHQUFMLEtBQUssQ0FBYztBQUFDLFFBQVMsY0FBUyxHQUFULFNBQVMsQ0FBa0I7QUFBQyxRQWRwRSw4QkFBeUIsR0FBVyxPQUFPLENBQ2xELHdEQUF3RCxDQUN6RCxDQUFDO0FBQ0osUUFBVyxnQ0FBMkIsR0FBVyxPQUFPLENBQ3BELHNFQUFzRSxDQUN2RSxDQUFDO0FBQ0osUUFBVyxnQ0FBMkIsR0FBVyxPQUFPLENBQ3BELCtFQUErRSxDQUNoRixDQUFDO0FBQ0osUUFDRSxxQkFBZ0IsR0FBd0IsRUFBRSxDQUFDO0FBQzdDLElBS0UsQ0FBQztBQUNILElBQ0Usa0JBQWtCLENBQUMsWUFBWTtBQUNqQyxRQUFJ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LENBQUMsMkJBQTJCLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztBQUNwRyxTQUFLO0FBQ0wsUUFDSSxPQUFPO0FBQ1gsWUFBTSxJQUFJLEVBQUUsT0FBTyxDQUFDLGlCQUFpQixDQUFDO0FBQ3RDLFlBQU0sU0FBUyxFQUFHO0FBQ2xCLGdCQUFRLFdBQVc7QUFDbkIsZ0JBQVEsa0JBQWtCLEVBQUUsWUFBWTtBQUN4QyxhQUFpQztBQUNqQyxTQUFLLENBQUM7QUFDTixJQUFFLENBQUM7QUFDSCxJQUNVLG9CQUFvQjtBQUFLLFFBQy9CLE9BQU8sSUFBSSxDQUNULElBQUksQ0FBQyxnQkFBZ0I7QUFDM0IsYUFBUyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUM7QUFDL0UsYUFBUyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQzFCLENBQUM7QUFDTixJQUFFLENBQUM7QUFDSDs0REE1RkMsU0FBUyxTQUFDLGtCQUNULFFBQVEsRUFBRSxnQ0FBZ0Msa0JBQzFDOzs7Ozs7cUxBQXdELGNBQ3pEOzs7Ozs7Ozs7Ozs7K01BQ0k7QUFBQztBQUEwRCxZQVpsQyxZQUFZO0FBQUksWUFDckMsZ0JBQWdCO0FBQUc7QUFBRztBQUNKLDZCQXNCeEIsU0FBUyxTQUFDLDJCQUEyQixFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRTtBQUN2RDs7Ozs7Ozs7OztvQkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2RrU3RlcCB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9zdGVwcGVyJztcbmltcG9ydCB7IENvbXBvbmVudCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJT3BlcmF0aW9uIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQzh5U3RlcHBlciwgZ2V0dGV4dCwgTW9kYWxTZXJ2aWNlLCBTdGF0dXMgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IFRyYW5zbGF0ZVNlcnZpY2UgfSBmcm9tICdAbmd4LXRyYW5zbGF0ZS9jb3JlJztcbmltcG9ydCB7IHVuaXEgfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgQmFzZVN0ZXBwZXJDb21wb25lbnQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvYnVsay1vcGVyYXRpb24tc3RlcHBlcic7XG5pbXBvcnQgeyBPcGVyYXRpb25EZXRhaWxzIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9vcGVyYXRpb25zL2J1bGstb3BlcmF0aW9ucy1zZXJ2aWNlJztcbmltcG9ydCB7IFNlbGVjdFNvZnR3YXJlU3RlcENvbXBvbmVudCB9IGZyb20gJy4vc2VsZWN0LXNvZnR3YXJlLXN0ZXAuY29tcG9uZW50JztcbmltcG9ydCB7IElTZWxlY3RlZFNvZnR3YXJlLCBJU29mdHdhcmVVcGRhdGVPcGVyYXRpb25Qcm90b3R5cGUgfSBmcm9tICcuL3NlbGVjdC1zb2Z0d2FyZS5tb2RlbCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1zdGVwcGVyLWJ1bGstdHlwZS1zb2Z0d2FyZScsXG4gIHRlbXBsYXRlVXJsOiAnc3RlcHBlci1idWxrLXR5cGUtc29mdHdhcmUuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFN0ZXBwZXJCdWxrVHlwZVNvZnR3YXJlQ29tcG9uZW50IGV4dGVuZHMgQmFzZVN0ZXBwZXJDb21wb25lbnQge1xuICByZWFkb25seSBkZXNjcmlwdGlvblRlbXBsYXRlU2luZ2xlOiBzdHJpbmcgPSBnZXR0ZXh0KFxuICAgICdVcGRhdGUgc29mdHdhcmUgdG86IHt7IG5hbWUgfX0gKHZlcnNpb24ge3sgdmVyc2lvbiB9fSknXG4gICk7XG4gIHJlYWRvbmx5IGRlc2NyaXB0aW9uVGVtcGxhdGVPbmVPdGhlcjogc3RyaW5nID0gZ2V0dGV4dChcbiAgICAnVXBkYXRlIHNvZnR3YXJlIHRvOiB7eyBuYW1lIH19ICh2ZXJzaW9uIHt7IHZlcnNpb24gfX0pIGFuZCBvbmUgb3RoZXInXG4gICk7XG4gIHJlYWRvbmx5IGRlc2NyaXB0aW9uVGVtcGxhdGVNdWx0aXBsZTogc3RyaW5nID0gZ2V0dGV4dChcbiAgICAnVXBkYXRlIHNvZnR3YXJlIHRvOiB7eyBuYW1lIH19ICh2ZXJzaW9uIHt7IHZlcnNpb24gfX0pIGFuZCB7eyBjb3VudCB9fSBvdGhlcnMnXG4gICk7XG5cbiAgc2VsZWN0ZWRTb2Z0d2FyZTogSVNlbGVjdGVkU29mdHdhcmVbXSA9IFtdO1xuICBAVmlld0NoaWxkKFNlbGVjdFNvZnR3YXJlU3RlcENvbXBvbmVudCwgeyBzdGF0aWM6IGZhbHNlIH0pXG4gIHNlbGVjdFNvZnR3YXJlOiBTZWxlY3RTb2Z0d2FyZVN0ZXBDb21wb25lbnQ7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBtb2RhbDogTW9kYWxTZXJ2aWNlLCBwcml2YXRlIHRyYW5zbGF0ZTogVHJhbnNsYXRlU2VydmljZSkge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBvblNvZnR3YXJlU2VsZWN0ZWQoc2VsZWN0ZWRJdGVtKSB7XG4gICAgdGhpcy5zZWxlY3RlZFNvZnR3YXJlID0gdGhpcy5zZWxlY3RlZFNvZnR3YXJlLmZpbHRlcihcbiAgICAgIGl0ZW0gPT4gaXRlbS5zb2Z0d2FyZS5pZCAhPT0gc2VsZWN0ZWRJdGVtLnNvZnR3YXJlLmlkXG4gICAgKTtcbiAgICB0aGlzLnNlbGVjdGVkU29mdHdhcmUucHVzaChzZWxlY3RlZEl0ZW0pO1xuICB9XG5cbiAgYXN5bmMgY29uZmlybVNvZnR3YXJlU2VsZWN0aW9uKCRldmVudDogeyBzdGVwcGVyOiBDOHlTdGVwcGVyOyBzdGVwOiBDZGtTdGVwIH0pIHtcbiAgICBjb25zdCBkZXZpY2VUeXBlczogc3RyaW5nW10gPSB0aGlzLmdldFVuaXF1ZURldmljZVR5cGVzKCk7XG4gICAgdGhpcy5kZXZpY2VUeXBlcyA9IGRldmljZVR5cGVzO1xuICAgIGlmIChkZXZpY2VUeXBlcy5sZW5ndGggPiAxKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLm1vZGFsLmNvbmZpcm0oXG4gICAgICAgICAgZ2V0dGV4dCgnU2VsZWN0ZWQgc29mdHdhcmUgZm9yIHZhcmlvdXMgZGV2aWNlIHR5cGVzJyksXG4gICAgICAgICAgZ2V0dGV4dCgnT3BlcmF0aW9uIG1heSBmYWlsIGR1ZSB0byB1bnN1cHBvcnRlZCBzb2Z0d2FyZS4gRG8geW91IHdhbnQgdG8gcHJvY2VlZD8nKSxcbiAgICAgICAgICBTdGF0dXMuV0FSTklORyxcbiAgICAgICAgICB7IG9rOiBnZXR0ZXh0KCdDb25maXJtJyksIGNhbmNlbDogZ2V0dGV4dCgnQ2FuY2VsJykgfVxuICAgICAgICApO1xuICAgICAgICAkZXZlbnQuc3RlcHBlci5uZXh0KCk7XG4gICAgICB9IGNhdGNoIChleCkge1xuICAgICAgICB0aGlzLnNlbGVjdGVkU29mdHdhcmUgPSBbXTtcbiAgICAgICAgdGhpcy5zZWxlY3RTb2Z0d2FyZS5yZXNldFNlbGVjdGlvbigpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAkZXZlbnQuc3RlcHBlci5uZXh0KCk7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHJldHJpZXZlT3BlcmF0aW9uUHJvdG90eXBlKCk6IE9wZXJhdGlvbkRldGFpbHMge1xuICAgIGNvbnN0IHNvZnR3YXJlTGlzdDogSVNvZnR3YXJlVXBkYXRlT3BlcmF0aW9uUHJvdG90eXBlW10gPSB0aGlzLnNlbGVjdGVkU29mdHdhcmUubWFwKGl0ZW0gPT4gKHtcbiAgICAgIG5hbWU6IGl0ZW0uc29mdHdhcmUubmFtZSxcbiAgICAgIHZlcnNpb246IGl0ZW0udmVyc2lvbi5jOHlfU29mdHdhcmUudmVyc2lvbixcbiAgICAgIHVybDogaXRlbS52ZXJzaW9uLmM4eV9Tb2Z0d2FyZS51cmwsXG4gICAgICBhY3Rpb246IGl0ZW0uYWN0aW9uXG4gICAgfSkpO1xuXG4gICAgY29uc3QgaW50ZXJwb2xhdGlvblBhcmFtczogb2JqZWN0ID0ge1xuICAgICAgbmFtZTogc29mdHdhcmVMaXN0WzBdLm5hbWUsXG4gICAgICB2ZXJzaW9uOiBzb2Z0d2FyZUxpc3RbMF0udmVyc2lvbixcbiAgICAgIGNvdW50OiBzb2Z0d2FyZUxpc3QubGVuZ3RoIC0gMVxuICAgIH07XG4gICAgbGV0IGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gICAgc3dpdGNoIChzb2Z0d2FyZUxpc3QubGVuZ3RoKSB7XG4gICAgICBjYXNlIDE6XG4gICAgICAgIGRlc2NyaXB0aW9uID0gdGhpcy50cmFuc2xhdGUuaW5zdGFudCh0aGlzLmRlc2NyaXB0aW9uVGVtcGxhdGVTaW5nbGUsIGludGVycG9sYXRpb25QYXJhbXMpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgMjpcbiAgICAgICAgZGVzY3JpcHRpb24gPSB0aGlzLnRyYW5zbGF0ZS5pbnN0YW50KHRoaXMuZGVzY3JpcHRpb25UZW1wbGF0ZU9uZU90aGVyLCBpbnRlcnBvbGF0aW9uUGFyYW1zKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBkZXNjcmlwdGlvbiA9IHRoaXMudHJhbnNsYXRlLmluc3RhbnQodGhpcy5kZXNjcmlwdGlvblRlbXBsYXRlTXVsdGlwbGUsIGludGVycG9sYXRpb25QYXJhbXMpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBuYW1lOiBnZXR0ZXh0KCdTb2Z0d2FyZSB1cGRhdGUnKSxcbiAgICAgIHByb3RvdHlwZTogKHtcbiAgICAgICAgZGVzY3JpcHRpb24sXG4gICAgICAgIGM4eV9Tb2Z0d2FyZVVwZGF0ZTogc29mdHdhcmVMaXN0XG4gICAgICB9IGFzIHVua25vd24pIGFzIElPcGVyYXRpb25cbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRVbmlxdWVEZXZpY2VUeXBlcygpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIHVuaXEoXG4gICAgICB0aGlzLnNlbGVjdGVkU29mdHdhcmVcbiAgICAgICAgLm1hcChpdGVtID0+IGl0ZW0uc29mdHdhcmUuYzh5X0ZpbHRlciAmJiBpdGVtLnNvZnR3YXJlLmM4eV9GaWx0ZXIudHlwZSlcbiAgICAgICAgLmZpbHRlcih0eXBlID0+ICEhdHlwZSlcbiAgICApO1xuICB9XG59XG4iXX0=