import { __awaiter } from "tslib";
import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { OperationBulkGeneralStatus } from '@c8y/client';
import { AlertService, gettext, ModalService, Status } from '@c8y/ngx-components';
import { assign, cloneDeep } from 'lodash-es';
import { BsModalService } from 'ngx-bootstrap/modal';
import { BulkOperationsService } from '@c8y/ngx-components/operations/bulk-operations-service';
import { BulkOperationsRescheduleModalComponent } from './modals/bulk-operations-reschedule-modal.component';
import { BULK_OPERATION_FALLBACK_STATUS_ICON, BULK_OPERATION_STATUS_OPTIONS } from './bulk-operation-list-item.model';
export class BulkOperationListItemComponent {
    constructor(bulkOperationsService, modal, alert, bsModalService) {
        this.bulkOperationsService = bulkOperationsService;
        this.modal = modal;
        this.alert = alert;
        this.bsModalService = bsModalService;
        this.detailsCollapsed = true;
        this.readOnly = false;
        this.showFailedOperation = new EventEmitter();
        this.reload = new EventEmitter();
        this.refreshLoading = false;
        this.bulkOperationGeneralStatus = OperationBulkGeneralStatus;
        this.bulkOperationStatusOptions = BULK_OPERATION_STATUS_OPTIONS;
        this.finishDatePopoverText = gettext('Approximate date, estimated based on the bulk operation settings.');
        this.progressBarClass = 'progress';
        this.progressBarStatus = 0;
    }
    ngOnInit() {
        this.iconClass = this.getIconClass();
        this.finishDate = this.calculateFinishDateMs();
        this.setProgressBar();
    }
    ngOnChanges(changes) {
        if (changes.bulkOperation && !changes.bulkOperation.firstChange) {
            this.iconClass = this.getIconClass();
            this.setProgressBar();
        }
    }
    getIconClass() {
        const statusOptions = this.bulkOperationStatusOptions.find(statusOption => statusOption.generalStatus.includes(this.bulkOperation.generalStatus));
        return statusOptions ? statusOptions.iconClass : BULK_OPERATION_FALLBACK_STATUS_ICON;
    }
    calculateFinishDateMs() {
        const startDateMs = new Date(this.bulkOperation.startDate).getTime();
        const creationRampMs = this.bulkOperation.creationRamp * 1000;
        return startDateMs + creationRampMs * this.bulkOperation.progress.all;
    }
    progressBarProgressFn() {
        return (((this.bulkOperation.progress.successful + this.bulkOperation.progress.failed) /
            this.bulkOperation.progress.all) *
            100);
    }
    setProgressBar() {
        const staticContentOfClass = 'progress-bar progress-striped active progress-bar';
        const progressBarState = {
            EXECUTING: {
                progressBarClass: 'progress progress-striped active',
                progressBarColor: `${staticContentOfClass}-primary`,
                progressBarStatus: this.progressBarProgressFn()
            },
            EXECUTING_WITH_ERROR: {
                progressBarClass: 'progress progress-striped active',
                progressBarColor: `${staticContentOfClass}-danger`,
                progressBarStatus: this.progressBarProgressFn()
            },
            FAILED: {
                progressBarClass: 'progress',
                progressBarColor: `${staticContentOfClass}-danger`,
                progressBarStatus: 100
            },
            SUCCESSFUL: {
                progressBarClass: 'progress',
                progressBarColor: `${staticContentOfClass}-success`,
                progressBarStatus: 100
            }
        };
        assign(this, progressBarState[this.bulkOperation.generalStatus]);
    }
    editSchedule() {
        const rescheduledOperation = cloneDeep(this.bulkOperation);
        const initialState = {
            bulkOperation: rescheduledOperation
        };
        const modalOptions = { initialState, class: 'modal-sm', backdrop: 'static' };
        this.bsModalRef = this.bsModalService.show(BulkOperationsRescheduleModalComponent, modalOptions);
    }
    cancelBulkOperation() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                yield this.modal.confirm(gettext('Cancel bulk operation'), gettext('You are about to cancel the bulk operation. Do you want to proceed?'), Status.DANGER);
                yield this.bulkOperationsService.deleteBulkOperation(this.bulkOperation.id);
                this.reload.emit();
                this.alert.success(gettext('Operation canceled.'));
            }
            catch (er) {
                this.alert.addServerFailure(er);
            }
        });
    }
    retryFailedOperation() {
        const clonedBulk = cloneDeep(this.bulkOperation);
        // change the id to failedparentId similar to the logic in deviceBulkControl.service.js
        delete clonedBulk.groupId;
        clonedBulk.failedParentId = this.bulkOperation.id;
        // show reschdedule modal:
        const initialState = {
            bulkOperation: clonedBulk,
            isRetryOperation: true
        };
        const modalOptions = { initialState, class: 'modal-sm', backdrop: 'static' };
        this.bsModalRef = this.bsModalService.show(BulkOperationsRescheduleModalComponent, modalOptions);
        this.bsModalRef.content.closeSubject.subscribe(() => {
            this.reload.emit();
        });
    }
    setToSuccessful() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                yield this.modal.confirm(gettext('Set manually bulk operation to SUCCESSFUL'), gettext('You are about to change the bulk operation status to SUCCESSFUL. Do you want to proceed?'), Status.DANGER);
                yield this.bulkOperationsService.updateBulkOperation({
                    id: this.bulkOperation.id,
                    generalStatus: OperationBulkGeneralStatus.SUCCESSFUL
                });
                this.reload.emit();
                this.alert.success(gettext('Operation status changed to SUCCESSFUL.'));
            }
            catch (er) {
                this.alert.addServerFailure(er);
            }
        });
    }
    openFailedOperation(failedParentId) {
        this.showFailedOperation.emit(failedParentId);
    }
    isStatusScheduled() {
        return this.bulkOperation.generalStatus === this.bulkOperationGeneralStatus.SCHEDULED;
    }
    isStatusExecutingOrExecutingWithError() {
        return (this.bulkOperation.generalStatus === this.bulkOperationGeneralStatus.EXECUTING ||
            this.bulkOperation.generalStatus === this.bulkOperationGeneralStatus.EXECUTING_WITH_ERROR);
    }
    allOperationsCreated() {
        return (this.bulkOperation.progress.all ===
            this.bulkOperation.progress.executing +
                this.bulkOperation.progress.failed +
                this.bulkOperation.progress.pending +
                this.bulkOperation.progress.successful);
    }
    isStatusCanceled() {
        return this.bulkOperation.generalStatus === this.bulkOperationGeneralStatus.CANCELED;
    }
    isStatusFailed() {
        return this.bulkOperation.generalStatus === this.bulkOperationGeneralStatus.FAILED;
    }
}
BulkOperationListItemComponent.decorators = [
    { type: Component, args: [{
                selector: 'c8y-bulk-operation-list-item',
                template: "<c8y-li\n  class=\"c8y-list__item--double-actions\"\n  [ngClass]=\"{ 'c8y-list__item--no-expand': !detailsCollapsed }\"\n  [collapsed]=\"detailsCollapsed\"\n  #listItem\n  id=\"{{ bulkOperation.id }}\"\n>\n  <c8y-li-icon>\n    <i [class]=\"iconClass\"></i>\n  </c8y-li-icon>\n  <div [ngClass]=\"{ 'content-flex-58': !readOnly, 'content-flex-50': readOnly }\">\n    <div class=\"col-5\">\n      <span\n        class=\"text-truncate\"\n        title=\"{{ bulkOperation.id }} - {{\n          bulkOperation.operationPrototype.description | translate\n        }}\"\n      >\n        <strong class=\"text-muted m-r-4\">{{ bulkOperation.id }}</strong>\n        {{ bulkOperation.operationPrototype.description | translate }}\n      </span>\n    </div>\n    <div class=\"flex-grow\">\n      <div class=\"m-t-8 visible-xs\"></div>\n      <hr *ngIf=\"isStatusCanceled(); else statusNotCanceled\" class=\"m-t-16 m-b-0\" />\n      <ng-template #statusNotCanceled>\n        <div\n          [class]=\"progressBarClass\"\n          title=\"{{ progressBarStatus | c8yNumber: 'floor':'1.0-0' }}%\"\n        >\n          <div\n            [class]=\"progressBarColor\"\n            role=\"progressbar\"\n            aria-valuenow=\"0\"\n            aria-valuemin=\"0\"\n            aria-valuemax=\"100\"\n            [style.width.%]=\"progressBarStatus\"\n          >\n            <span *ngIf=\"progressBarStatus !== 0\"\n              >{{ progressBarStatus | c8yNumber: 'floor':'1.0-0' }}%</span\n            >\n          </div>\n        </div>\n      </ng-template>\n    </div>\n    <div class=\"col-4\">\n      <div class=\"p-t-8 visible-xs\"></div>\n      <small *ngIf=\"bulkOperation.progress.successful > 0\" class=\"m-r-8 icon-flex\">\n        <i c8yIcon=\"check-circle\" class=\"text-success m-r-4\"></i>\n        <span\n          ngNonBindable\n          translate\n          [translateParams]=\"{ bulkOperationsCountSuccessful: bulkOperation.progress.successful }\"\n        >\n          {{ bulkOperationsCountSuccessful }} successful\n        </span>\n      </small>\n      <small *ngIf=\"bulkOperation.progress.failed > 0\" class=\"m-r-8 icon-flex\">\n        <i c8yIcon=\"warning\" class=\"text-danger m-r-4\"></i>\n        <span\n          ngNonBindable\n          translate\n          [translateParams]=\"{ bulkOperationsCountFailed: bulkOperation.progress.failed }\"\n        >\n          {{ bulkOperationsCountFailed }} failed\n        </span>\n      </small>\n      <small *ngIf=\"bulkOperation.progress.pending > 0\" class=\"m-r-8 icon-flex\">\n        <i c8yIcon=\"clock-o\" class=\"text-primary m-r-4\"></i>\n        <span\n          ngNonBindable\n          translate\n          [translateParams]=\"{ bulkOperationsCountPending: bulkOperation.progress.pending }\"\n        >\n          {{ bulkOperationsCountPending }} pending\n        </span>\n      </small>\n    </div>\n  </div>\n  <div class=\"c8y-list__item__footer\">\n    <div class=\"m-r-16\">\n      <span class=\"text-label-small m-r-4\" translate>Start</span>\n      <small class=\"icon-flex\">\n        <i c8yIcon=\"calendar\" class=\"m-r-4\"></i>\n        <span>\n          {{ bulkOperation.startDate | c8yDate }}\n        </span>\n      </small>\n    </div>\n    <div class=\"m-r-16\" *ngIf=\"bulkOperationGeneralStatus.CANCELED !== bulkOperation.generalStatus\">\n      <span class=\"text-label-small m-r-4\" translate>Finish</span>\n\n      <small class=\"icon-flex\">\n        <i c8yIcon=\"calendar\" class=\"m-r-4\"></i>\n        <span>{{ finishDate | c8yDate }}</span>\n      </small>\n      <a\n        container=\"body\"\n        *ngIf=\"isStatusScheduled() || isStatusExecutingOrExecutingWithError()\"\n        class=\"btn-clean m-l-4\"\n        popover=\"{{ finishDatePopoverText | translate }}\"\n        placement=\"right\"\n        outsideClick=\"true\"\n      >\n        <i c8yIcon=\"question-circle-o text-primary\"></i>\n      </a>\n    </div>\n  </div>\n  <ng-container *ngIf=\"!readOnly\">\n    <c8y-li-action\n      *ngIf=\"isStatusScheduled()\"\n      label=\"{{ 'Edit schedule' | translate }}\"\n      (click)=\"editSchedule()\"\n      icon=\"pencil\"\n    >\n    </c8y-li-action>\n    <c8y-li-action\n      *ngIf=\"\n        isStatusScheduled() || (isStatusExecutingOrExecutingWithError() && !allOperationsCreated())\n      \"\n      label=\"{{ 'Cancel bulk operation' | translate }}\"\n      (click)=\"cancelBulkOperation()\"\n      icon=\"remove\"\n    >\n    </c8y-li-action>\n    <c8y-li-action\n      *ngIf=\"isStatusFailed()\"\n      label=\"{{ 'Retry failed operations' | translate }}\"\n      (click)=\"retryFailedOperation()\"\n      icon=\"repeat\"\n    >\n    </c8y-li-action>\n    <c8y-li-action\n      *ngIf=\"isStatusFailed()\"\n      label=\"{{ 'Set operation to SUCCESSFUL' | translate }}\"\n      (click)=\"setToSuccessful()\"\n      icon=\"check-circle\"\n    >\n    </c8y-li-action>\n  </ng-container>\n  <c8y-li-collapse class=\"m-b-16\">\n    <c8y-bulk-operation-details-tabs\n      *ngIf=\"!listItem.collapsed\"\n      [bulkOperation]=\"bulkOperation\"\n      [readOnly]=\"readOnly\"\n      (onRetryFailedOperations)=\"retryFailedOperation()\"\n      (showFailedOperation)=\"openFailedOperation($event)\"\n    >\n    </c8y-bulk-operation-details-tabs>\n  </c8y-li-collapse>\n</c8y-li>\n"
            },] }
];
BulkOperationListItemComponent.ctorParameters = () => [
    { type: BulkOperationsService },
    { type: ModalService },
    { type: AlertService },
    { type: BsModalService }
];
BulkOperationListItemComponent.propDecorators = {
    bulkOperation: [{ type: Input }],
    detailsCollapsed: [{ type: Input }],
    readOnly: [{ type: Input }],
    showFailedOperation: [{ type: Output }],
    reload: [{ type: Output }],
    listItem: [{ type: ViewChild, args: ['listItem', { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1vcGVyYXRpb24tbGlzdC1pdGVtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL29wZXJhdGlvbnMvYnVsay1vcGVyYXRpb25zLWxpc3QvYnVsay1vcGVyYXRpb24tbGlzdC1pdGVtLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxZQUFZLEVBQ1osS0FBSyxFQUdMLE1BQU0sRUFFTixTQUFTLEVBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFrQiwwQkFBMEIsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN6RSxPQUFPLEVBQ0wsWUFBWSxFQUNaLE9BQU8sRUFFUCxZQUFZLEVBQ1osTUFBTSxFQUNQLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDOUMsT0FBTyxFQUFjLGNBQWMsRUFBZ0IsTUFBTSxxQkFBcUIsQ0FBQztBQUMvRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx3REFBd0QsQ0FBQztBQUUvRixPQUFPLEVBQUUsc0NBQXNDLEVBQUUsTUFBTSxxREFBcUQsQ0FBQztBQUM3RyxPQUFPLEVBQUUsbUNBQW1DLEVBQUUsNkJBQTZCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQU10SCxNQUFNLE9BQU8sOEJBQThCO0lBdUJ6QyxZQUNVLHFCQUE0QyxFQUM1QyxLQUFtQixFQUNuQixLQUFtQixFQUNuQixjQUE4QjtRQUg5QiwwQkFBcUIsR0FBckIscUJBQXFCLENBQXVCO1FBQzVDLFVBQUssR0FBTCxLQUFLLENBQWM7UUFDbkIsVUFBSyxHQUFMLEtBQUssQ0FBYztRQUNuQixtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUF2QnhDLHFCQUFnQixHQUFZLElBQUksQ0FBQztRQUVqQyxhQUFRLEdBQVksS0FBSyxDQUFDO1FBQ2hCLHdCQUFtQixHQUFHLElB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LEVBQUUsOEJBQThCO2dCQUN4QywycktBQXdEO2FBQ3pEOzs7WUFSUSxxQkFBcUI7WUFMNUIsWUFBWTtZQUhaLFlBQVk7WUFPTyxjQUFjOzs7NEJBV2hDLEtBQUs7K0JBRUwsS0FBSzt1QkFFTCxLQUFLO2tDQUVMLE1BQU07cUJBQ04sTUFBTTt1QkFDTixTQUFTLFNBQUMsVUFBVSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENvbXBvbmVudCxcbiAgRXZlbnRFbWl0dGVyLFxuICBJbnB1dCxcbiAgT25DaGFuZ2VzLFxuICBPbkluaXQsXG4gIE91dHB1dCxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgVmlld0NoaWxkXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSU9wZXJhdGlvbkJ1bGssIE9wZXJhdGlvbkJ1bGtHZW5lcmFsU3RhdHVzIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHtcbiAgQWxlcnRTZXJ2aWNlLFxuICBnZXR0ZXh0LFxuICBMaXN0SXRlbUNvbXBvbmVudCxcbiAgTW9kYWxTZXJ2aWNlLFxuICBTdGF0dXNcbn0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBhc3NpZ24sIGNsb25lRGVlcCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBCc01vZGFsUmVmLCBCc01vZGFsU2VydmljZSwgTW9kYWxPcHRpb25zIH0gZnJvbSAnbmd4LWJvb3RzdHJhcC9tb2RhbCc7XG5pbXBvcnQgeyBCdWxrT3BlcmF0aW9uc1NlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL29wZXJhdGlvbnMvYnVsay1vcGVyYXRpb25zLXNlcnZpY2UnO1xuaW1wb3J0IHsgSVN0YXR1c09wdGlvbiB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvb3BlcmF0aW9ucy9zdGF0dXMtZmlsdGVyJztcbmltcG9ydCB7IEJ1bGtPcGVyYXRpb25zUmVzY2hlZHVsZU1vZGFsQ29tcG9uZW50IH0gZnJvbSAnLi9tb2RhbHMvYnVsay1vcGVyYXRpb25zLXJlc2NoZWR1bGUtbW9kYWwuY29tcG9uZW50JztcbmltcG9ydCB7IEJVTEtfT1BFUkFUSU9OX0ZBTExCQUNLX1NUQVRVU19JQ09OLCBCVUxLX09QRVJBVElPTl9TVEFUVVNfT1BUSU9OUyB9IGZyb20gJy4vYnVsay1vcGVyYXRpb24tbGlzdC1pdGVtLm1vZGVsJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWJ1bGstb3BlcmF0aW9uLWxpc3QtaXRlbScsXG4gIHRlbXBsYXRlVXJsOiAnLi9idWxrLW9wZXJhdGlvbi1saXN0LWl0ZW0uY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIEJ1bGtPcGVyYXRpb25MaXN0SXRlbUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcbiAgQElucHV0KClcbiAgYnVsa09wZXJhdGlvbjogUGFydGlhbDxJT3BlcmF0aW9uQnVsaz47XG4gIEBJbnB1dCgpXG4gIGRldGFpbHNDb2xsYXBzZWQ6IGJvb2xlYW4gPSB0cnVlO1xuICBASW5wdXQoKVxuICByZWFkT25seTogYm9vbGVhbiA9IGZhbHNlO1xuICBAT3V0cHV0KCkgc2hvd0ZhaWxlZE9wZXJhdGlvbiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgQE91dHB1dCgpIHJlbG9hZDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBWaWV3Q2hpbGQoJ2xpc3RJdGVtJywgeyBzdGF0aWM6IHRydWUgfSkgbGlzdEl0ZW06IExpc3RJdGVtQ29tcG9uZW50O1xuICBpY29uQ2xhc3M6IHN0cmluZztcbiAgZmluaXNoRGF0ZTogbnVtYmVyO1xuICByZWZyZXNoTG9hZGluZyA9IGZhbHNlO1xuICBidWxrT3BlcmF0aW9uR2VuZXJhbFN0YXR1cyA9IE9wZXJhdGlvbkJ1bGtHZW5lcmFsU3RhdHVzO1xuICBidWxrT3BlcmF0aW9uU3RhdHVzT3B0aW9uczogSVN0YXR1c09wdGlvbltdID0gQlVMS19PUEVSQVRJT05fU1RBVFVTX09QVElPTlM7XG4gIGJzTW9kYWxSZWY6IEJzTW9kYWxSZWY7XG4gIGZpbmlzaERhdGVQb3BvdmVyVGV4dDogc3RyaW5nID0gZ2V0dGV4dChcbiAgICAnQXBwcm94aW1hdGUgZGF0ZSwgZXN0aW1hdGVkIGJhc2VkIG9uIHRoZSBidWxrIG9wZXJhdGlvbiBzZXR0aW5ncy4nXG4gICk7XG4gIHByb2dyZXNzQmFyQ2xhc3M6IHN0cmluZyA9ICdwcm9ncmVzcyc7XG4gIHByb2dyZXNzQmFyQ29sb3I6IHN0cmluZztcbiAgcHJvZ3Jlc3NCYXJTdGF0dXM6IG51bWJlciA9IDA7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBidWxrT3BlcmF0aW9uc1NlcnZpY2U6IEJ1bGtPcGVyYXRpb25zU2VydmljZSxcbiAgICBwcml2YXRlIG1vZGFsOiBNb2RhbFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhbGVydDogQWxlcnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgYnNNb2RhbFNlcnZpY2U6IEJzTW9kYWxTZXJ2aWNlXG4gICkge31cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmljb25DbGFzcyA9IHRoaXMuZ2V0SWNvbkNsYXNzKCk7XG4gICAgdGhpcy5maW5pc2hEYXRlID0gdGhpcy5jYWxjdWxhdGVGaW5pc2hEYXRlTXMoKTtcbiAgICB0aGlzLnNldFByb2dyZXNzQmFyKCk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKGNoYW5nZXMuYnVsa09wZXJhdGlvbiAmJiAhY2hhbmdlcy5idWxrT3BlcmF0aW9uLmZpcnN0Q2hhbmdlKSB7XG4gICAgICB0aGlzLmljb25DbGFzcyA9IHRoaXMuZ2V0SWNvbkNsYXNzKCk7XG4gICAgICB0aGlzLnNldFByb2dyZXNzQmFyKCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0SWNvbkNsYXNzKCkge1xuICAgIGNvbnN0IHN0YXR1c09wdGlvbnMgPSB0aGlzLmJ1bGtPcGVyYXRpb25TdGF0dXNPcHRpb25zLmZpbmQoc3RhdHVzT3B0aW9uID0+XG4gICAgICBzdGF0dXNPcHRpb24uZ2VuZXJhbFN0YXR1cy5pbmNsdWRlcyh0aGlzLmJ1bGtPcGVyYXRpb24uZ2VuZXJhbFN0YXR1cylcbiAgICApO1xuICAgIHJldHVybiBzdGF0dXNPcHRpb25zID8gc3RhdHVzT3B0aW9ucy5pY29uQ2xhc3MgOiBCVUxLX09QRVJBVElPTl9GQUxMQkFDS19TVEFUVVNfSUNPTjtcbiAgfVxuXG4gIGNhbGN1bGF0ZUZpbmlzaERhdGVNcygpOiBudW1iZXIge1xuICAgIGNvbnN0IHN0YXJ0RGF0ZU1zOiBudW1iZXIgPSBuZXcgRGF0ZSh0aGlzLmJ1bGtPcGVyYXRpb24uc3RhcnREYXRlKS5nZXRUaW1lKCk7XG4gICAgY29uc3QgY3JlYXRpb25SYW1wTXM6IG51bWJlciA9IHRoaXMuYnVsa09wZXJhdGlvbi5jcmVhdGlvblJhbXAgKiAxMDAwO1xuXG4gICAgcmV0dXJuIHN0YXJ0RGF0ZU1zICsgY3JlYXRpb25SYW1wTXMgKiB0aGlzLmJ1bGtPcGVyYXRpb24ucHJvZ3Jlc3MuYWxsO1xuICB9XG5cbiAgcHJvZ3Jlc3NCYXJQcm9ncmVzc0ZuKCkge1xuICAgIHJldHVybiAoXG4gICAgICAoKHRoaXMuYnVsa09wZXJhdGlvbi5wcm9ncmVzcy5zdWNjZXNzZnVsICsgdGhpcy5idWxrT3BlcmF0aW9uLnByb2dyZXNzLmZhaWxlZCkgL1xuICAgICAgICB0aGlzLmJ1bGtPcGVyYXRpb24ucHJvZ3Jlc3MuYWxsKSAqXG4gICAgICAxMDBcbiAgICApO1xuICB9XG5cbiAgc2V0UHJvZ3Jlc3NCYXIoKSB7XG4gICAgY29uc3Qgc3RhdGljQ29udGVudE9mQ2xhc3MgPSAncHJvZ3Jlc3MtYmFyIHByb2dyZXNzLXN0cmlwZWQgYWN0aXZlIHByb2dyZXNzLWJhcic7XG5cbiAgICBjb25zdCBwcm9ncmVzc0JhclN0YXRlID0ge1xuICAgICAgRVhFQ1VUSU5HOiB7XG4gICAgICAgIHByb2dyZXNzQmFyQ2xhc3M6ICdwcm9ncmVzcyBwcm9ncmVzcy1zdHJpcGVkIGFjdGl2ZScsXG4gICAgICAgIHByb2dyZXNzQmFyQ29sb3I6IGAke3N0YXRpY0NvbnRlbnRPZkNsYXNzfS1wcmltYXJ5YCxcbiAgICAgICAgcHJvZ3Jlc3NCYXJTdGF0dXM6IHRoaXMucHJvZ3Jlc3NCYXJQcm9ncmVzc0ZuKClcbiAgICAgIH0sXG4gICAgICBFWEVDVVRJTkdfV0lUSF9FUlJPUjoge1xuICAgICAgICBwcm9ncmVzc0JhckNsYXNzOiAncHJvZ3Jlc3MgcHJvZ3Jlc3Mtc3RyaXBlZCBhY3RpdmUnLFxuICAgICAgICBwcm9ncmVzc0JhckNvbG9yOiBgJHtzdGF0aWNDb250ZW50T2ZDbGFzc30tZGFuZ2VyYCxcbiAgICAgICAgcHJvZ3Jlc3NCYXJTdGF0dXM6IHRoaXMucHJvZ3Jlc3NCYXJQcm9ncmVzc0ZuKClcbiAgICAgIH0sXG4gICAgICBGQUlMRUQ6IHtcbiAgICAgICAgcHJvZ3Jlc3NCYXJDbGFzczogJ3Byb2dyZXNzJyxcbiAgICAgICAgcHJvZ3Jlc3NCYXJDb2xvcjogYCR7c3RhdGljQ29udGVudE9mQ2xhc3N9LWRhbmdlcmAsXG4gICAgICAgIHByb2dyZXNzQmFyU3RhdHVzOiAxMDBcbiAgICAgIH0sXG4gICAgICBTVUNDRVNTRlVMOiB7XG4gICAgICAgIHByb2dyZXNzQmFyQ2xhc3M6ICdwcm9ncmVzcycsXG4gICAgICAgIHByb2dyZXNzQmFyQ29sb3I6IGAke3N0YXRpY0NvbnRlbnRPZkNsYXNzfS1zdWNjZXNzYCxcbiAgICAgICAgcHJvZ3Jlc3NCYXJTdGF0dXM6IDEwMFxuICAgICAgfVxuICAgIH07XG5cbiAgICBhc3NpZ24odGhpcywgcHJvZ3Jlc3NCYXJTdGF0ZVt0aGlzLmJ1bGtPcGVyYXRpb24uZ2VuZXJhbFN0YXR1c10pO1xuICB9XG5cbiAgZWRpdFNjaGVkdWxlKCkge1xuICAgIGNvbnN0IHJlc2NoZWR1bGVkT3BlcmF0aW9uID0gY2xvbmVEZWVwKHRoaXMuYnVsa09wZXJhdGlvbik7XG4gICAgY29uc3QgaW5pdGlhbFN0YXRlID0ge1xuICAgICAgYnVsa09wZXJhdGlvbjogcmVzY2hlZHVsZWRPcGVyYXRpb25cbiAgICB9O1xuICAgIGNvbnN0IG1vZGFsT3B0aW9ucyA9IHsgaW5pdGlhbFN0YXRlLCBjbGFzczogJ21vZGFsLXNtJywgYmFja2Ryb3A6ICdzdGF0aWMnIH0gYXMgTW9kYWxPcHRpb25zO1xuICAgIHRoaXMuYnNNb2RhbFJlZiA9IHRoaXMuYnNNb2RhbFNlcnZpY2Uuc2hvdyhcbiAgICAgIEJ1bGtPcGVyYXRpb25zUmVzY2hlZHVsZU1vZGFsQ29tcG9uZW50LFxuICAgICAgbW9kYWxPcHRpb25zXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGNhbmNlbEJ1bGtPcGVyYXRpb24oKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMubW9kYWwuY29uZmlybShcbiAgICAgICAgZ2V0dGV4dCgnQ2FuY2VsIGJ1bGsgb3BlcmF0aW9uJyksXG4gICAgICAgIGdldHRleHQoJ1lvdSBhcmUgYWJvdXQgdG8gY2FuY2VsIHRoZSBidWxrIG9wZXJhdGlvbi4gRG8geW91IHdhbnQgdG8gcHJvY2VlZD8nKSxcbiAgICAgICAgU3RhdHVzLkRBTkdFUlxuICAgICAgKTtcbiAgICAgIGF3YWl0IHRoaXMuYnVsa09wZXJhdGlvbnNTZXJ2aWNlLmRlbGV0ZUJ1bGtPcGVyYXRpb24odGhpcy5idWxrT3BlcmF0aW9uLmlkKTtcbiAgICAgIHRoaXMucmVsb2FkLmVtaXQoKTtcbiAgICAgIHRoaXMuYWxlcnQuc3VjY2VzcyhnZXR0ZXh0KCdPcGVyYXRpb24gY2FuY2VsZWQuJykpO1xuICAgIH0gY2F0Y2ggKGVyKSB7XG4gICAgICB0aGlzLmFsZXJ0LmFkZFNlcnZlckZhaWx1cmUoZXIpO1xuICAgIH1cbiAgfVxuXG4gIHJldHJ5RmFpbGVkT3BlcmF0aW9uKCkge1xuICAgIGNvbnN0IGNsb25lZEJ1bGsgPSBjbG9uZURlZXAodGhpcy5idWxrT3BlcmF0aW9uKTtcblxuICAgIC8vIGNoYW5nZSB0aGUgaWQgdG8gZmFpbGVkcGFyZW50SWQgc2ltaWxhciB0byB0aGUgbG9naWMgaW4gZGV2aWNlQnVsa0NvbnRyb2wuc2VydmljZS5qc1xuICAgIGRlbGV0ZSBjbG9uZWRCdWxrLmdyb3VwSWQ7XG4gICAgY2xvbmVkQnVsay5mYWlsZWRQYXJlbnRJZCA9IHRoaXMuYnVsa09wZXJhdGlvbi5pZDtcblxuICAgIC8vIHNob3cgcmVzY2hkZWR1bGUgbW9kYWw6XG4gICAgY29uc3QgaW5pdGlhbFN0YXRlID0ge1xuICAgICAgYnVsa09wZXJhdGlvbjogY2xvbmVkQnVsayxcbiAgICAgIGlzUmV0cnlPcGVyYXRpb246IHRydWVcbiAgICB9O1xuICAgIGNvbnN0IG1vZGFsT3B0aW9ucyA9IHsgaW5pdGlhbFN0YXRlLCBjbGFzczogJ21vZGFsLXNtJywgYmFja2Ryb3A6ICdzdGF0aWMnIH0gYXMgTW9kYWxPcHRpb25zO1xuICAgIHRoaXMuYnNNb2RhbFJlZiA9IHRoaXMuYnNNb2RhbFNlcnZpY2Uuc2hvdyhcbiAgICAgIEJ1bGtPcGVyYXRpb25zUmVzY2hlZHVsZU1vZGFsQ29tcG9uZW50LFxuICAgICAgbW9kYWxPcHRpb25zXG4gICAgKTtcbiAgICB0aGlzLmJzTW9kYWxSZWYuY29udGVudC5jbG9zZVN1YmplY3Quc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHRoaXMucmVsb2FkLmVtaXQoKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIHNldFRvU3VjY2Vzc2Z1bCgpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5tb2RhbC5jb25maXJtKFxuICAgICAgICBnZXR0ZXh0KCdTZXQgbWFudWFsbHkgYnVsayBvcGVyYXRpb24gdG8gU1VDQ0VTU0ZVTCcpLFxuICAgICAgICBnZXR0ZXh0KFxuICAgICAgICAgICdZb3UgYXJlIGFib3V0IHRvIGNoYW5nZSB0aGUgYnVsayBvcGVyYXRpb24gc3RhdHVzIHRvIFNVQ0NFU1NGVUwuIERvIHlvdSB3YW50IHRvIHByb2NlZWQ/J1xuICAgICAgICApLFxuICAgICAgICBTdGF0dXMuREFOR0VSXG4gICAgICApO1xuXG4gICAgICBhd2FpdCB0aGlzLmJ1bGtPcGVyYXRpb25zU2VydmljZS51cGRhdGVCdWxrT3BlcmF0aW9uKHtcbiAgICAgICAgaWQ6IHRoaXMuYnVsa09wZXJhdGlvbi5pZCxcbiAgICAgICAgZ2VuZXJhbFN0YXR1czogT3BlcmF0aW9uQnVsa0dlbmVyYWxTdGF0dXMuU1VDQ0VTU0ZVTFxuICAgICAgfSk7XG4gICAgICB0aGlzLnJlbG9hZC5lbWl0KCk7XG4gICAgICB0aGlzLmFsZXJ0LnN1Y2Nlc3MoZ2V0dGV4dCgnT3BlcmF0aW9uIHN0YXR1cyBjaGFuZ2VkIHRvIFNVQ0NFU1NGVUwuJykpO1xuICAgIH0gY2F0Y2ggKGVyKSB7XG4gICAgICB0aGlzLmFsZXJ0LmFkZFNlcnZlckZhaWx1cmUoZXIpO1xuICAgIH1cbiAgfVxuXG4gIG9wZW5GYWlsZWRPcGVyYXRpb24oZmFpbGVkUGFyZW50SWQpIHtcbiAgICB0aGlzLnNob3dGYWlsZWRPcGVyYXRpb24uZW1pdChmYWlsZWRQYXJlbnRJZCk7XG4gIH1cblxuICBpc1N0YXR1c1NjaGVkdWxlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5idWxrT3BlcmF0aW9uLmdlbmVyYWxTdGF0dXMgPT09IHRoaXMuYnVsa09wZXJhdGlvbkdlbmVyYWxTdGF0dXMuU0NIRURVTEVEO1xuICB9XG5cbiAgaXNTdGF0dXNFeGVjdXRpbmdPckV4ZWN1dGluZ1dpdGhFcnJvcigpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5idWxrT3BlcmF0aW9uLmdlbmVyYWxTdGF0dXMgPT09IHRoaXMuYnVsa09wZXJhdGlvbkdlbmVyYWxTdGF0dXMuRVhFQ1VUSU5HIHx8XG4gICAgICB0aGlzLmJ1bGtPcGVyYXRpb24uZ2VuZXJhbFN0YXR1cyA9PT0gdGhpcy5idWxrT3BlcmF0aW9uR2VuZXJhbFN0YXR1cy5FWEVDVVRJTkdfV0lUSF9FUlJPUlxuICAgICk7XG4gIH1cblxuICBhbGxPcGVyYXRpb25zQ3JlYXRlZCgpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdGhpcy5idWxrT3BlcmF0aW9uLnByb2dyZXNzLmFsbCA9PT1cbiAgICAgIHRoaXMuYnVsa09wZXJhdGlvbi5wcm9ncmVzcy5leGVjdXRpbmcgK1xuICAgICAgICB0aGlzLmJ1bGtPcGVyYXRpb24ucHJvZ3Jlc3MuZmFpbGVkICtcbiAgICAgICAgdGhpcy5idWxrT3BlcmF0aW9uLnByb2dyZXNzLnBlbmRpbmcgK1xuICAgICAgICB0aGlzLmJ1bGtPcGVyYXRpb24ucHJvZ3Jlc3Muc3VjY2Vzc2Z1bFxuICAgICk7XG4gIH1cblxuICBpc1N0YXR1c0NhbmNlbGVkKCkge1xuICAgIHJldHVybiB0aGlzLmJ1bGtPcGVyYXRpb24uZ2VuZXJhbFN0YXR1cyA9PT0gdGhpcy5idWxrT3BlcmF0aW9uR2VuZXJhbFN0YXR1cy5DQU5DRUxFRDtcbiAgfVxuXG4gIGlzU3RhdHVzRmFpbGVkKCkge1xuICAgIHJldHVybiB0aGlzLmJ1bGtPcGVyYXRpb24uZ2VuZXJhbFN0YXR1cyA9PT0gdGhpcy5idWxrT3BlcmF0aW9uR2VuZXJhbFN0YXR1cy5GQUlMRUQ7XG4gIH1cbn1cbiJdfQ==