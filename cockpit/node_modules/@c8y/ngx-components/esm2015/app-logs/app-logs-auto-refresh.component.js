import { Component, Input, Output, ViewChild, EventEmitter } from '@angular/core';
import { AppLogsService } from './app-logs.service';
import { fromEvent, Subject, of, interval, NEVER } from 'rxjs';
import { filter, catchError, tap, debounce, switchMap, takeUntil, finalize, delay, repeat, merge, scan } from 'rxjs/operators';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './app-logs.service';
import * as ɵngcc2 from '@angular/common';
import * as ɵngcc3 from '@c8y/ngx-components';

const _c0 = ["autoRefresh"];
const _c1 = function () { return { "width": "auto" }; };
export class AppLogsAutoRefreshComponent {
    constructor(appLogsService) {
        this.appLogsService = appLogsService;
        this.cancel$ = new Subject();
        this.isAutoRefreshDisabled = false;
        this.logsToOutput = this.getEmptyLogsJson();
        this.isAutoRefreshOn = true;
        this.onNewLogs = new EventEmitter();
        this.isRealtimeEnabled = new EventEmitter();
        this.toggleState = currentState => !currentState;
    }
    set buttonsDisabled(areDisabled) {
        this.isAutoRefreshDisabled = areDisabled;
        if (areDisabled && this.isAutoRefreshOn) {
            this.isAutoRefreshOn = false;
            this.cancel$.next(false);
        }
    }
    ngAfterViewInit() {
        const clicks$ = fromEvent(this.button.nativeElement, 'click').pipe(merge(this.cancel$), debounce(() => interval(300)), scan(this.toggleState, false), tap(isAutoRefreshOn => this.setButtonState(isAutoRefreshOn)), switchMap(isOn => (isOn ? this.watchForNewLogs() : NEVER)));
        this.subscription = clicks$.subscribe();
    }
    ngOnDestroy() {
        if (this.subscription) {
            this.subscription.unsubscribe();
        }
    }
    setButtonState(isAutoRefreshOn) {
        this.isAutoRefreshOn = isAutoRefreshOn;
        this.isRealtimeEnabled.emit(isAutoRefreshOn);
    }
    watchForNewLogs() {
        return this.startPolling().pipe(takeUntil(this.cancel$.pipe(filter(isAutoRefreshOn => isAutoRefreshOn === false))), finalize(() => {
            this.isAutoRefreshOn = false;
        }));
    }
    startPolling() {
        return of(1).pipe(switchMap(() => this.getNewLogs().pipe(catchError(er => of(this.getEmptyLogsJson())))), tap(logs => this.updateLogsToOutput(logs)), delay(10000), repeat());
    }
    getNewLogs() {
        return this.appLogsService.getLogs$(this.getAppId(), this.getInstanceName());
    }
    getAppId() {
        return this.mo.applicationId;
    }
    getInstanceName() {
        return this.selectedInstance.name;
    }
    updateLogsToOutput(newLogs) {
        const { dateFrom, dateTo } = newLogs;
        if (dateFrom && dateTo) {
            this.logsToOutput = Object.assign({}, newLogs);
            this.onNewLogs.emit(this.logsToOutput);
        }
    }
    getEmptyLogsJson() {
        return {
            dateFrom: null,
            dateTo: null,
            logs: '',
            truncated: false
        };
    }
}
AppLogsAutoRefreshComponent.ɵfac = function AppLogsAutoRefreshComponent_Factory(t) { return new (t || AppLogsAutoRefreshComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.AppLogsService)); };
AppLogsAutoRefreshComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: AppLogsAutoRefreshComponent, selectors: [["c8y-app-logs-auto-refresh"]], viewQuery: function AppLogsAutoRefreshComponent_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵviewQuery(_c0, 7);
    } if (rf & 2) {
        let _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.button = _t.first);
    } }, inputs: { buttonsDisabled: "buttonsDisabled", selectedInstance: "selectedInstance", mo: "mo" }, outputs: { onNewLogs: "onNewLogs", isRealtimeEnabled: "isRealtimeEnabled" }, decls: 6, vars: 10, consts: [["type", "button", 1, "btn", "btn-link", "c8y-realtime", 3, "ngStyle", "title", "disabled"], ["autoRefresh", ""], [1, "c8y-pulse", 3, "ngClass"]], template: function AppLogsAutoRefreshComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "button", 0, 1);
        ɵngcc0.ɵɵpipe(2, "translate");
        ɵngcc0.ɵɵelement(3, "span", 2);
        ɵngcc0.ɵɵtext(4);
        ɵngcc0.ɵɵpipe(5, "translate");
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(2, 5, "Toggle auto refresh"));
        ɵngcc0.ɵɵproperty("ngStyle", ɵngcc0.ɵɵpureFunction0(9, _c1))("disabled", ctx.isAutoRefreshDisabled);
        ɵngcc0.ɵɵadvance(3);
        ɵngcc0.ɵɵproperty("ngClass", ctx.isAutoRefreshOn ? "active" : "inactive");
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(5, 7, "Auto refresh"), "\n");
    } }, directives: [ɵngcc2.NgStyle, ɵngcc2.NgClass], pipes: [ɵngcc3.C8yTranslatePipe], encapsulation: 2 });
AppLogsAutoRefreshComponent.ctorParameters = () => [
    { type: AppLogsService }
];
AppLogsAutoRefreshComponent.propDecorators = {
    selectedInstance: [{ type: Input }],
    mo: [{ type: Input }],
    buttonsDisabled: [{ type: Input }],
    onNewLogs: [{ type: Output }],
    isRealtimeEnabled: [{ type: Output }],
    button: [{ type: ViewChild, args: ['autoRefresh', { static: true },] }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(AppLogsAutoRefreshComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-app-logs-auto-refresh',
                template: "<button #autoRefresh\n  type=\"button\"\n  class=\"btn btn-link c8y-realtime\"\n  [ngStyle]=\"{'width': 'auto'}\"\n  title=\"{{'Toggle auto refresh' | translate}}\"\n  [disabled]=\"isAutoRefreshDisabled\"\n>\n  <span class=\"c8y-pulse\" [ngClass]=\"isAutoRefreshOn ? 'active' : 'inactive'\"></span>\n  {{'Auto refresh' | translate}}\n</button>"
            }]
    }], function () { return [{ type: ɵngcc1.AppLogsService }]; }, { onNewLogs: [{
            type: Output
        }], isRealtimeEnabled: [{
            type: Output
        }], buttonsDisabled: [{
            type: Input
        }], selectedInstance: [{
            type: Input
        }], mo: [{
            type: Input
        }], button: [{
            type: ViewChild,
            args: ['autoRefresh', { static: true }]
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLWxvZ3MtYXV0by1yZWZyZXNoLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vYXBwLWxvZ3MvYXBwLWxvZ3MtYXV0by1yZWZyZXNoLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBYyxNQUFNLGVBQWUsQ0FBQztBQUU5RixPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDcEQsT0FBTyxFQUFjLFNBQVMsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBQ3pGLE9BQU8sRUFDTCxNQUFNLEVBQ04sVUFBVSxFQUNWLEdBQUcsRUFDSCxRQUFRLEVBQ1IsU0FBUyxFQUNULFNBQVMsRUFDVCxRQUFRLEVBQ1IsS0FBSyxFQUNMLE1BQU0sRUFDTixLQUFLLEVBQ0wsSUFBSSxFQUNMLE1BQU0sZ0JBQWdCLENBQUM7Ozs7Ozs7O0FBTXhCLE1BQU0sT0FBTywyQkFBMkI7QUFDeEMsSUFvQkUsWUFBb0IsY0FBOEI7QUFBSSxRQUFsQyxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7QUFBQyxRQXBCbkQsWUFBTyxHQUFxQixJQUFJLE9BQU8sRUFBVyxDQUFDO0FBQ3JELFFBQUUsMEJBQXFCLEdBQVksS0FBSyxDQUFDO0FBQ3pDLFFBQUUsaUJBQVksR0FBYSxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztBQUNuRCxRQUFFLG9CQUFlLEdBQVksSUFBSSxDQUFDO0FBQ2xDLFFBVVksY0FBUyxHQUFHLElBQUksWUFBWSxFQUFZLENBQUM7QUFDckQsUUFBWSxzQkFBaUIsR0FBRyxJQUFJLFlBQVksRUFBVyxDQUFDO0FBQzVELFFBc0JVLGdCQUFXLEdBQUcsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQztBQUN0RCxJQW5CdUQsQ0FBQztB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aGlsZCwgRXZlbnRFbWl0dGVyLCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBMb2dzSlNPTiB9IGZyb20gJy4vbG9ncy5tb2RlbCc7XG5pbXBvcnQgeyBBcHBMb2dzU2VydmljZSB9IGZyb20gJy4vYXBwLWxvZ3Muc2VydmljZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBmcm9tRXZlbnQsIFN1YmplY3QsIG9mLCBpbnRlcnZhbCwgTkVWRVIsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgZmlsdGVyLFxuICBjYXRjaEVycm9yLFxuICB0YXAsXG4gIGRlYm91bmNlLFxuICBzd2l0Y2hNYXAsXG4gIHRha2VVbnRpbCxcbiAgZmluYWxpemUsXG4gIGRlbGF5LFxuICByZXBlYXQsXG4gIG1lcmdlLFxuICBzY2FuXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWFwcC1sb2dzLWF1dG8tcmVmcmVzaCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9hcHAtbG9ncy1hdXRvLXJlZnJlc2guY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIEFwcExvZ3NBdXRvUmVmcmVzaENvbXBvbmVudCB7XG4gIGNhbmNlbCQ6IFN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xuICBpc0F1dG9SZWZyZXNoRGlzYWJsZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgbG9nc1RvT3V0cHV0OiBMb2dzSlNPTiA9IHRoaXMuZ2V0RW1wdHlMb2dzSnNvbigpO1xuICBpc0F1dG9SZWZyZXNoT246IGJvb2xlYW4gPSB0cnVlO1xuXG4gIEBJbnB1dCgpIHNlbGVjdGVkSW5zdGFuY2U6IGFueTtcbiAgQElucHV0KCkgbW86IGFueTtcbiAgQElucHV0KCkgc2V0IGJ1dHRvbnNEaXNhYmxlZChhcmVEaXNhYmxlZDogYm9vbGVhbikge1xuICAgIHRoaXMuaXNBdXRvUmVmcmVzaERpc2FibGVkID0gYXJlRGlzYWJsZWQ7XG4gICAgaWYgKGFyZURpc2FibGVkICYmIHRoaXMuaXNBdXRvUmVmcmVzaE9uKSB7XG4gICAgICB0aGlzLmlzQXV0b1JlZnJlc2hPbiA9IGZhbHNlO1xuICAgICAgdGhpcy5jYW5jZWwkLm5leHQoZmFsc2UpO1xuICAgIH1cbiAgfVxuICBAT3V0cHV0KCkgb25OZXdMb2dzID0gbmV3IEV2ZW50RW1pdHRlcjxMb2dzSlNPTj4oKTtcbiAgQE91dHB1dCgpIGlzUmVhbHRpbWVFbmFibGVkID0gbmV3IEV2ZW50RW1pdHRlcjxib29sZWFuPigpO1xuICBAVmlld0NoaWxkKCdhdXRvUmVmcmVzaCcsIHsgc3RhdGljOiB0cnVlIH0pIGJ1dHRvbjogRWxlbWVudFJlZjtcblxuICBwcml2YXRlIHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBwTG9nc1NlcnZpY2U6IEFwcExvZ3NTZXJ2aWNlKSB7fVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICBjb25zdCBjbGlja3MkID0gZnJvbUV2ZW50KHRoaXMuYnV0dG9uLm5hdGl2ZUVsZW1lbnQsICdjbGljaycpLnBpcGUoXG4gICAgICBtZXJnZSh0aGlzLmNhbmNlbCQpLFxuICAgICAgZGVib3VuY2UoKCkgPT4gaW50ZXJ2YWwoMzAwKSksXG4gICAgICBzY2FuKHRoaXMudG9nZ2xlU3RhdGUsIGZhbHNlKSxcbiAgICAgIHRhcChpc0F1dG9SZWZyZXNoT24gPT4gdGhpcy5zZXRCdXR0b25TdGF0ZShpc0F1dG9SZWZyZXNoT24pKSxcbiAgICAgIHN3aXRjaE1hcChpc09uID0+IChpc09uID8gdGhpcy53YXRjaEZvck5ld0xvZ3MoKSA6IE5FVkVSKSlcbiAgICApO1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uID0gY2xpY2tzJC5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cbiAgcHJpdmF0ZSB0b2dnbGVTdGF0ZSA9IGN1cnJlbnRTdGF0ZSA9PiAhY3VycmVudFN0YXRlO1xuXG4gIHByaXZhdGUgc2V0QnV0dG9uU3RhdGUoaXNBdXRvUmVmcmVzaE9uOiBib29sZWFuKSB7XG4gICAgdGhpcy5pc0F1dG9SZWZyZXNoT24gPSBpc0F1dG9SZWZyZXNoT247XG4gICAgdGhpcy5pc1JlYWx0aW1lRW5hYmxlZC5lbWl0KGlzQXV0b1JlZnJlc2hPbik7XG4gIH1cblxuICBwcml2YXRlIHdhdGNoRm9yTmV3TG9ncygpIHtcbiAgICByZXR1cm4gdGhpcy5zdGFydFBvbGxpbmcoKS5waXBlKFxuICAgICAgdGFrZVVudGlsKHRoaXMuY2FuY2VsJC5waXBlKGZpbHRlcihpc0F1dG9SZWZyZXNoT24gPT4gaXNBdXRvUmVmcmVzaE9uID09PSBmYWxzZSkpKSxcbiAgICAgIGZpbmFsaXplKCgpID0+IHtcbiAgICAgICAgdGhpcy5pc0F1dG9SZWZyZXNoT24gPSBmYWxzZTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhcnRQb2xsaW5nKCkge1xuICAgIHJldHVybiBvZigxKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2V0TmV3TG9ncygpLnBpcGUoY2F0Y2hFcnJvcihlciA9PiBvZih0aGlzLmdldEVtcHR5TG9nc0pzb24oKSkpKSksXG4gICAgICB0YXAobG9ncyA9PiB0aGlzLnVwZGF0ZUxvZ3NUb091dHB1dChsb2dzKSksXG4gICAgICBkZWxheSgxMDAwMCksXG4gICAgICByZXBlYXQoKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldE5ld0xvZ3MoKTogT2JzZXJ2YWJsZTxMb2dzSlNPTj4ge1xuICAgIHJldHVybiB0aGlzLmFwcExvZ3NTZXJ2aWNlLmdldExvZ3MkKHRoaXMuZ2V0QXBwSWQoKSwgdGhpcy5nZXRJbnN0YW5jZU5hbWUoKSk7XG4gIH1cblxuICBwcml2YXRlIGdldEFwcElkKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMubW8uYXBwbGljYXRpb25JZDtcbiAgfVxuICBwcml2YXRlIGdldEluc3RhbmNlTmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnNlbGVjdGVkSW5zdGFuY2UubmFtZTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlTG9nc1RvT3V0cHV0KG5ld0xvZ3MpIHtcbiAgICBjb25zdCB7IGRhdGVGcm9tLCBkYXRlVG8gfSA9IG5ld0xvZ3M7XG4gICAgaWYgKGRhdGVGcm9tICYmIGRhdGVUbykge1xuICAgICAgdGhpcy5sb2dzVG9PdXRwdXQgPSB7IC4uLm5ld0xvZ3MgfTtcbiAgICAgIHRoaXMub25OZXdMb2dzLmVtaXQodGhpcy5sb2dzVG9PdXRwdXQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0RW1wdHlMb2dzSnNvbigpOiBMb2dzSlNPTiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGRhdGVGcm9tOiBudWxsLFxuICAgICAgZGF0ZVRvOiBudWxsLFxuICAgICAgbG9nczogJycsXG4gICAgICB0cnVuY2F0ZWQ6IGZhbHNlXG4gICAgfTtcbiAgfVxufVxuIl19