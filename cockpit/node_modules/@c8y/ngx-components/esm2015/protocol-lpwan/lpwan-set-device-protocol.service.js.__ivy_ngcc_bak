import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { InventoryService, FetchClient, IdentityService } from '@c8y/client';
import { get } from 'lodash-es';
export class LpwanSetDeviceProtocolService {
    constructor(inventoryService, client, identityService) {
        this.inventoryService = inventoryService;
        this.client = client;
        this.identityService = identityService;
        this.supportedDevicesCfgs = [
            {
                name: 'lora',
                match: device => get(device, 'c8y_LpwanDevice.lpwanDeviceType') === 'Lora',
                protocolTypes: ['c8y_ActilityDeviceType', 'c8y_LoraDeviceType', 'c8y_LpwanDeviceType'],
                externalIdTypes: ['c8y_LoriotEUI', 'c8y_Serial']
            },
            {
                name: 'sigfox',
                match: device => get(device, 'c8y_LpwanDevice.serviceProvider') === 'Sigfox',
                protocolTypes: ['c8y_SigfoxDeviceType', 'c8y_LpwanDeviceType'],
                externalIdTypes: ['com.sigfox.deviceId']
            }
        ];
        this.header = { 'Content-Type': 'application/json' };
    }
    refreshCache(device) {
        return __awaiter(this, void 0, void 0, function* () {
            const externalId = yield this.getExternalId(device);
            if (externalId) {
                const url = `${this.getMicroserviceUrl(device)}/refreshCache/${externalId}`;
                const options = {
                    method: 'POST',
                    headers: this.header,
                    body: JSON.stringify({})
                };
                return this.client.fetch(url, options);
            }
        });
    }
    getMicroserviceUrl(device) {
        const { serviceProvider } = device.c8y_LpwanDevice;
        let serviceName = serviceProvider.toLowerCase();
        if (serviceProvider === 'Sigfox') {
            serviceName = 'sigfox-agent';
        }
        return `/service/${serviceName}`;
    }
    isSupportedDevice(device) {
        return this.supportedDevicesCfgs.some(({ match }) => match(device));
    }
    getCurrentProtocol(device) {
        return __awaiter(this, void 0, void 0, function* () {
            const lpwanDevice = device.c8y_LpwanDevice;
            let protocolId;
            if (lpwanDevice.typeExternalId) {
                const externalId = (yield this.identityService.detail(lpwanDevice.typeExternalId)).data;
                protocolId = externalId.managedObject.id;
            }
            if (!protocolId && lpwanDevice.type) {
                protocolId = lpwanDevice.type.split('/')[2];
            }
            if (!protocolId) {
                return null;
            }
            return (yield this.inventoryService.detail(protocolId)).data;
        });
    }
    applyProtocol(device, selectedProtocol) {
        return __awaiter(this, void 0, void 0, function* () {
            const [protocolExternalId] = (yield this.identityService.list(selectedProtocol.id)).data;
            const { externalId, type } = protocolExternalId;
            device.c8y_LpwanDevice.typeExternalId = { externalId, type };
            device.c8y_LpwanDevice.type = 'inventory/managedObjects/' + selectedProtocol.id;
            device.type = selectedProtocol.name;
            return this.inventoryService.update(device);
        });
    }
    getAvailableProtocols(device) {
        return __awaiter(this, void 0, void 0, function* () {
            const query = {
                __filter: {
                    type: { __in: this.getProtocolTypesMatchingDevice(device) }
                },
                __orderby: [{ name: 1 }]
            };
            return this.inventoryService.listQuery(query, { withTotalPages: true, pageSize: 5 });
        });
    }
    getProtocolTypesMatchingDevice(device) {
        const matchingCfg = this.supportedDevicesCfgs.find(({ match }) => match(device));
        return matchingCfg ? matchingCfg.protocolTypes : [];
    }
    getExternalId(device) {
        return __awaiter(this, void 0, void 0, function* () {
            const matchingCfg = this.supportedDevicesCfgs.find(({ match }) => match(device));
            const externalIds = (yield this.identityService.list(device.id)).data;
            const externalId = externalIds.find(({ type }) => matchingCfg.externalIdTypes.includes(type));
            return externalId ? externalId.externalId : null;
        });
    }
}
LpwanSetDeviceProtocolService.decorators = [
    { type: Injectable }
];
LpwanSetDeviceProtocolService.ctorParameters = () => [
    { type: InventoryService },
    { type: FetchClient },
    { type: IdentityService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibHB3YW4tc2V0LWRldmljZS1wcm90b2NvbC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vcHJvdG9jb2wtbHB3YW4vbHB3YW4tc2V0LWRldmljZS1wcm90b2NvbC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFFTCxnQkFBZ0IsRUFFaEIsV0FBVyxFQUVYLGVBQWUsRUFDaEIsTUFBTSxhQUFhLENBQUM7QUFDckIsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUdoQyxNQUFNLE9BQU8sNkJBQTZCO0lBa0J4QyxZQUNVLGdCQUFrQyxFQUNsQyxNQUFtQixFQUNuQixlQUFnQztRQUZoQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLFdBQU0sR0FBTixNQUFNLENBQWE7UUFDbkIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBcEIxQyx5QkFBb0IsR0FBRztZQUNyQjtnQkFDRSxJQUFJLEVBQUUsTUFBTTtnQkFDWixLQUFLLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLGlDQUFpQyxDQUFDLEtBQUssTUFBTTtnQkFDMUUsYUFBYSxFQUFFLENBQUMsd0JBQXdCLEVBQUUsb0JBQW9CLEVBQUUscUJBQXFCLENBQUM7Z0JBQ3RGLGVBQWUsRUFBRSxDQUFDLGVBQWUsRUFBRSxZQUFZLENBQUM7YUFDakQ7WUFDRDtnQkFDRSxJQUFJLEVBQUUsUUFBUTtnQkFDZCxLQUFLLEVBQUUsTUFBTSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLGlDQUFpQyxDQUFDLEtBQUssUUFBUTtnQkFDNUUsYUFBYSxFQUFFLENBQUMsc0JBQXNCLEVBQUUscUJBQXFCLENBQUM7Z0JBQzlELGVBQWUsRUFBRSxDQUFDLHFCQUFxQixDQUFDO2FBQ3pDO1NBQ0YsQ0FB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QUFXLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQzlGLE9BQU8sVUFBVSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDbkQsQ0FBQztLQUFBOzs7WUF0R0YsVUFBVTs7O1lBUlQsZ0JBQWdCO1lBRWhCLFdBQVc7WUFFWCxlQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgSU1hbmFnZWRPYmplY3QsXG4gIEludmVudG9yeVNlcnZpY2UsXG4gIElSZXN1bHRMaXN0LFxuICBGZXRjaENsaWVudCxcbiAgSUZldGNoT3B0aW9ucyxcbiAgSWRlbnRpdHlTZXJ2aWNlXG59IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IGdldCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBMcHdhblNldERldmljZVByb3RvY29sU2VydmljZSB7XG4gIHN1cHBvcnRlZERldmljZXNDZmdzID0gW1xuICAgIHtcbiAgICAgIG5hbWU6ICdsb3JhJyxcbiAgICAgIG1hdGNoOiBkZXZpY2UgPT4gZ2V0KGRldmljZSwgJ2M4eV9McHdhbkRldmljZS5scHdhbkRldmljZVR5cGUnKSA9PT0gJ0xvcmEnLFxuICAgICAgcHJvdG9jb2xUeXBlczogWydjOHlfQWN0aWxpdHlEZXZpY2VUeXBlJywgJ2M4eV9Mb3JhRGV2aWNlVHlwZScsICdjOHlfTHB3YW5EZXZpY2VUeXBlJ10sXG4gICAgICBleHRlcm5hbElkVHlwZXM6IFsnYzh5X0xvcmlvdEVVSScsICdjOHlfU2VyaWFsJ11cbiAgICB9LFxuICAgIHtcbiAgICAgIG5hbWU6ICdzaWdmb3gnLFxuICAgICAgbWF0Y2g6IGRldmljZSA9PiBnZXQoZGV2aWNlLCAnYzh5X0xwd2FuRGV2aWNlLnNlcnZpY2VQcm92aWRlcicpID09PSAnU2lnZm94JyxcbiAgICAgIHByb3RvY29sVHlwZXM6IFsnYzh5X1NpZ2ZveERldmljZVR5cGUnLCAnYzh5X0xwd2FuRGV2aWNlVHlwZSddLFxuICAgICAgZXh0ZXJuYWxJZFR5cGVzOiBbJ2NvbS5zaWdmb3guZGV2aWNlSWQnXVxuICAgIH1cbiAgXTtcblxuICBwcml2YXRlIHJlYWRvbmx5IGhlYWRlcjogYW55ID0geyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH07XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgY2xpZW50OiBGZXRjaENsaWVudCxcbiAgICBwcml2YXRlIGlkZW50aXR5U2VydmljZTogSWRlbnRpdHlTZXJ2aWNlXG4gICkge31cblxuICBhc3luYyByZWZyZXNoQ2FjaGUoZGV2aWNlKSB7XG4gICAgY29uc3QgZXh0ZXJuYWxJZCA9IGF3YWl0IHRoaXMuZ2V0RXh0ZXJuYWxJZChkZXZpY2UpO1xuICAgIGlmIChleHRlcm5hbElkKSB7XG4gICAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmdldE1pY3Jvc2VydmljZVVybChkZXZpY2UpfS9yZWZyZXNoQ2FjaGUvJHtleHRlcm5hbElkfWA7XG4gICAgICBjb25zdCBvcHRpb25zOiBJRmV0Y2hPcHRpb25zID0ge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczogdGhpcy5oZWFkZXIsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHt9KVxuICAgICAgfTtcbiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5mZXRjaCh1cmwsIG9wdGlvbnMpO1xuICAgIH1cbiAgfVxuXG4gIGdldE1pY3Jvc2VydmljZVVybChkZXZpY2UpIHtcbiAgICBjb25zdCB7IHNlcnZpY2VQcm92aWRlciB9ID0gZGV2aWNlLmM4eV9McHdhbkRldmljZTtcblxuICAgIGxldCBzZXJ2aWNlTmFtZSA9IHNlcnZpY2VQcm92aWRlci50b0xvd2VyQ2FzZSgpO1xuICAgIGlmIChzZXJ2aWNlUHJvdmlkZXIgPT09ICdTaWdmb3gnKSB7XG4gICAgICBzZXJ2aWNlTmFtZSA9ICdzaWdmb3gtYWdlbnQnO1xuICAgIH1cblxuICAgIHJldHVybiBgL3NlcnZpY2UvJHtzZXJ2aWNlTmFtZX1gO1xuICB9XG5cbiAgaXNTdXBwb3J0ZWREZXZpY2UoZGV2aWNlOiBJTWFuYWdlZE9iamVjdCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnN1cHBvcnRlZERldmljZXNDZmdzLnNvbWUoKHsgbWF0Y2ggfSkgPT4gbWF0Y2goZGV2aWNlKSk7XG4gIH1cblxuICBhc3luYyBnZXRDdXJyZW50UHJvdG9jb2woZGV2aWNlOiBJTWFuYWdlZE9iamVjdCkge1xuICAgIGNvbnN0IGxwd2FuRGV2aWNlID0gZGV2aWNlLmM4eV9McHdhbkRldmljZTtcbiAgICBsZXQgcHJvdG9jb2xJZDtcblxuICAgIGlmIChscHdhbkRldmljZS50eXBlRXh0ZXJuYWxJZCkge1xuICAgICAgY29uc3QgZXh0ZXJuYWxJZCA9IChhd2FpdCB0aGlzLmlkZW50aXR5U2VydmljZS5kZXRhaWwobHB3YW5EZXZpY2UudHlwZUV4dGVybmFsSWQpKS5kYXRhO1xuICAgICAgcHJvdG9jb2xJZCA9IGV4dGVybmFsSWQubWFuYWdlZE9iamVjdC5pZDtcbiAgICB9XG5cbiAgICBpZiAoIXByb3RvY29sSWQgJiYgbHB3YW5EZXZpY2UudHlwZSkge1xuICAgICAgcHJvdG9jb2xJZCA9IGxwd2FuRGV2aWNlLnR5cGUuc3BsaXQoJy8nKVsyXTtcbiAgICB9XG5cbiAgICBpZiAoIXByb3RvY29sSWQpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiAoYXdhaXQgdGhpcy5pbnZlbnRvcnlTZXJ2aWNlLmRldGFpbChwcm90b2NvbElkKSkuZGF0YTtcbiAgfVxuXG4gIGFzeW5jIGFwcGx5UHJvdG9jb2woZGV2aWNlOiBJTWFuYWdlZE9iamVjdCwgc2VsZWN0ZWRQcm90b2NvbDogSU1hbmFnZWRPYmplY3QpIHtcbiAgICBjb25zdCBbcHJvdG9jb2xFeHRlcm5hbElkXSA9IChhd2FpdCB0aGlzLmlkZW50aXR5U2VydmljZS5saXN0KHNlbGVjdGVkUHJvdG9jb2wuaWQpKS5kYXRhO1xuICAgIGNvbnN0IHsgZXh0ZXJuYWxJZCwgdHlwZSB9ID0gcHJvdG9jb2xFeHRlcm5hbElkO1xuICAgIGRldmljZS5jOHlfTHB3YW5EZXZpY2UudHlwZUV4dGVybmFsSWQgPSB7IGV4dGVybmFsSWQsIHR5cGUgfTtcbiAgICBkZXZpY2UuYzh5X0xwd2FuRGV2aWNlLnR5cGUgPSAnaW52ZW50b3J5L21hbmFnZWRPYmplY3RzLycgKyBzZWxlY3RlZFByb3RvY29sLmlkO1xuICAgIGRldmljZS50eXBlID0gc2VsZWN0ZWRQcm90b2NvbC5uYW1lO1xuICAgIHJldHVybiB0aGlzLmludmVudG9yeVNlcnZpY2UudXBkYXRlKGRldmljZSk7XG4gIH1cblxuICBhc3luYyBnZXRBdmFpbGFibGVQcm90b2NvbHMoZGV2aWNlOiBJTWFuYWdlZE9iamVjdCk6IFByb21pc2U8SVJlc3VsdExpc3Q8SU1hbmFnZWRPYmplY3Q+PiB7XG4gICAgY29uc3QgcXVlcnkgPSB7XG4gICAgICBfX2ZpbHRlcjoge1xuICAgICAgICB0eXBlOiB7IF9faW46IHRoaXMuZ2V0UHJvdG9jb2xUeXBlc01hdGNoaW5nRGV2aWNlKGRldmljZSkgfVxuICAgICAgfSxcbiAgICAgIF9fb3JkZXJieTogW3sgbmFtZTogMSB9XVxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuaW52ZW50b3J5U2VydmljZS5saXN0UXVlcnkocXVlcnksIHsgd2l0aFRvdGFsUGFnZXM6IHRydWUsIHBhZ2VTaXplOiA1IH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQcm90b2NvbFR5cGVzTWF0Y2hpbmdEZXZpY2UoZGV2aWNlOiBJTWFuYWdlZE9iamVjdCk6IHN0cmluZ1tdIHtcbiAgICBjb25zdCBtYXRjaGluZ0NmZyA9IHRoaXMuc3VwcG9ydGVkRGV2aWNlc0NmZ3MuZmluZCgoeyBtYXRjaCB9KSA9PiBtYXRjaChkZXZpY2UpKTtcbiAgICByZXR1cm4gbWF0Y2hpbmdDZmcgPyBtYXRjaGluZ0NmZy5wcm90b2NvbFR5cGVzIDogW107XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldEV4dGVybmFsSWQoZGV2aWNlOiBJTWFuYWdlZE9iamVjdCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgbWF0Y2hpbmdDZmcgPSB0aGlzLnN1cHBvcnRlZERldmljZXNDZmdzLmZpbmQoKHsgbWF0Y2ggfSkgPT4gbWF0Y2goZGV2aWNlKSk7XG4gICAgY29uc3QgZXh0ZXJuYWxJZHMgPSAoYXdhaXQgdGhpcy5pZGVudGl0eVNlcnZpY2UubGlzdChkZXZpY2UuaWQpKS5kYXRhO1xuICAgIGNvbnN0IGV4dGVybmFsSWQgPSBleHRlcm5hbElkcy5maW5kKCh7IHR5cGUgfSkgPT4gbWF0Y2hpbmdDZmcuZXh0ZXJuYWxJZFR5cGVzLmluY2x1ZGVzKHR5cGUpKTtcbiAgICByZXR1cm4gZXh0ZXJuYWxJZCA/IGV4dGVybmFsSWQuZXh0ZXJuYWxJZCA6IG51bGw7XG4gIH1cbn1cbiJdfQ==