import { __awaiter } from "tslib";
import { Component } from '@angular/core';
import { ActivatedRoute } from '@angular/router';
import { InventoryService, OperationStatus } from '@c8y/client';
import { AlertService, gettext } from '@c8y/ngx-components';
import { DeviceConfigurationOperation } from '../repository.model';
import { RepositoryService } from '../repository.service';
import { DeviceConfigurationService } from './device-configuration.service';
export class TextBasedConfigurationComponent {
    constructor(route, alertService, repositoryService, deviceConfigurationService, inventoryService) {
        this.route = route;
        this.alertService = alertService;
        this.repositoryService = repositoryService;
        this.deviceConfigurationService = deviceConfigurationService;
        this.inventoryService = inventoryService;
        this.reloadingConfig = false;
    }
    ngOnInit() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.load();
        });
    }
    load() {
        return __awaiter(this, void 0, void 0, function* () {
            this.device = this.route.snapshot.parent.data.contextData;
            yield this.loadDevice();
            yield this.loadOperation();
            this.showTextBasedConfigReload = this.deviceConfigurationService.hasAnySupportedOperation(this.device, [DeviceConfigurationOperation.SEND_CONFIG]);
            this.showTextBasedConfigSave = this.deviceConfigurationService.hasAnySupportedOperation(this.device, [DeviceConfigurationOperation.CONFIG]);
            if (this.device.c8y_Configuration && this.device.c8y_Configuration.config) {
                this.config = this.device.c8y_Configuration.config;
            }
        });
    }
    loadOperation() {
        return __awaiter(this, void 0, void 0, function* () {
            const operation = yield this.repositoryService.getLastConfigUpdateOperation(this.device.id);
            if (operation !== null) {
                this.reloadingConfig =
                    !!operation.c8y_SendConfiguration &&
                        (operation.status === OperationStatus.PENDING ||
                            operation.status === OperationStatus.EXECUTING);
                this.repositoryService.observeOperation(operation).subscribe((operationUpdate) => {
                    this.latestOperation = operationUpdate;
                });
            }
        });
    }
    get savingConfig() {
        return this.latestOperation
            ? !!this.latestOperation.c8y_Configuration &&
                (this.latestOperation.status === OperationStatus.PENDING ||
                    this.latestOperation.status === OperationStatus.EXECUTING)
            : false;
    }
    reloadConfiguration() {
        return __awaiter(this, void 0, void 0, function* () {
            this.reloadingConfig = true;
            const operationCfg = yield this.repositoryService.createTextBasedConfigurationReloadOperation(this.device);
            try {
                this.repositoryService
                    .createObservedOperation(operationCfg)
                    .subscribe(operationUpdate => this.onOperationReloadSuccess(operationUpdate), operationUpdate => this.onOperationReloadError(operationUpdate), () => this.onOperationReloadComplete());
            }
            catch (ex) {
                this.alertService.addServerFailure(ex);
            }
        });
    }
    updateConfiguration(config) {
        return __awaiter(this, void 0, void 0, function* () {
            const operationCfg = yield this.repositoryService.createTextBasedConfigurationUpdateOperation(this.device, config);
            try {
                this.repositoryService
                    .createObservedOperation(operationCfg)
                    .subscribe(operationUpdate => this.onOperationUpdateSuccess(operationUpdate), operationUpdate => this.onOperationUpdateError(operationUpdate), () => this.onOperationUpdateComplete());
            }
            catch (ex) {
                this.alertService.addServerFailure(ex);
            }
        });
    }
    onOperationReloadSuccess(operationUpdate) {
        this.latestOperation = operationUpdate;
        if (operationUpdate.status === OperationStatus.PENDING) {
            this.alertService.success(gettext('Configuration will be reloaded.'));
        }
    }
    onOperationReloadError(operationUpdate) {
        this.latestOperation = operationUpdate;
        this.reloadingConfig = false;
    }
    onOperationReloadComplete() {
        return __awaiter(this, void 0, void 0, function* () {
            yield this.loadDevice();
            this.config = this.device.c8y_Configuration.config;
            this.reloadingConfig = false;
        });
    }
    onOperationUpdateSuccess(operationUpdate) {
        this.latestOperation = operationUpdate;
        if (operationUpdate.status === OperationStatus.PENDING) {
            this.alertService.success(gettext('Configuration will be updated.'));
        }
    }
    onOperationUpdateError(operationUpdate) {
        this.latestOperation = operationUpdate;
    }
    onOperationUpdateComplete() {
        this.device.c8y_Configuration.config = this.config;
    }
    loadDevice() {
        return __awaiter(this, void 0, void 0, function* () {
            this.device = (yield this.inventoryService.detail(this.device.id, {
                withChildren: false
            })).data;
        });
    }
}
TextBasedConfigurationComponent.decorators = [
    { type: Component, args: [{
                selector: 'c8y-text-based-configuration',
                template: "<div class=\"d-flex d-col fit-h\">\n  <fieldset class=\"card-block bg-gray-white fit-w\">\n    <div class=\"content-flex-50\">\n      <div class=\"flex-item-left d-flex\">\n        <button\n          title=\"{{ 'Get configuration from device' | translate }}\"\n          type=\"button\"\n          class=\"btn btn-default btn-sm flex-item-v-center m-t-8 m-b-8\"\n          *ngIf=\"showTextBasedConfigReload\"\n          (click)=\"reloadConfiguration()\"\n          [disabled]=\"reloadingConfig || savingConfig\"\n        >\n          <i\n            c8yIcon=\"refresh\"\n            *ngIf=\"reloadingConfig\"\n            class=\"m-r-4\"\n            [ngClass]=\"{ 'icon-spin': reloadingConfig }\"\n          ></i>\n          <i c8yIcon=\"download\" *ngIf=\"!reloadingConfig\" class=\"m-r-4\"></i>\n\n          {{ 'Get configuration from device' | translate }}\n        </button>\n      </div>\n      <c8y-single-operation\n        *ngIf=\"latestOperation !== undefined\"\n        [operation]=\"latestOperation\"\n        class=\"flex-grow\"\n      ></c8y-single-operation>\n    </div>\n  </fieldset>\n  <div class=\"flex-grow\">\n    <textarea\n      [(ngModel)]=\"config\"\n      class=\"form-control fit-h p-r-16 p-l-16\"\n      [disabled]=\"reloadingConfig || savingConfig\"\n      c8y-spellcheck=\"false\"\n    ></textarea>\n  </div>\n  <div class=\"card-footer fit-w separator\" *ngIf=\"showTextBasedConfigSave\">\n    <button\n      type=\"button\"\n      id=\"send-config-btn\"\n      (click)=\"updateConfiguration(config)\"\n      [disabled]=\"reloadingConfig || savingConfig || !config\"\n      class=\"btn btn-primary\"\n      [ngClass]=\"{ 'btn-pending': savingConfig }\"\n    >\n      <span title=\"{{ 'Send' | translate }}\" *ngIf=\"!savingConfig\">\n        {{ 'Send configuration to device' | translate }}\n      </span>\n      <span title=\"{{ 'Sending\u2026' | translate }}\" *ngIf=\"savingConfig\">\n        {{ 'Sending\u2026' | translate }}\n      </span>\n    </button>\n  </div>\n</div>\n"
            },] }
];
TextBasedConfigurationComponent.ctorParameters = () => [
    { type: ActivatedRoute },
    { type: AlertService },
    { type: RepositoryService },
    { type: DeviceConfigurationService },
    { type: InventoryService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dC1iYXNlZC1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3JlcG9zaXRvcnkvY29uZmlndXJhdGlvbi1kZXZpY2UtdGFiL3RleHQtYmFzZWQtY29uZmlndXJhdGlvbi5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDbEQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ2pELE9BQU8sRUFBa0IsZ0JBQWdCLEVBQWMsZUFBZSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQzVGLE9BQU8sRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDNUQsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbkUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDMUQsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFNNUUsTUFBTSxPQUFPLCtCQUErQjtJQVExQyxZQUNVLEtBQXFCLEVBQ3JCLFlBQTBCLEVBQzFCLGlCQUFvQyxFQUNwQywwQkFBc0QsRUFDdEQsZ0JBQWtDO1FBSmxDLFVBQUssR0FBTCxLQUFLLENBQWdCO1FBQ3JCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7UUFDcEMsK0JBQTBCLEdBQTFCLDBCQUEwQixDQUE0QjtRQUN0RCxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBUjVDLG9CQUFlLEdBQUcsS0FBSyxDQUFDO0lBVXhCLENBQUM7SUFFSyxRQUFROztZQUNaLE1BQU0sSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3BCLENBQUM7S0FBQTtJQUVLLElBQUk7O1lBQ1IsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQztZQUMxRCxNQUFNLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUN4QixNQUFNLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUMzQixJQUFJLENBQUMseUJBQXlCLEdBQUcsSUFBSSxDQUFDLDBCQUEwQixDQUFDLHdCQUF3QixDQUN2RixJQUFJLENBQUMsTUFBTSxFQUNYLENBQUMsNEJBQTRCLENBQUMsV0FBVyxDQUFDLENBQzNDLENBQUM7WUFDRixJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDLDBCQUEwQixDQUFDLHdCQUF3QixDQUNyRixJQUFJLENBQUMsTUFBTSxFQUNYLENBQUMsNEJBQTRCLENBQUMsTUFBTSxDQUFDLENBQ3RDLENBQUM7WUFDRixJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEVBQUU7Z0JBQ3pFLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUM7YUFDcEQ7UUFDSCxDQUFDO0tBQUE7SUFFSyxhQUFhOztZQUNqQixNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzVGLElBQUksU0FBUyxLQUFLLElBQUksRUFBRTtnQkFDdEIsSUFBSSxDQUFDLGVBQWU7b0JBQ2xCLENBQUMsQ0FBQyxTQUFTLENBQUMscUJBQXFCO3dCQUNqQyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEtBQUssZUFBZSxDQUFDLE9BQU87NEJBQzNDLFNBQVMsQ0FBQyxNQUFNLEtBQUssZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUNwRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsZUFBZSxFQUFFLEVBQUU7b0JBQy9FLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO2dCQUN6QyxDQUFDLENBQUMsQ0FBQzthQUNKO1FBQ0gsQ0FBQztLQUFBO0lBRUQsSUFBSSxZQUFZO1FBQ2QsT0FBTyxJQUFJLENBQUMsZUFBZTtZQUN6QixDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsaUJBQWlCO2dCQUN0QyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxLQUFLLGVBQWUsQ0FBQyxPQUFPO29CQUN0RCxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sS0FBSyxlQUFlLENBQUMsU0FBUyxDQUFDO1lBQ2hFLENBQUMsQ0FBQyxLQUFLLENBQUM7SUFDWixDQUFDO0lBRUssbUJBQW1COztZQUN2QixJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQztZQUM1QixNQUFNLFlBQVksR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQywyQ0FBMkMsQ0FDM0YsSUFBSSxDQUFDLE1BQU0sQ0FDWixDQUFDO1lBQ0YsSUFBSTtnQkFDRixJQUFJLENBQUMsaUJBQWlCO3FCQUNuQix1QkFBdUIsQ0FBQyxZQUFZLENBQUM7cUJBQ3JDLFNBQVMsQ0FDUixlQUFlLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxlQUFlLENBQUMsRUFDakUsZUFBZSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsZUFBZSxDQUFDLEVBQy9ELEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyx5QkFBeUIsRUFBRSxDQUN2QyxDQUFDO2FBQ0w7WUFBQyxPQUFPLEVBQUUsRUFBRTtnQkFDWCxJQUFJLENBQUMsWUFBWSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQyxDQUFDO2FBQ3hDO1FBQ0gsQ0FBQztLQUFBO0lBRUssbUJBQW1CLENBQUMsTUFBTTs7WUFDOUIsTUFBTSxZQUFZLEdBQUcsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsMkNBQTJDLENBQzNGLElBQUksQ0FBQyxNQUFNLEVBQ1gsTUFBTSxDQUNQLENBQUM7WUFDRixJQUFJO2dCQUNGLElBQUksQ0FBQyxpQkFBaUI7cUJBQ25CLHVCQUF1QixDQUFDLFlBQVksQ0FBQztxQkFDckMsU0FBUyxDQUNSLGVBQWUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLGVBQWUsQ0FBQyxFQUNqRSxlQUFlLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxlQUFlLENBQUMsRUFDL0QsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLHlCQUF5QixFQUFFLENBQ3ZDLENBQUM7YUFDTDtZQUFDLE9BQU8sRUFBRSxFQUFFO2dCQUNYLElBQUksQ0FBQyxZQUFZLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDeEM7UUFDSCxDQUFDO0tBQUE7SUFFTyx3QkFBd0IsQ0FBQyxlQUFlO1FBQzlDLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO1FBQ3ZDLElBQUksZUFBZSxDQUFDLE1BQU0sS0FBSyxlQUFlLENBQUMsT0FBTyxFQUFFO1lBQ3RELElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDLENBQUM7U0FDdkU7SUFDSCxDQUFDO0lBRU8sc0JBQXNCLENBQUMsZUFBZTtRQUM1QyxJQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQztRQUN2QyxJQUFJLENBQUMsZUFBZSxHQUFHLEtBQUssQ0FBQztJQUMvQixDQUFDO0lBRWEseUJBQXlCOztZQUNyQyxNQUFNLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUN4QixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDO1lBQ25ELElBQUksQ0FBQyxlQUFlLEdBQUcsS0FBSyxDQUFDO1FBQy9CLENBQUM7S0FBQTtJQUVPLHdCQUF3QixDQUFDLGVBQWU7UUFDOUMsSUFBSSxDQUFDLGVBQWUsR0FBRyxlQUFlLENBQUM7UUFDdkMsSUFBSSxlQUFlLENBQUMsTUFBTSxLQUFLLGVBQWUsQ0FBQyxPQUFPLEVBQUU7WUFDdEQsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGdDQUFnQyxDQUFDLENBQUMsQ0FBQztTQUN0RTtJQUNILENBQUM7SUFFTyxzQkFBc0IsQ0FBQyxlQUFlO1FBQzVDLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO0lBQ3pDLENBQUM7SUFFTyx5QkFBeUI7UUFDL0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUNyRCxDQUFDO0lBRWEsVUFBVTs7WUFDdEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRTtnQkFDaEUsWUFBWSxFQUFFLEtBQUs7YUFDcEIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQ1gsQ0FBQztLQUFBOzs7WUF4SUYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSw4QkFBOEI7Z0JBQ3hDLHMrREFBd0Q7YUFDekQ7OztZQVZRLGNBQWM7WUFFZCxZQUFZO1lBRVosaUJBQWlCO1lBQ2pCLDBCQUEwQjtZQUpWLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdCwgSW52ZW50b3J5U2VydmljZSwgSU9wZXJhdGlvbiwgT3BlcmF0aW9uU3RhdHVzIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlLCBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBEZXZpY2VDb25maWd1cmF0aW9uT3BlcmF0aW9uIH0gZnJvbSAnLi4vcmVwb3NpdG9yeS5tb2RlbCc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5U2VydmljZSB9IGZyb20gJy4uL3JlcG9zaXRvcnkuc2VydmljZSc7XG5pbXBvcnQgeyBEZXZpY2VDb25maWd1cmF0aW9uU2VydmljZSB9IGZyb20gJy4vZGV2aWNlLWNvbmZpZ3VyYXRpb24uc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS10ZXh0LWJhc2VkLWNvbmZpZ3VyYXRpb24nLFxuICB0ZW1wbGF0ZVVybDogJy4vdGV4dC1iYXNlZC1jb25maWd1cmF0aW9uLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBUZXh0QmFzZWRDb25maWd1cmF0aW9uQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgZGV2aWNlOiBJTWFuYWdlZE9iamVjdDtcbiAgbGF0ZXN0T3BlcmF0aW9uOiBJT3BlcmF0aW9uO1xuICBzaG93VGV4dEJhc2VkQ29uZmlnUmVsb2FkOiBib29sZWFuO1xuICBzaG93VGV4dEJhc2VkQ29uZmlnU2F2ZTogYm9vbGVhbjtcbiAgcmVsb2FkaW5nQ29uZmlnID0gZmFsc2U7XG4gIGNvbmZpZzogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcm91dGU6IEFjdGl2YXRlZFJvdXRlLFxuICAgIHByaXZhdGUgYWxlcnRTZXJ2aWNlOiBBbGVydFNlcnZpY2UsXG4gICAgcHJpdmF0ZSByZXBvc2l0b3J5U2VydmljZTogUmVwb3NpdG9yeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBkZXZpY2VDb25maWd1cmF0aW9uU2VydmljZTogRGV2aWNlQ29uZmlndXJhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlTZXJ2aWNlOiBJbnZlbnRvcnlTZXJ2aWNlXG4gICkge1xuICB9XG5cbiAgYXN5bmMgbmdPbkluaXQoKSB7XG4gICAgYXdhaXQgdGhpcy5sb2FkKCk7XG4gIH1cblxuICBhc3luYyBsb2FkKCkge1xuICAgIHRoaXMuZGV2aWNlID0gdGhpcy5yb3V0ZS5zbmFwc2hvdC5wYXJlbnQuZGF0YS5jb250ZXh0RGF0YTtcbiAgICBhd2FpdCB0aGlzLmxvYWREZXZpY2UoKTtcbiAgICBhd2FpdCB0aGlzLmxvYWRPcGVyYXRpb24oKTtcbiAgICB0aGlzLnNob3dUZXh0QmFzZWRDb25maWdSZWxvYWQgPSB0aGlzLmRldmljZUNvbmZpZ3VyYXRpb25TZXJ2aWNlLmhhc0FueVN1cHBvcnRlZE9wZXJhdGlvbihcbiAgICAgIHRoaXMuZGV2aWNlLFxuICAgICAgW0RldmljZUNvbmZpZ3VyYXRpb25PcGVyYXRpb24uU0VORF9DT05GSUddXG4gICAgKTtcbiAgICB0aGlzLnNob3dUZXh0QmFzZWRDb25maWdTYXZlID0gdGhpcy5kZXZpY2VDb25maWd1cmF0aW9uU2VydmljZS5oYXNBbnlTdXBwb3J0ZWRPcGVyYXRpb24oXG4gICAgICB0aGlzLmRldmljZSxcbiAgICAgIFtEZXZpY2VDb25maWd1cmF0aW9uT3BlcmF0aW9uLkNPTkZJR11cbiAgICApO1xuICAgIGlmICh0aGlzLmRldmljZS5jOHlfQ29uZmlndXJhdGlvbiAmJiB0aGlzLmRldmljZS5jOHlfQ29uZmlndXJhdGlvbi5jb25maWcpIHtcbiAgICAgIHRoaXMuY29uZmlnID0gdGhpcy5kZXZpY2UuYzh5X0NvbmZpZ3VyYXRpb24uY29uZmlnO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGxvYWRPcGVyYXRpb24oKSB7XG4gICAgY29uc3Qgb3BlcmF0aW9uID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5nZXRMYXN0Q29uZmlnVXBkYXRlT3BlcmF0aW9uKHRoaXMuZGV2aWNlLmlkKTtcbiAgICBpZiAob3BlcmF0aW9uICE9PSBudWxsKSB7XG4gICAgICB0aGlzLnJlbG9hZGluZ0NvbmZpZyA9XG4gICAgICAgICEhb3BlcmF0aW9uLmM4eV9TZW5kQ29uZmlndXJhdGlvbiAmJlxuICAgICAgICAob3BlcmF0aW9uLnN0YXR1cyA9PT0gT3BlcmF0aW9uU3RhdHVzLlBFTkRJTkcgfHxcbiAgICAgICAgICBvcGVyYXRpb24uc3RhdHVzID09PSBPcGVyYXRpb25TdGF0dXMuRVhFQ1VUSU5HKTtcbiAgICAgIHRoaXMucmVwb3NpdG9yeVNlcnZpY2Uub2JzZXJ2ZU9wZXJhdGlvbihvcGVyYXRpb24pLnN1YnNjcmliZSgob3BlcmF0aW9uVXBkYXRlKSA9PiB7XG4gICAgICAgIHRoaXMubGF0ZXN0T3BlcmF0aW9uID0gb3BlcmF0aW9uVXBkYXRlO1xuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0IHNhdmluZ0NvbmZpZygpIHtcbiAgICByZXR1cm4gdGhpcy5sYXRlc3RPcGVyYXRpb25cbiAgICAgID8gISF0aGlzLmxhdGVzdE9wZXJhdGlvbi5jOHlfQ29uZmlndXJhdGlvbiAmJlxuICAgICAgICAgICh0aGlzLmxhdGVzdE9wZXJhdGlvbi5zdGF0dXMgPT09IE9wZXJhdGlvblN0YXR1cy5QRU5ESU5HIHx8XG4gICAgICAgICAgICB0aGlzLmxhdGVzdE9wZXJhdGlvbi5zdGF0dXMgPT09IE9wZXJhdGlvblN0YXR1cy5FWEVDVVRJTkcpXG4gICAgICA6IGZhbHNlO1xuICB9XG5cbiAgYXN5bmMgcmVsb2FkQ29uZmlndXJhdGlvbigpIHtcbiAgICB0aGlzLnJlbG9hZGluZ0NvbmZpZyA9IHRydWU7XG4gICAgY29uc3Qgb3BlcmF0aW9uQ2ZnID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5jcmVhdGVUZXh0QmFzZWRDb25maWd1cmF0aW9uUmVsb2FkT3BlcmF0aW9uKFxuICAgICAgdGhpcy5kZXZpY2VcbiAgICApO1xuICAgIHRyeSB7XG4gICAgICB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlXG4gICAgICAgIC5jcmVhdGVPYnNlcnZlZE9wZXJhdGlvbihvcGVyYXRpb25DZmcpXG4gICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgb3BlcmF0aW9uVXBkYXRlID0+IHRoaXMub25PcGVyYXRpb25SZWxvYWRTdWNjZXNzKG9wZXJhdGlvblVwZGF0ZSksXG4gICAgICAgICAgb3BlcmF0aW9uVXBkYXRlID0+IHRoaXMub25PcGVyYXRpb25SZWxvYWRFcnJvcihvcGVyYXRpb25VcGRhdGUpLFxuICAgICAgICAgICgpID0+IHRoaXMub25PcGVyYXRpb25SZWxvYWRDb21wbGV0ZSgpXG4gICAgICAgICk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoZXgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZUNvbmZpZ3VyYXRpb24oY29uZmlnKSB7XG4gICAgY29uc3Qgb3BlcmF0aW9uQ2ZnID0gYXdhaXQgdGhpcy5yZXBvc2l0b3J5U2VydmljZS5jcmVhdGVUZXh0QmFzZWRDb25maWd1cmF0aW9uVXBkYXRlT3BlcmF0aW9uKFxuICAgICAgdGhpcy5kZXZpY2UsXG4gICAgICBjb25maWdcbiAgICApO1xuICAgIHRyeSB7XG4gICAgICB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlXG4gICAgICAgIC5jcmVhdGVPYnNlcnZlZE9wZXJhdGlvbihvcGVyYXRpb25DZmcpXG4gICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgb3BlcmF0aW9uVXBkYXRlID0+IHRoaXMub25PcGVyYXRpb25VcGRhdGVTdWNjZXNzKG9wZXJhdGlvblVwZGF0ZSksXG4gICAgICAgICAgb3BlcmF0aW9uVXBkYXRlID0+IHRoaXMub25PcGVyYXRpb25VcGRhdGVFcnJvcihvcGVyYXRpb25VcGRhdGUpLFxuICAgICAgICAgICgpID0+IHRoaXMub25PcGVyYXRpb25VcGRhdGVDb21wbGV0ZSgpXG4gICAgICAgICk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmFkZFNlcnZlckZhaWx1cmUoZXgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25PcGVyYXRpb25SZWxvYWRTdWNjZXNzKG9wZXJhdGlvblVwZGF0ZSkge1xuICAgIHRoaXMubGF0ZXN0T3BlcmF0aW9uID0gb3BlcmF0aW9uVXBkYXRlO1xuICAgIGlmIChvcGVyYXRpb25VcGRhdGUuc3RhdHVzID09PSBPcGVyYXRpb25TdGF0dXMuUEVORElORykge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2Uuc3VjY2VzcyhnZXR0ZXh0KCdDb25maWd1cmF0aW9uIHdpbGwgYmUgcmVsb2FkZWQuJykpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25PcGVyYXRpb25SZWxvYWRFcnJvcihvcGVyYXRpb25VcGRhdGUpIHtcbiAgICB0aGlzLmxhdGVzdE9wZXJhdGlvbiA9IG9wZXJhdGlvblVwZGF0ZTtcbiAgICB0aGlzLnJlbG9hZGluZ0NvbmZpZyA9IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBvbk9wZXJhdGlvblJlbG9hZENvbXBsZXRlKCkge1xuICAgIGF3YWl0IHRoaXMubG9hZERldmljZSgpO1xuICAgIHRoaXMuY29uZmlnID0gdGhpcy5kZXZpY2UuYzh5X0NvbmZpZ3VyYXRpb24uY29uZmlnO1xuICAgIHRoaXMucmVsb2FkaW5nQ29uZmlnID0gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIG9uT3BlcmF0aW9uVXBkYXRlU3VjY2VzcyhvcGVyYXRpb25VcGRhdGUpIHtcbiAgICB0aGlzLmxhdGVzdE9wZXJhdGlvbiA9IG9wZXJhdGlvblVwZGF0ZTtcbiAgICBpZiAob3BlcmF0aW9uVXBkYXRlLnN0YXR1cyA9PT0gT3BlcmF0aW9uU3RhdHVzLlBFTkRJTkcpIHtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3MoZ2V0dGV4dCgnQ29uZmlndXJhdGlvbiB3aWxsIGJlIHVwZGF0ZWQuJykpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb25PcGVyYXRpb25VcGRhdGVFcnJvcihvcGVyYXRpb25VcGRhdGUpIHtcbiAgICB0aGlzLmxhdGVzdE9wZXJhdGlvbiA9IG9wZXJhdGlvblVwZGF0ZTtcbiAgfVxuXG4gIHByaXZhdGUgb25PcGVyYXRpb25VcGRhdGVDb21wbGV0ZSgpIHtcbiAgICB0aGlzLmRldmljZS5jOHlfQ29uZmlndXJhdGlvbi5jb25maWcgPSB0aGlzLmNvbmZpZztcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbG9hZERldmljZSgpIHtcbiAgICB0aGlzLmRldmljZSA9IChhd2FpdCB0aGlzLmludmVudG9yeVNlcnZpY2UuZGV0YWlsKHRoaXMuZGV2aWNlLmlkLCB7XG4gICAgICB3aXRoQ2hpbGRyZW46IGZhbHNlXG4gICAgfSkpLmRhdGE7XG4gIH1cbn1cbiJdfQ==