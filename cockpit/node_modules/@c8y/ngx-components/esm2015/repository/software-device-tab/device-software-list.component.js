import { Component, EventEmitter, Input, Output } from '@angular/core';
import { filter, get, set } from 'lodash-es';
import { BehaviorSubject, combineLatest, of } from 'rxjs';
import { debounceTime, distinctUntilChanged, map, switchMap, tap } from 'rxjs/operators';
import { AdvancedSoftwareService } from './advanced-software.service';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from './advanced-software.service';
import * as ɵngcc2 from '@c8y/ngx-components';
import * as ɵngcc3 from '@angular/common';

function DeviceSoftwareListComponent_c8y_li_1_div_14_button_1_Template(rf, ctx) { if (rf & 1) {
    const _r8 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "button", 15);
    ɵngcc0.ɵɵlistener("click", function DeviceSoftwareListComponent_c8y_li_1_div_14_button_1_Template_button_click_0_listener() { ɵngcc0.ɵɵrestoreView(_r8); const software_r2 = ɵngcc0.ɵɵnextContext(2).$implicit; const ctx_r6 = ɵngcc0.ɵɵnextContext(); return ctx_r6.update.emit(software_r2); });
    ɵngcc0.ɵɵpipe(1, "translate");
    ɵngcc0.ɵɵtext(2, " Update ");
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(1, 1, "Update`software,verb`"));
} }
function DeviceSoftwareListComponent_c8y_li_1_div_14_button_2_Template(rf, ctx) { if (rf & 1) {
    const _r11 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "button", 16);
    ɵngcc0.ɵɵlistener("click", function DeviceSoftwareListComponent_c8y_li_1_div_14_button_2_Template_button_click_0_listener() { ɵngcc0.ɵɵrestoreView(_r11); const software_r2 = ɵngcc0.ɵɵnextContext(2).$implicit; const ctx_r9 = ɵngcc0.ɵɵnextContext(); return ctx_r9.remove.emit(software_r2); });
    ɵngcc0.ɵɵpipe(1, "translate");
    ɵngcc0.ɵɵelement(2, "i", 17);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(1, 1, "Remove`software`"));
} }
function DeviceSoftwareListComponent_c8y_li_1_div_14_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 12);
    ɵngcc0.ɵɵtemplate(1, DeviceSoftwareListComponent_c8y_li_1_div_14_button_1_Template, 3, 3, "button", 13);
    ɵngcc0.ɵɵtemplate(2, DeviceSoftwareListComponent_c8y_li_1_div_14_button_2_Template, 3, 3, "button", 14);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const software_r2 = ɵngcc0.ɵɵnextContext().$implicit;
    const ctx_r3 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r3.showUpdate && !ctx_r3.isSoftwareGoingToBeChanged(software_r2));
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r3.showRemove && !ctx_r3.isSoftwareGoingToBeChanged(software_r2));
} }
const _c0 = function (a0) { return { disabled: a0 }; };
function DeviceSoftwareListComponent_c8y_li_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "c8y-li", 3);
    ɵngcc0.ɵɵelementStart(1, "c8y-li-icon");
    ɵngcc0.ɵɵelement(2, "i", 4);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(3, "c8y-li-body", 5);
    ɵngcc0.ɵɵelementStart(4, "div", 6);
    ɵngcc0.ɵɵelementStart(5, "p", 7);
    ɵngcc0.ɵɵtext(6);
    ɵngcc0.ɵɵelementStart(7, "span", 8);
    ɵngcc0.ɵɵtext(8);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(9, "p", 7);
    ɵngcc0.ɵɵelementStart(10, "span", 9);
    ɵngcc0.ɵɵtext(11, " Version ");
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementStart(12, "span", 10);
    ɵngcc0.ɵɵtext(13);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵtemplate(14, DeviceSoftwareListComponent_c8y_li_1_div_14_Template, 3, 2, "div", 11);
    ɵngcc0.ɵɵelementEnd();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const software_r2 = ctx.$implicit;
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction1(7, _c0, ctx_r0.isSoftwareGoingToBeChanged(software_r2)));
    ɵngcc0.ɵɵadvance(4);
    ɵngcc0.ɵɵpropertyInterpolate("title", software_r2.name);
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate1(" ", software_r2.name, " ");
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵtextInterpolate(software_r2.softwareType);
    ɵngcc0.ɵɵadvance(4);
    ɵngcc0.ɵɵpropertyInterpolate("title", software_r2.version);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵtextInterpolate1(" ", software_r2.version, " ");
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r0.supportsSoftwareOperations && (ctx_r0.showUpdate || ctx_r0.showRemove));
} }
function DeviceSoftwareListComponent_div_2_ng_content_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵprojection(0, 0, ["*ngIf", "emptyList"]);
} }
function DeviceSoftwareListComponent_div_2_ng_content_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵprojection(0, 1, ["*ngIf", "noSearchResults"]);
} }
function DeviceSoftwareListComponent_div_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 18);
    ɵngcc0.ɵɵtemplate(1, DeviceSoftwareListComponent_div_2_ng_content_1_Template, 1, 0, "ng-content", 19);
    ɵngcc0.ɵɵtemplate(2, DeviceSoftwareListComponent_div_2_ng_content_2_Template, 1, 0, "ng-content", 19);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r1 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r1.emptyList);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r1.noSearchResults);
} }
const _c1 = [[["", 8, "c8y-empty-state", 9, "c8y-no-results-state"]], [["", 8, "c8y-no-results-state"]]];
const _c2 = [".c8y-empty-state:not(.c8y-no-results-state)", ".c8y-no-results-state"];
export class DeviceSoftwareListComponent {
    constructor(advancedSoftwareService) {
        this.advancedSoftwareService = advancedSoftwareService;
        this.filterCriteria$ = of(null);
        this.update = new EventEmitter();
        this.remove = new EventEmitter();
        this.onListEmpty = new EventEmitter();
        this.supportsSoftwareOperations = false;
        this.operationTypes = ['c8y_SoftwareUpdate', 'c8y_SoftwareList', 'c8y_Software'];
        this.legacySoftwareList$ = new BehaviorSubject([]);
    }
    set softwareList(softwareList) {
        if (softwareList !== null) {
            this.legacySoftwareList$.next(softwareList);
        }
    }
    ngOnInit() {
        this.softwareItems$ = combineLatest(this.filterCriteria$, this.legacySoftwareList$).pipe(debounceTime(300), distinctUntilChanged(), switchMap(([filterCriteria, legacySoftwareList]) => {
            if (legacySoftwareList) {
                return of(this.getLegacySoftwareList(filterCriteria)).pipe(map(resultList => ({ resultList, filterCriteria })));
            }
            else {
                return this.getAdvancedSoftwareList(filterCriteria).then(resultList => ({
                    resultList,
                    filterCriteria
                }));
            }
        }), tap(({ resultList, filterCriteria }) => {
            var _a, _b;
            this.notifyListEmpty(!((_a = resultList === null || resultList === void 0 ? void 0 : resultList.paging) === null || _a === void 0 ? void 0 : _a.totalPages) && !filterCriteria);
            this.noSearchResults = !((_b = resultList === null || resultList === void 0 ? void 0 : resultList.paging) === null || _b === void 0 ? void 0 : _b.totalPages) && !!filterCriteria;
        }), map(({ resultList }) => resultList));
        const supportedOperations = get(this.device, 'c8y_SupportedOperations', []);
        this.supportsSoftwareOperations = this.operationTypes.some(operationType => supportedOperations.indexOf(operationType) > -1);
    }
    ngAfterContentInit() {
        this.showUpdate = this.update.observers.length > 0;
        this.showRemove = this.remove.observers.length > 0;
    }
    isSoftwareGoingToBeChanged(software) {
        const relevantChanges = filter(this.deviceSoftwareChanges, software);
        return relevantChanges.length > 0;
    }
    getAdvancedSoftwareList(filterCriteria) {
        const queryFilter = { deviceId: this.device.id };
        if (filterCriteria === null || filterCriteria === void 0 ? void 0 : filterCriteria.name) {
            set(queryFilter, 'name', `*${filterCriteria.name}*`);
        }
        if (filterCriteria === null || filterCriteria === void 0 ? void 0 : filterCriteria.softwareType) {
            set(queryFilter, 'type', `${filterCriteria.softwareType}`);
        }
        return this.advancedSoftwareService.list(queryFilter);
    }
    getLegacySoftwareList(filterCriteria) {
        const data = filterCriteria
            ? this.legacySoftwareList$.value.filter(item => {
                var _a;
                let match = true;
                if (filterCriteria === null || filterCriteria === void 0 ? void 0 : filterCriteria.name) {
                    match = match && ((_a = item.name) === null || _a === void 0 ? void 0 : _a.includes(filterCriteria.name));
                }
                if (filterCriteria === null || filterCriteria === void 0 ? void 0 : filterCriteria.softwareType) {
                    match = match && item.softwareType === filterCriteria.softwareType;
                }
                return match;
            })
            : this.legacySoftwareList$.value;
        return {
            data,
            res: null,
            paging: {
                totalPages: data.length
            }
        };
    }
    notifyListEmpty(isEmpty) {
        this.emptyList = isEmpty;
        this.onListEmpty.emit(isEmpty);
    }
}
DeviceSoftwareListComponent.ɵfac = function DeviceSoftwareListComponent_Factory(t) { return new (t || DeviceSoftwareListComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.AdvancedSoftwareService)); };
DeviceSoftwareListComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: DeviceSoftwareListComponent, selectors: [["c8y-device-software-list"]], inputs: { filterCriteria$: "filterCriteria$", softwareList: "softwareList", device: "device", deviceSoftwareChanges: "deviceSoftwareChanges" }, outputs: { update: "update", remove: "remove", onListEmpty: "onListEmpty" }, ngContentSelectors: _c2, decls: 3, vars: 2, consts: [[1, "no-border-last"], [3, "ngClass", 4, "c8yFor", "c8yForOf"], ["class", "card-block", 4, "ngIf"], [3, "ngClass"], ["c8yIcon", "c8y-tools"], [1, "content-flex-20"], [1, "col-8", 3, "title"], [1, "text-truncate"], [1, "label", "label-primary", "m-l-8"], ["translate", "", 1, "text-label-small", "m-r-4"], [3, "title"], ["class", "col-4 text-right", 4, "ngIf"], [1, "col-4", "text-right"], ["class", "btn btn-default btn-xs showOnHover", "translate", "", 3, "title", "click", 4, "ngIf"], ["class", "showOnHover btn btn-dot pull-right", 3, "title", "click", 4, "ngIf"], ["translate", "", 1, "btn", "btn-default", "btn-xs", "showOnHover", 3, "title", "click"], [1, "showOnHover", "btn", "btn-dot", "pull-right", 3, "title", "click"], ["c8yIcon", "minus-circle", 1, "text-danger"], [1, "card-block"], [4, "ngIf"]], template: function DeviceSoftwareListComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵprojectionDef(_c1);
        ɵngcc0.ɵɵelementStart(0, "c8y-list-group", 0);
        ɵngcc0.ɵɵtemplate(1, DeviceSoftwareListComponent_c8y_li_1_Template, 15, 9, "c8y-li", 1);
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵtemplate(2, DeviceSoftwareListComponent_div_2_Template, 3, 2, "div", 2);
    } if (rf & 2) {
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("c8yForOf", ctx.softwareItems$);
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.noSearchResults || ctx.emptyList);
    } }, directives: [ɵngcc2.ListGroupComponent, ɵngcc2.ForOfDirective, ɵngcc3.NgIf, ɵngcc2.ListItemComponent, ɵngcc3.NgClass, ɵngcc2.ListItemIconComponent, ɵngcc2.IconDirective, ɵngcc2.ListItemBodyComponent, ɵngcc2.C8yTranslateDirective], pipes: [ɵngcc2.C8yTranslatePipe], encapsulation: 2 });
DeviceSoftwareListComponent.ctorParameters = () => [
    { type: AdvancedSoftwareService }
];
DeviceSoftwareListComponent.propDecorators = {
    softwareList: [{ type: Input }],
    device: [{ type: Input }],
    deviceSoftwareChanges: [{ type: Input }],
    filterCriteria$: [{ type: Input }],
    update: [{ type: Output }],
    remove: [{ type: Output }],
    onListEmpty: [{ type: Output }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(DeviceSoftwareListComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-device-software-list',
                template: "<c8y-list-group class=\"no-border-last\">\n  <c8y-li\n    [ngClass]=\"{ disabled: isSoftwareGoingToBeChanged(software) }\"\n    *c8yFor=\"let software of softwareItems$\"\n  >\n    <!-- SOFTWARE ICON -->\n    <c8y-li-icon>\n      <i c8yIcon=\"c8y-tools\"></i>\n    </c8y-li-icon>\n\n    <c8y-li-body class=\"content-flex-20\">\n      <div title=\"{{ software.name }}\" class=\"col-8\">\n        <!-- SOFTWARE NAME -->\n        <p class=\"text-truncate\">\n          {{ software.name }}\n          <!-- SOFTWARE TYPE-->\n          <span class=\"label label-primary m-l-8\">{{ software.softwareType }}</span>\n        </p>\n        <!-- SOFTWARE VERSION -->\n        <p class=\"text-truncate\">\n          <span class=\"text-label-small m-r-4\" translate> Version </span>\n          <span title=\"{{ software.version }}\">\n            {{ software.version }}\n          </span>\n        </p>\n      </div>\n\n      <div\n        *ngIf=\"supportsSoftwareOperations && (showUpdate || showRemove)\"\n        class=\"col-4 text-right\"\n      >\n        <!-- UPDATE SOFTWARE -->\n        <button\n          *ngIf=\"showUpdate && !isSoftwareGoingToBeChanged(software)\"\n          class=\"btn btn-default btn-xs showOnHover\"\n          (click)=\"update.emit(software)\"\n          title=\"{{ 'Update`software,verb`' | translate }}\"\n          translate\n        >\n          Update\n        </button>\n\n        <!-- REMOVE SOFTWARE -->\n        <button\n          *ngIf=\"showRemove && !isSoftwareGoingToBeChanged(software)\"\n          title=\"{{ 'Remove`software`' | translate }}\"\n          class=\"showOnHover btn btn-dot pull-right\"\n          (click)=\"remove.emit(software)\"\n        >\n          <i c8yIcon=\"minus-circle\" class=\"text-danger\"></i>\n        </button>\n      </div>\n    </c8y-li-body>\n  </c8y-li>\n</c8y-list-group>\n<!-- NO SEARCH RESULTS STATE -->\n<div class=\"card-block\" *ngIf=\"noSearchResults || emptyList\">\n  <ng-content *ngIf=\"emptyList\" select=\".c8y-empty-state:not(.c8y-no-results-state)\"></ng-content>\n  <ng-content *ngIf=\"noSearchResults\" select=\".c8y-no-results-state\"></ng-content>\n</div>\n"
            }]
    }], function () { return [{ type: ɵngcc1.AdvancedSoftwareService }]; }, { filterCriteria$: [{
            type: Input
        }], update: [{
            type: Output
        }], remove: [{
            type: Output
        }], onListEmpty: [{
            type: Output
        }], softwareList: [{
            type: Input
        }], device: [{
            type: Input
        }], deviceSoftwareChanges: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLXNvZnR3YXJlLWxpc3QuY29tcG9uZW50LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9yZXBvc2l0b3J5L3NvZnR3YXJlLWRldmljZS10YWIvZGV2aWNlLXNvZnR3YXJlLWxpc3QuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBb0IsU0FBUyxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQVUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRWpHLE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM3QyxPQUFPLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEUsT0FBTyxFQUFFLFlBQVksRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXpGLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLDZCQUE2QixDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFNdEUsTUFBTSxPQUFPLDJCQUEyQjtBQUFHLElBdUJ6QyxZQUFvQix1QkFBZ0Q7QUFBSSxRQUFwRCw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXlCO0FBQUMsUUFmNUQsb0JBQWUsR0FBdUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzFFLFFBQVksV0FBTSxHQUFHLElBQUksWUFBWSxFQUFrQixDQUFDO0FBQ3hELFFBQVksV0FBTSxHQUFHLElBQUksWUFBWSxFQUFrQixDQUFDO0FBQ3hELFFBQVksZ0JBQVcsR0FBMEIsSUFBSSxZQUFZLEVBQUUsQ0FBQztBQUNwRSxRQUtFLCtCQUEwQixHQUFZLEtBQUssQ0FBQztBQUM5QyxRQUNtQixt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Z0JBQVUsSUFBSSxjQUFjLGFBQWQsY0FBYyx1QkFBZCxjQUFjLENBQUUsWUFBWSxFQUFFO0FBQzVDLG9CQUFZLEtBQUssR0FBRyxLQUFLLElBQUksSUFBSSxDQUFDLFlBQVksS0FBSyxjQUFjLENBQUMsWUFBWSxDQUFDO0FBQy9FLGlCQUFXO0FBQ1gsZ0JBQ1UsT0FBTyxLQUFLLENBQUM7QUFDdkIsWUFBUSxDQUFDLENBQUM7QUFDVixZQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsS0FBSyxDQUFDO0FBQ3ZDLFFBQUksT0FBTztBQUNYLFlBQU0sSUFBSTtBQUNWLFlBQU0sR0FBRyxFQUFFLElBQUk7QUFDZixZQUFNLE1BQU0sRUFBRTtBQUNkLGdCQUFRLFVBQVUsRUFBRSxJQUFJLENBQUMsTUFBTTtBQUMvQixhQUFpQztBQUNqQyxTQUFLLENBQUM7QUFDTixJQUFFLENBQUM7QUFDSCxJQUNVLGVBQWUsQ0FBQyxPQUFnQjtBQUFJLFFBQzFDLElBQUksQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDO0FBQzdCLFFBQUksSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDbkMsSUFBRSxDQUFDO0FBQ0g7dURBL0dDLFNBQVMsU0FBQyxrQkFDVCxRQUFRLEVBQUUsMEJBQTBCLGtCQUNwQzs7Ozs7Ozs7Ozs7OzZRQUFrRCxjQUNuRCxXQUNJO0FBQUM7QUFBcUQsWUFObEQsdUJBQXVCO0FBQUc7QUFBRztBQUd0QywyQkFJRyxLQUFLO0FBQUsscUJBS1YsS0FBSztBQUFLLG9DQUNWLEtBQUs7QUFBSyw4QkFDVixLQUFLO0FBQUsscUJBQ1YsTUFBTTtBQUFLLHFCQUNYLE1BQU07QUFBSywwQkFDWCxNQUFNO0FBQUk7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWZ0ZXJDb250ZW50SW5pdCwgQ29tcG9uZW50LCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkluaXQsIE91dHB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSU1hbmFnZWRPYmplY3QsIElSZXN1bHRMaXN0LCBQYWdpbmcgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBmaWx0ZXIsIGdldCwgc2V0IH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlYm91bmNlVGltZSwgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBEZXZpY2VTb2Z0d2FyZSwgRGV2aWNlU29mdHdhcmVDaGFuZ2UsIFNvZnR3YXJlRmlsdGVyQ3JpdGVyaWEgfSBmcm9tICcuLi9yZXBvc2l0b3J5Lm1vZGVsJztcbmltcG9ydCB7IEFkdmFuY2VkU29mdHdhcmVTZXJ2aWNlIH0gZnJvbSAnLi9hZHZhbmNlZC1zb2Z0d2FyZS5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LWRldmljZS1zb2Z0d2FyZS1saXN0JyxcbiAgdGVtcGxhdGVVcmw6ICdkZXZpY2Utc29mdHdhcmUtbGlzdC5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgRGV2aWNlU29mdHdhcmVMaXN0Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlckNvbnRlbnRJbml0IHtcbiAgQElucHV0KCkgc2V0IHNvZnR3YXJlTGlzdChzb2Z0d2FyZUxpc3Q6IERldmljZVNvZnR3YXJlW10pIHtcbiAgICBpZiAoc29mdHdhcmVMaXN0ICE9PSBudWxsKSB7XG4gICAgICB0aGlzLmxlZ2FjeVNvZnR3YXJlTGlzdCQubmV4dChzb2Z0d2FyZUxpc3QpO1xuICAgIH1cbiAgfVxuICBASW5wdXQoKSBkZXZpY2U6IElNYW5hZ2VkT2JqZWN0O1xuICBASW5wdXQoKSBkZXZpY2VTb2Z0d2FyZUNoYW5nZXM6IERldmljZVNvZnR3YXJlQ2hhbmdlW107XG4gIEBJbnB1dCgpIGZpbHRlckNyaXRlcmlhJDogT2JzZXJ2YWJsZTxTb2Z0d2FyZUZpbHRlckNyaXRlcmlhPiA9IG9mKG51bGwpO1xuICBAT3V0cHV0KCkgdXBkYXRlID0gbmV3IEV2ZW50RW1pdHRlcjxEZXZpY2VTb2Z0d2FyZT4oKTtcbiAgQE91dHB1dCgpIHJlbW92ZSA9IG5ldyBFdmVudEVtaXR0ZXI8RGV2aWNlU29mdHdhcmU+KCk7XG4gIEBPdXRwdXQoKSBvbkxpc3RFbXB0eTogRXZlbnRFbWl0dGVyPGJvb2xlYW4+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBzb2Z0d2FyZUl0ZW1zJDogT2JzZXJ2YWJsZTxJUmVzdWx0TGlzdDxEZXZpY2VTb2Z0d2FyZT4+O1xuICBzaG93VXBkYXRlOiBib29sZWFuO1xuICBzaG93UmVtb3ZlOiBib29sZWFuO1xuICBlbXB0eUxpc3Q6IGJvb2xlYW47XG4gIG5vU2VhcmNoUmVzdWx0czogYm9vbGVhbjtcbiAgc3VwcG9ydHNTb2Z0d2FyZU9wZXJhdGlvbnM6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBwcml2YXRlIHJlYWRvbmx5IG9wZXJhdGlvblR5cGVzID0gWydjOHlfU29mdHdhcmVVcGRhdGUnLCAnYzh5X1NvZnR3YXJlTGlzdCcsICdjOHlfU29mdHdhcmUnXTtcblxuICBwcml2YXRlIGxlZ2FjeVNvZnR3YXJlTGlzdCQ6IEJlaGF2aW9yU3ViamVjdDxEZXZpY2VTb2Z0d2FyZVtdPiA9IG5ldyBCZWhhdmlvclN1YmplY3QoW10pO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgYWR2YW5jZWRTb2Z0d2FyZVNlcnZpY2U6IEFkdmFuY2VkU29mdHdhcmVTZXJ2aWNlKSB7fVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMuc29mdHdhcmVJdGVtcyQgPSBjb21iaW5lTGF0ZXN0KHRoaXMuZmlsdGVyQ3JpdGVyaWEkLCB0aGlzLmxlZ2FjeVNvZnR3YXJlTGlzdCQpLnBpcGUoXG4gICAgICBkZWJvdW5jZVRpbWUoMzAwKSxcbiAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICBzd2l0Y2hNYXAoKFtmaWx0ZXJDcml0ZXJpYSwgbGVnYWN5U29mdHdhcmVMaXN0XSkgPT4ge1xuICAgICAgICBpZiAobGVnYWN5U29mdHdhcmVMaXN0KSB7XG4gICAgICAgICAgcmV0dXJuIG9mKHRoaXMuZ2V0TGVnYWN5U29mdHdhcmVMaXN0KGZpbHRlckNyaXRlcmlhKSkucGlwZShcbiAgICAgICAgICAgIG1hcChyZXN1bHRMaXN0ID0+ICh7IHJlc3VsdExpc3QsIGZpbHRlckNyaXRlcmlhIH0pKVxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0QWR2YW5jZWRTb2Z0d2FyZUxpc3QoZmlsdGVyQ3JpdGVyaWEpLnRoZW4ocmVzdWx0TGlzdCA9PiAoe1xuICAgICAgICAgICAgcmVzdWx0TGlzdCxcbiAgICAgICAgICAgIGZpbHRlckNyaXRlcmlhXG4gICAgICAgICAgfSkpO1xuICAgICAgICB9XG4gICAgICB9KSxcbiAgICAgIHRhcCgoeyByZXN1bHRMaXN0LCBmaWx0ZXJDcml0ZXJpYSB9KSA9PiB7XG4gICAgICAgIHRoaXMubm90aWZ5TGlzdEVtcHR5KCFyZXN1bHRMaXN0Py5wYWdpbmc/LnRvdGFsUGFnZXMgJiYgIWZpbHRlckNyaXRlcmlhKTtcbiAgICAgICAgdGhpcy5ub1NlYXJjaFJlc3VsdHMgPSAhcmVzdWx0TGlzdD8ucGFnaW5nPy50b3RhbFBhZ2VzICYmICEhZmlsdGVyQ3JpdGVyaWE7XG4gICAgICB9KSxcbiAgICAgIG1hcCgoeyByZXN1bHRMaXN0IH0pID0+IHJlc3VsdExpc3QpXG4gICAgKTtcbiAgICBjb25zdCBzdXBwb3J0ZWRPcGVyYXRpb25zID0gZ2V0KHRoaXMuZGV2aWNlLCAnYzh5X1N1cHBvcnRlZE9wZXJhdGlvbnMnLCBbXSk7XG4gICAgdGhpcy5zdXBwb3J0c1NvZnR3YXJlT3BlcmF0aW9ucyA9IHRoaXMub3BlcmF0aW9uVHlwZXMuc29tZShcbiAgICAgIG9wZXJhdGlvblR5cGUgPT4gc3VwcG9ydGVkT3BlcmF0aW9ucy5pbmRleE9mKG9wZXJhdGlvblR5cGUpID4gLTFcbiAgICApO1xuICB9XG5cbiAgbmdBZnRlckNvbnRlbnRJbml0KCkge1xuICAgIHRoaXMuc2hvd1VwZGF0ZSA9IHRoaXMudXBkYXRlLm9ic2VydmVycy5sZW5ndGggPiAwO1xuICAgIHRoaXMuc2hvd1JlbW92ZSA9IHRoaXMucmVtb3ZlLm9ic2VydmVycy5sZW5ndGggPiAwO1xuICB9XG5cbiAgaXNTb2Z0d2FyZUdvaW5nVG9CZUNoYW5nZWQoc29mdHdhcmU6IERldmljZVNvZnR3YXJlKTogYm9vbGVhbiB7XG4gICAgY29uc3QgcmVsZXZhbnRDaGFuZ2VzID0gZmlsdGVyKHRoaXMuZGV2aWNlU29mdHdhcmVDaGFuZ2VzLCBzb2Z0d2FyZSk7XG4gICAgcmV0dXJuIHJlbGV2YW50Q2hhbmdlcy5sZW5ndGggPiAwO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRBZHZhbmNlZFNvZnR3YXJlTGlzdChcbiAgICBmaWx0ZXJDcml0ZXJpYTogU29mdHdhcmVGaWx0ZXJDcml0ZXJpYVxuICApOiBQcm9taXNlPElSZXN1bHRMaXN0PERldmljZVNvZnR3YXJlPj4ge1xuICAgIGNvbnN0IHF1ZXJ5RmlsdGVyID0geyBkZXZpY2VJZDogdGhpcy5kZXZpY2UuaWQgfTtcbiAgICBpZiAoZmlsdGVyQ3JpdGVyaWE/Lm5hbWUpIHtcbiAgICAgIHNldChxdWVyeUZpbHRlciwgJ25hbWUnLCBgKiR7ZmlsdGVyQ3JpdGVyaWEubmFtZX0qYCk7XG4gICAgfVxuICAgIGlmIChmaWx0ZXJDcml0ZXJpYT8uc29mdHdhcmVUeXBlKSB7XG4gICAgICBzZXQocXVlcnlGaWx0ZXIsICd0eXBlJywgYCR7ZmlsdGVyQ3JpdGVyaWEuc29mdHdhcmVUeXBlfWApO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5hZHZhbmNlZFNvZnR3YXJlU2VydmljZS5saXN0KHF1ZXJ5RmlsdGVyKSBhcyB1bmtub3duIGFzIFByb21pc2U8XG4gICAgICBJUmVzdWx0TGlzdDxEZXZpY2VTb2Z0d2FyZT5cbiAgICA+O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRMZWdhY3lTb2Z0d2FyZUxpc3QoXG4gICAgZmlsdGVyQ3JpdGVyaWE6IFNvZnR3YXJlRmlsdGVyQ3JpdGVyaWFcbiAgKTogSVJlc3VsdExpc3Q8RGV2aWNlU29mdHdhcmU+IHtcbiAgICBjb25zdCBkYXRhID0gZmlsdGVyQ3JpdGVyaWFcbiAgICAgID8gdGhpcy5sZWdhY3lTb2Z0d2FyZUxpc3QkLnZhbHVlLmZpbHRlcihpdGVtID0+IHtcbiAgICAgICAgICBsZXQgbWF0Y2ggPSB0cnVlO1xuICAgICAgICAgIGlmIChmaWx0ZXJDcml0ZXJpYT8ubmFtZSkge1xuICAgICAgICAgICAgbWF0Y2ggPSBtYXRjaCAmJiBpdGVtLm5hbWU/LmluY2x1ZGVzKGZpbHRlckNyaXRlcmlhLm5hbWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBpZiAoZmlsdGVyQ3JpdGVyaWE/LnNvZnR3YXJlVHlwZSkge1xuICAgICAgICAgICAgbWF0Y2ggPSBtYXRjaCAmJiBpdGVtLnNvZnR3YXJlVHlwZSA9PT0gZmlsdGVyQ3JpdGVyaWEuc29mdHdhcmVUeXBlO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBtYXRjaDtcbiAgICAgICAgfSlcbiAgICAgIDogdGhpcy5sZWdhY3lTb2Z0d2FyZUxpc3QkLnZhbHVlO1xuICAgIHJldHVybiB7XG4gICAgICBkYXRhLFxuICAgICAgcmVzOiBudWxsLFxuICAgICAgcGFnaW5nOiB7XG4gICAgICAgIHRvdGFsUGFnZXM6IGRhdGEubGVuZ3RoXG4gICAgICB9IGFzIFBhZ2luZzxEZXZpY2VTb2Z0d2FyZT5cbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBub3RpZnlMaXN0RW1wdHkoaXNFbXB0eTogYm9vbGVhbik6IHZvaWQge1xuICAgIHRoaXMuZW1wdHlMaXN0ID0gaXNFbXB0eTtcbiAgICB0aGlzLm9uTGlzdEVtcHR5LmVtaXQoaXNFbXB0eSk7XG4gIH1cbn1cbiJdfQ==