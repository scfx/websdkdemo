import { ChangeDetectionStrategy, ChangeDetectorRef, Component, ElementRef, HostListener, ViewChild } from '@angular/core';
import { QueriesUtil } from '@c8y/client';
import { FilteringFormRendererContext, gettext, TypeaheadComponent } from '@c8y/ngx-components';
import { cloneDeep, uniqBy } from 'lodash-es';
import { BehaviorSubject, NEVER, pipe } from 'rxjs';
import { debounceTime, map, switchMap, tap } from 'rxjs/operators';
import { RepositoryType } from '../../repository.model';
import { RepositoryService } from '../../repository.service';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/ngx-components';
import * as ɵngcc2 from '../../repository.service';
import * as ɵngcc3 from '@angular/forms';

function SoftwareTypeFilteringFormRendererComponent_c8y_li_5_Template(rf, ctx) { if (rf & 1) {
    const _r3 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "c8y-li", 6);
    ɵngcc0.ɵɵlistener("click", function SoftwareTypeFilteringFormRendererComponent_c8y_li_5_Template_c8y_li_click_0_listener() { const restoredCtx = ɵngcc0.ɵɵrestoreView(_r3); const software_r1 = restoredCtx.$implicit; const ctx_r2 = ɵngcc0.ɵɵnextContext(); ctx_r2.selectedType = software_r1; ctx_r2.typeahead.dropdown.hide(); return ctx_r2.changeDetectorRef.detectChanges(); });
    ɵngcc0.ɵɵelement(1, "c8y-highlight", 7);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const software_r1 = ctx.$implicit;
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵproperty("active", (ctx_r0.selectedType == null ? null : ctx_r0.selectedType.softwareType) === (software_r1 == null ? null : software_r1.softwareType));
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("text", (software_r1 == null ? null : software_r1.softwareType) || "--")("pattern", ctx_r0.search$.value);
} }
const _c0 = function () { return { example: "yum" }; };
export class SoftwareTypeFilteringFormRendererComponent {
    constructor(context, changeDetectorRef, repositoryService, elementRef) {
        this.context = context;
        this.changeDetectorRef = changeDetectorRef;
        this.repositoryService = repositoryService;
        this.elementRef = elementRef;
        this.softwareWithType$ = NEVER;
        this.search$ = new BehaviorSubject(null);
        this.filterPipe = pipe(tap());
        this.typeaheadPlaceholder = gettext('Start typing to search, e.g. {{ example }}');
        this.queriesUtil = new QueriesUtil();
        this.softwareTypes = new Set();
        this.softwareWithType$ = this.search$.pipe(debounceTime(300), tap(() => this.softwareTypes.clear()), switchMap((searchString) => {
            let query = this.queriesUtil.prependOrderbys({}, [{ softwareType: 1 }]);
            const filter = !!searchString
                ? {
                    softwareType: {
                        __eq: `*${searchString}*`
                    }
                }
                : {
                    __has: 'softwareType'
                };
            query = this.queriesUtil.addAndFilter(query, filter);
            return this.repositoryService.listRepositoryEntries(RepositoryType.SOFTWARE, {
                skipDefaultOrder: true,
                query,
                params: {
                    pageSize: 200
                }
            });
        }));
        this.filterPipe = pipe(map(this.removeDuplicatesBySoftwareType.bind(this)), tap(() => this.changeDetectorRef.detectChanges()));
    }
    onEnterKeyDown(event) {
        event.stopPropagation();
        this.applyFilter();
    }
    onEscapeKeyDown(event) {
        event.stopPropagation();
        this.context.resetFilter();
    }
    ngOnInit() {
        const column = this.context.property;
        this.selectedType = cloneDeep(column.externalFilterQuery || {});
    }
    ngAfterViewInit() {
        var _a, _b, _c;
        (_c = (_b = (_a = this.typeahead) === null || _a === void 0 ? void 0 : _a.searchControl) === null || _b === void 0 ? void 0 : _b.nativeElement) === null || _c === void 0 ? void 0 : _c.focus();
        try {
            this.elementRef.nativeElement.parentElement.parentElement.style.overflow = 'visible';
        }
        catch (ex) {
            // intentionally empty
        }
    }
    applyFilter() {
        this.context.applyFilter({
            externalFilterQuery: this.selectedType
        });
    }
    removeDuplicatesBySoftwareType(list) {
        const uniqueBySoftwareType = uniqBy(list, 'softwareType').filter((sw) => !this.softwareTypes.has(sw.softwareType));
        uniqueBySoftwareType.forEach((sw) => this.softwareTypes.add(sw.softwareType));
        return uniqueBySoftwareType;
    }
}
SoftwareTypeFilteringFormRendererComponent.ɵfac = function SoftwareTypeFilteringFormRendererComponent_Factory(t) { return new (t || SoftwareTypeFilteringFormRendererComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.FilteringFormRendererContext), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ChangeDetectorRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.RepositoryService), ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef)); };
SoftwareTypeFilteringFormRendererComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: SoftwareTypeFilteringFormRendererComponent, selectors: [["ng-component"]], viewQuery: function SoftwareTypeFilteringFormRendererComponent_Query(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵviewQuery(TypeaheadComponent, 5);
    } if (rf & 2) {
        let _t;
        ɵngcc0.ɵɵqueryRefresh(_t = ɵngcc0.ɵɵloadQuery()) && (ctx.typeahead = _t.first);
    } }, hostBindings: function SoftwareTypeFilteringFormRendererComponent_HostBindings(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵlistener("keydown.enter", function SoftwareTypeFilteringFormRendererComponent_keydown_enter_HostBindingHandler($event) { return ctx.onEnterKeyDown($event); })("keydown.escape", function SoftwareTypeFilteringFormRendererComponent_keydown_escape_HostBindingHandler($event) { return ctx.onEscapeKeyDown($event); });
    } }, decls: 13, vars: 15, consts: [["translate", ""], ["name", "softwareType", "displayProperty", "softwareType", 3, "ngModel", "placeholder", "ngModelChange", "onSearch"], ["class", "p-l-8 p-r-8 c8y-list__item--link", 3, "active", "click", 4, "c8yFor", "c8yForOf", "c8yForPipe", "c8yForLoadMore"], [1, "data-grid__dropdown__footer", "d-flex", "separator-top"], ["translate", "", 1, "btn", "btn-default", "btn-sm", "m-r-8", "flex-grow", 3, "title", "click"], ["translate", "", 1, "btn", "btn-primary", "btn-sm", "flex-grow", 3, "title", "click"], [1, "p-l-8", "p-r-8", "c8y-list__item--link", 3, "active", "click"], [3, "text", "pattern"]], template: function SoftwareTypeFilteringFormRendererComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "c8y-form-group");
        ɵngcc0.ɵɵelementStart(1, "label", 0);
        ɵngcc0.ɵɵtext(2, "Filter by software type");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(3, "c8y-typeahead", 1);
        ɵngcc0.ɵɵlistener("ngModelChange", function SoftwareTypeFilteringFormRendererComponent_Template_c8y_typeahead_ngModelChange_3_listener($event) { return ctx.selectedType = $event; })("onSearch", function SoftwareTypeFilteringFormRendererComponent_Template_c8y_typeahead_onSearch_3_listener($event) { return ctx.search$.next($event); });
        ɵngcc0.ɵɵpipe(4, "translate");
        ɵngcc0.ɵɵtemplate(5, SoftwareTypeFilteringFormRendererComponent_c8y_li_5_Template, 2, 3, "c8y-li", 2);
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(6, "div", 3);
        ɵngcc0.ɵɵelementStart(7, "button", 4);
        ɵngcc0.ɵɵlistener("click", function SoftwareTypeFilteringFormRendererComponent_Template_button_click_7_listener() { return ctx.context.resetFilter(); });
        ɵngcc0.ɵɵpipe(8, "translate");
        ɵngcc0.ɵɵtext(9, " Reset ");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(10, "button", 5);
        ɵngcc0.ɵɵlistener("click", function SoftwareTypeFilteringFormRendererComponent_Template_button_click_10_listener() { return ctx.applyFilter(); });
        ɵngcc0.ɵɵpipe(11, "translate");
        ɵngcc0.ɵɵtext(12, " Apply ");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵadvance(3);
        ɵngcc0.ɵɵpropertyInterpolate("placeholder", ɵngcc0.ɵɵpipeBind2(4, 7, ctx.typeaheadPlaceholder, ɵngcc0.ɵɵpureFunction0(14, _c0)));
        ɵngcc0.ɵɵproperty("ngModel", ctx.selectedType);
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("c8yForOf", ctx.softwareWithType$)("c8yForPipe", ctx.filterPipe)("c8yForLoadMore", "auto");
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(8, 10, "Reset"));
        ɵngcc0.ɵɵadvance(3);
        ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(11, 12, "Apply"));
    } }, directives: [ɵngcc1.FormGroupComponent, ɵngcc1.C8yTranslateDirective, ɵngcc1.TypeaheadComponent, ɵngcc3.NgControlStatus, ɵngcc3.NgModel, ɵngcc1.ForOfDirective, ɵngcc1.ListItemComponent, ɵngcc1.HighlightComponent], pipes: [ɵngcc1.C8yTranslatePipe], encapsulation: 2 });
SoftwareTypeFilteringFormRendererComponent.ctorParameters = () => [
    { type: FilteringFormRendererContext },
    { type: ChangeDetectorRef },
    { type: RepositoryService },
    { type: ElementRef }
];
SoftwareTypeFilteringFormRendererComponent.propDecorators = {
    typeahead: [{ type: ViewChild, args: [TypeaheadComponent, { static: false },] }],
    onEnterKeyDown: [{ type: HostListener, args: ['keydown.enter', ['$event'],] }],
    onEscapeKeyDown: [{ type: HostListener, args: ['keydown.escape', ['$event'],] }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(SoftwareTypeFilteringFormRendererComponent, [{
        type: Component,
        args: [{
                template: "<c8y-form-group>\n  <label translate>Filter by software type</label>\n  <c8y-typeahead\n    [(ngModel)]=\"selectedType\"\n    name=\"softwareType\"\n    placeholder=\"{{ typeaheadPlaceholder | translate: { example: 'yum' } }}\"\n    displayProperty=\"softwareType\"\n    (onSearch)=\"search$.next($event)\"\n  >\n    <c8y-li\n      *c8yFor=\"let software of softwareWithType$; pipe: filterPipe; loadMore: 'auto'\"\n      class=\"p-l-8 p-r-8 c8y-list__item--link\"\n      (click)=\"\n        selectedType = software; typeahead.dropdown.hide(); changeDetectorRef.detectChanges()\n      \"\n      [active]=\"selectedType?.softwareType === software?.softwareType\"\n    >\n      <c8y-highlight\n        [text]=\"software?.softwareType || '--'\"\n        [pattern]=\"search$.value\"\n      ></c8y-highlight>\n    </c8y-li>\n  </c8y-typeahead>\n</c8y-form-group>\n\n<div class=\"data-grid__dropdown__footer d-flex separator-top\">\n  <button\n    class=\"btn btn-default btn-sm m-r-8 flex-grow\"\n    (click)=\"context.resetFilter()\"\n    title=\"{{ 'Reset' | translate }}\"\n    translate\n  >\n    Reset\n  </button>\n\n  <button\n    class=\"btn btn-primary btn-sm flex-grow\"\n    (click)=\"applyFilter()\"\n    title=\"{{ 'Apply' | translate }}\"\n    translate\n  >\n    Apply\n  </button>\n</div>\n",
                changeDetection: ChangeDetectionStrategy.Default
            }]
    }], function () { return [{ type: ɵngcc1.FilteringFormRendererContext }, { type: ɵngcc0.ChangeDetectorRef }, { type: ɵngcc2.RepositoryService }, { type: ɵngcc0.ElementRef }]; }, { onEnterKeyDown: [{
            type: HostListener,
            args: ['keydown.enter', ['$event']]
        }], onEscapeKeyDown: [{
            type: HostListener,
            args: ['keydown.escape', ['$event']]
        }], typeahead: [{
            type: ViewChild,
            args: [TypeaheadComponent, { static: false }]
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29mdHdhcmUtdHlwZS5maWx0ZXJpbmctZm9ybS1yZW5kZXJlci5jb21wb25lbnQuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3JlcG9zaXRvcnkvc29mdHdhcmUvY29sdW1ucy9zb2Z0d2FyZS10eXBlLmZpbHRlcmluZy1mb3JtLXJlbmRlcmVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsdUJBQXVCLEVBQ3ZCLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFFWixTQUFTLEVBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUErQixXQUFXLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkUsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRWhHLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQzlDLE9BQU8sRUFBRSxlQUFlLEVBQUUsS0FBSyxFQUFjLElBQUksRUFBaUIsTUFBTSxNQUFNLENBQUM7QUFDL0UsT0FBTyxFQUFFLFlBQVksRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN4RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFNN0QsTUFBTSxPQUFPLDBDQUEwQztBQUFHLElBVXhELFlBQ1MsT0FBcUMsRUFDckMsaUJBQW9DLEVBQ25DLGlCQUFvQyxFQUNwQyxVQUFzQjtBQUMvQixRQUpRLFlBQU8sR0FBUCxPQUFPLENBQThCO0FBQUMsUUFDdEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtBQUFDLFFBQ3BDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBbUI7QUFBQyxRQUNy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QUFDLGtCQUFrQixFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRTtBQUFPLDZCQTBDdEQsWUFBWSxTQUFDLGVBQWUsRUFBRSxDQUFDLFFBQVEsQ0FBQztBQUFPLDhCQUkvQyxZQUFZLFNBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxRQUFRLENBQUM7QUFBTTs7Ozs7Ozs7Ozs7Ozs7OztvQkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBDb21wb25lbnQsXG4gIEVsZW1lbnRSZWYsXG4gIEhvc3RMaXN0ZW5lcixcbiAgT25Jbml0LFxuICBWaWV3Q2hpbGRcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJTWFuYWdlZE9iamVjdCwgSVJlc3VsdExpc3QsIFF1ZXJpZXNVdGlsIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgRmlsdGVyaW5nRm9ybVJlbmRlcmVyQ29udGV4dCwgZ2V0dGV4dCwgVHlwZWFoZWFkQ29tcG9uZW50IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBEZXZpY2VHcmlkQ29sdW1uIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9kZXZpY2UtZ3JpZCc7XG5pbXBvcnQgeyBjbG9uZURlZXAsIHVuaXFCeSB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE5FVkVSLCBPYnNlcnZhYmxlLCBwaXBlLCBVbmFyeUZ1bmN0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBkZWJvdW5jZVRpbWUsIG1hcCwgc3dpdGNoTWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBSZXBvc2l0b3J5VHlwZSB9IGZyb20gJy4uLy4uL3JlcG9zaXRvcnkubW9kZWwnO1xuaW1wb3J0IHsgUmVwb3NpdG9yeVNlcnZpY2UgfSBmcm9tICcuLi8uLi9yZXBvc2l0b3J5LnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgdGVtcGxhdGVVcmw6ICcuL3NvZnR3YXJlLXR5cGUuZmlsdGVyaW5nLWZvcm0tcmVuZGVyZXIuY29tcG9uZW50Lmh0bWwnLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5LkRlZmF1bHRcbn0pXG5leHBvcnQgY2xhc3MgU29mdHdhcmVUeXBlRmlsdGVyaW5nRm9ybVJlbmRlcmVyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcbiAgc2VsZWN0ZWRUeXBlOiBJTWFuYWdlZE9iamVjdDtcbiAgc29mdHdhcmVXaXRoVHlwZSQ6IE9ic2VydmFibGU8SVJlc3VsdExpc3Q8SU1hbmFnZWRPYmplY3Q+PiA9IE5FVkVSO1xuICBzZWFyY2gkOiBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPiA9IG5ldyBCZWhhdmlvclN1YmplY3QobnVsbCk7XG4gIGZpbHRlclBpcGU6IFVuYXJ5RnVuY3Rpb248dW5rbm93biwgdW5rbm93bj4gPSBwaXBlKHRhcCgpKTtcbiAgdHlwZWFoZWFkUGxhY2Vob2xkZXIgPSBnZXR0ZXh0KCdTdGFydCB0eXBpbmcgdG8gc2VhcmNoLCBlLmcuIHt7IGV4YW1wbGUgfX0nKTtcbiAgQFZpZXdDaGlsZChUeXBlYWhlYWRDb21wb25lbnQsIHsgc3RhdGljOiBmYWxzZSB9KSB0eXBlYWhlYWQ6IFR5cGVhaGVhZENvbXBvbmVudDtcbiAgcHJpdmF0ZSBxdWVyaWVzVXRpbDogUXVlcmllc1V0aWwgPSBuZXcgUXVlcmllc1V0aWwoKTtcbiAgcHJpdmF0ZSBzb2Z0d2FyZVR5cGVzOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgY29udGV4dDogRmlsdGVyaW5nRm9ybVJlbmRlcmVyQ29udGV4dCxcbiAgICBwdWJsaWMgY2hhbmdlRGV0ZWN0b3JSZWY6IENoYW5nZURldGVjdG9yUmVmLFxuICAgIHByaXZhdGUgcmVwb3NpdG9yeVNlcnZpY2U6IFJlcG9zaXRvcnlTZXJ2aWNlLFxuICAgIHByaXZhdGUgZWxlbWVudFJlZjogRWxlbWVudFJlZlxuICApIHtcbiAgICB0aGlzLnNvZnR3YXJlV2l0aFR5cGUkID0gdGhpcy5zZWFyY2gkLnBpcGUoXG4gICAgICBkZWJvdW5jZVRpbWUoMzAwKSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLnNvZnR3YXJlVHlwZXMuY2xlYXIoKSksXG4gICAgICBzd2l0Y2hNYXAoKHNlYXJjaFN0cmluZzogc3RyaW5nKSA9PiB7XG4gICAgICAgIGxldCBxdWVyeSA9IHRoaXMucXVlcmllc1V0aWwucHJlcGVuZE9yZGVyYnlzKHt9LCBbeyBzb2Z0d2FyZVR5cGU6IDEgfV0pO1xuICAgICAgICBjb25zdCBmaWx0ZXIgPSAhIXNlYXJjaFN0cmluZ1xuICAgICAgICAgID8ge1xuICAgICAgICAgICAgICBzb2Z0d2FyZVR5cGU6IHtcbiAgICAgICAgICAgICAgICBfX2VxOiBgKiR7c2VhcmNoU3RyaW5nfSpgXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICA6IHtcbiAgICAgICAgICAgICAgX19oYXM6ICdzb2Z0d2FyZVR5cGUnXG4gICAgICAgICAgICB9O1xuICAgICAgICBxdWVyeSA9IHRoaXMucXVlcmllc1V0aWwuYWRkQW5kRmlsdGVyKHF1ZXJ5LCBmaWx0ZXIpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLnJlcG9zaXRvcnlTZXJ2aWNlLmxpc3RSZXBvc2l0b3J5RW50cmllcyhSZXBvc2l0b3J5VHlwZS5TT0ZUV0FSRSwge1xuICAgICAgICAgIHNraXBEZWZhdWx0T3JkZXI6IHRydWUsXG4gICAgICAgICAgcXVlcnksXG4gICAgICAgICAgcGFyYW1zOiB7XG4gICAgICAgICAgICBwYWdlU2l6ZTogMjAwXG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHRoaXMuZmlsdGVyUGlwZSA9IHBpcGUoXG4gICAgICBtYXAodGhpcy5yZW1vdmVEdXBsaWNhdGVzQnlTb2Z0d2FyZVR5cGUuYmluZCh0aGlzKSksXG4gICAgICB0YXAoKCkgPT4gdGhpcy5jaGFuZ2VEZXRlY3RvclJlZi5kZXRlY3RDaGFuZ2VzKCkpXG4gICAgKTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24uZW50ZXInLCBbJyRldmVudCddKSBvbkVudGVyS2V5RG93bihldmVudDogS2V5Ym9hcmRFdmVudCkge1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMuYXBwbHlGaWx0ZXIoKTtcbiAgfVxuICBASG9zdExpc3RlbmVyKCdrZXlkb3duLmVzY2FwZScsIFsnJGV2ZW50J10pIG9uRXNjYXBlS2V5RG93bihldmVudDogS2V5Ym9hcmRFdmVudCkge1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMuY29udGV4dC5yZXNldEZpbHRlcigpO1xuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgY29uc3QgY29sdW1uOiBEZXZpY2VHcmlkQ29sdW1uID0gdGhpcy5jb250ZXh0LnByb3BlcnR5O1xuICAgIHRoaXMuc2VsZWN0ZWRUeXBlID0gY2xvbmVEZWVwKGNvbHVtbi5leHRlcm5hbEZpbHRlclF1ZXJ5IHx8IHt9KTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLnR5cGVhaGVhZD8uc2VhcmNoQ29udHJvbD8ubmF0aXZlRWxlbWVudD8uZm9jdXMoKTtcbiAgICB0cnkge1xuICAgICAgdGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQucGFyZW50RWxlbWVudC5wYXJlbnRFbGVtZW50LnN0eWxlLm92ZXJmbG93ID0gJ3Zpc2libGUnO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAvLyBpbnRlbnRpb25hbGx5IGVtcHR5XG4gICAgfVxuICB9XG5cbiAgYXBwbHlGaWx0ZXIoKSB7XG4gICAgdGhpcy5jb250ZXh0LmFwcGx5RmlsdGVyKHtcbiAgICAgIGV4dGVybmFsRmlsdGVyUXVlcnk6IHRoaXMuc2VsZWN0ZWRUeXBlXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHJlbW92ZUR1cGxpY2F0ZXNCeVNvZnR3YXJlVHlwZShsaXN0OiBJTWFuYWdlZE9iamVjdFtdKTogSU1hbmFnZWRPYmplY3RbXSB7XG4gICAgY29uc3QgdW5pcXVlQnlTb2Z0d2FyZVR5cGU6IElNYW5hZ2VkT2JqZWN0W10gPSB1bmlxQnkobGlzdCwgJ3NvZnR3YXJlVHlwZScpLmZpbHRlcihcbiAgICAgIChzdzogSU1hbmFnZWRPYmplY3QpID0+ICF0aGlzLnNvZnR3YXJlVHlwZXMuaGFzKHN3LnNvZnR3YXJlVHlwZSlcbiAgICApO1xuICAgIHVuaXF1ZUJ5U29mdHdhcmVUeXBlLmZvckVhY2goKHN3OiBJTWFuYWdlZE9iamVjdCkgPT4gdGhpcy5zb2Z0d2FyZVR5cGVzLmFkZChzdy5zb2Z0d2FyZVR5cGUpKTtcbiAgICByZXR1cm4gdW5pcXVlQnlTb2Z0d2FyZVR5cGU7XG4gIH1cbn1cbiJdfQ==