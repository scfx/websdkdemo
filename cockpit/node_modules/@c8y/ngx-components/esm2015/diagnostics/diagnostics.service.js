import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { InventoryBinaryService, OperationService, OperationStatus } from '@c8y/client';
import { AlertService, gettext, ModalService } from '@c8y/ngx-components';
import { assign } from 'lodash-es';
import { switchMap } from 'rxjs/operators';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/client';
import * as ɵngcc2 from '@c8y/ngx-components';
export class DiagnosticsService {
    constructor(operationService, inventoryBinary, modalService, alertService) {
        this.operationService = operationService;
        this.inventoryBinary = inventoryBinary;
        this.modalService = modalService;
        this.alertService = alertService;
        this.fragment = 'c8y_DiagnosticReport';
    }
    isSupportedDevice(device) {
        const supportedOperations = (device && device.c8y_SupportedOperations) || [];
        return supportedOperations.includes(this.fragment);
    }
    getOperations$(device$) {
        return device$.pipe(switchMap(device => this.operationService.list({
            deviceId: device.id,
            fragmentType: this.fragment,
            dateFrom: new Date(0).toISOString(),
            dateTo: new Date(Date.now()).toISOString(),
            revert: true,
            pageSize: 10,
            withTotalPages: true
        })));
    }
    createOperation(deviceId) {
        return __awaiter(this, void 0, void 0, function* () {
            const operation = {
                deviceId,
                description: gettext('Diagnostic file request'),
                [this.fragment]: {}
            };
            try {
                yield this.operationService.create(operation);
                this.alertService.success(gettext('Diagnostic file request sent.'));
            }
            catch (error) {
                this.alertService.addServerFailure(error);
            }
        });
    }
    deleteOperation(operation) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const result = yield this.modalService.confirm(gettext('Delete diagnostic file'), gettext('You are about to delete this diagnostic file. Do you want to proceed?'), 'danger', {
                    ok: gettext('Delete'),
                    cancel: gettext('Cancel')
                });
                if (result) {
                    this.deleteDiagnosticsBinary(operation);
                }
            }
            catch (error) {
                // Do nothing
            }
        });
    }
    cancelOperation(operation) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const operationAfterUpdate = (yield this.operationService.update({
                    id: operation.id,
                    status: OperationStatus.FAILED,
                    failureReason: gettext('Operation cancelled by user.')
                })).data;
                assign(operation, operationAfterUpdate);
                this.alertService.success(gettext('Diagnostic file request cancelled.'));
            }
            catch (ex) {
                this.alertService.addServerFailure(ex);
            }
        });
    }
    getOperation(op) {
        if (!op) {
            return null;
        }
        return op && op[this.fragment];
    }
    deleteDiagnosticsBinary(op) {
        return __awaiter(this, void 0, void 0, function* () {
            const operation = this.getOperation(op);
            if (operation && operation.file) {
                const { file } = operation;
                try {
                    const binaryId = this.inventoryBinary.getIdFromUrl(file);
                    const result = yield this.inventoryBinary.delete(binaryId);
                    if (result) {
                        this.deleteDiagnosticsFragment(op);
                    }
                }
                catch (err) {
                    if (err.res.status === 404) {
                        // In case the file is already deleted via other means we want to delete the fragment
                        this.deleteDiagnosticsFragment(op);
                    }
                    else {
                        const msg = gettext('Could not delete the diagnostic file.');
                        this.alertService.danger(msg);
                    }
                }
            }
        });
    }
    deleteDiagnosticsFragment(op) {
        return __awaiter(this, void 0, void 0, function* () {
            const deleteOp = {
                id: op.id,
                status: op.status,
                [this.fragment]: null
            };
            try {
                const operationAfterUpdate = (yield this.operationService.update(deleteOp)).data;
                assign(op, operationAfterUpdate);
                this.alertService.success(gettext('Diagnostic file deleted.'));
            }
            catch (error) {
                this.alertService.addServerFailure(error);
            }
        });
    }
}
DiagnosticsService.ɵfac = function DiagnosticsService_Factory(t) { return new (t || DiagnosticsService)(ɵngcc0.ɵɵinject(ɵngcc1.OperationService), ɵngcc0.ɵɵinject(ɵngcc1.InventoryBinaryService), ɵngcc0.ɵɵinject(ɵngcc2.ModalService), ɵngcc0.ɵɵinject(ɵngcc2.AlertService)); };
DiagnosticsService.ɵprov = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjectable({ token: DiagnosticsService, factory: DiagnosticsService.ɵfac });
DiagnosticsService.ctorParameters = () => [
    { type: OperationService },
    { type: InventoryBinaryService },
    { type: ModalService },
    { type: AlertService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(DiagnosticsService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.OperationService }, { type: ɵngcc1.InventoryBinaryService }, { type: ɵngcc2.ModalService }, { type: ɵngcc2.AlertService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhZ25vc3RpY3Muc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vZGlhZ25vc3RpY3MvZGlhZ25vc3RpY3Muc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBR0wsc0JBQXNCLEVBRXRCLGdCQUFnQixFQUNoQixlQUFlLEVBQ2hCLE1BQU0sYUFBYSxDQUFDO0FBQ3JCLE9BQU8sRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDbkMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7O0FBRzNDLE1BQU0sT0FBTyxrQkFBa0I7QUFDL0IsSUFDRSxZQUNVLGdCQUFrQyxFQUNsQyxlQUF1QyxFQUN2QyxZQUEwQixFQUMxQixZQUEwQjtBQUNuQyxRQUpTLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7QUFBQyxRQUNuQyxvQkFBZSxHQUFmLGVBQWUsQ0FBd0I7QUFBQyxRQUN4QyxpQkFBWSxHQUFaLFlBQVksQ0FBYztBQUFDLFFBQzNCLGlCQUFZLEdBQVosWUFBWSxDQUFjO0FBQ3RDLFFBTlcsYUFBUSxHQUFHLHNCQUFzQixDQUFDO0FBQzdDLElBS0ssQ0FBQztBQUNOLElBQ0UsaUJBQWlCLENBQUMsTUFBTTtBQUFJLFFBQzFCLE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLHVCQUF1QixDQUFDLElBQUksRUFBRSxDQUFDO0FBQ2pGLFFBQUksT0FBTyxtQkFBbUIsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3ZELElBQUUsQ0FBQztBQUNILElBQ0UsY0FBYyxDQUFDLE9BQW1DO0FBQUksUUFDcEQsT0FBTyxPQUFPLENBQUMsSUFBSSxDQUNqQixT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VSxJQUFJLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN4QyxxQkFBUztBQUNULGlCQUFPO0FBQ1AsYUFBSztBQUNMLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSCxJQUNnQix5QkFBeUIsQ0FBQyxFQUFjO0FBQ3hEO0FBRXNCLFlBRmxCLE1BQU0sUUFBUSxHQUFHO0FBQ3JCLGdCQUFNLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRTtBQUNmLGdCQUFNLE1BQU0sRUFBRSxFQUFFLENBQUMsTUFBTTtBQUN2QixnQkFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxJQUFJO0FBQzNCLGFBQUssQ0FBQztBQUNOLFlBQUksSUFBSTtBQUNSLGdCQUFNLE1BQU0sb0JBQW9CLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7QUFDdkYsZ0JBQU0sTUFBTSxDQUFDLEVBQUUsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO0FBQ3ZDLGdCQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQywwQkFBMEIsQ0FBQyxDQUFDLENBQUM7QUFDckUsYUFBSztBQUFDLFlBQUEsT0FBTyxLQUFLLEVBQUU7QUFDcEIsZ0JBQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNoRCxhQUFLO0FBQ0wsUUFBRSxDQUFDO0FBRUgsS0FGRztBQUNIOzhDQTVIQyxVQUFVO29JQUNUO0FBQUM7QUFDVSxZQVRYLGdCQUFnQjtBQUNoQixZQUhBLHNCQUFzQjtBQUN0QixZQUk4QixZQUFZO0FBQUksWUFBdkMsWUFBWTtBQUFHOzs7d0xBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIElNYW5hZ2VkT2JqZWN0LFxuICBJUmVzdWx0TGlzdCxcbiAgSW52ZW50b3J5QmluYXJ5U2VydmljZSxcbiAgSU9wZXJhdGlvbixcbiAgT3BlcmF0aW9uU2VydmljZSxcbiAgT3BlcmF0aW9uU3RhdHVzXG59IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSwgZ2V0dGV4dCwgTW9kYWxTZXJ2aWNlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBhc3NpZ24gfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRGlhZ25vc3RpY3NTZXJ2aWNlIHtcbiAgcmVhZG9ubHkgZnJhZ21lbnQgPSAnYzh5X0RpYWdub3N0aWNSZXBvcnQnO1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG9wZXJhdGlvblNlcnZpY2U6IE9wZXJhdGlvblNlcnZpY2UsXG4gICAgcHJpdmF0ZSBpbnZlbnRvcnlCaW5hcnk6IEludmVudG9yeUJpbmFyeVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBtb2RhbFNlcnZpY2U6IE1vZGFsU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlXG4gICkge31cblxuICBpc1N1cHBvcnRlZERldmljZShkZXZpY2UpOiBib29sZWFuIHtcbiAgICBjb25zdCBzdXBwb3J0ZWRPcGVyYXRpb25zID0gKGRldmljZSAmJiBkZXZpY2UuYzh5X1N1cHBvcnRlZE9wZXJhdGlvbnMpIHx8IFtdO1xuICAgIHJldHVybiBzdXBwb3J0ZWRPcGVyYXRpb25zLmluY2x1ZGVzKHRoaXMuZnJhZ21lbnQpO1xuICB9XG5cbiAgZ2V0T3BlcmF0aW9ucyQoZGV2aWNlJDogT2JzZXJ2YWJsZTxJTWFuYWdlZE9iamVjdD4pOiBPYnNlcnZhYmxlPElSZXN1bHRMaXN0PElPcGVyYXRpb24+PiB7XG4gICAgcmV0dXJuIGRldmljZSQucGlwZShcbiAgICAgIHN3aXRjaE1hcChkZXZpY2UgPT5cbiAgICAgICAgdGhpcy5vcGVyYXRpb25TZXJ2aWNlLmxpc3Qoe1xuICAgICAgICAgIGRldmljZUlkOiBkZXZpY2UuaWQsXG4gICAgICAgICAgZnJhZ21lbnRUeXBlOiB0aGlzLmZyYWdtZW50LFxuICAgICAgICAgIGRhdGVGcm9tOiBuZXcgRGF0ZSgwKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIGRhdGVUbzogbmV3IERhdGUoRGF0ZS5ub3coKSkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgICByZXZlcnQ6IHRydWUsXG4gICAgICAgICAgcGFnZVNpemU6IDEwLFxuICAgICAgICAgIHdpdGhUb3RhbFBhZ2VzOiB0cnVlXG4gICAgICAgIH0pXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZU9wZXJhdGlvbihkZXZpY2VJZDogc3RyaW5nKSB7XG4gICAgY29uc3Qgb3BlcmF0aW9uID0ge1xuICAgICAgZGV2aWNlSWQsXG4gICAgICBkZXNjcmlwdGlvbjogZ2V0dGV4dCgnRGlhZ25vc3RpYyBmaWxlIHJlcXVlc3QnKSxcbiAgICAgIFt0aGlzLmZyYWdtZW50XToge31cbiAgICB9O1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLm9wZXJhdGlvblNlcnZpY2UuY3JlYXRlKG9wZXJhdGlvbik7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5zdWNjZXNzKGdldHRleHQoJ0RpYWdub3N0aWMgZmlsZSByZXF1ZXN0IHNlbnQuJykpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5hZGRTZXJ2ZXJGYWlsdXJlKGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkZWxldGVPcGVyYXRpb24ob3BlcmF0aW9uOiBJT3BlcmF0aW9uKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMubW9kYWxTZXJ2aWNlLmNvbmZpcm0oXG4gICAgICAgIGdldHRleHQoJ0RlbGV0ZSBkaWFnbm9zdGljIGZpbGUnKSxcbiAgICAgICAgZ2V0dGV4dCgnWW91IGFyZSBhYm91dCB0byBkZWxldGUgdGhpcyBkaWFnbm9zdGljIGZpbGUuIERvIHlvdSB3YW50IHRvIHByb2NlZWQ/JyksXG4gICAgICAgICdkYW5nZXInLFxuICAgICAgICB7XG4gICAgICAgICAgb2s6IGdldHRleHQoJ0RlbGV0ZScpLFxuICAgICAgICAgIGNhbmNlbDogZ2V0dGV4dCgnQ2FuY2VsJylcbiAgICAgICAgfVxuICAgICAgKTtcblxuICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICB0aGlzLmRlbGV0ZURpYWdub3N0aWNzQmluYXJ5KG9wZXJhdGlvbik7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIERvIG5vdGhpbmdcbiAgICB9XG4gIH1cblxuICBhc3luYyBjYW5jZWxPcGVyYXRpb24ob3BlcmF0aW9uOiBJT3BlcmF0aW9uKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG9wZXJhdGlvbkFmdGVyVXBkYXRlID0gKFxuICAgICAgICBhd2FpdCB0aGlzLm9wZXJhdGlvblNlcnZpY2UudXBkYXRlKHtcbiAgICAgICAgICBpZDogb3BlcmF0aW9uLmlkLFxuICAgICAgICAgIHN0YXR1czogT3BlcmF0aW9uU3RhdHVzLkZBSUxFRCxcbiAgICAgICAgICBmYWlsdXJlUmVhc29uOiBnZXR0ZXh0KCdPcGVyYXRpb24gY2FuY2VsbGVkIGJ5IHVzZXIuJylcbiAgICAgICAgfSlcbiAgICAgICkuZGF0YTtcbiAgICAgIGFzc2lnbihvcGVyYXRpb24sIG9wZXJhdGlvbkFmdGVyVXBkYXRlKTtcbiAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLnN1Y2Nlc3MoZ2V0dGV4dCgnRGlhZ25vc3RpYyBmaWxlIHJlcXVlc3QgY2FuY2VsbGVkLicpKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRPcGVyYXRpb24ob3A6IElPcGVyYXRpb24pIHtcbiAgICBpZiAoIW9wKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIG9wICYmIG9wW3RoaXMuZnJhZ21lbnRdO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBkZWxldGVEaWFnbm9zdGljc0JpbmFyeShvcDogSU9wZXJhdGlvbikge1xuICAgIGNvbnN0IG9wZXJhdGlvbiA9IHRoaXMuZ2V0T3BlcmF0aW9uKG9wKTtcbiAgICBpZiAob3BlcmF0aW9uICYmIG9wZXJhdGlvbi5maWxlKSB7XG4gICAgICBjb25zdCB7IGZpbGUgfSA9IG9wZXJhdGlvbjtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGJpbmFyeUlkID0gdGhpcy5pbnZlbnRvcnlCaW5hcnkuZ2V0SWRGcm9tVXJsKGZpbGUpO1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmludmVudG9yeUJpbmFyeS5kZWxldGUoYmluYXJ5SWQpO1xuICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgdGhpcy5kZWxldGVEaWFnbm9zdGljc0ZyYWdtZW50KG9wKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGlmIChlcnIucmVzLnN0YXR1cyA9PT0gNDA0KSB7XG4gICAgICAgICAgLy8gSW4gY2FzZSB0aGUgZmlsZSBpcyBhbHJlYWR5IGRlbGV0ZWQgdmlhIG90aGVyIG1lYW5zIHdlIHdhbnQgdG8gZGVsZXRlIHRoZSBmcmFnbWVudFxuICAgICAgICAgIHRoaXMuZGVsZXRlRGlhZ25vc3RpY3NGcmFnbWVudChvcCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgbXNnID0gZ2V0dGV4dCgnQ291bGQgbm90IGRlbGV0ZSB0aGUgZGlhZ25vc3RpYyBmaWxlLicpO1xuICAgICAgICAgIHRoaXMuYWxlcnRTZXJ2aWNlLmRhbmdlcihtc2cpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBkZWxldGVEaWFnbm9zdGljc0ZyYWdtZW50KG9wOiBJT3BlcmF0aW9uKSB7XG4gICAgY29uc3QgZGVsZXRlT3AgPSB7XG4gICAgICBpZDogb3AuaWQsXG4gICAgICBzdGF0dXM6IG9wLnN0YXR1cyxcbiAgICAgIFt0aGlzLmZyYWdtZW50XTogbnVsbFxuICAgIH07XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG9wZXJhdGlvbkFmdGVyVXBkYXRlID0gKGF3YWl0IHRoaXMub3BlcmF0aW9uU2VydmljZS51cGRhdGUoZGVsZXRlT3ApKS5kYXRhO1xuICAgICAgYXNzaWduKG9wLCBvcGVyYXRpb25BZnRlclVwZGF0ZSk7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5zdWNjZXNzKGdldHRleHQoJ0RpYWdub3N0aWMgZmlsZSBkZWxldGVkLicpKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShlcnJvcik7XG4gICAgfVxuICB9XG59XG4iXX0=