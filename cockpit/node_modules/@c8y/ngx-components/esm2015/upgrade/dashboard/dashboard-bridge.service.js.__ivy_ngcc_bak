import { __awaiter } from "tslib";
import { Injectable, NgZone } from '@angular/core';
import { Router } from '@angular/router';
import { ActionBarService, getActivatedRoute } from '@c8y/ngx-components';
import { ContextDashboardService } from '@c8y/ngx-components/context-dashboard';
import { gettext } from '@c8y/ngx-components';
import { get } from 'lodash-es';
export class DashboardBridgeService {
    constructor(ng1Injector, zone, router, contextDashboardService, actionBarService) {
        this.ng1Injector = ng1Injector;
        this.zone = zone;
        this.router = router;
        this.contextDashboardService = contextDashboardService;
        this.actionBarService = actionBarService;
        this.dashboardSvc = ng1Injector.get('dashboardSvc');
        this.compile = ng1Injector.get('$compile');
    }
    get ng1Components() {
        return this.ng1Injector.get('c8yComponents');
    }
    instantiateComponent(widget, element) {
        return __awaiter(this, void 0, void 0, function* () {
            const { dashboard, context, child } = widget;
            if (dashboard) {
                const transformedChild = yield this.dashboardSvc.transformChildWithContext(this.dashboardSvc.forcedContext || context, dashboard, child);
                if (this.dashboardSvc.forcedContext || dashboard.deviceType || dashboard.updateTarget) {
                    yield this.dashboardSvc.updateConfigTargetsWithContext(this.dashboardSvc.forcedContext || context, transformedChild.config);
                }
                return this.zone.runOutsideAngular(() => this.loadTemplate(transformedChild, child, element, context));
            }
            else {
                return this.loadConfigTemplate(element, widget);
            }
        });
    }
    editDashboard(dashboard) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.dashboardSvc.editCurrentDashboard({ dashboardId: dashboard.id });
        });
    }
    copyDashboard() {
        const dashboard = this.getDashboard();
        const couldCopy = this.dashboardSvc.copyDashboard(dashboard.c8y_Dashboard);
        if (couldCopy) {
            this.dashboardClipboard = dashboard;
            this.actionBarService.refresh();
            return dashboard;
        }
    }
    pasteDashboard() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const newDashboard = yield this.dashboardSvc.pasteDashboard();
                this.navigateToDashboard(newDashboard);
                this.dashboardClipboard = undefined;
            }
            catch (ex) {
                // intended empty
            }
            this.actionBarService.refresh();
        });
    }
    instantiateDeviceSelector(element, widgetConfig) {
        return this.loadConfigTemplate(element, widgetConfig, true);
    }
    loadTemplate(transformedChild, child, element, context) {
        const scope = this.ng1Injector.get('$rootScope').$new(true);
        scope.child = transformedChild;
        scope.dashboardContext = context;
        if (child.widgetComponent) {
            element.innerHTML = `<c8y-ui-component component-name="'${child.widgetComponent}'" config="child.config" context="dashboardContext"></c8y-ui-component>`;
        }
        else if (child.templateUrl) {
            element.innerHTML = `<ng-include src="'${child.templateUrl}'"></ng-include>`;
        }
        this.compile(element)(scope);
        return scope;
    }
    navigateToDashboard(dashboard) {
        if (/dashboard/.test(this.router.url)) {
            this.router.navigate(['..', dashboard.id], {
                relativeTo: getActivatedRoute(this.router)
            });
        }
        else {
            this.router.navigate(['..', 'dashboard', dashboard.id], {
                relativeTo: getActivatedRoute(this.router)
            });
        }
    }
    getDashboard() {
        return getActivatedRoute(this.router).snapshot.data.dashboard;
    }
    loadConfigTemplate(element, widgetConfig, onlyDeviceSelector = false) {
        const { settings } = widgetConfig;
        const scope = this.ng1Injector.get('$rootScope').$new(true);
        scope.settings = Object.assign(Object.assign({}, settings), settings.ng1);
        scope.options = widgetConfig.options;
        scope.config = widgetConfig;
        scope.forms = {};
        scope.rootId = settings.context.id;
        scope.dashboard = get(widgetConfig, 'settings.dashboardMo');
        let configCmp = '';
        if (!onlyDeviceSelector) {
            if (widgetConfig.settings.configComponent) {
                configCmp = `<c8y-ui-component component-name="'${widgetConfig.settings.configComponent}'" config="config"></c8y-ui-component>`;
            }
            else if (widgetConfig.settings.configTemplateUrl) {
                configCmp = `<ng-include src="'${widgetConfig.settings.configTemplateUrl}'"></ng-include>`;
            }
        }
        element.innerHTML = `
    <ng-form name="forms.componentForm">
      <div class="form-group"
        ng-if="!settings.noDeviceTarget"
        ng-style="{height: settings.hideTarget && '0', overflow: 'hidden'}"
      >
        <label translate>${gettext('Target assets or devices')}</label>
        <c8y-device-selector-combo parent="rootId"
          selected-child-device="config.device"
          groups-selectable="settings.groupsSelectable"
          select-required="!settings.deviceTargetNotRequired"
        ></c8y-device-selector-combo>
      </div>
      ${configCmp}
    </ng-form>`;
        scope.$watch('forms.componentForm.$invalid', formStatus => {
            this.contextDashboardService.formDisabled = formStatus;
        });
        this.compile(element)(scope);
        this.contextDashboardService.formDisabled = scope.forms.componentForm.$invalid;
        return scope;
    }
}
DashboardBridgeService.decorators = [
    { type: Injectable }
];
DashboardBridgeService.ctorParameters = () => [
    { type: undefined },
    { type: NgZone },
    { type: Router },
    { type: ContextDashboardService },
    { type: ActionBarService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGJvYXJkLWJyaWRnZS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vdXBncmFkZS9kYXNoYm9hcmQvZGFzaGJvYXJkLWJyaWRnZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDekMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGlCQUFpQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDMUUsT0FBTyxFQUNMLHVCQUF1QixFQUd4QixNQUFNLHVDQUF1QyxDQUFDO0FBQy9DLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUM5QyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBR2hDLE1BQU0sT0FBTyxzQkFBc0I7SUFLakMsWUFDVSxXQUFnQixFQUNoQixJQUFZLEVBQ1osTUFBYyxFQUNkLHVCQUFnRCxFQUNoRCxnQkFBa0M7UUFKbEMsZ0JBQVcsR0FBWCxXQUFXLENBQUs7UUFDaEIsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUNaLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXlCO1FBQ2hELHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFFMUMsSUFBSSxDQUFDLFlBQVksR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxPQUFPLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsSUFBSSxhQUFhO1FBQ2YsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRUssb0JBQW9CLENBQUMs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QUFNO1lBR2IsdUJBQXVCO1lBRmhCLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IEFjdGlvbkJhclNlcnZpY2UsIGdldEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQge1xuICBDb250ZXh0RGFzaGJvYXJkU2VydmljZSxcbiAgQ29udGV4dERhc2hib2FyZE1hbmFnZWRPYmplY3QsXG4gIENvbnRleHRXaWRnZXRDb25maWdcbn0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9jb250ZXh0LWRhc2hib2FyZCc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBnZXQgfSBmcm9tICdsb2Rhc2gtZXMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRGFzaGJvYXJkQnJpZGdlU2VydmljZSB7XG4gIGRhc2hib2FyZFN2YztcbiAgY29tcGlsZTtcbiAgZGFzaGJvYXJkQ2xpcGJvYXJkO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbmcxSW5qZWN0b3I6IGFueSxcbiAgICBwcml2YXRlIHpvbmU6IE5nWm9uZSxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgY29udGV4dERhc2hib2FyZFNlcnZpY2U6IENvbnRleHREYXNoYm9hcmRTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWN0aW9uQmFyU2VydmljZTogQWN0aW9uQmFyU2VydmljZVxuICApIHtcbiAgICB0aGlzLmRhc2hib2FyZFN2YyA9IG5nMUluamVjdG9yLmdldCgnZGFzaGJvYXJkU3ZjJyk7XG4gICAgdGhpcy5jb21waWxlID0gbmcxSW5qZWN0b3IuZ2V0KCckY29tcGlsZScpO1xuICB9XG5cbiAgZ2V0IG5nMUNvbXBvbmVudHMoKSB7XG4gICAgcmV0dXJuIHRoaXMubmcxSW5qZWN0b3IuZ2V0KCdjOHlDb21wb25lbnRzJyk7XG4gIH1cblxuICBhc3luYyBpbnN0YW50aWF0ZUNvbXBvbmVudCh3aWRnZXQsIGVsZW1lbnQpIHtcbiAgICBjb25zdCB7IGRhc2hib2FyZCwgY29udGV4dCwgY2hpbGQgfSA9IHdpZGdldDtcbiAgICBpZiAoZGFzaGJvYXJkKSB7XG4gICAgICBjb25zdCB0cmFuc2Zvcm1lZENoaWxkID0gYXdhaXQgdGhpcy5kYXNoYm9hcmRTdmMudHJhbnNmb3JtQ2hpbGRXaXRoQ29udGV4dChcbiAgICAgICAgdGhpcy5kYXNoYm9hcmRTdmMuZm9yY2VkQ29udGV4dCB8fCBjb250ZXh0LFxuICAgICAgICBkYXNoYm9hcmQsXG4gICAgICAgIGNoaWxkXG4gICAgICApO1xuICAgICAgaWYgKHRoaXMuZGFzaGJvYXJkU3ZjLmZvcmNlZENvbnRleHQgfHwgZGFzaGJvYXJkLmRldmljZVR5cGUgfHwgZGFzaGJvYXJkLnVwZGF0ZVRhcmdldCkge1xuICAgICAgICBhd2FpdCB0aGlzLmRhc2hib2FyZFN2Yy51cGRhdGVDb25maWdUYXJnZXRzV2l0aENvbnRleHQoXG4gICAgICAgICAgdGhpcy5kYXNoYm9hcmRTdmMuZm9yY2VkQ29udGV4dCB8fCBjb250ZXh0LFxuICAgICAgICAgIHRyYW5zZm9ybWVkQ2hpbGQuY29uZmlnXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+XG4gICAgICAgIHRoaXMubG9hZFRlbXBsYXRlKHRyYW5zZm9ybWVkQ2hpbGQsIGNoaWxkLCBlbGVtZW50LCBjb250ZXh0KVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMubG9hZENvbmZpZ1RlbXBsYXRlKGVsZW1lbnQsIHdpZGdldCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZWRpdERhc2hib2FyZChkYXNoYm9hcmQpIHtcbiAgICByZXR1cm4gdGhpcy5kYXNoYm9hcmRTdmMuZWRpdEN1cnJlbnREYXNoYm9hcmQoeyBkYXNoYm9hcmRJZDogZGFzaGJvYXJkLmlkIH0pO1xuICB9XG5cbiAgY29weURhc2hib2FyZCgpIHtcbiAgICBjb25zdCBkYXNoYm9hcmQgPSB0aGlzLmdldERhc2hib2FyZCgpO1xuICAgIGNvbnN0IGNvdWxkQ29weSA9IHRoaXMuZGFzaGJvYXJkU3ZjLmNvcHlEYXNoYm9hcmQoZGFzaGJvYXJkLmM4eV9EYXNoYm9hcmQpO1xuICAgIGlmIChjb3VsZENvcHkpIHtcbiAgICAgIHRoaXMuZGFzaGJvYXJkQ2xpcGJvYXJkID0gZGFzaGJvYXJkO1xuICAgICAgdGhpcy5hY3Rpb25CYXJTZXJ2aWNlLnJlZnJlc2goKTtcbiAgICAgIHJldHVybiBkYXNoYm9hcmQ7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcGFzdGVEYXNoYm9hcmQoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG5ld0Rhc2hib2FyZCA9IGF3YWl0IHRoaXMuZGFzaGJvYXJkU3ZjLnBhc3RlRGFzaGJvYXJkKCk7XG4gICAgICB0aGlzLm5hdmlnYXRlVG9EYXNoYm9hcmQobmV3RGFzaGJvYXJkKTtcbiAgICAgIHRoaXMuZGFzaGJvYXJkQ2xpcGJvYXJkID0gdW5kZWZpbmVkO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAvLyBpbnRlbmRlZCBlbXB0eVxuICAgIH1cbiAgICB0aGlzLmFjdGlvbkJhclNlcnZpY2UucmVmcmVzaCgpO1xuICB9XG5cbiAgaW5zdGFudGlhdGVEZXZpY2VTZWxlY3RvcihlbGVtZW50LCB3aWRnZXRDb25maWc6IENvbnRleHRXaWRnZXRDb25maWcpIHtcbiAgICByZXR1cm4gdGhpcy5sb2FkQ29uZmlnVGVtcGxhdGUoZWxlbWVudCwgd2lkZ2V0Q29uZmlnLCB0cnVlKTtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZFRlbXBsYXRlKHRyYW5zZm9ybWVkQ2hpbGQsIGNoaWxkLCBlbGVtZW50LCBjb250ZXh0KSB7XG4gICAgY29uc3Qgc2NvcGUgPSB0aGlzLm5nMUluamVjdG9yLmdldCgnJHJvb3RTY29wZScpLiRuZXcodHJ1ZSk7XG4gICAgc2NvcGUuY2hpbGQgPSB0cmFuc2Zvcm1lZENoaWxkO1xuICAgIHNjb3BlLmRhc2hib2FyZENvbnRleHQgPSBjb250ZXh0O1xuICAgIGlmIChjaGlsZC53aWRnZXRDb21wb25lbnQpIHtcbiAgICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gYDxjOHktdWktY29tcG9uZW50IGNvbXBvbmVudC1uYW1lPVwiJyR7XG4gICAgICAgIGNoaWxkLndpZGdldENvbXBvbmVudFxuICAgICAgfSdcIiBjb25maWc9XCJjaGlsZC5jb25maWdcIiBjb250ZXh0PVwiZGFzaGJvYXJkQ29udGV4dFwiPjwvYzh5LXVpLWNvbXBvbmVudD5gO1xuICAgIH0gZWxzZSBpZiAoY2hpbGQudGVtcGxhdGVVcmwpIHtcbiAgICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gYDxuZy1pbmNsdWRlIHNyYz1cIicke2NoaWxkLnRlbXBsYXRlVXJsfSdcIj48L25nLWluY2x1ZGU+YDtcbiAgICB9XG4gICAgdGhpcy5jb21waWxlKGVsZW1lbnQpKHNjb3BlKTtcbiAgICByZXR1cm4gc2NvcGU7XG4gIH1cblxuICBwcml2YXRlIG5hdmlnYXRlVG9EYXNoYm9hcmQoZGFzaGJvYXJkOiBDb250ZXh0RGFzaGJvYXJkTWFuYWdlZE9iamVjdCkge1xuICAgIGlmICgvZGFzaGJvYXJkLy50ZXN0KHRoaXMucm91dGVyLnVybCkpIHtcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnLi4nLCBkYXNoYm9hcmQuaWRdLCB7XG4gICAgICAgIHJlbGF0aXZlVG86IGdldEFjdGl2YXRlZFJvdXRlKHRoaXMucm91dGVyKVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnLi4nLCAnZGFzaGJvYXJkJywgZGFzaGJvYXJkLmlkXSwge1xuICAgICAgICByZWxhdGl2ZVRvOiBnZXRBY3RpdmF0ZWRSb3V0ZSh0aGlzLnJvdXRlcilcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGFzaGJvYXJkKCkge1xuICAgIHJldHVybiBnZXRBY3RpdmF0ZWRSb3V0ZSh0aGlzLnJvdXRlcikuc25hcHNob3QuZGF0YS5kYXNoYm9hcmQ7XG4gIH1cblxuICBwcml2YXRlIGxvYWRDb25maWdUZW1wbGF0ZShcbiAgICBlbGVtZW50LFxuICAgIHdpZGdldENvbmZpZzogQ29udGV4dFdpZGdldENvbmZpZyxcbiAgICBvbmx5RGV2aWNlU2VsZWN0b3IgPSBmYWxzZVxuICApIHtcbiAgICBjb25zdCB7IHNldHRpbmdzIH0gPSB3aWRnZXRDb25maWc7XG4gICAgY29uc3Qgc2NvcGUgPSB0aGlzLm5nMUluamVjdG9yLmdldCgnJHJvb3RTY29wZScpLiRuZXcodHJ1ZSk7XG5cbiAgICBzY29wZS5zZXR0aW5ncyA9IHsgLi4uc2V0dGluZ3MsIC4uLnNldHRpbmdzLm5nMSB9O1xuICAgIHNjb3BlLm9wdGlvbnMgPSB3aWRnZXRDb25maWcub3B0aW9ucztcbiAgICBzY29wZS5jb25maWcgPSB3aWRnZXRDb25maWc7XG4gICAgc2NvcGUuZm9ybXMgPSB7fTtcbiAgICBzY29wZS5yb290SWQgPSBzZXR0aW5ncy5jb250ZXh0LmlkO1xuICAgIHNjb3BlLmRhc2hib2FyZCA9IGdldCh3aWRnZXRDb25maWcsICdzZXR0aW5ncy5kYXNoYm9hcmRNbycpO1xuXG4gICAgbGV0IGNvbmZpZ0NtcCA9ICcnO1xuICAgIGlmICghb25seURldmljZVNlbGVjdG9yKSB7XG4gICAgICBpZiAod2lkZ2V0Q29uZmlnLnNldHRpbmdzLmNvbmZpZ0NvbXBvbmVudCkge1xuICAgICAgICBjb25maWdDbXAgPSBgPGM4eS11aS1jb21wb25lbnQgY29tcG9uZW50LW5hbWU9XCInJHtcbiAgICAgICAgICB3aWRnZXRDb25maWcuc2V0dGluZ3MuY29uZmlnQ29tcG9uZW50XG4gICAgICAgIH0nXCIgY29uZmlnPVwiY29uZmlnXCI+PC9jOHktdWktY29tcG9uZW50PmA7XG4gICAgICB9IGVsc2UgaWYgKHdpZGdldENvbmZpZy5zZXR0aW5ncy5jb25maWdUZW1wbGF0ZVVybCkge1xuICAgICAgICBjb25maWdDbXAgPSBgPG5nLWluY2x1ZGUgc3JjPVwiJyR7d2lkZ2V0Q29uZmlnLnNldHRpbmdzLmNvbmZpZ1RlbXBsYXRlVXJsfSdcIj48L25nLWluY2x1ZGU+YDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBlbGVtZW50LmlubmVySFRNTCA9IGBcbiAgICA8bmctZm9ybSBuYW1lPVwiZm9ybXMuY29tcG9uZW50Rm9ybVwiPlxuICAgICAgPGRpdiBjbGFzcz1cImZvcm0tZ3JvdXBcIlxuICAgICAgICBuZy1pZj1cIiFzZXR0aW5ncy5ub0RldmljZVRhcmdldFwiXG4gICAgICAgIG5nLXN0eWxlPVwie2hlaWdodDogc2V0dGluZ3MuaGlkZVRhcmdldCAmJiAnMCcsIG92ZXJmbG93OiAnaGlkZGVuJ31cIlxuICAgICAgPlxuICAgICAgICA8bGFiZWwgdHJhbnNsYXRlPiR7Z2V0dGV4dCgnVGFyZ2V0IGFzc2V0cyBvciBkZXZpY2VzJyl9PC9sYWJlbD5cbiAgICAgICAgPGM4eS1kZXZpY2Utc2VsZWN0b3ItY29tYm8gcGFyZW50PVwicm9vdElkXCJcbiAgICAgICAgICBzZWxlY3RlZC1jaGlsZC1kZXZpY2U9XCJjb25maWcuZGV2aWNlXCJcbiAgICAgICAgICBncm91cHMtc2VsZWN0YWJsZT1cInNldHRpbmdzLmdyb3Vwc1NlbGVjdGFibGVcIlxuICAgICAgICAgIHNlbGVjdC1yZXF1aXJlZD1cIiFzZXR0aW5ncy5kZXZpY2VUYXJnZXROb3RSZXF1aXJlZFwiXG4gICAgICAgID48L2M4eS1kZXZpY2Utc2VsZWN0b3ItY29tYm8+XG4gICAgICA8L2Rpdj5cbiAgICAgICR7Y29uZmlnQ21wfVxuICAgIDwvbmctZm9ybT5gO1xuXG4gICAgc2NvcGUuJHdhdGNoKCdmb3Jtcy5jb21wb25lbnRGb3JtLiRpbnZhbGlkJywgZm9ybVN0YXR1cyA9PiB7XG4gICAgICB0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLmZvcm1EaXNhYmxlZCA9IGZvcm1TdGF0dXM7XG4gICAgfSk7XG4gICAgdGhpcy5jb21waWxlKGVsZW1lbnQpKHNjb3BlKTtcbiAgICB0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLmZvcm1EaXNhYmxlZCA9IHNjb3BlLmZvcm1zLmNvbXBvbmVudEZvcm0uJGludmFsaWQ7XG5cbiAgICByZXR1cm4gc2NvcGU7XG4gIH1cbn1cbiJdfQ==