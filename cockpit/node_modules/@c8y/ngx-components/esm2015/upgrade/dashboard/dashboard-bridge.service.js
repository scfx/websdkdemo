import { __awaiter } from "tslib";
import { Injectable, NgZone } from '@angular/core';
import { Router } from '@angular/router';
import { ActionBarService, getActivatedRoute } from '@c8y/ngx-components';
import { ContextDashboardService } from '@c8y/ngx-components/context-dashboard';
import { gettext } from '@c8y/ngx-components';
import { get } from 'lodash-es';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/router';
import * as ɵngcc2 from '@c8y/ngx-components/context-dashboard';
import * as ɵngcc3 from '@c8y/ngx-components';
export class DashboardBridgeService {
    constructor(ng1Injector, zone, router, contextDashboardService, actionBarService) {
        this.ng1Injector = ng1Injector;
        this.zone = zone;
        this.router = router;
        this.contextDashboardService = contextDashboardService;
        this.actionBarService = actionBarService;
        this.dashboardSvc = ng1Injector.get('dashboardSvc');
        this.compile = ng1Injector.get('$compile');
    }
    get ng1Components() {
        return this.ng1Injector.get('c8yComponents');
    }
    instantiateComponent(widget, element) {
        return __awaiter(this, void 0, void 0, function* () {
            const { dashboard, context, child } = widget;
            if (dashboard) {
                const transformedChild = yield this.dashboardSvc.transformChildWithContext(this.dashboardSvc.forcedContext || context, dashboard, child);
                if (this.dashboardSvc.forcedContext || dashboard.deviceType || dashboard.updateTarget) {
                    yield this.dashboardSvc.updateConfigTargetsWithContext(this.dashboardSvc.forcedContext || context, transformedChild.config);
                }
                return this.zone.runOutsideAngular(() => this.loadTemplate(transformedChild, child, element, context));
            }
            else {
                return this.loadConfigTemplate(element, widget);
            }
        });
    }
    editDashboard(dashboard) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.dashboardSvc.editCurrentDashboard({ dashboardId: dashboard.id });
        });
    }
    copyDashboard() {
        const dashboard = this.getDashboard();
        const couldCopy = this.dashboardSvc.copyDashboard(dashboard.c8y_Dashboard);
        if (couldCopy) {
            this.dashboardClipboard = dashboard;
            this.actionBarService.refresh();
            return dashboard;
        }
    }
    pasteDashboard() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const newDashboard = yield this.dashboardSvc.pasteDashboard();
                this.navigateToDashboard(newDashboard);
                this.dashboardClipboard = undefined;
            }
            catch (ex) {
                // intended empty
            }
            this.actionBarService.refresh();
        });
    }
    instantiateDeviceSelector(element, widgetConfig) {
        return this.loadConfigTemplate(element, widgetConfig, true);
    }
    loadTemplate(transformedChild, child, element, context) {
        const scope = this.ng1Injector.get('$rootScope').$new(true);
        scope.child = transformedChild;
        scope.dashboardContext = context;
        if (child.widgetComponent) {
            element.innerHTML = `<c8y-ui-component component-name="'${child.widgetComponent}'" config="child.config" context="dashboardContext"></c8y-ui-component>`;
        }
        else if (child.templateUrl) {
            element.innerHTML = `<ng-include src="'${child.templateUrl}'"></ng-include>`;
        }
        this.compile(element)(scope);
        return scope;
    }
    navigateToDashboard(dashboard) {
        if (/dashboard/.test(this.router.url)) {
            this.router.navigate(['..', dashboard.id], {
                relativeTo: getActivatedRoute(this.router)
            });
        }
        else {
            this.router.navigate(['..', 'dashboard', dashboard.id], {
                relativeTo: getActivatedRoute(this.router)
            });
        }
    }
    getDashboard() {
        return getActivatedRoute(this.router).snapshot.data.dashboard;
    }
    loadConfigTemplate(element, widgetConfig, onlyDeviceSelector = false) {
        const { settings } = widgetConfig;
        const scope = this.ng1Injector.get('$rootScope').$new(true);
        scope.settings = Object.assign(Object.assign({}, settings), settings.ng1);
        scope.options = widgetConfig.options;
        scope.config = widgetConfig;
        scope.forms = {};
        scope.rootId = settings.context.id;
        scope.dashboard = get(widgetConfig, 'settings.dashboardMo');
        let configCmp = '';
        if (!onlyDeviceSelector) {
            if (widgetConfig.settings.configComponent) {
                configCmp = `<c8y-ui-component component-name="'${widgetConfig.settings.configComponent}'" config="config"></c8y-ui-component>`;
            }
            else if (widgetConfig.settings.configTemplateUrl) {
                configCmp = `<ng-include src="'${widgetConfig.settings.configTemplateUrl}'"></ng-include>`;
            }
        }
        element.innerHTML = `
    <ng-form name="forms.componentForm">
      <div class="form-group"
        ng-if="!settings.noDeviceTarget"
        ng-style="{height: settings.hideTarget && '0', overflow: 'hidden'}"
      >
        <label translate>${gettext('Target assets or devices')}</label>
        <c8y-device-selector-combo parent="rootId"
          selected-child-device="config.device"
          groups-selectable="settings.groupsSelectable"
          select-required="!settings.deviceTargetNotRequired"
        ></c8y-device-selector-combo>
      </div>
      ${configCmp}
    </ng-form>`;
        scope.$watch('forms.componentForm.$invalid', formStatus => {
            this.contextDashboardService.formDisabled = formStatus;
        });
        this.compile(element)(scope);
        this.contextDashboardService.formDisabled = scope.forms.componentForm.$invalid;
        return scope;
    }
}
DashboardBridgeService.ɵfac = function DashboardBridgeService_Factory(t) { return new (t || DashboardBridgeService)(ɵngcc0.ɵɵinject(undefined), ɵngcc0.ɵɵinject(ɵngcc0.NgZone), ɵngcc0.ɵɵinject(ɵngcc1.Router), ɵngcc0.ɵɵinject(ɵngcc2.ContextDashboardService), ɵngcc0.ɵɵinject(ɵngcc3.ActionBarService)); };
DashboardBridgeService.ɵprov = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjectable({ token: DashboardBridgeService, factory: DashboardBridgeService.ɵfac });
DashboardBridgeService.ctorParameters = () => [
    { type: undefined },
    { type: NgZone },
    { type: Router },
    { type: ContextDashboardService },
    { type: ActionBarService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(DashboardBridgeService, [{
        type: Injectable
    }], function () { return [{ type: undefined }, { type: ɵngcc0.NgZone }, { type: ɵngcc1.Router }, { type: ɵngcc2.ContextDashboardService }, { type: ɵngcc3.ActionBarService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGJvYXJkLWJyaWRnZS5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi91cGdyYWRlL2Rhc2hib2FyZC9kYXNoYm9hcmQtYnJpZGdlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUMxRSxPQUFPLEVBQ0wsdUJBQXVCLEVBR3hCLE1BQU0sdUNBQXVDLENBQUM7QUFDL0MsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxXQUFXLENBQUM7Ozs7O0FBR2hDLE1BQU0sT0FBTyxzQkFBc0I7QUFDbkMsSUFJRSxZQUNVLFdBQWdCLEVBQ2hCLElBQVksRUFDWixNQUFjLEVBQ2QsdUJBQWdELEVBQ2hELGdCQUFrQztBQUMzQyxRQUxTLGdCQUFXLEdBQVgsV0FBVyxDQUFLO0FBQUMsUUFDakIsU0FBSSxHQUFKLElBQUksQ0FBUTtBQUFDLFFBQ2IsV0FBTSxHQUFOLE1BQU0sQ0FBUTtBQUFDLFFBQ2YsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUF5QjtBQUFDLFFBQ2pELHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7QUFDOUMsUUFDSSxJQUFJLENBQUMsWUFBWSxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDeEQsUUFBSSxJQUFJLENBQUMsT0FBTyxHQUFHLFdBQVcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDL0MsSUFBRSxDQUFDO0FBQ0gsSUFDRSxJQUFJLGFBQWE7QUFDbkIsUUFBSSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFD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Q0FBQyxpQkFBaUIsRUFBRTtBQUMxRCxnQkFBUSxTQUFTLEdBQUcscUJBQXFCLFlBQVksQ0FBQyxRQUFRLENBQUMsaUJBQWlCLGtCQUFrQixDQUFDO0FBQ25HLGFBQU87QUFDUCxTQUFLO0FBQ0wsUUFDSSxPQUFPLENBQUMsU0FBUyxHQUFHO0FBQ3hCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQkFBMkIsT0FBTyxDQUFDLDBCQUEwQixDQUFDO0FBQzlEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFFBQVEsU0FBUztBQUNqQixlQUFlLENBQUM7QUFDaEIsUUFDSSxLQUFLLENBQUMsTUFBTSxDQUFDLDhCQUE4QixFQUFFLFVBQVUsQ0FBQyxFQUFFO0FBQzlELFlBQU0sSUFBSSxDQUFDLHVCQUF1QixDQUFDLFlBQVksR0FBRyxVQUFVLENBQUM7QUFDN0QsUUFBSSxDQUFDLENBQUMsQ0FBQztBQUNQLFFBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUNqQyxRQUFJLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDO0FBQ25GLFFBQ0ksT0FBTyxLQUFLLENBQUM7QUFDakIsSUFBRSxDQUFDO0FBQ0g7a0RBekpDLFVBQVU7Z0pBQ1Q7QUFBQztBQUNVO0FBRUYsWUFmVSxNQUFNO0FBQUksWUFDdEIsTUFBTTtBQUFJLFlBR2pCLHVCQUF1QjtBQUN2QixZQUhPLGdCQUFnQjtBQUFHOzs7a01BQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IEFjdGlvbkJhclNlcnZpY2UsIGdldEFjdGl2YXRlZFJvdXRlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQge1xuICBDb250ZXh0RGFzaGJvYXJkU2VydmljZSxcbiAgQ29udGV4dERhc2hib2FyZE1hbmFnZWRPYmplY3QsXG4gIENvbnRleHRXaWRnZXRDb25maWdcbn0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9jb250ZXh0LWRhc2hib2FyZCc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBnZXQgfSBmcm9tICdsb2Rhc2gtZXMnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgRGFzaGJvYXJkQnJpZGdlU2VydmljZSB7XG4gIGRhc2hib2FyZFN2YztcbiAgY29tcGlsZTtcbiAgZGFzaGJvYXJkQ2xpcGJvYXJkO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgbmcxSW5qZWN0b3I6IGFueSxcbiAgICBwcml2YXRlIHpvbmU6IE5nWm9uZSxcbiAgICBwcml2YXRlIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgY29udGV4dERhc2hib2FyZFNlcnZpY2U6IENvbnRleHREYXNoYm9hcmRTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWN0aW9uQmFyU2VydmljZTogQWN0aW9uQmFyU2VydmljZVxuICApIHtcbiAgICB0aGlzLmRhc2hib2FyZFN2YyA9IG5nMUluamVjdG9yLmdldCgnZGFzaGJvYXJkU3ZjJyk7XG4gICAgdGhpcy5jb21waWxlID0gbmcxSW5qZWN0b3IuZ2V0KCckY29tcGlsZScpO1xuICB9XG5cbiAgZ2V0IG5nMUNvbXBvbmVudHMoKSB7XG4gICAgcmV0dXJuIHRoaXMubmcxSW5qZWN0b3IuZ2V0KCdjOHlDb21wb25lbnRzJyk7XG4gIH1cblxuICBhc3luYyBpbnN0YW50aWF0ZUNvbXBvbmVudCh3aWRnZXQsIGVsZW1lbnQpIHtcbiAgICBjb25zdCB7IGRhc2hib2FyZCwgY29udGV4dCwgY2hpbGQgfSA9IHdpZGdldDtcbiAgICBpZiAoZGFzaGJvYXJkKSB7XG4gICAgICBjb25zdCB0cmFuc2Zvcm1lZENoaWxkID0gYXdhaXQgdGhpcy5kYXNoYm9hcmRTdmMudHJhbnNmb3JtQ2hpbGRXaXRoQ29udGV4dChcbiAgICAgICAgdGhpcy5kYXNoYm9hcmRTdmMuZm9yY2VkQ29udGV4dCB8fCBjb250ZXh0LFxuICAgICAgICBkYXNoYm9hcmQsXG4gICAgICAgIGNoaWxkXG4gICAgICApO1xuICAgICAgaWYgKHRoaXMuZGFzaGJvYXJkU3ZjLmZvcmNlZENvbnRleHQgfHwgZGFzaGJvYXJkLmRldmljZVR5cGUgfHwgZGFzaGJvYXJkLnVwZGF0ZVRhcmdldCkge1xuICAgICAgICBhd2FpdCB0aGlzLmRhc2hib2FyZFN2Yy51cGRhdGVDb25maWdUYXJnZXRzV2l0aENvbnRleHQoXG4gICAgICAgICAgdGhpcy5kYXNoYm9hcmRTdmMuZm9yY2VkQ29udGV4dCB8fCBjb250ZXh0LFxuICAgICAgICAgIHRyYW5zZm9ybWVkQ2hpbGQuY29uZmlnXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+XG4gICAgICAgIHRoaXMubG9hZFRlbXBsYXRlKHRyYW5zZm9ybWVkQ2hpbGQsIGNoaWxkLCBlbGVtZW50LCBjb250ZXh0KVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMubG9hZENvbmZpZ1RlbXBsYXRlKGVsZW1lbnQsIHdpZGdldCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZWRpdERhc2hib2FyZChkYXNoYm9hcmQpIHtcbiAgICByZXR1cm4gdGhpcy5kYXNoYm9hcmRTdmMuZWRpdEN1cnJlbnREYXNoYm9hcmQoeyBkYXNoYm9hcmRJZDogZGFzaGJvYXJkLmlkIH0pO1xuICB9XG5cbiAgY29weURhc2hib2FyZCgpIHtcbiAgICBjb25zdCBkYXNoYm9hcmQgPSB0aGlzLmdldERhc2hib2FyZCgpO1xuICAgIGNvbnN0IGNvdWxkQ29weSA9IHRoaXMuZGFzaGJvYXJkU3ZjLmNvcHlEYXNoYm9hcmQoZGFzaGJvYXJkLmM4eV9EYXNoYm9hcmQpO1xuICAgIGlmIChjb3VsZENvcHkpIHtcbiAgICAgIHRoaXMuZGFzaGJvYXJkQ2xpcGJvYXJkID0gZGFzaGJvYXJkO1xuICAgICAgdGhpcy5hY3Rpb25CYXJTZXJ2aWNlLnJlZnJlc2goKTtcbiAgICAgIHJldHVybiBkYXNoYm9hcmQ7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcGFzdGVEYXNoYm9hcmQoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG5ld0Rhc2hib2FyZCA9IGF3YWl0IHRoaXMuZGFzaGJvYXJkU3ZjLnBhc3RlRGFzaGJvYXJkKCk7XG4gICAgICB0aGlzLm5hdmlnYXRlVG9EYXNoYm9hcmQobmV3RGFzaGJvYXJkKTtcbiAgICAgIHRoaXMuZGFzaGJvYXJkQ2xpcGJvYXJkID0gdW5kZWZpbmVkO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICAvLyBpbnRlbmRlZCBlbXB0eVxuICAgIH1cbiAgICB0aGlzLmFjdGlvbkJhclNlcnZpY2UucmVmcmVzaCgpO1xuICB9XG5cbiAgaW5zdGFudGlhdGVEZXZpY2VTZWxlY3RvcihlbGVtZW50LCB3aWRnZXRDb25maWc6IENvbnRleHRXaWRnZXRDb25maWcpIHtcbiAgICByZXR1cm4gdGhpcy5sb2FkQ29uZmlnVGVtcGxhdGUoZWxlbWVudCwgd2lkZ2V0Q29uZmlnLCB0cnVlKTtcbiAgfVxuXG4gIHByaXZhdGUgbG9hZFRlbXBsYXRlKHRyYW5zZm9ybWVkQ2hpbGQsIGNoaWxkLCBlbGVtZW50LCBjb250ZXh0KSB7XG4gICAgY29uc3Qgc2NvcGUgPSB0aGlzLm5nMUluamVjdG9yLmdldCgnJHJvb3RTY29wZScpLiRuZXcodHJ1ZSk7XG4gICAgc2NvcGUuY2hpbGQgPSB0cmFuc2Zvcm1lZENoaWxkO1xuICAgIHNjb3BlLmRhc2hib2FyZENvbnRleHQgPSBjb250ZXh0O1xuICAgIGlmIChjaGlsZC53aWRnZXRDb21wb25lbnQpIHtcbiAgICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gYDxjOHktdWktY29tcG9uZW50IGNvbXBvbmVudC1uYW1lPVwiJyR7XG4gICAgICAgIGNoaWxkLndpZGdldENvbXBvbmVudFxuICAgICAgfSdcIiBjb25maWc9XCJjaGlsZC5jb25maWdcIiBjb250ZXh0PVwiZGFzaGJvYXJkQ29udGV4dFwiPjwvYzh5LXVpLWNvbXBvbmVudD5gO1xuICAgIH0gZWxzZSBpZiAoY2hpbGQudGVtcGxhdGVVcmwpIHtcbiAgICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gYDxuZy1pbmNsdWRlIHNyYz1cIicke2NoaWxkLnRlbXBsYXRlVXJsfSdcIj48L25nLWluY2x1ZGU+YDtcbiAgICB9XG4gICAgdGhpcy5jb21waWxlKGVsZW1lbnQpKHNjb3BlKTtcbiAgICByZXR1cm4gc2NvcGU7XG4gIH1cblxuICBwcml2YXRlIG5hdmlnYXRlVG9EYXNoYm9hcmQoZGFzaGJvYXJkOiBDb250ZXh0RGFzaGJvYXJkTWFuYWdlZE9iamVjdCkge1xuICAgIGlmICgvZGFzaGJvYXJkLy50ZXN0KHRoaXMucm91dGVyLnVybCkpIHtcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnLi4nLCBkYXNoYm9hcmQuaWRdLCB7XG4gICAgICAgIHJlbGF0aXZlVG86IGdldEFjdGl2YXRlZFJvdXRlKHRoaXMucm91dGVyKVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucm91dGVyLm5hdmlnYXRlKFsnLi4nLCAnZGFzaGJvYXJkJywgZGFzaGJvYXJkLmlkXSwge1xuICAgICAgICByZWxhdGl2ZVRvOiBnZXRBY3RpdmF0ZWRSb3V0ZSh0aGlzLnJvdXRlcilcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGFzaGJvYXJkKCkge1xuICAgIHJldHVybiBnZXRBY3RpdmF0ZWRSb3V0ZSh0aGlzLnJvdXRlcikuc25hcHNob3QuZGF0YS5kYXNoYm9hcmQ7XG4gIH1cblxuICBwcml2YXRlIGxvYWRDb25maWdUZW1wbGF0ZShcbiAgICBlbGVtZW50LFxuICAgIHdpZGdldENvbmZpZzogQ29udGV4dFdpZGdldENvbmZpZyxcbiAgICBvbmx5RGV2aWNlU2VsZWN0b3IgPSBmYWxzZVxuICApIHtcbiAgICBjb25zdCB7IHNldHRpbmdzIH0gPSB3aWRnZXRDb25maWc7XG4gICAgY29uc3Qgc2NvcGUgPSB0aGlzLm5nMUluamVjdG9yLmdldCgnJHJvb3RTY29wZScpLiRuZXcodHJ1ZSk7XG5cbiAgICBzY29wZS5zZXR0aW5ncyA9IHsgLi4uc2V0dGluZ3MsIC4uLnNldHRpbmdzLm5nMSB9O1xuICAgIHNjb3BlLm9wdGlvbnMgPSB3aWRnZXRDb25maWcub3B0aW9ucztcbiAgICBzY29wZS5jb25maWcgPSB3aWRnZXRDb25maWc7XG4gICAgc2NvcGUuZm9ybXMgPSB7fTtcbiAgICBzY29wZS5yb290SWQgPSBzZXR0aW5ncy5jb250ZXh0LmlkO1xuICAgIHNjb3BlLmRhc2hib2FyZCA9IGdldCh3aWRnZXRDb25maWcsICdzZXR0aW5ncy5kYXNoYm9hcmRNbycpO1xuXG4gICAgbGV0IGNvbmZpZ0NtcCA9ICcnO1xuICAgIGlmICghb25seURldmljZVNlbGVjdG9yKSB7XG4gICAgICBpZiAod2lkZ2V0Q29uZmlnLnNldHRpbmdzLmNvbmZpZ0NvbXBvbmVudCkge1xuICAgICAgICBjb25maWdDbXAgPSBgPGM4eS11aS1jb21wb25lbnQgY29tcG9uZW50LW5hbWU9XCInJHtcbiAgICAgICAgICB3aWRnZXRDb25maWcuc2V0dGluZ3MuY29uZmlnQ29tcG9uZW50XG4gICAgICAgIH0nXCIgY29uZmlnPVwiY29uZmlnXCI+PC9jOHktdWktY29tcG9uZW50PmA7XG4gICAgICB9IGVsc2UgaWYgKHdpZGdldENvbmZpZy5zZXR0aW5ncy5jb25maWdUZW1wbGF0ZVVybCkge1xuICAgICAgICBjb25maWdDbXAgPSBgPG5nLWluY2x1ZGUgc3JjPVwiJyR7d2lkZ2V0Q29uZmlnLnNldHRpbmdzLmNvbmZpZ1RlbXBsYXRlVXJsfSdcIj48L25nLWluY2x1ZGU+YDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBlbGVtZW50LmlubmVySFRNTCA9IGBcbiAgICA8bmctZm9ybSBuYW1lPVwiZm9ybXMuY29tcG9uZW50Rm9ybVwiPlxuICAgICAgPGRpdiBjbGFzcz1cImZvcm0tZ3JvdXBcIlxuICAgICAgICBuZy1pZj1cIiFzZXR0aW5ncy5ub0RldmljZVRhcmdldFwiXG4gICAgICAgIG5nLXN0eWxlPVwie2hlaWdodDogc2V0dGluZ3MuaGlkZVRhcmdldCAmJiAnMCcsIG92ZXJmbG93OiAnaGlkZGVuJ31cIlxuICAgICAgPlxuICAgICAgICA8bGFiZWwgdHJhbnNsYXRlPiR7Z2V0dGV4dCgnVGFyZ2V0IGFzc2V0cyBvciBkZXZpY2VzJyl9PC9sYWJlbD5cbiAgICAgICAgPGM4eS1kZXZpY2Utc2VsZWN0b3ItY29tYm8gcGFyZW50PVwicm9vdElkXCJcbiAgICAgICAgICBzZWxlY3RlZC1jaGlsZC1kZXZpY2U9XCJjb25maWcuZGV2aWNlXCJcbiAgICAgICAgICBncm91cHMtc2VsZWN0YWJsZT1cInNldHRpbmdzLmdyb3Vwc1NlbGVjdGFibGVcIlxuICAgICAgICAgIHNlbGVjdC1yZXF1aXJlZD1cIiFzZXR0aW5ncy5kZXZpY2VUYXJnZXROb3RSZXF1aXJlZFwiXG4gICAgICAgID48L2M4eS1kZXZpY2Utc2VsZWN0b3ItY29tYm8+XG4gICAgICA8L2Rpdj5cbiAgICAgICR7Y29uZmlnQ21wfVxuICAgIDwvbmctZm9ybT5gO1xuXG4gICAgc2NvcGUuJHdhdGNoKCdmb3Jtcy5jb21wb25lbnRGb3JtLiRpbnZhbGlkJywgZm9ybVN0YXR1cyA9PiB7XG4gICAgICB0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLmZvcm1EaXNhYmxlZCA9IGZvcm1TdGF0dXM7XG4gICAgfSk7XG4gICAgdGhpcy5jb21waWxlKGVsZW1lbnQpKHNjb3BlKTtcbiAgICB0aGlzLmNvbnRleHREYXNoYm9hcmRTZXJ2aWNlLmZvcm1EaXNhYmxlZCA9IHNjb3BlLmZvcm1zLmNvbXBvbmVudEZvcm0uJGludmFsaWQ7XG5cbiAgICByZXR1cm4gc2NvcGU7XG4gIH1cbn1cbiJdfQ==