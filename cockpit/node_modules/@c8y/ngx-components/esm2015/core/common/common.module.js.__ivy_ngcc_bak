import { CommonModule as NgCommonModule } from '@angular/common';
import { APP_INITIALIZER, InjectionToken, NgModule } from '@angular/core';
import { DataModule } from '@c8y/ngx-components/api';
import { TooltipModule } from 'ngx-bootstrap/tooltip';
import { distinctUntilChanged, filter, map, startWith, switchMap } from 'rxjs/operators';
import { I18nModule } from '../i18n/i18n.module';
import { TranslateService } from '../i18n/translate.service';
import { DatePipe } from './date.pipe';
import { DropdownDirectionDirective } from './dropdown-direction.directive';
import { ForOfDirective } from './forOf.directive';
import { HumanizeAppNamePipe } from './humanize-app-name.pipe';
import { HumanizePipe } from './humanize.pipe';
import { IconDirective, ICONS } from './icon.directive';
import { IfAllowedDirective } from './if-allowed.directive';
import { LoadMoreComponent } from './load-more.component';
import { LoadingComponent } from './loading.component';
import { MapFunctionPipe } from './map-function.pipe';
import { NumberPipe } from './number.pipe';
import { HOOK_OPTIONS, OptionsService } from './options.service';
import { OutletDirective } from './outlet.directive';
import { Permissions } from './permissions.service';
import { ProgressBarComponent } from './progress-bar.component';
import { ShortenUserNamePipe } from './shorten-user-name.pipe';
import { TenantUiService } from './tenant-ui.service';
import { AppStateService } from './ui-state.service';
import { UserPreferencesService } from './user-preferences/user-preferences.service';
import { ZipService } from './zip.service';
import { TextareaAutoresizeDirective } from './textarea-autoresize.directive';
import { OperationResultComponent } from './operation-result.component';
import { VirtualScrollerWrapperComponent } from './virtual-scroll/virtual-scroller-wrapper.component';
import { ScrollingModule } from '@angular/cdk/scrolling';
import { VirtualScrollWindowDirective } from './virtual-scroll/virtual-scroll-window.directive';
export function initializeServices(translateService, state, userPreferences) {
    const initialize = () => {
        const queryStringLanguage = translateService.queryStringLang();
        const firstLanguage = translateService.firstSupportedLanguage();
        /*
          The ?lang parameter will prevent the user preference language from being activated
        */
        if (queryStringLanguage && translateService.getSupported(queryStringLanguage)) {
            translateService.switchToLanguage(queryStringLanguage);
        }
        else {
            state.currentUser
                .pipe(map(user => user && user.userName), filter(u => !!u), distinctUntilChanged(), switchMap(() => userPreferences.get('language')), startWith(firstLanguage), filter(lang => !!lang), distinctUntilChanged())
                .subscribe(lang => {
                translateService.switchToLanguage(lang);
            });
        }
    };
    return initialize;
}
export const ICON_LIST = new InjectionToken('iconList');
/**
 * Commonly used directives, data access and translation. This module is the shared
 * module across all core components. It should be imported by default.
 *
 * @exports IconDirective A directive to set a c8y icon with [c8yIcon]="'rocket'".
 * @exports OutletDirective A directive which allows to set DOM or Angular templates (used for upgrade).
 * @exports I18nModule Translation module.
 * @exports NgCommonModule Angular common module.
 * @exports DataModule The data layer to allow DI with @c8y/client
 * @exports HumanizeAppNamePipe Humanize an application name (e.g. in the app switcher)
 * @exports HumanizePipe Humanize a word. E.g. `device management` gets `Device management`
 * @exports ShortenUserNamePipe Allows a short name. E.g. `Foo Bar` gets `F. Bar`
 * @exports ForOfDirective A forOf directive like ngFor but with load-more function
 * @exports LoadMoreComponent A component to load more data from a certain data-source
 * @exports ProgressBarComponent Displays either defined or undefined progress.
 * @exports DropdownDirectionDirective Determines if a dropdown opens to the bottom or to the top.
 * @exports TextareaAutoresizeDirective resizes a textarea height as the user inputs.
 * @exports OperationResultComponent displays an animated svg for success and error operations.
 */
export class CommonModule {
    static providers() {
        return [
            ...DataModule.providers(),
            // TODO: maybe we can think of a way to remove this C8Y_APP global
            { provide: HOOK_OPTIONS, useValue: window.C8Y_APP || {}, multi: true },
            {
                provide: APP_INITIALIZER,
                useFactory: initializeServices,
                deps: [TranslateService, AppStateService, UserPreferencesService],
                multi: true
            },
            { provide: ICON_LIST, useValue: ICONS, multi: false },
            ...I18nModule.providers(),
            UserPreferencesService,
            OptionsService,
            AppStateService,
            Permissions,
            TenantUiService,
            HumanizePipe,
            HumanizeAppNamePipe,
            ShortenUserNamePipe,
            MapFunctionPipe,
            DatePipe,
            ZipService
        ];
    }
    static forRoot() {
        return {
            ngModule: CommonModule,
            providers: CommonModule.providers()
        };
    }
}
CommonModule.decorators = [
    { type: NgModule, args: [{
                imports: [NgCommonModule, I18nModule, TooltipModule, ScrollingModule],
                exports: [
                    IconDirective,
                    OutletDirective,
                    I18nModule,
                    NgCommonModule,
                    HumanizeAppNamePipe,
                    HumanizePipe,
                    IfAllowedDirective,
                    ShortenUserNamePipe,
                    ForOfDirective,
                    LoadMoreComponent,
                    MapFunctionPipe,
                    ProgressBarComponent,
                    DatePipe,
                    NumberPipe,
                    LoadingComponent,
                    DropdownDirectionDirective,
                    TextareaAutoresizeDirective,
                    OperationResultComponent,
                    VirtualScrollerWrapperComponent,
                    VirtualScrollWindowDirective
                ],
                declarations: [
                    IconDirective,
                    OutletDirective,
                    HumanizePipe,
                    HumanizeAppNamePipe,
                    IfAllowedDirective,
                    ShortenUserNamePipe,
                    ForOfDirective,
                    LoadMoreComponent,
                    MapFunctionPipe,
                    ProgressBarComponent,
                    DatePipe,
                    NumberPipe,
                    LoadingComponent,
                    DropdownDirectionDirective,
                    TextareaAutoresizeDirective,
                    OperationResultComponent,
                    VirtualScrollerWrapperComponent,
                    VirtualScrollWindowDirective
                ],
                entryComponents: [LoadMoreComponent, LoadingComponent, VirtualScrollerWrapperComponent]
            },] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbW9uLm1vZHVsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvY29tbW9uL2NvbW1vbi5tb2R1bGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksSUFBSSxjQUFjLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNqRSxPQUFPLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQ3JELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzdELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDdkMsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDNUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsYUFBYSxFQUFFLEtBQUssRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzVELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQzFELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFC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QUFtQjtvQkFDbkIsa0JBQWtCO29CQUNsQixtQkFBbUI7b0JBQ25CLGNBQWM7b0JBQ2QsaUJBQWlCO29CQUNqQixlQUFlO29CQUNmLG9CQUFvQjtvQkFDcEIsUUFBUTtvQkFDUixVQUFVO29CQUNWLGdCQUFnQjtvQkFDaEIsMEJBQTBCO29CQUMxQiwyQkFBMkI7b0JBQzNCLHdCQUF3QjtvQkFDeEIsK0JBQStCO29CQUMvQiw0QkFBNEI7aUJBQzdCO2dCQUNELGVBQWUsRUFBRSxDQUFDLGlCQUFpQixFQUFFLGdCQUFnQixFQUFFLCtCQUErQixDQUFDO2FBQ3hGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tbW9uTW9kdWxlIGFzIE5nQ29tbW9uTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IEFQUF9JTklUSUFMSVpFUiwgSW5qZWN0aW9uVG9rZW4sIE5nTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBEYXRhTW9kdWxlIH0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cy9hcGknO1xuaW1wb3J0IHsgVG9vbHRpcE1vZHVsZSB9IGZyb20gJ25neC1ib290c3RyYXAvdG9vbHRpcCc7XG5pbXBvcnQgeyBkaXN0aW5jdFVudGlsQ2hhbmdlZCwgZmlsdGVyLCBtYXAsIHN0YXJ0V2l0aCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgSTE4bk1vZHVsZSB9IGZyb20gJy4uL2kxOG4vaTE4bi5tb2R1bGUnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJy4uL2kxOG4vdHJhbnNsYXRlLnNlcnZpY2UnO1xuaW1wb3J0IHsgRGF0ZVBpcGUgfSBmcm9tICcuL2RhdGUucGlwZSc7XG5pbXBvcnQgeyBEcm9wZG93bkRpcmVjdGlvbkRpcmVjdGl2ZSB9IGZyb20gJy4vZHJvcGRvd24tZGlyZWN0aW9uLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBGb3JPZkRpcmVjdGl2ZSB9IGZyb20gJy4vZm9yT2YuZGlyZWN0aXZlJztcbmltcG9ydCB7IEh1bWFuaXplQXBwTmFtZVBpcGUgfSBmcm9tICcuL2h1bWFuaXplLWFwcC1uYW1lLnBpcGUnO1xuaW1wb3J0IHsgSHVtYW5pemVQaXBlIH0gZnJvbSAnLi9odW1hbml6ZS5waXBlJztcbmltcG9ydCB7IEljb25EaXJlY3RpdmUsIElDT05TIH0gZnJvbSAnLi9pY29uLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBJZkFsbG93ZWREaXJlY3RpdmUgfSBmcm9tICcuL2lmLWFsbG93ZWQuZGlyZWN0aXZlJztcbmltcG9ydCB7IExvYWRNb3JlQ29tcG9uZW50IH0gZnJvbSAnLi9sb2FkLW1vcmUuY29tcG9uZW50JztcbmltcG9ydCB7IExvYWRpbmdDb21wb25lbnQgfSBmcm9tICcuL2xvYWRpbmcuY29tcG9uZW50JztcbmltcG9ydCB7IE1hcEZ1bmN0aW9uUGlwZSB9IGZyb20gJy4vbWFwLWZ1bmN0aW9uLnBpcGUnO1xuaW1wb3J0IHsgTnVtYmVyUGlwZSB9IGZyb20gJy4vbnVtYmVyLnBpcGUnO1xuaW1wb3J0IHsgSE9PS19PUFRJT05TLCBPcHRpb25zU2VydmljZSB9IGZyb20gJy4vb3B0aW9ucy5zZXJ2aWNlJztcbmltcG9ydCB7IE91dGxldERpcmVjdGl2ZSB9IGZyb20gJy4vb3V0bGV0LmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBQZXJtaXNzaW9ucyB9IGZyb20gJy4vcGVybWlzc2lvbnMuc2VydmljZSc7XG5pbXBvcnQgeyBQcm9ncmVzc0JhckNvbXBvbmVudCB9IGZyb20gJy4vcHJvZ3Jlc3MtYmFyLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBTaG9ydGVuVXNlck5hbWVQaXBlIH0gZnJvbSAnLi9zaG9ydGVuLXVzZXItbmFtZS5waXBlJztcbmltcG9ydCB7IFRlbmFudFVpU2VydmljZSB9IGZyb20gJy4vdGVuYW50LXVpLnNlcnZpY2UnO1xuaW1wb3J0IHsgQXBwU3RhdGVTZXJ2aWNlIH0gZnJvbSAnLi91aS1zdGF0ZS5zZXJ2aWNlJztcbmltcG9ydCB7IFVzZXJQcmVmZXJlbmNlc1NlcnZpY2UgfSBmcm9tICcuL3VzZXItcHJlZmVyZW5jZXMvdXNlci1wcmVmZXJlbmNlcy5zZXJ2aWNlJztcbmltcG9ydCB7IFppcFNlcnZpY2UgfSBmcm9tICcuL3ppcC5zZXJ2aWNlJztcbmltcG9ydCB7IFRleHRhcmVhQXV0b3Jlc2l6ZURpcmVjdGl2ZSB9IGZyb20gJy4vdGV4dGFyZWEtYXV0b3Jlc2l6ZS5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgT3BlcmF0aW9uUmVzdWx0Q29tcG9uZW50IH0gZnJvbSAnLi9vcGVyYXRpb24tcmVzdWx0LmNvbXBvbmVudCc7XG5pbXBvcnQgeyBWaXJ0dWFsU2Nyb2xsZXJXcmFwcGVyQ29tcG9uZW50IH0gZnJvbSAnLi92aXJ0dWFsLXNjcm9sbC92aXJ0dWFsLXNjcm9sbGVyLXdyYXBwZXIuY29tcG9uZW50JztcbmltcG9ydCB7IFNjcm9sbGluZ01vZHVsZSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9zY3JvbGxpbmcnO1xuaW1wb3J0IHsgVmlydHVhbFNjcm9sbFdpbmRvd0RpcmVjdGl2ZSB9IGZyb20gJy4vdmlydHVhbC1zY3JvbGwvdmlydHVhbC1zY3JvbGwtd2luZG93LmRpcmVjdGl2ZSc7XG5cbmV4cG9ydCBmdW5jdGlvbiBpbml0aWFsaXplU2VydmljZXMoXG4gIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2UsXG4gIHN0YXRlOiBBcHBTdGF0ZVNlcnZpY2UsXG4gIHVzZXJQcmVmZXJlbmNlczogVXNlclByZWZlcmVuY2VzU2VydmljZVxuKSB7XG4gIGNvbnN0IGluaXRpYWxpemUgPSAoKSA9PiB7XG4gICAgY29uc3QgcXVlcnlTdHJpbmdMYW5ndWFnZSA9IHRyYW5zbGF0ZVNlcnZpY2UucXVlcnlTdHJpbmdMYW5nKCk7XG4gICAgY29uc3QgZmlyc3RMYW5ndWFnZSA9IHRyYW5zbGF0ZVNlcnZpY2UuZmlyc3RTdXBwb3J0ZWRMYW5ndWFnZSgpO1xuXG4gICAgLypcbiAgICAgIFRoZSA/bGFuZyBwYXJhbWV0ZXIgd2lsbCBwcmV2ZW50IHRoZSB1c2VyIHByZWZlcmVuY2UgbGFuZ3VhZ2UgZnJvbSBiZWluZyBhY3RpdmF0ZWRcbiAgICAqL1xuICAgIGlmIChxdWVyeVN0cmluZ0xhbmd1YWdlICYmIHRyYW5zbGF0ZVNlcnZpY2UuZ2V0U3VwcG9ydGVkKHF1ZXJ5U3RyaW5nTGFuZ3VhZ2UpKSB7XG4gICAgICB0cmFuc2xhdGVTZXJ2aWNlLnN3aXRjaFRvTGFuZ3VhZ2UocXVlcnlTdHJpbmdMYW5ndWFnZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN0YXRlLmN1cnJlbnRVc2VyXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIG1hcCh1c2VyID0+IHVzZXIgJiYgdXNlci51c2VyTmFtZSksXG4gICAgICAgICAgZmlsdGVyKHUgPT4gISF1KSxcbiAgICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiB1c2VyUHJlZmVyZW5jZXMuZ2V0KCdsYW5ndWFnZScpKSxcbiAgICAgICAgICBzdGFydFdpdGgoZmlyc3RMYW5ndWFnZSksXG4gICAgICAgICAgZmlsdGVyKGxhbmcgPT4gISFsYW5nKSxcbiAgICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpXG4gICAgICAgIClcbiAgICAgICAgLnN1YnNjcmliZShsYW5nID0+IHtcbiAgICAgICAgICB0cmFuc2xhdGVTZXJ2aWNlLnN3aXRjaFRvTGFuZ3VhZ2UobGFuZyk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgfTtcbiAgcmV0dXJuIGluaXRpYWxpemU7XG59XG5cbmV4cG9ydCBjb25zdCBJQ09OX0xJU1QgPSBuZXcgSW5qZWN0aW9uVG9rZW4oJ2ljb25MaXN0Jyk7XG5cbi8qKlxuICogQ29tbW9ubHkgdXNlZCBkaXJlY3RpdmVzLCBkYXRhIGFjY2VzcyBhbmQgdHJhbnNsYXRpb24uIFRoaXMgbW9kdWxlIGlzIHRoZSBzaGFyZWRcbiAqIG1vZHVsZSBhY3Jvc3MgYWxsIGNvcmUgY29tcG9uZW50cy4gSXQgc2hvdWxkIGJlIGltcG9ydGVkIGJ5IGRlZmF1bHQuXG4gKlxuICogQGV4cG9ydHMgSWNvbkRpcmVjdGl2ZSBBIGRpcmVjdGl2ZSB0byBzZXQgYSBjOHkgaWNvbiB3aXRoIFtjOHlJY29uXT1cIidyb2NrZXQnXCIuXG4gKiBAZXhwb3J0cyBPdXRsZXREaXJlY3RpdmUgQSBkaXJlY3RpdmUgd2hpY2ggYWxsb3dzIHRvIHNldCBET00gb3IgQW5ndWxhciB0ZW1wbGF0ZXMgKHVzZWQgZm9yIHVwZ3JhZGUpLlxuICogQGV4cG9ydHMgSTE4bk1vZHVsZSBUcmFuc2xhdGlvbiBtb2R1bGUuXG4gKiBAZXhwb3J0cyBOZ0NvbW1vbk1vZHVsZSBBbmd1bGFyIGNvbW1vbiBtb2R1bGUuXG4gKiBAZXhwb3J0cyBEYXRhTW9kdWxlIFRoZSBkYXRhIGxheWVyIHRvIGFsbG93IERJIHdpdGggQGM4eS9jbGllbnRcbiAqIEBleHBvcnRzIEh1bWFuaXplQXBwTmFtZVBpcGUgSHVtYW5pemUgYW4gYXBwbGljYXRpb24gbmFtZSAoZS5nLiBpbiB0aGUgYXBwIHN3aXRjaGVyKVxuICogQGV4cG9ydHMgSHVtYW5pemVQaXBlIEh1bWFuaXplIGEgd29yZC4gRS5nLiBgZGV2aWNlIG1hbmFnZW1lbnRgIGdldHMgYERldmljZSBtYW5hZ2VtZW50YFxuICogQGV4cG9ydHMgU2hvcnRlblVzZXJOYW1lUGlwZSBBbGxvd3MgYSBzaG9ydCBuYW1lLiBFLmcuIGBGb28gQmFyYCBnZXRzIGBGLiBCYXJgXG4gKiBAZXhwb3J0cyBGb3JPZkRpcmVjdGl2ZSBBIGZvck9mIGRpcmVjdGl2ZSBsaWtlIG5nRm9yIGJ1dCB3aXRoIGxvYWQtbW9yZSBmdW5jdGlvblxuICogQGV4cG9ydHMgTG9hZE1vcmVDb21wb25lbnQgQSBjb21wb25lbnQgdG8gbG9hZCBtb3JlIGRhdGEgZnJvbSBhIGNlcnRhaW4gZGF0YS1zb3VyY2VcbiAqIEBleHBvcnRzIFByb2dyZXNzQmFyQ29tcG9uZW50IERpc3BsYXlzIGVpdGhlciBkZWZpbmVkIG9yIHVuZGVmaW5lZCBwcm9ncmVzcy5cbiAqIEBleHBvcnRzIERyb3Bkb3duRGlyZWN0aW9uRGlyZWN0aXZlIERldGVybWluZXMgaWYgYSBkcm9wZG93biBvcGVucyB0byB0aGUgYm90dG9tIG9yIHRvIHRoZSB0b3AuXG4gKiBAZXhwb3J0cyBUZXh0YXJlYUF1dG9yZXNpemVEaXJlY3RpdmUgcmVzaXplcyBhIHRleHRhcmVhIGhlaWdodCBhcyB0aGUgdXNlciBpbnB1dHMuXG4gKiBAZXhwb3J0cyBPcGVyYXRpb25SZXN1bHRDb21wb25lbnQgZGlzcGxheXMgYW4gYW5pbWF0ZWQgc3ZnIGZvciBzdWNjZXNzIGFuZCBlcnJvciBvcGVyYXRpb25zLlxuICovXG5ATmdNb2R1bGUoe1xuICBpbXBvcnRzOiBbTmdDb21tb25Nb2R1bGUsIEkxOG5Nb2R1bGUsIFRvb2x0aXBNb2R1bGUsIFNjcm9sbGluZ01vZHVsZV0sXG4gIGV4cG9ydHM6IFtcbiAgICBJY29uRGlyZWN0aXZlLFxuICAgIE91dGxldERpcmVjdGl2ZSxcbiAgICBJMThuTW9kdWxlLFxuICAgIE5nQ29tbW9uTW9kdWxlLFxuICAgIEh1bWFuaXplQXBwTmFtZVBpcGUsXG4gICAgSHVtYW5pemVQaXBlLFxuICAgIElmQWxsb3dlZERpcmVjdGl2ZSxcbiAgICBTaG9ydGVuVXNlck5hbWVQaXBlLFxuICAgIEZvck9mRGlyZWN0aXZlLFxuICAgIExvYWRNb3JlQ29tcG9uZW50LFxuICAgIE1hcEZ1bmN0aW9uUGlwZSxcbiAgICBQcm9ncmVzc0JhckNvbXBvbmVudCxcbiAgICBEYXRlUGlwZSxcbiAgICBOdW1iZXJQaXBlLFxuICAgIExvYWRpbmdDb21wb25lbnQsXG4gICAgRHJvcGRvd25EaXJlY3Rpb25EaXJlY3RpdmUsXG4gICAgVGV4dGFyZWFBdXRvcmVzaXplRGlyZWN0aXZlLFxuICAgIE9wZXJhdGlvblJlc3VsdENvbXBvbmVudCxcbiAgICBWaXJ0dWFsU2Nyb2xsZXJXcmFwcGVyQ29tcG9uZW50LFxuICAgIFZpcnR1YWxTY3JvbGxXaW5kb3dEaXJlY3RpdmVcbiAgXSxcbiAgZGVjbGFyYXRpb25zOiBbXG4gICAgSWNvbkRpcmVjdGl2ZSxcbiAgICBPdXRsZXREaXJlY3RpdmUsXG4gICAgSHVtYW5pemVQaXBlLFxuICAgIEh1bWFuaXplQXBwTmFtZVBpcGUsXG4gICAgSWZBbGxvd2VkRGlyZWN0aXZlLFxuICAgIFNob3J0ZW5Vc2VyTmFtZVBpcGUsXG4gICAgRm9yT2ZEaXJlY3RpdmUsXG4gICAgTG9hZE1vcmVDb21wb25lbnQsXG4gICAgTWFwRnVuY3Rpb25QaXBlLFxuICAgIFByb2dyZXNzQmFyQ29tcG9uZW50LFxuICAgIERhdGVQaXBlLFxuICAgIE51bWJlclBpcGUsXG4gICAgTG9hZGluZ0NvbXBvbmVudCxcbiAgICBEcm9wZG93bkRpcmVjdGlvbkRpcmVjdGl2ZSxcbiAgICBUZXh0YXJlYUF1dG9yZXNpemVEaXJlY3RpdmUsXG4gICAgT3BlcmF0aW9uUmVzdWx0Q29tcG9uZW50LFxuICAgIFZpcnR1YWxTY3JvbGxlcldyYXBwZXJDb21wb25lbnQsXG4gICAgVmlydHVhbFNjcm9sbFdpbmRvd0RpcmVjdGl2ZVxuICBdLFxuICBlbnRyeUNvbXBvbmVudHM6IFtMb2FkTW9yZUNvbXBvbmVudCwgTG9hZGluZ0NvbXBvbmVudCwgVmlydHVhbFNjcm9sbGVyV3JhcHBlckNvbXBvbmVudF1cbn0pXG5leHBvcnQgY2xhc3MgQ29tbW9uTW9kdWxlIHtcbiAgc3RhdGljIHByb3ZpZGVycygpIHtcbiAgICByZXR1cm4gW1xuICAgICAgLi4uRGF0YU1vZHVsZS5wcm92aWRlcnMoKSxcbiAgICAgIC8vIFRPRE86IG1heWJlIHdlIGNhbiB0aGluayBvZiBhIHdheSB0byByZW1vdmUgdGhpcyBDOFlfQVBQIGdsb2JhbFxuICAgICAgeyBwcm92aWRlOiBIT09LX09QVElPTlMsIHVzZVZhbHVlOiAod2luZG93IGFzIGFueSkuQzhZX0FQUCB8fCB7fSwgbXVsdGk6IHRydWUgfSxcbiAgICAgIHtcbiAgICAgICAgcHJvdmlkZTogQVBQX0lOSVRJQUxJWkVSLFxuICAgICAgICB1c2VGYWN0b3J5OiBpbml0aWFsaXplU2VydmljZXMsXG4gICAgICAgIGRlcHM6IFtUcmFuc2xhdGVTZXJ2aWNlLCBBcHBTdGF0ZVNlcnZpY2UsIFVzZXJQcmVmZXJlbmNlc1NlcnZpY2VdLFxuICAgICAgICBtdWx0aTogdHJ1ZVxuICAgICAgfSxcbiAgICAgIHsgcHJvdmlkZTogSUNPTl9MSVNULCB1c2VWYWx1ZTogSUNPTlMsIG11bHRpOiBmYWxzZSB9LFxuICAgICAgLi4uSTE4bk1vZHVsZS5wcm92aWRlcnMoKSxcbiAgICAgIFVzZXJQcmVmZXJlbmNlc1NlcnZpY2UsXG4gICAgICBPcHRpb25zU2VydmljZSxcbiAgICAgIEFwcFN0YXRlU2VydmljZSxcbiAgICAgIFBlcm1pc3Npb25zLFxuICAgICAgVGVuYW50VWlTZXJ2aWNlLFxuICAgICAgSHVtYW5pemVQaXBlLFxuICAgICAgSHVtYW5pemVBcHBOYW1lUGlwZSxcbiAgICAgIFNob3J0ZW5Vc2VyTmFtZVBpcGUsXG4gICAgICBNYXBGdW5jdGlvblBpcGUsXG4gICAgICBEYXRlUGlwZSxcbiAgICAgIFppcFNlcnZpY2VcbiAgICBdO1xuICB9XG5cbiAgc3RhdGljIGZvclJvb3QoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5nTW9kdWxlOiBDb21tb25Nb2R1bGUsXG4gICAgICBwcm92aWRlcnM6IENvbW1vbk1vZHVsZS5wcm92aWRlcnMoKVxuICAgIH07XG4gIH1cbn1cbiJdfQ==