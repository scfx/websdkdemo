import { __awaiter } from "tslib";
import { Component, ElementRef, EventEmitter, HostBinding, Input, Output } from '@angular/core';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/common';
import * as ɵngcc2 from '../i18n/c8y-translate.directive';
import * as ɵngcc3 from './icon.directive';
import * as ɵngcc4 from '../i18n/c8y-translate.pipe';

function LoadMoreComponent_button_0_ng_container_2_span_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "span", 6);
    ɵngcc0.ɵɵpipe(1, "translate");
} if (rf & 2) {
    const ctx_r7 = ɵngcc0.ɵɵnextContext(3);
    ɵngcc0.ɵɵproperty("innerHTML", ɵngcc0.ɵɵpipeBind1(1, 1, ctx_r7.loadNextLabel), ɵngcc0.ɵɵsanitizeHtml);
} }
const _c0 = function (a0) { return { pageNo: a0 }; };
function LoadMoreComponent_button_0_ng_container_2_ng_template_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "span", 7);
    ɵngcc0.ɵɵdisableBindings();
    ɵngcc0.ɵɵtext(1, " Load page {{ pageNo }}");
    ɵngcc0.ɵɵenableBindings();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r9 = ɵngcc0.ɵɵnextContext(3);
    ɵngcc0.ɵɵproperty("translateParams", ɵngcc0.ɵɵpureFunction1(1, _c0, ctx_r9.paging.currentPage + 1));
} }
function LoadMoreComponent_button_0_ng_container_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtemplate(1, LoadMoreComponent_button_0_ng_container_2_span_1_Template, 2, 3, "span", 4);
    ɵngcc0.ɵɵtemplate(2, LoadMoreComponent_button_0_ng_container_2_ng_template_2_Template, 2, 3, "ng-template", null, 5, ɵngcc0.ɵɵtemplateRefExtractor);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const _r8 = ɵngcc0.ɵɵreference(3);
    const ctx_r5 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r5.loadNextLabel)("ngIfElse", _r8);
} }
function LoadMoreComponent_button_0_ng_container_3_span_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelement(0, "span", 6);
    ɵngcc0.ɵɵpipe(1, "translate");
} if (rf & 2) {
    const ctx_r10 = ɵngcc0.ɵɵnextContext(3);
    ɵngcc0.ɵɵproperty("innerHTML", ɵngcc0.ɵɵpipeBind1(1, 1, ctx_r10.loadingLabel), ɵngcc0.ɵɵsanitizeHtml);
} }
function LoadMoreComponent_button_0_ng_container_3_ng_template_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "span", 7);
    ɵngcc0.ɵɵdisableBindings();
    ɵngcc0.ɵɵtext(1, " Page {{ pageNo }} is loading\u2026 ");
    ɵngcc0.ɵɵenableBindings();
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r12 = ɵngcc0.ɵɵnextContext(3);
    ɵngcc0.ɵɵproperty("translateParams", ɵngcc0.ɵɵpureFunction1(1, _c0, ctx_r12.paging.currentPage + 1));
} }
function LoadMoreComponent_button_0_ng_container_3_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtemplate(1, LoadMoreComponent_button_0_ng_container_3_span_1_Template, 2, 3, "span", 4);
    ɵngcc0.ɵɵtemplate(2, LoadMoreComponent_button_0_ng_container_3_ng_template_2_Template, 2, 3, "ng-template", null, 8, ɵngcc0.ɵɵtemplateRefExtractor);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const _r11 = ɵngcc0.ɵɵreference(3);
    const ctx_r6 = ɵngcc0.ɵɵnextContext(2);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r6.loadingLabel)("ngIfElse", _r11);
} }
const _c1 = function (a0) { return { "btn-pending": a0 }; };
function LoadMoreComponent_button_0_Template(rf, ctx) { if (rf & 1) {
    const _r14 = ɵngcc0.ɵɵgetCurrentView();
    ɵngcc0.ɵɵelementStart(0, "button", 3);
    ɵngcc0.ɵɵlistener("click", function LoadMoreComponent_button_0_Template_button_click_0_listener($event) { ɵngcc0.ɵɵrestoreView(_r14); const ctx_r13 = ɵngcc0.ɵɵnextContext(); return ctx_r13.loadMore($event); });
    ɵngcc0.ɵɵpipe(1, "translate");
    ɵngcc0.ɵɵtemplate(2, LoadMoreComponent_button_0_ng_container_2_Template, 4, 2, "ng-container", 1);
    ɵngcc0.ɵɵtemplate(3, LoadMoreComponent_button_0_ng_container_3_Template, 4, 2, "ng-container", 1);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    const ctx_r0 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵstyleProp("visibility", ctx_r0.hidden ? "hidden" : "visible")("height", ctx_r0.hidden ? "1px" : null);
    ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(1, 8, "Load more"));
    ɵngcc0.ɵɵproperty("ngClass", ɵngcc0.ɵɵpureFunction1(10, _c1, ctx_r0.isLoading));
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("ngIf", !ctx_r0.isLoading);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngIf", ctx_r0.isLoading);
} }
function LoadMoreComponent_ng_container_1_ng_container_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainer(0);
} }
function LoadMoreComponent_ng_container_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtemplate(1, LoadMoreComponent_ng_container_1_ng_container_1_Template, 1, 0, "ng-container", 9);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const ctx_r1 = ɵngcc0.ɵɵnextContext();
    const _r2 = ɵngcc0.ɵɵreference(3);
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngTemplateOutlet", ctx_r1.noMoreDataHint || _r2);
} }
function LoadMoreComponent_ng_template_2_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementStart(0, "div", 10);
    ɵngcc0.ɵɵpipe(1, "translate");
    ɵngcc0.ɵɵelement(2, "i", 11);
    ɵngcc0.ɵɵelementEnd();
} if (rf & 2) {
    ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(1, 2, "Last record"));
    ɵngcc0.ɵɵadvance(2);
    ɵngcc0.ɵɵproperty("c8yIcon", "circle");
} }
function LoadMoreComponent_ng_container_4_ng_container_1_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainer(0);
} }
function LoadMoreComponent_ng_container_4_Template(rf, ctx) { if (rf & 1) {
    ɵngcc0.ɵɵelementContainerStart(0);
    ɵngcc0.ɵɵtemplate(1, LoadMoreComponent_ng_container_4_ng_container_1_Template, 1, 0, "ng-container", 9);
    ɵngcc0.ɵɵelementContainerEnd();
} if (rf & 2) {
    const ctx_r4 = ɵngcc0.ɵɵnextContext();
    ɵngcc0.ɵɵadvance(1);
    ɵngcc0.ɵɵproperty("ngTemplateOutlet", ctx_r4.loadingTemplate);
} }
export class LoadMoreComponent {
    constructor(element) {
        this.element = element;
        this.useIntersection = true;
        this.hidden = false;
        this.class = 'c8y-list__item p-0';
        this.maxIterations = 10;
        this.hideNoMoreDataHint = false;
        this.onLoad = new EventEmitter();
        this.isLoading = false;
        this.counter = 0;
        this.hasNoMoreData = false;
        this.LOAD_SAME_PAGE_THRESHOLD = 50;
        this.destroyed = false;
    }
    get hostClass() {
        return this.hidden || (!this.hasMore && !this.hasNoMoreData) ? '' : this.class;
    }
    get hasMore() {
        return (this.paging && (this.paging.totalPages > this.paging.currentPage || !!this.paging.nextPage));
    }
    ngAfterContentInit() {
        this.destroyed = false;
        if (this.useIntersection && 'IntersectionObserver' in window) {
            this.intersectionObserver = new IntersectionObserver(event => this.buttonInView(event[0]), {
                root: this.container ? this.container.nativeElement : null
            });
            this.intersectionObserver.observe(this.element.nativeElement);
        }
        this.hasNoMoreData = this.shouldShowNoMoreDataHint();
    }
    ngOnDestroy() {
        this.destroyed = true;
        if (this.intersectionObserver) {
            this.intersectionObserver.disconnect();
            this.intersectionObserver.unobserve(this.element.nativeElement);
            clearTimeout(this.loadUntilIntersected);
        }
    }
    loadMore(event) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.destroyed) {
                this.isLoading = true;
                if (event) {
                    event.stopPropagation();
                }
                if (this.hasMore) {
                    const result = yield this.paging.next();
                    this.paging = result.paging;
                    this.onLoad.emit(result.data);
                    this.intersectionLoading();
                    this.hasNoMoreData = this.shouldShowNoMoreDataHint();
                }
                else {
                    this.counter = 0;
                    this.isLoading = false;
                }
            }
        });
    }
    intersectionLoading() {
        if (this.useIntersection && this.hasMore && this.loadUntilIntersected !== null) {
            this.loadUntilIntersected = setTimeout(() => this.loadMore(), this.getLoadingThreshold());
            this.useIntersection = this.shouldSwitchMode();
        }
        else {
            this.isLoading = false;
            this.loadUntilIntersected = undefined;
        }
    }
    getLoadingThreshold() {
        return this.LOAD_SAME_PAGE_THRESHOLD * this.counter++;
    }
    shouldShowNoMoreDataHint() {
        return (this.counter !== 0 || this.noMoreDataHint) && !this.hasMore && !this.hidden;
    }
    shouldSwitchMode() {
        return this.counter < this.maxIterations || this.hidden;
    }
    buttonInView(event) {
        if (event.isIntersecting) {
            this.loadMore();
        }
        else if (this.loadUntilIntersected) {
            clearTimeout(this.loadUntilIntersected);
            this.loadUntilIntersected = null;
            this.isLoading = false;
        }
        else {
            // avoiding a race condition when timeout is faster
            // cleared then set
            this.loadUntilIntersected = null;
        }
    }
}
LoadMoreComponent.ɵfac = function LoadMoreComponent_Factory(t) { return new (t || LoadMoreComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc0.ElementRef)); };
LoadMoreComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: LoadMoreComponent, selectors: [["c8y-load-more"]], hostVars: 2, hostBindings: function LoadMoreComponent_HostBindings(rf, ctx) { if (rf & 2) {
        ɵngcc0.ɵɵclassMap(ctx.hostClass);
    } }, inputs: { useIntersection: "useIntersection", hidden: "hidden", class: "class", maxIterations: "maxIterations", hideNoMoreDataHint: "hideNoMoreDataHint", paging: "paging", container: "container", noMoreDataHint: "noMoreDataHint", loadingTemplate: "loadingTemplate", loadNextLabel: "loadNextLabel", loadingLabel: "loadingLabel" }, outputs: { onLoad: "onLoad" }, decls: 5, vars: 3, consts: [["class", "btn btn-default btn-block text-center", 3, "ngClass", "visibility", "height", "title", "click", 4, "ngIf"], [4, "ngIf"], ["finishHint", ""], [1, "btn", "btn-default", "btn-block", "text-center", 3, "ngClass", "title", "click"], [3, "innerHTML", 4, "ngIf", "ngIfElse"], ["loadPage", ""], [3, "innerHTML"], ["translate", "", 3, "translateParams"], ["loading", ""], [4, "ngTemplateOutlet"], [1, "legend", "form-block", "center", "last-record", 3, "title"], [3, "c8yIcon"]], template: function LoadMoreComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵtemplate(0, LoadMoreComponent_button_0_Template, 4, 12, "button", 0);
        ɵngcc0.ɵɵtemplate(1, LoadMoreComponent_ng_container_1_Template, 2, 1, "ng-container", 1);
        ɵngcc0.ɵɵtemplate(2, LoadMoreComponent_ng_template_2_Template, 3, 4, "ng-template", null, 2, ɵngcc0.ɵɵtemplateRefExtractor);
        ɵngcc0.ɵɵtemplate(4, LoadMoreComponent_ng_container_4_Template, 2, 1, "ng-container", 1);
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("ngIf", ctx.hasMore && !(ctx.loadingTemplate && ctx.isLoading));
        ɵngcc0.ɵɵadvance(1);
        ɵngcc0.ɵɵproperty("ngIf", ctx.hasNoMoreData && !ctx.hideNoMoreDataHint && !ctx.isLoading);
        ɵngcc0.ɵɵadvance(3);
        ɵngcc0.ɵɵproperty("ngIf", ctx.loadingTemplate && ctx.isLoading);
    } }, directives: [ɵngcc1.NgIf, ɵngcc1.NgClass, ɵngcc2.C8yTranslateDirective, ɵngcc1.NgTemplateOutlet, ɵngcc3.IconDirective], pipes: [ɵngcc4.C8yTranslatePipe], encapsulation: 2 });
LoadMoreComponent.ctorParameters = () => [
    { type: ElementRef }
];
LoadMoreComponent.propDecorators = {
    paging: [{ type: Input }],
    useIntersection: [{ type: Input }],
    hidden: [{ type: Input }],
    container: [{ type: Input }],
    class: [{ type: Input }],
    maxIterations: [{ type: Input }],
    noMoreDataHint: [{ type: Input }],
    loadingTemplate: [{ type: Input }],
    hideNoMoreDataHint: [{ type: Input }],
    loadNextLabel: [{ type: Input }],
    loadingLabel: [{ type: Input }],
    onLoad: [{ type: Output }],
    hostClass: [{ type: HostBinding, args: ['class',] }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(LoadMoreComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-load-more',
                template: "<button\n  class=\"btn btn-default btn-block text-center\"\n  (click)=\"loadMore($event)\"\n  [ngClass]=\"{ 'btn-pending': isLoading }\"\n  *ngIf=\"hasMore && !(loadingTemplate && isLoading)\"\n  [style.visibility]=\"hidden ? 'hidden' : 'visible'\"\n  [style.height]=\"hidden ? '1px' : null\"\n  title=\"{{ 'Load more' | translate }}\"\n>\n  <ng-container *ngIf=\"!isLoading\">\n    <span *ngIf=\"loadNextLabel; else loadPage\" [innerHTML]=\"loadNextLabel | translate\"></span>\n    <ng-template #loadPage>\n      <span translate ngNonBindable [translateParams]=\"{ pageNo: paging.currentPage + 1 }\">\n        Load page {{ pageNo }}</span\n      >\n    </ng-template>\n  </ng-container>\n  <ng-container *ngIf=\"isLoading\">\n    <span *ngIf=\"loadingLabel; else loading\" [innerHTML]=\"loadingLabel | translate\"></span>\n    <ng-template #loading>\n      <span translate ngNonBindable [translateParams]=\"{ pageNo: paging.currentPage + 1 }\">\n        Page {{ pageNo }} is loading\u2026\n      </span>\n    </ng-template>\n  </ng-container>\n</button>\n\n<ng-container *ngIf=\"hasNoMoreData && !hideNoMoreDataHint && !isLoading\">\n  <ng-container *ngTemplateOutlet=\"noMoreDataHint || finishHint\"></ng-container>\n</ng-container>\n\n<ng-template #finishHint>\n  <div class=\"legend form-block center last-record\" title=\"{{ 'Last record' | translate }}\">\n    <i [c8yIcon]=\"'circle'\"></i>\n  </div>\n</ng-template>\n\n<ng-container *ngIf=\"loadingTemplate && isLoading\">\n  <ng-container *ngTemplateOutlet=\"loadingTemplate\"></ng-container>\n</ng-container>\n"
            }]
    }], function () { return [{ type: ɵngcc0.ElementRef }]; }, { useIntersection: [{
            type: Input
        }], hidden: [{
            type: Input
        }], class: [{
            type: Input
        }], maxIterations: [{
            type: Input
        }], hideNoMoreDataHint: [{
            type: Input
        }], onLoad: [{
            type: Output
        }], hostClass: [{
            type: HostBinding,
            args: ['class']
        }], paging: [{
            type: Input
        }], container: [{
            type: Input
        }], noMoreDataHint: [{
            type: Input
        }], loadingTemplate: [{
            type: Input
        }], loadNextLabel: [{
            type: Input
        }], loadingLabel: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9hZC1tb3JlLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9jb21tb24vbG9hZC1tb3JlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxVQUFVLEVBQ1YsWUFBWSxFQUNaLFdBQVcsRUFDWCxLQUFLLEVBQ0wsTUFBTSxFQUVQLE1BQU0sZUFBZSxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBT3ZCLE1BQU0sT0FBTyxpQkFBaUI7QUFDOUIsSUE0Q0UsWUFBb0IsT0FBbUI7QUFBSSxRQUF2QixZQUFPLEdBQVAsT0FBTyxDQUFZO0FBQUMsUUF6Q3hDLG9CQUFlLEdBQUcsSUFBSSxDQUFDO0FBQ3pCLFFBQ0UsV0FBTSxHQUFHLEtBQUssQ0FBQztBQUNqQixRQUdFLFVBQUssR0FBVyxvQkFBb0IsQ0FBQztBQUN2QyxRQUNFLGtCQUFhLEdBQUcsRUFBRSxDQUFDO0FBQ3JCLFFBS0UsdUJBQWtCLEdBQVksS0FBSyxDQUFDO0FBQ3RDLFFBS0UsV0FBTSxHQUFHLElBQUksWUFBWSxFQUFlLENBQUM7QUFDM0MsUUFDRSxjQUFTLEdBQUcsS0FBSyxDQUFDO0FBQ3BCLFFBQUUsWUFBTyxHQUFHLENBQUMsQ0FBQztBQUNkLFFBQUUsa0JBQWEsR0FBRyxLQUFLLENBQUM7QUFDeEIsUUFDbUIsNkJBQXdCLEdBQUcsRUFBRSxDQUFDO0FBQ2pELFFBQ1UsY0FBUyxHQUFHLEtBQUssQ0FBQztBQUM1QixJQVk0QyxDQUFDO0FBQzdDLElBWkUsSUFDSSxTQUFTO0FBQ2YsUUFBSSxPQUFPLElBQUksQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxD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O0FBQzlDLFlBQU0sSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQztBQUN2QyxZQUFNLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO0FBQzdCLFNBQUs7QUFBQyxhQUFLO0FBQ1gsWUFBTSxtREFBbUQ7QUFDekQsWUFBTSxtQkFBbUI7QUFDekIsWUFBTSxJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDO0FBQ3ZDLFNBQUs7QUFDTCxJQUFFLENBQUM7QUFDSDs2Q0E3SEMsU0FBUyxTQUFDLGtCQUNULFFBQVEsRUFBRSxlQUFlLGtCQUN6Qjs7Ozs7Ozs4QkFBeUMsY0FDMUM7Ozs7Ozs7dUxBQ0k7QUFBQztBQUVELFlBZkgsVUFBVTtBQUNYO0FBQUc7QUFHSCxxQkFVRSxLQUFLO0FBQ04sOEJBQ0MsS0FBSztBQUNOLHFCQUNDLEtBQUs7QUFDTix3QkFDQyxLQUFLO0FBQ04sb0JBQ0MsS0FBSztBQUNOLDRCQUNDLEtBQUs7QUFDTiw2QkFDQyxLQUFLO0FBQ04sOEJBQ0MsS0FBSztBQUNOLGlDQUNDLEtBQUs7QUFDTiw0QkFDQyxLQUFLO0FBQ04sMkJBQ0MsS0FBSztBQUNOLHFCQUNDLE1BQU07QUFDUCx3QkFVQyxXQUFXLFNBQUMsT0FBTztBQUNsQjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztvQkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIEhvc3RCaW5kaW5nLFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBUZW1wbGF0ZVJlZlxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IElJZGVudGlmaWVkLCBQYWdpbmcgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1sb2FkLW1vcmUnLFxuICB0ZW1wbGF0ZVVybDogJy4vbG9hZC1tb3JlLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBMb2FkTW9yZUNvbXBvbmVudCB7XG4gIEBJbnB1dCgpXG4gIHBhZ2luZzogUGFnaW5nPGFueT47XG4gIEBJbnB1dCgpXG4gIHVzZUludGVyc2VjdGlvbiA9IHRydWU7XG4gIEBJbnB1dCgpXG4gIGhpZGRlbiA9IGZhbHNlO1xuICBASW5wdXQoKVxuICBjb250YWluZXI6IEVsZW1lbnRSZWY7XG4gIEBJbnB1dCgpXG4gIGNsYXNzOiBzdHJpbmcgPSAnYzh5LWxpc3RfX2l0ZW0gcC0wJztcbiAgQElucHV0KClcbiAgbWF4SXRlcmF0aW9ucyA9IDEwO1xuICBASW5wdXQoKVxuICBub01vcmVEYXRhSGludDogVGVtcGxhdGVSZWY8YW55PjtcbiAgQElucHV0KClcbiAgbG9hZGluZ1RlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+O1xuICBASW5wdXQoKVxuICBoaWRlTm9Nb3JlRGF0YUhpbnQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgQElucHV0KClcbiAgbG9hZE5leHRMYWJlbDogc3RyaW5nO1xuICBASW5wdXQoKVxuICBsb2FkaW5nTGFiZWw6IHN0cmluZztcbiAgQE91dHB1dCgpXG4gIG9uTG9hZCA9IG5ldyBFdmVudEVtaXR0ZXI8SUlkZW50aWZpZWQ+KCk7XG5cbiAgaXNMb2FkaW5nID0gZmFsc2U7XG4gIGNvdW50ZXIgPSAwO1xuICBoYXNOb01vcmVEYXRhID0gZmFsc2U7XG4gIHByaXZhdGUgbG9hZFVudGlsSW50ZXJzZWN0ZWQ7XG4gIHByaXZhdGUgcmVhZG9ubHkgTE9BRF9TQU1FX1BBR0VfVEhSRVNIT0xEID0gNTA7XG4gIHByaXZhdGUgaW50ZXJzZWN0aW9uT2JzZXJ2ZXI6IEludGVyc2VjdGlvbk9ic2VydmVyO1xuICBwcml2YXRlIGRlc3Ryb3llZCA9IGZhbHNlO1xuXG4gIEBIb3N0QmluZGluZygnY2xhc3MnKVxuICBnZXQgaG9zdENsYXNzKCkge1xuICAgIHJldHVybiB0aGlzLmhpZGRlbiB8fCAoIXRoaXMuaGFzTW9yZSAmJiAhdGhpcy5oYXNOb01vcmVEYXRhKSA/ICcnIDogdGhpcy5jbGFzcztcbiAgfVxuXG4gIGdldCBoYXNNb3JlKCkge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLnBhZ2luZyAmJiAodGhpcy5wYWdpbmcudG90YWxQYWdlcyA+IHRoaXMucGFnaW5nLmN1cnJlbnRQYWdlIHx8ICEhdGhpcy5wYWdpbmcubmV4dFBhZ2UpXG4gICAgKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZWxlbWVudDogRWxlbWVudFJlZikge31cblxuICBuZ0FmdGVyQ29udGVudEluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5kZXN0cm95ZWQgPSBmYWxzZTtcbiAgICBpZiAodGhpcy51c2VJbnRlcnNlY3Rpb24gJiYgJ0ludGVyc2VjdGlvbk9ic2VydmVyJyBpbiB3aW5kb3cpIHtcbiAgICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXIgPSBuZXcgSW50ZXJzZWN0aW9uT2JzZXJ2ZXIoZXZlbnQgPT4gdGhpcy5idXR0b25JblZpZXcoZXZlbnRbMF0pLCB7XG4gICAgICAgIHJvb3Q6IHRoaXMuY29udGFpbmVyID8gdGhpcy5jb250YWluZXIubmF0aXZlRWxlbWVudCA6IG51bGxcbiAgICAgIH0pO1xuICAgICAgdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlci5vYnNlcnZlKHRoaXMuZWxlbWVudC5uYXRpdmVFbGVtZW50KTtcbiAgICB9XG4gICAgdGhpcy5oYXNOb01vcmVEYXRhID0gdGhpcy5zaG91bGRTaG93Tm9Nb3JlRGF0YUhpbnQoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuZGVzdHJveWVkID0gdHJ1ZTtcbiAgICBpZiAodGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlcikge1xuICAgICAgdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlci5kaXNjb25uZWN0KCk7XG4gICAgICB0aGlzLmludGVyc2VjdGlvbk9ic2VydmVyLnVub2JzZXJ2ZSh0aGlzLmVsZW1lbnQubmF0aXZlRWxlbWVudCk7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5sb2FkVW50aWxJbnRlcnNlY3RlZCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgbG9hZE1vcmUoZXZlbnQ/KSB7XG4gICAgaWYgKCF0aGlzLmRlc3Ryb3llZCkge1xuICAgICAgdGhpcy5pc0xvYWRpbmcgPSB0cnVlO1xuICAgICAgaWYgKGV2ZW50KSB7XG4gICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuaGFzTW9yZSkge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnBhZ2luZy5uZXh0KCk7XG4gICAgICAgIHRoaXMucGFnaW5nID0gcmVzdWx0LnBhZ2luZztcbiAgICAgICAgdGhpcy5vbkxvYWQuZW1pdChyZXN1bHQuZGF0YSk7XG4gICAgICAgIHRoaXMuaW50ZXJzZWN0aW9uTG9hZGluZygpO1xuICAgICAgICB0aGlzLmhhc05vTW9yZURhdGEgPSB0aGlzLnNob3VsZFNob3dOb01vcmVEYXRhSGludCgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5jb3VudGVyID0gMDtcbiAgICAgICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGludGVyc2VjdGlvbkxvYWRpbmcoKSB7XG4gICAgaWYgKHRoaXMudXNlSW50ZXJzZWN0aW9uICYmIHRoaXMuaGFzTW9yZSAmJiB0aGlzLmxvYWRVbnRpbEludGVyc2VjdGVkICE9PSBudWxsKSB7XG4gICAgICB0aGlzLmxvYWRVbnRpbEludGVyc2VjdGVkID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLmxvYWRNb3JlKCksIHRoaXMuZ2V0TG9hZGluZ1RocmVzaG9sZCgpKTtcbiAgICAgIHRoaXMudXNlSW50ZXJzZWN0aW9uID0gdGhpcy5zaG91bGRTd2l0Y2hNb2RlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7XG4gICAgICB0aGlzLmxvYWRVbnRpbEludGVyc2VjdGVkID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0TG9hZGluZ1RocmVzaG9sZCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLkxPQURfU0FNRV9QQUdFX1RIUkVTSE9MRCAqIHRoaXMuY291bnRlcisrO1xuICB9XG5cbiAgcHJpdmF0ZSBzaG91bGRTaG93Tm9Nb3JlRGF0YUhpbnQoKSB7XG4gICAgcmV0dXJuICh0aGlzLmNvdW50ZXIgIT09IDAgfHwgdGhpcy5ub01vcmVEYXRhSGludCkgJiYgIXRoaXMuaGFzTW9yZSAmJiAhdGhpcy5oaWRkZW47XG4gIH1cblxuICBwcml2YXRlIHNob3VsZFN3aXRjaE1vZGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuY291bnRlciA8IHRoaXMubWF4SXRlcmF0aW9ucyB8fCB0aGlzLmhpZGRlbjtcbiAgfVxuXG4gIHByaXZhdGUgYnV0dG9uSW5WaWV3KGV2ZW50KSB7XG4gICAgaWYgKGV2ZW50LmlzSW50ZXJzZWN0aW5nKSB7XG4gICAgICB0aGlzLmxvYWRNb3JlKCk7XG4gICAgfSBlbHNlIGlmICh0aGlzLmxvYWRVbnRpbEludGVyc2VjdGVkKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGhpcy5sb2FkVW50aWxJbnRlcnNlY3RlZCk7XG4gICAgICB0aGlzLmxvYWRVbnRpbEludGVyc2VjdGVkID0gbnVsbDtcbiAgICAgIHRoaXMuaXNMb2FkaW5nID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGF2b2lkaW5nIGEgcmFjZSBjb25kaXRpb24gd2hlbiB0aW1lb3V0IGlzIGZhc3RlclxuICAgICAgLy8gY2xlYXJlZCB0aGVuIHNldFxuICAgICAgdGhpcy5sb2FkVW50aWxJbnRlcnNlY3RlZCA9IG51bGw7XG4gICAgfVxuICB9XG59XG4iXX0=