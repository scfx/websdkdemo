import { __awaiter } from "tslib";
import { InjectionToken, Optional, Inject, Injectable } from '@angular/core';
import { camelCase, isUndefined } from 'lodash-es';
import { ApplicationOptions } from './ApplicationOptions';
import { SystemOptionsService, TenantOptionsService } from '@c8y/ngx-components/api';
export const HOOK_OPTIONS = new InjectionToken('App options');
/**
 * A service that allows to set or get application options
 * which configure the default behavior of the UI.
 */
export class OptionsService extends ApplicationOptions {
    constructor(options, systemOptionsService, tenantOptionService) {
        super();
        this.systemOptionsService = systemOptionsService;
        this.tenantOptionService = tenantOptionService;
        this.setupOptions(options);
    }
    /**
     * Returns an application option used to configure the UI.
     * @param optionKey The application options key.
     * @param defaultValue A value to return if non is set.
     */
    get(optionKey, defaultValue) {
        let value = this[optionKey];
        if (typeof value === 'undefined') {
            value = this[camelCase(optionKey)];
        }
        return typeof value !== 'undefined' ? value : defaultValue;
    }
    /**
     * Sets an application option.
     * @param key The key to set.
     * @param value The value to set.
     */
    set(key, value) {
        this[camelCase(key)] = value;
    }
    /**
     * Gets support url from tenant options.
     * If response returns '404 not found' it gets the support url from application options.
     * If the support link within application options is not provided the UI will use the system options.
     * Is the support link explicitly set to false it will be hidden.
     *
     * @returns Returns support url or false.
     */
    getSupportUrl() {
        return __awaiter(this, void 0, void 0, function* () {
            let url = yield this.getTenantOption('configuration', 'system.support.url');
            if (isUndefined(url)) {
                url = this.supportUrl;
            }
            this.supportUrl = isUndefined(url) ? (yield this.getSystemOption('support', 'url')) || false : url;
            return this.supportUrl;
        });
    }
    /**
     * Returns if the tenant allows to show the activate-support user menu entry.
     * Note: Only if system-level support-user/enabled is false we can activate it at tenant level.
     */
    getActivateSupportUser() {
        return __awaiter(this, void 0, void 0, function* () {
            const option = yield this.getSystemOption('support-user', 'enabled', true);
            return !option;
        });
    }
    /**
     * Gets a value from the system service and parses it.
     *
     * @param category The category for this option.
     * @param key The key for that option.
     * @param defaultValue The default if the option was not found.
     */
    getSystemOption(category, key, defaultValue) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.getOptionFromService(category, key, this.systemOptionsService, defaultValue);
        });
    }
    /**
     * Gets a value from the tenant service and parses it.
     *
     * @param category The category for this option.
     * @param key The key for that option.
     * @param defaultValue The default if the option was not found.
     */
    getTenantOption(category, key, defaultValue) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.getOptionFromService(category, key, this.tenantOptionService, defaultValue);
        });
    }
    setupOptions(options) {
        if (options) {
            if (!Array.isArray(options)) {
                options = [options];
            }
            options.forEach(optionMap => {
                if (optionMap) {
                    Object.keys(optionMap).forEach(key => {
                        this[camelCase(key)] = optionMap[key];
                    });
                }
            });
        }
    }
    getOptionFromService(category, key, service, defaultValue) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const { data } = yield service.detail({ category, key });
                return this.parseOptionRawValue(data.value, defaultValue);
            }
            catch (ex) {
                return defaultValue;
            }
        });
    }
    parseOptionRawValue(rawValue, defaultValue) {
        let value;
        try {
            value = JSON.parse(rawValue);
        }
        catch (e) {
            value = isUndefined(rawValue) ? defaultValue : rawValue;
        }
        return value;
    }
}
OptionsService.decorators = [
    { type: Injectable }
];
OptionsService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [HOOK_OPTIONS,] }] },
    { type: SystemOptionsService },
    { type: TenantOptionsService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3B0aW9ucy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9jb21tb24vb3B0aW9ucy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzdFLE9BQU8sRUFBRSxTQUFTLEVBQUUsV0FBVyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ25ELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRTFELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxvQkFBb0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRXJGLE1BQU0sQ0FBQyxNQUFNLFlBQVksR0FBRyxJQUFJLGNBQWMsQ0FBdUMsYUFBYSxDQUFDLENBQUM7QUFFcEc7OztHQUdHO0FBRUgsTUFBTSxPQUFPLGNBQWUsU0FBUSxrQkFBa0I7SUFFcEQsWUFDb0MsT0FBTyxFQUNqQyxvQkFBMEMsRUFDMUMsbUJBQXlDO1FBRWpELEtBQUssRUFBRSxDQUFDO1FBSEEseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUMxQyx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXNCO1FBR2pELElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxHQUFHLENBQUMsU0FBK0IsRUFBRSxZQUFrQjtRQUNyRCxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDNUIsSUFBSSxPQUFPLEtBQUssS0FBSyxXQUFXLEVBQUU7WUFDaEMsS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztTQUNwQztRQUNELE9BQU8sT0FBTyxLQUFLLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFD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QU8sQ0FBQyxFQUFFO1lBQ1YsS0FBSyxHQUFHLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7U0FDekQ7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7OztZQWxIRixVQUFVOzs7NENBSU4sUUFBUSxZQUFJLE1BQU0sU0FBQyxZQUFZO1lBWjNCLG9CQUFvQjtZQUFFLG9CQUFvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGlvblRva2VuLCBPcHRpb25hbCwgSW5qZWN0LCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBjYW1lbENhc2UsIGlzVW5kZWZpbmVkIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IEFwcGxpY2F0aW9uT3B0aW9ucyB9IGZyb20gJy4vQXBwbGljYXRpb25PcHRpb25zJztcbmltcG9ydCB7IEV4dGVuc2lvbkZhY3RvcnkgfSBmcm9tICcuL2V4dGVuc2lvbi1ob29rcyc7XG5pbXBvcnQgeyBTeXN0ZW1PcHRpb25zU2VydmljZSwgVGVuYW50T3B0aW9uc1NlcnZpY2UgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL2FwaSc7XG5cbmV4cG9ydCBjb25zdCBIT09LX09QVElPTlMgPSBuZXcgSW5qZWN0aW9uVG9rZW48RXh0ZW5zaW9uRmFjdG9yeTxBcHBsaWNhdGlvbk9wdGlvbnM+PignQXBwIG9wdGlvbnMnKTtcblxuLyoqXG4gKiBBIHNlcnZpY2UgdGhhdCBhbGxvd3MgdG8gc2V0IG9yIGdldCBhcHBsaWNhdGlvbiBvcHRpb25zXG4gKiB3aGljaCBjb25maWd1cmUgdGhlIGRlZmF1bHQgYmVoYXZpb3Igb2YgdGhlIFVJLlxuICovXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgT3B0aW9uc1NlcnZpY2UgZXh0ZW5kcyBBcHBsaWNhdGlvbk9wdGlvbnMge1xuICBba2V5OiBzdHJpbmddOiBhbnk7XG4gIGNvbnN0cnVjdG9yKFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoSE9PS19PUFRJT05TKSBvcHRpb25zLFxuICAgIHByaXZhdGUgc3lzdGVtT3B0aW9uc1NlcnZpY2U6IFN5c3RlbU9wdGlvbnNTZXJ2aWNlLFxuICAgIHByaXZhdGUgdGVuYW50T3B0aW9uU2VydmljZTogVGVuYW50T3B0aW9uc1NlcnZpY2VcbiAgKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnNldHVwT3B0aW9ucyhvcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFuIGFwcGxpY2F0aW9uIG9wdGlvbiB1c2VkIHRvIGNvbmZpZ3VyZSB0aGUgVUkuXG4gICAqIEBwYXJhbSBvcHRpb25LZXkgVGhlIGFwcGxpY2F0aW9uIG9wdGlvbnMga2V5LlxuICAgKiBAcGFyYW0gZGVmYXVsdFZhbHVlIEEgdmFsdWUgdG8gcmV0dXJuIGlmIG5vbiBpcyBzZXQuXG4gICAqL1xuICBnZXQob3B0aW9uS2V5OiBrZXlvZiBPcHRpb25zU2VydmljZSwgZGVmYXVsdFZhbHVlPzogYW55KSB7XG4gICAgbGV0IHZhbHVlID0gdGhpc1tvcHRpb25LZXldO1xuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICB2YWx1ZSA9IHRoaXNbY2FtZWxDYXNlKG9wdGlvbktleSldO1xuICAgIH1cbiAgICByZXR1cm4gdHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJyA/IHZhbHVlIDogZGVmYXVsdFZhbHVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgYW4gYXBwbGljYXRpb24gb3B0aW9uLlxuICAgKiBAcGFyYW0ga2V5IFRoZSBrZXkgdG8gc2V0LlxuICAgKiBAcGFyYW0gdmFsdWUgVGhlIHZhbHVlIHRvIHNldC5cbiAgICovXG4gIHNldChrZXk6IHN0cmluZywgdmFsdWU6IGFueSkge1xuICAgIHRoaXNbY2FtZWxDYXNlKGtleSldID0gdmFsdWU7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBzdXBwb3J0IHVybCBmcm9tIHRlbmFudCBvcHRpb25zLlxuICAgKiBJZiByZXNwb25zZSByZXR1cm5zICc0MDQgbm90IGZvdW5kJyBpdCBnZXRzIHRoZSBzdXBwb3J0IHVybCBmcm9tIGFwcGxpY2F0aW9uIG9wdGlvbnMuXG4gICAqIElmIHRoZSBzdXBwb3J0IGxpbmsgd2l0aGluIGFwcGxpY2F0aW9uIG9wdGlvbnMgaXMgbm90IHByb3ZpZGVkIHRoZSBVSSB3aWxsIHVzZSB0aGUgc3lzdGVtIG9wdGlvbnMuXG4gICAqIElzIHRoZSBzdXBwb3J0IGxpbmsgZXhwbGljaXRseSBzZXQgdG8gZmFsc2UgaXQgd2lsbCBiZSBoaWRkZW4uXG4gICAqXG4gICAqIEByZXR1cm5zIFJldHVybnMgc3VwcG9ydCB1cmwgb3IgZmFsc2UuXG4gICAqL1xuICBhc3luYyBnZXRTdXBwb3J0VXJsKCkge1xuICAgIGxldCB1cmwgPSBhd2FpdCB0aGlzLmdldFRlbmFudE9wdGlvbignY29uZmlndXJhdGlvbicsICdzeXN0ZW0uc3VwcG9ydC51cmwnKTtcbiAgICBpZiAoaXNVbmRlZmluZWQodXJsKSkge1xuICAgICAgdXJsID0gdGhpcy5zdXBwb3J0VXJsO1xuICAgIH1cbiAgICB0aGlzLnN1cHBvcnRVcmwgPSBpc1VuZGVmaW5lZCh1cmwpID8gKGF3YWl0IHRoaXMuZ2V0U3lzdGVtT3B0aW9uKCdzdXBwb3J0JywgJ3VybCcpKSB8fCBmYWxzZSA6IHVybDtcbiAgICByZXR1cm4gdGhpcy5zdXBwb3J0VXJsO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgaWYgdGhlIHRlbmFudCBhbGxvd3MgdG8gc2hvdyB0aGUgYWN0aXZhdGUtc3VwcG9ydCB1c2VyIG1lbnUgZW50cnkuXG4gICAqIE5vdGU6IE9ubHkgaWYgc3lzdGVtLWxldmVsIHN1cHBvcnQtdXNlci9lbmFibGVkIGlzIGZhbHNlIHdlIGNhbiBhY3RpdmF0ZSBpdCBhdCB0ZW5hbnQgbGV2ZWwuXG4gICAqL1xuICBhc3luYyBnZXRBY3RpdmF0ZVN1cHBvcnRVc2VyKCkge1xuICAgIGNvbnN0IG9wdGlvbiA9IGF3YWl0IHRoaXMuZ2V0U3lzdGVtT3B0aW9uKCdzdXBwb3J0LXVzZXInLCAnZW5hYmxlZCcsIHRydWUpO1xuICAgIHJldHVybiAhb3B0aW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgYSB2YWx1ZSBmcm9tIHRoZSBzeXN0ZW0gc2VydmljZSBhbmQgcGFyc2VzIGl0LlxuICAgKlxuICAgKiBAcGFyYW0gY2F0ZWdvcnkgVGhlIGNhdGVnb3J5IGZvciB0aGlzIG9wdGlvbi5cbiAgICogQHBhcmFtIGtleSBUaGUga2V5IGZvciB0aGF0IG9wdGlvbi5cbiAgICogQHBhcmFtIGRlZmF1bHRWYWx1ZSBUaGUgZGVmYXVsdCBpZiB0aGUgb3B0aW9uIHdhcyBub3QgZm91bmQuXG4gICAqL1xuICBhc3luYyBnZXRTeXN0ZW1PcHRpb24oY2F0ZWdvcnk6IHN0cmluZywga2V5OiBzdHJpbmcsIGRlZmF1bHRWYWx1ZT86IGFueSkge1xuICAgIHJldHVybiB0aGlzLmdldE9wdGlvbkZyb21TZXJ2aWNlKGNhdGVnb3J5LCBrZXksIHRoaXMuc3lzdGVtT3B0aW9uc1NlcnZpY2UsIGRlZmF1bHRWYWx1ZSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBhIHZhbHVlIGZyb20gdGhlIHRlbmFudCBzZXJ2aWNlIGFuZCBwYXJzZXMgaXQuXG4gICAqXG4gICAqIEBwYXJhbSBjYXRlZ29yeSBUaGUgY2F0ZWdvcnkgZm9yIHRoaXMgb3B0aW9uLlxuICAgKiBAcGFyYW0ga2V5IFRoZSBrZXkgZm9yIHRoYXQgb3B0aW9uLlxuICAgKiBAcGFyYW0gZGVmYXVsdFZhbHVlIFRoZSBkZWZhdWx0IGlmIHRoZSBvcHRpb24gd2FzIG5vdCBmb3VuZC5cbiAgICovXG4gIGFzeW5jIGdldFRlbmFudE9wdGlvbihjYXRlZ29yeTogc3RyaW5nLCBrZXk6IHN0cmluZywgZGVmYXVsdFZhbHVlPzogYW55KSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0T3B0aW9uRnJvbVNlcnZpY2UoY2F0ZWdvcnksIGtleSwgdGhpcy50ZW5hbnRPcHRpb25TZXJ2aWNlLCBkZWZhdWx0VmFsdWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXR1cE9wdGlvbnMob3B0aW9uczogYW55W10gfCBudWxsKSB7XG4gICAgaWYgKG9wdGlvbnMpIHtcbiAgICAgIGlmICghQXJyYXkuaXNBcnJheShvcHRpb25zKSkge1xuICAgICAgICBvcHRpb25zID0gW29wdGlvbnNdO1xuICAgICAgfVxuICAgICAgb3B0aW9ucy5mb3JFYWNoKG9wdGlvbk1hcCA9PiB7XG4gICAgICAgIGlmIChvcHRpb25NYXApIHtcbiAgICAgICAgICBPYmplY3Qua2V5cyhvcHRpb25NYXApLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgIHRoaXNbY2FtZWxDYXNlKGtleSldID0gb3B0aW9uTWFwW2tleV07XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0T3B0aW9uRnJvbVNlcnZpY2UoY2F0ZWdvcnksIGtleSwgc2VydmljZSwgZGVmYXVsdFZhbHVlKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgc2VydmljZS5kZXRhaWwoeyBjYXRlZ29yeSwga2V5IH0pO1xuICAgICAgcmV0dXJuIHRoaXMucGFyc2VPcHRpb25SYXdWYWx1ZShkYXRhLnZhbHVlLCBkZWZhdWx0VmFsdWUpO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICByZXR1cm4gZGVmYXVsdFZhbHVlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VPcHRpb25SYXdWYWx1ZShyYXdWYWx1ZSwgZGVmYXVsdFZhbHVlKSB7XG4gICAgbGV0IHZhbHVlO1xuICAgIHRyeSB7XG4gICAgICB2YWx1ZSA9IEpTT04ucGFyc2UocmF3VmFsdWUpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHZhbHVlID0gaXNVbmRlZmluZWQocmF3VmFsdWUpID8gZGVmYXVsdFZhbHVlIDogcmF3VmFsdWU7XG4gICAgfVxuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxufVxuIl19