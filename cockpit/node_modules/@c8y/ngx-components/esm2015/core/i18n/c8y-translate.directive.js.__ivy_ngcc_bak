import { TranslateDirective, TranslateService } from '@ngx-translate/core';
import { ChangeDetectorRef, Directive, ElementRef, EventEmitter } from '@angular/core';
export class C8yTranslateDirective extends TranslateDirective {
    constructor(translateService, element, _ref) {
        super(translateService, element, _ref);
        /**
         * Used to trigger events when html is replaced by directive.
         */
        this.htmlUpdateEvent = new EventEmitter();
    }
    /**
     * Used to get private element property from TranslateDirective, so it doesn't throw tsErrors
     */
    get _elementRef() {
        return this.element;
    }
    /**
     * Used to get private translateService property from TranslateDirective, so it doesn't throw tsErrors
     */
    get _translateService() {
        return this.translateService;
    }
    /**
     * Overridden method from original directive.
     * For simple text nodes, it just invokes the base method.
     * For complex nodes, it builds translation key from whole inner HTML
     * and replaces it with its translation.
     * This prevents splitting HTML into pieces and attempting to translate each one separately
     * which doesn't work, because we extract strings in whole.
     */
    checkNodes(forceUpdate = false, translations) {
        if (!this.htmlMode && (this.isElementSimpleTextType() || this.isElementInnerHtmlEmpty())) {
            /**
             * If element does not contain complex html, then fallBack to default logic.
             */
            super.checkNodes(forceUpdate, translations);
        }
        else {
            this.htmlMode = true;
            if (this.isLookupKeyMissing()) {
                this._elementRef.nativeElement.lookupKey = this.getLookupKey();
            }
            if (this.lookupKeyExist()) {
                const newTranslation = this.getNewTranslation();
                if (!this.lastTranslation || this.lastTranslation !== newTranslation) {
                    this.lastTranslation = newTranslation;
                    this.updateHtmlContent();
                    this.htmlUpdateEvent.emit();
                }
            }
        }
    }
    ngOnDestroy() {
        this.htmlUpdateEvent.complete();
        super.ngOnDestroy();
    }
    /**
     * Builds lookup key from innerHTML, removes comments (that might be added by Angular) and trims it.
     */
    getLookupKey() {
        return this._elementRef.nativeElement.innerHTML.replace(/<!--.*?-->/gs, '').trim();
    }
    isElementSimpleTextType() {
        return this._elementRef.nativeElement.childNodes.length === 1 && this._elementRef.nativeElement.childNodes[0].nodeType === 3;
    }
    isElementInnerHtmlEmpty() {
        return !this._elementRef.nativeElement.innerHTML;
    }
    isLookupKeyMissing() {
        return !this._elementRef.nativeElement.lookupKey;
    }
    lookupKeyExist() {
        return this._elementRef.nativeElement.lookupKey;
    }
    getNewTranslation() {
        return this._translateService.instant(this._elementRef.nativeElement.lookupKey, this.currentParams || {});
    }
    updateHtmlContent() {
        this._elementRef.nativeElement.innerHTML = this.lastTranslation;
    }
}
C8yTranslateDirective.decorators = [
    { type: Directive, args: [{
                selector: '[translate],[ngx-translate]'
            },] }
];
C8yTranslateDirective.ctorParameters = () => [
    { type: TranslateService },
    { type: ElementRef },
    { type: ChangeDetectorRef }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYzh5LXRyYW5zbGF0ZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9jb3JlL2kxOG4vYzh5LXRyYW5zbGF0ZS5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGtCQUFrQixFQUFFLGdCQUFnQixFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDM0UsT0FBTyxFQUFFLGlCQUFpQixFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBS3ZGLE1BQU0sT0FBTyxxQkFBc0IsU0FBUSxrQkFBa0I7SUFnQzNELFlBQ0UsZ0JBQWtDLEVBQ2xDLE9BQW1CLEVBQ25CLElBQXVCO1FBQ3ZCLEtBQUssQ0FBQyxnQkFBZ0IsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFyQnpDOztXQUVHO1FBQ0gsb0JBQWUsR0FBdUIsSUFBSSxZQUFZLEVBQVEsQ0FBQztJQW1CL0QsQ0FBQztJQXBDRDs7T0FFRztJQUNILElBQVksV0FBVztRQUNyQixPQUFRLElBQVksQ0FBQyxPQUFPLENBQUM7SUFDL0IsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBWSxpQkFBaUI7UUFDM0IsT0FBUSxJQUFZLENBQUMsZ0JBQWdCLENBQUM7SUFDeEMsQ0FBQztJQTBCRDs7Ozs7OztPQU9HO0lBQ0gsVUFBVSxDQUFDLFdBQVcsR0FBRyxLQUFLLEVBQUUsWUFBa0I7UUFDaEQsSUFDRSxDQUFDLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsdUJBQXVCLEVBQUUsSUFBSSxJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQyxFQUNwRjtZQUNBOztlQUVHO1lBQ0gsS0FBSyxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsWUFBWSxDQUFDLENBQUM7U0FDN0M7YUFBTTtZQUNMLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1lBQ3JCLElBQUksSUFBSSxDQUFDLGtCQUFrQixFQUFFLEVBQUU7Z0JBQzdCLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7YUFDaEU7WUFDRCxJQUFJLElBQUksQ0FBQyxjQUFjLEVBQUUsRUFBRTtnQkFDekIsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7Z0JBQ2hELElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxJQUFJLElBQUksQ0FBQyxlQUFlLEtBQUssY0FBYyxFQUFFO29CQUNwRSxJQUFJLENBQUMsZUFBZSxHQUFHLGNBQWMsQ0FBQztvQkFDdEMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7b0JBQ3pCLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLENBQUM7aUJBQzdCO2FBQ0Y7U0FDRjtJQUNILENBQUM7SUFFRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLGVBQWUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUNoQyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDdEIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssWUFBWTtRQUNsQixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsY0FBYyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3JGLENBQUM7SUFFTyx1QkFBdUI7UUFDN0IsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxLQUFLLENBQUMsQ0FBQztJQUMvSCxDQUFDO0lBRU8sdUJBQXVCO1FBQzdCLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUM7SUFDbkQsQ0FBQztJQUVPLGtCQUFrQjtRQUN4QixPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDO0lBQ25ELENBQUM7SUFFTyxjQUFjO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDO0lBQ2xELENBQUM7SUFFTyxpQkFBaUI7UUFDdkIsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUNuQyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxTQUFTLEVBQ3hDLElBQUksQ0FBQyxhQUFhLElBQUksRUFBRSxDQUN6QixDQUFDO0lBQ0osQ0FBQztJQUVPLGlCQUFpQjtRQUN2QixJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQztJQUNsRSxDQUFDOzs7WUEvR0YsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSw2QkFBNkI7YUFDeEM7OztZQUw0QixnQkFBZ0I7WUFDTixVQUFVO1lBQXhDLGlCQUFpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRyYW5zbGF0ZURpcmVjdGl2ZSwgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJ0BuZ3gtdHJhbnNsYXRlL2NvcmUnO1xuaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0b3JSZWYsIERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbkBEaXJlY3RpdmUoe1xuICBzZWxlY3RvcjogJ1t0cmFuc2xhdGVdLFtuZ3gtdHJhbnNsYXRlXSdcbn0pXG5leHBvcnQgY2xhc3MgQzh5VHJhbnNsYXRlRGlyZWN0aXZlIGV4dGVuZHMgVHJhbnNsYXRlRGlyZWN0aXZlIHtcbiAgLyoqXG4gICAqIFVzZWQgdG8gZ2V0IHByaXZhdGUgZWxlbWVudCBwcm9wZXJ0eSBmcm9tIFRyYW5zbGF0ZURpcmVjdGl2ZSwgc28gaXQgZG9lc24ndCB0aHJvdyB0c0Vycm9yc1xuICAgKi9cbiAgcHJpdmF0ZSBnZXQgX2VsZW1lbnRSZWYoKTogRWxlbWVudFJlZiB7XG4gICAgcmV0dXJuICh0aGlzIGFzIGFueSkuZWxlbWVudDtcbiAgfVxuXG4gIC8qKlxuICAgKiBVc2VkIHRvIGdldCBwcml2YXRlIHRyYW5zbGF0ZVNlcnZpY2UgcHJvcGVydHkgZnJvbSBUcmFuc2xhdGVEaXJlY3RpdmUsIHNvIGl0IGRvZXNuJ3QgdGhyb3cgdHNFcnJvcnNcbiAgICovXG4gIHByaXZhdGUgZ2V0IF90cmFuc2xhdGVTZXJ2aWNlKCk6IFRyYW5zbGF0ZVNlcnZpY2Uge1xuICAgIHJldHVybiAodGhpcyBhcyBhbnkpLnRyYW5zbGF0ZVNlcnZpY2U7XG4gIH1cblxuICAvKipcbiAgICogVXNlZCB0byB0cmlnZ2VyIGV2ZW50cyB3aGVuIGh0bWwgaXMgcmVwbGFjZWQgYnkgZGlyZWN0aXZlLlxuICAgKi9cbiAgaHRtbFVwZGF0ZUV2ZW50OiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XG5cbiAgLyoqXG4gICAqIFdoZW4gdGhpcyBkaXJlY3RpdmUgc3VjY2Vzc2Z1bGx5IHRyYW5zbGF0ZXMgbm9kZSwgaXQgc3RvcmVzIGl0cyB2YWx1ZSBpbiB0aGlzIHByb3BlcnR5LlxuICAgKiBBbm90aGVyIHRyYW5zbGF0aW9uIHdpbGwgYmUgcGVyZm9ybWVkIG9ubHkgaWYgbmV3IHRyYW5zbGF0aW9uIHZhbHVlIGRpZmZlcnMgZnJvbSBzdG9yZWQgb25lLlxuICAgKi9cbiAgbGFzdFRyYW5zbGF0aW9uOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFdoZW4gdGhpcyBkaXJlY3RpdmUgZW5jb3VudGVycyBlbGVtZW50IHRoYXQgaXMgSFRNTCwgaXQgc2hvdWxkIHN3aXRjaCB0byBIdG1sIG1vZGUgZXZlbiBpZlxuICAgKiBuZXcgdHJhbnNsYXRlZCBlbGVtZW50IGRvZXMgbm90IGNvbnRhaW4gYW55IEhUTUwuXG4gICAqL1xuICBodG1sTW9kZTogYm9vbGVhbjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICB0cmFuc2xhdGVTZXJ2aWNlOiBUcmFuc2xhdGVTZXJ2aWNlLFxuICAgIGVsZW1lbnQ6IEVsZW1lbnRSZWYsXG4gICAgX3JlZjogQ2hhbmdlRGV0ZWN0b3JSZWYpIHtcbiAgICBzdXBlcih0cmFuc2xhdGVTZXJ2aWNlLCBlbGVtZW50LCBfcmVmKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBPdmVycmlkZGVuIG1ldGhvZCBmcm9tIG9yaWdpbmFsIGRpcmVjdGl2ZS5cbiAgICogRm9yIHNpbXBsZSB0ZXh0IG5vZGVzLCBpdCBqdXN0IGludm9rZXMgdGhlIGJhc2UgbWV0aG9kLlxuICAgKiBGb3IgY29tcGxleCBub2RlcywgaXQgYnVpbGRzIHRyYW5zbGF0aW9uIGtleSBmcm9tIHdob2xlIGlubmVyIEhUTUxcbiAgICogYW5kIHJlcGxhY2VzIGl0IHdpdGggaXRzIHRyYW5zbGF0aW9uLlxuICAgKiBUaGlzIHByZXZlbnRzIHNwbGl0dGluZyBIVE1MIGludG8gcGllY2VzIGFuZCBhdHRlbXB0aW5nIHRvIHRyYW5zbGF0ZSBlYWNoIG9uZSBzZXBhcmF0ZWx5XG4gICAqIHdoaWNoIGRvZXNuJ3Qgd29yaywgYmVjYXVzZSB3ZSBleHRyYWN0IHN0cmluZ3MgaW4gd2hvbGUuXG4gICAqL1xuICBjaGVja05vZGVzKGZvcmNlVXBkYXRlID0gZmFsc2UsIHRyYW5zbGF0aW9ucz86IGFueSkge1xuICAgIGlmIChcbiAgICAgICF0aGlzLmh0bWxNb2RlICYmICh0aGlzLmlzRWxlbWVudFNpbXBsZVRleHRUeXBlKCkgfHwgdGhpcy5pc0VsZW1lbnRJbm5lckh0bWxFbXB0eSgpKVxuICAgICkge1xuICAgICAgLyoqXG4gICAgICAgKiBJZiBlbGVtZW50IGRvZXMgbm90IGNvbnRhaW4gY29tcGxleCBodG1sLCB0aGVuIGZhbGxCYWNrIHRvIGRlZmF1bHQgbG9naWMuXG4gICAgICAgKi9cbiAgICAgIHN1cGVyLmNoZWNrTm9kZXMoZm9yY2VVcGRhdGUsIHRyYW5zbGF0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuaHRtbE1vZGUgPSB0cnVlO1xuICAgICAgaWYgKHRoaXMuaXNMb29rdXBLZXlNaXNzaW5nKCkpIHtcbiAgICAgICAgdGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50Lmxvb2t1cEtleSA9IHRoaXMuZ2V0TG9va3VwS2V5KCk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5sb29rdXBLZXlFeGlzdCgpKSB7XG4gICAgICAgIGNvbnN0IG5ld1RyYW5zbGF0aW9uID0gdGhpcy5nZXROZXdUcmFuc2xhdGlvbigpO1xuICAgICAgICBpZiAoIXRoaXMubGFzdFRyYW5zbGF0aW9uIHx8IHRoaXMubGFzdFRyYW5zbGF0aW9uICE9PSBuZXdUcmFuc2xhdGlvbikge1xuICAgICAgICAgIHRoaXMubGFzdFRyYW5zbGF0aW9uID0gbmV3VHJhbnNsYXRpb247XG4gICAgICAgICAgdGhpcy51cGRhdGVIdG1sQ29udGVudCgpO1xuICAgICAgICAgIHRoaXMuaHRtbFVwZGF0ZUV2ZW50LmVtaXQoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuaHRtbFVwZGF0ZUV2ZW50LmNvbXBsZXRlKCk7XG4gICAgc3VwZXIubmdPbkRlc3Ryb3koKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdWlsZHMgbG9va3VwIGtleSBmcm9tIGlubmVySFRNTCwgcmVtb3ZlcyBjb21tZW50cyAodGhhdCBtaWdodCBiZSBhZGRlZCBieSBBbmd1bGFyKSBhbmQgdHJpbXMgaXQuXG4gICAqL1xuICBwcml2YXRlIGdldExvb2t1cEtleSgpIHtcbiAgICByZXR1cm4gdGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmlubmVySFRNTC5yZXBsYWNlKC88IS0tLio/LS0+L2dzLCAnJykudHJpbSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0VsZW1lbnRTaW1wbGVUZXh0VHlwZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNoaWxkTm9kZXMubGVuZ3RoID09PSAxICYmIHRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5jaGlsZE5vZGVzWzBdLm5vZGVUeXBlID09PSAzO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0VsZW1lbnRJbm5lckh0bWxFbXB0eSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gIXRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5pbm5lckhUTUw7XG4gIH1cblxuICBwcml2YXRlIGlzTG9va3VwS2V5TWlzc2luZygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gIXRoaXMuX2VsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5sb29rdXBLZXk7XG4gIH1cblxuICBwcml2YXRlIGxvb2t1cEtleUV4aXN0KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQubG9va3VwS2V5O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXROZXdUcmFuc2xhdGlvbigpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl90cmFuc2xhdGVTZXJ2aWNlLmluc3RhbnQoXG4gICAgICB0aGlzLl9lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQubG9va3VwS2V5LFxuICAgICAgdGhpcy5jdXJyZW50UGFyYW1zIHx8IHt9XG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlSHRtbENvbnRlbnQoKTogdm9pZCB7XG4gICAgdGhpcy5fZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmlubmVySFRNTCA9IHRoaXMubGFzdFRyYW5zbGF0aW9uO1xuICB9XG59XG4iXX0=