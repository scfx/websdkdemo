import { Injectable } from '@angular/core';
import { PatternMessagesService } from './pattern-messages.service';
import { TranslateParser } from '@ngx-translate/core';
export class MissingTranslationCustomHandler {
    constructor(parser, patternMessagesService) {
        this.parser = parser;
        this.patternMessagesService = patternMessagesService;
        this.cache = {};
    }
    handle(params) {
        const { key: messageKey, interpolateParams, translateService } = params;
        this.translateService = translateService;
        let translation = this.getFromCache(messageKey, interpolateParams);
        if (!translation) {
            const patternMessageTranslation = this.getPatternMessageTranslation(messageKey, interpolateParams);
            if (patternMessageTranslation) {
                translation = patternMessageTranslation;
            }
            else {
                translation = this.parser.interpolate(messageKey, interpolateParams);
            }
            this.addToCache(messageKey, interpolateParams, translation);
        }
        return translation;
    }
    getFromCache(messageKey, interpolateParams) {
        const { currentLang } = this.translateService;
        const currentCache = this.cache[currentLang] || {};
        const cacheKey = this.getCacheKey(messageKey, interpolateParams);
        return currentCache[cacheKey];
    }
    addToCache(messageKey, interpolateParams, translation) {
        const { currentLang } = this.translateService;
        const currentCache = this.cache[currentLang] = this.cache[currentLang] || {};
        const cacheKey = this.getCacheKey(messageKey, interpolateParams);
        currentCache[cacheKey] = translation;
    }
    getCacheKey(messageKey, interpolateParams) {
        return interpolateParams ? `${messageKey} ${JSON.stringify(interpolateParams)}` : messageKey;
    }
    getPatternMessageTranslation(messageKey, interpolateParams) {
        const shouldTryPatternMessages = !interpolateParams || !(interpolateParams.noPatternMessages);
        if (shouldTryPatternMessages) {
            if (!this.patternMessagesService.translateService) {
                this.patternMessagesService.translateService = this.translateService;
            }
            return this.patternMessagesService.translate(messageKey);
        }
        return undefined;
    }
}
MissingTranslationCustomHandler.decorators = [
    { type: Injectable }
];
MissingTranslationCustomHandler.ctorParameters = () => [
    { type: TranslateParser },
    { type: PatternMessagesService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWlzc2luZy10cmFuc2xhdGlvbi1jdXN0b20uaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvaTE4bi9taXNzaW5nLXRyYW5zbGF0aW9uLWN1c3RvbS5oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDcEUsT0FBTyxFQUdMLGVBQWUsRUFFaEIsTUFBTSxxQkFBcUIsQ0FBQztBQUc3QixNQUFNLE9BQU8sK0JBQStCO0lBSTFDLFlBQ1UsTUFBdUIsRUFDdkIsc0JBQThDO1FBRDlDLFdBQU0sR0FBTixNQUFNLENBQWlCO1FBQ3ZCLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBd0I7UUFKeEQsVUFBSyxHQUFRLEVBQUUsQ0FBQztJQUtiLENBQUM7SUFFSixNQUFNLENBQUMsTUFBdUM7UUFDNUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxVQUFVLEVBQUUsaUJBQWlCLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxNQUFNLENBQUM7UUFDeEUsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDO1FBRXpDLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFFbkUsSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNoQixNQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxVQUFVLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztZQUNuRyxJQUFJLHlCQUF5QixFQUFFO2dCQUM3QixXQUFXLEdBQUcseUJBQXlCLENBQUM7YUFDekM7aUJBQU07Z0JBQ0wsV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO2FBQ3RFO1lBRUQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxVQUFVLEVBQUUsaUJBQWlCLEVBQUUsV0FBVyxDQUFDLENBQUM7U0FDN0Q7UUFFRCxPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDO0lBRU8sWUFBWSxDQUFDLFVBQWtCLEVBQUUsaUJBQXlCO1FBQ2hFLE1BQU0sRUFBRSxXQUFXLEVBQUUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7UUFDOUMsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDbkQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztRQUNqRSxPQUFPLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRU8sVUFBVSxDQUFDLFVBQWtCLEVBQUUsaUJBQXlCLEVBQUUsV0FBbUI7UUFDbkYsTUFBTSxFQUFFLFdBQVcsRUFBRSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQztRQUM5QyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzdFLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFDakUsWUFBWSxDQUFDLFFBQVEsQ0FBQyxHQUFHLFdBQVcsQ0FBQztJQUN2QyxDQUFDO0lBRU8sV0FBVyxDQUFDLFVBQWtCLEVBQUUsaUJBQXlCO1FBQy9ELE9BQU8saUJBQWlCLENBQUMsQ0FBQyxDQUFDLEdBQUcsVUFBVSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUM7SUFDL0YsQ0FBQztJQUVPLDRCQUE0QixDQUFDLFVBQWtCLEVBQUUsaUJBQXlCO1FBQ2hGLE1BQU0sd0JBQXdCLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSxDQUFDLENBQUUsaUJBQXlCLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUV2RyxJQUFJLHdCQUF3QixFQUFFO1lBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsc0JBQXNCLENBQUMsZ0JBQWdCLEVBQUU7Z0JBQ2pELElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7YUFDdEU7WUFDRCxPQUFPLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUM7U0FDMUQ7UUFFRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDOzs7WUEzREYsVUFBVTs7O1lBSlQsZUFBZTtZQUpSLHNCQUFzQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFBhdHRlcm5NZXNzYWdlc1NlcnZpY2UgfSBmcm9tICcuL3BhdHRlcm4tbWVzc2FnZXMuc2VydmljZSc7XG5pbXBvcnQge1xuICBNaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyLFxuICBNaXNzaW5nVHJhbnNsYXRpb25IYW5kbGVyUGFyYW1zLFxuICBUcmFuc2xhdGVQYXJzZXIsXG4gIFRyYW5zbGF0ZVNlcnZpY2Vcbn0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBNaXNzaW5nVHJhbnNsYXRpb25DdXN0b21IYW5kbGVyIGltcGxlbWVudHMgTWlzc2luZ1RyYW5zbGF0aW9uSGFuZGxlciB7XG4gIHRyYW5zbGF0ZVNlcnZpY2U6IFRyYW5zbGF0ZVNlcnZpY2U7XG4gIGNhY2hlOiBhbnkgPSB7fTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHBhcnNlcjogVHJhbnNsYXRlUGFyc2VyLFxuICAgIHByaXZhdGUgcGF0dGVybk1lc3NhZ2VzU2VydmljZTogUGF0dGVybk1lc3NhZ2VzU2VydmljZVxuICApIHt9XG5cbiAgaGFuZGxlKHBhcmFtczogTWlzc2luZ1RyYW5zbGF0aW9uSGFuZGxlclBhcmFtcykge1xuICAgIGNvbnN0IHsga2V5OiBtZXNzYWdlS2V5LCBpbnRlcnBvbGF0ZVBhcmFtcywgdHJhbnNsYXRlU2VydmljZSB9ID0gcGFyYW1zO1xuICAgIHRoaXMudHJhbnNsYXRlU2VydmljZSA9IHRyYW5zbGF0ZVNlcnZpY2U7XG5cbiAgICBsZXQgdHJhbnNsYXRpb24gPSB0aGlzLmdldEZyb21DYWNoZShtZXNzYWdlS2V5LCBpbnRlcnBvbGF0ZVBhcmFtcyk7XG5cbiAgICBpZiAoIXRyYW5zbGF0aW9uKSB7XG4gICAgICBjb25zdCBwYXR0ZXJuTWVzc2FnZVRyYW5zbGF0aW9uID0gdGhpcy5nZXRQYXR0ZXJuTWVzc2FnZVRyYW5zbGF0aW9uKG1lc3NhZ2VLZXksIGludGVycG9sYXRlUGFyYW1zKTtcbiAgICAgIGlmIChwYXR0ZXJuTWVzc2FnZVRyYW5zbGF0aW9uKSB7XG4gICAgICAgIHRyYW5zbGF0aW9uID0gcGF0dGVybk1lc3NhZ2VUcmFuc2xhdGlvbjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRyYW5zbGF0aW9uID0gdGhpcy5wYXJzZXIuaW50ZXJwb2xhdGUobWVzc2FnZUtleSwgaW50ZXJwb2xhdGVQYXJhbXMpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmFkZFRvQ2FjaGUobWVzc2FnZUtleSwgaW50ZXJwb2xhdGVQYXJhbXMsIHRyYW5zbGF0aW9uKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJhbnNsYXRpb247XG4gIH1cblxuICBwcml2YXRlIGdldEZyb21DYWNoZShtZXNzYWdlS2V5OiBzdHJpbmcsIGludGVycG9sYXRlUGFyYW1zOiBvYmplY3QpOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgY3VycmVudExhbmcgfSA9IHRoaXMudHJhbnNsYXRlU2VydmljZTtcbiAgICBjb25zdCBjdXJyZW50Q2FjaGUgPSB0aGlzLmNhY2hlW2N1cnJlbnRMYW5nXSB8fCB7fTtcbiAgICBjb25zdCBjYWNoZUtleSA9IHRoaXMuZ2V0Q2FjaGVLZXkobWVzc2FnZUtleSwgaW50ZXJwb2xhdGVQYXJhbXMpO1xuICAgIHJldHVybiBjdXJyZW50Q2FjaGVbY2FjaGVLZXldO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRUb0NhY2hlKG1lc3NhZ2VLZXk6IHN0cmluZywgaW50ZXJwb2xhdGVQYXJhbXM6IG9iamVjdCwgdHJhbnNsYXRpb246IHN0cmluZykge1xuICAgIGNvbnN0IHsgY3VycmVudExhbmcgfSA9IHRoaXMudHJhbnNsYXRlU2VydmljZTtcbiAgICBjb25zdCBjdXJyZW50Q2FjaGUgPSB0aGlzLmNhY2hlW2N1cnJlbnRMYW5nXSA9IHRoaXMuY2FjaGVbY3VycmVudExhbmddIHx8IHt9O1xuICAgIGNvbnN0IGNhY2hlS2V5ID0gdGhpcy5nZXRDYWNoZUtleShtZXNzYWdlS2V5LCBpbnRlcnBvbGF0ZVBhcmFtcyk7XG4gICAgY3VycmVudENhY2hlW2NhY2hlS2V5XSA9IHRyYW5zbGF0aW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDYWNoZUtleShtZXNzYWdlS2V5OiBzdHJpbmcsIGludGVycG9sYXRlUGFyYW1zOiBvYmplY3QpOiBzdHJpbmcge1xuICAgIHJldHVybiBpbnRlcnBvbGF0ZVBhcmFtcyA/IGAke21lc3NhZ2VLZXl9ICR7SlNPTi5zdHJpbmdpZnkoaW50ZXJwb2xhdGVQYXJhbXMpfWAgOiBtZXNzYWdlS2V5O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQYXR0ZXJuTWVzc2FnZVRyYW5zbGF0aW9uKG1lc3NhZ2VLZXk6IHN0cmluZywgaW50ZXJwb2xhdGVQYXJhbXM6IG9iamVjdCk6IHN0cmluZyB7XG4gICAgY29uc3Qgc2hvdWxkVHJ5UGF0dGVybk1lc3NhZ2VzID0gIWludGVycG9sYXRlUGFyYW1zIHx8ICEoKGludGVycG9sYXRlUGFyYW1zIGFzIGFueSkubm9QYXR0ZXJuTWVzc2FnZXMpO1xuXG4gICAgaWYgKHNob3VsZFRyeVBhdHRlcm5NZXNzYWdlcykge1xuICAgICAgaWYgKCF0aGlzLnBhdHRlcm5NZXNzYWdlc1NlcnZpY2UudHJhbnNsYXRlU2VydmljZSkge1xuICAgICAgICB0aGlzLnBhdHRlcm5NZXNzYWdlc1NlcnZpY2UudHJhbnNsYXRlU2VydmljZSA9IHRoaXMudHJhbnNsYXRlU2VydmljZTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLnBhdHRlcm5NZXNzYWdlc1NlcnZpY2UudHJhbnNsYXRlKG1lc3NhZ2VLZXkpO1xuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn1cbiJdfQ==