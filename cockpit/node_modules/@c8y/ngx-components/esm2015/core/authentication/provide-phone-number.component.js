import { __awaiter } from "tslib";
import { Component, Output, EventEmitter, Input } from '@angular/core';
import { LoginService } from '../login/login.service';
import { AlertService } from '../alert/alert.service';
import { LoginViews } from '../login/login.model';
import { UserService } from '@c8y/client';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '../login/login.service';
import * as ɵngcc2 from '../alert/alert.service';
import * as ɵngcc3 from '@c8y/client';
import * as ɵngcc4 from '@angular/forms';
import * as ɵngcc5 from '../i18n/c8y-translate.directive';
import * as ɵngcc6 from '../forms/form-group.component';
import * as ɵngcc7 from '@angular/common';
import * as ɵngcc8 from '../forms/required-input-placeholder.directive';
import * as ɵngcc9 from '../forms/phone-validation.directive';
import * as ɵngcc10 from '../forms/default-validation.directive';
import * as ɵngcc11 from '../i18n/c8y-translate.pipe';
export class ProvidePhoneNumberComponent {
    constructor(loginService, alert, userService) {
        this.loginService = loginService;
        this.alert = alert;
        this.userService = userService;
        this.onCancel = new EventEmitter();
        this.onChangeView = new EventEmitter();
        this.requestInProgress = false;
        this.sendTfa = '0';
    }
    save() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                this.requestInProgress = true;
                yield this.userService.savePhoneNumber(this.phoneNumber);
                yield this.sendTFASms();
                this.onChangeView.emit({
                    view: LoginViews.SmsChallenge,
                    credentials: this.credentials
                });
            }
            catch (e) {
                this.alert.addServerFailure(e);
            }
            finally {
                this.requestInProgress = false;
            }
        });
    }
    sendTFASms() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                yield this.userService.verifyTFACode(this.sendTfa);
            }
            catch (e) {
                if (e.res.status === 403) {
                    this.loginService.cleanMessages();
                    this.loginService.addSuccessMessage('send_sms');
                }
                else {
                    throw e;
                }
            }
        });
    }
}
ProvidePhoneNumberComponent.ɵfac = function ProvidePhoneNumberComponent_Factory(t) { return new (t || ProvidePhoneNumberComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.LoginService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.AlertService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.UserService)); };
ProvidePhoneNumberComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: ProvidePhoneNumberComponent, selectors: [["c8y-provide-phone-number"]], inputs: { credentials: "credentials" }, outputs: { onCancel: "onCancel", onChangeView: "onChangeView" }, decls: 19, vars: 18, consts: [["role", "form", "novalidate", "", 1, "loginForm", 3, "ngSubmit"], ["twoFactorForm", "ngForm"], ["translate", "", 1, "legend", "form-block", "center"], [3, "ngClass"], ["translate", ""], ["type", "text", "name", "phone", "autocomplete", "off", "c8yPhoneValidation", "", "c8yDefaultValidation", "phoneNumber", "required", "", 1, "form-control", 3, "ngModel", "placeholder", "ngModelChange"], ["contactPhone", "ngModel"], ["type", "submit", 1, "btn", "btn-primary", "btn-lg", "btn-block", "form-group", 3, "title", "disabled"], [1, "d-flex", "m-t-8"], ["href", "#", 1, "small", "pointer", "m-l-auto", 3, "title", "click"]], template: function ProvidePhoneNumberComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "form", 0, 1);
        ɵngcc0.ɵɵlistener("ngSubmit", function ProvidePhoneNumberComponent_Template_form_ngSubmit_0_listener() { return ctx.save(); });
        ɵngcc0.ɵɵelementStart(2, "div", 2);
        ɵngcc0.ɵɵtext(3, " Two-factor authentication ");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(4, "c8y-form-group", 3);
        ɵngcc0.ɵɵelementStart(5, "label", 4);
        ɵngcc0.ɵɵtext(6, "Provide your phone number");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(7, "input", 5, 6);
        ɵngcc0.ɵɵlistener("ngModelChange", function ProvidePhoneNumberComponent_Template_input_ngModelChange_7_listener($event) { return ctx.phoneNumber = $event; });
        ɵngcc0.ɵɵpipe(9, "translate");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(10, "button", 7);
        ɵngcc0.ɵɵpipe(11, "translate");
        ɵngcc0.ɵɵtext(12);
        ɵngcc0.ɵɵpipe(13, "translate");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementStart(14, "div", 8);
        ɵngcc0.ɵɵelementStart(15, "a", 9);
        ɵngcc0.ɵɵlistener("click", function ProvidePhoneNumberComponent_Template_a_click_15_listener() { return ctx.onCancel.emit(); });
        ɵngcc0.ɵɵpipe(16, "translate");
        ɵngcc0.ɵɵtext(17);
        ɵngcc0.ɵɵpipe(18, "translate");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        const _r0 = ɵngcc0.ɵɵreference(1);
        ɵngcc0.ɵɵadvance(4);
        ɵngcc0.ɵɵproperty("ngClass", ctx.requestInProgress || _r0.invalid ? "p-b-8" : "");
        ɵngcc0.ɵɵadvance(3);
        ɵngcc0.ɵɵpropertyInterpolate("placeholder", ɵngcc0.ɵɵpipeBind1(9, 8, "e.g. +49 9 876 543 210`LOCALIZE`"));
        ɵngcc0.ɵɵproperty("ngModel", ctx.phoneNumber);
        ɵngcc0.ɵɵadvance(3);
        ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(11, 10, "Save and continue"));
        ɵngcc0.ɵɵproperty("disabled", ctx.requestInProgress || _r0.invalid);
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(13, 12, "Save and continue"), " ");
        ɵngcc0.ɵɵadvance(3);
        ɵngcc0.ɵɵpropertyInterpolate("title", ɵngcc0.ɵɵpipeBind1(16, 14, "Login"));
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵtextInterpolate1(" ", ɵngcc0.ɵɵpipeBind1(18, 16, "Login"), " ");
    } }, directives: [ɵngcc4.ɵNgNoValidate, ɵngcc4.NgControlStatusGroup, ɵngcc4.NgForm, ɵngcc5.C8yTranslateDirective, ɵngcc6.FormGroupComponent, ɵngcc7.NgClass, ɵngcc8.RequiredInputPlaceholderDirective, ɵngcc4.DefaultValueAccessor, ɵngcc9.PhoneValidationDirective, ɵngcc10.DefaultValidationDirective, ɵngcc4.RequiredValidator, ɵngcc4.NgControlStatus, ɵngcc4.NgModel], pipes: [ɵngcc11.C8yTranslatePipe], encapsulation: 2 });
ProvidePhoneNumberComponent.ctorParameters = () => [
    { type: LoginService },
    { type: AlertService },
    { type: UserService }
];
ProvidePhoneNumberComponent.propDecorators = {
    credentials: [{ type: Input }],
    onCancel: [{ type: Output }],
    onChangeView: [{ type: Output }]
};
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(ProvidePhoneNumberComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-provide-phone-number',
                template: "<form #twoFactorForm=\"ngForm\" role=\"form\" class=\"loginForm\" (ngSubmit)=\"save()\" novalidate>\n  <div class=\"legend form-block center\" translate>\n    Two-factor authentication\n  </div>\n\n  <c8y-form-group [ngClass]=\"requestInProgress || twoFactorForm.invalid ? 'p-b-8' : ''\">\n    <label translate>Provide your phone number</label>\n\n    <input\n      class=\"form-control\"\n      [(ngModel)]=\"phoneNumber\"\n      #contactPhone=\"ngModel\"\n      type=\"text\"\n      name=\"phone\"\n      autocomplete=\"off\"\n      placeholder=\"{{ 'e.g. +49 9 876 543 210`LOCALIZE`' | translate }}\"\n      c8yPhoneValidation\n      c8yDefaultValidation=\"phoneNumber\"\n      required\n    />\n  </c8y-form-group>\n\n  <button\n    title=\"{{ 'Save and continue' | translate }}\"\n    type=\"submit\"\n    class=\"btn btn-primary btn-lg btn-block form-group\"\n    [disabled]=\"requestInProgress || twoFactorForm.invalid\"\n  >\n    {{ 'Save and continue' | translate }}\n  </button>\n\n  <div class=\"d-flex m-t-8\">\n    <a\n      title=\"{{ 'Login' | translate }}\"\n      class=\"small pointer m-l-auto\"\n      href=\"#\"\n      (click)=\"onCancel.emit()\"\n    >\n      {{ 'Login' | translate }}\n    </a>\n  </div>\n</form>\n"
            }]
    }], function () { return [{ type: ɵngcc1.LoginService }, { type: ɵngcc2.AlertService }, { type: ɵngcc3.UserService }]; }, { onCancel: [{
            type: Output
        }], onChangeView: [{
            type: Output
        }], credentials: [{
            type: Input
        }] }); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZS1waG9uZS1udW1iZXIuY29tcG9uZW50LmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9jb3JlL2F1dGhlbnRpY2F0aW9uL3Byb3ZpZGUtcGhvbmUtbnVtYmVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3RELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQWdCLFdBQVcsRUFBRSxNQUFNLGFBQWEsQ0FBQzs7Ozs7Ozs7Ozs7OztBQU14RCxNQUFNLE9BQU8sMkJBQTJCO0FBQ3hDLElBUUUsWUFDUyxZQUEwQixFQUMxQixLQUFtQixFQUNsQixXQUF3QjtBQUNqQyxRQUhRLGlCQUFZLEdBQVosWUFBWSxDQUFjO0FBQUMsUUFDM0IsVUFBSyxHQUFMLEtBQUssQ0FBYztBQUFDLFFBQ25CLGdCQUFXLEdBQVgsV0FBVyxDQUFhO0FBQ3BDLFFBWFksYUFBUSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7QUFDMUMsUUFBWSxpQkFBWSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7QUFDOUMsUUFFRSxzQkFBaUIsR0FBRyxLQUFLLENBQUM7QUFDNUIsUUFBbUIsWUFBTyxHQUFXLEdBQUcsQ0FBQztBQUN6QyxJQUtLLENBQUM7QUFDTixJQUNRLElBQUk7QUFDWjtBQUVlLFlBRlgsSUFBSTtBQUNSLGdCQUFNLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUM7QUFDcEMsZ0JBQU0sTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDL0QsZ0JBQU0sTUFBTSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7QUFDOUIsZ0JBQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUM7QUFDN0Isb0JBQVEsSUFBSSxFQUFFLFVBQVUsQ0FBQyxZQUFZO0FBQ3JDLG9CQUFRLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVztBQUNyQyxpQkFBTyxDQUFDLENBQUM7QUFDVCxhQUFLO0FBQUMsWUFBQSxPQUFPLENBQUMsRUFBRTtBQUNoQixnQkFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3JDLGFBQUs7QUFBQyxvQkFBUTtBQUNkLGdCQUFNLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxLQUFLLENBQUM7QUFDckMsYUFBSztBQUNMLFFBQUUsQ0FBQztBQUVGLEtBRkU7QUFDSCxJQUNnQixVQUFVO0FBQzFCO0FBQ29ELFlBRGhELElBQUk7QUFDUixnQkFBTSxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN6RCxhQUFLO0FBQUMsWUFBQSxPQUFPLENBQUMsRUFBRTtBQUNoQixnQkFBTSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxLQUFLLEdBQUcsRUFBRTtBQUNoQyxvQkFBUSxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsRUFBRSxDQUFDO0FBQzFDLG9CQUFRLElBQUksQ0FBQyxZQUFZLENBQUMsaUJBQWlCLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDeEQsaUJBQU87QUFBQyxxQkFBSztBQUNiLG9CQUFRLE1BQU0sQ0FBQyxDQUFDO0FBQ2hCLGlCQUFPO0FBQ1AsYUFBSztBQUNMLFFBQUUsQ0FBQztBQUVILEtBRkc7QUFDSDt1REEvQ0MsU0FBUyxTQUFDLGtCQUNULFFBQVEsRUFBRSwwQkFBMEIsa0JBQ3BDOzs7K0VBQW9ELGNBQ3JEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O3VhQUNJO0FBQUM7QUFDVSxZQVZQLFlBQVk7QUFBSSxZQUNoQixZQUFZO0FBQUksWUFFRixXQUFXO0FBQUc7QUFBRztBQUd4QiwwQkFJYixLQUFLO0FBQUssdUJBQ1YsTUFBTTtBQUFLLDJCQUNYLE1BQU07QUFBSTs7Ozs7Ozs7Ozs7OztvQkFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPdXRwdXQsIEV2ZW50RW1pdHRlciwgSW5wdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IExvZ2luU2VydmljZSB9IGZyb20gJy4uL2xvZ2luL2xvZ2luLnNlcnZpY2UnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlIH0gZnJvbSAnLi4vYWxlcnQvYWxlcnQuc2VydmljZSc7XG5pbXBvcnQgeyBMb2dpblZpZXdzIH0gZnJvbSAnLi4vbG9naW4vbG9naW4ubW9kZWwnO1xuaW1wb3J0IHsgSUNyZWRlbnRpYWxzLCBVc2VyU2VydmljZSB9IGZyb20gJ0BjOHkvY2xpZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXByb3ZpZGUtcGhvbmUtbnVtYmVyJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3Byb3ZpZGUtcGhvbmUtbnVtYmVyLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBQcm92aWRlUGhvbmVOdW1iZXJDb21wb25lbnQge1xuICBASW5wdXQoKSBjcmVkZW50aWFsczogSUNyZWRlbnRpYWxzO1xuICBAT3V0cHV0KCkgb25DYW5jZWwgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBvbkNoYW5nZVZpZXcgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgcGhvbmVOdW1iZXI6IHN0cmluZztcbiAgcmVxdWVzdEluUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgcHJpdmF0ZSByZWFkb25seSBzZW5kVGZhOiBzdHJpbmcgPSAnMCc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGxvZ2luU2VydmljZTogTG9naW5TZXJ2aWNlLFxuICAgIHB1YmxpYyBhbGVydDogQWxlcnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgdXNlclNlcnZpY2U6IFVzZXJTZXJ2aWNlXG4gICkge31cblxuICBhc3luYyBzYXZlKCkge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLnJlcXVlc3RJblByb2dyZXNzID0gdHJ1ZTtcbiAgICAgIGF3YWl0IHRoaXMudXNlclNlcnZpY2Uuc2F2ZVBob25lTnVtYmVyKHRoaXMucGhvbmVOdW1iZXIpO1xuICAgICAgYXdhaXQgdGhpcy5zZW5kVEZBU21zKCk7XG4gICAgICB0aGlzLm9uQ2hhbmdlVmlldy5lbWl0KHtcbiAgICAgICAgdmlldzogTG9naW5WaWV3cy5TbXNDaGFsbGVuZ2UsXG4gICAgICAgIGNyZWRlbnRpYWxzOiB0aGlzLmNyZWRlbnRpYWxzXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aGlzLmFsZXJ0LmFkZFNlcnZlckZhaWx1cmUoZSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMucmVxdWVzdEluUHJvZ3Jlc3MgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNlbmRURkFTbXMoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMudXNlclNlcnZpY2UudmVyaWZ5VEZBQ29kZSh0aGlzLnNlbmRUZmEpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlLnJlcy5zdGF0dXMgPT09IDQwMykge1xuICAgICAgICB0aGlzLmxvZ2luU2VydmljZS5jbGVhbk1lc3NhZ2VzKCk7XG4gICAgICAgIHRoaXMubG9naW5TZXJ2aWNlLmFkZFN1Y2Nlc3NNZXNzYWdlKCdzZW5kX3NtcycpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==