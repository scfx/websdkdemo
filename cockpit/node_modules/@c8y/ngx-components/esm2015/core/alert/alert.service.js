import { BehaviorSubject } from 'rxjs';
import { Injectable } from '@angular/core';
import { StateService } from '../common/state-service.abstract';
import { gettext } from '../i18n/gettext';
import { isEqual } from 'lodash-es';
import * as i0 from "@angular/core";
/**
 * A service which allows to display alerts.
 */
import * as ɵngcc0 from '@angular/core';
export class AlertService extends StateService {
    constructor() {
        super(...arguments);
        /**
         * @ignore
         */
        this.state$ = new BehaviorSubject([]);
        this.MAX_ALERTS = 3;
        this.ALERT_TIMEOUT = 3000;
    }
    /**
     * Returns all alerts.
     * @readonly
     */
    get state() {
        return this.state$.value;
    }
    /**
     * Adds a new alert to the current state.
     */
    add(alert) {
        this.addAlert(alert);
    }
    /**
     * Adds a alert by text.
     */
    addByText(type, txt, detailedData) {
        this.addAlert({ text: txt, type, detailedData });
    }
    /**
     * Returns all alerts.
     * @deprecated Use alertService.alerts instead.
     */
    list() {
        return this.state;
    }
    /**
     * Remove an alert from the current state.
     */
    remove(alert) {
        this.changeAlerts(this.state.filter(item => !this.areSame(alert, item)));
    }
    /**
     * Updates matching alert with provided values.
     */
    update(alert, fieldsToUpdate) {
        this.changeAlerts(this.state.map(item => {
            if (this.areSame(alert, item)) {
                Object.assign(item, fieldsToUpdate);
            }
            return item;
        }));
    }
    /**
     * Removes last danger alert.
     * It can be used e.g. in the case of a failed request which triggered an alert, to hide it from user.
     *
     * ```js
     *  try {
     *    // something that might throw a danger server msg
     *  } catch (ex) {
     *   this.alertService.removeLastDanger();
     *  }
     * ```
     */
    removeLastDanger() {
        const firstDangerAlert = this.state.reverse().find(({ type }) => type === 'danger');
        this.changeAlerts(this.state.filter(alert => alert !== firstDangerAlert));
    }
    /**
     * Shorthand for a save successful alert.
     * @param savedObject The object which was saved.
     * @return A function that can be executed to show the msg.
     */
    saveSuccess(savedObject) {
        return () => {
            const text = `${savedObject} saved successfully`;
            this.addByText('success', text);
        };
    }
    /**
     * Shorthand for a create successful alert.
     * @param createdObject The object which was created.
     * @return A function that can be executed to show the msg.
     */
    createSuccess(createdObject) {
        return () => {
            const text = `${createdObject} created successfully`;
            this.addByText('success', text);
        };
    }
    /**
     * Clears all alerts.
     */
    clearAll() {
        this.changeAlerts([]);
    }
    /**
     * A shorthand to display a simple success message.
     * @param text The success text.
     * @param detailedData The text with additional information.
     */
    success(text, detailedData) {
        this.addByText('success', text, detailedData);
    }
    /**
     * A shorthand to display a simple danger message.
     * @param text The danger text.
     * @param detailedData The text with additional information.
     */
    danger(text, detailedData) {
        this.addByText('danger', text, detailedData);
    }
    /**
     * A shorthand to display a simple info message.
     * @param text The info text.
     * @param detailedData The text with additional information.
     */
    info(text, detailedData) {
        this.addByText('info', text, detailedData);
    }
    /**
     * A shorthand to display a simple warning message.
     * @param text The warning text.
     * @param detailedData The text with additional information.
     */
    warning(text, detailedData) {
        this.addByText('warning', text, detailedData);
    }
    /**
     * Creates alert from standard api errors.
     * Should be used for errors generated by @c8y/client services.
     * @param {IResult}  error The error from server.
     * @param {alertType} type The type of alert.
     */
    addServerFailure(error, type = 'danger') {
        const { data, res } = error;
        let text = (data === null || data === void 0 ? void 0 : data.message) || null;
        let detailedData;
        if (data) {
            if (typeof data === 'object') {
                detailedData = data.exceptionMessage;
            }
            else if (typeof data === 'string') {
                detailedData = data;
            }
        }
        const hasRelevantMessage = !!(text || detailedData);
        if (!text) {
            text = gettext('A server error occurred.');
        }
        if (res && !hasRelevantMessage) {
            detailedData = {
                status: res.status,
                statusText: res.statusText,
                url: res.url
            };
        }
        this.addAlert({
            type,
            text,
            detailedData
        });
    }
    /**
     * Compares two alert objects. Alerts are same if text, type, detailed data and callbacks are same.
     * Callbacks are same if they refer to the same function.
     */
    areSame(alert1, alert2) {
        return (alert1.text === alert2.text &&
            alert1.type === alert2.type &&
            isEqual(alert1.detailedData, alert2.detailedData) &&
            alert1.onClose === alert2.onClose &&
            alert1.onDetail === alert2.onDetail);
    }
    changeAlerts(newAlerts) {
        this.state$.next(newAlerts);
    }
    addAlert(alert) {
        if (!alert.text && !alert.type) {
            throw new Error('Cannot add empty alert');
        }
        const alertAlreadyAdded = this.state.find(item => this.areSame(alert, item));
        if (alertAlreadyAdded) {
            return;
        }
        this.changeAlerts([...this.state, alert]);
        this.hideAutomaticallyIfNeeded(alert);
        this.removeOldestIfMax();
    }
    hideAutomaticallyIfNeeded(alert) {
        const isSuccess = alert.type === 'success';
        const noDetails = !alert.detailedData;
        let alertTimeout = isSuccess && noDetails ? this.ALERT_TIMEOUT : 0;
        if (typeof alert.timeout !== 'undefined') {
            alertTimeout = alert.timeout;
        }
        if (alertTimeout) {
            setTimeout(() => this.remove(alert), alertTimeout);
        }
    }
    removeOldestIfMax() {
        if (this.state.length > this.MAX_ALERTS) {
            const [, ...firstRemoved] = this.state;
            this.changeAlerts(firstRemoved);
        }
    }
}
AlertService.ɵfac = /*@__PURE__*/ function () { let ɵAlertService_BaseFactory; return function AlertService_Factory(t) { return (ɵAlertService_BaseFactory || (ɵAlertService_BaseFactory = ɵngcc0.ɵɵgetInheritedFactory(AlertService)))(t || AlertService); }; }();
AlertService.ɵprov = i0.ɵɵdefineInjectable({ factory: function AlertService_Factory() { return new AlertService(); }, token: AlertService, providedIn: "root" });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(AlertService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], null, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxlcnQuc2VydmljZS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9hbGVydC9hbGVydC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDaEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRTFDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDcEM7QUFFQTtBQUNBO0FBQ0EsR0FBRzs7QUFJSCxNQUFNLE9BQU8sWUFBYSxTQUFRLFlBQVk7QUFDOUMsSUFKQTtBQUNFO0FBRUssUUFRTDtBQUNGO0FBRUEsV0FESztBQUNMLFFBQUUsV0FBTSxHQUFHLElBQUksZUFBZSxDQUFVLEVBQUUsQ0FBQyxDQUFDO0FBQzVDLFFBQ1UsZUFBVSxHQUFHLENBQUMsQ0FBQztBQUN6QixRQUFVLGtCQUFhLEdBQUcsSUFBSSxDQUFDO0FBQy9CLEtBdU5DO0FBQ0QsSUF0T0U7QUFDRjtBQUNFO0FBQ0UsT0FBQztBQUNMLElBQUUsSUFBSSxLQUFLO0FBQ1gsUUFBSSxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO0FBQzdCLElBQUUsQ0FBQztBQUNILElBUUU7QUFDRjtBQUNFLE9BQUc7QUFDTCxJQUFFLEdBQUcsQ0FBQyxLQUFZO0FBQ2xCLFFBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN6QixJQUFFLENBQUM7QUFDSCxJQUNFO0FBQ0Y7QUFDRSxPQUFHO0FBQ0wsSUFBRSxTQUFTLENBQUMsSUFBZSxFQUFFLEdBQVcsRUFBRSxZQUFxQjtBQUFJLFFBQy9ELElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLElB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S0FBSyxDQUFDLEVBQUUsWUFBWSxDQUFDLENBQUM7QUFDekQsU0FBSztBQUNMLElBQUUsQ0FBQztBQUNILElBQ1UsaUJBQWlCO0FBQzNCLFFBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFO0FBQzdDLFlBQU0sTUFBTSxDQUFDLEVBQUUsR0FBRyxZQUFZLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO0FBQzdDLFlBQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUN0QyxTQUFLO0FBQ0wsSUFBRSxDQUFDO0FBQ0g7bVFBQUM7QUFDRDt3Q0ExT0MsVUFBVSxTQUFDLGtCQUNWLFVBQVUsRUFBRSxNQUFNO0NBQ25COzs7OzBCQUNJO0FBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBbGVydCB9IGZyb20gJy4vYWxlcnQubW9kZWwnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdGF0ZVNlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vc3RhdGUtc2VydmljZS5hYnN0cmFjdCc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnLi4vaTE4bi9nZXR0ZXh0JztcbmltcG9ydCB7IElSZXN1bHQgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBpc0VxdWFsIH0gZnJvbSAnbG9kYXNoLWVzJztcblxudHlwZSBhbGVydFR5cGUgPSAnc3VjY2VzcycgfCAnd2FybmluZycgfCAnZGFuZ2VyJyB8ICdpbmZvJyB8ICdzeXN0ZW0nO1xuLyoqXG4gKiBBIHNlcnZpY2Ugd2hpY2ggYWxsb3dzIHRvIGRpc3BsYXkgYWxlcnRzLlxuICovXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBBbGVydFNlcnZpY2UgZXh0ZW5kcyBTdGF0ZVNlcnZpY2Uge1xuICAvKipcbiAgICogUmV0dXJucyBhbGwgYWxlcnRzLlxuICAgKiBAcmVhZG9ubHlcbiAgICovXG4gIGdldCBzdGF0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5zdGF0ZSQudmFsdWU7XG4gIH1cbiAgLyoqXG4gICAqIEBpZ25vcmVcbiAgICovXG4gIHN0YXRlJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8QWxlcnRbXT4oW10pO1xuXG4gIHByaXZhdGUgTUFYX0FMRVJUUyA9IDM7XG4gIHByaXZhdGUgQUxFUlRfVElNRU9VVCA9IDMwMDA7XG5cbiAgLyoqXG4gICAqIEFkZHMgYSBuZXcgYWxlcnQgdG8gdGhlIGN1cnJlbnQgc3RhdGUuXG4gICAqL1xuICBhZGQoYWxlcnQ6IEFsZXJ0KSB7XG4gICAgdGhpcy5hZGRBbGVydChhbGVydCk7XG4gIH1cblxuICAvKipcbiAgICogQWRkcyBhIGFsZXJ0IGJ5IHRleHQuXG4gICAqL1xuICBhZGRCeVRleHQodHlwZTogYWxlcnRUeXBlLCB0eHQ6IHN0cmluZywgZGV0YWlsZWREYXRhPzogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5hZGRBbGVydCh7IHRleHQ6IHR4dCwgdHlwZSwgZGV0YWlsZWREYXRhIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYWxsIGFsZXJ0cy5cbiAgICogQGRlcHJlY2F0ZWQgVXNlIGFsZXJ0U2VydmljZS5hbGVydHMgaW5zdGVhZC5cbiAgICovXG4gIGxpc3QoKTogQWxlcnRbXSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhdGU7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGFuIGFsZXJ0IGZyb20gdGhlIGN1cnJlbnQgc3RhdGUuXG4gICAqL1xuICByZW1vdmUoYWxlcnQ6IEFsZXJ0KSB7XG4gICAgdGhpcy5jaGFuZ2VBbGVydHModGhpcy5zdGF0ZS5maWx0ZXIoaXRlbSA9PiAhdGhpcy5hcmVTYW1lKGFsZXJ0LCBpdGVtKSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgbWF0Y2hpbmcgYWxlcnQgd2l0aCBwcm92aWRlZCB2YWx1ZXMuXG4gICAqL1xuICB1cGRhdGUoYWxlcnQ6IEFsZXJ0LCBmaWVsZHNUb1VwZGF0ZTogUGFydGlhbDxBbGVydD4pIHtcbiAgICB0aGlzLmNoYW5nZUFsZXJ0cyhcbiAgICAgIHRoaXMuc3RhdGUubWFwKGl0ZW0gPT4ge1xuICAgICAgICBpZiAodGhpcy5hcmVTYW1lKGFsZXJ0LCBpdGVtKSkge1xuICAgICAgICAgIE9iamVjdC5hc3NpZ24oaXRlbSwgZmllbGRzVG9VcGRhdGUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpdGVtO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgbGFzdCBkYW5nZXIgYWxlcnQuXG4gICAqIEl0IGNhbiBiZSB1c2VkIGUuZy4gaW4gdGhlIGNhc2Ugb2YgYSBmYWlsZWQgcmVxdWVzdCB3aGljaCB0cmlnZ2VyZWQgYW4gYWxlcnQsIHRvIGhpZGUgaXQgZnJvbSB1c2VyLlxuICAgKlxuICAgKiBgYGBqc1xuICAgKiAgdHJ5IHtcbiAgICogICAgLy8gc29tZXRoaW5nIHRoYXQgbWlnaHQgdGhyb3cgYSBkYW5nZXIgc2VydmVyIG1zZ1xuICAgKiAgfSBjYXRjaCAoZXgpIHtcbiAgICogICB0aGlzLmFsZXJ0U2VydmljZS5yZW1vdmVMYXN0RGFuZ2VyKCk7XG4gICAqICB9XG4gICAqIGBgYFxuICAgKi9cbiAgcmVtb3ZlTGFzdERhbmdlcigpIHtcbiAgICBjb25zdCBmaXJzdERhbmdlckFsZXJ0ID0gdGhpcy5zdGF0ZS5yZXZlcnNlKCkuZmluZCgoeyB0eXBlIH0pID0+IHR5cGUgPT09ICdkYW5nZXInKTtcbiAgICB0aGlzLmNoYW5nZUFsZXJ0cyh0aGlzLnN0YXRlLmZpbHRlcihhbGVydCA9PiBhbGVydCAhPT0gZmlyc3REYW5nZXJBbGVydCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNob3J0aGFuZCBmb3IgYSBzYXZlIHN1Y2Nlc3NmdWwgYWxlcnQuXG4gICAqIEBwYXJhbSBzYXZlZE9iamVjdCBUaGUgb2JqZWN0IHdoaWNoIHdhcyBzYXZlZC5cbiAgICogQHJldHVybiBBIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIGV4ZWN1dGVkIHRvIHNob3cgdGhlIG1zZy5cbiAgICovXG4gIHNhdmVTdWNjZXNzKHNhdmVkT2JqZWN0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY29uc3QgdGV4dCA9IGAke3NhdmVkT2JqZWN0fSBzYXZlZCBzdWNjZXNzZnVsbHlgO1xuICAgICAgdGhpcy5hZGRCeVRleHQoJ3N1Y2Nlc3MnLCB0ZXh0KTtcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFNob3J0aGFuZCBmb3IgYSBjcmVhdGUgc3VjY2Vzc2Z1bCBhbGVydC5cbiAgICogQHBhcmFtIGNyZWF0ZWRPYmplY3QgVGhlIG9iamVjdCB3aGljaCB3YXMgY3JlYXRlZC5cbiAgICogQHJldHVybiBBIGZ1bmN0aW9uIHRoYXQgY2FuIGJlIGV4ZWN1dGVkIHRvIHNob3cgdGhlIG1zZy5cbiAgICovXG4gIGNyZWF0ZVN1Y2Nlc3MoY3JlYXRlZE9iamVjdCkge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXh0ID0gYCR7Y3JlYXRlZE9iamVjdH0gY3JlYXRlZCBzdWNjZXNzZnVsbHlgO1xuICAgICAgdGhpcy5hZGRCeVRleHQoJ3N1Y2Nlc3MnLCB0ZXh0KTtcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFycyBhbGwgYWxlcnRzLlxuICAgKi9cbiAgY2xlYXJBbGwoKSB7XG4gICAgdGhpcy5jaGFuZ2VBbGVydHMoW10pO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgc2hvcnRoYW5kIHRvIGRpc3BsYXkgYSBzaW1wbGUgc3VjY2VzcyBtZXNzYWdlLlxuICAgKiBAcGFyYW0gdGV4dCBUaGUgc3VjY2VzcyB0ZXh0LlxuICAgKiBAcGFyYW0gZGV0YWlsZWREYXRhIFRoZSB0ZXh0IHdpdGggYWRkaXRpb25hbCBpbmZvcm1hdGlvbi5cbiAgICovXG4gIHN1Y2Nlc3ModGV4dDogc3RyaW5nLCBkZXRhaWxlZERhdGE/OiBzdHJpbmcpIHtcbiAgICB0aGlzLmFkZEJ5VGV4dCgnc3VjY2VzcycsIHRleHQsIGRldGFpbGVkRGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQSBzaG9ydGhhbmQgdG8gZGlzcGxheSBhIHNpbXBsZSBkYW5nZXIgbWVzc2FnZS5cbiAgICogQHBhcmFtIHRleHQgVGhlIGRhbmdlciB0ZXh0LlxuICAgKiBAcGFyYW0gZGV0YWlsZWREYXRhIFRoZSB0ZXh0IHdpdGggYWRkaXRpb25hbCBpbmZvcm1hdGlvbi5cbiAgICovXG4gIGRhbmdlcih0ZXh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZykge1xuICAgIHRoaXMuYWRkQnlUZXh0KCdkYW5nZXInLCB0ZXh0LCBkZXRhaWxlZERhdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIEEgc2hvcnRoYW5kIHRvIGRpc3BsYXkgYSBzaW1wbGUgaW5mbyBtZXNzYWdlLlxuICAgKiBAcGFyYW0gdGV4dCBUaGUgaW5mbyB0ZXh0LlxuICAgKiBAcGFyYW0gZGV0YWlsZWREYXRhIFRoZSB0ZXh0IHdpdGggYWRkaXRpb25hbCBpbmZvcm1hdGlvbi5cbiAgICovXG4gIGluZm8odGV4dDogc3RyaW5nLCBkZXRhaWxlZERhdGE/OiBzdHJpbmcpIHtcbiAgICB0aGlzLmFkZEJ5VGV4dCgnaW5mbycsIHRleHQsIGRldGFpbGVkRGF0YSk7XG4gIH1cblxuICAvKipcbiAgICogQSBzaG9ydGhhbmQgdG8gZGlzcGxheSBhIHNpbXBsZSB3YXJuaW5nIG1lc3NhZ2UuXG4gICAqIEBwYXJhbSB0ZXh0IFRoZSB3YXJuaW5nIHRleHQuXG4gICAqIEBwYXJhbSBkZXRhaWxlZERhdGEgVGhlIHRleHQgd2l0aCBhZGRpdGlvbmFsIGluZm9ybWF0aW9uLlxuICAgKi9cbiAgd2FybmluZyh0ZXh0OiBzdHJpbmcsIGRldGFpbGVkRGF0YT86IHN0cmluZykge1xuICAgIHRoaXMuYWRkQnlUZXh0KCd3YXJuaW5nJywgdGV4dCwgZGV0YWlsZWREYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGFsZXJ0IGZyb20gc3RhbmRhcmQgYXBpIGVycm9ycy5cbiAgICogU2hvdWxkIGJlIHVzZWQgZm9yIGVycm9ycyBnZW5lcmF0ZWQgYnkgQGM4eS9jbGllbnQgc2VydmljZXMuXG4gICAqIEBwYXJhbSB7SVJlc3VsdH0gIGVycm9yIFRoZSBlcnJvciBmcm9tIHNlcnZlci5cbiAgICogQHBhcmFtIHthbGVydFR5cGV9IHR5cGUgVGhlIHR5cGUgb2YgYWxlcnQuXG4gICAqL1xuICBhZGRTZXJ2ZXJGYWlsdXJlKGVycm9yOiBhbnksIHR5cGU6IGFsZXJ0VHlwZSA9ICdkYW5nZXInKSB7XG4gICAgY29uc3QgeyBkYXRhLCByZXMgfSA9IGVycm9yO1xuICAgIGxldCB0ZXh0ID0gZGF0YT8ubWVzc2FnZSB8fCBudWxsO1xuICAgIGxldCBkZXRhaWxlZERhdGE7XG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgZGV0YWlsZWREYXRhID0gZGF0YS5leGNlcHRpb25NZXNzYWdlO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgZGF0YSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgZGV0YWlsZWREYXRhID0gZGF0YTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgaGFzUmVsZXZhbnRNZXNzYWdlID0gISEodGV4dCB8fCBkZXRhaWxlZERhdGEpO1xuICAgIGlmICghdGV4dCkge1xuICAgICAgdGV4dCA9IGdldHRleHQoJ0Egc2VydmVyIGVycm9yIG9jY3VycmVkLicpO1xuICAgIH1cbiAgICBpZiAocmVzICYmICFoYXNSZWxldmFudE1lc3NhZ2UpIHtcbiAgICAgIGRldGFpbGVkRGF0YSA9IHtcbiAgICAgICAgc3RhdHVzOiByZXMuc3RhdHVzLFxuICAgICAgICBzdGF0dXNUZXh0OiByZXMuc3RhdHVzVGV4dCxcbiAgICAgICAgdXJsOiByZXMudXJsXG4gICAgICB9O1xuICAgIH1cblxuICAgIHRoaXMuYWRkQWxlcnQoe1xuICAgICAgdHlwZSxcbiAgICAgIHRleHQsXG4gICAgICBkZXRhaWxlZERhdGFcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb21wYXJlcyB0d28gYWxlcnQgb2JqZWN0cy4gQWxlcnRzIGFyZSBzYW1lIGlmIHRleHQsIHR5cGUsIGRldGFpbGVkIGRhdGEgYW5kIGNhbGxiYWNrcyBhcmUgc2FtZS5cbiAgICogQ2FsbGJhY2tzIGFyZSBzYW1lIGlmIHRoZXkgcmVmZXIgdG8gdGhlIHNhbWUgZnVuY3Rpb24uXG4gICAqL1xuICBhcmVTYW1lKGFsZXJ0MTogQWxlcnQsIGFsZXJ0MjogQWxlcnQpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKFxuICAgICAgYWxlcnQxLnRleHQgPT09IGFsZXJ0Mi50ZXh0ICYmXG4gICAgICBhbGVydDEudHlwZSA9PT0gYWxlcnQyLnR5cGUgJiZcbiAgICAgIGlzRXF1YWwoYWxlcnQxLmRldGFpbGVkRGF0YSwgYWxlcnQyLmRldGFpbGVkRGF0YSkgJiZcbiAgICAgIGFsZXJ0MS5vbkNsb3NlID09PSBhbGVydDIub25DbG9zZSAmJlxuICAgICAgYWxlcnQxLm9uRGV0YWlsID09PSBhbGVydDIub25EZXRhaWxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGFuZ2VBbGVydHMobmV3QWxlcnRzOiBBbGVydFtdKSB7XG4gICAgdGhpcy5zdGF0ZSQubmV4dChuZXdBbGVydHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRBbGVydChhbGVydDogQWxlcnQpOiB2b2lkIHtcbiAgICBpZiAoIWFsZXJ0LnRleHQgJiYgIWFsZXJ0LnR5cGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGFkZCBlbXB0eSBhbGVydCcpO1xuICAgIH1cblxuICAgIGNvbnN0IGFsZXJ0QWxyZWFkeUFkZGVkID0gdGhpcy5zdGF0ZS5maW5kKGl0ZW0gPT4gdGhpcy5hcmVTYW1lKGFsZXJ0LCBpdGVtKSk7XG4gICAgaWYgKGFsZXJ0QWxyZWFkeUFkZGVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5jaGFuZ2VBbGVydHMoWy4uLnRoaXMuc3RhdGUsIGFsZXJ0XSk7XG4gICAgdGhpcy5oaWRlQXV0b21hdGljYWxseUlmTmVlZGVkKGFsZXJ0KTtcbiAgICB0aGlzLnJlbW92ZU9sZGVzdElmTWF4KCk7XG4gIH1cblxuICBwcml2YXRlIGhpZGVBdXRvbWF0aWNhbGx5SWZOZWVkZWQoYWxlcnQ6IEFsZXJ0KSB7XG4gICAgY29uc3QgaXNTdWNjZXNzID0gYWxlcnQudHlwZSA9PT0gJ3N1Y2Nlc3MnO1xuICAgIGNvbnN0IG5vRGV0YWlscyA9ICFhbGVydC5kZXRhaWxlZERhdGE7XG4gICAgbGV0IGFsZXJ0VGltZW91dCA9IGlzU3VjY2VzcyAmJiBub0RldGFpbHMgPyB0aGlzLkFMRVJUX1RJTUVPVVQgOiAwO1xuICAgIGlmICh0eXBlb2YgYWxlcnQudGltZW91dCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIGFsZXJ0VGltZW91dCA9IGFsZXJ0LnRpbWVvdXQ7XG4gICAgfVxuICAgIGlmIChhbGVydFRpbWVvdXQpIHtcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5yZW1vdmUoYWxlcnQpLCBhbGVydFRpbWVvdXQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlT2xkZXN0SWZNYXgoKSB7XG4gICAgaWYgKHRoaXMuc3RhdGUubGVuZ3RoID4gdGhpcy5NQVhfQUxFUlRTKSB7XG4gICAgICBjb25zdCBbLCAuLi5maXJzdFJlbW92ZWRdID0gdGhpcy5zdGF0ZTtcbiAgICAgIHRoaXMuY2hhbmdlQWxlcnRzKGZpcnN0UmVtb3ZlZCk7XG4gICAgfVxuICB9XG59XG4iXX0=