import { coerceNumberProperty } from '@angular/cdk/coercion';
import { Subject } from 'rxjs';
import { filter, finalize, map } from 'rxjs/operators';
/**
 * A wrapper class for handling realtime notifications in RxJS fashion.
 */
export class RealtimeService {
    constructor(realtime) {
        this.realtime = realtime;
        this.subjects$ = new Map();
        this.isActive = true;
    }
    /**
     * A flag displaying if realtime notifications are currently active.
     */
    get active() {
        return this.isActive;
    }
    /**
     * Get an Observable of all realtime notifications.
     *
     * @param {string | number | IIdentified} entityOrId Entity object or id
     *
     * @returns An [[Observable]] of notifications wrapped as [[RealtimeMessage]]
     */
    onAll$(entityOrId) {
        const subject$ = this.getSubjectForChannel(entityOrId);
        return subject$.pipe(finalize(() => {
            if (subject$.observers.length === 1 && subject$.observers[0].closed) {
                subject$.stop();
                this.subjects$.delete(subject$.channel);
            }
        }));
    }
    /**
     * Subscribes again all realtime channels with active observers.
     */
    start() {
        if (!this.isActive) {
            this.subjects$.forEach(subject$ => {
                subject$.start();
            });
            this.isActive = true;
        }
    }
    /**
     * Stops realtime notifications and unsubscribes all realtime channels.
     */
    stop() {
        if (this.isActive) {
            this.subjects$.forEach(subject$ => {
                subject$.stop();
            });
            this.isActive = false;
        }
    }
    /**
     * Get an Observable of all CREATE realtime notifications.
     *
     * @param {string | number | IIdentified} entityOrId Entity object or id
     *
     * @returns An [[Observable]] of newly created entity objects.
     */
    onCreate$(entityOrId) {
        return this.onAll$(entityOrId).pipe(filter(msg => msg.realtimeAction === 'CREATE'), map(msg => msg.data));
    }
    /**
     * Get an Observable of all UPDATE realtime notifications.
     *
     * @param {string | number | IIdentified} entityOrId Entity object or id
     *
     * @returns An [[Observable]] of updated entity objects.
     */
    onUpdate$(entityOrId) {
        return this.onAll$(entityOrId).pipe(filter(msg => msg.realtimeAction === 'UPDATE'), map(msg => msg.data));
    }
    /**
     * Get an Observable of all DELETE realtime notifications.
     *
     * @param {string | number | IIdentified} entityOrId Entity object or id
     *
     * @returns An [[Observable]] of deleted entity objects.
     */
    onDelete$(entityOrId) {
        return this.onAll$(entityOrId).pipe(filter(msg => msg.realtimeAction === 'DELETE'), map(msg => coerceNumberProperty(msg.data)));
    }
    getIdString(reference) {
        let id;
        if (typeof reference === 'object') {
            id = reference.id;
        }
        else {
            id = reference;
        }
        return String(id);
    }
    getChannel(entityOrId) {
        return entityOrId ? this.channel().replace('*', this.getIdString(entityOrId)) : this.channel();
    }
    getSubjectForChannel(entityOrId) {
        const channel = this.getChannel(entityOrId);
        let subject$;
        if (this.subjects$.has(channel)) {
            subject$ = this.subjects$.get(channel);
        }
        else {
            subject$ = new RealtimeSubject(channel, this.realtime);
            this.subjects$.set(channel, subject$);
        }
        return subject$;
    }
}
// tslint:disable-next-line: max-classes-per-file
class RealtimeSubject extends Subject {
    constructor(realtimeChannel, realtime) {
        super();
        this.realtimeChannel = realtimeChannel;
        this.realtime = realtime;
        this.start();
    }
    get channel() {
        return this.realtimeChannel;
    }
    start() {
        if (!this.realtimeSubscription) {
            this.realtimeSubscription = this.realtime.subscribe(this.realtimeChannel, msg => {
                const data = {
                    channel: msg.channel,
                    data: msg.data.data,
                    id: msg.id,
                    realtimeAction: msg.data.realtimeAction
                };
                this.next(data);
            });
        }
    }
    stop() {
        if (this.realtimeSubscription) {
            this.realtime.unsubscribe(this.realtimeSubscription);
            this.realtimeSubscription = null;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhbHRpbWUuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2NvcmUvcmVhbHRpbWUvcmVhbHRpbWUuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUU3RCxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBR3ZEOztHQUVHO0FBQ0gsTUFBTSxPQUFnQixlQUFlO0lBV25DLFlBQXNCLFFBQWtCO1FBQWxCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFIaEMsY0FBUyxHQUFvQyxJQUFJLEdBQUcsRUFBOEIsQ0FBQztRQUNuRixhQUFRLEdBQVksSUFBSSxDQUFDO0lBRVUsQ0FBQztJQVY1Qzs7T0FFRztJQUNILElBQUksTUFBTTtRQUNSLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN2QixDQUFDO0lBT0Q7Ozs7OztPQU1HO0lBQ0gsTUFBTSxDQUFDLFVBQTBDO1FBQy9DLE1BQU0sUUFBUSxHQUF1QixJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFM0UsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUNsQixRQUFRLENBQUMsR0FBRyxFQUFFO1lBQ1osSUFBSSxRQUFRLENBQUMsU0FBUyxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUU7Z0JBQ25FLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDaEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2FBQ3pDO1FBQ0gsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNI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ZXNDb250ZW50IjpbImltcG9ydCB7IGNvZXJjZU51bWJlclByb3BlcnR5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2NvZXJjaW9uJztcbmltcG9ydCB7IElJZGVudGlmaWVkLCBSZWFsdGltZSB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgZmluYWxpemUsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFJlYWx0aW1lTWVzc2FnZSB9IGZyb20gJy4vcmVhbHRpbWUubW9kZWwnO1xuXG4vKipcbiAqIEEgd3JhcHBlciBjbGFzcyBmb3IgaGFuZGxpbmcgcmVhbHRpbWUgbm90aWZpY2F0aW9ucyBpbiBSeEpTIGZhc2hpb24uXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBSZWFsdGltZVNlcnZpY2U8VD4ge1xuICAvKipcbiAgICogQSBmbGFnIGRpc3BsYXlpbmcgaWYgcmVhbHRpbWUgbm90aWZpY2F0aW9ucyBhcmUgY3VycmVudGx5IGFjdGl2ZS5cbiAgICovXG4gIGdldCBhY3RpdmUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaXNBY3RpdmU7XG4gIH1cblxuICBwcml2YXRlIHN1YmplY3RzJDogTWFwPHN0cmluZywgUmVhbHRpbWVTdWJqZWN0PFQ+PiA9IG5ldyBNYXA8c3RyaW5nLCBSZWFsdGltZVN1YmplY3Q8VD4+KCk7XG4gIHByaXZhdGUgaXNBY3RpdmU6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCByZWFsdGltZTogUmVhbHRpbWUpIHt9XG5cbiAgLyoqXG4gICAqIEdldCBhbiBPYnNlcnZhYmxlIG9mIGFsbCByZWFsdGltZSBub3RpZmljYXRpb25zLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZyB8IG51bWJlciB8IElJZGVudGlmaWVkfSBlbnRpdHlPcklkIEVudGl0eSBvYmplY3Qgb3IgaWRcbiAgICpcbiAgICogQHJldHVybnMgQW4gW1tPYnNlcnZhYmxlXV0gb2Ygbm90aWZpY2F0aW9ucyB3cmFwcGVkIGFzIFtbUmVhbHRpbWVNZXNzYWdlXV1cbiAgICovXG4gIG9uQWxsJChlbnRpdHlPcklkPzogc3RyaW5nIHwgbnVtYmVyIHwgSUlkZW50aWZpZWQpOiBPYnNlcnZhYmxlPFJlYWx0aW1lTWVzc2FnZTxUPj4ge1xuICAgIGNvbnN0IHN1YmplY3QkOiBSZWFsdGltZVN1YmplY3Q8VD4gPSB0aGlzLmdldFN1YmplY3RGb3JDaGFubmVsKGVudGl0eU9ySWQpO1xuXG4gICAgcmV0dXJuIHN1YmplY3QkLnBpcGUoXG4gICAgICBmaW5hbGl6ZSgoKSA9PiB7XG4gICAgICAgIGlmIChzdWJqZWN0JC5vYnNlcnZlcnMubGVuZ3RoID09PSAxICYmIHN1YmplY3QkLm9ic2VydmVyc1swXS5jbG9zZWQpIHtcbiAgICAgICAgICBzdWJqZWN0JC5zdG9wKCk7XG4gICAgICAgICAgdGhpcy5zdWJqZWN0cyQuZGVsZXRlKHN1YmplY3QkLmNoYW5uZWwpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogU3Vic2NyaWJlcyBhZ2FpbiBhbGwgcmVhbHRpbWUgY2hhbm5lbHMgd2l0aCBhY3RpdmUgb2JzZXJ2ZXJzLlxuICAgKi9cbiAgc3RhcnQoKSB7XG4gICAgaWYgKCF0aGlzLmlzQWN0aXZlKSB7XG4gICAgICB0aGlzLnN1YmplY3RzJC5mb3JFYWNoKHN1YmplY3QkID0+IHtcbiAgICAgICAgc3ViamVjdCQuc3RhcnQoKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5pc0FjdGl2ZSA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFN0b3BzIHJlYWx0aW1lIG5vdGlmaWNhdGlvbnMgYW5kIHVuc3Vic2NyaWJlcyBhbGwgcmVhbHRpbWUgY2hhbm5lbHMuXG4gICAqL1xuICBzdG9wKCkge1xuICAgIGlmICh0aGlzLmlzQWN0aXZlKSB7XG4gICAgICB0aGlzLnN1YmplY3RzJC5mb3JFYWNoKHN1YmplY3QkID0+IHtcbiAgICAgICAgc3ViamVjdCQuc3RvcCgpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuaXNBY3RpdmUgPSBmYWxzZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFuIE9ic2VydmFibGUgb2YgYWxsIENSRUFURSByZWFsdGltZSBub3RpZmljYXRpb25zLlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZyB8IG51bWJlciB8IElJZGVudGlmaWVkfSBlbnRpdHlPcklkIEVudGl0eSBvYmplY3Qgb3IgaWRcbiAgICpcbiAgICogQHJldHVybnMgQW4gW1tPYnNlcnZhYmxlXV0gb2YgbmV3bHkgY3JlYXRlZCBlbnRpdHkgb2JqZWN0cy5cbiAgICovXG4gIG9uQ3JlYXRlJChlbnRpdHlPcklkPzogc3RyaW5nIHwgbnVtYmVyIHwgSUlkZW50aWZpZWQpOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICByZXR1cm4gdGhpcy5vbkFsbCQoZW50aXR5T3JJZCkucGlwZShcbiAgICAgIGZpbHRlcihtc2cgPT4gbXNnLnJlYWx0aW1lQWN0aW9uID09PSAnQ1JFQVRFJyksXG4gICAgICBtYXAobXNnID0+IG1zZy5kYXRhIGFzIFQpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYW4gT2JzZXJ2YWJsZSBvZiBhbGwgVVBEQVRFIHJlYWx0aW1lIG5vdGlmaWNhdGlvbnMuXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nIHwgbnVtYmVyIHwgSUlkZW50aWZpZWR9IGVudGl0eU9ySWQgRW50aXR5IG9iamVjdCBvciBpZFxuICAgKlxuICAgKiBAcmV0dXJucyBBbiBbW09ic2VydmFibGVdXSBvZiB1cGRhdGVkIGVudGl0eSBvYmplY3RzLlxuICAgKi9cbiAgb25VcGRhdGUkKGVudGl0eU9ySWQ/OiBzdHJpbmcgfCBudW1iZXIgfCBJSWRlbnRpZmllZCk6IE9ic2VydmFibGU8VD4ge1xuICAgIHJldHVybiB0aGlzLm9uQWxsJChlbnRpdHlPcklkKS5waXBlKFxuICAgICAgZmlsdGVyKG1zZyA9PiBtc2cucmVhbHRpbWVBY3Rpb24gPT09ICdVUERBVEUnKSxcbiAgICAgIG1hcChtc2cgPT4gbXNnLmRhdGEgYXMgVClcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhbiBPYnNlcnZhYmxlIG9mIGFsbCBERUxFVEUgcmVhbHRpbWUgbm90aWZpY2F0aW9ucy5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmcgfCBudW1iZXIgfCBJSWRlbnRpZmllZH0gZW50aXR5T3JJZCBFbnRpdHkgb2JqZWN0IG9yIGlkXG4gICAqXG4gICAqIEByZXR1cm5zIEFuIFtbT2JzZXJ2YWJsZV1dIG9mIGRlbGV0ZWQgZW50aXR5IG9iamVjdHMuXG4gICAqL1xuICBvbkRlbGV0ZSQoZW50aXR5T3JJZD86IHN0cmluZyB8IG51bWJlciB8IElJZGVudGlmaWVkKTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcbiAgICByZXR1cm4gdGhpcy5vbkFsbCQoZW50aXR5T3JJZCkucGlwZShcbiAgICAgIGZpbHRlcihtc2cgPT4gbXNnLnJlYWx0aW1lQWN0aW9uID09PSAnREVMRVRFJyksXG4gICAgICBtYXAobXNnID0+IGNvZXJjZU51bWJlclByb3BlcnR5KG1zZy5kYXRhKSlcbiAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldElkU3RyaW5nKHJlZmVyZW5jZTogbnVtYmVyIHwgc3RyaW5nIHwgSUlkZW50aWZpZWQpOiBzdHJpbmcge1xuICAgIGxldCBpZDogc3RyaW5nIHwgbnVtYmVyO1xuICAgIGlmICh0eXBlb2YgcmVmZXJlbmNlID09PSAnb2JqZWN0Jykge1xuICAgICAgaWQgPSByZWZlcmVuY2UuaWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlkID0gcmVmZXJlbmNlO1xuICAgIH1cbiAgICByZXR1cm4gU3RyaW5nKGlkKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRDaGFubmVsKGVudGl0eU9ySWQ/OiBzdHJpbmcgfCBudW1iZXIgfCBJSWRlbnRpZmllZCkge1xuICAgIHJldHVybiBlbnRpdHlPcklkID8gdGhpcy5jaGFubmVsKCkucmVwbGFjZSgnKicsIHRoaXMuZ2V0SWRTdHJpbmcoZW50aXR5T3JJZCkpIDogdGhpcy5jaGFubmVsKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgY2hhbm5lbCgpOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSBnZXRTdWJqZWN0Rm9yQ2hhbm5lbChlbnRpdHlPcklkPzogc3RyaW5nIHwgbnVtYmVyIHwgSUlkZW50aWZpZWQpOiBSZWFsdGltZVN1YmplY3Q8VD4ge1xuICAgIGNvbnN0IGNoYW5uZWw6IHN0cmluZyA9IHRoaXMuZ2V0Q2hhbm5lbChlbnRpdHlPcklkKTtcbiAgICBsZXQgc3ViamVjdCQ6IFJlYWx0aW1lU3ViamVjdDxUPjtcbiAgICBpZiAodGhpcy5zdWJqZWN0cyQuaGFzKGNoYW5uZWwpKSB7XG4gICAgICBzdWJqZWN0JCA9IHRoaXMuc3ViamVjdHMkLmdldChjaGFubmVsKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3ViamVjdCQgPSBuZXcgUmVhbHRpbWVTdWJqZWN0KGNoYW5uZWwsIHRoaXMucmVhbHRpbWUpO1xuICAgICAgdGhpcy5zdWJqZWN0cyQuc2V0KGNoYW5uZWwsIHN1YmplY3QkKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3ViamVjdCQ7XG4gIH1cbn1cblxuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBtYXgtY2xhc3Nlcy1wZXItZmlsZVxuY2xhc3MgUmVhbHRpbWVTdWJqZWN0PFQ+IGV4dGVuZHMgU3ViamVjdDxSZWFsdGltZU1lc3NhZ2U8VD4+IHtcbiAgcmVhbHRpbWVTdWJzY3JpcHRpb246IG9iamVjdDtcbiAgZ2V0IGNoYW5uZWwoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5yZWFsdGltZUNoYW5uZWw7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWx0aW1lQ2hhbm5lbDogc3RyaW5nLCBwcml2YXRlIHJlYWx0aW1lOiBSZWFsdGltZSkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5zdGFydCgpO1xuICB9XG5cbiAgc3RhcnQoKSB7XG4gICAgaWYgKCF0aGlzLnJlYWx0aW1lU3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLnJlYWx0aW1lU3Vic2NyaXB0aW9uID0gdGhpcy5yZWFsdGltZS5zdWJzY3JpYmUodGhpcy5yZWFsdGltZUNoYW5uZWwsIG1zZyA9PiB7XG4gICAgICAgIGNvbnN0IGRhdGE6IFJlYWx0aW1lTWVzc2FnZTxUPiA9IHtcbiAgICAgICAgICBjaGFubmVsOiBtc2cuY2hhbm5lbCxcbiAgICAgICAgICBkYXRhOiBtc2cuZGF0YS5kYXRhLFxuICAgICAgICAgIGlkOiBtc2cuaWQsXG4gICAgICAgICAgcmVhbHRpbWVBY3Rpb246IG1zZy5kYXRhLnJlYWx0aW1lQWN0aW9uXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMubmV4dChkYXRhKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHN0b3AoKSB7XG4gICAgaWYgKHRoaXMucmVhbHRpbWVTdWJzY3JpcHRpb24pIHtcbiAgICAgIHRoaXMucmVhbHRpbWUudW5zdWJzY3JpYmUodGhpcy5yZWFsdGltZVN1YnNjcmlwdGlvbik7XG4gICAgICB0aGlzLnJlYWx0aW1lU3Vic2NyaXB0aW9uID0gbnVsbDtcbiAgICB9XG4gIH1cbn1cbiJdfQ==