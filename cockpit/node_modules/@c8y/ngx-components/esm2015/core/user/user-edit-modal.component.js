import { __awaiter } from "tslib";
import { Component } from '@angular/core';
import { BasicAuth, FetchClient, TenantLoginOptionType, UserService } from '@c8y/client';
import { BsModalRef, BsModalService } from 'ngx-bootstrap/modal';
import { AlertService } from '../alert/alert.service';
import { AppStateService } from '../common/ui-state.service';
import { UserPreferencesService } from '../common/user-preferences/user-preferences.service';
import { gettext } from '../i18n/gettext';
import { TranslateService } from '../i18n/translate.service';
import { take } from 'rxjs/operators';
import { ModalService } from '../modal/modal.service';
import { Status } from '../common/status.model';
import { GainsightService } from '../product-experience/gainsight.service';
import { CookieBannerService } from '../bootstrap/cookie-banner/cookie-banner.service';
import { LoginService } from '../login/login.service';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from 'ngx-bootstrap/modal';
import * as ɵngcc2 from '@c8y/client';
import * as ɵngcc3 from '../common/ui-state.service';
import * as ɵngcc4 from '../alert/alert.service';
import * as ɵngcc5 from '../i18n/translate.service';
import * as ɵngcc6 from '../common/user-preferences/user-preferences.service';
import * as ɵngcc7 from '../modal/modal.service';
import * as ɵngcc8 from '../product-experience/gainsight.service';
import * as ɵngcc9 from '../bootstrap/cookie-banner/cookie-banner.service';
import * as ɵngcc10 from '../login/login.service';
import * as ɵngcc11 from '../modal/modal.component';
import * as ɵngcc12 from './user-edit.component';
import * as ɵngcc13 from '../i18n/c8y-translate.pipe';
import * as ɵngcc14 from '@angular/common';
export class UserEditModalComponent {
    constructor(modal, user, ui, auth, client, alert, translate, userPreferences, modalService, c8yModalService, gainsightService, cookieBannerService, loginService) {
        this.modal = modal;
        this.user = user;
        this.ui = ui;
        this.auth = auth;
        this.client = client;
        this.alert = alert;
        this.translate = translate;
        this.userPreferences = userPreferences;
        this.modalService = modalService;
        this.c8yModalService = c8yModalService;
        this.gainsightService = gainsightService;
        this.cookieBannerService = cookieBannerService;
        this.loginService = loginService;
        this.loading = false;
        this.showProductUsageSetting = false;
        this.lang = this.ui.state.lang;
        this.modalService.onHide.pipe(take(1)).subscribe((reason) => {
            if (reason !== null && this.changedLang !== undefined) {
                this.translate.switchToLanguage(this.lang);
            }
        });
    }
    ngOnInit() {
        return __awaiter(this, void 0, void 0, function* () {
            this.updateUserInAppState();
            this.showProductUsageSetting = yield this.gainsightService.canEditProductExperienceSettings();
            if (this.showProductUsageSetting) {
                this.currentUsageTrackingState = !(yield this.gainsightService.isGainsightDisabledInUserPreferences()) &&
                    this.cookieBannerService.isFunctionalCookieEnabled();
            }
        });
    }
    onDismiss() {
        if (this.changedLang !== undefined) {
            this.translate.switchToLanguage(this.lang);
        }
        this.modal.hide();
    }
    onLanguage(lang) {
        this.changedLang = lang;
        this.translate.switchToLanguage(this.changedLang);
    }
    onProductExperience(option) {
        this.usageTrackingState = option;
    }
    updateAndClose(user) {
        return __awaiter(this, void 0, void 0, function* () {
            this.loading = true;
            let reloadRequired = false;
            let logoutRequired = false;
            try {
                const passwordChanged = Boolean(user.password);
                const usesOAuth2Internal = this.loginService.loginMode.type === TenantLoginOptionType.OAUTH2_INTERNAL;
                if (passwordChanged && usesOAuth2Internal) {
                    yield this.c8yModalService.confirmLogout(gettext('You will be logged out to apply your new password. Do you want to proceed?'));
                    logoutRequired = true;
                }
                if (this.changedLang && this.changedLang !== this.lang) {
                    reloadRequired = yield this.persistLanguage(this.changedLang);
                }
                if (this.currentUsageTrackingState !== this.usageTrackingState) {
                    yield this.userPreferences.set(this.gainsightService.USER_PREFERENCES_KEY, this.usageTrackingState);
                    this.gainsightService.setFunctionalCookie(this.usageTrackingState);
                    this.usageTrackingState ? this.gainsightService.loadTag(this.client.tenant) : yield this.gainsightTrackingAppReload();
                }
                if (user.customProperties.userOrigin !== 'OAUTH2') {
                    yield this.user.updateCurrent(user);
                    if (!logoutRequired) {
                        if (user.password) {
                            this.updateCredentials(user.password);
                        }
                        yield this.updateUserInAppState();
                    }
                }
                this.modal.hide();
                this.alert.success(gettext('User saved.'));
            }
            catch (e) {
                if (e) {
                    this.alert.addServerFailure(e);
                }
            }
            finally {
                this.loading = false;
                if (reloadRequired) {
                    location.reload();
                }
                if (logoutRequired) {
                    yield this.loginService.logout(true);
                }
            }
        });
    }
    persistLanguage(lang) {
        return __awaiter(this, void 0, void 0, function* () {
            let shouldReload;
            try {
                yield this.c8yModalService.confirm(gettext('Reload recommended'), gettext('To change the language in the entire application, we recommend you to reload the page. If you have any unsaved changes, you can reload later. How would you like to proceed?'), Status.WARNING, {
                    ok: gettext('Reload now'),
                    cancel: gettext('Reload later')
                });
                this.translate.saveInLocalStorage(lang);
                yield this.userPreferences.set('language', lang);
                this.lang = lang;
                shouldReload = true;
            }
            catch (ex) {
                this.translate.saveInLocalStorage(lang);
                yield this.userPreferences.set('language', lang);
                this.lang = lang;
                shouldReload = false;
            }
            return shouldReload;
        });
    }
    gainsightTrackingAppReload() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                yield this.c8yModalService.confirm(gettext('Reload required'), gettext('To change the tracking option in the entire application, you need to reload the page. If you have any unsaved changes, you can reload later. How would you like to proceed?'), Status.WARNING, {
                    ok: gettext('Reload now'),
                    cancel: gettext('Reload later')
                });
                location.reload();
            }
            catch (ex) {
                // do nothing
            }
        });
    }
    updateUserInAppState() {
        return __awaiter(this, void 0, void 0, function* () {
            const currentUserResult = yield this.user.current();
            this.ui.currentUser.next(currentUserResult.data);
        });
    }
    updateCredentials(password) {
        const newCredentials = {
            password,
            user: this.ui.currentUser.value.id,
            tenant: this.client.tenant
        };
        this.auth.updateCredentials(newCredentials);
    }
}
UserEditModalComponent.ɵfac = function UserEditModalComponent_Factory(t) { return new (t || UserEditModalComponent)(ɵngcc0.ɵɵdirectiveInject(ɵngcc1.BsModalRef), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.UserService), ɵngcc0.ɵɵdirectiveInject(ɵngcc3.AppStateService), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.BasicAuth), ɵngcc0.ɵɵdirectiveInject(ɵngcc2.FetchClient), ɵngcc0.ɵɵdirectiveInject(ɵngcc4.AlertService), ɵngcc0.ɵɵdirectiveInject(ɵngcc5.TranslateService), ɵngcc0.ɵɵdirectiveInject(ɵngcc6.UserPreferencesService), ɵngcc0.ɵɵdirectiveInject(ɵngcc1.BsModalService), ɵngcc0.ɵɵdirectiveInject(ɵngcc7.ModalService), ɵngcc0.ɵɵdirectiveInject(ɵngcc8.GainsightService), ɵngcc0.ɵɵdirectiveInject(ɵngcc9.CookieBannerService), ɵngcc0.ɵɵdirectiveInject(ɵngcc10.LoginService)); };
UserEditModalComponent.ɵcmp = /*@__PURE__*/ ɵngcc0.ɵɵdefineComponent({ type: UserEditModalComponent, selectors: [["c8y-user-edit-modal"]], decls: 4, vars: 11, consts: [[3, "customFooter", "title", "onDismiss"], [3, "lang", "user", "loading", "isUsageTrackingEnabled", "showProductUsageSetting", "onLanguage", "onProductExperience", "onUser", "onCancel"]], template: function UserEditModalComponent_Template(rf, ctx) { if (rf & 1) {
        ɵngcc0.ɵɵelementStart(0, "c8y-modal", 0);
        ɵngcc0.ɵɵlistener("onDismiss", function UserEditModalComponent_Template_c8y_modal_onDismiss_0_listener() { return ctx.onDismiss(); });
        ɵngcc0.ɵɵpipe(1, "translate");
        ɵngcc0.ɵɵelementStart(2, "c8y-user-edit", 1);
        ɵngcc0.ɵɵlistener("onLanguage", function UserEditModalComponent_Template_c8y_user_edit_onLanguage_2_listener($event) { return ctx.onLanguage($event); })("onProductExperience", function UserEditModalComponent_Template_c8y_user_edit_onProductExperience_2_listener($event) { return ctx.onProductExperience($event); })("onUser", function UserEditModalComponent_Template_c8y_user_edit_onUser_2_listener($event) { return ctx.updateAndClose($event); })("onCancel", function UserEditModalComponent_Template_c8y_user_edit_onCancel_2_listener() { return ctx.onDismiss(); });
        ɵngcc0.ɵɵpipe(3, "async");
        ɵngcc0.ɵɵelementEnd();
        ɵngcc0.ɵɵelementEnd();
    } if (rf & 2) {
        ɵngcc0.ɵɵproperty("customFooter", true)("title", ɵngcc0.ɵɵpipeBind1(1, 7, "Edit user"));
        ɵngcc0.ɵɵadvance(2);
        ɵngcc0.ɵɵproperty("lang", ctx.lang)("user", ɵngcc0.ɵɵpipeBind1(3, 9, ctx.ui.currentUser))("loading", ctx.loading)("isUsageTrackingEnabled", ctx.currentUsageTrackingState)("showProductUsageSetting", ctx.showProductUsageSetting);
    } }, directives: [ɵngcc11.ModalComponent, ɵngcc12.UserEditComponent], pipes: [ɵngcc13.C8yTranslatePipe, ɵngcc14.AsyncPipe], encapsulation: 2 });
UserEditModalComponent.ctorParameters = () => [
    { type: BsModalRef },
    { type: UserService },
    { type: AppStateService },
    { type: BasicAuth },
    { type: FetchClient },
    { type: AlertService },
    { type: TranslateService },
    { type: UserPreferencesService },
    { type: BsModalService },
    { type: ModalService },
    { type: GainsightService },
    { type: CookieBannerService },
    { type: LoginService }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(UserEditModalComponent, [{
        type: Component,
        args: [{
                selector: 'c8y-user-edit-modal',
                template: "<c8y-modal [customFooter]=\"true\" [title]=\"'Edit user' | translate\" (onDismiss)=\"onDismiss()\">\n  <c8y-user-edit\n    [lang]=\"lang\"\n    [user]=\"ui.currentUser | async\"\n    [loading]=\"loading\"\n    [isUsageTrackingEnabled]=\"currentUsageTrackingState\"\n    [showProductUsageSetting]=\"showProductUsageSetting\"\n    (onLanguage)=\"onLanguage($event)\"\n    (onProductExperience)=\"onProductExperience($event)\"\n    (onUser)=\"updateAndClose($event)\"\n    (onCancel)=\"onDismiss()\"\n  >\n  </c8y-user-edit>\n</c8y-modal>\n"
            }]
    }], function () { return [{ type: ɵngcc1.BsModalRef }, { type: ɵngcc2.UserService }, { type: ɵngcc3.AppStateService }, { type: ɵngcc2.BasicAuth }, { type: ɵngcc2.FetchClient }, { type: ɵngcc4.AlertService }, { type: ɵngcc5.TranslateService }, { type: ɵngcc6.UserPreferencesService }, { type: ɵngcc1.BsModalService }, { type: ɵngcc7.ModalService }, { type: ɵngcc8.GainsightService }, { type: ɵngcc9.CookieBannerService }, { type: ɵngcc10.LoginService }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci1lZGl0LW1vZGFsLmNvbXBvbmVudC5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS91c2VyL3VzZXItZWRpdC1tb2RhbC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFDbEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQXVCLHFCQUFxQixFQUFFLFdBQVcsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUM5RyxPQUFPLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN0RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDN0QsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0scURBQXFELENBQUM7QUFDN0YsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzdELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN0QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ2hELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBQzNFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGtEQUFrRCxDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7OztBQU10RCxNQUFNLE9BQU8sc0JBQXNCO0FBQUcsSUFTcEMsWUFDUyxLQUFpQixFQUNqQixJQUFpQixFQUNqQixFQUFtQixFQUNsQixJQUFlLEVBQ2YsTUFBbUIsRUFDbkIs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SSxZQURzRCxXQUFXO0FBQUksWUFHbkYsZUFBZTtBQUFJLFlBSG5CLFNBQVM7QUFBSSxZQUFGLFdBQVc7QUFBSSxZQUUxQixZQUFZO0FBQUksWUFJaEIsZ0JBQWdCO0FBQUksWUFGcEIsc0JBQXNCO0FBQUksWUFIZCxjQUFjO0FBQUksWUFPOUIsWUFBWTtBQUFJLFlBRWhCLGdCQUFnQjtBQUFJLFlBQ3BCLG1CQUFtQjtBQUFJLFlBQ3ZCLFlBQVk7QUFBRzs7Ozs7Ozt5ZEFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBPbkluaXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEJhc2ljQXV0aCwgRmV0Y2hDbGllbnQsIElDcmVkZW50aWFscywgSVVzZXIsIFRlbmFudExvZ2luT3B0aW9uVHlwZSwgVXNlclNlcnZpY2UgfSBmcm9tICdAYzh5L2NsaWVudCc7XG5pbXBvcnQgeyBCc01vZGFsUmVmLCBCc01vZGFsU2VydmljZSB9IGZyb20gJ25neC1ib290c3RyYXAvbW9kYWwnO1xuaW1wb3J0IHsgQWxlcnRTZXJ2aWNlIH0gZnJvbSAnLi4vYWxlcnQvYWxlcnQuc2VydmljZSc7XG5pbXBvcnQgeyBBcHBTdGF0ZVNlcnZpY2UgfSBmcm9tICcuLi9jb21tb24vdWktc3RhdGUuc2VydmljZSc7XG5pbXBvcnQgeyBVc2VyUHJlZmVyZW5jZXNTZXJ2aWNlIH0gZnJvbSAnLi4vY29tbW9uL3VzZXItcHJlZmVyZW5jZXMvdXNlci1wcmVmZXJlbmNlcy5zZXJ2aWNlJztcbmltcG9ydCB7IGdldHRleHQgfSBmcm9tICcuLi9pMThuL2dldHRleHQnO1xuaW1wb3J0IHsgVHJhbnNsYXRlU2VydmljZSB9IGZyb20gJy4uL2kxOG4vdHJhbnNsYXRlLnNlcnZpY2UnO1xuaW1wb3J0IHsgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IE1vZGFsU2VydmljZSB9IGZyb20gJy4uL21vZGFsL21vZGFsLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3RhdHVzIH0gZnJvbSAnLi4vY29tbW9uL3N0YXR1cy5tb2RlbCc7XG5pbXBvcnQgeyBHYWluc2lnaHRTZXJ2aWNlIH0gZnJvbSAnLi4vcHJvZHVjdC1leHBlcmllbmNlL2dhaW5zaWdodC5zZXJ2aWNlJztcbmltcG9ydCB7IENvb2tpZUJhbm5lclNlcnZpY2UgfSBmcm9tICcuLi9ib290c3RyYXAvY29va2llLWJhbm5lci9jb29raWUtYmFubmVyLnNlcnZpY2UnO1xuaW1wb3J0IHsgTG9naW5TZXJ2aWNlIH0gZnJvbSAnLi4vbG9naW4vbG9naW4uc2VydmljZSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS11c2VyLWVkaXQtbW9kYWwnLFxuICB0ZW1wbGF0ZVVybDogJy4vdXNlci1lZGl0LW1vZGFsLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBVc2VyRWRpdE1vZGFsQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgY3VycmVudFVzZXI6IElVc2VyO1xuICBsYW5nOiBzdHJpbmc7XG4gIGNoYW5nZWRMYW5nOiBzdHJpbmc7XG4gIGxvYWRpbmcgPSBmYWxzZTtcbiAgc2hvd1Byb2R1Y3RVc2FnZVNldHRpbmc6IGJvb2xlYW4gPSBmYWxzZTtcbiAgY3VycmVudFVzYWdlVHJhY2tpbmdTdGF0ZTogYm9vbGVhbjtcbiAgdXNhZ2VUcmFja2luZ1N0YXRlOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBtb2RhbDogQnNNb2RhbFJlZixcbiAgICBwdWJsaWMgdXNlcjogVXNlclNlcnZpY2UsXG4gICAgcHVibGljIHVpOiBBcHBTdGF0ZVNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhdXRoOiBCYXNpY0F1dGgsXG4gICAgcHJpdmF0ZSBjbGllbnQ6IEZldGNoQ2xpZW50LFxuICAgIHByaXZhdGUgYWxlcnQ6IEFsZXJ0U2VydmljZSxcbiAgICBwcml2YXRlIHRyYW5zbGF0ZTogVHJhbnNsYXRlU2VydmljZSxcbiAgICBwcml2YXRlIHVzZXJQcmVmZXJlbmNlczogVXNlclByZWZlcmVuY2VzU2VydmljZSxcbiAgICBwcml2YXRlIG1vZGFsU2VydmljZTogQnNNb2RhbFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBjOHlNb2RhbFNlcnZpY2U6IE1vZGFsU2VydmljZSxcbiAgICBwcml2YXRlIGdhaW5zaWdodFNlcnZpY2U6IEdhaW5zaWdodFNlcnZpY2UsXG4gICAgcHJpdmF0ZSBjb29raWVCYW5uZXJTZXJ2aWNlOiBDb29raWVCYW5uZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgbG9naW5TZXJ2aWNlOiBMb2dpblNlcnZpY2VcbiAgKSB7XG4gICAgdGhpcy5sYW5nID0gdGhpcy51aS5zdGF0ZS5sYW5nO1xuICAgIHRoaXMubW9kYWxTZXJ2aWNlLm9uSGlkZS5waXBlKHRha2UoMSkpLnN1YnNjcmliZSgocmVhc29uOiBzdHJpbmcpID0+IHtcbiAgICAgIGlmIChyZWFzb24gIT09IG51bGwgJiYgdGhpcy5jaGFuZ2VkTGFuZyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMudHJhbnNsYXRlLnN3aXRjaFRvTGFuZ3VhZ2UodGhpcy5sYW5nKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIG5nT25Jbml0KCkge1xuICAgIHRoaXMudXBkYXRlVXNlckluQXBwU3RhdGUoKTtcbiAgICB0aGlzLnNob3dQcm9kdWN0VXNhZ2VTZXR0aW5nID0gYXdhaXQgdGhpcy5nYWluc2lnaHRTZXJ2aWNlLmNhbkVkaXRQcm9kdWN0RXhwZXJpZW5jZVNldHRpbmdzKCk7XG4gICAgaWYgKHRoaXMuc2hvd1Byb2R1Y3RVc2FnZVNldHRpbmcpIHtcbiAgICAgIHRoaXMuY3VycmVudFVzYWdlVHJhY2tpbmdTdGF0ZSA9ICEoYXdhaXQgdGhpcy5nYWluc2lnaHRTZXJ2aWNlLmlzR2FpbnNpZ2h0RGlzYWJsZWRJblVzZXJQcmVmZXJlbmNlcygpKSAmJlxuICAgICAgICB0aGlzLmNvb2tpZUJhbm5lclNlcnZpY2UuaXNGdW5jdGlvbmFsQ29va2llRW5hYmxlZCgpO1xuICAgIH1cbiAgfVxuXG4gIG9uRGlzbWlzcygpIHtcbiAgICBpZiAodGhpcy5jaGFuZ2VkTGFuZyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLnRyYW5zbGF0ZS5zd2l0Y2hUb0xhbmd1YWdlKHRoaXMubGFuZyk7XG4gICAgfVxuICAgIHRoaXMubW9kYWwuaGlkZSgpO1xuICB9XG5cbiAgb25MYW5ndWFnZShsYW5nKSB7XG4gICAgdGhpcy5jaGFuZ2VkTGFuZyA9IGxhbmc7XG4gICAgdGhpcy50cmFuc2xhdGUuc3dpdGNoVG9MYW5ndWFnZSh0aGlzLmNoYW5nZWRMYW5nKTtcbiAgfVxuXG4gIG9uUHJvZHVjdEV4cGVyaWVuY2Uob3B0aW9uOiBib29sZWFuKSB7XG4gICAgdGhpcy51c2FnZVRyYWNraW5nU3RhdGUgPSBvcHRpb247XG4gIH1cblxuICBhc3luYyB1cGRhdGVBbmRDbG9zZSh1c2VyKSB7XG4gICAgdGhpcy5sb2FkaW5nID0gdHJ1ZTtcblxuICAgIGxldCByZWxvYWRSZXF1aXJlZCA9IGZhbHNlO1xuICAgIGxldCBsb2dvdXRSZXF1aXJlZCA9IGZhbHNlO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHBhc3N3b3JkQ2hhbmdlZCA9IEJvb2xlYW4odXNlci5wYXNzd29yZCk7XG4gICAgICBjb25zdCB1c2VzT0F1dGgySW50ZXJuYWwgPSB0aGlzLmxvZ2luU2VydmljZS5sb2dpbk1vZGUudHlwZSA9PT0gVGVuYW50TG9naW5PcHRpb25UeXBlLk9BVVRIMl9JTlRFUk5BTDtcbiAgICAgIGlmIChwYXNzd29yZENoYW5nZWQgJiYgdXNlc09BdXRoMkludGVybmFsKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYzh5TW9kYWxTZXJ2aWNlLmNvbmZpcm1Mb2dvdXQoXG4gICAgICAgICAgZ2V0dGV4dCgnWW91IHdpbGwgYmUgbG9nZ2VkIG91dCB0byBhcHBseSB5b3VyIG5ldyBwYXNzd29yZC4gRG8geW91IHdhbnQgdG8gcHJvY2VlZD8nKVxuICAgICAgICApO1xuICAgICAgICBsb2dvdXRSZXF1aXJlZCA9IHRydWU7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLmNoYW5nZWRMYW5nICYmIHRoaXMuY2hhbmdlZExhbmcgIT09IHRoaXMubGFuZykge1xuICAgICAgICByZWxvYWRSZXF1aXJlZCA9IGF3YWl0IHRoaXMucGVyc2lzdExhbmd1YWdlKHRoaXMuY2hhbmdlZExhbmcpO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5jdXJyZW50VXNhZ2VUcmFja2luZ1N0YXRlICE9PSB0aGlzLnVzYWdlVHJhY2tpbmdTdGF0ZSkge1xuICAgICAgICBhd2FpdCB0aGlzLnVzZXJQcmVmZXJlbmNlcy5zZXQodGhpcy5nYWluc2lnaHRTZXJ2aWNlLlVTRVJfUFJFRkVSRU5DRVNfS0VZLCB0aGlzLnVzYWdlVHJhY2tpbmdTdGF0ZSk7XG4gICAgICAgIHRoaXMuZ2FpbnNpZ2h0U2VydmljZS5zZXRGdW5jdGlvbmFsQ29va2llKHRoaXMudXNhZ2VUcmFja2luZ1N0YXRlKTtcbiAgICAgICAgdGhpcy51c2FnZVRyYWNraW5nU3RhdGUgPyB0aGlzLmdhaW5zaWdodFNlcnZpY2UubG9hZFRhZyh0aGlzLmNsaWVudC50ZW5hbnQpIDogYXdhaXQgdGhpcy5nYWluc2lnaHRUcmFja2luZ0FwcFJlbG9hZCgpO1xuICAgICAgfVxuXG4gICAgICBpZiAodXNlci5jdXN0b21Qcm9wZXJ0aWVzLnVzZXJPcmlnaW4gIT09ICdPQVVUSDInKSB7XG4gICAgICAgIGF3YWl0IHRoaXMudXNlci51cGRhdGVDdXJyZW50KHVzZXIpO1xuICAgICAgICBpZiAoIWxvZ291dFJlcXVpcmVkKSB7XG4gICAgICAgICAgaWYgKHVzZXIucGFzc3dvcmQpIHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlQ3JlZGVudGlhbHModXNlci5wYXNzd29yZCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGF3YWl0IHRoaXMudXBkYXRlVXNlckluQXBwU3RhdGUoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhpcy5tb2RhbC5oaWRlKCk7XG4gICAgICB0aGlzLmFsZXJ0LnN1Y2Nlc3MoZ2V0dGV4dCgnVXNlciBzYXZlZC4nKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUpIHtcbiAgICAgICAgdGhpcy5hbGVydC5hZGRTZXJ2ZXJGYWlsdXJlKGUpO1xuICAgICAgfVxuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgICAgIGlmIChyZWxvYWRSZXF1aXJlZCkge1xuICAgICAgICBsb2NhdGlvbi5yZWxvYWQoKTtcbiAgICAgIH1cbiAgICAgIGlmIChsb2dvdXRSZXF1aXJlZCkge1xuICAgICAgICBhd2FpdCB0aGlzLmxvZ2luU2VydmljZS5sb2dvdXQodHJ1ZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcGVyc2lzdExhbmd1YWdlKGxhbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBsZXQgc2hvdWxkUmVsb2FkO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmM4eU1vZGFsU2VydmljZS5jb25maXJtKFxuICAgICAgICBnZXR0ZXh0KCdSZWxvYWQgcmVjb21tZW5kZWQnKSxcbiAgICAgICAgZ2V0dGV4dChcbiAgICAgICAgICAnVG8gY2hhbmdlIHRoZSBsYW5ndWFnZSBpbiB0aGUgZW50aXJlIGFwcGxpY2F0aW9uLCB3ZSByZWNvbW1lbmQgeW91IHRvIHJlbG9hZCB0aGUgcGFnZS4gSWYgeW91IGhhdmUgYW55IHVuc2F2ZWQgY2hhbmdlcywgeW91IGNhbiByZWxvYWQgbGF0ZXIuIEhvdyB3b3VsZCB5b3UgbGlrZSB0byBwcm9jZWVkPydcbiAgICAgICAgKSxcbiAgICAgICAgU3RhdHVzLldBUk5JTkcsXG4gICAgICAgIHtcbiAgICAgICAgICBvazogZ2V0dGV4dCgnUmVsb2FkIG5vdycpLFxuICAgICAgICAgIGNhbmNlbDogZ2V0dGV4dCgnUmVsb2FkIGxhdGVyJylcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHRoaXMudHJhbnNsYXRlLnNhdmVJbkxvY2FsU3RvcmFnZShsYW5nKTtcbiAgICAgIGF3YWl0IHRoaXMudXNlclByZWZlcmVuY2VzLnNldCgnbGFuZ3VhZ2UnLCBsYW5nKTtcbiAgICAgIHRoaXMubGFuZyA9IGxhbmc7XG4gICAgICBzaG91bGRSZWxvYWQgPSB0cnVlO1xuICAgIH0gY2F0Y2ggKGV4KSB7XG4gICAgICB0aGlzLnRyYW5zbGF0ZS5zYXZlSW5Mb2NhbFN0b3JhZ2UobGFuZyk7XG4gICAgICBhd2FpdCB0aGlzLnVzZXJQcmVmZXJlbmNlcy5zZXQoJ2xhbmd1YWdlJywgbGFuZyk7XG4gICAgICB0aGlzLmxhbmcgPSBsYW5nO1xuICAgICAgc2hvdWxkUmVsb2FkID0gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNob3VsZFJlbG9hZDtcbiAgfVxuXG4gIGFzeW5jIGdhaW5zaWdodFRyYWNraW5nQXBwUmVsb2FkKCkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmM4eU1vZGFsU2VydmljZS5jb25maXJtKFxuICAgICAgICBnZXR0ZXh0KCdSZWxvYWQgcmVxdWlyZWQnKSxcbiAgICAgICAgZ2V0dGV4dChcbiAgICAgICAgICAnVG8gY2hhbmdlIHRoZSB0cmFja2luZyBvcHRpb24gaW4gdGhlIGVudGlyZSBhcHBsaWNhdGlvbiwgeW91IG5lZWQgdG8gcmVsb2FkIHRoZSBwYWdlLiBJZiB5b3UgaGF2ZSBhbnkgdW5zYXZlZCBjaGFuZ2VzLCB5b3UgY2FuIHJlbG9hZCBsYXRlci4gSG93IHdvdWxkIHlvdSBsaWtlIHRvIHByb2NlZWQ/J1xuICAgICAgICApLFxuICAgICAgICBTdGF0dXMuV0FSTklORyxcbiAgICAgICAge1xuICAgICAgICAgIG9rOiBnZXR0ZXh0KCdSZWxvYWQgbm93JyksXG4gICAgICAgICAgY2FuY2VsOiBnZXR0ZXh0KCdSZWxvYWQgbGF0ZXInKVxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgbG9jYXRpb24ucmVsb2FkKCk7XG4gICAgfSBjYXRjaCAoZXgpIHtcbiAgICAgIC8vIGRvIG5vdGhpbmdcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHVwZGF0ZVVzZXJJbkFwcFN0YXRlKCkge1xuICAgIGNvbnN0IGN1cnJlbnRVc2VyUmVzdWx0ID0gYXdhaXQgdGhpcy51c2VyLmN1cnJlbnQoKTtcbiAgICB0aGlzLnVpLmN1cnJlbnRVc2VyLm5leHQoY3VycmVudFVzZXJSZXN1bHQuZGF0YSk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZUNyZWRlbnRpYWxzKHBhc3N3b3JkOiBzdHJpbmcpIHtcbiAgICBjb25zdCBuZXdDcmVkZW50aWFsczogSUNyZWRlbnRpYWxzID0ge1xuICAgICAgcGFzc3dvcmQsXG4gICAgICB1c2VyOiB0aGlzLnVpLmN1cnJlbnRVc2VyLnZhbHVlLmlkLFxuICAgICAgdGVuYW50OiB0aGlzLmNsaWVudC50ZW5hbnRcbiAgICB9O1xuICAgIHRoaXMuYXV0aC51cGRhdGVDcmVkZW50aWFscyhuZXdDcmVkZW50aWFscyk7XG4gIH1cbn1cbiJdfQ==