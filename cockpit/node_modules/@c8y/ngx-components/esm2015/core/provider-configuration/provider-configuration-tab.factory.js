import { Inject, Injectable, Injector, Optional } from '@angular/core';
import { Router } from '@angular/router';
import { flatten } from 'lodash-es';
import { forkJoin, of } from 'rxjs';
import { map } from 'rxjs/operators';
import { toObservable } from '../common';
import { HOOK_DYNAMIC_PROVIDER_CONFIG } from './provider-configuration-hook';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@angular/router';
export class ProviderConfigurationTabFactory {
    constructor(config, router, injector) {
        this.router = router;
        this.injector = injector;
        this.config = flatten(config);
    }
    get() {
        if (!this.config || !this.config.length) {
            return;
        }
        const configForRoute = this.config.find(c => c.tab
            ? this.router.url === '/' + this.getNodeTabPath(c.navigation.path, c.tab.path) ||
                this.router.url.startsWith('/' + c.navigation.path.replace(/^\/|\/$/g, ''))
            : false);
        const filteredRoutes = configForRoute
            ? this.config.filter(c => c.navigation.path.replace(/^\/|\/$/g, '') ===
                configForRoute.navigation.path.replace(/^\/|\/$/g, '') && c.tab)
            : [];
        const canActivate = filteredRoutes
            .map(c => c.tab.canActivate && c.tab.canActivate.length
            ? c.tab.canActivate.map(ca => this.injector.get(ca))
            : undefined)
            .map(this.checkCanActivate.bind(this));
        return canActivate.length > 0
            ? forkJoin(canActivate).pipe(map((canActivateResult) => filteredRoutes
                .map((c, index) => {
                const tab = Object.assign(Object.assign({}, c.tab), { path: this.getNodeTabPath(c.navigation.path, c.tab.path) });
                return canActivateResult[index] ? tab : undefined;
            })
                .filter(el => !!el)))
            : [];
    }
    checkCanActivate(ca) {
        if (!!ca && ca.length) {
            const canActivateResult = ca
                .map((canActivate) => canActivate.canActivate(undefined, undefined))
                .map(toObservable);
            return forkJoin(canActivateResult).pipe(map((caResult) => caResult.reduce((acc, curr) => acc && curr)));
        }
        return of(true);
    }
    getNodeTabPath(nodePath, tabPath) {
        return `${nodePath.replace(/^\/|\/$/g, '')}/${tabPath.replace(/^\/|\/$/g, '')}`;
    }
}
ProviderConfigurationTabFactory.ɵfac = function ProviderConfigurationTabFactory_Factory(t) { return new (t || ProviderConfigurationTabFactory)(ɵngcc0.ɵɵinject(HOOK_DYNAMIC_PROVIDER_CONFIG, 8), ɵngcc0.ɵɵinject(ɵngcc1.Router), ɵngcc0.ɵɵinject(ɵngcc0.Injector)); };
ProviderConfigurationTabFactory.ɵprov = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjectable({ token: ProviderConfigurationTabFactory, factory: ProviderConfigurationTabFactory.ɵfac });
ProviderConfigurationTabFactory.ctorParameters = () => [
    { type: Array, decorators: [{ type: Optional }, { type: Inject, args: [HOOK_DYNAMIC_PROVIDER_CONFIG,] }] },
    { type: Router },
    { type: Injector }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(ProviderConfigurationTabFactory, [{
        type: Injectable
    }], function () { return [{ type: Array, decorators: [{
                type: Optional
            }, {
                type: Inject,
                args: [HOOK_DYNAMIC_PROVIDER_CONFIG]
            }] }, { type: ɵngcc1.Router }, { type: ɵngcc0.Injector }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdmlkZXItY29uZmlndXJhdGlvbi10YWIuZmFjdG9yeS5qcyIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9wcm92aWRlci1jb25maWd1cmF0aW9uL3Byb3ZpZGVyLWNvbmZpZ3VyYXRpb24tdGFiLmZhY3RvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RSxPQUFPLEVBQWUsTUFBTSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDdEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNwQyxPQUFPLEVBQUUsUUFBUSxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNoRCxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDckMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUd6QyxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQzs7O0FBRzdFLE1BQU0sT0FBTywrQkFBK0I7QUFBRyxJQUc3QyxZQUdFLE1BQWlDLEVBQzFCLE1BQWMsRUFDYixRQUFrQjtBQUMzQixRQUZRLFdBQU0sR0FBTixNQUFNLENBQVE7QUFBQyxRQUNkLGFBQVEsR0FBUixRQUFRLENBQVU7QUFDOUIsUUFDSSxJQUFJLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNsQyxJQUFFLENBQUM7QUFDSCxJQUNFLEdBQUc7QUFDTCxRQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUU7QUFDN0MsWUFBTSxPQUFPO0FBQ2IsU0FBSztBQUNMLFFBQ0ksTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FD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QUNNLE9BQU8sUUFBUSxDQUFDLGlCQUFpQixDQUFDLENBQUMsSUFBSSxDQUNyQyxHQUFHLENBQUMsQ0FBQyxRQUFtQixFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQzFFLENBQUM7QUFDUixTQUFLO0FBQ0wsUUFBSSxPQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNwQixJQUFFLENBQUM7QUFDSCxJQUNVLGNBQWMsQ0FBQyxRQUFRLEVBQUUsT0FBTztBQUMxQyxRQUFJLE9BQU8sR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsSUFBSSxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDO0FBQ3BGLElBQUUsQ0FBQztBQUNIOzJEQTNFQyxVQUFVOzJLQUNUO0FBQUM7QUFBeUQsd0NBSXZELFFBQVEsWUFDUixNQUFNLFNBQUMsNEJBQTRCO0FBQ2pDLFlBaEJlLE1BQU07QUFBSSxZQURILFFBQVE7QUFBRzs7Ozs7Ozs7c0ZBQUU7QUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDYW5BY3RpdmF0ZSwgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcbmltcG9ydCB7IGZsYXR0ZW4gfSBmcm9tICdsb2Rhc2gtZXMnO1xuaW1wb3J0IHsgZm9ya0pvaW4sIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyB0b09ic2VydmFibGUgfSBmcm9tICcuLi9jb21tb24nO1xuaW1wb3J0IHsgVGFiLCBUYWJGYWN0b3J5IH0gZnJvbSAnLi4vdGFicyc7XG5pbXBvcnQgeyBEeW5hbWljUHJvdmlkZXJDb25maWcgfSBmcm9tICcuL21vZGVsL2R5bmFtaWMtcHJvdmlkZXItY29uZmlnLm1vZGVsJztcbmltcG9ydCB7IEhPT0tfRFlOQU1JQ19QUk9WSURFUl9DT05GSUcgfSBmcm9tICcuL3Byb3ZpZGVyLWNvbmZpZ3VyYXRpb24taG9vayc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQcm92aWRlckNvbmZpZ3VyYXRpb25UYWJGYWN0b3J5IGltcGxlbWVudHMgVGFiRmFjdG9yeSB7XG4gIHByaXZhdGUgY29uZmlnOiBEeW5hbWljUHJvdmlkZXJDb25maWdbXTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBAT3B0aW9uYWwoKVxuICAgIEBJbmplY3QoSE9PS19EWU5BTUlDX1BST1ZJREVSX0NPTkZJRylcbiAgICBjb25maWc6IER5bmFtaWNQcm92aWRlckNvbmZpZ1tdW10sXG4gICAgcHVibGljIHJvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yXG4gICkge1xuICAgIHRoaXMuY29uZmlnID0gZmxhdHRlbihjb25maWcpO1xuICB9XG5cbiAgZ2V0KCkge1xuICAgIGlmICghdGhpcy5jb25maWcgfHwgIXRoaXMuY29uZmlnLmxlbmd0aCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbmZpZ0ZvclJvdXRlID0gdGhpcy5jb25maWcuZmluZChjID0+XG4gICAgICBjLnRhYlxuICAgICAgICA/IHRoaXMucm91dGVyLnVybCA9PT0gJy8nICsgdGhpcy5nZXROb2RlVGFiUGF0aChjLm5hdmlnYXRpb24ucGF0aCwgYy50YWIucGF0aCkgfHxcbiAgICAgICAgICB0aGlzLnJvdXRlci51cmwuc3RhcnRzV2l0aCgnLycgKyBjLm5hdmlnYXRpb24ucGF0aC5yZXBsYWNlKC9eXFwvfFxcLyQvZywgJycpKVxuICAgICAgICA6IGZhbHNlXG4gICAgKTtcblxuICAgIGNvbnN0IGZpbHRlcmVkUm91dGVzID0gY29uZmlnRm9yUm91dGVcbiAgICAgID8gdGhpcy5jb25maWcuZmlsdGVyKFxuICAgICAgICAgIGMgPT5cbiAgICAgICAgICAgIGMubmF2aWdhdGlvbi5wYXRoLnJlcGxhY2UoL15cXC98XFwvJC9nLCAnJykgPT09XG4gICAgICAgICAgICAgIGNvbmZpZ0ZvclJvdXRlLm5hdmlnYXRpb24ucGF0aC5yZXBsYWNlKC9eXFwvfFxcLyQvZywgJycpICYmIGMudGFiXG4gICAgICAgIClcbiAgICAgIDogW107XG5cbiAgICBjb25zdCBjYW5BY3RpdmF0ZTogQXJyYXk8T2JzZXJ2YWJsZTxib29sZWFuPj4gPSBmaWx0ZXJlZFJvdXRlc1xuICAgICAgLm1hcChjID0+XG4gICAgICAgIGMudGFiLmNhbkFjdGl2YXRlICYmIGMudGFiLmNhbkFjdGl2YXRlLmxlbmd0aFxuICAgICAgICAgID8gYy50YWIuY2FuQWN0aXZhdGUubWFwKGNhID0+IHRoaXMuaW5qZWN0b3IuZ2V0KGNhKSlcbiAgICAgICAgICA6IHVuZGVmaW5lZFxuICAgICAgKVxuICAgICAgLm1hcCh0aGlzLmNoZWNrQ2FuQWN0aXZhdGUuYmluZCh0aGlzKSk7XG5cbiAgICByZXR1cm4gY2FuQWN0aXZhdGUubGVuZ3RoID4gMFxuICAgICAgPyBmb3JrSm9pbihjYW5BY3RpdmF0ZSkucGlwZShcbiAgICAgICAgICBtYXAoKGNhbkFjdGl2YXRlUmVzdWx0OiBib29sZWFuW10pID0+XG4gICAgICAgICAgICBmaWx0ZXJlZFJvdXRlc1xuICAgICAgICAgICAgICAubWFwKChjLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRhYiA9IHtcbiAgICAgICAgICAgICAgICAgIC4uLmMudGFiLFxuICAgICAgICAgICAgICAgICAgcGF0aDogdGhpcy5nZXROb2RlVGFiUGF0aChjLm5hdmlnYXRpb24ucGF0aCwgYy50YWIucGF0aClcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIHJldHVybiBjYW5BY3RpdmF0ZVJlc3VsdFtpbmRleF0gPyAodGFiIGFzIFRhYikgOiB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIC5maWx0ZXIoZWwgPT4gISFlbClcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgIDogW107XG4gIH1cblxuICBwcml2YXRlIGNoZWNrQ2FuQWN0aXZhdGUoY2E6IENhbkFjdGl2YXRlW10pOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICBpZiAoISFjYSAmJiBjYS5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IGNhbkFjdGl2YXRlUmVzdWx0OiBBcnJheTxPYnNlcnZhYmxlPGJvb2xlYW4+PiA9IGNhXG4gICAgICAgIC5tYXAoKGNhbkFjdGl2YXRlOiBDYW5BY3RpdmF0ZSkgPT4gY2FuQWN0aXZhdGUuY2FuQWN0aXZhdGUodW5kZWZpbmVkLCB1bmRlZmluZWQpKVxuICAgICAgICAubWFwKHRvT2JzZXJ2YWJsZSkgYXMgQXJyYXk8T2JzZXJ2YWJsZTxib29sZWFuPj47XG5cbiAgICAgIHJldHVybiBmb3JrSm9pbihjYW5BY3RpdmF0ZVJlc3VsdCkucGlwZShcbiAgICAgICAgbWFwKChjYVJlc3VsdDogYm9vbGVhbltdKSA9PiBjYVJlc3VsdC5yZWR1Y2UoKGFjYywgY3VycikgPT4gYWNjICYmIGN1cnIpKVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIG9mKHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXROb2RlVGFiUGF0aChub2RlUGF0aCwgdGFiUGF0aCkge1xuICAgIHJldHVybiBgJHtub2RlUGF0aC5yZXBsYWNlKC9eXFwvfFxcLyQvZywgJycpfS8ke3RhYlBhdGgucmVwbGFjZSgvXlxcL3xcXC8kL2csICcnKX1gO1xuICB9XG59XG4iXX0=