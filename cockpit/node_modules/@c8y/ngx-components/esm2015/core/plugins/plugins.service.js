import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { ApplicationService, FetchClient } from '@c8y/ngx-components/api';
import { gettext } from '../i18n/gettext';
import * as ɵngcc0 from '@angular/core';
import * as ɵngcc1 from '@c8y/ngx-components/api';
export class PluginsService {
    constructor(applicationService, client) {
        this.applicationService = applicationService;
        this.client = client;
    }
    listPackages() {
        return __awaiter(this, void 0, void 0, function* () {
            const { data } = yield this.applicationService.list({ pageSize: 2000 });
            return data.filter((app) => app.exports || (app.manifest && app.manifest.exports));
        });
    }
    listVersions(forPackage) {
        return __awaiter(this, void 0, void 0, function* () {
            const { data } = yield this.applicationService.binary(forPackage).listPlugins();
            return data
                .map(plugin => (Object.assign(Object.assign({}, plugin.pluginPackage), { version: plugin.pluginName })))
                .filter(plugin => plugin.exports);
        });
    }
    listInstalled(forApp, flat = true) {
        return __awaiter(this, void 0, void 0, function* () {
            const app = yield this.getApplication(forApp);
            const c8yJson = yield this.getCumulocityJsonFile(app);
            if (flat) {
                let flatList = [];
                for (const key in c8yJson.imports) {
                    if (c8yJson.imports.hasOwnProperty(key)) {
                        flatList = [
                            ...flatList,
                            ...c8yJson.imports[key].map(imp => /@/.test(key) ? `${key}/${imp}` : `${key}@latest/${imp}`)
                        ];
                    }
                }
                return flatList;
            }
            return c8yJson.imports;
        });
    }
    addByName(addTo, pluginName) {
        return __awaiter(this, void 0, void 0, function* () {
            const name = pluginName.split('//').pop();
            const contextPath = pluginName.split('//').shift();
            const pkg = {
                contextPath
            };
            return this.add(addTo, pkg, name);
        });
    }
    removeByName(removeFrom, pluginName) {
        return __awaiter(this, void 0, void 0, function* () {
            const name = pluginName.split('/').pop();
            const contextPath = /@latest/.test(pluginName)
                ? pluginName.split('@').shift()
                : pluginName.split('/').shift();
            const pkg = {
                contextPath
            };
            return this.remove(removeFrom, pkg, name);
        });
    }
    add(addToApp, fromPackage, name) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.addOrRemove(addToApp, fromPackage, name, true);
        });
    }
    remove(removeFromApp, fromPackage, name) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.addOrRemove(removeFromApp, fromPackage, name, false);
        });
    }
    updateRemotesInCumulocityJson(app, remotes) {
        return __awaiter(this, void 0, void 0, function* () {
            const c8yJson = yield this.getCumulocityJsonFile(app);
            return this.storeCumulocityJson(app, Object.assign(Object.assign({}, c8yJson), { remotes }));
        });
    }
    addOrRemove(addToApp, fromPackage, name, add = true) {
        return __awaiter(this, void 0, void 0, function* () {
            const application = yield this.getApplication(addToApp);
            const pkg = yield this.getApplication(fromPackage);
            const c8yJson = yield this.getCumulocityJsonFile(application);
            // TODO: Versions?!!
            const pkgImport = new Set(c8yJson.imports[pkg.contextPath]);
            if (add) {
                pkgImport.add(name);
            }
            else {
                pkgImport.delete(name);
            }
            c8yJson.imports[pkg.contextPath] = Array.from(pkgImport);
            yield this.storeCumulocityJson(application, c8yJson);
            return c8yJson;
        });
    }
    storeCumulocityJson(application, c8yJson) {
        return this.applicationService
            .binary(application)
            .updateFiles([{ path: 'cumulocity.json', contents: JSON.stringify(c8yJson) }]);
    }
    getCumulocityJsonFile(app) {
        return __awaiter(this, void 0, void 0, function* () {
            const result = yield this.client.fetch(`/apps/${app.contextPath}/cumulocity.json`);
            if (result.status >= 400) {
                throw new Error(gettext('No Cumulocity IoT manifest found.'));
            }
            const c8yJson = yield result.json();
            if (!c8yJson.imports) {
                c8yJson.imports = {};
            }
            return c8yJson;
        });
    }
    getApplication(app) {
        return __awaiter(this, void 0, void 0, function* () {
            if (typeof app !== 'number' && app.contextPath) {
                return app;
            }
            const { data } = yield this.applicationService.detail(app);
            return data;
        });
    }
}
PluginsService.ɵfac = function PluginsService_Factory(t) { return new (t || PluginsService)(ɵngcc0.ɵɵinject(ɵngcc1.ApplicationService), ɵngcc0.ɵɵinject(ɵngcc1.FetchClient)); };
PluginsService.ɵprov = /*@__PURE__*/ ɵngcc0.ɵɵdefineInjectable({ token: PluginsService, factory: PluginsService.ɵfac });
PluginsService.ctorParameters = () => [
    { type: ApplicationService },
    { type: FetchClient }
];
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && ɵngcc0.ɵsetClassMetadata(PluginsService, [{
        type: Injectable
    }], function () { return [{ type: ɵngcc1.ApplicationService }, { type: ɵngcc1.FetchClient }]; }, null); })();

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2lucy5zZXJ2aWNlLmpzIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9jb3JlL3BsdWdpbnMvcGx1Z2lucy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQ0wsVUFBVSxFQUNYLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxXQUFXLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUMxRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0saUJBQWlCLENBQUM7OztBQU0xQyxNQUFNLE9BQU8sY0FBYztBQUMzQixJQUFFLFlBQW9CLGtCQUFzQyxFQUFVLE1BQW1CO0FBQUksUUFBdkUsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtBQUFDLFFBQVMsV0FBTSxHQUFOLE1BQU0sQ0FBYTtBQUFDLElBQUUsQ0FBQztBQUM3RixJQUNRLFlBQVk7QUFDcEI7QUFBOEQsWUFBMUQsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBQzVFLFlBQUksT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBUSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7QUFDNUYsUUFBRSxDQUFDO0FBRUYsS0FGRTtBQUNILElBQ1EsWUFBWSxDQUFDLFVBQW1CO0FBQ3hDO0FBQThELFlBQTFELE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7QUFDcEYsWUFBSSxPQUFPLElBQUk7QUFDZixpQkFBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FB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QUFFLENBQUM7QUFDM0IsYUFBSztBQUNMLFlBQUksT0FBTyxPQUFPLENBQUM7QUFDbkIsUUFBRSxDQUFDO0FBRUYsS0FGRTtBQUNILElBQ2dCLGNBQWMsQ0FBQyxHQUFnQjtBQUFJO0FBQ1osWUFBbkMsSUFBSSxPQUFPLEdBQUcsS0FBSyxRQUFRLElBQUssR0FBb0IsQ0FBQyxXQUFXLEVBQUU7QUFDdEUsZ0JBQU0sT0FBTyxHQUFtQixDQUFDO0FBQ2pDLGFBQUs7QUFDTCxZQUFJLE1BQU0sRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDL0QsWUFBSSxPQUFPLElBQUksQ0FBQztBQUNoQixRQUFFLENBQUM7QUFFSCxLQUZHO0FBQ0g7MENBakhDLFVBQVU7d0hBQ1Q7QUFBQztBQUNVLFlBUkosa0JBQWtCO0FBQUksWUFBRixXQUFXO0FBQUc7OztpSEFBRTtBQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSW5qZWN0YWJsZVxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFwcGxpY2F0aW9uUmVtb3RlUGx1Z2lucywgSUFwcGxpY2F0aW9uLCBJSWRlbnRpZmllZCB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEFwcGxpY2F0aW9uU2VydmljZSwgRmV0Y2hDbGllbnQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzL2FwaSc7XG5pbXBvcnQgeyBnZXR0ZXh0IH0gZnJvbSAnLi4vaTE4bi9nZXR0ZXh0JztcblxudHlwZSBBcHBsaWNhdGlvbiA9IElJZGVudGlmaWVkIHwgSUFwcGxpY2F0aW9uIHwgbnVtYmVyIHwgc3RyaW5nO1xudHlwZSBQYWNrYWdlID0gQXBwbGljYXRpb247XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBQbHVnaW5zU2VydmljZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBwbGljYXRpb25TZXJ2aWNlOiBBcHBsaWNhdGlvblNlcnZpY2UsIHByaXZhdGUgY2xpZW50OiBGZXRjaENsaWVudCkge31cblxuICBhc3luYyBsaXN0UGFja2FnZXMoKSB7XG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5saXN0KHsgcGFnZVNpemU6IDIwMDAgfSk7XG4gICAgcmV0dXJuIGRhdGEuZmlsdGVyKChhcHA6IGFueSkgPT4gYXBwLmV4cG9ydHMgfHwgKGFwcC5tYW5pZmVzdCAmJiBhcHAubWFuaWZlc3QuZXhwb3J0cykpO1xuICB9XG5cbiAgYXN5bmMgbGlzdFZlcnNpb25zKGZvclBhY2thZ2U6IFBhY2thZ2UpIHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmJpbmFyeShmb3JQYWNrYWdlKS5saXN0UGx1Z2lucygpO1xuICAgIHJldHVybiBkYXRhXG4gICAgICAubWFwKHBsdWdpbiA9PiAoeyAuLi5wbHVnaW4ucGx1Z2luUGFja2FnZSwgdmVyc2lvbjogcGx1Z2luLnBsdWdpbk5hbWUgfSkpXG4gICAgICAuZmlsdGVyKHBsdWdpbiA9PiBwbHVnaW4uZXhwb3J0cyk7XG4gIH1cblxuICBhc3luYyBsaXN0SW5zdGFsbGVkKGZvckFwcDogQXBwbGljYXRpb24sIGZsYXQgPSB0cnVlKSB7XG4gICAgY29uc3QgYXBwID0gYXdhaXQgdGhpcy5nZXRBcHBsaWNhdGlvbihmb3JBcHApO1xuICAgIGNvbnN0IGM4eUpzb24gPSBhd2FpdCB0aGlzLmdldEN1bXVsb2NpdHlKc29uRmlsZShhcHApO1xuICAgIGlmIChmbGF0KSB7XG4gICAgICBsZXQgZmxhdExpc3QgPSBbXTtcbiAgICAgIGZvciAoY29uc3Qga2V5IGluIGM4eUpzb24uaW1wb3J0cykge1xuICAgICAgICBpZiAoYzh5SnNvbi5pbXBvcnRzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgICBmbGF0TGlzdCA9IFtcbiAgICAgICAgICAgIC4uLmZsYXRMaXN0LFxuICAgICAgICAgICAgLi4uYzh5SnNvbi5pbXBvcnRzW2tleV0ubWFwKGltcCA9PlxuICAgICAgICAgICAgICAvQC8udGVzdChrZXkpID8gYCR7a2V5fS8ke2ltcH1gIDogYCR7a2V5fUBsYXRlc3QvJHtpbXB9YFxuICAgICAgICAgICAgKVxuICAgICAgICAgIF07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBmbGF0TGlzdDtcbiAgICB9XG4gICAgcmV0dXJuIGM4eUpzb24uaW1wb3J0cztcbiAgfVxuXG4gIGFzeW5jIGFkZEJ5TmFtZShhZGRUbzogQXBwbGljYXRpb24sIHBsdWdpbk5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IG5hbWUgPSBwbHVnaW5OYW1lLnNwbGl0KCcvLycpLnBvcCgpO1xuICAgIGNvbnN0IGNvbnRleHRQYXRoID0gcGx1Z2luTmFtZS5zcGxpdCgnLy8nKS5zaGlmdCgpO1xuICAgIGNvbnN0IHBrZyA9IHtcbiAgICAgIGNvbnRleHRQYXRoXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5hZGQoYWRkVG8sIHBrZywgbmFtZSk7XG4gIH1cblxuICBhc3luYyByZW1vdmVCeU5hbWUocmVtb3ZlRnJvbTogQXBwbGljYXRpb24sIHBsdWdpbk5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IG5hbWUgPSBwbHVnaW5OYW1lLnNwbGl0KCcvJykucG9wKCk7XG4gICAgY29uc3QgY29udGV4dFBhdGggPSAvQGxhdGVzdC8udGVzdChwbHVnaW5OYW1lKVxuICAgICAgPyBwbHVnaW5OYW1lLnNwbGl0KCdAJykuc2hpZnQoKVxuICAgICAgOiBwbHVnaW5OYW1lLnNwbGl0KCcvJykuc2hpZnQoKTtcblxuICAgIGNvbnN0IHBrZyA9IHtcbiAgICAgIGNvbnRleHRQYXRoXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5yZW1vdmUocmVtb3ZlRnJvbSwgcGtnLCBuYW1lKTtcbiAgfVxuXG4gIGFzeW5jIGFkZChhZGRUb0FwcDogQXBwbGljYXRpb24sIGZyb21QYWNrYWdlOiBQYWNrYWdlLCBuYW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5hZGRPclJlbW92ZShhZGRUb0FwcCwgZnJvbVBhY2thZ2UsIG5hbWUsIHRydWUpO1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlKHJlbW92ZUZyb21BcHA6IEFwcGxpY2F0aW9uLCBmcm9tUGFja2FnZTogUGFja2FnZSwgbmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuYWRkT3JSZW1vdmUocmVtb3ZlRnJvbUFwcCwgZnJvbVBhY2thZ2UsIG5hbWUsIGZhbHNlKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVJlbW90ZXNJbkN1bXVsb2NpdHlKc29uKGFwcDogSUFwcGxpY2F0aW9uLCByZW1vdGVzOiBBcHBsaWNhdGlvblJlbW90ZVBsdWdpbnMpIHtcbiAgICBjb25zdCBjOHlKc29uID0gYXdhaXQgdGhpcy5nZXRDdW11bG9jaXR5SnNvbkZpbGUoYXBwKTtcbiAgICByZXR1cm4gdGhpcy5zdG9yZUN1bXVsb2NpdHlKc29uKGFwcCwgeyAuLi5jOHlKc29uLCByZW1vdGVzfSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGFkZE9yUmVtb3ZlKGFkZFRvQXBwOiBBcHBsaWNhdGlvbiwgZnJvbVBhY2thZ2U6IFBhY2thZ2UsIG5hbWU6IHN0cmluZywgYWRkID0gdHJ1ZSkge1xuICAgIGNvbnN0IGFwcGxpY2F0aW9uID0gYXdhaXQgdGhpcy5nZXRBcHBsaWNhdGlvbihhZGRUb0FwcCk7XG4gICAgY29uc3QgcGtnID0gYXdhaXQgdGhpcy5nZXRBcHBsaWNhdGlvbihmcm9tUGFja2FnZSk7XG4gICAgY29uc3QgYzh5SnNvbiA9IGF3YWl0IHRoaXMuZ2V0Q3VtdWxvY2l0eUpzb25GaWxlKGFwcGxpY2F0aW9uKTtcblxuICAgIC8vIFRPRE86IFZlcnNpb25zPyEhXG4gICAgY29uc3QgcGtnSW1wb3J0ID0gbmV3IFNldChjOHlKc29uLmltcG9ydHNbcGtnLmNvbnRleHRQYXRoXSk7XG4gICAgaWYgKGFkZCkge1xuICAgICAgcGtnSW1wb3J0LmFkZChuYW1lKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGtnSW1wb3J0LmRlbGV0ZShuYW1lKTtcbiAgICB9XG4gICAgYzh5SnNvbi5pbXBvcnRzW3BrZy5jb250ZXh0UGF0aF0gPSBBcnJheS5mcm9tKHBrZ0ltcG9ydCk7XG5cbiAgICBhd2FpdCB0aGlzLnN0b3JlQ3VtdWxvY2l0eUpzb24oYXBwbGljYXRpb24sIGM4eUpzb24pO1xuICAgIHJldHVybiBjOHlKc29uO1xuICB9XG5cbiAgcHJpdmF0ZSBzdG9yZUN1bXVsb2NpdHlKc29uKGFwcGxpY2F0aW9uLCBjOHlKc29uKSB7XG4gICAgcmV0dXJuIHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlXG4gICAgICAuYmluYXJ5KGFwcGxpY2F0aW9uKVxuICAgICAgLnVwZGF0ZUZpbGVzKFt7IHBhdGg6ICdjdW11bG9jaXR5Lmpzb24nLCBjb250ZW50czogSlNPTi5zdHJpbmdpZnkoYzh5SnNvbikgYXMgYW55IH1dKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0Q3VtdWxvY2l0eUpzb25GaWxlKGFwcDogSUFwcGxpY2F0aW9uKSB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5jbGllbnQuZmV0Y2goYC9hcHBzLyR7YXBwLmNvbnRleHRQYXRofS9jdW11bG9jaXR5Lmpzb25gKTtcbiAgICBpZiAocmVzdWx0LnN0YXR1cyA+PSA0MDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihnZXR0ZXh0KCdObyBDdW11bG9jaXR5IElvVCBtYW5pZmVzdCBmb3VuZC4nKSk7XG4gICAgfVxuICAgIGNvbnN0IGM4eUpzb24gPSBhd2FpdCByZXN1bHQuanNvbigpO1xuICAgIGlmICghYzh5SnNvbi5pbXBvcnRzKSB7XG4gICAgICBjOHlKc29uLmltcG9ydHMgPSB7fTtcbiAgICB9XG4gICAgcmV0dXJuIGM4eUpzb247XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGdldEFwcGxpY2F0aW9uKGFwcDogQXBwbGljYXRpb24pOiBQcm9taXNlPElBcHBsaWNhdGlvbj4ge1xuICAgIGlmICh0eXBlb2YgYXBwICE9PSAnbnVtYmVyJyAmJiAoYXBwIGFzIElBcHBsaWNhdGlvbikuY29udGV4dFBhdGgpIHtcbiAgICAgIHJldHVybiBhcHAgYXMgSUFwcGxpY2F0aW9uO1xuICAgIH1cbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmRldGFpbChhcHApO1xuICAgIHJldHVybiBkYXRhO1xuICB9XG59XG4iXX0=