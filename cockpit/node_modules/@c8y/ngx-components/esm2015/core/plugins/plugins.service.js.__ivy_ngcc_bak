import { __awaiter } from "tslib";
import { Injectable } from '@angular/core';
import { ApplicationService, FetchClient } from '@c8y/ngx-components/api';
import { gettext } from '../i18n/gettext';
export class PluginsService {
    constructor(applicationService, client) {
        this.applicationService = applicationService;
        this.client = client;
    }
    listPackages() {
        return __awaiter(this, void 0, void 0, function* () {
            const { data } = yield this.applicationService.list({ pageSize: 2000 });
            return data.filter((app) => app.exports || (app.manifest && app.manifest.exports));
        });
    }
    listVersions(forPackage) {
        return __awaiter(this, void 0, void 0, function* () {
            const { data } = yield this.applicationService.binary(forPackage).listPlugins();
            return data
                .map(plugin => (Object.assign(Object.assign({}, plugin.pluginPackage), { version: plugin.pluginName })))
                .filter(plugin => plugin.exports);
        });
    }
    listInstalled(forApp, flat = true) {
        return __awaiter(this, void 0, void 0, function* () {
            const app = yield this.getApplication(forApp);
            const c8yJson = yield this.getCumulocityJsonFile(app);
            if (flat) {
                let flatList = [];
                for (const key in c8yJson.imports) {
                    if (c8yJson.imports.hasOwnProperty(key)) {
                        flatList = [
                            ...flatList,
                            ...c8yJson.imports[key].map(imp => /@/.test(key) ? `${key}/${imp}` : `${key}@latest/${imp}`)
                        ];
                    }
                }
                return flatList;
            }
            return c8yJson.imports;
        });
    }
    addByName(addTo, pluginName) {
        return __awaiter(this, void 0, void 0, function* () {
            const name = pluginName.split('//').pop();
            const contextPath = pluginName.split('//').shift();
            const pkg = {
                contextPath
            };
            return this.add(addTo, pkg, name);
        });
    }
    removeByName(removeFrom, pluginName) {
        return __awaiter(this, void 0, void 0, function* () {
            const name = pluginName.split('/').pop();
            const contextPath = /@latest/.test(pluginName)
                ? pluginName.split('@').shift()
                : pluginName.split('/').shift();
            const pkg = {
                contextPath
            };
            return this.remove(removeFrom, pkg, name);
        });
    }
    add(addToApp, fromPackage, name) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.addOrRemove(addToApp, fromPackage, name, true);
        });
    }
    remove(removeFromApp, fromPackage, name) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.addOrRemove(removeFromApp, fromPackage, name, false);
        });
    }
    updateRemotesInCumulocityJson(app, remotes) {
        return __awaiter(this, void 0, void 0, function* () {
            const c8yJson = yield this.getCumulocityJsonFile(app);
            return this.storeCumulocityJson(app, Object.assign(Object.assign({}, c8yJson), { remotes }));
        });
    }
    addOrRemove(addToApp, fromPackage, name, add = true) {
        return __awaiter(this, void 0, void 0, function* () {
            const application = yield this.getApplication(addToApp);
            const pkg = yield this.getApplication(fromPackage);
            const c8yJson = yield this.getCumulocityJsonFile(application);
            // TODO: Versions?!!
            const pkgImport = new Set(c8yJson.imports[pkg.contextPath]);
            if (add) {
                pkgImport.add(name);
            }
            else {
                pkgImport.delete(name);
            }
            c8yJson.imports[pkg.contextPath] = Array.from(pkgImport);
            yield this.storeCumulocityJson(application, c8yJson);
            return c8yJson;
        });
    }
    storeCumulocityJson(application, c8yJson) {
        return this.applicationService
            .binary(application)
            .updateFiles([{ path: 'cumulocity.json', contents: JSON.stringify(c8yJson) }]);
    }
    getCumulocityJsonFile(app) {
        return __awaiter(this, void 0, void 0, function* () {
            const result = yield this.client.fetch(`/apps/${app.contextPath}/cumulocity.json`);
            if (result.status >= 400) {
                throw new Error(gettext('No Cumulocity IoT manifest found.'));
            }
            const c8yJson = yield result.json();
            if (!c8yJson.imports) {
                c8yJson.imports = {};
            }
            return c8yJson;
        });
    }
    getApplication(app) {
        return __awaiter(this, void 0, void 0, function* () {
            if (typeof app !== 'number' && app.contextPath) {
                return app;
            }
            const { data } = yield this.applicationService.detail(app);
            return data;
        });
    }
}
PluginsService.decorators = [
    { type: Injectable }
];
PluginsService.ctorParameters = () => [
    { type: ApplicationService },
    { type: FetchClient }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGx1Z2lucy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vY29yZS9wbHVnaW5zL3BsdWdpbnMuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFVBQVUsRUFDWCxNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsV0FBVyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDMUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBTTFDLE1BQU0sT0FBTyxjQUFjO0lBQ3pCLFlBQW9CLGtCQUFzQyxFQUFVLE1BQW1CO1FBQW5FLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFhO0lBQUcsQ0FBQztJQUVyRixZQUFZOztZQUNoQixNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7WUFDeEUsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBUSxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFDMUYsQ0FBQztLQUFBO0lBRUssWUFBWSxDQUFDLFVBQW1COztZQUNwQyxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ2hGLE9BQU8sSUFBSTtpQkFDUixHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxpQ0FBTSxNQUFNLENBQUMsYUFBYSxLQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsVUFBVSxJQUFHLENBQUM7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USxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzFGLENBQUM7SUFFYSxxQkFBcUIsQ0FBQyxHQUFpQjs7WUFDbkQsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsQ0FBQyxXQUFXLGtCQUFrQixDQUFDLENBQUM7WUFDbkYsSUFBSSxNQUFNLENBQUMsTUFBTSxJQUFJLEdBQUcsRUFBRTtnQkFDeEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsbUNBQW1DLENBQUMsQ0FBQyxDQUFDO2FBQy9EO1lBQ0QsTUFBTSxPQUFPLEdBQUcsTUFBTSxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDcEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUU7Z0JBQ3BCLE9BQU8sQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO2FBQ3RCO1lBQ0QsT0FBTyxPQUFPLENBQUM7UUFDakIsQ0FBQztLQUFBO0lBRWEsY0FBYyxDQUFDLEdBQWdCOztZQUMzQyxJQUFJLE9BQU8sR0FBRyxLQUFLLFFBQVEsSUFBSyxHQUFvQixDQUFDLFdBQVcsRUFBRTtnQkFDaEUsT0FBTyxHQUFtQixDQUFDO2FBQzVCO1lBQ0QsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMzRCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7S0FBQTs7O1lBaEhGLFVBQVU7OztZQU5GLGtCQUFrQjtZQUFFLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJbmplY3RhYmxlXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQXBwbGljYXRpb25SZW1vdGVQbHVnaW5zLCBJQXBwbGljYXRpb24sIElJZGVudGlmaWVkIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgQXBwbGljYXRpb25TZXJ2aWNlLCBGZXRjaENsaWVudCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMvYXBpJztcbmltcG9ydCB7IGdldHRleHQgfSBmcm9tICcuLi9pMThuL2dldHRleHQnO1xuXG50eXBlIEFwcGxpY2F0aW9uID0gSUlkZW50aWZpZWQgfCBJQXBwbGljYXRpb24gfCBudW1iZXIgfCBzdHJpbmc7XG50eXBlIFBhY2thZ2UgPSBBcHBsaWNhdGlvbjtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFBsdWdpbnNTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBhcHBsaWNhdGlvblNlcnZpY2U6IEFwcGxpY2F0aW9uU2VydmljZSwgcHJpdmF0ZSBjbGllbnQ6IEZldGNoQ2xpZW50KSB7fVxuXG4gIGFzeW5jIGxpc3RQYWNrYWdlcygpIHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuYXBwbGljYXRpb25TZXJ2aWNlLmxpc3QoeyBwYWdlU2l6ZTogMjAwMCB9KTtcbiAgICByZXR1cm4gZGF0YS5maWx0ZXIoKGFwcDogYW55KSA9PiBhcHAuZXhwb3J0cyB8fCAoYXBwLm1hbmlmZXN0ICYmIGFwcC5tYW5pZmVzdC5leHBvcnRzKSk7XG4gIH1cblxuICBhc3luYyBsaXN0VmVyc2lvbnMoZm9yUGFja2FnZTogUGFja2FnZSkge1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5hcHBsaWNhdGlvblNlcnZpY2UuYmluYXJ5KGZvclBhY2thZ2UpLmxpc3RQbHVnaW5zKCk7XG4gICAgcmV0dXJuIGRhdGFcbiAgICAgIC5tYXAocGx1Z2luID0+ICh7IC4uLnBsdWdpbi5wbHVnaW5QYWNrYWdlLCB2ZXJzaW9uOiBwbHVnaW4ucGx1Z2luTmFtZSB9KSlcbiAgICAgIC5maWx0ZXIocGx1Z2luID0+IHBsdWdpbi5leHBvcnRzKTtcbiAgfVxuXG4gIGFzeW5jIGxpc3RJbnN0YWxsZWQoZm9yQXBwOiBBcHBsaWNhdGlvbiwgZmxhdCA9IHRydWUpIHtcbiAgICBjb25zdCBhcHAgPSBhd2FpdCB0aGlzLmdldEFwcGxpY2F0aW9uKGZvckFwcCk7XG4gICAgY29uc3QgYzh5SnNvbiA9IGF3YWl0IHRoaXMuZ2V0Q3VtdWxvY2l0eUpzb25GaWxlKGFwcCk7XG4gICAgaWYgKGZsYXQpIHtcbiAgICAgIGxldCBmbGF0TGlzdCA9IFtdO1xuICAgICAgZm9yIChjb25zdCBrZXkgaW4gYzh5SnNvbi5pbXBvcnRzKSB7XG4gICAgICAgIGlmIChjOHlKc29uLmltcG9ydHMuaGFzT3duUHJvcGVydHkoa2V5KSkge1xuICAgICAgICAgIGZsYXRMaXN0ID0gW1xuICAgICAgICAgICAgLi4uZmxhdExpc3QsXG4gICAgICAgICAgICAuLi5jOHlKc29uLmltcG9ydHNba2V5XS5tYXAoaW1wID0+XG4gICAgICAgICAgICAgIC9ALy50ZXN0KGtleSkgPyBgJHtrZXl9LyR7aW1wfWAgOiBgJHtrZXl9QGxhdGVzdC8ke2ltcH1gXG4gICAgICAgICAgICApXG4gICAgICAgICAgXTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIGZsYXRMaXN0O1xuICAgIH1cbiAgICByZXR1cm4gYzh5SnNvbi5pbXBvcnRzO1xuICB9XG5cbiAgYXN5bmMgYWRkQnlOYW1lKGFkZFRvOiBBcHBsaWNhdGlvbiwgcGx1Z2luTmFtZTogc3RyaW5nKSB7XG4gICAgY29uc3QgbmFtZSA9IHBsdWdpbk5hbWUuc3BsaXQoJy8vJykucG9wKCk7XG4gICAgY29uc3QgY29udGV4dFBhdGggPSBwbHVnaW5OYW1lLnNwbGl0KCcvLycpLnNoaWZ0KCk7XG4gICAgY29uc3QgcGtnID0ge1xuICAgICAgY29udGV4dFBhdGhcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLmFkZChhZGRUbywgcGtnLCBuYW1lKTtcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZUJ5TmFtZShyZW1vdmVGcm9tOiBBcHBsaWNhdGlvbiwgcGx1Z2luTmFtZTogc3RyaW5nKSB7XG4gICAgY29uc3QgbmFtZSA9IHBsdWdpbk5hbWUuc3BsaXQoJy8nKS5wb3AoKTtcbiAgICBjb25zdCBjb250ZXh0UGF0aCA9IC9AbGF0ZXN0Ly50ZXN0KHBsdWdpbk5hbWUpXG4gICAgICA/IHBsdWdpbk5hbWUuc3BsaXQoJ0AnKS5zaGlmdCgpXG4gICAgICA6IHBsdWdpbk5hbWUuc3BsaXQoJy8nKS5zaGlmdCgpO1xuXG4gICAgY29uc3QgcGtnID0ge1xuICAgICAgY29udGV4dFBhdGhcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLnJlbW92ZShyZW1vdmVGcm9tLCBwa2csIG5hbWUpO1xuICB9XG5cbiAgYXN5bmMgYWRkKGFkZFRvQXBwOiBBcHBsaWNhdGlvbiwgZnJvbVBhY2thZ2U6IFBhY2thZ2UsIG5hbWU6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLmFkZE9yUmVtb3ZlKGFkZFRvQXBwLCBmcm9tUGFja2FnZSwgbmFtZSwgdHJ1ZSk7XG4gIH1cblxuICBhc3luYyByZW1vdmUocmVtb3ZlRnJvbUFwcDogQXBwbGljYXRpb24sIGZyb21QYWNrYWdlOiBQYWNrYWdlLCBuYW1lOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5hZGRPclJlbW92ZShyZW1vdmVGcm9tQXBwLCBmcm9tUGFja2FnZSwgbmFtZSwgZmFsc2UpO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlUmVtb3Rlc0luQ3VtdWxvY2l0eUpzb24oYXBwOiBJQXBwbGljYXRpb24sIHJlbW90ZXM6IEFwcGxpY2F0aW9uUmVtb3RlUGx1Z2lucykge1xuICAgIGNvbnN0IGM4eUpzb24gPSBhd2FpdCB0aGlzLmdldEN1bXVsb2NpdHlKc29uRmlsZShhcHApO1xuICAgIHJldHVybiB0aGlzLnN0b3JlQ3VtdWxvY2l0eUpzb24oYXBwLCB7IC4uLmM4eUpzb24sIHJlbW90ZXN9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgYWRkT3JSZW1vdmUoYWRkVG9BcHA6IEFwcGxpY2F0aW9uLCBmcm9tUGFja2FnZTogUGFja2FnZSwgbmFtZTogc3RyaW5nLCBhZGQgPSB0cnVlKSB7XG4gICAgY29uc3QgYXBwbGljYXRpb24gPSBhd2FpdCB0aGlzLmdldEFwcGxpY2F0aW9uKGFkZFRvQXBwKTtcbiAgICBjb25zdCBwa2cgPSBhd2FpdCB0aGlzLmdldEFwcGxpY2F0aW9uKGZyb21QYWNrYWdlKTtcbiAgICBjb25zdCBjOHlKc29uID0gYXdhaXQgdGhpcy5nZXRDdW11bG9jaXR5SnNvbkZpbGUoYXBwbGljYXRpb24pO1xuXG4gICAgLy8gVE9ETzogVmVyc2lvbnM/ISFcbiAgICBjb25zdCBwa2dJbXBvcnQgPSBuZXcgU2V0KGM4eUpzb24uaW1wb3J0c1twa2cuY29udGV4dFBhdGhdKTtcbiAgICBpZiAoYWRkKSB7XG4gICAgICBwa2dJbXBvcnQuYWRkKG5hbWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwa2dJbXBvcnQuZGVsZXRlKG5hbWUpO1xuICAgIH1cbiAgICBjOHlKc29uLmltcG9ydHNbcGtnLmNvbnRleHRQYXRoXSA9IEFycmF5LmZyb20ocGtnSW1wb3J0KTtcblxuICAgIGF3YWl0IHRoaXMuc3RvcmVDdW11bG9jaXR5SnNvbihhcHBsaWNhdGlvbiwgYzh5SnNvbik7XG4gICAgcmV0dXJuIGM4eUpzb247XG4gIH1cblxuICBwcml2YXRlIHN0b3JlQ3VtdWxvY2l0eUpzb24oYXBwbGljYXRpb24sIGM4eUpzb24pIHtcbiAgICByZXR1cm4gdGhpcy5hcHBsaWNhdGlvblNlcnZpY2VcbiAgICAgIC5iaW5hcnkoYXBwbGljYXRpb24pXG4gICAgICAudXBkYXRlRmlsZXMoW3sgcGF0aDogJ2N1bXVsb2NpdHkuanNvbicsIGNvbnRlbnRzOiBKU09OLnN0cmluZ2lmeShjOHlKc29uKSBhcyBhbnkgfV0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRDdW11bG9jaXR5SnNvbkZpbGUoYXBwOiBJQXBwbGljYXRpb24pIHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmNsaWVudC5mZXRjaChgL2FwcHMvJHthcHAuY29udGV4dFBhdGh9L2N1bXVsb2NpdHkuanNvbmApO1xuICAgIGlmIChyZXN1bHQuc3RhdHVzID49IDQwMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGdldHRleHQoJ05vIEN1bXVsb2NpdHkgSW9UIG1hbmlmZXN0IGZvdW5kLicpKTtcbiAgICB9XG4gICAgY29uc3QgYzh5SnNvbiA9IGF3YWl0IHJlc3VsdC5qc29uKCk7XG4gICAgaWYgKCFjOHlKc29uLmltcG9ydHMpIHtcbiAgICAgIGM4eUpzb24uaW1wb3J0cyA9IHt9O1xuICAgIH1cbiAgICByZXR1cm4gYzh5SnNvbjtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0QXBwbGljYXRpb24oYXBwOiBBcHBsaWNhdGlvbik6IFByb21pc2U8SUFwcGxpY2F0aW9uPiB7XG4gICAgaWYgKHR5cGVvZiBhcHAgIT09ICdudW1iZXInICYmIChhcHAgYXMgSUFwcGxpY2F0aW9uKS5jb250ZXh0UGF0aCkge1xuICAgICAgcmV0dXJuIGFwcCBhcyBJQXBwbGljYXRpb247XG4gICAgfVxuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5hcHBsaWNhdGlvblNlcnZpY2UuZGV0YWlsKGFwcCk7XG4gICAgcmV0dXJuIGRhdGE7XG4gIH1cbn1cbiJdfQ==