{"version":3,"file":"c8y-ngx-components-api.js","sources":["../../api/api.service.ts","../../api/data.module.ts","../../api/c8y-ngx-components-api.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { FetchClient, IFetchOptions } from '@c8y/client';\nimport { Subject, Observable } from 'rxjs';\nimport { ApiCall, ApiCallOptions } from './api.model';\nimport { filter } from 'rxjs/operators';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class ApiService {\n  calls: Observable<ApiCall>;\n  private callsSubject = new Subject<ApiCall>();\n\n  constructor(private client: FetchClient) {\n    this.calls = this.callsSubject.asObservable();\n    this.hookIntoClientFetch();\n  }\n\n  hookResponse(hookFilter: (call: ApiCall) => boolean) {\n    return this.callsSubject.pipe(\n      filter(({ phase }) => phase === 'finish'),\n      filter(hookFilter)\n    );\n  }\n\n  hookRequest(hookFilter: (call: ApiCall) => boolean) {\n    return this.callsSubject.pipe(\n      filter(({ phase }) => phase === 'start'),\n      filter(hookFilter)\n    );\n  }\n\n  async onFinish(call: ApiCall) {\n    this.callsSubject.next({ phase: 'finish', ...call });\n  }\n\n  onStart(call: ApiCall) {\n    this.callsSubject.next({ phase: 'start', ...call });\n  }\n\n  async resolveData(call: ApiCall): Promise<any> {\n    const { response, method } = call;\n    if ('data' in response) {\n      return Promise.resolve({ data: response.data, method });\n    } else {\n      const cb = (data) => ({ data, method});\n      return (response as Response).clone().json().then(cb, cb);\n    }\n  }\n\n  private hookIntoClientFetch() {\n    const fetch = this.client.fetch.bind(this.client);\n    this.client.fetch = async (url, options: ApiCallOptions & IFetchOptions = { method: 'GET'}) => {\n      const { method } = options;\n      this.onStart({ options, method, url });\n      let fetchPromise = fetch(url, options);\n      if (typeof options.responseInterceptor === 'function') {\n        fetchPromise = fetchPromise.then(options.responseInterceptor);\n      }\n      fetchPromise.then(\n        (response: Response) => this.onFinish({ response, url, options, method }),\n        (response: Response) => this.onFinish({ response, url, options, method })\n      );\n      return fetchPromise;\n    };\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { BasicAuth, FetchClient, Realtime, CookieAuth } from '@c8y/client';\nimport { ApiService } from './api.service';\nimport * as services from './services';\n\nfunction toProvider(provide) {\n  let deps: any[] = [FetchClient, Realtime];\n  if (provide === FetchClient)  {\n    deps = [CookieAuth];\n  }\n  if (provide === BasicAuth || provide === CookieAuth)  {\n    deps = [];\n  }\n  if (provide === Realtime) {\n    deps = [FetchClient];\n  }\n  return {provide, useClass: provide, deps};\n}\n\nconst providers: any[] = (Object.keys(services).map((k) => toProvider(services[k])) as any[])\n  .concat([\n    { provide: ApiService, useClass: ApiService, deps: [FetchClient] }\n  ]);\n// @dynamic\n@NgModule({\n  providers\n})\nexport class DataModule {\n  static providers() {\n    return providers;\n  }\n  static forRoot() {\n    return {\n      ngModule: DataModule,\n      providers\n    };\n  }\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}