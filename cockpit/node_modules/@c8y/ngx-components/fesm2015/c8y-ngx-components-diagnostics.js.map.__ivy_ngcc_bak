{"version":3,"file":"c8y-ngx-components-diagnostics.js","sources":["../../diagnostics/diagnostics.service.ts","../../diagnostics/diagnostics-tab.guard.ts","../../diagnostics/diagnostics.component.ts","../../diagnostics/diagnostics.module.ts","../../diagnostics/c8y-ngx-components-diagnostics.ts"],"sourcesContent":["import { Observable } from 'rxjs';\nimport { Injectable } from '@angular/core';\nimport {\n  IManagedObject,\n  IResultList,\n  InventoryBinaryService,\n  IOperation,\n  OperationService,\n  OperationStatus\n} from '@c8y/client';\nimport { AlertService, gettext, ModalService } from '@c8y/ngx-components';\nimport { assign } from 'lodash-es';\nimport { switchMap } from 'rxjs/operators';\n\n@Injectable()\nexport class DiagnosticsService {\n  readonly fragment = 'c8y_DiagnosticReport';\n  constructor(\n    private operationService: OperationService,\n    private inventoryBinary: InventoryBinaryService,\n    private modalService: ModalService,\n    private alertService: AlertService\n  ) {}\n\n  isSupportedDevice(device): boolean {\n    const supportedOperations = (device && device.c8y_SupportedOperations) || [];\n    return supportedOperations.includes(this.fragment);\n  }\n\n  getOperations$(device$: Observable<IManagedObject>): Observable<IResultList<IOperation>> {\n    return device$.pipe(\n      switchMap(device =>\n        this.operationService.list({\n          deviceId: device.id,\n          fragmentType: this.fragment,\n          dateFrom: new Date(0).toISOString(),\n          dateTo: new Date(Date.now()).toISOString(),\n          revert: true,\n          pageSize: 10,\n          withTotalPages: true\n        })\n      )\n    );\n  }\n\n  async createOperation(deviceId: string) {\n    const operation = {\n      deviceId,\n      description: gettext('Diagnostic file request'),\n      [this.fragment]: {}\n    };\n    try {\n      await this.operationService.create(operation);\n      this.alertService.success(gettext('Diagnostic file request sent.'));\n    } catch (error) {\n      this.alertService.addServerFailure(error);\n    }\n  }\n\n  async deleteOperation(operation: IOperation) {\n    try {\n      const result = await this.modalService.confirm(\n        gettext('Delete diagnostic file'),\n        gettext('You are about to delete this diagnostic file. Do you want to proceed?'),\n        'danger',\n        {\n          ok: gettext('Delete'),\n          cancel: gettext('Cancel')\n        }\n      );\n\n      if (result) {\n        this.deleteDiagnosticsBinary(operation);\n      }\n    } catch (error) {\n      // Do nothing\n    }\n  }\n\n  async cancelOperation(operation: IOperation) {\n    try {\n      const operationAfterUpdate = (\n        await this.operationService.update({\n          id: operation.id,\n          status: OperationStatus.FAILED,\n          failureReason: gettext('Operation cancelled by user.')\n        })\n      ).data;\n      assign(operation, operationAfterUpdate);\n      this.alertService.success(gettext('Diagnostic file request cancelled.'));\n    } catch (ex) {\n      this.alertService.addServerFailure(ex);\n    }\n  }\n\n  private getOperation(op: IOperation) {\n    if (!op) {\n      return null;\n    }\n    return op && op[this.fragment];\n  }\n\n  private async deleteDiagnosticsBinary(op: IOperation) {\n    const operation = this.getOperation(op);\n    if (operation && operation.file) {\n      const { file } = operation;\n      try {\n        const binaryId = this.inventoryBinary.getIdFromUrl(file);\n        const result = await this.inventoryBinary.delete(binaryId);\n        if (result) {\n          this.deleteDiagnosticsFragment(op);\n        }\n      } catch (err) {\n        if (err.res.status === 404) {\n          // In case the file is already deleted via other means we want to delete the fragment\n          this.deleteDiagnosticsFragment(op);\n        } else {\n          const msg = gettext('Could not delete the diagnostic file.');\n          this.alertService.danger(msg);\n        }\n      }\n    }\n  }\n\n  private async deleteDiagnosticsFragment(op: IOperation) {\n    const deleteOp = {\n      id: op.id,\n      status: op.status,\n      [this.fragment]: null\n    };\n    try {\n      const operationAfterUpdate = (await this.operationService.update(deleteOp)).data;\n      assign(op, operationAfterUpdate);\n      this.alertService.success(gettext('Diagnostic file deleted.'));\n    } catch (error) {\n      this.alertService.addServerFailure(error);\n    }\n  }\n}\n","import { DiagnosticsService } from './diagnostics.service';\nimport { Injectable } from '@angular/core';\nimport { CanActivate, ActivatedRouteSnapshot } from '@angular/router';\n\n@Injectable()\nexport class DiagnosticsTabGuard implements CanActivate {\n  constructor(private diagnosticsService: DiagnosticsService) {}\n\n  canActivate(route: ActivatedRouteSnapshot) {\n    const device = route.data.contextData || route.parent.data.contextData;\n    return this.diagnosticsService.isSupportedDevice(device);\n  }\n}\n","import { DiagnosticsService } from './diagnostics.service';\nimport { ActivatedRoute } from '@angular/router';\nimport { Component } from '@angular/core';\nimport { BehaviorSubject, pipe } from 'rxjs';\nimport { map } from 'rxjs/operators';\nimport {\n  ForOfRealtimeOptions,\n  operationStatusClasses,\n  operationStatusIcons,\n  OperationRealtimeService\n} from '@c8y/ngx-components';\nimport { IManagedObject, IOperation } from '@c8y/client';\n@Component({\n  templateUrl: './diagnostics.component.html',\n  selector: 'c8y-diagnostics'\n})\nexport class DiagnosticsComponent {\n  statusIcons = operationStatusIcons;\n  statusClasses = operationStatusClasses;\n  deviceId: string = this.route.snapshot.parent.data.contextData.id;\n  device$ = new BehaviorSubject<IManagedObject>(this.route.snapshot.parent.data.contextData);\n  operations$ = this.diagnosticService.getOperations$(this.device$);\n  operationsPipe = pipe(\n    map((ops: IOperation[]) => ops.filter(op => op[this.diagnosticService.fragment]))\n  );\n  realtimeOptions: ForOfRealtimeOptions = {\n    entityOrId: this.deviceId,\n    removeOnUpdate: true,\n    insertOnUpdate: true\n  } as ForOfRealtimeOptions;\n  operationCount: number;\n\n  constructor(\n    private route: ActivatedRoute,\n    private diagnosticService: DiagnosticsService,\n    public operationRealtime: OperationRealtimeService\n  ) {}\n\n  onDiagnosticRequest() {\n    this.diagnosticService.createOperation(this.deviceId);\n  }\n\n  onDelete(operation: IOperation) {\n    this.diagnosticService.deleteOperation(operation);\n  }\n\n  onCancel(operation: IOperation) {\n    this.diagnosticService.cancelOperation(operation);\n  }\n}\n","import { DiagnosticsTabGuard } from './diagnostics-tab.guard';\nimport { ListGroupModule } from '@c8y/ngx-components';\nimport { RouterModule } from '@angular/router';\nimport { DiagnosticsService } from './diagnostics.service';\nimport { CoreModule, gettext, HOOK_ROUTE, Route, ViewContext } from '@c8y/ngx-components';\nimport { DiagnosticsComponent } from './diagnostics.component';\nimport { NgModule } from '@angular/core';\nimport { CommonModule } from '@angular/common';\nimport { TooltipModule } from 'ngx-bootstrap/tooltip';\nimport { BsDropdownModule, BsDropdownConfig } from 'ngx-bootstrap/dropdown';\nimport { RepositoryModule } from '@c8y/ngx-components/repository';\n\n@NgModule({\n  imports: [\n    CoreModule,\n    RouterModule,\n    CommonModule,\n    ListGroupModule,\n    RepositoryModule,\n    BsDropdownModule,\n    TooltipModule\n  ],\n  declarations: [DiagnosticsComponent],\n  exports: [DiagnosticsComponent],\n  providers: [\n    DiagnosticsService,\n    BsDropdownConfig,\n    DiagnosticsTabGuard,\n    {\n      provide: HOOK_ROUTE,\n      useValue: [\n        {\n          context: ViewContext.Device,\n          path: 'diagnostics',\n          component: DiagnosticsComponent,\n          label: gettext('Diagnostics'),\n          icon: 'stethoscope',\n          canActivate: [DiagnosticsTabGuard],\n          priority: 200\n        }\n      ] as Route[],\n      multi: true\n    }\n  ]\n})\nexport class DiagnosticsModule {}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":[],"mappings":"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"}