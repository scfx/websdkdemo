"use strict";function _slicedToArray(n,e){return _arrayWithHoles(n)||_iterableToArrayLimit(n,e)||_unsupportedIterableToArray(n,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(n,e){if(n){if("string"==typeof n)return _arrayLikeToArray(n,e);var t=Object.prototype.toString.call(n).slice(8,-1);return"Object"===t&&n.constructor&&(t=n.constructor.name),"Map"===t||"Set"===t?Array.from(n):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(n,e):void 0}}function _arrayLikeToArray(n,e){(null==e||e>n.length)&&(e=n.length);for(var t=0,r=new Array(e);t<e;t++)r[t]=n[t];return r}function _iterableToArrayLimit(n,e){var t=null==n?null:"undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(null!=t){var r,o,i=[],a=!0,c=!1;try{for(t=t.call(n);!(a=(r=t.next()).done)&&(i.push(r.value),!e||i.length!==e);a=!0);}catch(n){c=!0,o=n}finally{try{a||null==t.return||t.return()}finally{if(c)throw o}}return i}}function _arrayWithHoles(n){if(Array.isArray(n))return n}!function(){function ln(n,e,o,i,a,c,u,d,l,t,r,s,f,h,p,g){var v=n("dashboards"),m=n("dashboardLists"),b="c8y_Dashboard",y={welcome:{icon:"cloud",name:p.getString("Welcome")},home:{icon:"home",name:p.getString("Home")}};function C(n){return _.map(n,function(n){return _.assign(_.get(n,b,{}),{id:n.id})})}function x(n){var e=n||{},t=_.assign(_.get(e,b,{}),{id:e.id},function(n){var t=/^c8y_Dashboard!(.+)$/;return _.pickBy(n,function(n,e){return t.test(e)})}(e));return _.set(t,"global",!!_.get(e,"c8y_Global")),function(n){var e=["templateUrl","configTemplateUrl"],t=_.map(n.children,function(n){return c.all(_.map(e,_.partial(O,n)))});return c.all(t).then(function(){return n})}(t).then(T)}function T(e){return e.children?function(n){return r.list().then(function(e){return _(n).mapValues(function(n){return R(n,e,!1)}).value()})}(e.children).then(function(n){return e.children=n,e}):e}function R(n,e,t){var r=_.cloneDeep(n),o=_.find(e,function(n){var e=n.name&&n.name===r.name,t=n.templateUrl&&n.templateUrl===r.templateUrl;return e||t});if(o){var i=o.replaceWith;return i&&(r.config=u.invoke(i.config,void 0,{oldConfig:r.config}),o=_.find(e,{name:i.component})),r.name=o.name,o.transformConfigWithContext&&(r.componentTransformConfigWithContext=o.transformConfigWithContext),o.widgetComponent?(r.widgetComponent=o.widgetComponent,delete r.templateUrl):r.templateUrl=o.templateUrl,o.configComponent?(r.configComponent=o.configComponent,delete r.configTemplateUrl):r.configTemplateUrl=o.configTemplateUrl,r}return t?null:r}function A(e){return s.canAdminMOs([e]).then(function(n){return n||(e.isFrozen=!n),e.readOnly=!n,e})}function D(n){return _.get(n,"isFrozen")}function I(n){return L(n,!0)}function E(n){return L(n,!1)}function L(n,e){return n.isFrozen=e,dn.saveAndWait(n).then(ln.clearCacheList)}function O(e,t){var n=e[t];return f.verifyPluginViewPath(n).then(function(n){return e[t]=n,e})}function w(t){return function(n){var e=_.isObjectLike(n)?n.id:n;return[b,t,e].join("!")}}var U=w("device"),P=w("group"),S=w("name"),N=w("type");function k(n){return v.put(W(n),_.cloneDeep(n))}function W(n){return _.isObjectLike(n)?n.id:n}function $(n,e){var t,r=_.assign(n||{},{fragmentType:e||b}),o=l.list(r).then(C);return e&&!n&&(t=m.get(e),o.then(function(n){0<n.length&&m.put(e,n)})),t?c.when(t):o}function j(){m.removeAll(),e.$emit("dashboard:refresh")}function G(n,e,t){var r=v.get(W(n)),o=!(t&&r)&&l.detail(n).then(d.getResData).then(x).then(A).then(k);return(r?c.when(r):o).then(V).then(M(e))}function M(t){return function(n){var e=n;return(e.deviceType||t)&&(e=function(n){return cn().then(_.partial(z,n))}(_.cloneDeep(e))),e}}function z(n,e){return c.all(_.map(n.children,function(n){return H(e,n.config)})).then(_.constant(n))}function H(e,n){var t=function(n){n.__target={id:e.id,name:e.name}};return n&&(n.device={id:e.id,name:e.name},n.datapoints&&_.forEach(n.datapoints,t),n.alarmsEventsConfigs&&_.forEach(n.alarmsEventsConfigs,t),n.options&&n.options.dataPoints&&_.forEach(n.options.dataPoints,t),n.datapointsGauge&&_.forEach(n.datapointsGauge,t),n.datapointsLabels&&_.forEach(n.datapointsLabels,t)),n}function V(t){return cn().then(function(e){return c.all(_.map(t.children,function(n){return F(e,t,n)}))}).then(_.constant(t))}function F(t,r,e){var n=e.config||{},o=_.compact([e.transformConfigWithContext,e.componentTransformConfigWithContext]);return _.reduce(o,function(n,e){return n.then(function(n){return u.invoke(e,null,{config:n,context:t,dashboard:r})})},c.resolve(n)).then(function(n){return _.assign(e,{config:n})})}function B(n){return r.list().then(function(e){return _(n).map(function(n){return R(n,e,!0)}).compact().value()})}function Y(t,n){_.forEach(n,function(n,e){t[e]&&(t[e]=n(t[e]))})}function q(n,e,t){return _.forEach(n,function(n){n.__target=J(n.__target,e,t)}),n}function J(n,e,t){return n&&n.id===t.id&&_.assign(n,_.pick(e,["id","name"])),n}function K(n){var t=["id","creationContext","readOnly"],r=/^c8y_Dashboard!/,e=_.cloneDeep(n);e.global=!!e.deviceType||e.global;var o,i=e.id,a={id:i},c=i?"update":"createConfirm";a[b]=_.pickBy(e,function(n,e){return!r.test(e)&&!_.includes(t,e)}),function(n){n[b].global&&_.assign(n,{c8y_Global:{}})}(a);var u=e.deviceType?{}:e.creationContext;return o=l[c](a,u),"update"==c&&(o=o.then(function(){return n})),"createConfirm"==c&&(o=o.then(d.getResData).then(x)),o.then(k)}function Q(n,e,t,r){var o={id:t.id},i=n(e);return o[i]=r?null:{},v.get(i)&&v.remove(i),l.save(o)}function X(n,e){return $(null,n(e))}function Z(){if(dn.forcedContext)return dn.forcedContext;var t=null,r=null;return _.forEach(["report","device","group"],function(n){var e=_.get(o,"".concat(n,"Id"));e&&(t=n,r=e)}),{context:t,id:r}}function nn(n,e){var t={templateUrl:":::PLUGIN_PATH:::/dashboardWidget/config.html",controller:"DashboardWidgetConfigController",size:"lg",resolve:{dashboard:function(){return e||{}},component:function(){return n||{}},hideTarget:function(){return e&&e.deviceType}}};return i.open(t).result}function en(n,r){var e={template:'<div ng-include="\':::PLUGIN_PATH:::/dashboard/new.html\'" ng-controller="DashboardEditCtrl"></div>',controller:["$scope","$uibModalInstance","config",function(n,e,t){n.dashboardId="new",n.modalInstance=e,n.config=t||{},n.creationContext=r}],size:"lg",resolve:{config:_.constant(n)}};return i.open(e).result}function tn(n,e){return function(n){var e={templateUrl:":::PLUGIN_PATH:::/dashboard/select.html",controller:"DashboardSelectController",size:"lg",resolve:{config:_.constant(n)}};return i.open(e).result}(angular.extend({title:h("Select dashboard"),preventNew:!0,selectLabel:h("Select"),useReports:!0},e)).then(function(t){return n.templateUrl?on(t,n):B([n]).then(function(n){var e=_slicedToArray(n,1)[0];return on(t,e)})})}var rn={};function on(n,e,t){var r=n.id||n;rn[r]=rn[r]||{children:[]};var o=rn[r],i=o.promise;return o.children.push({child:e,remove:t}),i||(o.promise=a(function(){return c.all({dashboard:G(n,!1,!0),contextObject:cn()}).then(function(n){var t=n.dashboard,r=n.contextObject;return c.all(_.map(o.children,function(e){return(e.remove?c.resolve(e.child):F(r,t,e.child)).then(function(n){t.children=an(t.children||{},n,e.remove)})})).then(_.constant(t))}).then(K)}),(i=o.promise).finally(function(){delete rn[r]})),i}function an(n,e,t){return e.id||(e.id=String(Math.random()).substr(2)),t?delete n[e.id]:n[e.id]=e,function(n){var e=0;return _(n).sortBy("position").forEach(function(n){n.position=e,e+=1}),_.cloneDeep(n)}(n)}function cn(){var e=Z();return e.id?t.detailCached(e.id,{withChildren:!1}).then(d.getResData).then(function(n){return n||{id:e.id}}):c.when({})}var un=[];var dn={list:$,save:K,saveAndWait:_.partialRight(K,!0),detail:G,detailPredefinedReadOnly:function(n,e){var t={children:{},isFrozen:!0,readOnly:!0};return B(n).then(function(n){return _.forEach(n,function(n){an(t.children,n)}),t}).then(V).then(M(e))},named:function(e,r,o){var i=function(n){return K(n).then(_.partial(Q,S,e)).then(d.getResData).then(function(n){return G(n,o)})};return $(null,S(e)).then(function(n){var e;if(n.length)e=G(_.head(n).id,o);else{var t={children:{}};e=B(r).then(function(n){return _.forEach(n,function(n){an(t.children,n)}),s.hasAnyRole(["ROLE_INVENTORY_ADMIN","ROLE_INVENTORY_CREATE"]).then(function(n){return!!n||c.reject()}).then(_.partial(i,t)).catch(_.partial(_.identity,t))})}return e})},isNamed:function(n){return _.some(_.keys(n),function(n){return/^c8y_Dashboard!name!/.test(n)})},remove:function(n){return v.remove(W(n)),e.$emit("dashboard:remove",W(n)),l.remove(n)},isLocked:D,toggleLock:function(n){return D(n)?E(n):I(n)},lock:I,unlock:E,deviceAdd:_.partial(Q,U),deviceRemove:_.partialRight(_.partial(Q,U),!0),deviceList:_.partial(X,U),deviceTypeAdd:_.partial(Q,N),deviceTypeRemove:_.partialRight(_.partial(Q,N),!0),deviceTypeList:function(n){return c.all([X(U,n.id),X(N,n.type)]).then(_.flattenDeep)},groupAdd:_.partial(Q,P),groupRemove:_.partialRight(_.partial(Q,P),!0),groupList:_.partial(X,P),getContextObject:cn,transformChildWithContext:F,updateConfigTargetsWithContext:H,addDashboard:en,copyDashboard:function(n){var e,t=function(n){var e=Z(),r=e.id;function o(n){return n.__target.id!==r}if("device"!==e.context&&"group"!==e.context)return h("Only dashboards from devices or groups can be copied");if(!_.every(n.children,function(n){var e=n.config||{},t=!0;return e.device&&e.device.id!==r&&(t=!1),e.datapoints&&_.some(e.datapoints,o)&&(t=!1),t})){if("device"===e.context)return h("Only dashboards with widgets referencing the current device can be copied.");if("group"===e.context)return h("Only dashboards with widgets referencing the current group can be copied.")}return!1}(n);if(t)return g.warning(t),!1;un=[];var r=Z();return un.push({dashboard:_.cloneDeep(n),context:r}),"device"===r.context&&(e=h('Dashboard copied. Navigate to the desired device and select "Paste dashboard"')),"group"===r.context&&(e=h('Dashboard copied. Navigate to the desired group and select "Paste dashboard"')),g.success(e),!0},pasteDashboard:function(){if(un&&un.length)return cn().then(function(n){if(!function(n){var e,t=Z(),r=n.context.context;return t.context!==r&&("device"===r&&(e=h("Device dashboards can only be copied into a device.")),"group"===r&&(e=h("Group dashboards can only be copied into a group."))),e&&g.warning(e),!e}(_.last(un)))return!1;var e=un.pop(),t=e.dashboard,r=Z();r.name=n.name;var o=dn["".concat(r.context,"Add")];_.forEach(t,function(n,e){e.match(/!/)&&delete t[e]});var i=r.context;r.context===e.context.context&&["device","group"].includes(i)&&(t=function(n,i,a){var e=_.reduce(n.children,function(n,e){var t=e.id,r=e.config,o={device:function(n){return J(n,i,a)},datapoints:function(n){return q(n,i,a)},dataPoints:function(n){return q(n,i,a)},datapointsGauge:function(n){return q(n,i,a)},datapointsLabels:function(n){return q(n,i,a)}};return r&&(Y(r,o),r.options&&Y(r.options,o)),n[t]=e,n},{});return n.children=e,n}(t,r,e.context)),t.creationContext=r,delete t.id;var a=K(t);return a.then(function(n){return o(r.id,n)}).finally(j),a})},dashboardToPaste:function(){var n=un&&un[0];return n&&n.dashboard},selectDashboard:en,editCurrentDashboard:function(t){var n={template:'<div ng-include="\':::PLUGIN_PATH:::/dashboard/new.html\'" ng-controller="DashboardEditCtrl"></div>',controller:["$scope","$uibModalInstance",function(n,e){n.modalInstance=e,n.dashboardId=_.get(t,"dashboardId")}],size:"lg"};return i.open(n).result},editChildUI:nn,addChildUI:_.partial(nn,null),restoreDefaultChildren:function(t,n,r){return B(n).then(function(n){var e=t.children;return _.forEach(_.keys(e),function(n){an(e,e[n],!0)}),_.forEach(n,function(n){an(e,n)}),K(t).then(function(n){return G(n,r)})})},getContext:Z,getContextPath:function(){var n=Z(),e="";return"group"===n.context&&(e="/group/".concat(n.id)),"device"===n.context&&(e="/device/".concat(n.id)),e},appendChild:_.partialRight(on,!1),updateChild:_.partialRight(on,!1),removeChild:_.partialRight(on,!0),clearCacheList:j,addWidgetToSelectedDashboard:tn,addWidgetToSelectedDashboardInContext:function(n){return tn(n,{inContext:!0,preventCreate:!0,useReports:!1})},addWidgetToSelectedReport:function(n){return tn(n,{onlyReports:!0,useReports:!0,title:h("Select report"),preventCreate:!0})},getIconNameObj:function(n){var e={icon:n.icon||"th",name:n.name||p.getString("Dashboard")},t=function(n){var t=/^c8y_Dashboard!name!(.+?)[-_].+$/,e=_.pickBy(n,function(n,e){return t.test(e)}),r=_.keys(e);if(0<r.length){var o=r[0].match(t);return o[1]}return null}(n),r=d.getPluginService("c8yReports");if(t){var o=y[t];o&&(e.icon=o.icon||e.icon,e.name=o.name||e.name)}return"report"===t&&r&&(e=r.getReportFromDashboard(n).then(function(n){return _.pick(n,["icon","name"])})),c.resolve(e)},hasWritePermissions:function(n){return d.hasId(n)?s.canAdminMOs([n]):s.hasAnyRole(["ROLE_INVENTORY_ADMIN","ROLE_INVENTORY_CREATE"])},VERSION:2};return _.assign(dn)}ln.$inject=["$cacheFactory","$rootScope","$routeParams","$uibModal","$timeout","$q","$injector","c8yBase","dashboardInventorySvc","c8yInventory","c8yComponents","c8yPermissions","c8yUiUtil","gettext","gettextCatalog","c8yAlert"],angular.module("c8y.parts.dashboard2").factory("dashboardSvc",ln)}();