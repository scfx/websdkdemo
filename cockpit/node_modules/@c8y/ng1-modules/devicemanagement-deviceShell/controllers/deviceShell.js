"use strict";!function(){function e(c,a,e,r,o,d,t,n,l,i,m,u){var s,y,p=[],f={},v=3,g=t.getDeliveryTypes().defaultDeliveryType,T=t.getDeliveryTypes().standardDeliveryTypes;function h(){c.command={text:""},c.commandDeliveryType=g}function S(e){c.operations=e}function x(e,t){var n="SMS"===t;if(n&&!s)return l.warning(m("SMS transport is not configured.")),r.when();c.sendingCommand=!0;var i=function(e,t){return{deviceId:a.deviceId,description:m("Execute shell command")+(e.name?": ".concat(e.name):""),deliveryType:t?"SMS":void 0,c8y_Command:{text:e.text}}}(e,n);return d.createWithNotifications(i).then(function(e){return e.created.then(function(e){return function(t,e){d.detail(e).then(o.getResData).then(function(e){l.success(m("Command sent.")),_.assign(t,e),function(e){c.operations.push(e),function(e){p.length=0,D(e)}(e)}(t)})}(i,e)}),e.completed.then(function(e){return C(i,e)},function(){},function(e){return C(i,e)}),e.created}).finally(function(){e.text="",c.sendingCommand=!1})}function C(e,t){l.success(m("Command status updated.")),_.assign(e,t)}function D(e){if(E(e)){var t=p.indexOf(e);p.splice(t,1)}else p.push(e)}function E(e){return-1<p.indexOf(e)}function I(){return"/device/".concat(a.deviceId,"/control?fragmentType=c8y_Command")}function w(e){c.device=e}i.detail(a.deviceId).then(o.getResData).then(w),h(),(y={deviceId:a.deviceId,pageSize:v,fragmentType:"c8y_Command",revert:!0},d.list(o.timeOrderFilter(y))).then(S),t.canSendCommandsViaSMS().then(function(e){s=e}),c.execute=x,c.toggle=D,c.isOpen=E,c.cancel=d.cancel,c.viewHistory=function(){e.url(I())},c.getViewHistoryLink=I,c.getPredefinedCommand=function(){n({templateUrl:":::PLUGIN_PATH:::/views/commandTemplates.html",controller:"commandTemplatesCtrl",controllerAs:"vm"}).then(function(e){if("USE"===e.action){c.command.name=e.commandTemplate.name,c.command.text=e.commandTemplate.text,c.command.deliveryTypes=e.commandTemplate.deliveryTypes,c.commandDeliveryType=_.first(e.commandTemplate.deliveryTypes)||g;var t=c.$watch("command.text",function(e){e||(h(),t())});c.apply(),f.refresh()}else"EXECUTE"===e.action&&x(e.commandTemplate,e.deliveryType)})},c.deviceStatus=f,c.standardDeliveryTypes=T,c.defaultDeliveryType=g,c.isDeliveryTypeSupported=function(e,t){var n=_.get(t,"deliveryTypes");return _.isEmpty(n)||_.includes(n,e)},c.getExecuteButtonLabel=function(e){return e===g?u.getString("Execute"):u.getString("Execute (via {{ deliveryType | translate }})",{deliveryType:e})}}e.$inject=["$scope","$routeParams","$location","$q","c8yBase","c8yDeviceControl","c8yDeviceShell","c8yModal","c8yAlert","c8yInventory","gettext","gettextCatalog"],angular.module("c8y.deviceShell").controller("deviceShellCtrl",e)}();