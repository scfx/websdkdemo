"use strict";!function(){function e(s,e,r,n,a,i,t,o,u,c,d,p){var f,l=e.userId,g={PATTERN:{type:"pattern",text:p.validation.password.message},PASSWORD_MISSMATCH:{type:"password_missmatch",text:c("Password confirmation does not match.")},REQUIRED:{type:"required",text:c("This field is required.")},EMAIL:{type:"email",text:c("Invalid email address.")}};function h(e){!function(e){a.checkIfCurrent(e).then(function(e){s.isCurrent=e})}(e),s.user=e,s._groups={},(e.groups&&e.groups.references||[]).forEach(function(e){var r=e.group.id;s._groups[r]=!0}),s.showPassword=!e.id,s.changePasswordBtn=!s.showPassword,delete s.confirmPassword}function v(e){s.groups=e}function w(){l?a.detail(l).then(function(e){return e.data}).then(h):h({enabled:s.isNew=!0})}s.saving=!1,s.passwordRegex=p.validation.password.pattern,s.cancel=function(){r.path("/deviceusers")},s.save=function(e){if(s.saving=!0,s.userForm.$valid){var r=_.keys(s._groups).filter(function(e){return s._groups[e]}).map(function(e){return parseInt(e,10)});try{var t=a.save(e,s.password.currentPassword).then(function(e){var r=e.data;return l=r.userName,r.id=l,r}).then(function(e){return i.updateGroups(e,r)}).then(angular.bind({},w)).then(_.partial(o.success,c("Device updated.")));t.finally(function(){s.saving=!1}),t.then(function(){n.history.back()})}catch(e){o.danger(e.message),s.saving=!1}}},s.confirmPassword="",s.password={},s.invalid=angular.bind(t,t.invalid,s,"userForm"),s.changePasswordConfirm=function(e){s.userForm.confirmPassword.$setValidity(g.PASSWORD_MISSMATCH.type,e===s.user.password)},s.$watch("user.userName",function(e){e&&u.changeTitle({title:e},{skipTitleTranslation:!0})}),s.getErrorFeedback=function(e){var t=s.userForm[e]||{},n=[];return _.forEach(t.$error||{},function(e,r){e&&!t.$pristine&&n.push(d.getString(g[r.toUpperCase()].text))}),n.join(" ")},w(),i.list(f).then(v)}e.$inject=["$scope","$routeParams","$location","$window","c8yUser","c8yUserGroup","c8yBase","c8yAlert","c8yTitle","gettext","gettextCatalog","c8yConfig"],angular.module("c8y.parts.deviceUsers").controller("deviceUserDetailCtrl",e)}();