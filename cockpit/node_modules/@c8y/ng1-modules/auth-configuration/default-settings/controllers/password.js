"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?Object(arguments[e]):{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&i.push.apply(i,Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),i.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(){function e(u,r,i,e,o,a,c,t,l){var s,n="password",p="limit.validity",y="strength.validity",f="enforce.strength",g=t.loginOptions.BASIC.value.toUpperCase(),v=t.loginOptions.OAUTH2_INTERNAL.value.toUpperCase(),d=t.loginOptions.OAUTH2.value.toUpperCase(),h="SSO_REDIRECT",O={userManagementSource:"INTERNAL",grantType:"PASSWORD",providerName:"Cumulocity",visibleOnLoginPage:!0,type:g},m=!1;function b(){return t.list({silentError:!0}).then(i.getResData).then(T).catch(T)}function T(e){var t=e.loginOptions;s=void 0===t?[]:t;var n,i=N(),r=s.find(function(e){var t=e.type,n=e.grantType;return t===d&&"AUTHORIZATION_CODE"===n}),o=A();n=!r||i||o?i?i.type:o?o.type:O.type:h,u.loginModeType=n,u.previousLoginModeType=n,u.noOAuth=!r,S()}function L(){var e=[];if(D()){var t=u.loginModeType,n=!!A(),i=!!N();t===v?(n||e.push(function(){return P(g)}),i||e.push(function(){return P(v)})):t===g?(n||e.push(function(){return P(g)}),i&&e.push(C)):t===h&&(n&&e.push(E),i&&e.push(C)),e.push(S)}return e.reduce(function(e,t){return e.then(t)},r.resolve())}function S(){u.savedloginModeType=u.loginModeType}function A(){return s.find(function(e){return e.type===g&&!0===e.visibleOnLoginPage})}function N(){return s.find(function(e){return e.type===v&&!0===e.visibleOnLoginPage})}function P(e){return t.save(_objectSpread({},O,{type:e}))}function C(){var e=N();return e?t.remove(e):r.when()}function E(){var e=A();return e?t.remove(e):r.when()}function M(e){var t=e.key.replace(/\./g,"_"),n=JSON.parse(e.value);u[t]=e,u[t].value=n}function R(e){return o.detail({category:n,key:e}).then(i.getResData).catch(function(){return null})}function j(e){return o.getSystemOption({category:n,key:e}).then(i.getResData).catch(function(){return null})}function w(e){u.limit_validity.value=parseInt(e,10)}function U(e){M(_.assign({},e,{key:"system.".concat(e.key)}))}function D(){return u.loginModeType!==u.previousLoginModeType}e.changeTitle({title:c("Authentication")}),r.all({systemLimitKeyOption:j("limit.validity"),tenantLimitKeyOption:R(p)}).then(function(e){var t=e.systemLimitKeyOption,n=e.tenantLimitKeyOption;if(null!==n&&M(n),null!==t){var i;U(t);try{i=JSON.parse(t.value)}catch(e){}_.isUndefined(i)||0===i||(m=!0,u.validityLimitEnforced=m,u.limit_validity={value:i})}}),j(f).then(U),R(y).then(M),b(),u.save=function(t){var e=function(){S();var e=[m?r.when():o.updateOption(u.limit_validity),o.updateOption(u.strength_validity)];return r.all(e).then(L).then(function(){return D()?r.resolve():function(e){m||R(p).then(M);R(y).then(M),j(f).then(U),a.success(c("Login settings saved.")),e.$setPristine(),b()}(t)})},n=D()?l.requireLogout(e):e();return n.catch(function(e){"canceled"!==e&&a.danger(i.getResErrorMessage(e))})},u.validateDays=function(e){var t=e;_.isNaN(_.toNumber(t))||parseInt(t,10)<0?w(t=t.slice(0,-1)):w(t);t.length||w(0)},u.validityLimitEnforced=m,u.isLoginModeChanged=D}e.$inject=["$scope","$q","c8yBase","c8yTitle","c8ySettings","c8yAlert","gettext","c8yLoginOptions","c8yUserUtil"],angular.module("c8y.authenticationConfiguration").controller("passwordCtrl",e)}();