"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?Object(arguments[e]):{},n=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&n.push.apply(n,Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable})),n.forEach(function(e){_defineProperty(t,e,o[e])})}return t}function _defineProperty(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,n=new Array(t);o<t;o++)n[o]=e[o];return n}function _iterableToArrayLimit(e,t){var o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var n,r,i=[],a=!0,u=!1;try{for(o=o.call(e);!(a=(n=o.next()).done)&&(i.push(n.value),!t||i.length!==t);a=!0);}catch(e){u=!0,r=e}finally{try{a||null==o.return||o.return()}finally{if(u)throw r}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}!function(){function e(e){var n=this,r=/^(.+)\/((.+?)\/oauth2\/authorize)$/,t={visibleOnLoginPage:!0},o={providerName:"Azure AD",type:"oauth2",grantType:"AUTHORIZATION_CODE"};function i(e){return _.head(_.reject(e,_.isUndefined))}function a(e){return _.map(e,function(e,t){return"".concat(t,"=").concat(e)}).join("&")}e.$watch("vm.ssoConfiguration",function(){n.onChange({configuration:function(){var e="".concat(n.ssoConfiguration.aadAddress||"","/").concat(n.ssoConfiguration.tenant||"","/oauth2");return _objectSpread({},_.omit(n.ssoConfiguration,["applicationId","aadAddress","tenant","clientSecret","redirectAfterLogoutUrl","redirectAfterLogout"]),{audience:n.ssoConfiguration.applicationId,clientId:n.ssoConfiguration.applicationId,logoutRequest:n.ssoConfiguration.redirectAfterLogout?{method:"POST",url:"".concat(e,"/logout"),requestParams:{post_logout_redirect_uri:n.ssoConfiguration.redirectAfterLogoutUrl},headers:{},body:"",operation:"REDIRECT"}:{},authorizationRequest:{method:"GET",url:"".concat(e,"/authorize"),requestParams:{redirect_uri:"${redirectUri}",client_id:"${clientId}",response_type:"code"},headers:{},body:"",operation:"REDIRECT"},tokenRequest:{method:"POST",url:"".concat(e,"/token"),requestParams:{},headers:{},body:a({grant_type:"authorization_code",code:"${code}",redirect_uri:"${redirectUri}",resource:"${clientId}",client_id:"${clientId}",client_secret:encodeURIComponent(n.ssoConfiguration.clientSecret)}),operation:"EXECUTE"},refreshRequest:{method:"POST",url:"".concat(e,"/token"),requestParams:{},headers:{},body:a({grant_type:"refresh_token",refresh_token:"${refreshToken}",resource:"${clientId}",client_id:"${clientId}",client_secret:encodeURIComponent(n.ssoConfiguration.clientSecret)}),operation:"EXECUTE"}})}()})},!0),_.assign(n,{fieldsConfig:{aadAddress:!0,applicationId:!0,audience:!1,buttonName:!0,certificateType:!1,clientId:!1,clientSecret:!0,issuer:!0,providerName:!1,redirectToPlatform:!0,tenant:!0,useConstantValue:!1,visibleOnLoginPage:!0},$onChanges:function(e){e.inputConfiguration&&(n.ssoConfiguration=_.cloneDeep(n.inputConfiguration),_.defaults(n.ssoConfiguration,t),_.assign(n.ssoConfiguration,o),function(){var e=_.at(n.ssoConfiguration,["audience","clientId"]);_.set(n.ssoConfiguration,"applicationId",i(e))}(),function(){var e=_.at(n.ssoConfiguration,["authorizationRequest.url","tokenRequest.url","refreshRequest.url"]),t=_.map(e,function(e){return function(e){return _slicedToArray((e||"").match(r)||[],2)[1]}(e)});_.set(n.ssoConfiguration,"aadAddress",i(t));var o=_.map(e,function(e){return function(e){return _slicedToArray((e||"").match(r)||[],4)[3]}(e)});_.set(n.ssoConfiguration,"tenant",i(o))}(),function(){var e=_.at(n.ssoConfiguration,["tokenRequest.body","refreshRequest.body"]),t=_.map(e,function(e){return function(e){var t=_slicedToArray((e||"").match(/client_secret=([^&]+)/)||[],2)[1];return decodeURIComponent(t)}(e)});_.set(n.ssoConfiguration,"clientSecret",i(t))}(),_.defaultsDeep(n.ssoConfiguration,{userIdConfig:{jwtField:"upn"}}),_.set(n.ssoConfiguration,"userIdConfig.useConstantValue",!1),_.defaultsDeep(n.ssoConfiguration,{signatureVerificationConfig:{aad:{}}}),n.ssoConfiguration.redirectAfterLogout=_.has(n.ssoConfiguration,"logoutRequest.requestParams.post_logout_redirect_uri"),n.ssoConfiguration.redirectAfterLogout&&(n.ssoConfiguration.redirectAfterLogoutUrl=n.ssoConfiguration.logoutRequest.requestParams.post_logout_redirect_uri),_.unset(n.ssoConfiguration,"audience"),_.unset(n.ssoConfiguration,"clientId"),_.unset(n.ssoConfiguration,"authorizationRequest"),_.unset(n.ssoConfiguration,"tokenRequest"),_.unset(n.ssoConfiguration,"refreshRequest"),_.unset(n.ssoConfiguration,"signatureVerificationConfig.manual"),_.unset(n.ssoConfiguration,"userIdConfig.constantValue"))},onPartialChange:function(e){_.assign(n.ssoConfiguration,e)}})}e.$inject=["$scope"],angular.module("c8y.authenticationConfiguration").component("c8ySsoAadTemplate",{bindings:{inputConfiguration:"<ssoConfiguration",onChange:"&",apps:"<",groups:"<"},templateUrl:":::PLUGIN_PATH:::/sso-configuration/aad-template.html",controller:e,controllerAs:"vm"})}();