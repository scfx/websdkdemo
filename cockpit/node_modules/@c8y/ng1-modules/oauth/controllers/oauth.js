"use strict";angular.module("c8y.parts.oauth").controller("OAuthCtrl",["$scope","$location","$window","$http","c8ySettings","c8yAuth","c8yUser","c8yTitle","c8yAlert","gettext",function(r,t,e,o,c,n,a,i,u,d){var l=t.search(),s=t.host(),h="developer.cumulocity.com",p=t.protocol(),f=t.port(),y=a.current(),g=e.location.pathname,k=null;function v(t){var e=t.data;r.token=e.value}function m(t){var e=t.data;u.danger("".concat(e.error,": ").concat(e.error_description))}function T(e){return _.keys(e).map(function(t){return"".concat(t,"=").concat(e[t])}).join("&")}function w(t){var e={},n=[],o="redirect"===t?h:s,r=80!==parseInt(f,10)&&443!==parseInt(f,10)?":".concat(f):"",c="".concat(p,"://").concat(o).concat(r);return e.tenant_id=k,"login"===t&&(_.assign(e,{redirect_uri:w("redirect"),response_type:"code"}),n=[c,"/tenant/oauth?",T(e)]),"token"===t&&(n=[c,"/tenant/oauth?"]),"redirect"===t&&(n=[c,g,"%23/oauth"]),n.join("")}function O(){return w("login")}y.then(function(t){k=t.tenant,l.code?function(t){var e=w("token"),n={redirect_uri:w("redirect"),grant_type:"authorization_code",code:t};n.tenant_id=k,o({method:"POST",url:e,data:T(n),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(t){var e=t.data;e.refresh_token&&function(n){var o="paypal";c.list().then(function(t){var e="createOption";(t||[]).forEach(function(t){return t.category!==o||!(e="updateOption")}),c[e]({category:o,key:"refreshToken",value:n}).then(function(){r.token=n,r.$emit("message",{type:"success",text:d("Token saved.")})})})}(e.refresh_token)},m)}(l.code):c.detail({category:"paypal",key:"refreshToken"}).then(v),r.getLoginUrl=O}),i.changeTitle({title:d("OAuth")})}]);