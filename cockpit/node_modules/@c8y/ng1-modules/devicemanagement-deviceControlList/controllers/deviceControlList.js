"use strict";!function(){function n(i,a,t,r,o,c,n,l,e,d,u,s,g,f,p,h,m){var v,y,I=this,C={},A={},w=!0;function D(){return $().then(_.partialRight(L,!0))}function $(n){var e=function(n){var e=o.timeOrderFilter(n||{});return _.assign(e,a),e.revert=!0,e}(n);return c.list(e)}function L(n,e){return i.operations&&!e||(i.operations=[],C={},A={}),i.paging=n.paging,r.all(_.map(n,b))}function b(e){var t=r.when();return U(e)?C[e.id]?t:function(n){return r.when(n.deviceName||f.detail(n.deviceId).then(o.getResData).then(_.partial(_.pick,"name")))}(e).then(function(n){return e.deviceName=n,C[e.id]=e,i.operations.push(C[e.id]),t}):t}function T(n){var e=[];return c.listPaged(n).then(function(){return e},_.noop,function(n){e=e.concat(n)})}function O(){i.refreshLoading=!0,i.realtimeAnimation=!1,D().finally(function(){i.refreshLoading=!1,i.realtimeAnimation=!0})}function P(){e({templateUrl:":::PLUGIN_PATH:::/views/cancelAllModal.html",title:h("Confirm cancelling all pending operations"),body:h("Do you really want to cancel all pending operations?")}).then(_.partial(T,{status:c.status.PENDING,deviceId:a.deviceId})).then(S)}function S(n){var e=h("Cancelling pending operations"),t=n.map(function(n){return _.partial(c.cancel,n)});t.length?l.run(t,e).result.finally(O):s.warning(h("There are no pending operations"))}function E(){u.addAction({text:h("Cancel all pending operations"),action:function(){P()}})}function k(n){var e=o.getId(n);N(i.operations,n),n.bulkOperationId&&N(A[n.bulkOperationId].operations,n),delete C[e]}function N(n,e){var t=o.getId(e);_.remove(n,function(n){return n.id.toString()===t.toString()})}function U(n){var e=!n.groupId||!v||_.includes(v,n.groupId),t=!(a.status&&a.status!==n.status);return e&&t}i.singleOperations=C,i.bulkOperations=A,i.statusClass=function(n){return c.getStyle(n).cls},i.statusIcon=function(n){return c.getStyle(n).icon},i.loadNext=function(n){i.paging.loading=!0,(n?$({pageSize:n}):i.paging.next().then(L)).finally(function(){i.paging.loading=!1})},i.getStandardKeys=c.getStandardKeys,i.refresh=O,i.changeFilter=function(n){var e=(n||"").toUpperCase();t.search("status",e||null)},i.btnActive=function(n){return a.status===n},i.cancel=c.cancel,i.cancelAllPending=P,i.realtimeAnimation=!1,i.realtimeChannel="/operations/".concat(void 0!==a.deviceId?a.deviceId:"*"),I.realtimeChannel=i.realtimeChannel,i.getDisplayOptions=function(){return{showDetails:!1,showDeviceLink:!a.deviceId,showGroupLink:!a.deviceId,showEditable:!0}},i.isSingleOperation=function(n){return!_.isUndefined(n.deviceId)},i.sortOperationsListByTime=function(n){return moment(n.creationTime||n.startDate).toDate()},I.subTitle=function(){var n=_.get(i,"operations.length");return _.isUndefined(n)?"":m.getPlural(n,"1 loaded","{{$count}} loaded",{})},I.showTitle=function(){return!a.deviceId},I.realtimeSubscriberId=i.$id,g.addListener(i.$id,i.realtimeChannel,"".concat(i.$id,"-subscribed"),function(){i.realtimeAnimation=!1,D(),E()}),g.addListener(i.$id,i.realtimeChannel,"CREATE",function(n,e){i.realtimeAnimation=!0,b(e)}),g.addListener(i.$id,i.realtimeChannel,"UPDATE",function(n,e){C[e.id]?U(e)?function(n){C[n.id]=_.assign(C[n.id],n)}(e):k(e):b(e)}),g.addListener(i.$id,i.realtimeChannel,"DELETE",function(n,e){k(e)}),(y=r.when(),a.deviceId&&(y=p.directParentAssets(a.deviceId,null,null,{withChildren:!1}).then(function(n){return _.map(n,"id")}).then(function(n){v=n})),y).then($).then(L),E(),w&&g.switchRealtime(i.$id,i.realtimeChannel)}n.$inject=["$scope","$routeParams","$location","$q","c8yBase","c8yDeviceControl","c8yDeviceBulkControl","c8yBatchOp","c8yModal","c8yTitle","c8yActions","c8yAlert","c8yRealtime","c8yDevices","c8yInventory","gettext","gettextCatalog"],angular.module("c8y.parts.deviceControlList").controller("deviceControlCtrl",n)}();