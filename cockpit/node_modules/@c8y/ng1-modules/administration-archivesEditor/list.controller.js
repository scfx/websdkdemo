"use strict";!function(){function e(e,a,r,i,t,n,o,s,c){var u=this;_.assign(u,{refresh:function(){return e.refreshLoading=!0,r.detail(d).then(function(e){l=e.data}).then(function(){return r.listArchives(l).then(function(e){u.archives=e.attachments}).catch(function(){u.archives=[]})}).finally(function(){e.refreshLoading=!1})},isActive:function(e){return l.activeVersionId===e.id},toActivate:function(e){return u.toActivateVersionId===e.id},deleteArchive:function(e){return n({title:s("Delete archive"),body:c.getString("You are about to delete archive \"{{name}}{{description ? (' (' + description + ')') : ''}}\". Do you want to proceed?",e),status:"danger",labels:{ok:s("Delete")}}).then(function(){return u.requestInProgress=!0,r.deleteArchive(l,e).then(u.refresh).finally(function(){u.requestInProgress=!1})})},uploadArchive:function(){var t=a.when();6===u.archives.length&&(t=n({title:s("Delete oldest archive and continue"),body:s("Up to 6 archives can be saved in the platform. If you upload a new archive, the oldest archive that is not active will be deleted. Do you want to proceed?"),labels:{ok:s("Delete and continue")}}));return t.then(function(){u.requestInProgress=!0,u.uploadStatus.inProgress=!0,u.uploadStatus.progress=0;var n=_(u.appArchives).map("file").map(_.partial(r.uploadArchive,l)).value();return _.forEach(n,function(r){r.progress(function(e){r.uploadProgress=e.loaded/e.total;var t=_(n).map("uploadProgress").sum();u.uploadStatus.progress=100*t/n.length})}),a.all(n).catch(function(e){o.danger(s("Application archive could not be updated."),e),t.reject()}).finally(function(){u.requestInProgress=!1,u.uploadStatus.inProgress=!1,u.uploadStatus.progress=0})}).then(function(e){1===e.length&&(u.refresh(),u.setActive(e[0].data).then(u.refresh).then(function(){var e="APAMA_CEP_RULE"===l.type?s("Application archive uploaded."):s("Application archive uploaded and activated.");o.success(e)}))})},setActive:f,requestInProgress:!1,archives:[],uploadStatus:{inProgress:!1,progress:0}});var l,d=t.applicationId,h="/applications/*",p=e.$id;function f(e){var t=e.id||e;return u.toActivateVersionId=t,u.requestInProgress=!0,r.setActiveArchive(l,e).then(function(e){return function(r){var n=a.defer();"APAMA_CEP_RULE"===l.type?(i.addListener(p,h,i.realtimeActions().UPDATE,function(e,t){t.id!==l.id||_.isUndefined(t.state)||(0<t.state.monitors.length?(n.resolve(r.data),i.destroySubscription(p,h)):0<t.state.errors.length&&(f(l.activeVersionId),o.danger(s("Failed to activate application"),t.state.errors[0]),n.reject(t.state.errors[0]),i.destroySubscription(p,h)))}),i.start(p,h)):n.resolve(r.data);return n.promise}(e)}).then(function(e){l=e}).finally(function(){u.requestInProgress=!1})}e.refresh=u.refresh,e.paging={refresh:!0},r.detail(d).then(function(e){l=e.data,u.refresh()})}e.$inject=["$scope","$q","c8yApplication","c8yRealtime","$routeParams","c8yModal","c8yAlert","gettext","gettextCatalog"],angular.module("c8y.parts.appArchives").controller("ArchivesListCtrl",e)}();