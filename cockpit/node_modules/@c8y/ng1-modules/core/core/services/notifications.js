"use strict";!function(){function e(r,o,t,e,c,n,s){if(e.getFlag("e2e"))return{subscribe:function(){return o.when()},configure:_.noop,status:_.noop};var i,u,a=new org.cometd.CometD,f={},l={url:e.url("cep/customnotifications"),logLevel:"info",requestHeaders:c.headers(),appendMessageTypeToURL:!1},g=57e4,p=_.cloneDeep(l),d="notification:message";p.url=e.url("cep/notifications"),a.unregisterTransports(),a.registerTransport("long-polling",new n.LongPollingTransport);var m=s.getAcceptEmptyMessagesExt();function b(){return t(function(){a.getTransport().abort()},g)}function v(e){var n=function(n){var e=_.keys(f).filter(function(e){return n.subscription.match(e)});return f[e[0]]}(e);n.scope.$emit("connected"),n.scope.connected=!0}function h(e,n){i&&(t.cancel(),i=b()),e.$emit(d,n)}function y(e){e.counter--,e.counter||(a.unsubscribe(e.comet),delete f[e.channel],_.keys(f).length||function(){i&&(t.cancel(i),i=void 0);a.removeListener(u),a.disconnect()}())}return a.registerExtension(m.name,m),a.configure(_.cloneDeep(l)),{subscribe:function(e){var n=function(e){return f[e]}(e)||{},t=!1;return n.channel||(t=!0,(f[e]=n).channel=e,n.scope=r.$new(!0),n.scope.unsubscribe=angular.bind({},y,n),n.counter=0),n.counter++,function(){var e=o.defer();if(a.isDisconnected()){a.handshake();var n=a.addListener("/meta/connect",function(){e.resolve(!0),a.removeListener(n)}),t=a.addListener("/meta/connect",function(e){e.failure&&401===e.failure.httpCode&&(a.disconnect(),a.removeListener(t))});u=a.addListener("/meta/subscribe",v)}else e.resolve(!0);return e.promise}().then(function(){return t&&(n.comet=a.subscribe(e,angular.bind({},h,n.scope)),i=b()),function(o){var c=o.$on;return o.$on=function(e){"message"===e&&(e=d);for(var n=arguments.length,t=new Array(1<n?n-1:0),r=1;r<n;r++)t[r-1]=arguments[r];return c.call.apply(c,[o,e].concat(t))},o}(n.scope)})},configure:function(e){l.requestHeaders=c.headers(),p.requestHeaders=c.headers();var n=_.cloneDeep("debug"===e?p:l);a.configure(n)},status:function(){return a.getStatus()}}}e.$inject=["$rootScope","$q","$timeout","c8yBase","c8yAuth","c8yLongPollingTransport","c8yCometdExtensions"],angular.module("c8y.core").factory("c8yNotifications",e)}();