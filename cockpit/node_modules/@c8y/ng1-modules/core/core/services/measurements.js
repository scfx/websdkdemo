"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(){function e(u,l,p,c,v,e,o,t){var g=window.c8y_testing?1:500,m=2083,a=v.clean,f="measurement/measurements",i={headers:v.contentHeaders("measurement")},d=t.getUnitHeaders(),n={status:"DEPLOYED",name:"c8yui_measurements",body:'insert into SendNotification\n        select\n          measurement as payload,\n          "c8yui/measurements" as channelName\n        from MeasurementCreated;'},h=1440,s=_.once(function(){var e=v.url(f),t={params:{pageSize:1},headers:{Accept:b.stream.value},silentError:!0};if(window.c8y_testing)return l.when();return u.get(e,t).catch(function(e){b.stream.notAcceptable=406===e.status})});function y(e){var t=e.id||e;return"".concat(v.url(f),"/").concat(t)}var b=v.createEnum([{name:"stream",value:"application/json-stream"},{name:"csv",value:"text/csv"},{name:"xlsx",value:"application/vnd.ms-excel"}]);function F(e,t){var n,r=v.url(f),a=_.assign({},v.todayFilter({}),{pageSize:h},e),i={params:a};return n=t?(i.responseType="blob",function(e){return e.data}):v.cleanListCallback("measurements",F,a),function(e){return s().then(function(){return e&&_(b).reject("notAcceptable").map("value").includes(e.value)?e.value:"application/json"})}(t||b.stream).then(function(t){return d.then(function(e){return i.headers=_.assign({},e,{Accept:t}),u.get(r,i).then(function(e){return 202===e.status?l.reject({async:!0,data:e.data}):e})})}).then(n)}function w(e){var t=h,n=v.url("".concat(f,"/series")),r=v.todayFilter(_.assign({pageSize:t,revert:!0},e||{}));r.dateFrom&&(r.dateFrom=moment(r.dateFrom).format(v.dateFullFormat)),r.dateTo&&(r.dateTo=moment(r.dateTo).format(v.dateFullFormat));var a={params:r},i=function(e){return e.data},o=_.findIndex(w._cacheFilter,_.partial(_.isEqual,r)),s=0<=o?w._cacheRequest[o]:null;return r.dateFrom&&(r.dateFrom=moment(r.dateFrom).format(v.dateFullFormat)),r.dateTo&&(r.dateTo=moment(r.dateTo).format(v.dateFullFormat)),function(e,t){return"".concat(v.absoluteUrl(e),"?").concat(c(t)).length>m}(n,r)&&_.unset(r,"series"),d.then(function(e){if(_.assign(a,{headers:e}),!s){s=u.get(n,a).then(i);var t=_.cloneDeep(r);w._cacheFilter.push(_.cloneDeep(t)),w._cacheRequest.push(s),moment(r.dateTo).isAfter(moment())&&setTimeout(function(){!function(e,t){_.remove(w._cacheFilter,e),_.remove(w._cacheRequest,t)}(t,s)},3e3)}return s})}function r(e){var t=v.url(f),n=e,r=_.cloneDeep(i);if(!n.source)throw new Error("c8yMeasurement: source must be defined");return u.post(t,n,r)}function S(e){var t=y(e),n=a(e),r=_.cloneDeep(i);return u.put(t,n,r)}w._cacheFilter=[],w._cacheRequest=[];var T=[];return{format:b,list:F,listPaged:function(e){var r=l.defer(),a=_.assign(e||{},{pageSize:1e3,withTotalPages:!0}),i=!1;return _.assign(r.promise,{cancel:function(){i=!0,r.reject("canceled")}}),F(a).then(function e(t){var n=!_.isUndefined(t.paging.next)&&t.length>=a.pageSize;return r.notify(t),n||r.resolve(!0),!!i||!n||t.paging.next().then(e)}),r.promise},listSeries:w,listSeriesPaged:function(e){var n=l.defer(),t=_.assign({revert:!0},e||{},{pageSize:1e3,withTotalPages:!0}),r=!1;return _.assign(n.promise,{cancel:function(){r=!0,n.reject("canceled")}}),w(t).then(function e(t){return n.notify(t),t.paging.next||n.resolve(!0),!!r||!t.paging.next||t.paging.next().then(e)}),n.promise},detail:function(e){var t=y(e);return u.get(t)},create:r,update:S,save:function(e){return e.id?S(e):r(e)},remove:function(e){var t=y(e);return u.delete(t)},activateCep:function(){return e.createOrDeploy(n)},latest:function(){var r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=1<arguments.length?arguments[1]:void 0,a={};if(!r.device)throw new Error("filter.device must be defined");if(!r.fragment)throw new Error("filter.fragment must be defined");if(!r.series)throw new Error("filter.series must be defined");var t=F(_.assign(v.timeOrderFilter(),{revert:!0,valueFragmentType:r.fragment,valueFragmentSeries:r.series,source:r.device,pageSize:1,dateTo:void 0})).then(function(e){return _.assign(a,_.first(e)||{}),a});if(e){var n={ops:"CREATE",channel:"/measurements/".concat(r.device),onUpdate:function(e,t){var n=t[r.fragment];n&&n[r.series]&&_.assign(a,t)}},i=o.watch(n);t.stop=_.bind(i.stop,i)}return t},listForDataPoint:function(e,t,n,r,a){var i=T;"object"===_typeof(a)&&(i=a._cachedRequests||[],a._cachedRequests=i);var o=t,s=n,u=e.__target.id,c=("NONE"!==r?r:0)||void 0;if(o){switch(o=moment(o),r){case"HOURLY":o.subtract(1,"hour").startOf("hour");break;case"DAILY":o.subtract(1,"day").startOf("day");break;default:o.subtract(1,"minute").startOf("minute")}o=o.format(v.dateFullFormat)}if(s){switch(s=moment(s),r){case"HOURLY":s.add(1,"hour").startOf("hour");break;case"DAILY":s.add(1,"days").startOf("day");break;default:s.add(1,"minute").startOf("minute")}s=s.format(v.dateFullFormat)}var m={dateFrom:o,dateTo:s,source:u,aggregationType:c},f=_.find(i,function(e){return _.isMatch(e.filters,m)});f||(f={deferred:l.defer(),sendDebounced:function(){return f._sendDebounced(),f.deferred.promise},_sendDebounced:_.debounce(function(){w(f.filters).then(_.unary(f.deferred.resolve))},g),filters:m},i.push(f));var d=[e.fragment,e.series].join(".");return f.filters.series=_.uniq((f.filters.series||[]).concat([d])),p(function(){return f.sendDebounced().then(function(t){return function(e){var n=_.findIndex(e.series,function(e){return e.name===t.series&&e.type===t.fragment}),r=[];return-1<n&&_.forEach(e.values,function(e,t){_.isObjectLike(e[n])&&r.push({time:t,min:e[n].min&&Number(e[n].min),max:e[n].max&&Number(e[n].max)})}),{dataPoint:t,values:r,truncated:e.truncated}}}(e)).then(function(e){return e.aggregation=r,e.dateFrom=o,e.dateTo=s,e}).finally(function(){_.remove(i,f)})},5)},rtMeasurementForDatapoint:function(i){return function(e){var t=i.__target.id,n=i.fragment,r=i.series,a=_.get(e,[n,r]);return e.source.id===t&&!!a&&{dataPoint:i,values:[{time:e.time,min:a.value,max:a.value}]}}}}}e.$inject=["$http","$q","$timeout","$httpParamSerializer","c8yBase","c8yCepModule","c8yRealtime","c8yMeasurementUnits"],angular.module("c8y.core").factory("c8yMeasurements",e)}();