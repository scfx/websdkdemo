"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a=[],o=!0,c=!1;try{for(n=n.call(e);!(o=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);o=!0);}catch(e){c=!0,i=e}finally{try{o||null==n.return||n.return()}finally{if(c)throw i}}return a}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&r.push.apply(r,Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),r.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(){function e(o,y,a,u,g,r,m,c){var s="inventory/managedObjects",n="\\/inventory\\/managedObjects\\/(\\d+)",d={headers:g.contentHeaders("managedObject","managedObject")},l={headers:g.contentHeaders("managedObjectReference")},f=["lastUpdated","assetParents","deviceParents","additionParents","childAssets","childDevices","childAdditions","c8y_ActiveAlarmsStatus","c8y_Availability"];function h(e){var t=e&&(e.id||e);return t&&g.url("".concat(s,"/").concat(t))}function p(e,t){return"".concat(h(e),"/").concat(t)}function v(e,t){var n=g.url(s),r=g.pageSizeFilter(function(e){var t=e||{};return t.text&&(t=_.pick(t,["text","pageSize","currentPage","skipChildrenNames","fragmentType","withParents","q","query"])),t}(e)),i=_objectSpread({params:r},t),a=g.cleanListCallback("managedObjects",v,r,!0);return o.get(n,i).then(a)}function b(e,t,n){var r=h(e),i=t||{},a=_.defaults({params:i},n);return r?o.get(r,a):y.reject("Managed object not valid")}function A(e,t,n){return b(e,t,n)}function i(e){var t=_.get(e,"assetParents.references"),n=_.get(e,"deviceParents.references"),r=_.get(e,"additionParents.references");return _.union(t,n,r).map(function(e){return e.managedObject})}function t(e){var t=g.url(s),n=_.cloneDeep(d),r=g.cleanFields(e,f);return o.post(t,r,n)}function j(e,t,n){var r=p(t,n),i=_.omit(e,["id"]),a=_.assign({},d,{Accept:"application/json"});return L(t),o.post(r,i,a)}function S(e){var t=new RegExp(n);return e.headers("Location").match(t)[1]}function w(t){var e=h(t),n=_.cloneDeep(d),r=g.cleanFields(t,f),i=o.put(e,r,n);return i.then(function(e){a.$emit("c8yInventory:update",{mo:e.data,res:e}),a.$emit("c8yInventory:update:".concat(t.id),{mo:e.data,res:e})}),L(t),i}function O(e,t){return!!C(e,t)}function C(e,t){return _.get(e,[t,"references","length"])}function D(e,t,n){var r=p(e,t),i=n||{},a=y.resolve(0);return i.skipDetail||(a=A(e).then(function(e){return e.data[t].references.length})),a.then(function(e){return _.get(i,"params.pageSize")||(i.params=i.params||{},i.params.pageSize=e),o.get(r,i)})}function P(e){return _.map(e.data.references,_.property("managedObject"))}function I(e,t,n){var r=p(e,n),i={managedObject:t},a=_.cloneDeep(l);return L(e),o.post(r,i,a)}function k(e,n,r,i){return b(e,{withParents:!0}).then(function(e){var t="data.".concat(n,"Parents.references");return _.map(_.get(e,t),_.property("managedObject.id"))}).then(function(e){var t=[],n={ids:e.join(",")};return e.length&&(t=v(n),(r||i)&&(t=t.then(T(r,i)))),t})}function T(t,n){return function(e){return _.filter(e,function(e){return t&&e.type===t||n&&!_.isUndefined(e[n])})}}function E(e,t,n,r){var i=4<arguments.length&&void 0!==arguments[4]?arguments[4]:{},a=_.camelCase(["child",_.lowerCase(t),"id"]),o=_objectSpread({withParents:!0},i);return o[a]=e.id||e,v(o).then(function(e){return n||r?T(n,r)(e):e})}function $(e,t,n){var r=function(e,t,n){var r=t.id||t;return"".concat(p(e,n),"/").concat(r)}(e,t,n);return L(e),o.delete(r)}function L(e){var t=g.getId(e),n=x.cache.__data__;R(n.string,t),R(n.hash,t)}function R(t,n){if(0<t.size){var e=Object.keys(t.__data__);_.forEach(e,function(e){(e===n.toString()||e.startsWith("".concat(n,"_")))&&t.delete(e)})}}function z(e){var t="".concat(h(e),"/supportedMeasurements");return o.get(t).then(_.property("data.c8y_SupportedMeasurements"))}function U(e){return(_.get(e,"owner")?y.when(e):b(e).then(g.getResData)).then(_.property("owner"))}var F=_.memoize(U,function(e){return g.getId(e)}),x=_.memoize(A,function(e,t){return function(e,t){var n=g.getId(e);t&&(n="".concat(n,"_").concat(JSON.stringify(t)));return n}(e,t)});function M(e){return g.url("inventory/managedObjects/".concat(e,"/user"))}return{list:v,listQuery:function(e,t,n,r){var i=g.pageSizeFilter(t);return i[n?"query":"q"]=c.buildQuery(e),v(i,r)},listAll:function(e){var a=[];return v(_objectSpread({pageSize:g.MAX_PAGESIZE},e)).then(function e(t){a.push.apply(a,_toConsumableArray(t));var n=t.statistics.pageSize,r=t.paging.next,i=t.length>=n;return r&&i?t.paging.next().then(e):y.resolve(a)})},detail:b,detailCached:x,detailRealtime:function(e,t,r,n,i){var a,o,c,u=e.id||e,s=_.isObjectLike(e)?y.when(e):b(u,n,i).then(g.getResData),d="/managedobjects/".concat(u),l=m.realtimeActions().UPDATE;function f(n){return a?_.assign(a,n):a=n,_.forEach(a,function(e,t){void 0===n[t]&&delete a[t]}),_.isFunction(r)&&r(a),a}if(t)o=t.$id,m.addListener(o,d,l,function(e,t){f(t)}),m.start(o,d),t.$on("stopRealtime",function(){m.stop(o,d)}),t.$on("$destroy",function(){m.removeSubscriber(o,d)}),c=s.then(function(e){return f(e)});else{var h=c=b(u).then(function(e){return f(e.data)}),p={ops:l,channel:d,onUpdate:function(e,t){f(t)}},v=m.watch(p);h.stop=_.bind(v.stop,v)}return c},create:t,createChild:j,createConfirm:function(e){return t(e).then(S).then(b)},update:w,save:function(e){return e.id?w(e):t(e)},remove:function(e,t){var n=h(e);if(!n)throw new Error("No managed object id provided!");var r=i(e);return _.forEach(r,function(e){L(e)}),L(e),o.delete(n,{params:_.isObjectLike(t)?t:{}})},extractParents:i,hasChildAssets:function(e){return O(e,"childAssets")},hasChildDevices:function(e){return O(e,"childDevices")},hasChildAdditions:function(e){return O(e,"childAdditions")},getChildAssetsCount:function(e){return C(e,"childAssets")},getChildDevicesCount:function(e){return C(e,"childDevices")},getChildAdditionsCount:function(e){return C(e,"childAdditions")},children:D,onChildren:P,childAssets:function(e,t){return D(e,"childAssets",t).then(P)},childDevices:function(e,t){return D(e,"childDevices",t).then(P)},childAdditions:function(e,t){return D(e,"childAdditions",t).then(P)},addChildAsset:function(e,t){return I(e,t,"childAssets")},addChildDevice:function(e,t){return I(e,t,"childDevices")},addChildAddition:function(e,t){return I(e,t,"childAdditions")},createChildAsset:function(e,t){return j(e,t,"childAssets")},createChildDevice:function(e,t){return j(e,t,"childDevices")},createChildAddition:function(e,t){return j(e,t,"childAdditions")},removeChildAsset:function(e,t){return $(e,t,"childAssets")},removeChildDevice:function(e,t){return $(e,t,"childDevices")},removeChildAddition:function(e,t){return $(e,t,"childAdditions")},parentsAsset:function(e,t,n){return k(e,"asset",t,n)},parentsDevice:function(e,t,n){return k(e,"device",t,n)},parentsAddition:function(e,t,n){return k(e,"addition",t,n)},directParentAssets:function(e,t,n,r){return E(e,"asset",t,n,r)},directParentDevices:function(e,t,n,r){return E(e,"device",t,n,r)},directParentAdditions:function(e,t,n,r){return E(e,"addition",t,n,r)},getCount:function(e){return g.getCount(v,e||{})},getFragments:function(e){var t=_.union(f,["id","type","name","owner","self"]);return _.keys(g.cleanFields(e,t))},getSupportedMeasurements:z,getSupportedSeries:function(t){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return function(e){return y.all([z(e),function(e){var t="".concat(h(e),"/supportedSeries");return o.get(t).then(_.property("data.c8y_SupportedSeries"))}(e)]).then(function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1],i=_.sortBy(n,"length").reverse();return _(r).map(function(t){var e=_.find(i,function(e){return 0===t.indexOf(e)}),n=t.replace("".concat(e,"."),"");return{fragment:e,series:n}}).filter(_.property("fragment")).value()})}(t).then(function(e){return function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=2<arguments.length?arguments[2]:void 0;return t.withUnits?function e(t,r){var n=t&&(t.id||t),i=_.reject(r,"checked"),a=_.head(i);if(a){var o=u.get("c8yMeasurements");return o.latest({device:n,fragment:a.fragment,series:a.series}).then(function(n){return _.forEach(i,function(e){var t=_.get(n,[e.fragment,e.series]);t&&(e.unit=t.unit,e.checked=!0)}),e(t,r)})}var c=_.map(r,function(e){return _.omit(e,"checked")});return y.resolve(c)}(e,n):y.resolve(n)}(t,n,e)})},isOwner:function(e,t){var n={user:t?y.when(t):r.current(),owner:U(e)};return y.all(n).then(function(e){return e.user.userName===e.owner})},isOwnerCached:function(e,t){var n={user:t?y.when(t):r.current(),owner:F(e)};return y.all(n).then(function(e){return e.user.userName===e.owner})},getOwner:U,getOwnerObject:function(e,t){var n=M(g.getId(e));return o.get(n,t).then(g.getResData).catch(function(t){return U(e).then(function(e){return y.reject({notFound:404===t.status,accessDenied:403===t.status,serviceUser:r.isServiceUser(e)})})})},getOwnerCached:F,setOwnerEnabled:function(e,t){var n=g.getId(e);return o.put(M(n),{enabled:!!t}).then(g.getResData)},addGlobalFlag:function(e,t){return e.c8y_Global=t?{}:null,e},updateManagedObject:function(t,e){var n=_.keys(e),r=_.keys(t).filter(function(e){return!_.includes(n,e)});return _.forEach(r,function(e){return _.unset(t,e)}),_.assign(t,e)}}}e.$inject=["$http","$q","$rootScope","$injector","c8yBase","c8yUser","c8yRealtime","c8yQueriesUtil"],angular.module("c8y.core").factory("c8yInventory",e)}();