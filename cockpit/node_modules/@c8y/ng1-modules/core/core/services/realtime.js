"use strict";function _slicedToArray(n,e){return _arrayWithHoles(n)||_iterableToArrayLimit(n,e)||_unsupportedIterableToArray(n,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(n,e){if(n){if("string"==typeof n)return _arrayLikeToArray(n,e);var t=Object.prototype.toString.call(n).slice(8,-1);return"Object"===t&&n.constructor&&(t=n.constructor.name),"Map"===t||"Set"===t?Array.from(n):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(n,e):void 0}}function _arrayLikeToArray(n,e){(null==e||e>n.length)&&(e=n.length);for(var t=0,r=new Array(e);t<e;t++)r[t]=n[t];return r}function _iterableToArrayLimit(n,e){var t=null==n?null:"undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(null!=t){var r,i,o=[],a=!0,s=!1;try{for(t=t.call(n);!(a=(r=t.next()).done)&&(o.push(r.value),!e||o.length!==e);a=!0);}catch(n){s=!0,i=n}finally{try{a||null==t.return||t.return()}finally{if(s)throw i}}return o}}function _arrayWithHoles(n){if(Array.isArray(n))return n}!function(){function n(n,t,a,r,e,i,o,s,c,u,f,l){var d,h,p=this,b="XSRF-TOKEN",m=3e4,y=new org.cometd.CometD;y.unregisterTransports(),window.c8y_testing||y.registerTransport("websocket",new org.cometd.WebSocketTransport),e.has("ngZone")&&(h=e.get("ngZone")),window.c8y_testing&&(d=n.when("")),y.registerTransport("long-polling",new u.LongPollingTransport);var v=n.defer();y.addListener("/meta/handshake",function(n){if("websocket"===_.get(n,"failure.connectionType"))return t.error(n.failure),void y.disconnect(function(){y.websocketEnabled=!1,y.handshake()});if(!n.successful){var e=new Error("Handshake failed.");throw v.reject(e),e}_.forEach(w,function(n){var e=n.subscription;e&&y.resubscribe(e)}),v.resolve(),a.$broadcast("c8yRealtime::connected")});var g=y.addListener("/meta/connect",function(n){n.failure&&401===n.failure.httpCode&&(T(),y.removeListener(g))});function E(){var e;_.isUndefined(d)&&(d=c.current().then(function(n){return function(n){var e={params:{fragmentType:n}},t=o.url("inventory/managedObjects");return r.get(t,e)}(e="unit".concat(n.userName))}).then(o.getResData).then(function(n){return _.first(n.managedObjects)}).then(function(n){return _.get(n,e)}));return d}function T(){v=n.defer(),y.disconnect()}a.$on("authStateChange",function(n,e){e.hasAuth?E().then(function(n){var e={"X-Cumulocity-System-Of-Units":n};return _.merge(s.headers(),e)}).then(function(n){!function(n){y.configure({url:o.absoluteUrl("notification/realtime"),logLevel:"info",requestHeaders:n,appendMessageTypeToURL:!1,stickyReconnect:!1,useWorkerScheduler:!window.c8y_testing})}(n),E().then(function(n){return y.handshake(function(n){var e=function(n){for(var e="".concat(n,"="),t=document.cookie.split(";"),r=0;r<t.length;r++){for(var i=t[r];" "===i.charAt(0);)i=i.substring(1);if(0===i.indexOf(e))return decodeURIComponent(i.substring(e.length,i.length))}return}(b),t={ext:{"com.cumulocity.authn":{token:l.token,tfa:l.TFAToken}}};e&&_.merge(t,{ext:{"com.cumulocity.authn":{xsrfToken:e}}});n&&(t.ext.systemOfUnits=n);return t}(n))})}):T()}),y.onListenerException=function(n,e,t){throw p.removeListener&&t?p.removeListener(e):p.unsubscribe&&p.unsubscribe(e),new Error("Cometd onListenerException exception: ".concat(n))};var w=[],A={addListener:_.wrap(L,x),realtimeActions:k,switchRealtime:_.wrap(function(n,e){U(n,e)?D(n,e):C(n,e)},x),getStatus:U,start:_.wrap(C,x),stop:_.wrap(D,x),removeSubscriber:_.wrap(R,x),destroySubscription:_.wrap(function(n,e){R(n,e)},x),icon:function(n){return n?"active":"inactive"},watch:function(n){var e=n.id||String(Math.random()).substr(2),t=n.channel,r=_.flattenDeep([n.ops||_.values({CREATE:"CREATE",UPDATE:"UPDATE",DELETE:"DELETE"})]),i=n.onUpdate||_.noop;return _.forEach(r,function(n){L(e,t,n,i)}),C(e,t),{stop:function(){R(e,t)}}},_getSubscriptionChannels:function(){o.getFlag("test")||console.warn("DO NOT USE THIS API CALL: it will break encapsulation,\n          use it only for doing state verification in unit test.");return w},status:function(){return y.getStatus()}};return window.c8y_testing&&_.assign(A,{cometd:y,handshakeDeferred:v}),A;function L(n,e,t,r){var i=_.find(w,{name:e});i||(i=function(n){return{name:n,subscription:void 0,subscribers:[]}}(e),w.push(i));var o=i.subscribers,a=_.find(o,{id:n});a||(a=function(n){return{id:n,subscribedEvents:_.map({CREATE:"CREATE",UPDATE:"UPDATE",DELETE:"DELETE"},S),active:!1}}(n),o.push(a));var s=a.subscribedEvents,c=_.find(s,{name:t});c||(c=S(t),s.push(c)),c.listeners.push(r)}function k(){return{CREATE:"CREATE",UPDATE:"UPDATE",DELETE:"DELETE"}}function S(n){return{name:n,listeners:[]}}function U(r,n){var e=I(n);if(0!==e.length)return _.every(e,function(n){var e=!1,t=_.find(w,{name:n});return t&&(e=_.some(t.subscribers,{id:r,active:!0})),e})}function D(n,e){var t=$(e),r=P(n,e);r&&(r.active=!1,_.some(t.subscribers,"active")||O(t))}function C(n,e){var t=P(n,e);if(t){t.active=!0;var r=_.find(w,{name:e});if(_.isUndefined(r.subscription)&&!r.subscriptionPending)return function(o){o.subscriptionPending=!0;var n=function(){o.subscriptionPending=!1,o.subscription=y.subscribe(o.name,function(n){var e=n.data,r=e.realtimeAction,i=e.data,t=function(){_(o.subscribers).filter("active").forEach(function(n){var e=_.find(n.subscribedEvents,{name:r}),t=e.listeners;_.forEach(t,function(n){n(r,i)})})};"websocket"===y.getTransport().getType()?a.$applyAsync(t):t()},function(n){n.successful||i(function(){return y.resubscribe(o.subscription)},m)})};v.promise.then(h?function(){return h.runOutsideAngular(n)}:n)}(r)}}function R(n,e){if(P(n,e)){var t=$(e),r=t.subscribers;_.remove(r,{id:n}),_.isEmpty(r)&&function(n){O(n),_.remove(w,n)}(t)}}function P(n,e){var t,r=$(e);if(!r)throw new Error('There is no listener registered for your scope on the channel "'.concat(e,'"'));if(t=_.find(r.subscribers,{id:n}),_.isUndefined(t))throw new Error('There is no subscriber with id "'.concat(n,'" ')+'registered for your scope on the channel "'.concat(e,'"'));return t}function $(n){return _.find(w,{name:n})}function O(n){var e=n.subscription;e&&y.unsubscribe(e),delete n.subscription}function x(e){for(var t=this,n=arguments.length,r=new Array(1<n?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];var o=I(r[1]);_.forEach(o,function(n){r[1]=n,e.apply(t,r)})}function I(n){var e=[],t=n.match(/(\/.*)\/(.*)$/);if(_.isEmpty(t))e.push(n);else{var r=_slicedToArray(t,3),i=r[1],o=r[2].split(",");_.forEach(o,function(n){e.push("".concat(i,"/").concat(n))})}return e}}n.$inject=["$q","$log","$rootScope","$http","$injector","$timeout","c8yBase","c8yAuth","c8yUser","c8yLongPollingTransport","c8yCometdExtensions","info"],angular.module("c8y.core").factory("c8yRealtime",n)}();