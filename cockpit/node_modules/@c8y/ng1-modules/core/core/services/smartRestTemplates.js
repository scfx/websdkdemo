"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}!function(){function e(t,a,n,r,l,e,m){var s="c8y_SmartRest2Template",u="com_cumulocity_model_smartrest_csv_CsvSmartRestTemplate",p="c8y_SmartRest2DeviceIdentifier",i="10",o="11",y=1e3,d=a.createEnum(["MEASUREMENT","INVENTORY","ALARM","EVENT","OPERATION"]),T=a.createEnum(["POST","GET","PUT"]),c=a.createEnum([{name:"STRING",value:"STRING",label:e("STRING")},{name:"DATE",value:"DATE",label:e("DATE")},{name:"NUMBER",value:"NUMBER",label:e("NUMBER"),numeric:!0},{name:"INTEGER",value:"INTEGER",label:e("INTEGER"),numeric:!0},{name:"UNSIGNED",value:"UNSIGNED",label:e("UNSIGNED"),numeric:!0},{name:"FLAG",value:"FLAG",label:e("FLAG")},{name:"SEVERITY",value:"SEVERITY",label:e("SEVERITY")},{name:"ALARMSTATUS",value:"ALARMSTATUS",label:e("ALARM STATUS")},{name:"OPERATIONSTATUS",value:"OPERATIONSTATUS",label:e("OPERATION STATUS")},{name:"ARRAY",value:"ARRAY",label:e("ARRAY")},{name:"OBJECTARRAY",value:"OBJECTARRAY",label:e("OBJECT ARRAY")}]),I=[c.OBJECTARRAY.value,c.ARRAY.value],R={name:"",type:s,com_cumulocity_model_smartrest_csv_CsvSmartRestTemplate:{requestTemplates:[],responseTemplates:[]}},v={name:"",msgId:"",api:d.MEASUREMENT.name,method:T.POST.name,response:!0,byId:!0,mandatoryValues:[],customValues:[]},S={path:"",type:c.STRING.name,value:""},f={name:"",msgId:"",base:"",condition:"",patterns:[]},N={path:""},b={MEASUREMENT:{POST:[{path:"$.type",type:c.STRING.name},{path:"$.time",type:c.DATE.name}]},EVENT:{POST:[{path:"$.type",type:c.STRING.name},{path:"$.text",type:c.STRING.name},{path:"$.time",type:c.DATE.name}]},ALARM:{POST:[{path:"$.type",type:c.STRING.name},{path:"$.text",type:c.STRING.name},{path:"$.status",type:c.ALARMSTATUS.name},{path:"$.severity",type:c.SEVERITY.name},{path:"$.time",type:c.DATE.name}],PUT:[{path:"$.type",type:c.STRING.name}]},OPERATION:{PUT:[{path:"$.type",type:c.STRING.name}]},INVENTORY:{POST:[{label:e("External ID type"),path:"$.type",type:c.STRING.name}],PUT:[],GET:[]}},g=[{msgId:"100",name:e("Device creation"),values:[{label:e("device name"),type:c.STRING.name,default:"MQTT Device <serialNumber>"},{label:e("device type"),type:c.STRING.name,default:"c8y_MQTTDevice"}],hideInSimulators:!0},{msgId:"101",name:e("Child device creation"),values:[{label:e("unique child ID"),type:c.STRING.name,mandatory:!0},{label:e("device name"),type:c.STRING.name,default:"MQTT Device <serialNumber>"},{label:e("device type"),type:c.STRING.name,default:"c8y_MQTTChildDevice"}],hideInSimulators:!0},{msgId:"105",name:e("Get child device"),hideInSimulators:!0},{msgId:"110",name:e("Configure hardware"),values:[{label:e("serialNumber"),type:c.STRING.name},{label:e("model"),type:c.STRING.name},{label:e("revision"),type:c.STRING.name}]},{msgId:"111",name:e("Configure mobile"),values:[{label:e("IMEI"),type:c.STRING.name},{label:e("ICCID"),type:c.STRING.name},{label:e("IMSI"),type:c.STRING.name},{label:e("MCC"),type:c.STRING.name},{label:e("MNC"),type:c.STRING.name},{label:e("LAC"),type:c.STRING.name},{label:e("Cell ID"),type:c.STRING.name}]},{msgId:"112",name:e("Configure position"),values:[{label:e("latitude"),type:c.STRING.name,renderType:c.NUMBER.name,modelOptions:{preserveNumericStrings:!0},validation:{min:-90,max:90}},{label:e("longitude"),type:c.STRING.name,renderType:c.NUMBER.name,modelOptions:{preserveNumericStrings:!0},validation:{min:-180,max:180}},{label:e("altitude"),type:c.STRING.name,renderType:c.NUMBER.name,modelOptions:{preserveNumericStrings:!0}},{label:e("accuracy"),type:c.STRING.name,renderType:c.NUMBER.name,modelOptions:{preserveNumericStrings:!0}}]},{msgId:"113",name:e("Set configuration"),values:[{label:e("configuration"),type:c.STRING.name}]},{msgId:"114",name:e("Set supported operations"),values:[{label:e("List of supported operations"),type:c.ARRAY.name}],hideInSimulators:!0},{msgId:"115",name:e("Set firmware"),values:[{label:e("name"),type:c.STRING.name},{label:e("version"),type:c.STRING.name},{label:e("URL"),type:c.STRING.name}]},{msgId:"116",name:e("Set software list"),values:[{label:e("List of 3 values per software"),type:c.OBJECTARRAY.name,values:[{label:e("name"),type:c.STRING.name},{label:e("version"),type:c.STRING.name},{label:e("URL"),type:c.STRING.name}]}]},{msgId:"117",name:e("Set required availability"),values:[{label:e("required interval"),type:c.NUMBER.name}]},{msgId:"200",name:e("Create custom measurement"),values:[{label:e("fragment"),type:c.STRING.name,mandatory:!0},{label:e("series"),type:c.STRING.name,mandatory:!0},{label:e("value"),type:c.NUMBER.name,mandatory:!0},{label:e("unit"),type:c.STRING.name},{label:e("time"),type:c.DATE.name}]},{msgId:"210",name:e("Create signal strength measurement"),values:[{label:e("RSSI value"),type:c.NUMBER.name,mandatory:!0},{label:e("BER value"),type:c.NUMBER.name,mandatory:!0},{label:e("time"),type:c.DATE.name}]},{msgId:"211",name:e("Create temperature measurement"),values:[{label:e("temperature value"),type:c.NUMBER.name,mandatory:!0},{label:e("time"),type:c.DATE.name}]},{msgId:"212",name:e("Create battery measurement"),values:[{label:e("battery value"),type:c.NUMBER.name,mandatory:!0,validation:{min:0,max:100}},{label:e("time"),type:c.DATE.name}]},{msgId:"301",name:e("Create CRITICAL alarm"),values:[{label:e("type"),type:c.STRING.name,mandatory:!0},{label:e("text"),type:c.STRING.name,default:"Alarm of type <alarmType> raised"},{label:e("time"),type:c.DATE.name}]},{msgId:"302",name:e("Create MAJOR alarm"),values:[{label:e("type"),type:c.STRING.name,mandatory:!0},{label:e("text"),type:c.STRING.name,default:"Alarm of type <alarmType> raised"},{label:e("time"),type:c.DATE.name}]},{msgId:"303",name:e("Create MINOR alarm"),values:[{label:e("type"),type:c.STRING.name,mandatory:!0},{label:e("text"),type:c.STRING.name,default:"Alarm of type <alarmType> raised"},{label:e("time"),type:c.DATE.name}]},{msgId:"304",name:e("Create WARNING alarm"),values:[{label:e("type"),type:c.STRING.name,mandatory:!0},{label:e("text"),type:c.STRING.name,default:"Alarm of type <alarmType> raised"},{label:e("time"),type:c.DATE.name}]},{msgId:"305",name:e("Update severity of existing alarm"),values:[{label:e("type"),type:c.STRING.name,mandatory:!0},{label:e("severity"),type:c.SEVERITY.name,mandatory:!0}]},{msgId:"306",name:e("Clear existing alarm"),values:[{label:e("type"),type:c.STRING.name,mandatory:!0},{label:e("severity"),type:c.SEVERITY.name,mandatory:!0}]},{msgId:"400",name:e("Create basic event"),values:[{label:e("type"),type:c.STRING.name,mandatory:!0},{label:e("text"),type:c.STRING.name,mandatory:!0},{label:e("time"),type:c.DATE.name}]},{msgId:"401",name:e("Create location update event"),values:[{label:e("latitude"),type:c.STRING.name,renderType:c.NUMBER.name,modelOptions:{preserveNumericStrings:!0},validation:{min:-90,max:90}},{label:e("longitude"),type:c.STRING.name,renderType:c.NUMBER.name,modelOptions:{preserveNumericStrings:!0},validation:{min:-180,max:180}},{label:e("altitude"),type:c.STRING.name,renderType:c.NUMBER.name,modelOptions:{preserveNumericStrings:!0}},{label:e("accuracy"),type:c.STRING.name,renderType:c.NUMBER.name,modelOptions:{preserveNumericStrings:!0}}]},{msgId:"402",name:e("Create location update event with device update"),values:[{label:e("latitude"),type:c.STRING.name,renderType:c.NUMBER.name,modelOptions:{preserveNumericStrings:!0},validation:{min:-90,max:90}},{label:e("longitude"),type:c.STRING.name,renderType:c.NUMBER.name,modelOptions:{preserveNumericStrings:!0},validation:{min:-180,max:180}},{label:e("altitude"),type:c.STRING.name,renderType:c.NUMBER.name,modelOptions:{preserveNumericStrings:!0}},{label:e("accuracy"),type:c.STRING.name,renderType:c.NUMBER.name,modelOptions:{preserveNumericStrings:!0}}]},{msgId:"500",name:e("Get PENDING operations"),hideInSimulators:!0},{msgId:"501",name:e("Set operation to EXECUTING"),values:[{label:e("fragment"),type:c.STRING.name,mandatory:!0}],hideInSimulators:!0},{msgId:"502",name:e("Set operation to FAILED"),values:[{label:e("fragment"),type:c.STRING.name,mandatory:!0},{label:e("failureReason"),type:c.STRING.name}],hideInSimulators:!0},{msgId:"503",name:e("Set operation to SUCCESSFUL"),values:[{label:e("fragment"),type:c.STRING.name,mandatory:!0},{label:e("parameters"),type:c.ARRAY.name}],hideInSimulators:!0}];return{APIs:d,Methods:T,Types:c,fragmentType:u,externalIdType:p,newTemplate:function(){return _.defaults({},R)},create:function(e,t){var a;return E(_.defaults({},e,R)).then(function(e){a=e}).then(function(){return function(e,t){var a={type:p,externalId:t};return l.createIdentity(e,a)}(a,t)}).then(function(){return D(a)})},save:E,list:A,detail:function(e){return r.detail(e).then(a.getResData).then(D)},remove:function(e){return r.remove(e)},download:function(e){var t="".concat(e.name,".json"),a=JSON.stringify(function(e){return _(x(e)).pick(["name","type",u]).assign(_.pick(e,["__externalId"])).value()}(e),null,2),n=new Blob([a],{type:"application/json"});saveAs(n,t)},getAllMsgIds:function(e){return _.map(_.flatten([e[u].requestTemplates,e[u].responseTemplates]),"msgId")},countRequestTemplates:function(e){return e[u].requestTemplates.length},newRequestTemplate:function(){return _.defaults({},v)},addRequestTemplate:function(e,t){var a=_.defaults({},t,v);return e[u].requestTemplates.push(a),a},removeRequestTemplate:function(e,t){_.pull(e[u].requestTemplates,t)},setupRequestTemplateDefaults:function(a){if(!a.api||!a.method)return;var e=b[a.api][a.method]||[];a.mandatoryValues=_.map(e,function(e){var t=(_.find(a.mandatoryValues,{path:e.path})||{}).value;return _.assign({},e,{value:t})}),a.externalIdType=a.externalIdType||"c8y_Serial",a.response=a.method===T.GET.name},doesRequestTemplateRequireByIdOrByExternalId:function(e){var t=e.api===d.INVENTORY.name,a=e.method===T.GET.name,n=e.method===T.PUT.name;return t&&(a||n)},addRequestTemplateCustomValue:function(e,t){var a=_.defaults({},t,S);return e.customValues.push(a),a},removeRequestTemplateCustomValue:function(e,t){_.pull(e.customValues,t)},getRequestTemplatePreview:U,countResponseTemplates:function(e){return e[u].responseTemplates.length},newResponseTemplate:function(){return _.defaults({},f)},addResponseTemplate:function(e,t){var a=_.defaults({},t,f);return e[u].responseTemplates.push(a),a},removeResponseTemplate:function(e,t){_.pull(e[u].responseTemplates,t)},addResponseTemplatePattern:function(e,t){var a=_.defaults({},t,N);return e.patterns.push(a),a},removeResponseTemplatePattern:function(e,t){_.pull(e.patterns,t)},getResponseTemplatePreview:O,getPreviewsCsvData:function(e,t){var a=t||{},n=[],r=h(e);a.skipRequestTemplates||(n.push([m.getString("Messages")]),n.push([m.getString("Name"),m.getString("API"),m.getString("Method"),m.getString("Preview")]),_.each(r.requestTemplates,function(e){n.push([e.name,e.api,e.method,e.csv])}));a.skipRequestTemplates||a.skipResponseTemplates||n.push([]);a.skipResponseTemplates||(n.push([m.getString("Responses")]),n.push([m.getString("Name"),m.getString("Preview")]),_.each(r.responseTemplates,function(e){n.push([e.name,e.csv])}));return n},getPreviews:h,getMethodsForAPI:function(e){var t=_.keys(b[e]||{});return _.filter(T.values(),function(e){return _.includes(t,e.name)})},listAllPublishMessages:function(){return A().then(M).then(function(e){return _.union(e,_.cloneDeep(g))})},typesForUI:function(){return _.filter(c.values(),function(e){return-1===I.indexOf(e.value)})},getCreationCsvData:G,getCreationCsv:function(e){var t=G(e);return n.getCsv(t,{fieldSeparator:",",textDelimiter:'"'})}};function E(e){return r.save(x(e)).then(a.getResData).then(D)}function A(){return r.list({type:s,pageSize:y}).then(function(e){return t.all(_.map(e,D))})}function h(e){return{requestTemplates:_.map(e[u].requestTemplates,U),responseTemplates:_.map(e[u].responseTemplates,O)}}function G(e){return _.flatten([(a=e[u].requestTemplates,_.map(a,n)),(t=e[u].responseTemplates,_.map(t,l))]);var t,a;function n(e){var t=_.flattenDeep([i,e.msgId,e.method,e.api,e.response,_.map(e.mandatoryValues,"value"),_.map(e.customValues,function(e){return[e.path,e.type,e.value]})]);return _.map(t,r)}function r(e){var t=e;return _.isNil(t)&&(t=""),!_.isString(t)&&_.isFunction(t.toString)&&(t=t.toString()),t}function l(e){return _.flatten([o,e.msgId,e.base||"",e.condition].concat(_toConsumableArray((e.patterns||[]).map(function(e){return e.path}))))}}function M(e){return _(e).reduce(C,[])}function C(t,a){var e=a[u].requestTemplates;return _.forEach(e,function(e){Object.defineProperties(e,{_template:{value:a}}),t.push(e)}),t}function U(e){return{name:e.name,api:e.api,method:e.method,csv:function(e){return _.compact(_.flatten([e.msgId,function(e){var t;e.api===d.INVENTORY.name&&_.includes([T.GET.name,T.PUT.name],e.method)&&(t=e.byId?"<deviceId>":e.externalIdType?"<externalId>":"<externalIdType>,<externalId>");return t}(e),_.map(e.mandatoryValues||[],function(e){var t;return e.type===c.FLAG.name||e.value||(t="<".concat(e.path,">")),t}),_.map(e.customValues||[],function(e){var t;return e.type===c.FLAG.name||e.value||(t="<".concat(e.path,">")),t})])).join(",")}(e)}}function O(e){return{name:e.name,csv:function(e){var t=e.msgId,a=_.map(e.patterns,function(e){return"<".concat(e.path,">")});return[t].concat(_toConsumableArray(a)).join(",")}(e)}}function D(a){return function(e){return l.listExternalIds(e).then(function(e){var t=_.find(e,{type:p});return t&&t.externalId})}(a).then(function(e){var t=_.cloneDeep(a);return t.__externalId=e,_.forEach(t[u].responseTemplates,function(e){e.pattern&&(e.patterns=_.map(e.pattern,function(e){return{path:e}}),delete e.pattern)}),t})}function x(e){var t=_.cloneDeep(e);return t.__externalId=void 0,_.forEach((t[u]||{}).responseTemplates,function(e){e.patterns&&(e.pattern=_.map(e.patterns,function(e){return e.path}),delete e.patterns)}),t}}e.$inject=["$q","c8yBase","csvExporterSvc","c8yInventory","c8yIdentity","gettext","gettextCatalog"],angular.module("c8y.core").factory("c8ySmartRestTemplates",e)}();