"use strict";function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?Object(arguments[t]):{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&n.push.apply(n,Object.getOwnPropertySymbols(r).filter(function(t){return Object.getOwnPropertyDescriptor(r,t).enumerable})),n.forEach(function(t){_defineProperty(e,t,r[t])})}return e}function _defineProperty(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}!function(){function t(a,u,o,i,n,t,e,c){var s=u.cleanFields,f="alarm/alarms",l="".concat(f,"/reports"),m={headers:u.contentHeaders("alarm")},r={WARNING:e("WARNING"),MINOR:e("MINOR"),MAJOR:e("MAJOR"),CRITICAL:e("CRITICAL")},p=[r.CRITICAL,r.MAJOR,r.MINOR,r.WARNING],g=_.keys(r),y={ACTIVE:e("ACTIVE"),ACKNOWLEDGED:e("ACKNOWLEDGED"),CLEARED:e("CLEARED")},h=_.keys(y),v=["id"],d=["id","self","creationTime","type","time","count","history","firstOccurence","firstOccurrenceTime"],E={},C="status",A={type:e("Type")};function D(t){var e=t.id||t;return u.url("".concat(f,"/").concat(e))}function O(t){var e=u.url(f),r=u.timeOrderFilter(u.pageSizeNoTotalFilter(t)),n={params:r},i=u.cleanListCallback("alarms",O,r);return a.get(e,n).then(i)}function w(t){var e=u.url(f),r=s(t,v);return a.post(e,r,m)}function N(t){var e=D(t),r=s(t,d);return a.put(e,r,m)}function b(e,t){return t?r(t):n.list({source:e.id,pageSize:1e3}).then(r);function r(t){var n="--";return e.status!==y.ACKNOWLEDGED||_.isEmpty(t)||(n=_.last(t).user),t.forEach(function(t){var e=t.changes||[],r=!1;if(e.forEach(function(t){if(t.attribute===C&&t.newValue===y.ACKNOWLEDGED)return!(r=!0)}),r)return n=t.user||n,!1}),n}}function T(t,e){function r(t){var e=t||[],n=e.length?e[e.length-1].creationTime:void 0;return e.forEach(function(e){var t=e.changes||[],r=!1;if(t.forEach(function(t){if(t.attribute===C&&t.newValue===y.ACKNOWLEDGED)return n=e.creationTime,!(r=!0)}),r)return!1}),n}return e?r(e):n.list({source:t.id,pageSize:1e3}).then(r)}function L(t,e){var r=R(t,e);return r.humanize?r.humanize():r.then(function(t){return t.humanize?t.humanize():""})}function R(o,t){function e(t){var e=t||[],r=o.creationTime,n=e.length?e[e.length-1].creationTime:void 0,i="";if(_.forEach(e,function(e){var t=e.changes||[],r=!1;if(t.forEach(function(t){if(t.attribute===C&&t.newValue===y.CLEARED)return n=e.creationTime,!(r=!0)}),r)return!1}),r&&n){var a=moment(r),u=moment(n);i=moment.duration(a.diff(u))}return i}return t?e(t):n.list({source:o.id,pageSize:1e3}).then(e)}function I(t,e){var r=[l,t];return e.id&&r.push(e.id),u.url(r.join("/"))}function k(t){var r=_.memoize(t,function(t,e){return[t.id,t.status,t.count,e&&e.length].join(":")});return function(t,e){return r(t,e)}}function S(t,e){var r=i.when(b(t,e)),n=i.when(T(t,e));return i.all([r,n]).then(function(t){return c.getString("ACKNOWLEDGED`alarm` by: {{ackBy}} {{ackTimeFromNow}}",{ackBy:t[0],ackTimeFromNow:moment(t[1]).fromNow()})})}function W(t,e){return i.when(L(t,e)).then(function(t){return c.getString("CLEARED`alarm`: was active for {{alarmDuration}}",{alarmDuration:t})})}function j(t){return i.when(c.getString("ACTIVE`alarm`: triggered {{alarmTimeFromNow}}",{alarmTimeFromNow:moment(t.time).fromNow()}))}E[r.WARNING]="circle",E[r.MINOR]="exclamation-circle",E[r.MAJOR]="exclamation-circle",E[r.CRITICAL]="warning",E[y.CLEARED]="check-circle",E[y.ACKNOWLEDGED]="bell-slash",E[y.ACTIVE]="bell";var G={list:O,listByStatus:function(t,e){var r=_.compact(_.map(t,function(t,e){return t?e:void 0})),n=_.map(r,function(t){return O(_objectSpread({},e,{status:t}))});return i.all(n).then(u.combineLists)},listByDevices:function(t,e){return i.all(_.map(t,function(t){return e.source=t,O(e)})).then(u.combineLists)},getSeverityCount:function(t,e){return _.filter(t,{severity:e}).length},detail:function(t){var e=D(t);return a.get(e)},update:N,updateBulk:function(t,e){var r=u.url(f);return a.put(r,e,{params:t})},create:w,save:function(t){return t.id?N(t):w(t)},acknowledgedBy:k(b),ackTime:k(T),alarmDuration:k(L),alarmDurationDiff:k(R),severity:r,severityList:g,getHighestSeverityFromAlarmsStatus:function(e){var t=_.map(p,function(t){return{severity:t,count:_.get(e,_.toLower(t),0)}}),r=_.find(t,function(t){return 0<t.count});return _.get(r,"severity",null)},status:y,statusList:h,statusText:k(function(t,e){var r;switch((t.status||"").toUpperCase()){case y.ACKNOWLEDGED:r=S;break;case y.CLEARED:r=W;break;case y.ACTIVE:r=j}return r&&r(t,e)}),icon:function(t){var e=(_.isObjectLike(t)?t.severity:t).toUpperCase();return E[e]},reports:{downtimeDuration:function(t){var e=u.timeOrderFilter(t),r=I("downtimeDuration",e),n={params:e};return a.get(r,n)},downtimeDurationAggregation:function(t){var e=u.timeOrderFilter(t),r=I("downtimeDuration/aggregation",e),n={params:e};return a.get(r,n)}},getDisplayCount:function(t){var e=u.url("".concat(f,"/count")),r={params:t};return a.get(e,r).then(u.getResData).then(function(t){return 99<t?"99+":t})},createCounter:function(t){var e=_.get(t,"source"),r="/alarms/".concat(e||"*"),n=new o.Counter(O,r);if(t){var i=[o.defaultPropertyMaps.date,o.defaultPropertyMaps.source];if(t.type){var a=t.type;i.push([function(t){return a===t.type}])}delete t.type,n.filter(t,i)}return n}};return t.enhanceWithKeysUtil({target:G,reservedKeys:["history","id","severity","self","source","creationTime","time","text","firstOccurrence","count","firstOccurrenceTime","status"],standardKeys:A})}t.$inject=["$http","c8yBase","c8yCounter","$q","c8yAudits","c8yUtil","gettext","gettextCatalog"],angular.module("c8y.core").factory("c8yAlarms",t)}();