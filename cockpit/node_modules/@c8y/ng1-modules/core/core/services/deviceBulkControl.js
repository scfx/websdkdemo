"use strict";!function(){function e(s,i,r){var l="devicecontrol/bulkoperations",n="\\/devicecontrol\\/bulkoperations\\/(\\d+)",a=i.cleanFields,c={headers:i.contentHeaders("bulkOperation")},E=["creationTime","id","self","operations"],o=[],u={SCHEDULED:"SCHEDULED",EXECUTING:"EXECUTING",COMPLETED_WITH_FAILURES:"COMPLETED_WITH_FAILURES",COMPLETED_SUCCESSFULLY:"COMPLETED_SUCCESSFULLY",CANCELLED:"CANCELLED"},e=_.keys(u),C="ACTIVE",L="IN_PROGRESS",t={PENDING:[u.SCHEDULED],EXECUTING:[u.EXECUTING],SUCCESSFUL:[u.COMPLETED_SUCCESSFULLY],FAILED:[u.COMPLETED_WITH_FAILURES,u.CANCELLED]},S={};function D(e){var t=e.id||e;return i.url("".concat(l,"/").concat(t))}function d(e,t){return _.isUndefined(t)?e:_.filter(e,function(e){return _.includes(_.isArray(t)?t:[t],T(e))})}function p(e){var t=i.url(l),r=a(e,E),n=_.cloneDeep(c);return s.post(t,r,n).then(U)}function U(e){var t=new RegExp(n),r=e.headers("Location").match(t);return parseInt(r[1],10)}function f(e){var t=i.url("".concat(l,"/").concat(e.id)),r=a(e,E.concat(o)),n=_.cloneDeep(c);return s.put(t,r,n)}function T(e){return"CANCELED"===e.status||"DELETED"===e.status?u.CANCELLED:!e.progress||!e.progress.all||0===e.progress.pending&&0===e.progress.executing&&0===e.progress.successful&&0===e.progress.failed?u.SCHEDULED:e.progress&&e.progress.successful+e.progress.failed<e.progress.all?u.EXECUTING:0<e.progress.failed?u.COMPLETED_WITH_FAILURES:u.COMPLETED_SUCCESSFULLY}function g(e){return t[e]}return S.SCHEDULED={label:r("SCHEDULED"),icon:"calendar",cls:""},S.EXECUTING={label:r("EXECUTING"),icon:"refresh",cls:"text-info"},S.COMPLETED_WITH_FAILURES={label:r("COMPLETED WITH FAILURES"),icon:"exclamation-circle",cls:"text-danger"},S.COMPLETED_SUCCESSFULLY={label:r("COMPLETED SUCCESSFULLY"),icon:"check-circle",cls:"text-success"},S.CANCELLED={label:r("CANCELLED"),icon:"ban",cls:"text-danger"},{list:function e(t,r){var n=i.url(l),a=i.pageSizeNoTotalFilter(t),c={params:a,silentError:r},E=i.cleanListCallback("bulkOperations",e,a);return s.get(n,c).then(E).then(_.partialRight(d,a.status))},detail:function(e){var t=D(e);return s.get(t)},create:p,save:function(e){return e.id?f(e):p(e)},update:f,canCancel:function(e){var t=e&&e.status;return _.includes([C,L],t)},cancel:function(e){e.status=u.CANCELLED,e.failureReason=r("Bulk operation cancelled by user.");var t=D(e);return s.delete(t)},retryFailed:function(e){var t=_.cloneDeep(e);return delete t.groupId,t.failedParentId=e.id,p(t)},status:u,statusList:e,getStatus:T,getStatusStyle:function(e){var t=_.isObjectLike(e)?T(e):e;return S[t]},doesMatchSingleOpStatus:function(e,t){var r=_.isObjectLike(e)?T(e):e,n=g(t);return _.includes(n,r)},getMappedSingleOpStatus:g}}e.$inject=["$http","c8yBase","gettext"],angular.module("c8y.core").factory("c8yDeviceBulkControl",e)}();