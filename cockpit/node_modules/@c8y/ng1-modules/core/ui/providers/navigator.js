"use strict";function _typeof(i){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(i){return typeof i}:function(i){return i&&"function"==typeof Symbol&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i})(i)}angular.module("c8y.ui").provider("c8yNavigator",function(){var o,s,a,c=[],h=0;function l(i){if(i.preventDuplicates&&!!_.find(c,{path:i.path,_parent:i.parent,name:i.name}))return;i.showIfContainsVisibleViews&&(i.showIf=function(n){i.$inject=["$q","$injector"];var e=n.showIf;function i(i,t){return i.all({showIf:!e||t.invoke(e),showIfContainsVisibleViews:t.invoke(r,null,{nav:n})}).then(function(i){return i.showIf&&i.showIfContainsVisibleViews})}return i}(i));var t=new m(i);return c.push(t),t}function r(i,t,n,e){var r=t.getByPath(e.path);return i.all(_.map(r,function(i){return n.configureVisibility(_.cloneDeep(i),"show",!1).then(_.property("show"))})).then(function(i){return _.some(i)})}function u(i,t){var n=p(i),e=c.indexOf(n);-1<e&&(c.splice(e,1),t||y())}function f(){return _.find(c,"active")}function p(i){if(i){d||y();var t=_.isString(i),n=_.isFunction(i),e=i,r={},o=t?"name":"hash";if(_.isObjectLike(i)){if(i instanceof m)return i;e=g(e)}if(n)r=e;else{if(!o||!e)return;r[o]=e}return _.find(c,r)}}var d=!(r.$inject=["$q","c8yViews","c8yUiUtil","nav"]);function v(){y();var i=_.filter(c,function(i){return!i.parent()});return 1===i.length&&i[0].ignoreIfSingle&&(i=[]),i}function y(){d=!0,_.invokeMap(c,"_clearChildren"),_.invokeMap(c,"addToParent"),_.invokeMap(c,"updatePriority")}function g(i){return function(i){return i.split("").reduce(function(i,t){var n=(i<<5)-i+t.charCodeAt(0);return n&n},0)}(JSON.stringify(i))}function m(i){return this._listenersMap={},this._parent=i.parent,this.hash=g(i),this._children=[],this.priority=i.priority||0,delete i.priority,delete i.parent,_.assign(this,i),this.configureVisibility(),this}return m.prototype={_listenersList:function(i){var t=this._listenersMap;return t[i]=t[i]?t[i]:[],t[i]},hasListeners:function(i){return _.get(this._listenersMap,"".concat(i,".length"))},update:function(i){this._parent=_.isUndefined(i.parent)?this._parent:i.parent,delete i.parent,_.assign(this,i)},on:function(i,t){return this._listenersList(i).push(t),this},off:function(i,t){var n=this._listenersList(i),e=n.indexOf(t);-1<e&&n.splice(e,1)},trigger:function(i){var t=this._listenersList(i),n=this;_.forEach(t,function(i){i(n)})},children:function(){var t=this;return _.isEmpty(t._children)||(t._children=_.sortBy(t._children,function(i){return t.sortAlphabetically&&!i.ignoreAlphabeticalOrder?(i.name||"").toLowerCase():-i.priority})),t._children},parent:function(){return this._parent&&p(this._parent)},addChild:function(i){var t=i;t instanceof m||(t=l(t)),0===this._children.length&&void 0===this.closed&&(this.closed=!0),-1===this._children.indexOf(t)&&(this._children.push(t),t._parent=this),t.active&&1===h&&this.expand()},removeChild:function(i){var t=p(i),n=this._children.indexOf(t);this._children.splice(n,1)},removeAllChildren:function(){_.forEach(this._children,function(i){i.removeAllChildren(),u(i,!0)}),this._clearChildren()},_clearChildren:function(){this._children.length=0},addToParent:function(){var i,t=this._parent;t&&(t instanceof m?i=t:"object"===_typeof(t)?((i=p(t.name))||(i=l(t)),t.icon&&!i.icon&&(i.icon=t.icon),t.iconOpen&&!i.iconOpen&&(i.iconOpen=t.iconOpen)):(i=p(t))||(i=l({name:t})),i?i.addChild(this):console.warn(i,"c8yNavigator: parent not found"))},removeFromParent:function(){var i=this._parent&&p(this._parent);i&&i.removeChild(this)},updatePriority:function(){if(this._children.length){var i="priority";this.priority=_(this._children).filter(i).map(i).max()||0}},url:function(i){var t="";return this.searchParams&&(t=_.reduce(this.searchParams,function(i,t,n){var e=i;return 1<e.length&&(e+="&"),e+=encodeURI("".concat(n,"=").concat(t))},"?")),!_.isUndefined(this.path)&&"".concat(i?"":"#","/").concat(this.path).concat(t)},expandCollapse:function(){this[!this.closed?"collapse":"expand"]()},expand:function(){this.closed&&(_.get(this._parent,"expand")&&this._parent.expand(),this.closed=!1,this.trigger("expand"))},collapse:function(){this.closed||(this.closed=!0,this.trigger("collapse"))},activate:function(){var i=f();if(i!==this)return i&&(i.active=!1),this.active=!0,this.trigger("active"),_.get(this._parent,"expand")&&this._parent.expand(),!0},matchToPath:function(i){var t,n=this.url(!0),e=0;return n&&(t=new RegExp("^".concat(n.replace(/\//,"\\/").replace("?","\\?"))).exec(i))&&(e=t[0].length),e},configureVisibility:function(){var i=this;this.visibilityConfigured||o&&s&&!this.visibilityConfiguredPromise&&(this.visibilityConfiguredPromise=o.whenAuthorized().then(function(){return s.configureVisibility(i)}).then(function(){i.visibilityConfigured=!0}))}},Object.defineProperty(m.prototype,"icon",{get:function(){var i=this.iconOpen||this.__icon;return this.closed?this.__icon:i},set:function(i){this.__icon=i}}),{addNavigation:l,$get:["$rootScope","$location","c8yAuth","c8yUiUtil",function(i,t,n,e){o=n,s=e,a=i;var r=_.debounce(function(){return function(n){var i=_(c).map(function(i,t){return{ix:t,score:i.matchToPath(n),lastClick:i.__lastClick}}).filter("score").value();if(i.length){var t=_.maxBy(i,"score"),e=!1;if(1===t.score&&1<n.length){var r=f();r&&(e=!(r.active=!1))}else{if(1<i.length){var o=_.filter(i,{score:t.score});1<o.length&&(t=_.maxBy(o,"lastClick"))}e=!!t&&c[t.ix].activate()}e&&a&&a.$applyAsync()}h++}(t.absUrl().split("#").pop()),!0},500,{trailing:!0,leading:!0});return i.$on("$locationChangeSuccess",r),_.invokeMap(c,"configureVisibility"),{rootNodes:v,findNode:p,addNavigation:function(i){var t=i,n=_.isArray(t);n||(t=[t]);var e=_.map(t,l);return y(),r(),n?e:e[0]},removeNavigation:function(i){u(i),r()}}}]}});