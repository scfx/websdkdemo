"use strict";function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?Object(arguments[t]):{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&i.push.apply(i,Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable})),i.forEach(function(t){_defineProperty(e,t,n[t])})}return e}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}!function(){t.$inject=["$q","$injector","$window","c8yAlarms","c8yAlert","c8yInventory","c8yBase","c8yRealtime","c8yUser","c8yConfig","c8ySmartRulesAvailability","gettextCatalog"];var X="c8yAlarmList";function t(P,U,K,z,B,G,V,M,q,H,J,Q){return{restrict:"EA",scope:{severities:"=?activeSeverities",options:"=?filter",realtime:"=?",hideHeaderActions:"=?",title:"=?",unresolved:"=?",paginate:"=?",refreshLoading:"=?",hideDevice:"=?"},templateUrl:":::PLUGIN_PATH:::/ui/views/alarmList.html",link:function(a,t,r){var i={};function o(t){z.detail(t).then(_.partial(e,t))}function e(t,e){var n=P.when(t);return i[t.id]&&(n=n.then(a.auditRefresh[t.id])),n.then(function(){_.assign(t,e.data)})}function n(t){if(!a.auditList||!a.auditList[t.id])return Q.getString("ACKNOWLEDGED`alarm`");var e=a.auditList[t.id],n=z.ackTime(t,e),i={ackBy:z.acknowledgedBy(t,e),ackTimeFromNow:moment(n).fromNow()};return Q.getString("ACKNOWLEDGED`alarm` by: {{ackBy}} {{ackTimeFromNow}}",i)}function s(t){if(!a.auditList||!a.auditList[t.id])return Q.getString("CLEARED`alarm`");var e={alarmDuration:z.alarmDuration(t,a.auditList[t.id])};return Q.getString("CLEARED`alarm`: was active for {{alarmDuration}}",e)}function u(t){var e={alarmTimeFromNow:moment(t.time).fromNow()};return Q.getString("ACTIVE`alarm`: triggered {{alarmTimeFromNow}}",e)}function c(t){var e=!0;return r.activeSeverities&&(e=_.isEmpty(a.severities)||a.severities[t.severity]),e&&!((a.unresolved||!1===(a.options&&a.options.resolved))&&"CLEARED"===t.status)}function l(t){var e=!0,n=_.get(a.options,"status");return _.isUndefined(n)||(e=Boolean(n[t.status])),e}function f(){return a.refreshLoading?P.resolve():(a.refreshLoading=!0,a.alarms=[],a.auditList={},i={},a.options=a.options||{},a.options.type&&(a.options.types=[a.options.type]),function(){if(!A(a.options).byDevices())return P.reject();var t=W();if(t.length<=0)return P.reject();var e=_.map(t,function(t){return z.list(_objectSpread({source:t,withSourceDevices:!0,withSourceAssets:!0,pageSize:k()},y(a.severities,"severity"),y(a.options.status,"status"),y(a.options.types,"type"),g(),function(t){var e=["severity asc","time.date desc","text asc"];return"ACTIVE_FIRST"===t&&(e=["status asc","severity asc","time.date desc","text asc"]),{query:"$orderby=".concat(e.join(","))}}(a.options.orderMode)))});return P.all(e).then(V.combineLists)}().catch(h).catch(v).catch(p).catch(d).then(S).finally(function(){a.refreshLoading=!1}))}function d(){var t={pageSize:k()};return z.list(t)}a.refreshLoading=!1;var m=_.throttle(function(){a.refreshLoading||(a.paging.loading=!0,a.refreshLoading=!0,a.realtimeAnimation=!1,a.paging.next().then(function(t){_.forEach(t,function(t){L("nextPage",t)}),a.paging.loading=!1,a.refreshLoading=!1,a.paging=t.paging}))},300,{trailing:!0});function p(){if(!A(a.options).bySeverity())return P.reject();var t=_objectSpread({severity:a.options.severity,pageSize:k()},g());return V.timeOrderFilter(t),z.list(t)}function v(){return A(a.options).byStatus()?z.listByStatus(a.options.status,_objectSpread({pageSize:k()},y(),g())):P.reject()}function y(e,t){return e?_.isArray(e)?_defineProperty({},t,e.join(",")):_defineProperty({},t,Object.keys(e).filter(function(t){return e[t]}).join(",")):{}}function g(){return"resolved"in a.options&&a.options.resolved?{}:_.isUndefined(a.options.resolved)?{resolved:void 0}:{resolved:!1}}function h(){if(!A(a.options).byType())return P.reject();var e=a.options.types,t=_objectSpread({pageSize:k()},g(),y(a.severities,"severity"),y(a.options.status,"status"),y(a.options.types,"type"));return z.list(t).then(function(t){return _.filter(t,function(t){return _.includes(e,t.type)})})}function S(t){var e=t;r.paginate&&!a.paginate||(a.paging=e.paging);var n=a.options;if(n){var i=A(n);e=_.filter(e,function(t){return(!i.byType()||_.includes(n.types,t.type))&&(!i.byStatus()||n.status[t.status])&&(!i.bySeverity()||n.severity===t.severity)})}return a.alarms=e}function b(t){var e=[["severity","time","text"],["asc","desc","asc"]];if("ACTIVE_FIRST"===a.options.orderMode){var n={ACTIVE:1,ACKNOWLEDGED:0,CLEARED:-1};e=[[function(t){return n[t.status]},"severity","time","text"],["desc","asc","desc","asc"]]}var i=_(t).filter(c).filter(l).orderBy(e[0],e[1]).value(),r=_.get(a,"options.displayFilter");return r&&(i=_.filter(i,r)),a.filteredAlarms=i}function A(e){function t(t){return function(){return e&&!!t}}var n=e||{};return{byType:t(!_.isEmpty(n.types)),byStatus:t(n.status&&!_.isEmpty(n.status)&&function(t){return _.some(t,function(t){return!0===t})}(n.status)),bySeverity:t(n.severity),byDevices:function(){return t(!_.isEmpty(W()))}}}function E(){a.realtimeAnimation=!1,f()}function L(t,e){if(a.realtimeAnimation=!0,$(e,a.options)){var n=_.find(a.alarms,{id:e.id});n?D(e,n):w(e,t)}}function w(t,e){var n=w._executing;if(n&&"nextPage"!==e)return n.creating=!0,P.reject(n);var i=T(t).then(function(t){a.alarms.unshift(t)}).finally(function(){w._executing=null});return w._executing=i}function D(e,t){var n=T(e,t.source.name);return i[e.id]&&(n=n.then(a.auditRefresh[e.id])),n.then(function(){a.realtimeAnimation=!0;var t=_.findIndex(a.alarms,{id:e.id});a.alarms[t]=e})}function R(t){_.remove(a.alarms,{id:t.id}),delete a.auditList[t.id],delete i[t.id]}function j(t,n){a.realtimeAnimation=!0,!_.some(a.alarms,function(t){var e;return t.id===n.id&&($(n,a.options)?D(n,t):R(n),e=!0),e})&&$(n,a.options)&&w(n).catch(function(e,n){return function(t){return t&&t.creating&&_.isFunction(t.then)?t.then(_.partial(j,e,n)):P.reject(t)}}(t,n))}function C(t,e){var n;return a.realtimeAnimation=!0,_.forEach(a.alarms,function(t){t.id===e.id&&(R(e),n=!1)}),n}function T(e,t){var n=P.resolve(e);return _.defaultsDeep(e,{source:{name:t}}),!e.source.name&&e.source.id&&(n=function(t){return G.detail(t).then(V.getResData).then(function(t){return t.name})}(e.source.id).then(function(t){e.source.name=t}).then(function(){return e})),n}function $(t,e){return function(n,t){return!t||_.some(t,function(t,e){return t&&e===n.status})}(t,e.status)&&function(t,e){return _.isEmpty(e)||_.includes(e,t.type)}(t,e.types)&&function(t,e){return!e||e===t.severity}(t,e.severity)}function k(){return a.options&&Number(a.options.pageSize)||20}function x(){M.switchRealtime(a.$id,a.realtimeChannel)}function N(){return M.getStatus(a.$id,a.realtimeChannel)}function O(t,e){M.addListener(a.$id,a.realtimeChannel,t,e)}function I(){var t=a.realtimeChannel,e=function(){var t=W();return"/alarmsWithChildren/".concat(t.length?t.join(","):"*")}();if(t){if(e===t)return;M.removeSubscriber(a.$id,t),a.cancelDestroyRemoveSubscriber(),a.stopWatchingRealtime()}a.realtimeChannel=e,O("".concat(a.$id,"-subscribed"),E),O("CREATE",L),O("UPDATE",j),O("DELETE",C),a.cancelDestroyRemoveSubscriber=a.$on("$destroy",function(){return M.removeSubscriber(a.$id,a.realtimeChannel)}),a.stopWatchingRealtime=a.$watch("realtime",F),a.realtime&&x()}function W(){var t=a.options,e=t.source,n=t.sources,i=_.concat(n,e);return _(i).map(function(t){return V.hasId(t)&&V.getId(t)}).compact().value()}function F(){a.realtime&&f(),a.realtime!==N()&&x()}a.auditRefresh={},a.statusText=function(t){var e;switch((t.status||"").toUpperCase()){case z.status.ACKNOWLEDGED:e=n;break;case z.status.CLEARED:e=s;break;case z.status.ACTIVE:e=u;break;default:e=function(){return""}}return e(t)},a.isActive=function(t){return t.status===z.status.ACTIVE},a.toggle=function(t){i[t.id]=!i[t.id]},a.isOpen=function(t){return!0===i[t.id]},a.isNarrow=function(){return a.containerWidth<=991},a.changeStatus=function(t,e){a.changingStatus=!0;var n=Q.getString('Alarm status changed to "{{status | translate}}".',{status:e}),i=z.update({id:t.id,status:e});return N()||(i=i.then(_.partial(o,t))),(i=i.then(function(){B.success(n)})).finally(function(){a.changingStatus=!1})},a.isFitSeverity=c,a.icon=z.icon,a.getStandardKeys=z.getStandardKeys.bind(z),a.getNonStandardKeys=z.getNonStandardKeys.bind(z),a.alarmDuration=function(t){return a.auditList&&a.auditList[t.id]?z.alarmDuration(t,a.auditList[t.id]):""},a.refresh=f,a.loadNext=m,a.createSmartRule=function(e){var t;return a.smartRules&&(t=q.current().then(function(t){return a.smartRulesSvc.addNewForInputAlarmAndOutputUserWithUI(e,t)})),t},a.translateAlarmText=function(t){return Q.getString(t.text)},a.getDeviceLinkFromAlarm=_.memoize(function(t){var e=H[X]||{};return e.getDeviceLinkFromAlarm?e.getDeviceLinkFromAlarm(t):["#","device",t.source.id].join("/")},function(t){return t.id}),a.$watch(function(){return{containerWidth:t.parent().width(),windowWidth:K.innerWidth}},function(t){a.containerWidth=t.containerWidth||t.windowWidth},!0),a.$watch("alarms",b,!0),a.$watch("severities",function(){f().then(function(){return b(a.alarms)})},!0),a.$on("alarmListRefresh",f),r.filter?a.$watch("options",function(){f().then(I)},!0):a.realtime||f(),J.shouldShowGlobalSmartRules().then(function(t){a.smartRules=t&&V.checkIfModulesExist(["c8y.cockpit.config"])}).then(function(){a.smartRules&&(a.smartRulesSvc=U.get("smartRulesSvc"))})}}}angular.module("c8y.ui").directive(X,t)}();