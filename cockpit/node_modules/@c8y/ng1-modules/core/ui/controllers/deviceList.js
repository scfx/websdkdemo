"use strict";function _objectSpread(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?Object(arguments[e]):{},i=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&i.push.apply(i,Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.forEach(function(e){_defineProperty(n,e,t[e])})}return n}function _defineProperty(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}!function(){function e(i,e,r,o,c,a,n,t,u,l,s,d,g,f,m,h,p,v){var y,C="all-devices-columns-config",D=40,I=this,b=g("No devices to display."),S=_.throttle(function(){i.parentDeviceId()&&(I.realtimeAnimation=!1,I.realtimeChannel="/managedobjects/*",t.addListener(i.$id,I.realtimeChannel,t.realtimeActions().CREATE,E),t.addListener(i.$id,I.realtimeChannel,t.realtimeActions().UPDATE,N),t.addListener(i.$id,I.realtimeChannel,t.realtimeActions().DELETE,R),I.rtState=function(){return t.getStatus(i.$id,I.realtimeChannel)},I.rtStart=function(){t.start(i.$id,I.realtimeChannel)},I.rtStop=function(){t.stop(i.$id,I.realtimeChannel)});return r.when().then(G).then($).then(L).then(k).then(U)},500,{leading:!1,trailing:!0}),w={clickDeleteCallback:function(e){return m.deleteDeviceWithConfirmation(e).then(function(){_.pull(I.devices,e),I.totalDevices-=1})}};function G(){return(i.parentDeviceId()?r.resolve(h.getChildDeviceColumns(w)):p.getConfigurableColumns({dynamicGroupId:i.dynamicGroupId(),options:w}).then(function(e){return O(y=e)})).then(function(e){I.columns=e||I.columns})}function $(){return(i.parentDeviceId()?r.when({}):i.dynamicGroupId()?s.getColumnsConfig(i.dynamicGroupId()):d.get(C)).then(function(e){I.columnsConfig=e||I.columnsConfig})}function L(e){var n=e||{};return void 0===n.pageSize&&(n.pageSize=D),(i.parentDeviceId()?(I.rtStop&&I.rtStop(),j({pageSize:D})):i.dynamicGroupId()?s.getGroupItems(i.dynamicGroupId(),n):function(e){var n=l.getQuery(I.columns,I.columnsConfig);return o.listQuery(n,_objectSpread({withGroups:!0,withChildren:!1},e))}(n)).then(function(e){return A(e,!0)})}function j(e){var n={params:_objectSpread({},e,{withChildren:!1,withTotalPages:!0}),skipDetail:!0},t=i.parentDeviceId();return c.children(t,"childDevices",n).then(function(e){var n=e.data;return i.paging=a.createPaging(n,j),c.onChildren(e)})}function A(e,n){I.devices||(I.devices=[]),n&&(I.devices.length=0),e.forEach(function(e){_.assign(e,{properName:o.properName(e)}),I.devices.push(e)}),I.devices=function(e){var n=e,t=I.columnsConfig.systemId;if(t&&0!==t.sorting.order){var i=1===t.sorting.order?"asc":"desc";n=_.orderBy(e,function(e){return _.toNumber(e.id)},i)}return n}(I.devices),e.paging&&(i.paging=e.paging)}function O(e){return _.filter(e,"meta.active")}function P(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:i.dynamicGroupId();return p.saveConfigurableColumnsMeta({dynamicGroupId:e,configurableColumns:y})}function T(e){I.columnsConfig=e||I.columnsConfig,function(){var e;e=i.parentDeviceId()?r.when():i.dynamicGroupId()?s.saveColumnsConfig(i.dynamicGroupId(),I.columns,I.columnsConfig):d.set(C,I.columnsConfig);return e}().then(function(){return L()})}function E(e,n){var t=!n.c8y_IsDevice,i=!1;I.realtimeAnimation=!0,_.forOwn(I.devices,function(e){return e.id!==n.id||!(i=!0)}),t||i||(_.assign(n,{properName:o.properName(n)}),I.devices.push(n),I.totalDevices+=1)}function N(e,n){I.realtimeAnimation=!0,_.forOwn(I.devices,function(e){e.id===n.id&&(_.assign(n,{properName:o.properName(n)}),_.assign(e,n))})}function R(e,n){I.devices=_.reject(I.devices,{id:n.id})}function U(){if(i.setTitles()&&I.devices){var t={title:void 0,subtitle:void 0};return i.parentDeviceId()?o.detailCached(i.parentDeviceId()).then(a.getResData).then(function(e){return t.subtitle=f.getPlural(I.devices.length,"Showing 1 child device","Showing {{$count}} child devices",{}),t.title=e.name,v.changeTitle(r.when(t))}):i.dynamicGroupId()?c.detailCached(i.dynamicGroupId()).then(a.getResData).then(function(e){t.title=e.name;var n=I.devices.length;return t.subtitle=f.getString("Showing {{length}} items",{length:n}),v.changeTitle(r.when(t))}):(t.title=g("All devices"),t.subtitle=_.isUndefined(I.totalDevices)?f.getString("Showing {{devices.length}}",I):f.getString("Showing {{devices.length}} of {{totalDevices}}",I),v.changeTitle(r.when(t)))}return!1}function k(){i.parentDeviceId()?I.totalDevices=I.devices.length:i.dynamicGroupId()||o.getCount().then(function(e){I.totalDevices=e})}_.assign(I,{columnsConfig:{},noItemsMessage:b,clearColumnsConfig:function(){T({})},createSmartGroup:function(){return s.createWithUI({columns:I.columns,columnsConfig:I.columnsConfig,configurableColumns:y})},onLoadMore:function(e){I.realtimeAnimation=!1,i.paging.loading=!0,(e?L({pageSize:e}):i.paging.next().then(A)).finally(function(){i.paging.loading=!1})},onColumnsConfigChanged:T,parentDeviceId:function(){return i.parentDeviceId()},configureColumns:function(){return p.popupModalColumnsConfigure({dynamicGroupId:i.dynamicGroupId(),columnOptions:w}).then(function(e){y=e,I.columns=O(e)}).then(P).then(function(){return n.success(g("Columns definitions saved."))}).then(L)}}),i.refresh=function(){return I.realtimeAnimation=!1,I.refreshLoading=!0,i.paging?(i.paging.refresh().then(_.partialRight(A,!0)).then(k).finally(function(){I.refreshLoading=!1}),i.paging=null,!1):L().finally(function(){I.refreshLoading=!1})},i.$watch("parentDeviceId()",S),i.$watch("dynamicGroupId()",S),i.$watch("ctrl.devices.length",U),i.$watch("ctrl.totalDevices",U),e.$on("deviceList.getLoadedDevicesList",function(){e.$emit("deviceList.loadedDevicesList",I.devices)})}e.$inject=["$scope","$rootScope","$q","c8yDevices","c8yInventory","c8yBase","c8yAlert","c8yRealtime","c8yQueriesUtil","c8yFilteringSortingInventoryQueries","c8yDynamicGroups","c8yUserPreferences","gettext","gettextCatalog","groupsHierarchySvc","c8yDeviceListColumns","c8yConfigurableDeviceListColumns","c8yTitle"],angular.module("c8y.ui").controller("c8yDeviceListCtrl",e)}();