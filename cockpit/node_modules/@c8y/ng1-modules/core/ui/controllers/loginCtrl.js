"use strict";angular.module("c8y.ui").controller("c8yLoginController",["$scope","$location","$window","c8yBase","c8yLoginService","gettextCatalog","c8ySettings","c8yLoginOptions","c8yConfig",function(n,r,o,t,a,s,e,i,c){var u,d,f=this,l=[],g=a.MESSAGES,p=a.FORMS;function h(e){return _.find(a.getLoginOptions(),function(n){return n.type.toLowerCase()===e})}function w(){l.length=0}function m(n){var e=n.data.message;e&&$("remote_error",e=s.getString(e))}function v(n){var e=n.action;e?(E(e.form,e.keepCredentials),e.msg&&x.apply(this,e.msg)):m(n)}function y(n){return a.login(n.tenant,n.name,n.password,n.rememberMe).catch(v)}function P(){w(),L("password_reset_requested")}function R(){w(),E(p.LOGIN),L("password_changed")}function O(){$("phone_number_error")}function S(n){var e=_.get(n,"config.url","").match(/user\/pin$/)&&403===n.status;e?$("tfa_pin_invalid"):m(n)}function C(){u=void 0}function E(n,e){f.user.name=f.user.name||t.getRuntimeOption("userPrefilled"),f.user.password=e?f.user.password:void 0,f.user.newPassword=e?f.user.newPassword:void 0,f.user.newPasswordConfirm=e?f.user.newPasswordConfirm:void 0,f.formToDisplay=n,w(),n===p.NEW_PASSWORD&&(T(),F())}function T(n){a.mustEnforcePasswordStrength(n).then(function(n){f.user.enforcePasswordStrength=n,A()})}function F(n){a.getPasswordMinGreenLength(n).then(function(n){(function(n){e.setUserPasswordValidationParams(n),f.passwordRegex=c.validation.password.pattern,g.ERROR.pattern_newPassword=c.validation.password.message})(f.user.minGreenLength=n),A()})}function L(n,e){return x("success",g.SUCCESS,n,e)}function $(n,e){return x("danger",g.ERROR,n,e)}function x(n,e,t,r){l.push({type:n,class:"alert-".concat(n),text:r||e[t]})}function A(n){var e=n;e||(e=A.formToValidate),e&&(A.formToValidate=e,a.validateForm(e,f.user).then(function(){w(),_.forEach(e.$error,function(n,e){var t=e;n&&"required"!==t&&("pattern"===t&&(t="".concat(t,"_").concat((n[0]||{}).$name||"")),$(t))})}))}f.showTenant=a.showTenant(),f.FORMS=p,f.disabledForm=function(n){return u||n.$invalid},f.showForm=E,f.messages=l,f.login=function(n){w(),(u=y(n)).finally(C)},f.redirectOauth=function(){var n=f.oauthOptions.initRequest,e=encodeURIComponent(r.absUrl()),t="".concat(n.includes("?")?"&":"?","originUri=").concat(e);o.location.href="".concat(n).concat(t)},f.resetPassword=function(n){w(),(u=a.resetPassword(n).then(P).catch(m)).finally(C)},f.changePassword=function(n){w(),(u=a.changePassword(n).then(R).catch(function(n){var e;e=n.data.message,_.isEqual(e,"Error during password change : Token expired.")?(f.formToDisplay="password_reset",$("password_reset_token_expired")):m(n)})).finally(C)},f.savePhoneNumber=function(n){w(),(u=a.savePhoneNumber(f.user,n).then(_.partial(y,f.user)).catch(O)).finally(C)},f.verifyTFACode=function(n){w(),(u=a.verifyTFACode(n).catch(S)).finally(C)},f.resendTFASms=function(){w(),(u=a.resendTFASms().then(function(){L("resend_sms")}).catch(m)).finally(C)},f.fieldClass=function(n,e){var t=(e||d)[n]||{};return t.$dirty&&t.$invalid?"has-error":""},f.fieldTooltip=function(n,e){var t,r,o=(e||d)[n]||{};return _.reduce((t=o.$error,r=n,_(t).map(function(n,e){var t=g.ERROR[e]||g.ERROR["".concat(e,"_").concat(r)];return n&&(s.getString(t)||e)}).filter(_.identity).value()),function(n,e){return n+(n?". ":"")+e},"")},f.setCurrentForm=function(n){d=n},f.validate=A,f.getEnforcePassword=T,f.getPasswordMinGreenLength=F,f.onTenantInputBlur=function(){f.getEnforcePassword(f.user.tenant),f.getPasswordMinGreenLength(f.user.tenant)},f.passwordRegex=c.validation.password.pattern,f.extra_link=t.appOption("login_extra_link"),f.showBasic=!1,f.user={},f.oauthOptions=void 0,w(),a.initializing.then(function(n){f.showBasic=!!h(i.loginOptions.BASIC.value),f.oauthOptions=h(i.loginOptions.OAUTH2.value),E(n)})}]);