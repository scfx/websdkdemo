"use strict";angular.module("c8y.ui").controller("c8yRadialGaugeCtrl",["$scope","$element","$window","$filter",function(a,t,e,i){var r={container:null,gauge:null,ranges:null,pointer:{knob:null,gradient:null,text:null}},d={width:0,height:0,base:0},o={x:0,y:0},s={limits:{lower:0,upper:0},ranges:[],precision:2},p={width:300,height:300,minPointerRotation:-140,maxPointerRotation:140,greenRangeColor:"#7ED321",yellowRangeColor:"#F5A623",redRangeColor:"#D0021B",lowerLimit:0,upperLimit:100,precision:2,unit:"",pointerGradientColorFar:"#FFFFFF",pointerGradientColorNear:"#5ADCEA",initialValueUpdateTransitionDuration:500,valueUpdateTransitionDuration:2e3,pointerValueTextFontSize:"1.75em",pointerValueTextFillColor:"#FFFFFF",pointerUnitTextFontSize:"1.5em",pointerUnitTextFillColor:"#F8F8F8",scaleTicksCount:10,scaleTickFontSize:"0.85em",gaugeWheelStrokeColor:"#D8D8D8",gaugeWheelFillColor:"#F5F5F5",scaleWheelStrokeColor:"#F1F1F1",scaleWheelFillColor:"#FFFFFF",scaleTickStrokeColor:"#FFFFFF",scaleTickStrokeWidth:5,scaleTickFontColor:"#444444",pointerKnobStrokeColor:"#333333",pointerKnobFillColor:"#333333",gaugeScaleInnerRadiusFactor:.7,gaugeScaleOuterRadiusFactor:1},n={degsToRads:function(t){return t*(Math.PI/180)}},u={valueToRotationRads:d3.scale.linear().domain([p.lowerLimit,p.upperLimit]).range([n.degsToRads(p.minPointerRotation),n.degsToRads(p.maxPointerRotation)]),valueToRotationDegs:d3.scale.linear().domain([p.lowerLimit,p.upperLimit]).range([p.minPointerRotation,p.maxPointerRotation]),pointerGradientProgressToColor:d3.scale.pow().exponent(25).domain([0,360]).range([p.pointerGradientColorFar,p.pointerGradientColorNear]),pointerGradientProgressToOpacity:d3.scale.pow().exponent(25).domain([0,360]).range([0,1])},l={rotate:function(t,e){var n=[t,e.x,e.y].join(",");return["rotate(",n,")"].join("")},translate:function(t){var e=[t.x,t.y].join(",");return["translate(",e,")"].join("")}},c=d3.svg.line().x(function(t){return t.x}).y(function(t){return t.y}).interpolate("linear");function g(){d.width=(parseInt(a.width(),10)||t.width()||p.width)-5,d.height=(parseInt(a.height(),10)||t.parent().parent().height()||p.height)-5,d.base=Math.min(d.width,d.height)/2,o.x=d.width/2,o.y=d.height/2,_.forEach([{property:"pointerValueTextFontSize",fn:function(t){return.007678571*t+.2280357},min:.85,max:2.5,precision:2,unit:"em"},{property:"scaleTickFontSize",fn:function(t){return.007107143*t+.00527381},min:.65,max:1.5,precision:2,unit:"em"},{property:"pointerUnitTextFontSize",fn:function(t){return.007107143*t+.00527381},min:.65,max:2,precision:2,unit:"em"}],function(t){var e=t.property,n=t.fn,i=t.min,a=t.max,r=t.precision,o=t.unit,l=n(d.base),s=_.round(l,r),u=_.clamp(s,i,a);_.set(p,e,"".concat(u).concat(o))}),t.empty(),r.container=d3.select(t[0]).append("svg").attr("viewBox",[0,0,d.width,d.height].join(",")),r.gauge=r.container.append("g").attr("class","radial-gauge"),r.gauge.append("circle").attr("cx",o.x).attr("cy",o.y).attr("r",d.base).style("stroke",p.gaugeWheelStrokeColor).style("fill",p.gaugeWheelFillColor),r.ranges=r.gauge.append("g").attr("class","radial-gauge-ranges"),r.ranges.selectAll("path").data(s.ranges).enter().append("path").attr("d",d3.svg.arc().innerRadius(d.base*p.gaugeScaleInnerRadiusFactor).outerRadius(d.base*p.gaugeScaleOuterRadiusFactor).startAngle(function(t){return u.valueToRotationRads(t.min)}).endAngle(function(t){return u.valueToRotationRads(t.max)})).style("fill",function(t){return t.color}).attr("transform",l.translate(o)),function(){r.scale=r.container.append("g").attr("class","radial-gauge-scale"),r.scale.append("circle").attr("cx",o.x).attr("cy",o.y).attr("r",.7*d.base).style("stroke",p.scaleWheelStrokeColor).style("fill",p.scaleWheelFillColor);var t=(s.limits.upper-s.limits.lower)/p.scaleTicksCount,e=d3.range(s.limits.lower,s.limits.upper,t).map(_.identity);e.push(s.limits.upper);var n=_.every(e,function(t){return Math.round(t)===t});r.scale.selectAll("line").data(e).enter().append("line").attr("x1",o.x).attr("y1",o.y-.7*d.base).attr("x2",o.x).attr("y2",o.y-.75*d.base).attr("transform",function(t){return l.rotate(u.valueToRotationDegs(t),o)}).style("stroke",p.scaleTickStrokeColor).style("stroke-width",p.scaleTickStrokeWidth),r.scale.selectAll("text").data(e).enter().append("text").attr("x",o.x).attr("y",o.y-.8*d.base).attr("text-anchor","middle").style("font-size",p.scaleTickFontSize).style("font-weight","bold").attr("fill",p.scaleTickFontColor).attr("transform",function(t){return l.rotate(u.valueToRotationDegs(t),o)}).text(function(t){return i("number")(t,n?0:s.precision)})}(),r.pointer.knob=r.container.append("g").attr("class","radial-gauge-pointer-knob"),r.pointer.knob.append("circle").attr("cx",o.x).attr("cy",o.y).attr("r",.55*d.base).style("stroke",p.pointerKnobStrokeColor).style("fill",p.pointerKnobFillColor),r.pointer.knob.append("path").attr("d",c([{x:o.x-.55*d.base,y:o.y},{x:o.x+.55*d.base,y:o.y},{x:o.x,y:o.y-.8*d.base}])).attr("fill",p.pointerKnobFillColor),r.pointer.text=r.container.append("text").attr("x",o.x).attr("y",o.y+-.2*d.base).style("font-size",p.pointerValueTextFontSize).attr("fill",p.pointerValueTextFillColor).attr("text-anchor","middle").text(i("number")(s.value,s.precision)||""),r.pointer.textUnit=r.container.append("text").attr("id","text-unit").attr("x",o.x).attr("y",o.y).style("font-size",p.pointerUnitTextFontSize).attr("fill",p.pointerUnitTextFillColor).attr("text-anchor","middle").text(s.unit),r.pointer.dateTimeText=r.container.append("text").attr("id","text-time").attr("x",o.x).attr("y",o.y+.2*d.base).style("font-size",p.pointerUnitTextFontSize).attr("fill",p.pointerUnitTextFillColor).attr("text-anchor","middle").attr("font-style","italic").text(i("absoluteDateTimeShort")(a.time)),f(a.value||s.value||0)}function m(){var t,e,n,i;s.ranges=a.ranges||[],t=s.dataPoint.yellowRangeMin,e=s.dataPoint.yellowRangeMax,x(t,e,p.yellowRangeColor),n=s.dataPoint.redRangeMin,i=s.dataPoint.redRangeMax,x(n,i,p.redRangeColor)}function x(t,e,n){var i=Number(t),a=Number(e);_.isFinite(i)&&_.isFinite(a)&&s.ranges.push({min:i,max:a,color:n})}function f(t){s.previousValue=s.value,s.value=t,s.previousDateTimeValue=s.dateTimeValue,s.dateTimeValue=moment(a.time).valueOf();var e=!!_.isUndefined(s.previousValue);!function(t){if(r.pointer.gradient){var e=t?p.initialValueUpdateTransitionDuration:p.valueUpdateTransitionDuration;r.pointer.gradient.transition().duration(e).call(F,s.value)}}(e),function(t){if(r.pointer.knob){var e=t?p.initialValueUpdateTransitionDuration:p.valueUpdateTransitionDuration;r.pointer.knob.transition().duration(e).attrTween("transform",function(t,e){return function(){return d3.interpolateString(l.rotate(u.valueToRotationDegs(t),o),l.rotate(u.valueToRotationDegs(e),o))}}(_.isUndefined(s.previousValue)?s.limits.lower:s.previousValue,s.value))}}(e),function(t){if(r.pointer.text){var e=t?p.initialValueUpdateTransitionDuration:p.valueUpdateTransitionDuration;r.pointer.text.transition().duration(e).tween("text",function(){var e=this,n=d3.interpolate(s.previousValue,s.value);return function(t){e.textContent=i("number")(n(t),s.precision)}})}}(e),function(t){if(r.pointer.dateTimeText){var e=t?p.initialValueUpdateTransitionDuration:p.valueUpdateTransitionDuration;r.pointer.dateTimeText.transition().duration(e).tween("text",function(){var e=this,n=d3.interpolate(s.previousDateTimeValue,s.dateTimeValue);return function(t){e.textContent=_.isNaN(n(t))?"":i("absoluteDateTimeShort")(n(t))}})}}(e)}function F(t,e){var o=function(t){return d3.scale.linear().domain([0,360]).range([u.valueToRotationRads(s.limits.lower),u.valueToRotationRads(_.isUndefined(t)?s.limits.lower:t)])}(e),l=d3.svg.arc().innerRadius(d.base*p.gaugeScaleInnerRadiusFactor).outerRadius(d.base*p.gaugeScaleOuterRadiusFactor).startAngle(function(t){return t.startAngle}).endAngle(function(t){return t.endAngle});t.attrTween("d",function(e,t){var n=d3.interpolate(e.startAngle,o(t)),i=d3.interpolate(e.endAngle,o(t+1)),a=d3.interpolate(e.color,u.pointerGradientProgressToColor(t)),r=d3.interpolate(e.opacity,u.pointerGradientProgressToOpacity(t));return function(t){return e.startAngle=n(t),e.endAngle=i(t),e.fill=a(t),e.opacity=r(t),l(e)}})}a.$watch("dp",function(t){var e;t&&(s.dataPoint=t,s.limits.lower=a.lowerLimit||Number(s.dataPoint.min)||p.lowerLimit,s.limits.upper=a.upperLimit||Number(s.dataPoint.max)||p.upperLimit,s.unit=a.valueUnit||s.dataPoint.unit||p.unit,u.valueToRotationRads=d3.scale.linear().domain([s.limits.lower,s.limits.upper]).range([n.degsToRads(p.minPointerRotation),n.degsToRads(p.maxPointerRotation)]),u.valueToRotationDegs=d3.scale.linear().domain([s.limits.lower,s.limits.upper]).range([p.minPointerRotation,p.maxPointerRotation]),e=void 0===a.fractionSize?p.precision:a.fractionSize,s.precision=e,m(),g())},!0),a.$watch("measurement",function(t){if(t){var e=t&&t.value;f(a.value||(_.isFinite(e)?e:s.value||0))}},!0),a.$on("dashboardResize",g),a.$on("$destroy",function(){e.removeEventListener("resize",g)}),e.addEventListener("resize",g),g()}]);