"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(){function e(r,u,t,c,l,n,e,o,a,i,f,s,y,d){return h.$inject=["options","$uibModalInstance"],{askForPassword:function(){try{return r.get("c8yPasswordConfirm").confirmPassword().toPromise()}catch(e){return u.resolve(!0)}},warnIfPasswordExpiresSoon:function(){var e="passwordExpirationAlertsDisplayed";function s(e,t){return!e||moment(e).isBefore(moment(t))}return u.all({user:l.current(),expirationAlertsDisplayedPreference:n.get(e),validityLimitInDays:o.detailValue({category:"password",key:"limit.validity"},0)}).then(function(e){var t=e.user,n=e.expirationAlertsDisplayedPreference,r=e.validityLimitInDays,o=n||{LESS_THAN_WEEK:null,LESS_THAN_DAY:null};if(0!==r){var a=moment(t.lastPasswordChange).add(r,"days"),i=moment.duration(a.diff(moment())).asDays(),u=!1;i<=1&&s(o.LESS_THAN_DAY,t.lastPasswordChange)?(u=!0,o.LESS_THAN_DAY=moment().format(c.dateFullFormat)):i<=7&&s(o.LESS_THAN_WEEK,t.lastPasswordChange)&&(u=!0,o.LESS_THAN_WEEK=moment().format(c.dateFullFormat)),u&&f.warning(y.getString("Your password will expire {{expirationTime | relativeDate}}. Consider changing password now.",{expirationTime:a}))}return o}).then(_.partial(n.set,e))},createUserFlatTree:function(e){return g(m(e))},buildUserTree:m,flattenTree:g,search:function(e,t){var n=["userName","lastName","firstName","email","phone"],r=_.constant(!0),o=_.constant(!0);if(e){var a=new RegExp(e,"i");r=function(t){return _.some(n,function(e){return a.test(t[e])})}}if(t&&t.length){var i=_.reduce(t,function(e,t){return e[t.id]=!0,e},{});o=function(e){return _.some(e.groups.references,function(e){return i[_.get(e,"group.id")]})}}return function(e){return r(e)&&o(e)}},selectUserDialog:function(e){return t.open({templateUrl:":::PLUGIN_PATH:::/ui/user/selectUser.modal.html",controllerAs:"vm",controller:h,resolve:{options:_.constant(e)}}).result},userHierarchyActive:_.once(function(){return e.listByUser().then(function(e){return!!_.find(e,{key:"c8y-feature-user-hierarchy"})})}),hideUsers:function(e,t){var n=_(_.isArray(t)?t:[t]).map(p(e)).value(),r=function(){var t=_.keyBy(n,"id");return _.filter(e,function(e){return t[e.owner]&&!t[e.id]})};for(;r().length;)n=_.union(n,r());return _.uniq(n)},mapToUsersInMemory:p,canUserManageTenant:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.user,n=e.tenant,o=e.mustBeTopTenant,a=r.get("c8yPermissions"),i=r.get("c8yTenant");return u.all({user:t||l.current(),tenant:n||i.current()}).then(function(e){var t=i.isTopTenant(e.tenant.name),n=_.get(e.tenant,"allowCreateTenants"),r=a.hasRole(e.user,"ROLE_TENANT_MANAGEMENT_READ");return r&&(o?t:t||n)})},requireLogout:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:angular.noop;return i({title:s("Logout required"),body:s("You must log out to apply your changes. Do you want to proceed?"),status:"warning",labels:{ok:s("Confirm and log out"),cancel:s("Cancel")},dismissValue:"canceled"}).then(e).then(a.logout).then(function(e){e&&e.url?d.location.href=e.url:d.location.reload()})}};function m(t){var e=function(e){var t=_.keyBy(e,"id");return _.reject(e,function(e){return e.owner&&!t[e.owner]&&delete e.owner,e.owner})}(t),n=_.keyBy(t,"id");return _.forEach(t,function(e){e._owns=_.filter(t,{owner:e.id}),e._owner=_.get(n,e.owner)}),e}function p(n){return function(e){var t;return"string"==typeof e&&(t=e),"object"===_typeof(e)&&(t=e.userName),_.find(n,{userName:t})}}function g(e,t,n){var r=n||[],o=_.sortBy(e,["id","lastName"]),a=t||0;return _.reduce(o,function(e,t){return t._depth=a,e.push(t),g(t._owns,a+1,e)},r)}function h(e,t){_.assign(this,{textOk:s("Select"),textCancel:s("Cancel")},e,t)}}e.$inject=["$injector","$q","$uibModal","c8yBase","c8yUser","c8yUserPreferences","c8yApplication","c8ySettings","c8yAuth","c8yModal","c8yAlert","gettext","gettextCatalog","$window"],angular.module("c8y.ui").factory("c8yUserUtil",e)}();