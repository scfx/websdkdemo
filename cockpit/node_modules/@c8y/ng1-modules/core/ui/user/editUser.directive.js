"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(){function e(o,u,l,g,f,p,m,w,h,E,A,S,y){return e.$inject=["$scope","$q"],{restrict:"EA",scope:{user:"=",forms:"=",password:"=",hideUsername:"=?",hideActive:"=?",hideFirstName:"=?",hideLastName:"=?",hideEmail:"=?",hideTelephone:"=?",hideCustomProperties:"=?",hideTfaOption:"=?",hidePasswordReset:"=?",hideChangePassword:"=?",hideOwner:"=?",hideDelegate:"=?",disabledEdit:"=?",hideLanguage:"=?",userTfaEnforced:"=?",topLevelTfaEnforced:"=?"},templateUrl:":::PLUGIN_PATH:::/ui/user/editUser.directive.html",controller:e,controllerAs:"vm",link:function(e,t){$(t).find("input[name=email]").bind("blur",function(){e.emailWarning=!(e.user&&e.user.email)})}};function e(d,r){var e="maxlength",a=S("Messaging application is not subscribed."),c={NEWUSERNAME:{type:"validation",text:S('Username "new" is not allowed.')},PATTERN:{type:"pattern",text:S("Invalid pattern.")},PATTERN_PASSWORD:{type:"pattern",text:y.getString(h.validation.password.message)},PATTERN_USERNAME:{type:"pattern",text:y.getString(h.validation.user.message)},PATTERN_DISPLAYNAME:{type:"pattern",text:y.getString(h.validation.loginAlias.message)},PATTERN_PHONE:{type:"pattern",text:y.getString(h.validation.phoneNumber.message)},SAME_AS_CURRENT_PASSWORD:{type:"same_as_current",text:S("New password can't be the same as current one.")},PASSWORD_MISSMATCH:{type:"password_missmatch",text:S("Password confirmation does not match.")},REQUIRED:{type:"required",text:S("This field is required.")},EMAIL:{type:"email",text:S("Invalid email address.")},PASSWORD_STRENGTH:{type:"password_strength",text:S("Password not good enough, password must be stronger (green).")},INTERNATIONAL_NUMBER_REQUIRED_PHONE:{type:"international_number_required",text:y.getString(h.validation.internationalPhoneNumber.message)},MAXLENGTH_FIRSTNAME:{type:e,text:"".concat(y.getString("Max length:")," 50")},MAXLENGTH_LASTNAME:{type:e,text:"".concat(y.getString("Max length:")," 50")},MAXLENGTH_USERNAME:{type:e,text:"".concat(y.getString("Max length:")," 254")},MAXLENGTH_DISPLAYNAME:{type:e,text:"".concat(y.getString("Max length:")," 254")},MAXLENGTH_PHONE:{type:e,text:"".concat(y.getString("Max length:")," 254")},MAXLENGTH_EMAIL:{type:e,text:"".concat(y.getString("Max length:")," 254")}},i=this;_.assign(d,{confirmPassword:"",invalid:angular.bind(o,o.invalid,d.forms,"userForm"),isInvalidConfirmPassword:function(){var e=d.forms.userForm,t=e.password.$pristine,r=e.confirmPassword.$invalid;return!t&&r},changePasswordConfirm:function(){d.forms.userForm.confirmPassword&&d.forms.userForm.confirmPassword.$setValidity(c.PASSWORD_MISSMATCH.type,d.forms.userForm.confirmPassword.$viewValue===d.user.password)},getErrorFeedback:function(s){var o=d.forms.userForm[s]||{},i=[];return _.forEach(o.$error||{},function(e,t){if("parse"!==t){var r=t.toUpperCase(),n="".concat(r,"_").concat(s.toUpperCase());if(e&&o.$touched){var a=c[n]||c[r];i.push(y.getString(a.text))}}else d.forms.userForm.phone.$setValidity(t,!0)}),i.join(" ")},getUserCustomProperties:function(e){var r={};e&&e.customProperties&&_.forEach(e.customProperties,function(e,t){"userOrigin"!==t&&(r[t]="object"===_typeof(e)?angular.toJson(e):e)});return r},humanize:o.humanizeFragment,passwordRegex:h.validation.password.pattern,resetPasswords:function(e){var r=y.getString("A user managed via your authorization server cannot change the password of the user.");u.current().then(function(e){var t=u.hasExternalOrigin(e);d.password.showPassword&&t&&A.add({text:r,type:"warning"})}),d.password.showPassword=!d.password.showPassword,e.passwordStrength=d.password.strength,e.password=null,d.confirmPassword=""},tfaAvailable:!1,delegateTo:function(){u.current().then(function(e){d.user.delegatedBy=e.id}),s()},undelegate:function(){d.user.delegatedBy=null,s()},setOwner:function(e){d.user.owner=e,i.isParentDropDownOpen=!1,i.ownerHiddenForm.$setDirty()},userCanChangePasswordAndEmail:!1}),_.assign(i,{onToggleDropdown:function(e){e&&(i.ownerDropDownInitialized=!0)},twoFactorAuthenticationCheckboxDisabled:function(){return d.topLevelTfaEnforced||d.disabledEdit||"TOTP"===i.tfaStrategy||!d.smsMicroserviceAvailable||!d.notCurrentUser&&"SMS"===i.tfaStrategy},enforceTfaCheckboxDisbaled:function(){return d.topLevelTfaEnforced||d.disabledEdit||!d.notCurrentUser},messagingWarningVisible:function(){return!d.smsMicroserviceAvailable&&"SMS"===i.tfaStrategy}}),f.getStrongPasswordSettings().then(t);var n=d.$watch("user",function(e,t){e&&e!==t&&(function(n){var o=!n.id;d.password.strength=n.passwordStrength,d.changePasswordBtn=!d.password.showPassword,d.emailWarning=!n.email,d.smsWarningPopover=a,o&&(n.sendPasswordResetEmail=!0);delete d.confirmPassword,d.notCurrentUser=null,function(e){var t=/.*/;e&&!e.id&&(t=h.validation.user.pattern),d.userNamePattern=t,d.loginAliasPattern=h.validation.loginAlias.pattern}(n),d.hideLanguage||l.get("language").then(function(e){e&&(d.user.language={name:w.getLanguageNativeName(e),code:e}),d.languages=_.map(p.getSupportedLanguages(),function(e){return Object.assign({name:w.getLanguageNativeName(e),code:e},{})})}),E.isActivatedFor("units-conversion")&&(d.unitsConversionActive=!0);r.all({tfaAvailable:u.isTfaAvailable(),smsMicroserviceAvailable:m.isAvailable({contextPath:"messaging"}),twoFactorAuthenticationEnabled:u.isTfaActive(n),tfaStrategy:u.getTfaStrategy(),isCurrentUser:u.checkIfCurrent(n)}).then(function(e){var t=e.tfaAvailable,r=e.smsMicroserviceAvailable,n=e.twoFactorAuthenticationEnabled,a=e.tfaStrategy,s=e.isCurrentUser;d.notCurrentUser=!s,d.tfaAvailable=t,d.smsMicroserviceAvailable=!!r,i.tfaStrategy=a,d.user.twoFactorAuthenticationEnabled=!o&&n,d.userCanChangePasswordAndEmail=o||!u.hasExternalOrigin(d.user)}),d.hideOwner||(d.ownerEditDisabled=!1,u.current().then(function(e){var t=g.hasRole(e,"ROLE_USER_MANAGEMENT_ADMIN"),r=g.hasRole(e,"ROLE_USER_MANAGEMENT_CREATE");!t&&r&&(i.rootOwner=[e],i.currentOwner=e.id,i.defaultOwner=e,o&&(d.ownerEditDisabled=!0,n.owner=i.currentOwner))}))}(e),n())});function t(e){var t=e.enforceStrength,r=e.strengthValidity,n=t||r;(d.passwordStrengthEnforced=n)&&d.$watch("user.passwordStrength",function(e){e&&d.password.showPassword&&d.forms.userForm.password.$setValidity(c.PASSWORD_STRENGTH.type,function(e){return"GREEN"===e}(d.user.passwordStrength))})}function s(){d.delegationHiddenForm.$setDirty()}d.$watch("user.password",function(){d.forms.userForm&&d.forms.userForm.password&&d.forms.userForm.password.$setValidity(c.SAME_AS_CURRENT_PASSWORD.type,!d.notCurrentUser&&!u.isCurrentPassword(d.user.password)||d.notCurrentUser)})}}e.$inject=["c8yBase","c8yUser","c8yUserPreferences","c8yPermissions","c8yLoginOptions","c8yLocales","c8yApplication","LocalesUtil","c8yConfig","c8yBeta","c8yAlert","gettext","gettextCatalog"],angular.module("c8y.ui").directive("c8yEditUser",e).directive("c8yUiEditUser",e)}();