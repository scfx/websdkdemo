"use strict";!function(){var o;function e(e){o={},e.register("lastMeasurement",t,{configTemplateUrl:":::PLUGIN_PATH:::/ui/properties/lastMeasurementConfig.html"})}function t(e,a){var t=e||{},r=_.isArray(t.dp)?_.find(t.dp,"__active")||_.last(t.dp):{},n=t.target||r.__target,i=t.fragment||r.fragment,c=t.series||r.series,s=t.resultType||a.RESULT_TYPES.VALUE.value;return u.detach=function(e){var t=_.get(o,e.id);if(t){var a=t.detach(e);a&&delete o[e.id]}},u;function u(e){o[e.id]=o[e.id]||new a.Updater(e);var t=o[e.id];return t.attach(e),t.resultType=s,t.get(i,c,n)}}function a(e,d,n,t,c){var s=e.createEnum([{name:"VALUE",value:1,label:t("Only value")},{name:"VALUE_UNIT",value:2,label:t("Value and unit")},{name:"VALUE_UNIT_TIME",value:3,label:t("Value, unit and time")},{name:"OBJECT",value:4,label:t("Complete object")}]);function a(e){var t=this;t.device=e,t.cache={},t.devices=new Set,t.attach(e),t.latestPromises=[]}return a.prototype.attach=function(e){var t=this.devices;t.has(e)||t.add(e)},a.prototype.detach=function(e){var t=this.devices;return t.delete(e),!t.size&&(_.forEach(this.latestPromises,function(e){return e.stop()}),!0)},a.prototype.lastMeasurementFilter=function(e,t,a){var r=this;return{device:n.isProbablyDevice(r.device)?r.device.id:_.get(a,"id",r.device.id),fragment:e,series:t}},a.prototype.format=function(e,t){var a=e.value,r=e.unit,n=t.time,i="";switch(this.resultType||s.VALUE.value){case s.VALUE.value:i=a;break;case s.VALUE_UNIT.value:i=a+(r||"");break;case s.VALUE_UNIT_TIME.value:i="".concat(c("absoluteDateShort")(n)," | ").concat(a+(r||""));break;case s.OBJECT.value:default:i=e}return i},a.prototype.get=function(e,t,a){var r=this,n=this,i="".concat(e,".").concat(t),c="loading".concat(i),s="";if(!n.cache[i]&&!n[c]){n[c]=!0;var u=d.latest(n.lastMeasurementFilter(e,t,a),!0);this.latestPromises.push(u),u.then(function(e){r.cache[i]=e}).finally(function(){return delete r[c]})}var o=_.get(n.cache,i,{}),l=_.get(o,"".concat(e,".").concat(t));return l&&(s=n.format(l,o)),s},{RESULT_TYPES:s,Updater:a}}t.$inject=["config","lastMeasurementComputedProperty"],a.$inject=["c8yBase","c8yMeasurements","c8yDevices","gettext","$filter"],e.$inject=["c8yComputedPropertiesProvider"],angular.module("c8y.ui").config(e).factory("lastMeasurementComputedProperty",a)}();