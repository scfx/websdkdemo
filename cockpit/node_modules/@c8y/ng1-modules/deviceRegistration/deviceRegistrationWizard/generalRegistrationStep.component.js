"use strict";!function(){function e(t,e,n,i,a,r,s,o,c){var d,l=this;function u(e){_.assign(l.wizardCtrl.data,{multipleResults:e})}function g(){c.disableInteractionWhenRequestInProgress(l,!1),l.wizardCtrl.goTo("multiple-finish"),c.doResize()}function v(e){var t=_.get(e,"tenantId");return t&&r.isTopTenant(t)}_.assign(l,{newDeviceRegistrations:[{}],$onInit:function(){t.all({user:e.current(),topTenant:r.isCurrentUserTopTenant(),tenantsRead:s.hasAnyRole(["ROLE_TENANT_MANAGEMENT_READ"])}).then(function(e){e.topTenant&&e.tenantsRead&&(d=e.user.tenant,l.showTenantField=!0,l.newDeviceRegistrations[0].tenantId=d,r.list().then(function(e){l.tenants=e}))}),s.hasAnyRole(["ROLE_INVENTORY_READ"]).then(function(e){l.canReadInventory=e})},$doCheck:function(){var e=_.get(l,"wizardCtrl.data.retry");e&&(l.newDeviceRegistrations=e.devices,_.unset(l,"wizardCtrl.data.retry"))},deviceIdPattern:a.validation.deviceId.pattern,validation:a.validation,onClickRegisterDevices:function(e){return c.setFormData(l.wizardCtrl.data,{devices:e}),c.disableInteractionWhenRequestInProgress(l,!0),t.all(_.map(e,function(t){return n.create(t,{silentError:!0}).then(function(e){return{device:t,status:"SUCCESS",details:o.getResData(e)}}).catch(function(e){return{device:t,status:"FAILED",details:o.getResData(e)}})})).then(u).finally(g)},addNewDevice:function(){var e={};r.isTopTenant(d)&&_.set(e,"tenantId",d);0<l.newDeviceRegistrations.length&&_.set(e,"groupId",_.get(_.last(l.newDeviceRegistrations),"groupId"));l.newDeviceRegistrations.push(e),c.doResize()},removeNewDevice:function(e){l.newDeviceRegistrations.splice(e,1),c.doResize()},isTopTenantSelected:v,validateDeviceId:function(e,t){var n=_.clone(l.newDeviceRegistrations),i=_.uniqBy(n,"id").length!==l.newDeviceRegistrations.length,a=l["newDeviceRegistrationForm".concat(t)].id;a.$setTouched(!0),a.$setValidity("deviceIdAlreadyUsed",!0),i&&function(e,t){return 1<_.filter(e,{id:t}).length}(n,e)&&a.$setValidity("deviceIdAlreadyUsed",!1)},getIdFieldForForm:function(e){return l["newDeviceRegistrationForm".concat(e)].id},isAnyFormInvalid:function(){for(var e=l.newDeviceRegistrations.length,t=!1,n=0;n<e;n++)t=l["newDeviceRegistrationForm".concat(n)].$invalid||t;return t},resetGroup:function(e){v(e.tenantId)||_.unset(e,"groupId")}})}e.$inject=["$q","c8yUser","c8yDeviceRegistration","c8yAlert","c8yConfig","c8yTenant","c8yPermissions","c8yBase","deviceRegistrationWizardUtils"],angular.module("c8y.deviceRegistration").component("generalRegistrationStep",{controllerAs:"vm",controller:e,require:{wizardCtrl:"^c8yWizardStep"},bindings:{backStep:"@?"},templateUrl:":::PLUGIN_PATH:::/deviceRegistrationWizard/generalRegistrationStep.html"})}();