"use strict";!function(){function e(n,e,t,i,c,s,a,o,u,r,l,d){var g=this;function f(){a.getLimitStatus().then(function(e){g.limitStatus=e})}function p(e){g.newDeviceRequests||(g.newDeviceRequests=[]);var t=function(e,t){var n=[];return e.forEach(function(e){_.includes(t,e.id)||"c8y_DataBroker"===e.type||n.push(e)}),g.newDeviceRequests.concat(n)}(e,_.map(g.newDeviceRequests,"id"));g.newDeviceRequests=function(e){return _.sortBy(e,[function(e){var t=e.status;return t===a.status.PENDING_ACCEPTANCE?0:1},"-creationTime"])}(t),n.paging=e.paging}function v(){n.paging.loading=!0,n.paging.next().then(p).finally(function(){n.paging.loading=!1})}function D(){g.newDeviceRequests=null,g.refreshLoading=!0,n.paging.refresh().then(p).then(f).finally(function(){g.refreshLoading=!1}),n.paging=null}function h(e,t){g.newDeviceRequests.forEach(function(e){e.id===t.id&&(e.status=t.status,u.success(l("New device connected.")))})}function w(e){_.set(e,"status",a.status.ACCEPTED)}function y(e){r.changeTitle({title:l("Device registration"),subtitle:d.getPlural(e,"1 new device","{{$count}} new devices",{})})}function R(e){g.isBulk=e,g.registerType=e?"Bulk":"Single"}function m(e){return e.status===a.status.PENDING_ACCEPTANCE}_.assign(g,{$onInit:function(){n.refresh=D,n.loadNext=v,R(!1),n.$watch("vm.newDeviceRequests.length",y),t.isCurrentUserTopTenant().then(function(e){g.isTopTenant=e}),f(),g.newDevice?g.newDevice.id=null:g.newDevice={id:null},function(e){a.list(e).then(p)}({pageSize:1e3}),o.addListener(n.$id,"/bootstrap",o.realtimeActions().UPDATE,h),o.start(n.$id,"/bootstrap"),n.$on("$destroy",function(){o.stop(n.$id,"/bootstrap")}),y()},setBulk:R,statusIcon:a.statusIcon,statusClass:a.statusClass,newDeviceRequestsStatus:a.status,onClickAccept:function(e){a.accept(e).then(function(){w(e),u.success(l("Device registration accepted."))}).then(f)},onClickCancel:function(e){c({title:l("Cancel device registration"),body:d.getString('You are about to cancel device registration for ID "{{id}}". Do you want to proceed?',e),labels:{ok:l("Cancel registration"),cancel:l("Close")},status:"danger",size:"sm"}).then(function(){return a.cancel(e)}).then(function(){!function(e){_.remove(g.newDeviceRequests,e)}(e),u.success(l("Device registration cancelled."))}).then(f)},addWithWizard:function(){return s.open({component:"deviceRegistrationWizard",backdrop:"static",keyboard:!1}).result.then(D)},canAcceptAll:function(){return _.some(g.newDeviceRequests,m)},acceptAll:function(){return a.acceptAll().then(function(e){_(e.acceptedDeviceRequests).map("id").map(function(e){return _.find(g.newDeviceRequests,{id:e})}).forEach(w),e.failedDeviceRequests.length?u.warning(l("Could not accept all pending registration requests."),e):u.success(l("Accepted all pending registration requests."))})}})}e.$inject=["$scope","$timeout","c8yTenant","c8yBase","c8yModal","c8yWizardModal","c8yDeviceRegistration","c8yRealtime","c8yAlert","c8yTitle","gettext","gettextCatalog"],angular.module("c8y.deviceRegistration").component("c8yDeviceRegistration",{templateUrl:":::PLUGIN_PATH:::/deviceRegistration.html",controller:e,controllerAs:"vm"})}();