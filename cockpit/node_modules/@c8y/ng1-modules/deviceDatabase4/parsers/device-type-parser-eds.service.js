"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,a,i=[],o=!0,u=!1;try{for(r=r.call(e);!(o=(n=r.next()).done)&&(i.push(n.value),!t||i.length!==t);o=!0);}catch(e){u=!0,a=e}finally{try{o||null==r.return||r.return()}finally{if(u)throw a}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}!function(){function e(a,e,t,u,r,i,s){return{doesSupportFile:function(e){return/\.eds$/.test(e.name)},parseFile:function(n){return a(function(r,t){var e=new FileReader;e.onload=function(e){var t=e.target;return r(t.result)},e.onerror=function(e){return t({feedback:{type:"error",summary:i("Could not read file."),details:e}})},e.readAsText(n)}).then(o).then(function(e){return _.defaults(e.deviceType,{name:n.name.replace(/\.eds$/,"")}),e})},parseString:o,parseObject:n};function o(e){var t;try{t=a.resolve(r.parse(e))}catch(e){t=a.reject({feedback:{type:"error",summary:i("Could not parse EDS content."),details:[{type:"error",text:e.toString()}]}})}return t.then(n)}function n(e){var t=function(e){return _.transform(e,function(e,t,r){e[function(e){var t=_slicedToArray(_.toString(e).match(/^([0-9A-Fa-f]+)(sub([0-9A-Fa-f]+)){0,1}$/)||[],4),r=t[1],n=t[3];if(_.isUndefined(r)&&_.isUndefined(n))return e;return"".concat(c(r)).concat(_.isUndefined(n)?"":"sub".concat(c(n)))}(r)]=function(e,t){var r=_slicedToArray(_.toString(t).match(/^([0-9A-Fa-f]+)(sub([0-9A-Fa-f]+)){0,1}$/)||[],4),n=r[1],a=r[3];return _.defaults(_.mapValues(e,function(e){return function(e){return/^0x[0-9A-Fa-f]+$/.test(e)}(e)?c(e):_.isNaN(_.toNumber(e))?e:_.toNumber(e)}),{id:t,Index:_.isUndefined(n)?void 0:c(n),SubIndex:_.isUndefined(a)?void 0:c(a)})}(t,r)},{})}(e),r={},n={details:[]};return function(e,t){t.name=function(e){var t=_.compact([_.get(e,"DeviceInfo.VendorName"),_.get(e,"DeviceInfo.ProductName"),_.get(e,"DeviceInfo.RevisionNumber")]);return 0<t.length?t.join("_"):void 0}(e)}(t,r),function(e,t){t.fieldbusType="canopen"}(0,r),function(e,t,r){t.deviceType=function(e){return _.get(e,[c("1000"),"DefaultValue"])}(e),t.deviceType||r.details.push({type:"warning",text:i("[DeviceType] - not found")})}(t,r,n),function(t,e,r){var n=function(e){return _(e).filter({ObjectType:7}).reject({SubIndex:0}).value()}(t),a=u.getDeviceTypeFeatures(e),i=[];_.forEach(n,function(e){return function(e,t,r,n,a){var i=a.holdingRegisters.dataType.choices.values(),o=a.holdingRegisters.accessType.choices.values(),u=_.omitBy({category:e.SubIndex?r[e.Index].ParameterName:void 0,name:e.ParameterName?"".concat(e.ParameterName," (").concat(d(e.Index),")"):void 0,index:e.Index,subIndex:e.SubIndex,dataType:function(e,t){var r=_.find(t,{edsValue:e.DataType});return _.get(r,"value")}(e,i),accessType:function(e,t){var r=_.find(t,{value:e.AccessType});return _.get(r,"value")}(e,o),min:e.LowLimit,max:e.HighLimit},_.isUndefined),c=!0;_.isUndefined(u.name)&&(c=!1,n.details.push({type:"warning",text:s.getString("[{{id}}] - missing ParameterName",e)}));_.isUndefined(u.dataType)&&(c=!1,n.details.push({type:"warning",text:s.getString("[{{id}}] - missing, invalid or unsupported DataType",e)}));_.isUndefined(u.accessType)&&(c=!1,n.details.push({type:"warning",text:s.getString("[{{id}}] - missing, invalid or unsupported AccessType",e)}));c&&(t.push(u),n.details.push({type:"info",text:s.getString("[{{id}}] - added as variable",e)}))}(e,i,t,r,a)});var o=_.sortBy(i,["index","subIndex"]);(function(e,t){var r=[];_.forEach(e,function(e){return function e(t,r,n,a){var i=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1;if(_.includes(n,t.name)){var o=i+1;t.name="".concat(r," (").concat(o,")"),e(t,r,n,a,o)}else n.push(t.name),1<i&&a.details.push({type:"info",text:s.getString('Duplicate ParameterName "{{name}}" for object [{{id}}] renamed to "{{register.name}}".',{name:r,id:(u=t,"".concat(d(u.index)).concat(u.subIndex?"sub".concat(d(u.subIndex)):"")),register:t})});var u}(e,e.name,r,t)})})(o,r),e.c8y_Registers=o}(t,r,n),_.filter(n.details,{type:"error"}).length?(n.type="error",n.summary=i("EDS parsed with errors."),a.reject({feedback:n})):(_.filter(n.details,{type:"warning"}).length?(n.type="warning",n.summary=i("EDS parsed with warnings.")):(n.type="success",n.summary=i("EDS parsed successfully.")),a.resolve({deviceType:_.omitBy(r,_.isUndefined),feedback:n}))}function d(e){return _.toNumber(e).toString(16)}function c(e){return parseInt(_.toString(e).replace(/^0x/,""),16)}}e.$inject=["$q","$rootScope","c8yDeviceTypeParser","c8yDeviceDatabase","ini","gettext","gettextCatalog"],angular.module("c8y.deviceDatabase4").factory("c8yDeviceTypeParserEDS",e)}();