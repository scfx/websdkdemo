"use strict";!function(){function t(i,r,n,u,a,c){function s(t){return _.map(t.matchKpi,function(t){return t.c8y_Kpi})}function o(t){o.cache[t]=o.cache[t]||n.listKpiForDevice(t).then(s);var e=o.cache[t];return e=e.catch(function(t){var e=t.data||{},n=c.getString(e.message);return a.add({type:"danger",text:n,detailedData:t}),i.reject(t)})}function f(t){var e=t.values,n=_.map(t.series,function(t){return t.fragment=t.type,t.values=[],t.timelist=[],t.dataPoints=[],t}),r=[];return _.forEach(e,function(i,t){var a=moment(t).toDate();r.push(a),_.forEach(n,function(t,e){var n=i[e];!_.isObjectLike(n)||_.isUndefined(n.min)||_.isUndefined(n.max)||(t.values.push(n),t.timelist.push(a),t.dataPoints.push({val:n,time:a}))})}),n=_.filter(n,function(t){return t.values.length}),(n=_.map(n,m)).truncated=t.truncated||!1,n}function m(t){return _.assign(t,{getNearIndex:function(t){return function(t,e){var n=e,i=t.timelist,a=d3.bisect(i,n,1,i.length-1),r=i[a-1],u=i[a],c=a;return _.isUndefined(r)||(_.isUndefined(u)?c=a-1:n-r<u-n&&(c=a-1)),c}(this,t)}})}function d(t,e,n){return _.find(n,{fragment:t,series:e})}return o.cache={},{getKpi:o,getSeries:function(t,c,e,n,i){var a={source:t,dateFrom:e?moment(e).format(u.dateFullFormat):e,dateTo:n?moment(n).format(u.dateFullFormat):n,aggregationType:"NONE"!==i?i:void 0};return r.listSeries(a).then(f).then(function(t){var e=_.isString(c),n=_.isArray(c),i=t.truncated,a=t;if(e){var r=c;a=_.filter(t,{type:r})}else if(n){var u=c;a=_.filter(t,function(t){return _.find(u,{fragment:t.fragment,series:t.name})}),_.forEach(a,function(t){t.kpi=d(t.type,t.name,u)})}return a.truncated=i,a})},getMaxTimeFromSeries:function(t){return d3.max(_.flattenDeep(_.map(t,"timelist")))},getKpiOfSerie:function(t,e){return d(t.fragment,t.name,e)},appendMeasurement:function(t,e,n){var r=_.isString(t),u=r?[t]:_.uniq(_.map(n,"fragment")),c=!1,s=_.isArray(e)?e:[e];return _.forEach(s,function(t){var i=moment(t.time).toDate(),a=_.flattenDeep(_.map(u,function(t){return function(c,t){var s=_.reduce(t,function(n,t){return _.forEach(t[c],function(t,e){n[e]||(n[e]={unit:t.unit}),n[e].unit||(n[e].unit=t.unit)}),n},{}),e=_.keys(s),o=[],n=[];return _.forEach(t,function(t){var r=t[c],u=moment(t.time).toDate();_.forEach(e,function(t,e){o[e]=o[e]||{fragment:c,name:t,unit:s[t].unit,values:[],timelist:[],dataPoints:[]};var n=o[e];if(r[t]){var i=r[t].value,a={min:i,max:i};n.values.push(a),n.timelist.push(u),n.dataPoints.push({time:u,val:a})}}),n.push(u)}),{timeList:n,series:o}}(t,s).series}));c=c||a.length,_.forEach(n,function(t){var e=_.find(a,{fragment:t.fragment,name:t.name});if(e){var n=d3.bisect(t.timelist,i);t.timelist.splice(n,0,i),t.values.splice(n,0,_.head(e.values)),t.dataPoints.splice(n,0,_.head(e.dataPoints)),e.found=!0}}),r&&_.forEach(_.filter(a,function(t){return!t.found}),function(t){n.push(t)})}),{hasNew:c,series:n}},getDOMId:function(t,e){var n=[t.kpi&&t.kpi.__target?"target".concat(t.kpi.__target.id):"",t.fragment,e,t.name].join("");return"id".concat(window.btoa(n).replace(/[/=]/gi,"_"))}}}t.$inject=["$q","c8yMeasurements","c8yKpi","c8yBase","c8yAlert","gettextCatalog"],angular.module("c8y.core.measurements2").service("c8yLineChartSvc",t)}();