"use strict";!function(){function e(l,u,t,s,d,e,n){var o,f,a,c={},i=[],r=!1,g=[{value:"NONE",name:e("No aggregation")},{value:"MINUTELY",name:e("Minutely"),disabledWhenLessThan:{qty:1,unit:"minutes"}},{value:"HOURLY",name:e("Hourly"),disabledWhenLessThan:{qty:1,unit:"hours"}},{value:"DAILY",name:e("Daily"),disabledWhenLessThan:{qty:1,unit:"days"}}],m=[{minDuration:moment.duration(1,"months"),maxDuration:null,aggregationType:"DAILY"},{minDuration:moment.duration(1,"days"),maxDuration:moment.duration(1,"months"),aggregationType:"HOURLY"},{minDuration:moment.duration(1,"minutes"),maxDuration:moment.duration(1,"days"),aggregationType:"MINUTELY"},{minDuration:null,maxDuration:moment.duration(1,"minutes"),aggregationType:"NONE"}],p=!1,y=n(function(){if(!p){var e=moment(l.filter.dateTo).diff(l.filter.dateFrom);l.filter.dateTo=new Date,l.filter.dateFrom=moment().subtract(e).toDate(),l.$broadcast("newData")}});function T(){l.filter.dateFrom&&l.filter.dateTo&&l.filter.aggregationType&&v()}function h(e){l.series=e,i.length&&t(function(){$(_.flattenDeep(i)),i.length=0}),D()}function D(){l.loading=!1}function v(){var n=c.dateFrom,a=c.dateTo,i=c.aggregationType.value,e=l.deviceId,o=l.frag,t=l.selectedKpis,r=l.datapoints;if(l.title=d.humanizeFragment(o||""),n&&a&&(e||r)&&(o||t||r))if(l.loading=!0,r){var g=_.groupBy(r,function(e){return e.__target.id});u.all(_.map(g,function(e,t){return s.getSeries(t,e,n,a,e.aggregation||i)})).then(function(e){return f||(f=l.$watch("datapoints",v,!0)),h(_.flattenDeep(e))}).finally(D)}else t?s.getSeries(e,t,n,a,i).then(h).finally(D):o&&s.getKpi(e).then(function(t){s.getSeries(e,o,n,a,i).then(function(e){return l.truncated=e.truncated,_.map(e,function(e){return e.kpi=s.getKpiOfSerie(e,t),e})}).then(h)}).finally(D)}function $(e){!l.loading&&l.series&&l.series.length?s.appendMeasurement(l.frag||l.kpis,e,l.series).hasNew&&t(_.bind(l.$broadcast,l,"newData")):(!l.series||l.series.length||l.loading||(l.$broadcast("updateInterval"),t(v)),i.push(e))}function L(){return!!(l.filter&&l.filter.dateFrom&&l.filter.dateTo&&l.filter.aggregationType&&(l.deviceId||l.datapoints)&&(l.selectedKpis||l.frag||l.datapoints))}function b(e){l.filter.aggregationType=_.find(g,{value:e})||g[0],l.aggregationTypeDescription=l.filter.aggregationType.name.toLowerCase()}function w(){var t,n,e=moment(l.filter.dateFrom),a=moment(l.filter.dateTo),i=moment.duration(a.diff(e));l.autoAggregationOff||r||!o||o.asMilliseconds()===i.asMilliseconds()||_.forEach(m,function(e){t=!e.minDuration||e.minDuration&&e.minDuration.asMilliseconds()<=i.asMilliseconds(),n=!e.maxDuration||e.maxDuration&&e.maxDuration.asMilliseconds()>i.asMilliseconds(),t&&n&&b(e.aggregationType)}),o=i}l.onDatepickerOpen=function(e){e?t(function(){p=!0},50):p=!1},l.filter=c,l.aggregationTypes=g,l.onAggregationTypeChangedManually=function(e){l.filter.aggregationType=_.find(g,{value:e})||g[0],r=!0,T()},l.isAggregationTypeEnabled=function(e){if(e.disabledWhenLessThan){var t=e.disabledWhenLessThan;return!(moment(l.dateTo).diff(l.dateFrom,t.unit)<t.qty)}return!0},l.getData=v,l.onData=$,l.$watch("realtimeState",function(e){e&&L()?(l.$broadcast("updateInterval"),t(T),y.start()):y.cancel()}),l.$watch("aggregationType",b),l.$watch("filter.dateFrom",w),l.$watch("filter.dateTo",w),l.$watch("filter.aggregationType",function(){l.aggregationType=l.filter.aggregationType.value,l.selectedAggregationTypeValue=l.filter.aggregationType.value}),l.$on("connect",function(e,t){125<t.fromLastConnect&&v()}),l.$on("changeFilters",function(){l.dateFrom=l.filter.dateFrom,l.dateTo=l.filter.dateTo,l.aggregationType=l.filter.aggregationType.value,l.interval=l.filter.interval}),l.$on("$destroy",y.cancel),a=l.$watch(L,function(e){e&&(T(),l.$on("search",T),a())})}e.$inject=["$scope","$q","$timeout","c8yLineChartSvc","c8yBase","gettext","RTAutoMove"],angular.module("c8y.core.measurements2").controller("c8yLineChartCtrl",e)}();