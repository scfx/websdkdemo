"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,o=[],a=!0,s=!1;try{for(n=n.call(e);!(a=(i=n.next()).done)&&(o.push(i.value),!t||o.length!==t);a=!0);}catch(e){s=!0,r=e}finally{try{a||null==n.return||n.return()}finally{if(s)throw r}}return o}}function _arrayWithHoles(e){if(Array.isArray(e))return e}!function(){function e(h,l,e,c,t,n,i,r,u,o){var d,m=r,f=t,a=n,v=i,s=[{val:"min",text:o("Minimum")},{val:"max",text:o("Maximum")},{val:"area",text:o("Minimum and maximum")}],p=[{val:"line",text:o("Line")},{val:"points",text:o("Points")},{val:"linePoints",text:o("Line and points")},{val:"bars",text:o("Bars")},{val:"step-before",text:o("Step before")},{val:"step-after",text:o("Step after")}],g=[{val:void 0,text:o("Auto")},{val:"left",text:o("Left")},{val:"right",text:o("Right")}];function y(e,t){var n,i=this,r=$(e),o=r.find(".chart-container").length,a=function(){n||(n=setTimeout(function(){n=void 0,i._render()},300))},s=function e(){return e.result||(e.result=i._dimensions()),e.timerId||(e.timerId=setTimeout(function(){delete e.result,delete e.timerId},700)),e.result};i._hasContainer=o,i.el=o?r.find(".chart-container"):r,i.parentEl=i.el.parent(),i.items=[],i.dimensions=s,i.render=function(){return a()},d&&(i.dimensions=function(){return d.runOutsideAngular(s)},i.render=function(){return d.runOutsideAngular(function(){return a()})}),i.init(t)}return d3.selection.prototype.dblTap=function(n){var i=0;return this.each(function(){d3.select(this).on("touchstart",function(e){var t=function(){};return d3.event.timeStamp-i<500?(d3.event.preventDefault(),d3.event.stopPropagation(),t=n):i=d3.event.timeStamp,t(e)})})},e.has("ngZone")&&(d=e.get("ngZone")),y.prototype={sizes:{yAxisWidth:50},margins:{t:20,r:10,b:20,l:10},init:function(e){var t=this,n=t.parentEl,i=t.el,r=t._hasContainer?"25px":0,o=t._hasContainer?{position:"absolute",top:0,right:0,bottom:0,left:0}:{position:"relative"},a=i.parents(".panel-body"),s=i.parents(".grid-stack-item-content").length;if(a.length&&!s&&a.height("320px"),n.css(o),t._hasContainer){var l=n.parent().css("position");"absolute"!==l&&"fixed"!==l&&n.parent().css({position:"relative"})}i.addClass("c8y-chart"),i.css({display:"block",position:"absolute",top:e.showTime?"55px":r,right:0,bottom:"5px",left:0}),t._id=String(Math.random()).substr(2),t.svg=t.createSvg(),t.hoverBox(),t.svgSeries=t.createSeriesContainer(),t.axisX=new v(t),t.series=[],t.allowSelectPoint=e.allowSelectPoint,t.hoverInfo=new m(t),t.hoverItems=t.renderVerticalLine().concat([t.hoverInfo.el]),t.addEvents()},destroy:function(){this.hoverInfo.destroy()},renderVerticalLine:function(){var r=this,e=r.overline,t=r.selectLine,n=r.box().height-r.margins.t-r.margins.b,i=function(e,t,n,i){return r.svg.append("g").attr("transform",u.translate(r.margins.l,r.margins.t)).append("line").style({visibility:"hidden",stroke:e,"stroke-dasharray":t,opacity:i,"pointer-events":"none"}).attr({class:n})};e||(r.overline=i("#999999","3,3","overline",.5),e=r.overline),t||(r.selectLine=i("#333333",void 0,"selectline",0),t=r.selectLine);var o=[e,t];return _.forEach(o,function(e){e.attr({y1:0,y2:n})}),o},createSeriesContainer:function(){var e=this,t=e.svg,n=e.margins,i=e.box(),r=i.height-n.b-n.t;return e._clipPath=t.append("defs").append("svg:clipPath").attr({id:"clipmask".concat(e._id)}).append("svg:rect").attr({id:"clip-rect".concat(e._id),x:n.l,y:n.t,width:i.axisXwidth,height:0<r?r:0}),t.append("g").style({"z-index":10}).attr({class:"seriesContainer","clip-path":"url(#clipmask".concat(e._id,")")})},hoverBox:function(){var e=this,t=e.box(),n=e._hoverBox,i=t.height-e.margins.b-e.margins.t;return n||(e._hoverBox=e.svg.append("rect").style({fill:"transparent",opacity:.3,"z-index":void 0,"pointer-events":"all"}),n=e._hoverBox),n.attr({width:t.axisXwidth,height:0<i?i:0,transform:u.translate(t.leftSpace,e.margins.t)}),n},selectionBox:function(e){var t=this,n=t.box(),i=t._selBox,r=n.height-t.margins.b-t.margins.t,o=t._mouseSelectStart;if(r=0<r?r:0,i||(t._selBox=t.svg.append("rect").attr({"pointer-events":"none",fill:"rgba(200,200,200, 0.5)"}),i=t._selBox),o&&e){var a=_slicedToArray(o,1)[0],s=e[0]-n.leftSpace,l=a<s?a:s,c=s<a?a:s;i.attr({transform:u.translate(n.leftSpace+l,t.margins.t),height:r,width:c-l}).style({visibility:"visible"})}else i.style({visibility:"hidden"})},realtimeMeasurement:function(n){var i=!1;return _.forEach(this.series,function(e){var t=e.realtimeMeasurement(n);i=i||t}),i},getHoverItems:function(){var t=_.clone(this.hoverItems);return _.forEach(this.series,function(e){t=_.union(t,e.hoverItems)}),t},showHoverItems:function(e){var t=this.getHoverItems();this.hoverItemsVisible=!0,t="nolines"===e?_.without(t,this.overline):_.without(t,this.selectLine),_.forEach(t,function(e){e.style&&e.style("visibility","visible"),e.show&&e.show()})},showHoverItemsExceptLine:function(){this.showHoverItems("nolines")},hideHoverItems:function(){this.hoverItemsVisible=!1,_.forEach(this.getHoverItems(),function(e){e.style&&e.style("visibility","hidden"),e.hide&&e.hide()})},addEvents:function(){var t=this,n=this.hoverBox();n.on("mouseenter",function(){t.mouseIn=!0,t.showHoverItems()}),n.on("mouseleave",function(){var e=d3.event.relatedTarget;e&&"circle"===e.tagName||(t.hideHoverItems(),t.resetSelectLine(),_.invokeMap(t.series,"mouseleave"),t.mouseIn=!1)});var e=d3.behavior.drag();function i(){var e=d3.mouse(n.node());t.zoomOut(e[0])}e.call(n),e.on("dragstart",function(){t._mouseSelectStart=d3.mouse(n.node())}),e.on("dragend",function(){var e=d3.mouse(n.node());t._mouseSelectStart&&e[0]!==t._mouseSelectStart[0]&&t.makeSelection(t._mouseSelectStart,e),t.selectionBox()}),e.on("drag",_.bind(t.onDragSelection,t)),n.on("mousemove",_.bind(t.onMove,t)),n.on("dblclick",i),n.dblTap(i),window.addEventListener("resize",function(){t.render(!0)})},zoomOut:function(e){var t=this.box(),n=this.margins,i=this.axisX,r=i.scale(),o=i._from,a=i._to,s=moment(r.invert(e+t.leftSpace-n.l)),l=Math.round(2*s.diff(o)),c=Math.round(2*moment(a).diff(s)),u=moment(new Date(Math.max(Date.now(),a)));u=moment.min(u,s.clone().add(c,"ms")),i.updateDates(s.clone().subtract(l,"ms"),u,!0),h.$apply()},moveToCenter:function(e){var t=this.axisX,n=t._from,i=t._to,r=moment(i).diff(n)/2,o=moment(e).subtract(r),a=moment(e).add(r);t.updateDates(o,a),this.render()},makeSelection:function(e,t){var n=this.axisX,i=this.box(),r=n.scale(),o=this.margins,a=moment(r.invert(e[0]+i.leftSpace-o.l)),s=moment(r.invert(t[0]+i.leftSpace-o.l)),l=a.isBefore(s)?a:s,c=l===a?s:a;n.updateDates(l,c,!0),h.$apply()},onDragSelection:function(){this._mouseSelectStart&&this.selectionBox([d3.event.x,d3.event.y])},onMove:function(e){var t,n=this,i=n.box(),r=n.hoverBox().node(),o=n.margins;try{t=d3.mouse(r),n.axisX._xDragStart&&n.axisX.updateScaleOnDrag(d3.mouse(r)[0])}catch(e){t=n.__cachedMouse||[0,0]}finally{n.__cachedMouse=t}var a=i.leftSpace+t[0]-o.l;n.overline.attr({transform:u.translate(1+a,0)}),n.currentHoverTime=n.axisX.scale().invert(a);var s=n.currentHoverTime;if(n._selectTime&&"moveToNow"===e)n.resetSelectLine();else{_.forEach(n.series,function(e){e.onMove(s,a)});var l=_slicedToArray(t,2)[1];_.forEach(n.items,function(e){e.onMove&&e.onMove(s,a,l)})}},setSelectTimeWithMouse:function(e){var t=this.axisX.scale().invert(e);return this.setSelectLine(t),t},setSelectPoint:function(e){var t=this;(t.selectedPoint=e).date?(t.setSelectLine(moment(e.date).toDate()),t.onSelectPoint&&t.onSelectPoint(t.selectedPoint)):t.clearSelectPoint()},clearSelectPoint:function(){var e=this;e.onSelectPoint&&e.selectedPoint&&e.selectedPoint.date&&(delete e.selectedPoint,e.onSelectPoint({})),e.clearSelectLine()},setSelectLine:function(t,e){var n=this,i=n.box(),r=n.axisX.scale(),o=n.selectLine,a=r(t),s=!(!n._selectTime||!moment(n._selectTime).isSame(t)),l=a<i.rangeMin||a>i.rangeMax;n._selectTime=t,l?s?n.hideSelectLine():n.moveToCenter(t):(o.attr({transform:u.translate(a,0)}),o.style("visibility","visible"),o.style("opacity",.5),!0!==e&&(n.showHoverItemsExceptLine(),setTimeout(function(){_.forEach(n.series,function(e){e.onMove(t,a)}),_.forEach(n.items,function(e){e.onMove&&e.onMove(t,a)})})))},clearSelectLine:function(){this.hideSelectLine(),delete this._selectTime},hideSelectLine:function(){var e=this.selectLine;"hidden"!==e.style("visibility")&&(e.style("visibility","hidden"),this.hideHoverItems())},resetSelectLine:function(){return!!this._selectTime&&(this.setSelectLine(this._selectTime),!0)},createSvg:function(){return d3.select(this.el[0]).append("svg").style({position:"absolute",top:0,right:0,bottom:0,left:0})},_dimensions:function(){return{h:this.el.height(),w:this.el.width()}},box:function(){var e=this,t=e.dimensions(),n=t.h,i=t.w,r=e.getAxisYByOrientation("left"),o=e.getAxisYByOrientation("right"),a=r.length*e.sizes.yAxisWidth||0,s=o.length*e.sizes.yAxisWidth||0,l=e.margins.r+s||0,c=e.margins.l+a||0,u=i-(c+l);return u<0&&(u=0),e.chartBox={height:0<n?n:0,width:0<i?i:0,axisXwidth:u,leftSpace:c,rightSpace:l,rangeMin:a,rangeMax:i-e.margins.l-l},e.chartBox},_render:function(){var e=this;e.updateYaxis();var t=e.box(),n=e.margins;e.renderVerticalLine(),e.selectionBox(),e.hoverBox(),e.axisX.render(),_.invokeMap(e.items,"render"),_.invokeMap(e.series,"render");var i=t.height-n.b-n.t;e._clipPath.attr({x:t.leftSpace,width:t.axisXwidth,height:0<i?i:0}),e.resetSelectLine()||e.onMove()},addItem:function(e){_.isObjectLike(e)&&-1===this.items.indexOf(e)&&this.items.push(e)},removeItem:function(e){this.items=_.without(this.items,e)},updateSeries:function(t,i){var r=this,o=r.axisX._to,a=r.axisX._from,s=r._aggregation,e=_.remove(r.series,function(e){return-1===t.indexOf(e.dataPoint)});_.invokeMap(e,"destroy");var n=_.map(t,function(t){var e;if(!_.find(r.series,function(e){return e.dataPoint===t})){var n=new f(r,t);r.series.push(n),i&&a&&o&&(e=n.loadDataAndRender(a,o,s))}return e}).filter(_.identity);return(n.length?l.all(n):c()).finally(function(){r.render()})},loadData:function(t,n,i){var r=this;return r._aggregation=i,r.loading=!0,l.all(_.map(r.series,function(e){return e.loadData(t,n,i)})).then(function(e){r.truncated=_.some(e,{truncated:!0})}).finally(function(){r.loading=!1,r.render(!0)})},scaleY:function(){var e=this.box().height-this.margins.t-this.margins.b,t=this.margins.t;return d3.scale.linear().range([e,t]).nice()},getAxisY:function(){return _.filter(this.items,function(e){return e instanceof n})},getAxisYByOrientation:function(t){return _.filter(this.items,function(e){return e instanceof n&&e.orientation()===t})},updateYaxis:function(){var n=this,e=n.series,i=[],r=n.getAxisY();_.forEach(r,function(e){e.series.length=0}),_.forEach(e,function(t){var e=_.find(i,function(e){return _.find(e.series,function(e){return function(e,t){var n=e.dataPoint,i=t.dataPoint,r=e.scale().domain(),o=t.scale().domain();return n.yAxisType===i.yAxisType&&r[0]===o[0]&&r[1]===o[1]}(t,e)})});e||(e=r.length?r.shift():new a(n),i.push(e)),e.addSerie(t)}),_.invokeMap(r,"remove")},showDateSelection:function(){this.el.css({top:"55px"})},hideDateSelection:function(){this.el.css({top:"25px"})}},{Chart:y,renderTypes:s,lineTypes:p,axisTypes:g}}e.$inject=["$rootScope","$q","$injector","$timeout","c8ySeries","c8yAxisY","c8yAxisX","c8yHoverInfo","c8yChartCommon","gettext"],angular.module("c8y.core.measurements2").factory("c8yChart",e)}();