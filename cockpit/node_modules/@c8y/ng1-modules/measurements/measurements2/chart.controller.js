"use strict";!function(){function t(o,t,a,n,e){var i,s,l,c,m,r=_.debounce(D,300,{leading:!1,trailing:!0}),d=12e4,u=!1,f=e("Realtime is active. Deactivate it to edit date and time.");function D(){s&&l.dateFrom&&l.dateTo&&(u=!0,s.loadData(l.dateFrom,l.dateTo,o.aggregation).then(h).finally(function(){u=!1,o.onDataChange({chart:s})}))}function p(t){s.realtimeMeasurement(t)&&(g(),h(),o.selectable()&&($(i),o.selected&&s.setSelectPoint(o.selected)))}function h(){i=moment()}function g(){!u&&moment().diff(i)>d&&D()}function $(t,e){var a=e||{},n=moment(t),o=moment.duration(moment(l.dateTo).diff(l.dateFrom)),i=moment(n).subtract(o);l.dateFrom=i.toDate(),l.dateTo=n.toDate();var c=l,r=c.dateFrom,d=c.dateTo;a.notrigger&&(m=!0),s.axisX.updateDates(r,d,!1),a.loadData&&D()}var T={dateFrom:!1,dateTo:!1,aggregation:!1,datapoints:!1};function v(t){t&&(T[t]=!0),_.every(T,function(t){return!0===t})&&r()}function F(){g(),moment(s.axisX._to).isBefore(moment())&&!s.allowSelectFocusTime&&$(moment(),{notrigger:1})}function w(){return _.map(o.datapoints,function(t,e){return{id:e,name:t.label,datapoint:t,datapointActive:t.__active}})}function S(t){o.seriesSelected=t;var e=_.map(o.seriesSelected,"datapoint");s.updateSeries(e,!0)}t.$on("c8yRealtime::connected",function(){D()}),this.init=function(t){s=t,o.chart=s,l={},o.internalDates=l,c=n(F),s.axisX.onUpdateDates=function(t,e){l.dateFrom=t,l.dateTo=e},o.$watch("dateFrom",function(t){moment(o.internalDates.dateFrom).isSame(t)||(o.internalDates.dateFrom=new Date(t),s.axisX.updateDates(t,o.dateTo,!1),v("dateFrom"))}),o.$watch("dateTo",function(t){moment(o.internalDates.dateTo).isSame(t)||(o.internalDates.dateTo=new Date(t),s.axisX.updateDates(o.dateFrom,t,!1),v("dateTo"))}),o.$watch("internalDates",function(t,e){var a=t.dateFrom&&moment(t.dateFrom).toDate(),n=t.dateTo&&moment(t.dateTo).toDate();o.datesValid=a&&n&&a<=n,o.datesValid&&(o.onUpdateDisplayedDates&&o.onUpdateDisplayedDates({$dateFrom:a,$dateTo:n}),m?m=!1:t!==e&&o.onUpdateDates&&(o.onUpdateDates({$dateFrom:a,$dateTo:n}),s.axisX.updateDates(a,n,!1),o.realtime||r()))},!0),o.$watch("aggregation",function(){return v("aggregation")}),o.$watch("datapoints",function(){o.seriesAvailable=w(),o.seriesSelected?S(_.filter(o.seriesAvailable,"datapointActive")):S(function(){var t=_.filter(w(),"datapointActive"),e=o.datapointsInitialDisplayLimit;return _.isUndefined(e)?t:_.take(t,e)}())},!0),o.$watchCollection("datapoints",function(){return v("datapoints")}),o.$watch("realtime",function(t){t&&!o.selectable()?($(moment(),{notrigger:1,loadData:1}),c.start()):c.cancel()}),o.$watch("selected",function(t){t?s.setSelectPoint(t):s.clearSelectPoint()}),s.onSelectPoint=function(t){a(function(){o.selected=t})},o.$watch(function(){return o.selectable()},function(t){(s.allowSelectFocusTime=t)&&c.cancel()}),o.$watch("chart.chartBox",function(t,e){_.isEqual(t,e)||o.onBoxChanged({box:t})});var e=_.throttle(s.render.bind(s),500);o.$on("dashboardResize",function(){return e()}),o.$watch("showTime()",function(t){t?s.showDateSelection():s.hideDateSelection()}),o.onData=p,o.$on("$destroy",function(){return c.cancel()}),o.onSeriesSelectionChanged=S},o.data={},o.realtimeActiveInfo=f}t.$inject=["$scope","$rootScope","$timeout","RTAutoMove","gettext"],angular.module("c8y.core.measurements2").controller("c8yChartCtrl",t)}();