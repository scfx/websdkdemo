"use strict";!function(){function t(R,K,t,e,n,M,L,D,$){function i(t,n,e){this.measurements=null,this.dataPoints=null,this.times=null,this.deviceIds=null;var i,r,a,s,c,o=this,u=!1,d=!1;function f(t){return $.listPossibleFast(t).then(h)}function m(){return R.all(_.map(o.deviceIds,l))}function l(t){var e=b(t);return L.addListener(n,e,"CREATE",y),R.when(L.start(n,e))}function p(t){return R.when(L.stop(n,b(t)))}function h(t){return r.datapoints?o.dataPoints=_(r.datapoints).filter(E).forEach(g):o.dataPoints=_(r.kpis||r.kpi&&[r.kpi]||[]).map(_.partial(v,t)).map(I).value(),!!_.get(r,"widget.templateUrl","").match("gauge")&&1<o.dataPoints.length&&(o.dataPoints=o.dataPoints.slice(0,1)),R.all(_.map(o.dataPoints,P))}function v(t,e){return e.moId&&_.find(t,{_kpiId:e.moId})||e}function g(t){M.createLocalId(t,"id")}function I(t){var e=_.assign({},t,{id:t.moId});return e.id||M.createLocalId(e),e}function P(t){return D.getMeasurement(t,k(t),1).then(_.partial(w,t))}function w(t,e){return o.measurements[t.id]=e[t.series],o.times[t.id]=e.time,e}function y(t,r){var a=r;a&&(_.forEach(a,function(t,i){_.isObjectLike(t)&&_.forEach(t,function(e,t){var n=function(e,n,i){return _.filter(o.dataPoints,function(t){return k(t)===e&&t.fragment===n&&t.series===i})}(a.source.id,i,t);_.forEach(n,function(t){o.measurements[t.id]=e,o.times[t.id]=r.time})})}),i&&i())}function E(t){return!("__active"in t)||t.__active}function k(t){return _.get(t,"__target.id")||_.get(r,"device.id")||K.deviceId}function b(t){return"/measurements/".concat(t)}c=t,r=_.cloneDeep(c),o.deviceIds=(s=(a=r).datapoints||a.kpis||[a.kpi],_(s).map(k).uniq().value()),e&&(r.widget=e),this.start=function(){if(u)throw new Error("MostRecentKpi service instance cannot be started more than once");return u=!0,o.refresh().then(m)},this.refresh=function(){return o.dataPoints=[],o.measurements={},o.times={},R.all(_.map(o.deviceIds,f))},this.stop=function(){if(!u)throw new Error("MostRecentKpi service instance cannot be stopped before being started");if(d)throw new Error("MostRecentKpi service instance cannot be stopped more than once");return d=!0,R.all(_.map(o.deviceIds,p))},this.onNotification=function(t){i=t}}return{createInstance:function(t,e,n){return new i(t,e,n)}}}t.$inject=["$q","$routeParams","c8yInventory","c8yMeasurements","c8yDevices","c8yBase","c8yRealtime","c8yKpi","c8yDataPointSvc"],angular.module("c8y.parts.kpi").factory("mostRecentKpiSvc",t)}();