"use strict";angular.module("c8y.parts.kpi").controller("kpiEditCtrl",["$scope","$routeParams","$location","kpiSvc","c8yTitle","gettext",function(t,e,n,i,a,l){var u,d=["target","min","max","yellowRangeMin","yellowRangeMax","redRangeMin","redRangeMax"],r={IS_REQUIRED:"required",SHOULD_CONTAIN_NUMBER:"number",SHOULD_BE_DEFINED:"should-be-defined",GREATER_THAN_SCALE_MAX:"greater-than-scale-max",LESS_THAN_SCALE_MIN:"less-than-scale-min",GREATER_THAN_RANGE_MAX:"greater-than-range-max",LESS_THAN_RANGE_MIN:"less-than-range-min"},o={};function m(n){return d.forEach(function(e){n[e]&&!_.isNumber(n[e])&&(n[e]=parseFloat(n[e]))}),n}function s(e){return _.isUndefined(e.enabled)&&(e.enabled=!0),e}function E(n){return _.isUndefined(n.unit)?i.getOneSeries(e.measurement,e.series).then(function(e){return n.unit=e.unit,n}):n}function c(e){u=e,t.kpi=u,a.changeTitle({subtitle:"".concat(u.fragment," / ").concat(u.series)})}function A(e,n){return!!(_.isUndefined(e)||!e&&0!==e||_.isUndefined(n)||!n&&0!==n)||e<n}function N(e,n){return!!(_.isUndefined(e)||!e&&0!==e||_.isUndefined(n)||!n&&0!==n)||e<=n}function f(e,n){e.$setValidity(r.SHOULD_BE_DEFINED,R(e.$modelValue,n.$modelValue)),n.$setValidity(r.SHOULD_BE_DEFINED,R(n.$modelValue,e.$modelValue)),e.$setValidity(r.GREATER_THAN_RANGE_MAX,A(e.$modelValue,n.$modelValue)),n.$setValidity(r.LESS_THAN_RANGE_MIN,A(e.$modelValue,n.$modelValue))}function R(e,n){return!(!_.isUndefined(n)&&(n||0===n))||!_.isUndefined(e)&&(e||0===e)}function V(e,n,i,t){n.$setValidity(r.LESS_THAN_SCALE_MIN,N(e.$modelValue,n.$modelValue)),i.$setValidity(r.GREATER_THAN_SCALE_MAX,N(i.$modelValue,t.$modelValue))}function $(){n.path("/device/".concat(e.deviceId,"/kpi"))}o[r.IS_REQUIRED]=l("This field is required."),o[r.SHOULD_CONTAIN_NUMBER]=l("This field must contain a number."),o[r.SHOULD_BE_DEFINED]=l("Value must be defined."),o[r.GREATER_THAN_SCALE_MAX]=l("Value must be less than scale maximum."),o[r.LESS_THAN_SCALE_MIN]=l("Value must be greater than scale minimum."),o[r.GREATER_THAN_RANGE_MAX]=l("Value must be less than range maximum."),o[r.LESS_THAN_RANGE_MIN]=l("Value must be greater than range minimum."),t.isFormValid=function(){var e=t.editKpi;return function(e){e.min.$setValidity(r.GREATER_THAN_SCALE_MAX,A(e.min.$modelValue,e.max.$modelValue)),e.max.$setValidity(r.LESS_THAN_SCALE_MIN,A(e.min.$modelValue,e.max.$modelValue))}(e),function(e){f(e.yellowRangeMin,e.yellowRangeMax)}(e),function(e){f(e.redRangeMin,e.redRangeMax)}(e),function(e){V(e.min,e.yellowRangeMin,e.yellowRangeMax,e.max)}(e),function(e){V(e.min,e.redRangeMin,e.redRangeMax,e.max)}(e),function(e){e.target.$setValidity(r.LESS_THAN_SCALE_MIN,N(e.min.$modelValue,e.target.$modelValue)),e.target.$setValidity(r.GREATER_THAN_SCALE_MAX,N(e.target.$modelValue,e.max.$modelValue))}(e),e.$valid},t.isFieldInvalid=function(e){var n=t.editKpi[e];return n&&n.$invalid},t.getFieldValidationHints=function(e){var i=[];return t.editKpi[e]&&t.editKpi[e].$error&&_.forEach(t.editKpi[e].$error,function(e,n){e&&i.push(o[n])}),i.join(" ")},t.save=function(){i.updateKpi(u).then($)},t.cancel=function(){$()},i.getKpi(e.measurement,e.series).then(m).then(s).then(E).then(c)}]);