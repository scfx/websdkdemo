"use strict";!function(){function e(g,e,n){d.$inject=["$rootScope","$location","$q","gettextCatalog","c8yBase","c8yTitle","c8yModal","c8yAlert","c8yRoles","c8yPermissions","c8yRolesUiStrings"],c.$inject=["$routeParams","c8yTenant"];var y="roles",b="roles/inventory_roles",R="".concat(y,"/global/:roleId"),w="".concat(y,"/inventory/:roleId"),t="c8y-users",o={priority:1e3,icon:"connected-people",template:'<c8y-roles-list roles="vm.globalRoles" help-text="vm.globalHelpText" on-remove="vm.onRemove(role, vm.globalRoles)" add-role="vm.add(\'global\')" on-load-next="vm.loadNext(\'global\')"></c8y-roles-list>',name:g("Global roles"),controller:"c8yRolesOverviewCtrl",controllerAs:"vm"},r={icon:"insurance-agent",template:'<c8y-roles-list roles="vm.inventoryRoles" help-text="vm.inventoryHelpText" on-remove="vm.onRemove(role, vm.inventoryRoles)" add-role="vm.add(\'inventory\')" on-load-next="vm.loadNext(\'inventory\')"></c8y-roles-list>',name:g("Inventory roles"),controller:"c8yRolesOverviewCtrl",controllerAs:"vm"},a={template:'<c8y-role-detail-global id="vm.params.roleId" duplicate-id="vm.params.duplicate"></c8y-role-global-global>'},l={template:'<c8y-role-detail-inventory id="vm.params.roleId" duplicate-id="vm.params.duplicate" is-top-tenant="vm.isTopTenant"></c8y-role-detail-inventory>'},i={controllerAs:"vm",controller:c};function c(e,n){var t=this;_.assign(t,{isTopTenant:!1,params:e}),n.isCurrentUserTopTenant().then(function(e){t.isTopTenant=e})}var T=["READ","ADMIN","CREATE","UPDATE"],E="ROLE_USER_MANAGEMENT_ADMIN",s=["ROLE_USER_MANAGEMENT_READ",E];function u(){e.when("/".concat(y),o),e.when("/".concat(y),r),e.when("/".concat(R),_.assign(a,i)),e.when("/".concat(w),_.assign(l,i))}function d(l,r,i,c,a,e,s,u,d,n,t){return{ROUTE_LIST:y,STRINGS:t,listGlobalPermissions:function(){return n.listGlobal().then(function(e){return _.filter(e,function(e){return _.includes(T,e.access)})})},list:o,setListTitle:function(){e.changeTitle({title:g("Roles")})},add:m,edit:function(e){var n=d.isGlobal(e)?R:w;return function(e,n){var t=a.getId(e),o=n.replace(/:\w+/,t);return r.search("duplicate",null),r.path(o)}(e,n)},duplicate:function(e){m(d.isGlobal(e)?"global":"inventory",e.id)},removeAfterConfirmation:function(e){var n={title:g("Delete role"),body:c.getString('You are about to delete role "{{name}}". Do you want to proceed?',e),labels:{ok:g("Delete")},status:"danger"},t=s(n),o=_.partial(d.remove,e),r=_.partial(d.global.remove,e),a=d.isGlobal(e)?r:o;return t.then(a).then(function(){return u.success(g("Role deleted."))}).catch(function(e){var n=_.get(e,"status");n&&(422===n?u.warning(g("Role cannot be deleted because it is assigned to users.")):(t=e,o=_.get(t,"data",t),l.$emit("alert",{type:"danger",text:$("<div/>").text(c.getString(o.message)).html(),detailedData:o})));var t,o;return i.reject(e)})},canCreate:function(){return n.hasAnyRole([E])},newInventoryRole:function(e){var n=i.when({name:c.getString("New inventory role"),permissions:[]});e&&(n=d.detail(e).then(function(e){var n=e.data,t={};return t.name="".concat(n.name," 2"),t.permissions=_.map(n.permissions,function(e){return _.omit(e,["id"])}),t}));return n},saveInventoryRole:function(e){var n=i.when();e.id||(n=v(e,e.name).catch(h(e.name)));return n.then(_.partial(d.save,e)).then(function(){return u.success(g("Inventory role saved."))}).then(o)},saveInventoryRoleName:function(n,t){return v(n,t).then(function(){var e;return n.id?e=d.update({id:n.id,name:t}).then(function(e){return n.name=t,e}):n.name=t,e},h(t))},newGlobalRole:function(e){var n=i.when({name:c.getString("New global role")});e&&(n=d.global.detail(e).then(function(e){var n=_.pick(e.data,["name","roles","applications"]);return n.name+=" 2",n}));return n},saveGlobalRole:function(n,t){return(n.id?function(){var e=l.$new(!0);return e.role=n,s({templateUrl:":::PLUGIN_PATH:::/detail/roleGlobalSaveConfirm.html",title:g("Confirm saving changes?"),scope:e})}():i.when()).then(function(){var e=i.when();n.id||(e=f(n,n.name).catch(h(n.name)));return e.then(_.partial(d.global.save,n))}).then(function(e){return d.global.updateRoles(e,t)}).then(function(){return u.success(g("Global role saved."))}).then(o)},saveGlobalRoleName:function(n,t){return f(n,t).then(function(){var e=i.when();return n.id?e=d.global.update({id:n.id,name:t}).then(function(e){return n.name=t,e}):n.name=t,e},h(t))},isUndeletable:function(e){return d.isGlobal(e)&&("admins"===_.lowerCase(e.name)||"devices"===_.lowerCase(e.name)||n.hasRole(e,"ROLE_NO_DELETE"))}};function o(){var e=new RegExp("\\/roles\\/inventory\\/(\\w+)"),n=r.path().match(e),t="/".concat(n?b:y);r.path(t),r.search("duplicate",null)}function m(e,n){var t=("global"===e?R:w).replace(/:\w+/,"new");r.path(t),n&&r.search("duplicate",n)}function v(n,t){return d.list().then(function(e){return p(e,n,t)})}function p(e,n,t){var o=_.filter(e,function(e){return e.id!==n.id});return _.some(o,{name:t})&&i.reject({duplicate:!0})}function h(n){return function(e){return _.get(e,"duplicate")&&u.danger(c.getString('There is already a role with the name "{{name}}"',{name:n})),i.reject()}}function f(n,t){return d.global.list().then(function(e){return p(e,n,t)})}}return{$get:d,init:function(){u(),n.addNavigation({name:g("Roles"),parent:g("Accounts"),routerLinkExact:!1,priority:4900,path:y,icon:t,showIfPermissions:{anyRole:s}})},hookViews:u}}e.$inject=["gettext","c8yViewsProvider","c8yNavigatorProvider"],angular.module("c8y.roles").provider("c8yRolesUi",e)}();