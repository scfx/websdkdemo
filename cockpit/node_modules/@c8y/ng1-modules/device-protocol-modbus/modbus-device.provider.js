"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?Object(arguments[e]):{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&r.push.apply(r,Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),r.forEach(function(e){_defineProperty(t,e,n[e])})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(){e.$inject=["c8yDeviceTypeProtocolBaseProvider","c8yDeviceProtocolUiProvider","c8yViewsProvider","gettext"];var a="c8yModbusDevice";function e(e,t,n,P){r.$inject=["c8yDeviceDatabase","c8yDeviceControl","gettextCatalog","c8yInventory","c8yDevices","c8yAlert","c8yBase","c8yUser","$q"];var D={label:P("Modbus"),fieldbusType:"modbus",serviceName:a};return e.getDeviceTypeProtocolProvider(D,r);function r(o,c,l,e,d,i,p,r,m){var t,n=o.ElementType,v=n.DISCRETE_IO,g=n.REGISTER,a=(_defineProperty(t={},v.value,"c8y_CoilStatus"),_defineProperty(t,g.value,"c8y_RegisterStatus"),t),s=_objectSpread({},D,{discreteOutputs:{functionalities:{showStatus:!0,updateStatus:!0}},discreteInputs:{functionalities:{showStatus:!0,updateStatus:!1}},holdingRegisters:{number:!0,startBit:{max:15},noBits:{max:64,base:16},multiplier:{min:1,step:1},divisor:!0,decimalPlaces:!0,unit:!0,options:{signed:!0,enumType:!0,littleEndian:!0},functionalities:{showStatus:!0,updateStatus:!0,sendMeasurement:!0,raiseAlarm:!0,sendEvent:!0}},inputRegisters:{number:!0,startBit:{max:15},noBits:{max:64,base:16},multiplier:{min:1,step:1},divisor:!0,decimalPlaces:!0,unit:!0,options:{signed:!0,enumType:!0,littleEndian:!0},functionalities:{showStatus:!0,updateStatus:!0,sendMeasurement:!0,raiseAlarm:!0,sendEvent:!0}},options:{serverTime:!0},deviceFragments:["c8y_ModbusDevice"],deviceConfiguration:{fragment:"c8y_ModbusConfiguration",icon:"microchip"},versions:[{number:5,checks:[function(e){return _.some(e.c8y_Registers,function(e){return 16<e.noBits})},function(e){return _.some(e.c8y_Registers,function(e){return!_.isUndefined(e.littleEndian)})}]}]});return{registerFeaturesManifest:function(){o.registerFeaturesManifest(u().then(function(e){return e&&s}))},isAvailable:u,create:function(a,i){var s,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(f(a,i));case 2:return s=e.sent,e.t0=p,e.next=6,regeneratorRuntime.awrap(d.createConfirm(s));case 6:return e.t1=e.sent,u=e.t0.getResData.call(e.t0,e.t1),e.next=10,regeneratorRuntime.awrap(d.addChildDevice(a,u));case 10:return u.owner=a.owner,e.next=13,regeneratorRuntime.awrap(d.save(u));case 13:return e.abrupt("return",c.create((t=a,n=i.deviceType,r=u,{deviceId:t.id,description:'Added new child device to "'.concat(t.name,'" (ID: ').concat(t.id,")."),c8y_ModbusDevice:{id:r.id,name:r.name,address:r.c8y_ModbusDevice.address,ipAddress:r.c8y_ModbusDevice.ipAddress,type:"/inventory/managedObjects/".concat(n.id),protocol:r.c8y_ModbusDevice.protocol}})));case 14:case"end":return e.stop()}var t,n,r},null,null,null,Promise)},canUpdateElement:b,isElementChangePending:function(e){return e.changePending},getCurrentElementValue:y,getCurrentElementValueFormatted:function(e,t){var n=y(e,t);t.meta.enumType&&(n=t.meta.enumValues[n].label);return n},updateElement:function(t,n,r){var a,i,s,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(b(t,n))return e.next=3,regeneratorRuntime.awrap(o.getDeviceTypeFromDevice(t));e.next=12;break;case 3:return a=e.sent,i=h(t,a,n,r),n.changePending=!0,s=S(n,r),e.next=9,regeneratorRuntime.awrap(R(i,s));case 9:return(u=e.sent).status===c.status.SUCCESSFUL?(w(t,n,r),n.changePending=!1):u.status===c.status.FAILED&&(n.changePending=!1),e.abrupt("return",u);case 12:return e.abrupt("return",m.reject());case 13:case"end":return e.stop()}},null,null,null,Promise)},getAlertMessagesFns:S,sendOperationAndGetResult:R};function u(){return o.isFeatureFieldbus4Available()}function f(e,t){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(r.current());case 2:return n=e.sent,e.abrupt("return",{name:t.name,type:t.deviceType.name,c8y_ModbusDevice:{address:t.address,ipAddress:t.ipAddress,type:"/inventory/managedObjects/".concat(t.deviceType.id),protocol:t.protocol},owner:n.id});case 4:case"end":return e.stop()}},null,null,null,Promise)}function y(e,t){var n=a[t.meta.type.value];return e&&e[n]&&parseFloat(e[n][t.name])}function b(e,t){var n=t.statusMapping;return!e.c8y_ModbusReadOnlyDevice&&n&&"write"===n.status}function h(e,t,n,r){var a=n.meta.type;return a===v?function(e,t,n){return{deviceId:e.id,description:'Change status of "'.concat(t.name,'" to "').concat(n.label,'".'),c8y_SetCoil:{address:e.c8y_ModbusDevice.address,input:t.input,coil:t.number,value:n.value}}}(e,n,r):a===g?function(e,t,n,r){var a=r.label||r.value,i=!r.label&&n.unit?" ".concat(n.unit):"",s={deviceId:e.id,description:'Change value of "'.concat(n.name,'" to ').concat(a).concat(i,"."),c8y_SetRegister:{}};"opcua"===t.fieldbusType?s.c8y_SetRegister={address:e.c8y_OPCUADevice.browsePath,register:n.browsePath,value:r.value}:s.c8y_SetRegister={ipAddress:_.get(e,"c8y_ModbusDevice.ipAddress",""),address:e.c8y_ModbusDevice.address,input:n.input,register:n.number,startBit:n.startBit,noBits:n.noBits,value:r.value};return s}(e,t,n,r):void 0}function S(e,t){var n,r,a,i,s=e.meta.type,u={name:e.name};s===v?(u.label=t.label,n=P("Status of {{name}} will be changed to {{label}}"),r=P("Status of {{name}} has been changed to {{label}}"),a=P("Failed to change status of {{name}} to {{label}}"),i=P('Failed to change status of {{name}} to {{label}} due to: "{{operation.failureReason | translate}}".')):s===g&&(u.value=t.label||t.value,u.unit=!t.label&&e.unit?" ".concat(e.unit):"",n=P("Value of {{name}} will be changed to {{value}}{{unit}}"),r=P("Value of {{name}} has been changed to {{value}}{{unit}}"),a=P("Failed to change value of {{name}} to {{value}}{{unit}}"),i=P('Failed to change value of {{name}} to {{value}}{{unit}} due to: "{{operation.failureReason | translate}}".'));var o=function(t){return function(e){return l.getString(t,_objectSpread({},u,{operation:e}))}};return{onCreated:o(n),onSuccess:o(r),onFailure:o(a),onFailureWithReason:o(i)}}function R(t,n){var r,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(c.createWithNotifications(t));case 2:return(r=e.sent).created.then(function(){n.onCreated?i.success(n.onCreated(t)):i.success(l.getString('"{{description | translate}}" will be executed.',t))}),e.next=6,regeneratorRuntime.awrap(r.completed);case 6:return(a=e.sent).status===c.status.SUCCESSFUL?n.onSuccess?i.success(n.onSuccess(t)):i.success(l.getString('"{{description | translate}}" completed.',t)):a.status===c.status.FAILED&&(a.failureReason?n.onFailureWithReason?i.danger(n.onFailureWithReason(a)):i.danger(l.getString('"{{description | translate}}" failed due to: "{{failureReason | translate}}".',a)):n.onFailure?i.danger(n.onFailure(t)):i.danger(l.getString('"{{description | translate}}" failed.',t))),e.abrupt("return",a);case 9:case"end":return e.stop()}},null,null,null,Promise)}function w(e,t,n){var r=t.meta.type;r===v?_.set(e,["c8y_CoilStatus",t.name],n.value):r===g&&_.set(e,["c8y_RegisterStatus",t.name],n.value)}}}angular.module("c8y.modbus").provider(a,e)}();