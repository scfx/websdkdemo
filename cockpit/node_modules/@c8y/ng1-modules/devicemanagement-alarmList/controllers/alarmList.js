"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?Object(arguments[e]):{},i=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&i.push.apply(i,Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),i.forEach(function(e){_defineProperty(t,e,r[e])})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}!function(){function e(r,t,i,n,s,e,o,a,c){var u,l,f=this,d={pageSize:10},v=new WeakMap,h=new WeakMap,m=function(){function t(e){_classCallCheck(this,t),this.name=e,this.active=!1,this.filters={},this.count=null,this.countLoading=!1}return _createClass(t,[{key:"active",get:function(){return v.get(this)},set:function(e){v.set(this,e),this.reloadCount()}},{key:"toggleActive",value:function(){this.active=!this.active}},{key:"filters",get:function(){return h.get(this)},set:function(e){h.set(this,e),this.reloadCount()}},{key:"reloadCount",value:function(){var t=this;this.active&&(this.countLoading=!0,_.isUndefined(this.filters.source)||_.assign(this.filters,{withSourceAssets:!0,withSourceDevices:!0}),n.getDisplayCount(_.omit(this.filters,this.filters.resolved?["pageSize","resolved"]:"pageSize")).then(function(e){t.count=e}).finally(function(){t.countLoading=!1}))}}]),t}(),y="/alarmsWithChildren";function g(){f.severities.forEach(function(e){e.filters=_objectSpread({},d,{severity:e.name})})}function p(e,t){s.addListener(r.$id,u,e,t)}function b(){S()}function C(e,t){var r=_.find(f.severities,{name:t.severity});if(_.isString(r.count))r.reloadCount();else{var i=0;"CREATE"===e&&("ACTIVE"!==t.status&&"ACKNOWLEDGED"!==t.status||(i=r.filters.resolved?0:1),"CLEARED"===t.status&&(i=r.filters.resolved?1:0)),"UPDATE"===e&&"CLEARED"===t.status&&(i=r.filters.resolved?1:-1),r.count+=i}}function E(){s.switchRealtime(r.$id,u)}function A(){d.resolved=!f.unresolved,g()}function w(){var e=_.filter(f.severities,"active"),t=_.map(e,function(e){var t=_objectSpread({resolved:!1},_.pick(e.filters,["source","severity"]));_.isUndefined(t.source)||_.assign(t,{withSourceAssets:!0,withSourceDevices:!0});var r={status:n.status.CLEARED};return n.updateBulk(t,r)});return i.all(t).then(function(e){return{resolvedImmediately:_.every(e,function(e){return 200===e.status})}})}function S(){r.$broadcast("alarmListRefresh"),f.severities.forEach(function(e){return e.reloadCount()})}_.assign(f,{icon:n.icon,realtime:!0,onVmUnresolvedChange:A,clientSideUnresolved:function(){return t.deviceId?f.unresolved:void 0},resolveAll:function(){return e({title:c("Confirm clearing alarms?"),body:c("Do you really want to clear all alarms of selected severities?"),status:"danger"}).then(w).then(function(e){var t=e.resolvedImmediately;t?a.success(c("Alarms cleared.")):a.success(c("Alarms are being cleared in background."))}).then(S)},refresh:S,isRefreshing:function(){return _.some(f.severities,"refreshing")}}),function(){var e=_.reverse(_.cloneDeep(n.severityList));f.severities=_.map(e,function(e){return new m(e)}),f.unresolved=!0,A(),t.deviceId&&(d.source=t.deviceId);g(),f.severities.forEach(function(e){e.active=!0}),o.changeTitle({title:c("Alarms")}),function(){var e="".concat(y,"/*");d.source&&(e="".concat(y,"/").concat(d.source));if(u){if(e===u)return;s.removeSubscriber(r.$id,u),l()}u=e,p("".concat(r.$id,"-subscribed"),b),p("CREATE",C),p("UPDATE",C),l=r.$on("$destroy",function(){s.removeSubscriber(r.$id,u)}),f.realtime&&E()}()}(),r.$watch("vm.realtime",function(){f.realtime&&S();f.realtime!==s.getStatus(r.$id,u)&&E()})}e.$inject=["$scope","$routeParams","$q","c8yAlarms","c8yRealtime","c8yModal","c8yTitle","c8yAlert","gettext"],angular.module("c8y.parts.alarmList").controller("alarmListCtrl",e)}();