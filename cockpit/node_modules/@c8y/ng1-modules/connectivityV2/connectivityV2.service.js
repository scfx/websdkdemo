"use strict";!function(){function t(n,t,e,r,a,i,o,c,s){var u={getThisMonth:function(){var t=e.monthFilter();return _.unset(t,"dataTo"),m(t)},getLastMonth:function(){return m(e.monthFilter({},1))},getThisDay:function(){return{dateFrom:moment().startOf("day").format("YYYY-MM-DD")}},getTerminalUsage:function(t){1<arguments.length&&void 0!==arguments[1]&&arguments[1]&&d.cache.delete(t);return d(t)},getUsageTooltip:function(t,e,n){var r=[];if(!_.isUndefined(t)){var i={thisMonthEnd:t.dateTo,thisMonthStart:t.dateFrom};r.push(a.getString("Usage in this month to date ({{thisMonthStart}} - {{thisMonthEnd}})",i))}if(!_.isUndefined(n)){var o={thisMonthEnd:t.dateTo,thisMonthStart:t.dateFrom,lastMonthStart:e.dateFrom,lastMonthEnd:e.dateTo,lastMonthUsage:n};r.push(a.getString("Usage in the last month ({{lastMonthStart}} - {{lastMonthEnd}}): {{lastMonthUsage}}",o))}return r.join("\n")},getTodaysUsageTooltip:function(){return t("Recent data")},processUsageData:function(t,n){var e=t?_.reduce(t,function(t,e){return t+_.get(e,n)},0).toFixed(3):0;return 0<e?e:0},isAdmin:function t(){t.promise||(t.promise=r.hasAnyRole(["ROLE_CONNECTIVITY_ADMIN"]));return t.promise},getProviderSupportedFunctionalities:function t(){t.promise||(t.promise=i.getProviderSupportedFunctionalities().then(function(t){var e,n=t.functionalities;return e=n,_.reduce(e,function(t,e){return t[e]=!0,t},{})}));return t.promise},getCurrentProviderDetails:function t(){t.promise||(t.promise=o.detail());return t.promise},getThisDayDataUsage:function(t,e){2<arguments.length&&void 0!==arguments[2]&&arguments[2]&&h.cache.delete("".concat(t,"_").concat(e));return h(t,e)},shouldShowConnectivityTabInDM:function(t){return c.detailCached(t).then(e.getResData).then(f).then(g).then(i.ping).then(i.isConnectivitySubscribed).then(_.constant(!0)).catch(_.constant(!1))},isDeviceSupportedByCurrentProvider:function(t){return i.getTerminalDetails(t,{},{},{silentError:!0}).catch(function(t){return 400!==t.status&&s.danger(e.getResErrorMessage(t)),n.reject(t)})},checkConnectivityCache:function(t){return c.detailCached(t).then(e.getResData).then(function(e){return _.get(e,"c8y_Mobile.c8y_IsConnectivity")?n.when():i.getTerminalDetails(t,{},{},{silentError:!0}).then(function(){return _.set(e,"c8y_Mobile.c8y_IsConnectivity",{}),r.canAdminMOs([e]).then(function(t){return t?c.save(e):n.when(e)})})})}},h=_.memoize(function(t,e){return i.getTerminalDataUsage(t,{},e)},function(t,e){return"".concat(t,"_").concat(e)}),d=_.memoize(function(t){return i.getTerminalUsage(t,{},{})});return u;function m(t){if(t.dateFrom){var e=t.dateFrom;t.dateFrom=moment(e).format("YYYY-MM-DD"),t.cycleStartDate=moment(e).format("YYYY-MM-DD")}return t.dateTo?t.dateTo=moment(t.dateTo).format("YYYY-MM-DD"):t.dateTo=moment().format("YYYY-MM-DD"),t}function g(){return r.hasAnyRole(["ROLE_CONNECTIVITY_READ"]).then(function(t){return t?n.when():n.reject()})}function f(t){var e=t;return _.get(e,"c8y_Mobile.iccid")||_.get(e,"c8y_Mobile.msisdn")?n.when():n.reject()}}t.$inject=["$q","gettext","c8yBase","c8yPermissions","gettextCatalog","c8yConnectivity","c8yConnectivitySettings","c8yDevices","c8yAlert"],angular.module("c8y.connectivityV2").factory("connectivityService",t)}();