"use strict";!function(){function t(n,t,o,a,e,i,r,d,c,s,l,m,g,f){var u,h;function v(t){n.data.graphDataPoints=t;var a=D(_.filter(t,"__active"));n.channel=a?"/measurements/".concat(a):""}function p(t){n.data.graphAlarmsEventsConfigs=t;var a=D(_.filter(t,"__active"));n.alarmsChannel=a?"/alarms/".concat(a):"",n.eventsChannel=a?"/events/".concat(a):""}function D(t){return _(t).map(function(t){return t.__target.id}).uniq().value().join(",")}function F(){var t=a.getContext();t.context&&(u="".concat(t.context,"_").concat(t.id)),function(){if(n.disableLocalStorage)return;var a=_.throttle(function(t,a){t!==a&&function(){if(!n.dontSave&&!n.disableLocalStorage){var t=_.pick(n.data,["dateFrom","dateTo","interval","aggregation","realtime","alarmsEventsConfigs"]);i.setSavedFilters(t,u)}}()},500,{leading:!1,trailing:!0});i.getSavedFilters(u).then(function(t){_.assign(n.data,t),n.$watch("data.realtime",a),n.$watch("data.dateFrom",a),n.$watch("data.dateTo",a),n.$watch("data.interval",a),n.$watch("data.aggregation",a),n.$watch("data.alarmsEventsConfigs",a,!0)})}()}function x(){var t,a=x._hasDashboard,e=a;if(_.isUndefined(a))try{2===(t=o.get("dashboardSvc")).VERSION&&(e=t)}catch(t){e=!1}return x._hasDashboard=e}function w(t){var a=x();a&&a[t]({name:"Data points graph",title:l.getString("Data points"),_width:12,_height:5,config:{datapoints:n.data.graphDataPoints,alarmsEventsConfigs:n.data.graphAlarmsEventsConfigs,dateTo:n.data.dateTo,dateFrom:n.data.dateFrom,aggregation:n.data.aggregation,realtime:n.data.realtime}}).then(S)}function S(){d.success(s("Widget created."))}function y(){w("addWidgetToSelectedDashboardInContext")}function C(){w("addWidgetToSelectedReport")}function T(t){n.chartBox=t}n.onRealtimeAlarmFn=function(t){n.onAlarm=t},n.onRealtimeEventFn=function(t){n.onEvent=t},!a.getContext().context&&t.path().match(/datapoint/)&&e.changeTitle({title:s("Data explorer")}),F(),h={text:s(u?"Send as widget to dashboard":"Send as widget to report"),action:u?y:C},x()&&!n.noActions&&r.addAction(h),n.noActions||function(){function t(t,a){r.addAction({text:t,action:function(){var t={dateFrom:moment(n.data.dateFrom).format(c.dateFullFormat),dateTo:moment(n.data.dateTo).format(c.dateFullFormat)};g.downloadReportForDatapoints(a,n.data.graphDataPoints,t).catch(function(t){t&&t.message&&d.warning(t.message)})}})}t(s("Download as CSV"),m.format.csv),t(s("Download as Excel"),m.format.xlsx)}(),$(window).resize(function(){n.$broadcast("dashboardResize"),n.$apply()}),n.onBoxChanged=T,n.onUpdateDates=function(t,a){n.data.dateFrom=t;var e=moment().diff(moment(a),"seconds")<10;n.data.realtime&&!e&&(n.data.realtime=!1),n.data.dateTo=a},n.onUpdateDisplayedDates=function(t,a){n.data.displayedDateFrom=t,n.data.displayedDateTo=a},n.savedFilter={config:{}},n.data=n.data||_.cloneDeep(n.savedFilter),function(){var a=n.data.interval;if(a&&"custom"!==a){var t=_.find(f.intervals,function(t){return t.id===a})||{};t.qty&&(n.data.dateFrom=moment().subtract(t.qty,t.unit).toDate(),n.data.dateTo=moment().toDate())}}(),n.$watch("data.datapoints",v,!0),n.$watch("data.alarmsEventsConfigs",p,!0)}t.$inject=["$scope","$location","$injector","c8yUiUtil","c8yTitle","c8yDataPointSvc","c8yActions","c8yAlert","c8yBase","gettext","gettextCatalog","c8yMeasurements","MeasurementsReportSvc","INTERVAL_CONSTANTS"],angular.module("c8y.cockpit.dataPointExplorer").controller("c8yDataPointExplorerCtrl",t)}();