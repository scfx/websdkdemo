"use strict";function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?Object(arguments[e]):{},n=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&n.push.apply(n,Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable})),n.forEach(function(e){_defineProperty(t,e,r[e])})}return t}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}!function(){function e(a,p,e,r,t,n,i){var c;a.placeholder=i("Device's name or value of any device's property"),a.isDeviceSelected=a.isDeviceSelected||function(){return!(!_.isUndefined(A())||!a.selectRequired)},a.selectRoot=a.selectRoot||function(){m(c)},a.isSelectedRoot=a.isSelectedRoot||A,a.select=a.select||m,a.clickSelect=function(e){a.select(e,a),a.form&&(a.form.$setDirty(),a.form.$setValidity("deviceSelected",!0))},a.isSelected=a.isSelected||S,a.isSelectedById=a.isSelectedById||D,a.isSelectionEmpty=a.isSelectionEmpty||function(){return!a.selectedChildDevice},a.search=u,a.searchData={},a.propagateToggle={},a.icon=function(){return a.loading?"circle-o-notch":"search"},a.checkEnter=function(e){e.keyCode===I&&u(a.searchData.text)},a.getRootName=function(e){return e||i("Root Device")},a.emptySelectionAvailable=_.result(a,"emptySelectionAvailable")||!1,a.emptySelectionIcon=_.result(a,"emptySelectionIcon")||"",a.emptySelectionLabel=_.result(a,"emptySelectionLabel")||i("None"),a.readOnlyInfoText=_.result(a,"readOnlyInfo")||i("Selection change is disabled."),a.getScope=function(){return a},a.$watch("parent",o),a.$watch("selectedChildDevice",g),a.$on("selectDevice",C);function o(e,t){e&&(t&&e.id&&e.id===t||(_.isObjectLike(e)?p.when(e):n.detail(e).then(r.getResData)).then(function(e){return h(e),a.parentDevice=e,a.top&&(c=e,a.root=c,a.selectedChildDevice||!e.isDevice&&!a.groupsSelectable||(a.selectedChildDevice=e)),e}).then(y).then(v).then(l))}function l(e,t){var r=(a.children||[]).concat(e);a.children=_.uniqBy(r,"id"),a.truncated=!_.isUndefined(t)&&t}function u(e){a.propagateToggle.value=!1,_.remove(a.children,function(e){return!D(e)}),a.loading=!0,d({text:a.searchData.lastText=e}).then(s).finally(function(){a.loading=!1})}function d(e){var d=0,s=[];return n.list(_objectSpread({},e,{withParents:!0})).then(function e(t){d++;var r,n=t.statistics.pageSize,i=t.paging.next,c=t.length>=n,o=function(e){var t=function(e){return _(e).map(_.property("childDevices.references")).flatten().map(_.property("managedObject.id")).uniq().value()}(e);return _.filter(e,function(e){return e&&(D(e)||e.c8y_IsDevice||f(e)||function(e,t){return function(e){return _.get(e,"deviceParents.references.length")}(e)&&!_.includes(t,e.id)}(e,t))&&!function(e){return"c8y_OpcuaNode"===e.type}(e)})}(t),a=(s=[].concat(_toConsumableArray(s),_toConsumableArray(o))).length>n,l=i&&c;if(s.length>=n||10<=d||!l){var u=a||l;r=p.resolve({mos:_.take(s,n),truncated:u})}else r=t.paging.next().then(e);return r})}function s(e){var t=e.mos,r=e.truncated;return p.resolve(t).then(v).then(function(e){return l(e,r)})}function f(e){return!!e.c8y_IsDeviceGroup}function y(e){return t[f(e)?"childAssets":"childDevices"](e)}function h(e){var t=!f(e),r=t?"childDevices":"childAssets";return e.isDevice=t,e.__children=e[r]&&e[r].references||[],e}function v(e){return _.map(e,function(e){return h(e),D(e)&&m(e),a.parent&&(e.openChildren=!1,Array.isArray(a.parent.idPath)?(e.idPath=_.cloneDeep(a.parent.idPath),e.idPath.push(a.parent.id)):e.idPath=[a.parent.id]),e})}function g(e){if(e&&e.id){a.$parent.propagateToggle?a.propagateToggle=a.$parent.propagateToggle:a.propagateToggle={value:!0};var t=e.idPath?e.idPath[0]:e.id;!a.deviceSelectorForm.$dirty&&a.selectedChildDeviceId&&a.selectedChildDeviceId!==e.id&&a.deviceSelectorForm.$setDirty(),a.idPath=e.idPath,a.selectedChildDeviceId=e.id,a.children||!a.top||a.parent||d({ids:t}).then(s)}}function m(e,t){var r=["id","type","name"],n=t?[b(r,e)]:[];(t||a).$emit("selectDevice",n,r,e)}function b(e,r){return _.reduce(e,function(e,t){return e[t]=_.get(r,[t]),e},{})}function D(e){return e&&a.selectedChildDevice&&a.selectedChildDevice.id===e.id}function S(e){return D(e)}function A(){return S(c)||a.selectedChildDevice&&(c&&c.id)===a.selectedChildDevice.id}function C(e,t,r,n){var i=a.top?_.reduce(r,function(e,t){return e[t]="_root",e},{}):b(r,a.parentDevice);if(t.push(i),a.top){var c=t.reverse(),o=_.reduce(c[0],function(e,t,r){return e["path_".concat(r)]=_.map(c,r).join("/"),e},{});e.stopPropagation(),a.selectedChildDevice=n,a.contextPaths=o,a.onSelect({selDevice:n,contextPaths:o})}}_.assign(this,{$onInit:function(){void 0!==a.selectedChildDevice&&e(function(){a.form.$setValidity("deviceSelected",!0)},500)}});var I=13}e.$inject=["$scope","$q","$timeout","c8yBase","c8yDevices","c8yInventory","gettext"],angular.module("c8y.deviceSelector").controller("DeviceSelectorComboCtrl",e)}();