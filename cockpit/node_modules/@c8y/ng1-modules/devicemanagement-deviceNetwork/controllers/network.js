"use strict";angular.module("c8y.deviceNetwork").controller("deviceNetworkCtrl",["$scope","c8yBase","c8yDeviceControl","c8ySettings","c8yAlert","gettext",function(s,e,i,t,n,o){var a=[{value:"pap",label:"PAP"},{value:"chap",label:"CHAP"},{value:"none",label:o("None")}],r=[{substr:{start:0,count:1},leadingBits:"0",netmask:"255.0.0.0"},{substr:{start:0,count:2},leadingBits:"10",netmask:"255.255.0.0"},{substr:{start:0,count:3},leadingBits:"110",netmask:"255.255.255.0"}];function c(e){return _.isBoolean(e)?e:Boolean(e)}function d(e,t){var n=e.c8y_Network.c8y_WAN,a={deviceId:e.id,description:o("Configure WAN settings"),deliveryType:t,c8y_Network:{c8y_WAN:{apn:n.apn,username:n.username,password:n.password,authType:n.authType}}};return i.create(a).then(_.partial(l,o("Sent operation to apply WAN settings."),s.wanForm))}function l(e,t){n.success(e),t&&t.$setPristine()}function u(e){var t;if(e){var n=e.split("."),a=p(parseInt(n[0],10).toString(2),8);t=null,_.forEach(r,function(e){a.substr(e.substr.start,e.substr.count)===e.leadingBits&&(t=e.netmask)})}return t}function p(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"0",a="".concat(e);return a.length>=t?a:new Array(t-a.length+1).join(n)+a}s.patterns={MAC:/^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/},s.authTypes=a,s.invalid=angular.bind(e,e.invalid,s),s.onLanIpChanged=function(e){e.netmask=u(e.ip)},s.saveWANviaIP=function(e){return d(e)},s.saveWANviaSMS=function(e){return d(e,"SMS")},s.saveLANandDHCP=function(e){var t=e.c8y_Network.c8y_LAN,n={deviceId:e.id,description:o("Configure LAN settings"),c8y_Network:{c8y_LAN:{enabled:t.enabled?1:0,ip:t.ip,netmask:t.netmask}}},a=e.c8y_Network.c8y_DHCP,r={deviceId:e.id,description:o("Configure DHCP settings"),c8y_Network:{c8y_DHCP:{enabled:a.enabled?1:0,addressRange:a.addressRange,dns1:a.dns1,dns2:a.dns2,domainName:a.domainName}}};Promise.all(i.create(n),i.create(r)).then(_.partial(l,a.enabled?o("Sent operation to apply LAN and DHCP settings."):o("Sent operation to apply LAN settings."),s.lanDhcpForm))},s.$watch("device",function(e){_.update(e,"c8y_Network.c8y_LAN.enabled",c),_.update(e,"c8y_Network.c8y_DHCP.enabled",c)}),t.getSystemOptionValue({category:"messaging",key:"provider"},!1).then(function(e){s.smsEnabled=!!e})}]);