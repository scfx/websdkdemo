"use strict";function _objectSpread(n){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?Object(arguments[e]):{},i=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&i.push.apply(i,Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.forEach(function(e){_defineProperty(n,e,t[e])})}return n}function _defineProperty(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}!function(){function e(t,e,n,i,r,o,c,u,a,p,g,l,s,d,f,h,v,y,m){var C,D,G,b=this,S="c8y_IsDeviceGroup",w={};function T(e){D=e,t.currentGroup=e,b.currentGroup=e}function O(){var e;return D?g.isGroup(D)&&(e="function"==typeof _.get(t,"paging.refresh")?t.paging.refresh().then(I):P().then(j).then(I)):e=g.getTopLevelGroups("devicemanagement"===m.getCurrentContextPath(),{withChildren:!1,pageSize:20,skipChildCount:!0}),e}function P(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return e.pageSize||(e.pageSize=20),e.withChildren=!1,o.children(D,"childAssets",{skipDetail:!0,params:e})}function j(e){if(k(e)){var n=e.data;0===o.onChildren(e).length&&(n=_objectSpread({},n,{next:!1})),t.paging=c.createPaging(n,P)}else e.paging&&(t.paging=e.paging);return e}function k(e){return"number"==typeof e.status}function I(e){return k(e)?o.onChildren(e):e}function A(e){G=(G=G||[]).concat(e),t.items=G,b.items=G}function L(e){return w={},G&&(G.length=0),e}function $(){delete t.newGroup}function x(e){D?f.updateGroupChildren(D):f.addGroupNavigation(e)}function N(e){n.url("/device/".concat(e.id))}function M(e){return!z(e)&&!u.isDeviceOrChildDevice(e)}function z(e){return g.isGroup(e)||s.isDynamicGroup(e)}function E(){t.refreshLoading=!0,O().then(L).then(A).finally(function(){t.refreshLoading=!1})}function H(e){return"number"==typeof R(e)}function R(e){return"number"==typeof e.childCount?e.childCount:"number"==typeof w[e.id]?w[e.id]:void 0}_.assign(b,{c8yConfig:d,getTitle:function(){var e;e=D?D.name:v("Groups");return e},getSubtitle:function(){return G?y.getPlural(G.length,"Showing 1 item","Showing {{$count}} items",{}):void 0},isDeviceListViewEnabled:function(){return s.isDynamicGroup(b.currentGroup)},hasChildCount:H,childCount:R,fetchChildCount:function(n){if(!H(n)&&void 0===w[n.id]){w[n.id]="loading";var e=s.isDynamicGroup(n)?s.getChildCount(n):g.getItemsCount(n);e.then(function(e){w[n.id]=e},function(){delete w[n.id]})}}}),_.assign(t,{addNewGroup:function(){t.newGroup={groupType:i.groupId?p.getDeviceSubgroupType():p.getDeviceGroupType(),name:""},b.newGroup=t.newGroup},cancelNewGroup:$,refresh:E,loadNext:function(){t.paging.loading=!0,t.paging.next().then(j).then(I).then(A).finally(function(){t.paging.loading=!1})},onClickEditGroup:function(e){h.editGroup(e)},onClickDeleteGroup:function(e){h.deleteGroupWithConfirmation(e).then(_.partial(_.pull,t.items,e))},onClickUnassignDevice:function(e){return h.unassignDevice(D,e).then(function(){return _.remove(G,{id:e.id})})},onClickDeleteDevice:function(e){return h.deleteDeviceWithConfirmation(e,M(e)).then(function(){return _.remove(t.items,{id:e.id})})},saveNewGroup:function(e){var n=function(e){var n=_.cloneDeep(e);return n[S]={},n.type=n.groupType.type,delete n.groupType,n}(e),t=D?o.createChildAsset(n,D):o.createConfirm(n);return t.then(c.getResData).then(x),t.then(function(){a.success(y.getString('Group "{{name}}" created.',e)),O().then(L).then(A),$()})},drillDown:function(e){n.url("/group/".concat(e.id))},getLinkToDM:function(e){var n={deviceId:e.id};return r(C||"")(n)},goToDeviceDetails:N,goToDeviceAlarms:function(e){if(_.some(l.getTabsByURL("/device/".concat(e.id)),{name:"Alarms"}))return void n.url("/device/".concat(e.id,"/alarms"));N(e)},getIconForGroup:function(e){return g.getIconSpecs(e).iconOpen},isGroupOrDynamicGroup:z,isGroup:g.isGroup,isDeviceOrChildDevice:u.isDeviceOrChildDevice,isOtherItem:M,assignDevices:function(){h.assignDevices(D).then(E)},deviceModel:u.model,deviceSerial:u.serial,c8yConfig:d,getDeviceTitle:function(e){return _.get(e,"name",y.getString("Device {{id}}",e))}}),function(){if(t.inSearchMode)return;var e=i.groupId,n=_.isUndefined(e);c.getStaticLinkTemplate("devicemanagementDeviceDetails").then(function(e){C=e}),(n?O():function(e){return o.detail(e,{withParents:!0,withChildren:!1}).then(c.getResData)}(e).then(T).then(O)).then(j).then(A)}(),b.inSearchMode=t.inSearchMode,e.$on("c8yGroupCreateAndAssign::created",function(){E()})}e.$inject=["$scope","$rootScope","$location","$routeParams","$interpolate","c8yInventory","c8yBase","c8yDevices","c8yAlert","c8yGroupTypesConfig","c8yGroups","c8yTabs","c8yDynamicGroups","c8yConfig","groupTypesHierarchyNavigator","groupsHierarchySvc","gettext","gettextCatalog","c8yApplication"],angular.module("c8y.groupsHierarchy").controller("groupsListCtrl",e)}();