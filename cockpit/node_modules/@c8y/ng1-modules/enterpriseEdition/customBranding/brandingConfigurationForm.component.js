"use strict";!function(){function n(r,n,t,e,i,o,a,c,l,s,u,d,f,g){var p,m,b,y,v=g("humanizeAppName"),h=this,I={html_title:B,favicon:function(n){h.favicon=n?n.fileSrc:"",p&&p.document.querySelector("link[rel=icon]")&&(p.document.querySelector("link[rel=icon]").href=n?n.fileSrc:"")},"navigator-font-family":function(n){S("navigator-font-family",a.getFontFamilyCssVar(n))},appLogo:function(n){return S("navigator-platform-logo",n?"url(".concat(n.fileSrc,")"):"")},"brand-logo-img":function(n){return S("brand-logo-img",n?"url(".concat(n.fileSrc,")"):"")},"__import-font":function(n){var e=document.createElement("style");e.innerText="@import url('".concat(n,"')"),w().contentDocument.head.appendChild(e),p&&p.document.head.appendChild(e)}},N=!!window.MSInputMethodContext&&!!document.documentMode;function w(){return document.querySelector("#previewBrowser")}function C(){return h.isLoading=!0,n.all({schema:i.getSchema(),form:i.getForm(),options:i.getSchemaFormOptions(),branding:i.getBranding(),app:d.getCurrent()}).then(function(n){var e=n.schema,t=n.form,o=n.options,i=n.branding,a=n.app;_.defaults(i,{c8y_less_variables:{}}),b=_.cloneDeep(i),_.assign(h,{schema:e,form:t,options:o,branding:i}),y=a,w().src=d.getHref(y),w().onload=function(){w().appTitle=w().contentDocument.title,B(),R()},r.$watchCollection("vm.branding.c8y_less_variables",R)}).finally(function(){h.isLoading=!1})}function B(n){var e=n||A();h.title="".concat(e," - ").concat(w().appTitle),p&&(p.document.title="".concat(e," - ").concat(p.appTitle),p.C8Y_PREVIEW.globalTitle=e)}function A(){return _.get(h,"branding.c8y_less_variables.html_title")||u.appOption("globalTitle")}function R(){h.isLoading||_.forOwn(h.branding.c8y_less_variables,function(n,e){I[e]?I[e](n):S(e,n)})}function S(n,e){T(n,e,w().contentDocument.documentElement),p&&T(n,e,p.document.documentElement)}function T(n,e,t){var o=a.keyToCssVar(n);"navigator-platform-logo-height"===o?t.style.setProperty("--".concat(o),"".concat(e,"%")):t.style.setProperty("--".concat(o),_.isNumber(e)?"".concat(e,"px"):e)}function P(){return o.state().then(k)}function k(n){var e=h.state;h.state=n,e&&e.RUNNING&&!n.RUNNING&&l.success(s("Branded applications created.")),e&&e.WAITING&&n.RUNNING&&l.success(s("Branded applications will be created.")),(n.RUNNING||n.WAITING)&&t(P,2e3)}_.assign(h,{$onInit:function(){c&&P();return C()},canSave:function(){return!(_.get(r,"platformConfigurationForm1.$invalid")||_.get(r,"platformConfigurationForm2.$invalid"))},save:function(){var t=[],o=i.BINARY_VARS;return h.branding.binary_ref={},_.each(o,function(e){if(h.branding.c8y_less_variables[e]){var n=i.saveBinary(e,h.branding.c8y_less_variables[e],b.binary_ref,b.c8y_less_variables[e]).then(function(n){h.branding.binary_ref[e]=_.pick(n,["id","name"])});t.push(n)}}),n.all(t).then(function(){return h.branding.c8y_less_variables=_.omitBy(h.branding.c8y_less_variables,function(n,e){return""===_.trim(n)||_.includes(o,e)}),i.saveConfiguration(h.branding,b.id).then(function(){return l.success(s("Branding saved."))})}).then(e.reload)},generate:o.wizardGenerate,preview:function(){p=window.open(d.getHref(y),"_blank"),function e(){clearInterval(m);m=setInterval(function(){if(p&&(p.C8Y_PREVIEW={globalTitle:A()},p.C8Y_APP)){var n=p.C8Y_APP.name;p.appTitle=v(n),clearInterval(m),R(),p.onunload=function(){return e()}}})}()},blocked:function(){var n=h.state;return!_.get(h,"branding.id")||_.get(n,"RUNNING")||_.get(n,"WAITING")},title:window.document.title,favicon:"favicon.ico",useMicroservice:c,applyConfiguration:function(){a.removeLegacyBrandedApplications().then(function(){return f({status:"info",title:s("Apply branding configuration"),body:s("You are about to apply the branding configuration, making it visible to all subtenants. Do you want to proceed?"),labels:{ok:s("Apply")}})}).then(function(){a.deploy(h.branding.c8y_less_variables).then(function(){return l.success(s("Branding configuration is being applied. It usually takes less than a minute."))},function(n){l.danger(u.getResErrorMessage(n))})})},showPreview:!N,removeAppliedBranding:function(){f({status:"info",title:s("Remove branding"),body:s("You are about to remove applied branding.\n        If you have any extra customization options set, they will be reset.\n        The default branding will be shown to all subtenants. Do you want to proceed?"),labels:{ok:s("Remove")}}).then(function(){a.reset().then(function(){return l.success(s("Branding has been removed."))})})},resetForm:function(n){f({status:"info",title:s("Reset branding configuration"),body:s("You are about to reset the branding configuration to the previously saved settings.\n        Do you want to proceed?"),labels:{ok:s("Reset")}}).then(function(){C().then(function(){n&&n.$setPristine(),l.success(s("Branding configuration has been reset."))},function(n){return l.danger(n)})})}})}n.$inject=["$scope","$q","$timeout","$route","c8yBrandingConfigurationUi","c8yBrandingConfiguration","c8yBrandingDeploy","USE_BRANDING_MICROSERVICE","c8yAlert","gettext","c8yBase","c8yApplication","c8yModal","$filter"],angular.module("c8y.custom-branding").component("c8yBrandingConfigurationForm",{templateUrl:":::PLUGIN_PATH:::/customBranding/brandingConfigurationForm.html",controller:n,controllerAs:"vm"})}();