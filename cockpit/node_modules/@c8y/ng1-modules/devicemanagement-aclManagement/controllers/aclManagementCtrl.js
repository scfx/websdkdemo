"use strict";angular.module("c8y.aclManagement").controller("aclManagementCtrl",["$scope","$q","c8yBase","c8yUser","c8yUserGroup","c8yAlert","gettext","gettextCatalog",function(t,e,n,s,i,r,o,c){var u={},a=n.createEnum([o("GROUP"),o("USER")]);function l(){t.user={},t.permission={},t.permission.type=null,t.permission.scope=null,t.permission.access=null,t.permission.source=null,t.sourceType=a.GROUP,t.addPermission=!0,s.current().then(function(e){t.allowEdit=s.hasRole(e,"ROLE_USER_MANAGEMENT_ADMIN")})}function p(e){return e&&null!==e&&""!==e}function d(e){var n=e.split(":");return{scope:{value:n[0]},type:n[1],access:{value:n[2]}}}function m(e){i.save(e).then(_.partial(r.success,o("Permissions updated."))).then(v).then(g)}function f(e){delete e.name,s.save(e).then(_.partial(r.success,o("Permissions updated."))).then(h).then(g)}function g(){l()}function h(){var e=s.listAll();e.then(function(e){t.users=e,_.forEach(e,function(e){e.name=e.id})}),P(e).then(function(e){t.userPermissions=e})}function v(){var e=i.list(u);e.then(function(e){t.groups=e,t.sources=t.groups}),P(e).then(function(e){t.groupPermissions=e})}function y(e){return e.toLowerCase().replace("_"," ")}function P(e){return e.then(_.partialRight(_.map,R))}function R(e){return{source:e,permissions:e.devicePermissions[t.device.id]||[]}}function S(e,n,s){var i=e.source;!function(e,n){e[t.device.id]=_.filter(e[t.device.id],function(e){return e!==n})}(i.devicePermissions,n),s(i)}t.emptyPermission=function(e){var n=(e||{}).permissions;return n&&n.length},t.toggleAddPermission=function(){t.addPermission=!t.addPermission},t.sourceTypes=a.values(),t.setSourceType=function(e){t.sourceType=e},t.create=function(e){var n=e.source,s=n.devicePermissions[t.device.id]||[];n.devicePermissions[t.device.id]=_.union(s,[function(e){return[e.scope.value,e.type,e.access.value].join(":")}(e)]),t.sourceType===a.GROUP?m(n):f(n)},t.cancel=g,t.isValid=function(e){return p(e.source)&&p(e.scope)&&p(e.type)&&p(e.access)},t.humanizeScope=function(e){return"*"===e?c.getString("all types of objects"):"MANAGED_OBJECT"===e?y(e):"".concat(y(e),"s")},t.humanizeAccess=function(e){return"*"===e?c.getString("Read and write"):"ADMIN"===e?c.getString("Write"):c.getString("Read")},t.humanizeFragment=function(e){return"*"===e?c.getString("any"):e},t.translatePermission=function(e){var n=e.split(":");return[c.getString(n[0]),n[1],c.getString(n[2])].join(":")},t.removeGroupPermission=_.partialRight(S,m),t.removeUserPermission=_.partialRight(S,f),t.helpText=o('"Check user permissions" section allows you to verify permissions granted to selected user for the device also inherited from parent devices or assinged to global role. "Granted permissions" section allows you to check and manage permissions for the device.'),t.$watch("user.selected",function(e){e&&s.getDevicePermissions(e,t.device.id).then(n.getResData).then(_.partialRight(_.map,d)).then(function(e){t.permissions=e})}),t.$watch("device",function(e){_.isObjectLike(e)&&0<_.keys(e).length&&(h(),v())}),t.$watch("sourceType",function(e){delete t.permission.source,e===a.GROUP?t.sources=t.groups:t.sources=t.users}),l()}]);