"use strict";angular.module("c8y.parts.vendMeDeviceControl").controller("vendMeDeviceControlCtrl",["$scope","c8yDeviceControl","c8yDevices","c8yModal","c8yInventory","c8yAlert","gettext",function(i,o,t,n,e,a,c){var r=[{text:c("Executive"),code:"EXE",bitmask:"0x0001",val:"a"},{text:c("MDB"),code:"MDB",bitmask:"0x0002",val:"m"},{text:c("Free vend"),code:"FREE",bitmask:"0x0008",val:"f"},{text:c("DDCMP on RS232 #1"),code:"DDCMP1",bitmask:"0x0004",val:"d"},{text:c("DEX on RS232 #1"),code:"DEX1",bitmask:"0x0010",val:"x"},{text:c("DDCMP on RS232 #2"),code:"DDCMP2",bitmask:"0x0100",val:"D"},{text:c("DEX on RS232 #2"),code:"DEX2",bitmask:"0x0200",val:"X"}],s=[{text:c("Operate as MDB Communications Gateway"),code:"MDB_COMMGW",val:"0x00000001",require:"m"},{text:c("VMC supports undefined credit"),code:"MDB_UNCREDIT",val:"0x00000002",require:"m"},{text:c("Force not to use display"),code:"MDB_NODISPLAY",val:"0x00000004",require:"m"},{text:c("Use FTL File Id 2 (default 1)"),code:"MDB_2FTL",val:"0x00000008",require:"m"},{text:c("Deactivate MDB sniffer mode"),code:"MDB_NOSNIFFER",val:"0x00000010",require:"m"},{text:c("Sielaff OLM2 variant of Communications Gateway"),code:"MDB_CGWOLM",val:"0x00000020",require:"m"},{text:c("Sielaff CGW variant of Communications Gateway"),code:"MDB_CGWSIE",val:"0x00000040",require:"m"},{text:c("Remote cashless"),code:"REMOTECL",val:"0x00000080",require:"m"},{text:c("Use DDCMP list #2, RS232 #2"),code:"DDCMP_2LIST2",val:"0x00000400",require:"D"},{text:c("Use enhanced DDCMP @ 2400 on RS232 #2"),code:"DDCMP_ENHANCED2",val:"0x00000800",require:"D"},{text:c("Use DDCMP list 2 on RS232 #1"),code:"DDCMP_2LIST1",val:"0x00004000",require:"d"},{text:c("Use enhanced DDCMP @ 2400 on RS232 #1"),code:"DDCMP_ENHANCED1",val:"0x00008000",require:"d"}];function d(){i.$emit("message",{type:"success",text:c("Operation created")}),i.$emit("update","devicecontrol")}function u(){return r.filter(function(e){return e.active}).map(function(e){return e.val}).join("")}function l(e){var t=u();return!e.require||!(!t||!t.match(e.require))}i.$watch("device",function(e){if(_.isObjectLike(e)&&0<_.keys(e).length){var t=e.com_nsn_startups_vendme_fragments_MachineTechnicalInformation;if(t&&(function(e){e.maxCredit&&(i.credit=e.maxCredit),e.useResetCounters&&(i.useResetCounters=e.useResetCounters),i.coinChanger="DISABLED"!==e.coinChanger,i.billValidator="DISABLED"!==e.bill_validator,i.cashless2="DISABLED"!==e.cashless2,i.cashless1="DISABLED"!==e.cashless1}(t),t.protocolInfo)){var n=t.protocolInfo.id,o=t.protocolInfo.configuration;n&&function(n){r.forEach(function(e){var t=new RegExp(e.val);e.active=t.test(n)})}(n),o&&function(n){if(n){var o=parseInt(n,16);isNaN(n)||s.forEach(function(e){var t=parseInt(e.val,16);e.selected=(t|n)===o})}}(o)}}}),i.$watch(u,function(){s.forEach(function(e){e.selected=e.selected&&l(e)})}),i.visible=function(){var e=i.device;return e&&(t.supportsOperation(e,"v4e_Protocol")||t.supportsOperation(e,"v4e_SetMaxCredit"))},i.bitmask=s,i.setProtocol=function(){var e={deviceId:i.device.id,v4e_Protocol:{val:u(),bitmask:"0x".concat(i.bitmask.filter(function(e){return e.selected}).reduce(function(e,t){return e|parseInt(t.val,16)},0).toString(16))},description:c("Set protocol")};o.create(e).then(d,_.noop)},i.updateDevice=function(){e.update({id:i.device.id,com_nsn_startups_vendme_fragments_MachineTechnicalInformation:i.device.com_nsn_startups_vendme_fragments_MachineTechnicalInformation}).then(_.partial(a.success,"Vending machine updated!"))},i.setCredit=function(e){var t=Math.round(100*e),n={deviceId:i.device.id,v4e_SetMaxCredit:{value:t},description:c("Set max credit to ")+t+c("cents")};o.create(n).then(d,_.noop)},i.getDeviceLog=function(){var e={deviceId:i.device.id,v4e_Log:{},description:c("Request device Log")};o.create(e).then(d,_.noop)},i.showOption=l,i.confirmFreeVend=function(e){e&&n({title:c("Confirm Free vend mode?"),body:c("This setting will enable all the products to be retrieved without payment. Are you sure you want to activate Free vend?")}).then(null,function(){i.proto.FREE.active=!1})},i.setVendingMachineSettings=function(e,t,n){e.com_nsn_startups_vendme_fragments_MachineTechnicalInformation[t]=n?null:"DISABLED"},i.setUseResetCounters=function(e,t){e.com_nsn_startups_vendme_fragments_MachineTechnicalInformation.useResetCounters=t},function(){i.proto={};var t=i.proto;r.forEach(function(e){t[e.code]=e})}()}]);