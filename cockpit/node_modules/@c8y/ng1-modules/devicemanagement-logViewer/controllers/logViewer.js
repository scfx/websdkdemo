"use strict";!function(){function e(i,n,o,e,a,t,s,l,r,c,u,f,d){var g=this,m="YYYY-MM-DDTHH:mm:ssZZ";function p(){i.filters={dateFrom:moment().subtract(1,"day"),dateTo:moment(),logFile:i.logTypes[0]&&i.logTypes[0].name||null,maximumLines:1e3},g.filters=i.filters}function y(e){var t=_.assign({deviceId:n.deviceId,fragmentType:"c8y_LogfileRequest",dateFrom:new Date(0).toISOString(),revert:!0,withTotalPages:!0},e);return s.list(t).then(h)}function h(e,t){i.operations&&!t||(i.operations=[]),e.forEach(function(e){i.operations.push(e)}),i.paging=e.paging}function L(){_.get(i.paging,"refresh")&&(i.realtimeAnimation=!1,i.refreshLoading=!0,i.paging.refresh().then(_.partialRight(h,!0)).finally(function(){i.refreshLoading=!1}),i.paging=null)}function v(e){if(e.c8y_LogfileRequest.file){var t=a.getIdFromUrl(e.c8y_LogfileRequest.file);if(t)return a.removeBinary(t)}return!1}function R(e){var t={id:e.id,status:e.status,c8y_LogfileRequest:null};return s.save(t)}function C(e){F(e)?i.selectedLog=e:i.selectedLog=void 0}function F(e){return e.c8y_LogfileRequest&&e.c8y_LogfileRequest.file}function q(e){return e&&"SUCCESSFUL"===e.status}function T(e){return e&&"FAILED"===e.status}function D(e,t){t&&!e?(g.shouldClose="disabled",o(function(){g.shouldClose="outsideClick"})):g.shouldClose="outsideClick"}i.requestLogfile=function(e){var t={deviceId:n.deviceId,description:u("Log file request"),c8y_LogfileRequest:{dateFrom:moment(e.dateFrom).format(m),dateTo:moment(e.dateTo).format(m),logFile:e.logFile,searchText:e.searchText||"",maximumLines:e.maximumLines}};s.createWithNotifications(t).then(function(e){e.created.then(L),e.completed.then(function(e){e.status===s.status.SUCCESSFUL?(_.assign(t,e),C(t)):e.status===s.status.FAILED&&"Operation cancelled by user."!==e.failureReason&&(e.failureReason?c.danger(f('Could not load file: "{{failureReason | translate}}".',e)):c.danger(u("Could not load file.")))},_.noop,function(e){_.assign(t,e),C(t)}).then(L)})},i.hasLogFile=F,i.selectLogfile=C,i.isBinary=function(e){return e&&e.c8y_LogfileRequest&&e.c8y_LogfileRequest.file&&!!a.getIdFromUrl(e.c8y_LogfileRequest.file)},i.download=d.download,i.cancel=function(e){return"PENDING"===e.status&&s.cancel(e).then(_.partial(c.success,u("Log file request cancelled."))).then(L)},i.remove=function(e){return r({title:u("Delete log file"),body:u("You are about to delete this log file. Do you want to proceed?"),status:"danger",labels:{ok:u("Delete")}}).then(_.partial(v,e)).then(_.partial(R,e)).then(_.partial(c.success,u("Log file deleted."))).then(L)},i.statusIcon=function(e){return s.getStyle(e).icon},i.statusClass=function(e){return s.getStyle(e).cls},i.isSuccessful=q,i.isPending=function(e){return e&&"PENDING"===e.status},i.isFailed=T,i.isCompleted=function(e){return q(e)||T(e)},i.refresh=L,i.loadNext=function(e){i.paging.loading=!0,(e?y({pageSize:e}):i.paging.next().then(h)).finally(function(){i.paging.loading=!1})},i.getOperationDesc=function(e){return e.description||u("no description available")},i.$watch("vm.datePickerToOpen",D),i.$watch("vm.datePickerFromOpen",D),g.shouldClose="outsideClick",g.datePickerToOpen=!1,g.datePickerFromOpen=!1,t.detail(n.deviceId).then(e.getResData).then(function(e){i.logTypes=_.map(e.c8y_SupportedLogs,function(e){return{name:e}}),g.logTypes=i.logTypes}).then(p),y();var I=i.$id,S="/operations/".concat(n.deviceId),w=l.realtimeActions();_.forOwn(w,function(e){l.addListener(I,S,e,function(e,t){if(_.has(t,"c8y_LogfileRequest")){L();var n=i.selectedLog;n&&n.id===t.id&&e===w.UPDATE&&(n.c8y_LogfileRequest=t.c8y_LogfileRequest)}})}),l.start(I,S),i.$on("$destroy",function(){l.stop(I,S),l.destroySubscription(I,S)})}e.$inject=["$scope","$routeParams","$timeout","c8yBase","c8yBinary","c8yDevices","c8yDeviceControl","c8yRealtime","c8yModal","c8yAlert","gettext","gettextCatalog","logViewer"],angular.module("c8y.logViewer").controller("logViewerCtrl",e)}();