"use strict";!function(){function e(n,t,h){r.$inject=["$q","$interval","$window","c8yRemoteAccess","$uibModal","c8yModal","c8yAlert","c8yBase","c8yInventory","c8yDevices","gettextCatalog"],i.$inject=["$routeParams","c8yBase","c8yDevices","c8yRemoteAccess"],c.$inject=["$routeParams"];var e="device/:deviceId",o={name:h("Remote access"),icon:"window-restore",template:'<c8y-remote-access-endpoints-list device="vm.id"></c8y-remote-access-endpoints-list>',controllerAs:"vm",controller:c,showIf:i};function c(e){this.id=e.deviceId}function i(e,n,t,o){var c=e.deviceId;return t.detail(c).then(n.getResData).then(function(e){return t.supportsOperation(e,"c8y_RemoteAccessConnect")}).then(function(e){return e&&o.isMicroServiceAvailable(c)})}function r(o,i,r,s,c,a,d,n,t,u,l){return{getSuggestedIPAddresses:function(e){var t=[{label:"localhost",ipAddress:s.DEFAULT_HOST}];return v(e).then(function(e){var n=_.map(e,function(e){return{label:u.properName(e),ipAddress:u.getIPAddress(e)}});return _.filter(t.concat(n),"ipAddress")})},getChildDevices:v,getEndpoints:p,addEndpoint:function(e){var n=g(e).then(function(e){return c.open({size:"md",component:"c8yRemoteAccessEndpointModal",resolve:{rootDevice:_.constant(_.cloneDeep(e))}}).result});return n.then(function(){return d.success(h("Endpoint saved."))})},editEndpoint:function(n){var e=o.all({deviceDetails:g(n.device),endpointDetails:p(n.device).then(function(e){return _.find(e,function(e){return e.config.id===n.config.id})})}).then(function(e){var n=e.deviceDetails,t=e.endpointDetails;return c.open({size:"md",component:"c8yRemoteAccessEndpointModal",resolve:{rootDevice:_.constant(_.cloneDeep(n)),endpoint:_.constant(_.cloneDeep(t))}}).result});return e.then(function(){return d.success(h("Endpoint saved."))})},removeEndpoint:function(e){var n={title:h("Delete endpoint"),body:l.getString('You are about to delete endpoint "{{config.name}}" from device "{{device.name}}". Do you want to proceed?',e),labels:{ok:h("Delete")},status:"danger"},t=a(n);return t.then(function(){return s.remove(e.device,e.config)}).then(function(){return d.success(h("Endpoint deleted."))})},connectEndpoint:function(c){return s.getConnectionParams(c.device,c.config).then(function(e){var n=m(c);r.localStorage.setItem(n,JSON.stringify(e));var t="".concat(e.protocol.clientWindowPath,"?paramsId=").concat(n),o=r.open(t,n,e.protocol.clientWindowParams);return o.opener=null,f(o,n,e),_.assign(e,{paramsId:n,clientWindow:o})})},isLocalEndpoint:function(e){return _.includes(["localhost",s.DEFAULT_HOST],e.config.hostname)},resumeMonitoring:function(e){var n=m(e);if(r.localStorage.getItem(n)){var t=r.open("",n);if(t.opener=null,t)return function(e,n,t){return s.getConnectionParams(e.device,e.config).then(function(e){return f(n,t,e),_.assign(e,{paramsId:t,clientWindow:n})})}(e,t,n)}return o.resolve()}};function v(e){return t.childDevices(e)}function p(e){return g(e).then(function(n){return s.list(n).then(function(e){return _.map(e,function(e){return{device:n,config:e}})})})}function f(e,t,o){var c=i(function(){var n;try{n=JSON.parse(r.localStorage.getItem(t))}catch(e){n={}}_.assign(o,n),e.closed&&(i.cancel(c),r.localStorage.removeItem(t),o.status=void 0,o.clientWindow=void 0)},1e3)}function m(e){return"remoteConnection_".concat(e.device.id,"_").concat(e.config.id)}function g(e){return _.isObjectLike(e)?o.when(e):t.detail(e).then(n.getResData)}}return{$get:r,provideSettingsPage:function(){function e(e){return e.isAvailable({name:"cloud-remote-access",type:"MICROSERVICE"})}e.$inject=["c8yApplication"],t.addNavigation({parent:h("Settings"),name:h("Remote access"),path:"remoteAccessSettings",icon:"key",priority:2e3,showIf:e}),n.when("/remoteAccessSettings",{template:"<c8y-remote-access-settings />"})},provideDeviceTab:function(){n.when("/".concat(e),o)}}}e.$inject=["c8yViewsProvider","c8yNavigatorProvider","gettext"],angular.module("c8y.remoteAccess").provider("c8yRemoteAccessUI",e)}();