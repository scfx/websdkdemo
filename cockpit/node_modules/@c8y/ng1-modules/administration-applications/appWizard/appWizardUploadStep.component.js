"use strict";!function(){function e(c,e,l,r,i,t,n,s,p,a){var o,u=this,d={inProgress:!1,progress:0,label:null,deferred:null,cancelled:!1};function f(e){var t=c.defer();return d.deferred=t,d.cancelled&&t.reject({cancelled:!0}),c.when(e).then(t.resolve,t.reject),t.promise.catch(function(e){var t=e.cancelled;t&&(d.cancelled=t)}),o=function(){_.has(e,"abort")&&e.abort(),d.cancelled=!0,t.reject({cancelled:!0})},t.promise}function g(e,t){return _.head(_.compact(_.at(e,t)))}function h(e){var t=c.resolve();return _.get(u.wizardCtrl.data.chosenMethod,"expectedType")!==e&&(t=c.reject({type:"typeValidation",message:a.getString(u.wizardCtrl.data.chosenMethod.invalidFileTypeMessage)})),t}function v(e){return y(e).then(function(e){return _.get(e,"type")||(_.get(e,"apiVersion")?"MICROSERVICE":"HOSTED")}).catch(function(){return"HOSTED"})}function y(e){return t.getJsonData(e,{filename:"cumulocity.json"})}function m(){d.cancelled=!0,o&&o()}_.assign(u,{processingStatus:d,createAppAndUploadArchive:function(e){var t;return d.inProgress=!0,d.progress=0,d.cancelled=!1,v(e).then(h).then(function(){return function(i){var u={manifest:{},resourcesUrl:"/"};return d.label=p("Creating application"),v(i).then(function(t){return"HOSTED"===t?y(i).catch(function(){return{}}).then(function(e){return{appType:t,appModel:e}}):{appType:t}}).then(function(e){var t=e.appType,n=e.appModel,r=function(e,t,n){var r=_.get(n,"name",e.name.replace(/.zip$/i,""));return"MICROSERVICE"===t&&(r=r.replace(/-\d+\.\d+\.\d+(-SNAPSHOT)?$/,"")),r}(i,t,n),a=function(e){return e.replace(/[^a-zA-Z0-9-_]/g,"")}(r),o=function(e,t){var n=_.get(e,"key");return n||(n="".concat(_.kebabCase(t),"-key")),n}(n,a),c=function(e,t){return _.get(e,"contextPath",t.toLowerCase())}(n,a);return _.assign(u,{type:t,name:r,key:o,contextPath:c})}).then(r.revertType).then(function(e){var t="MICROSERVICE"===e.type?r.save(e).then(l.getResData):r.trySave(e);return"MARKET"===e.availability&&"HOSTED"===e.type?c.all({newApp:t,tenant:s.current()}).then(function(e){var t=e.newApp,n=e.tenant;return s.addApplication({id:n.name},t),t}):t}).finally(function(){d.progress+=10})}(e)}).then(function(e){t=e}).then(function(){return f(function(e){return"MICROSERVICE"===e.type?n({title:p("Subscribe to microservice"),size:"sm",labels:{ok:p("Subscribe"),cancel:p("Don't subscribe")},body:p("You are about to subscribe to the microservice after upload. Do you want to subscribe to it?"),status:"info"}).then(function(){return!0},function(){return!1}).then(function(e){u.activateAfterUpdate=e}):c.resolve()}(t))}).then(function(){return f(function(e,t){d.label=p("Uploading file");var n=r.uploadArchive(e,t,{silentError:!0});return n.progress(function(e){d.progress=10+e.loaded/e.total*90}).then(l.getResData).then(_.partial(r.setActiveArchive,e)).then(function(){return e}),n}(t,e))}).then(function(){return f(function(e){var t=c.resolve();return"MICROSERVICE"===(u.wizardCtrl.data.createdApp=e).type?t=function(a,o){return s.current(!0).then(function(e){var t=e.applications.references,n=t.some(function(e){var t=e.application;return t.id===o.id}),r=c.resolve();return!n&&a?r=s.addApplication(e.name,o,{silentError:!0}).catch(function(e){409===e.status?i.warning(p("Could not subscribe to the microservice because another application with the same context path is already subscribed.")):i.danger(l.getResErrorMessage(e))}):n&&!a&&(r=s.removeApplication(e.name,o)),r})}(u.activateAfterUpdate,u.wizardCtrl.data.createdApp).then(function(){return u.wizardCtrl.goTo("success")}):u.wizardCtrl.goTo("success"),t}(t))}).catch(function(e){t&&r.remove(t,{force:!0}),function(e){"typeValidation"===e.type?i.warning(e.message,e.details):e.cancelled||i.danger(function(e){var t=g(e,["data.message","data.error","errorMessage"])||p("An internal error occurred, try to upload again.");return a.getString(t)}(e),function(e){return g(e,["data.details","errorDetails"])}(e))}(e)}).finally(function(){d.inProgress=!1,d.progress=100})},goTo:function(e){m(),u.wizardCtrl.goTo(e)}}),e.$parent.$on("modal.closing",m),e.$watch(function(){return u.wizardCtrl.getCurrentStep()},function(e){"upload"===_.get(e,"stepId")&&u.wizardCtrl.data.appUpload&&(u.wizardCtrl.data.appUpload.files=[{file:null}])})}e.$inject=["$q","$scope","c8yBase","c8yApplication","c8yAlert","c8yZip","c8yModal","c8yTenant","gettext","gettextCatalog"],angular.module("c8y.parts.applications").component("appWizardUploadStep",{require:{wizardCtrl:"^c8yWizardStep"},templateUrl:":::PLUGIN_PATH:::/appWizard/appWizardUploadStep.html",controller:e,controllerAs:"vm"})}();