"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}!function(){function e(e,r,t,C){l.$inject=["$q","$routeParams"],d.$inject=["$q","$location","$uibModal","c8yBase","c8yUser","c8yRoles","c8yUserRolesUi","c8yUserInventoryRoles","c8yUserUtil","c8yPermissions","c8yAlert","$injector","passwordStrengthCheckerFactory","c8yModal","gettextCatalog"];var n="c8y-user",o=["ROLE_USER_MANAGEMENT_READ","ROLE_USER_MANAGEMENT_ADMIN","ROLE_USER_MANAGEMENT_CREATE"],L=c(),O=c("/new"),M=c("/:userId"),a={template:"<c8y-user-list-view></c8y-user-list-view>"},i={priority:1e3,icon:n,name:C("Profile / Global roles"),template:'<c8y-user-detail-view user-id="$resolve.userId"></c8y-user-detail-view>',resolve:{userId:["$route",function(e){return e.current.params.userId}]}},u={priority:-1e3,icon:"c8y-atom",name:C("Application access"),template:'<c8y-user-application-access user="$resolve.user"></c8y-user-application-access>',resolve:{user:["$route","c8yUser","c8yBase",function(e,t,n){return t.detail(e.current.params.userId).then(n.getResData).then(function(r){return r.owner?t.detail(r.owner).then(n.getResData).then(function(e){return r._owner=e,r}).catch(function(){return r}):r})}]}},s={data:l};return{initUi:function(){e.addNavigation({parent:{name:C("Accounts"),icon:"c8y-accounts"},name:C("Users"),path:c().replace(/^\//,""),icon:n,priority:5e3,routerLinkExact:!1,showIfPermissions:{anyRole:o}}),r.when(L,a),r.when(O,i),r.when(M,i),r.when(M,u),t.addTitle(M,s)},$get:d};function c(e){return"/users".concat(e||"")}function l(e,r){return e.when({title:r.userId})}function d(u,r,t,n,i,o,e,a,s,c,l,d,f,g,y){var p,h=f();return i.current().then(function(e){p=e.id}),{ROUTE_NEW_USER:O,fullName:function(e){return"".concat(e.firstName||""," ").concat(e.lastName||"")},toggleExpanded:function(e){var t=!e._expanded;(e._expanded=t)||!function r(e){_.forEach(e,function(e){e._expanded=t,r(e._owns)})}(e._owns);return e},createUserFlatTree:s.createUserFlatTree,visibleInList:function(e){return!_.get(e,"owner")||_.get(e,"_owner._expanded")},expandAll:function(e){_.forEach(e,function(e){e._expanded=!0})},collapseAll:function(e){_.forEach(e,function(e){delete e._expanded})},detailLink:v,editUser:function(e){r.path(v(e))},search:s.search,changeUser:function(e,r){var t={changeGlobalRoles:A,copyInventoryRoles:m,enable:b,disable:E,remove:w,delegate:T,removeDelegate:R},n="string"==typeof r?r:_.get(r,"name");return _.get(t,n,u.reject)(e,_.get(r,"data"))},getPasswordStrength:h.getStrengthForColor,getPasswordColor:h.getHexColorForColor,getPasswordIcon:h.getIconForColor,isTfaAvailable:i.isTfaAvailable,gotoList:function(){r.path(L)},userHierarchyActive:s.userHierarchyActive,hasAppManagement:function(e){return c.hasAnyRole(["ROLE_APPLICATION_MANAGEMENT_READ","ROLE_APPLICATION_MANAGEMENT_ADMIN"],e)},isUndeletable:function(e){return p?S(e)||c.hasRole(e,"ROLE_TENANT_ADMIN"):void 0},isCurrent:S,warnAboutUserLogOutIfNeeded:function(e,r){var t=r.rolesChanged,n=r.passwordChanged||t,o=d.get("c8yAuthBridgeService").getPreferredLoginOption(),a="OAUTH2_INTERNAL"===o.type,i=!_.isUndefined(o.sessionConfiguration);return e.id&&n&&a&&i?g({title:C("Force user to log out"),body:y.getString('Updating password or global roles will force user "{{userName}}" to log out. Do you want to proceed?',e),status:"warning",size:"sm",labels:{ok:C("Update and log out user")}}):u.resolve()},EXTERNAL_ORIGIN_TEXT:C("You cannot edit the user since it is managed via your authorization server."),EXTERNAL_ORIGIN_TEXT_FOR_USERS_LIST_VIEW:C("You cannot edit global roles for user with external origin, since it is managed via your authorization server."),EXTERNAL_ORIGIN_DYNAMIC_ACCESS_MAPPING_EXCEPTION_TEXT:C("You cannot edit the user since it is managed via your authorization server, but the configuration allows for changing global roles."),LOCAL_USER_TEXT:C("You are about to create a local user which will not be able to log in via single sign-on.")};function v(e){return M.replace(/:userId/,e.id)}function A(e,r){var t=_.map(r.roles,"id");return o.global.updateGroups(e,t)}function m(o){return u.all({copy:e.copyFromUserDialog(o),assignedRoles:i.listInventoryRoles(o)}).then(function(e){var r="replace"===e.copy.process,t=e.copy.roles,n=_.keyBy(e.assignedRoles.data.inventoryAssignments,"managedObject");return a.copyUserRoles(t,n,o,r)})}function E(e){return i.disable(e)}function b(e){return i.enable(e)}function w(r){var e=0<r.subusersCount;return t.open({component:"c8yUserRemovalModal",resolve:{user:function(){return r}}}).result.then(function(e){return e.deleteAll?function(e){return I(e,{deep:!0}).then(function(e){return e.reduce(function(e,r){return e.then(function(){return i.remove(r)})},u.resolve())})}(r):_.isUndefined(e.newOwner)?u.resolve():function(e,t){return I(e,{deep:!1}).then(function(e){return e.reduce(function(e,r){return e.then(function(){return i.save({id:r.id,owner:t})})},u.resolve())})}(r,e.newOwner)}).then(function(){return i.remove(r)}).then(function(){return function(e){return l.success(y.getString('User "{{userName}}" deleted.',e))}(r)}).then(function(){return{removeUser:!e,refresh:e}})}function I(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};if(0===e.subusersCount)return u.resolve([]);var a=[];return i.list({owner:e.id,withSubusersCount:!0,pageSize:n.MAX_PAGESIZE}).then(function e(r){a.push.apply(a,_toConsumableArray(r));var t=r.statistics.pageSize,n=r.paging.next,o=r.length>=t;return n&&o?r.paging.next().then(e):u.resolve(a)}).then(function(e){if(!t.deep)return e;var r=e.map(function(e){return I(e,t)});return u.all([].concat(_toConsumableArray(e),_toConsumableArray(r))).then(_.flattenDeep)})}function T(e){return i.delegateTo(e).then(_.partial(N,e))}function N(e){return l.success(y.getString('You delegated to user "{{userName}}".',e))}function R(e){var r={id:e.id,delegatedBy:null};return i.save(r).then(_.partial(U,e))}function U(e){return l.success(y.getString('You removed delegation from user "{{userName}}".',e))}function S(e){return p&&p===e.id}}}e.$inject=["c8yNavigatorProvider","c8yViewsProvider","c8yTitleProvider","gettext"],angular.module("c8y.users").provider("c8yUsersUi",e)}();