"use strict";!function(){function e(a,u,c,e,f,l,d,g,r,n,h,E,p,t,m,w){var s=this;_.assign(s,{cancel:E.gotoList,shouldDisableGlobalRolesCheckbox:S,isUserAndRolesFormPristine:function(){return c.forms.userForm.$pristine&&c.forms.rolesForm.$pristine},isUserFormInvalid:function(){return!(!P(c.currentUser,c.user)||c.hasExternalOrigin)&&c.forms.userForm.$invalid},isRolesFormInvalid:function(){return!S()&&c.forms.rolesForm.$invalid}});var o,N,i,U,v=e.userId,R=["business"];function A(){v?l.detail(v).then(function(e){return e.data}).then(T).then(function(){return l.getUserTfaSettings(c.user).then(f.getResData).then(function(e){c.userTfaEnforced=!!e.tfaEnforced})}):(T({enabled:c.isNew=!0}),G(w("New user"),!0))}function T(e){N=e.email,e.devicePermissions=e.devicePermissions||{},c.user=e,c._groups=y(e),c.password.showPassword=c.isNew,c.hasExternalOrigin=l.hasExternalOrigin(e),c.isNew&&(_.forEach(c.groups,function(e){_.includes(R,e.name)&&(c._groups[e.id]=!0)}),i&&g.warning(E.LOCAL_USER_TEXT)),c.hasExternalOrigin&&t.detail("oauth2",{silentError:!0}).then(function(e){return c.mapRolesOnlyForNewUser=_.get(e,"onNewUser.dynamicMapping.configuration.mapRolesOnlyForNewUser",!1),c.mapRolesOnlyForNewUser}).then(function(e){e?g.warning(E.EXTERNAL_ORIGIN_DYNAMIC_ACCESS_MAPPING_EXCEPTION_TEXT):g.warning(E.EXTERNAL_ORIGIN_TEXT)})}function y(e){return _.reduce(_.get(e,"groups.references"),function(e,n){return e[n.group.id]=!0,e},{})}function O(e){c.groups=e}function I(e){c.currentUser=e}function L(n){c.saving=!0;var e=function(){return g.success(w("User saved."))},r=E.gotoList,t=!(n.id&&!n.groups),s=_(c._groups).map(function(e,n){return e&&parseInt(n,10)}).filter().value(),o=t?function(e){return d.updateGroups(e||n,s)}:function(){return a.resolve()},i=c.forms.rolesForm.$dirty,u=c.password.showPassword;try{c.hasExternalOrigin?E.warnAboutUserLogOutIfNeeded(n,{rolesChanged:i,passwordChanged:u}).then(o).then(e).then(r).finally(function(){c.saving=!1}):E.warnAboutUserLogOutIfNeeded(n,{rolesChanged:i,passwordChanged:u}).then(function(){return l.current()}).then(function(e){return _.isEqual(e.userName,n.userName)}).then(function(e){return m.isActivatedFor("units-conversion")&&(e&&function(e){var n=_.get(e,"measurementUnit.value");p.set("unit",n)}(n),_.unset(n,"measurementUnit")),e}).then(function(e){return l.save(_.omit(n,"measurementUnit"),e)}).then(f.getResData).then(o).then(function(){return l.setUserTfaSettings(n,{tfaEnforced:!!c.userTfaEnforced})}).then(e).then(r).finally(function(){c.saving=!1})}catch(e){g.danger(e.message),c.saving=!1}}function G(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",n=1<arguments.length&&void 0!==arguments[1]&&arguments[1];return r.changeTitle({title:e},{skipTitleTranslation:!n})}function M(e){return l.hasRole(e,"ROLE_USER_MANAGEMENT_ADMIN")||l.hasRole(e,"ROLE_USER_MANAGEMENT_CREATE")}function P(e,n){return!(!e||!n)&&(!n.id||(e.id===n.id?l.hasRole(e,"ROLE_USER_MANAGEMENT_OWN_ADMIN"):l.hasRole(e,"ROLE_USER_MANAGEMENT_ADMIN")||l.hasRole(e,"ROLE_USER_MANAGEMENT_CREATE")))}function C(e){return _.get(c.user,"owner")&&o&&!o[e.id]}function S(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,n=M(c.currentUser),r=!e||!C(e),t=!!c.mapRolesOnlyForNewUser||!c.hasExternalOrigin;return!(n&&r&&t)}c.checkPassword=function(e){var n=!c.isNew,r=c.password.showPassword,t=r||function(e){return e.email!==N}(e);if(!n||!t)return L(e);var s=u.get("c8yModalService"),o="OAUTH2_INTERNAL"===u.get("c8yAuthBridgeService").getPreferredLoginOption().type,i=!(!c.currentUser||!c.user)&&c.currentUser.id===c.user.id&&r&&o;return h.askForPassword().then(function(e){return e?a.resolve():a.reject()}).then(function(){return i?s.confirmLogout(w("You will be logged out to apply your new password. Do you want to proceed?")):a.resolve()}).then(function(){return L(e)}).catch(function(e){e&&g.danger(f.getResErrorMessage(e)),A()})},c.$watch("user.userName",G),c.$watch("user.owner",function(e){e?l.detail(e).then(f.getResData).then(function(e){o=y(e),_.forEach(c._groups,function(e,n){c._groups[n]=e&&o[n]})}):o=null}),c.$watch("_groups",function(e){c.enforcedGroup&&(c.topLevelTfaEnforced=e[c.enforcedGroup.id])},!0),c.canEditUser=P,c.canEditUserGroups=M,c.canActivateUser=function(e,n){return!(!e||!n)&&e.id!==n.id},c.forms={},c.password={},c.saving=!1,c.showAcl=function(){var e=_.get(c.user,"devicePermissions"),n=_.keys(e);return f.getFlag("deprecated")||n.length},c.restrictedByOwner=C,c.$on("$destroy",function(){g.remove({text:E.EXTERNAL_ORIGIN_TEXT,type:"warning"}),g.remove({text:E.EXTERNAL_ORIGIN_DYNAMIC_ACCESS_MAPPING_EXCEPTION_TEXT,type:"warning"}),g.remove({text:E.LOCAL_USER_TEXT,type:"warning"})}),d.list(U).then(O).then(t.isSsoEnabled).then(function(e){i=e}).then(A).then(function(){return n.current().then(function(e){return l.getTenantTfaSettings(c.user,e.name)}).then(function(e){c.enforcedGroup=_.find(c.groups,{name:e.enforcedUsersGroup}),c.topLevelTfaEnforced=l.isEnforcedForUser(c.user,e)||c._groups[c.enforcedGroup.id]})}),l.current().then(I),E.userHierarchyActive().then(function(e){s.FEATURE_USER_HIERARCHY=e})}e.$inject=["$q","$injector","$scope","$routeParams","c8yBase","c8yUser","c8yUserGroup","c8yAlert","c8yTitle","c8yTenant","c8yUserUtil","c8yUsersUi","c8yUserPreferences","c8yLoginOptions","c8yBeta","gettext"],angular.module("c8y.users").component("c8yUserDetailView",{templateUrl:":::PLUGIN_PATH:::/userDetailView/userDetailView.html",controller:e,controllerAs:"vm"})}();