"use strict";!function(){function e(i,n,o,r,e){var a,l=this;function u(e){return a=e?[]:l.users,l.users=[],o.list(function(){var e=_.get(l.filters,"text"),n=_.map(_.get(l.filters,"globalRoles"),"id"),t=n.length?n.join(","):void 0;return{withSubusersCount:!0,username:e,groups:t,withApps:!1,withGroups:!1,withRoles:!1,onlyRoots:_.isEmpty(e)}}()).then(t)}function t(e){s(e),l.users.paging=e.paging}function s(e){var n=l.users,t=n.paging,s=o.getTfaStrategy(),u=[];return _.forEach(e,function(r){var e=_.find(a,{id:r.id});r.twoFactorAuthenticationEnabled||i.all({enforced:o.isTfaActive(r),strategy:s}).then(function(e){var n=e.enforced,t=e.strategy;"SMS"!==t&&t||n&&(r.twoFactorAuthenticationEnabled=n)}),e&&(r._expanded=e._expanded,u.push(r)),_.some(n,{id:r.id})||(n=n.concat([r]))}),n.paging=t,l.users=n,u.reduce(function(e,n){return e.then(function(){return g(n)})},i.resolve())}function c(e){l.globalRoles=e}function f(e){return e._globalRoles=_.map(_.get(e,"groups.references"),function(e){return _.find(l.globalRoles,{id:e.group.id})}),e}function d(){o.current().then(function(e){l.canAddUser=o.hasRole(e,"ROLE_USER_MANAGEMENT_ADMIN")||l.FEATURE_USER_HIERARCHY&&o.hasRole(e,"ROLE_USER_MANAGEMENT_CREATE")})}function g(e){return a=l.users,o.listAll({owner:e.id,withSubusersCount:!0}).then(s)}_.assign(l,{ROUTE_NEW_USER:r.ROUTE_NEW_USER,$onInit:function(){i.all([u(),e.global.list({pageSize:1e4}).then(c)]).then(function(){return _.forEach(l.users,f)}),r.userHierarchyActive().then(function(e){l.FEATURE_USER_HIERARCHY=e}).then(d)},loadMore:function(){l.users.paging.loading=!0,l.users.paging.next().then(t).finally(function(){l.users.paging.loading=!1})},loadUsers:u,loadSubusers:g,changeUser:function(n,e){var t="changeGlobalRoles"===e.name;return r.warnAboutUserLogOutIfNeeded(n,{rolesChanged:t}).then(function(){return r.changeUser(n,e)}).then(function(e){return function(e,n){var t,r=n||{};if(r.removeUser){l.users=_.reject(l.users,{id:e.id});var s=_.get(e,"_owner.id");l.users=_.map(l.users,function(e){return s&&s===e.id?(e.subusersCount--,angular.copy(e)):e})}r.refresh||r.removeUser||(t=o.list({username:e.id,withSubusersCount:!0}).then(_.first).then(function(t){var r=t.id,e=_.map(l.users,function(e){var n=r===e.id;return n&&(t._expanded=e._expanded),n?f(t):e});_.assign(e,_.pick(l.users,["statistics","paging"])),l.users=e}));r.refresh&&(t=u());return t}(n,e)})},showExpandCollapse:function(){return l.FEATURE_USER_HIERARCHY&&_.some(l.users,function(e){return 0<e.subusersCount||_.get(e,"_owns.length")})},collapseAll:function(){r.collapseAll(l.users)},expandAll:function(){r.expandAll(l.users),i.all(_.map(l.users,function(e){return e.subusersCount>e._owns.length?g(e).then(function(){return!0}):i.resolve(!1)})).then(function(e){_.some(e)&&n(l.expandAll)})},filters:{},applyFilters:function(){u(!0)},clearFilters:function(){l.filters={},u(!0)},isAnyFilterSelected:function(){return _.some(l.filters,_.identity)},refresh:function(){return u(!0).then(function(){return _.forEach(l.users,f)})}})}e.$inject=["$q","$timeout","c8yUser","c8yUsersUi","c8yRoles"],angular.module("c8y.users").component("c8yUserListView",{templateUrl:":::PLUGIN_PATH:::/userListView/userListView.html",controller:e,controllerAs:"vm"})}();