"use strict";!function(){function e(t,n,e,a,i,o,l,c,d){var r,s,u="c8y_Position",g="com_nsn_startups_vendme_fragments_GPSCoordinates",f={},m={icon:{type:"div",className:"normal-marker-icon",iconSize:[25,41],iconAnchor:[12.5,41]},focus:!0,draggable:!0},v={lat:0,lng:0,zoom:11};function h(e){d.getMap("locationId").then(function(e){setTimeout(function(){e.invalidateSize(!0)},500)}),r=e,t.location=D(e)||{};var n=t.location;b(t.location),s=_.clone(n),function(e){return!(!e.lat||!e.lng)}(n)&&C(n)}function b(e){var n=_.get(e,"lat"),t=_.get(e,"lng"),a=_.get(e,"alt");_.set(e,"lat",_.toNumber(n)),_.set(e,"lng",_.toNumber(t)),_.isUndefined(a)||_.set(e,"alt",_.toNumber(a))}function p(e){if(e){var n={lat:Number(e.lat),lng:Number(e.lon),zoom:17};C(n),y(n),N(n)}}function $(){i.detailCached(function(){var e=_.get(t,"child.config.device");return e&&(m.draggable=!1),_.get(e,"id",n.deviceId)}()).then(function(e){return _.cloneDeep(e.data)}).then(h)}function C(e){_.assign(m,{lat:parseFloat(e.lat),lng:parseFloat(e.lng)}),N(f.main=m)}function y(e){_.assign(t.location,{lat:parseFloat(e.lat),lng:function(e){var n=e%360;return n<-180?360+n:180<n?n-360:n}(parseFloat(e.lng))})}function A(e){return i.isVendme(e)?g:u}function D(e){return e[A(e)]}function N(e){var n=e||m;_.assign(t.center,n)}_.assign(t,{settings:{},markers:f,mapDefaults:{scrollWheelZoom:!1},centerMap:N,center:v,pattern:{latitude:/^[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)$/,longitude:/^[-+]?(180(\.0+)?|((1[0-7]\d)|([1-9]?\d))(\.\d+)?)$/,altitude:/^[-+]?(0|([1-9]\d*))(\.\d+)?$/},events:{markers:["dragend"]},gotoAddress:function(e){a.geoCode(e).then(function(e){return 0===e.data.length&&l.warning(c("Address could not be found.")),e.data[0]||null}).then(p)},cancel:function(){t.noeditable=!t.noeditable,_.isEqual(t.location,s)||(t.location=_.clone(s))},save:function(){t.noeditable=!t.noeditable;var e={id:r.id},n=_.clone(D(r));delete n.address,e[A(r)]=n,b(e[A(r)]),i.save(e).then(function(){l.success(c("Location saved."))}).then($)},realtimeChannel:"/managedobjects/".concat(void 0!==n.deviceId?n.deviceId:"*"),invalid:angular.bind(e,e.invalid,t),id:t.$id}),t.$on("leafletDirectiveMarker.dragend",function(e,n){y(n.model)}),t.$watch("child.config.device",$),o.addListener(t.$id,t.realtimeChannel,"".concat(t.$id,"-subscribed"),function(){$()}),o.addListener(t.$id,t.realtimeChannel,"CREATE",function(e,n){h(n)}),o.addListener(t.$id,t.realtimeChannel,"UPDATE",function(e,n){h(n)}),$()}e.$inject=["$scope","$routeParams","c8yBase","c8yGeo","c8yDevices","c8yRealtime","c8yAlert","gettext","leafletData"],angular.module("c8y.parts.location").controller("locationCtrl",e)}();