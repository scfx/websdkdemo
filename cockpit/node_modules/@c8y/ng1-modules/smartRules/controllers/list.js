"use strict";!function(){function e(i,c,a,t,n,r,o,u,s,l,d,e,f,h,g,v,m){var p,A=c.deviceId||c.groupId,S={},E={},R={done:!1,inProgress:!1},b={true:{text:v("Active"),icon:"check-circle",cls:"text-success"},false:{text:v("Inactive"),icon:"ban",cls:"text-danger"}},y=d.getContext(),x=v("Global smart rules");function I(){return a.when().then(C).then(T).then(P).then(U).then(M).catch(N)}function C(){R.inProgress=!0}function M(){R.inProgress=!1,R.done=!0,R.error=!1}function N(e){e.data&&e.data.message&&l.danger(e.data.message),R.inProgress=!1,R.done=!0,R.error=!0}function T(){return h.list().then(D)}function D(e){_.forEach(e||[],function(e){S[e.name]=e})}function P(){var e=A?g.listByContext(A):a.resolve([]),t=f.hasPermissions().then(function(e){return e?g.list():a.when([])});return a.all({listByContext:e,list:t}).then(function(e){i.rules=function(e){var t=e;A&&(t=_.reject(e,function(e){var n=new RegExp("".concat(e,"/dashboard"));return function(e){var t=_.get(e,"config.url","");return w(e)&&!n.test(t)}}(A)));return t}(_.concat(e.listByContext,e.list))})}function w(e){return"sendDashboardsViaEmail"===e.ruleTemplateName}function O(e){return g.hasSource(e,A)}function U(){return Array.isArray(i.rules)&&0<i.rules.length?function(){var e=d.getContext();return null!==e.context?r.childAssets(e.id,{skipDetail:!0,params:{pageSize:2e3,withChildren:!1}}).then(function(e){i.children=e}).then(function(){i.ruleChildren={},_.forEach(i.rules,function(e){i.ruleChildren[e.id]=L(e)})}):a.resolve()}():a.resolve()}function L(t){return _.filter(i.children,function(e){return g.hasSource(t,e)})}_.assign(i,{isOpen:{},moId:A,loadingStatus:R,refresh:I,paging:{refresh:I},ruleTemplates:S,getLinkToDM:function(){var e={deviceId:A};return t(p||"")(e)},add:function(){g.addNewWithUI().then(I)},edit:function(e){g.editWithUI(e).then(I)},clone:function(e){g.cloneWithUI(e).then(I)},remove:function(e){s({title:v("Delete smart rule"),body:m.getString('You are about to delete smart rule "{{name}}". Do you want to proceed?',e),labels:{ok:v("Delete")},status:"danger"}).then(angular.bind(g,g.remove,e)).then(function(){return _.pull(i.rules,e)}).then(function(){return l.success(v("Smart rule deleted."))})},hasSource:O,getChildrenEnabledForSmartRule:L,toggleRuleActivationForContextMO:function(e){if(O(e))return g.deactivate(e,A,!1).then(function(){l.success(m.getString('Smart rule "{{name}}" deactivated.',e))});return g.activate(e,A,!1).then(function(){l.success(m.getString('Smart rule "{{name}}" activated.',e))})},toggleRuleActivationForChildrenMOs:function(e,n){var r=[];return _.forEach(n,function(t){!_.find(i.ruleChildren[e.id],function(e){return e.id===t.id})&&r.push(g.activate(e,t,!1))}),_.forEach(i.ruleChildren[e.id],function(t){!_.find(n,function(e){return t.id===e.id})&&r.push(g.deactivate(e,t,!1))}),a.all(r).then(P).then(U).then(function(){l.success(m.getString('Smart rule "{{name}}" activated/deactivated for children.',e))})},tooltip:function(e){var t={activate:{"for group":v("Activate for this group"),"for device":v("Activate for this device"),"for object":v("Activate for this object")},deactivate:{"for group":v("Deactivate for this group"),"for device":v("Deactivate for this device"),"for object":v("Deactivate for this object")}},n=e.enabled&&O(e)?"deactivate":"activate",r=c.groupId?"group":"object";return r=c.deviceId?"device":r,t[n]["for ".concat(r)]},type:function(e){var t,n=S[e.ruleTemplateName];n&&(t=n.label.full?m.getString(n.label.full):"".concat(m.getString(n.label.input)," ").concat(m.getString(n.label.output)));return t},status:function(e){return b[e.enabled].text},statusIcon:function(e){return b[e.enabled].icon},statusClass:function(e){return b[e.enabled].cls},showTitle:function(){return null!==d.getContext().context},title:x,context:y,inputIcon:function(e){var t,n=S[e.ruleTemplateName];n&&(t=n.paramGroups.input.icon);return t},outputIcon:function(e){var t,n=S[e.ruleTemplateName];n&&(t=n.paramGroups.output.icon);return t},canAddRules:function(e){var t=_.get(S,"".concat(_.get(e,"ruleTemplateName"),"._active")),n=E.canAddRules;e&&!t&&(n=!1);if(_.isUndefined(n)){var r;r=i.context?{adminMOs:[i.context.id]}:{allRoles:["ROLE_INVENTORY_ADMIN"],anyRole:["ROLE_SMARTRULE_ADMIN","ROLE_CEP_MANAGEMENT_ADMIN"]},E.canAddRules=u.isAllowed(r).then(function(e){return E.canAddRules=e,E.canAddRules}),n=!1}return n},canModify:function(t){E.rules=E.rules||{};var n=E.rules,e=n[t.id];_.isUndefined(e)&&(n[t.id]=u.isAllowed({adminMOs:[t.id]}).then(function(e){return n[t.id]=e,n[t.id]}),e=!1);return e},canInspect:function(){var e=E.canInspect;_.isUndefined(e)&&(E.canInspect=a.all({administrationAccess:o.listByUser().then(function(e){return!!_.find(e,{contextPath:"administration"})}),eventProcessingAccess:u.isAllowed({anyRole:["ROLE_CEP_MANAGEMENT_READ","ROLE_CEP_MANAGEMENT_ADMIN"]}),eventProcessingEnabled:g.eventProcessingEnabled()}).then(function(e){return E.canInspect=e.administrationAccess&&e.eventProcessingAccess&&e.eventProcessingEnabled,E.canInspect}),e=!1);return e},canApplyOnChildren:function(e){return!w(e)},canSeeSection:function(){var e=E.canSeeSection;_.isUndefined(e)&&(E.canSeeSection=(n.checkIfModulesExist(["c8y.cockpit.config"])?f.shouldShowLocalSmartRules():a.when(!1)).then(function(e){return E.canSeeSection=e,E.canSeeSection}),e=!1);return e}}),I(),null===d.getContext().context&&e.changeTitle({title:x}),"device"===y.context&&n.getStaticLinkTemplate("devicemanagementDeviceDetails").then(function(e){p=e})}e.$inject=["$scope","$routeParams","$q","$interpolate","c8yBase","c8yInventory","c8yApplication","c8yPermissions","c8yModal","c8yAlert","c8yUiUtil","c8yTitle","c8ySmartRulesAvailability","smartRuleTemplatesSvc","smartRulesSvc","gettext","gettextCatalog"],angular.module("c8y.smartRules").controller("SmartRulesListCtrl",e)}();