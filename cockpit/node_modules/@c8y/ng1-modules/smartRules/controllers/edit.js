"use strict";!function(){function e(t,e,n,s,i,a,l,r,u,o,c,d,m){var g=_.isEmpty(c)?null:c,h="smartRuleForm",v={parent:null,mo:null,withChildren:{assets:!0,devices:!1}},y={inProgres:!1};function f(e){o=e,t.ruleTemplate=o,t.rule.name||(t.rule.name=m.getString(t.ruleTemplate.description))}function p(e){t.enabledSources=_.sortBy(e,"name")}function b(e){t.disabledSources=_.sortBy(e,"name")}function C(e){t.title=e}function S(){return T(),n.reject()}function R(){y.inProgress=!0}function T(){y.inProgress=!1}t.hasChildAssets=angular.bind(i,i.hasChildAssets),t.getChildAssetsCount=angular.bind(i,i.getChildAssetsCount),t.ruleTemplate=o,t.rule=c,t.save=function(){o.noTarget&&(v.withChildren={assets:!1,devices:!1}),n.when().then(R).then(angular.bind(r,r.save,c,o,v)).then(e.close,S).then(_.partial(_.unary(l.success),m.getString('Smart rule "{{name}}" saved.',{name:c.name}))).then(T)},t.savingStatus=y,t.cancel=e.dismiss,t.invalid=angular.bind(s,s.invalid,t,h);var A,E=t.$watch(h,function(e){g&&e.$setDirty(),e&&E()});c&&c.id?C(d("Edit global smart rule")):(C(d("New global smart rule")),c=_.assign(r.getEmpty(),c||{})),t.rule=c,o?f(o):u.getTemplateForRule(c).then(f),function(){t.initialActivationCfg=v;var e=_.get(c,"c8y_Context",a.getContext());i.detail(e.id).then(s.getResData).then(function(e){v.mo=e})}(),c&&c.id&&(_.isEmpty(c.enabledSources)||(A=c.enabledSources.join(","),i.list({ids:A}).then(p)),_.isEmpty(c.disabledSources)||(A=c.disabledSources.join(","),i.list({ids:A}).then(b)))}e.$inject=["$scope","$uibModalInstance","$q","c8yBase","c8yInventory","c8yUiUtil","c8yAlert","smartRulesSvc","smartRuleTemplatesSvc","ruleTemplate","rule","gettext","gettextCatalog"],angular.module("c8y.smartRules").controller("SmartRuleEditCtrl",e)}();