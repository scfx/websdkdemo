"use strict";!function(){function t(i,t,s,e,n,o,r,u,a,c){var h=this;this.APP_IGNORE=["administration","vendme_plugins","core","c8ydata","tenantadmin","platformadmin"],c.$on("language:loaded",function(){h.fetch()}),c.$on("language:change",function(){h.fetch()});var d={requestCount:r("calculating number of API requests"),deviceRequestCount:r("calculating number of device API requests"),totalResourceCreateAndUpdateCount:r("calculating number of inbound API requests"),storageSize:r("calculating storage"),devicesCount:r("calculating number of devices"),usersCount:r("calculating number of users"),deviceWithChildrenCount:r("calculating number of devices")},l=e.administration.statistics.thisMonthExtraTooltip;function m(){return!!l}function g(t,e){var i=u.getString("Usage between {{start}} - {{end}}",t);return m()&&"thisMonth"===e&&(i+="\n".concat(u.getString(l))),i}function f(t){return u.getString("Amount of data in use on {{end}}.",t)}function v(t){return u.getString("Number of root devices on {{end}}. Does not include child devices.",t)}function C(t){return u.getString("Number of devices on {{end}}, including child devices.",t)}this.summary={thisMonth:_.clone(d),lastMonth:_.clone(d)},this.tooltips=function(t,e){return{month:_.partial(g,t,e),storageSize:_.partial(f,t),rootDevicesCount:_.partial(v,t),devicesCount:_.partial(C,t)}},this.fetch=function(){a.hasAllRoles(["ROLE_TENANT_STATISTICS_READ"]).then(_.bind(this.fetchStatisticsIfPermission,this)),a.hasAllRoles(["ROLE_APPLICATION_MANAGEMENT_READ"]).then(_.bind(this.fetchSubscribedApps,this))},this.fetchStatisticsIfPermission=function(t){if(t){var e=function(){var t=s.monthFilter({},1);return t.dateFrom=moment(t.dateFrom).subtract(1,"month").endOf("month").format(s.dateFormat),t}(),i=function(){var t=s.monthFilter();return delete t.dateTo,t}();this.formatMonth("thisMonth",i),this.formatMonth("lastMonth",e),this.fetchStatistics("thisMonth",i).then(_.bind(this.fetchUsersCount,this)),this.fetchStatistics("lastMonth",e)}},this.formatMonth=function(t,e){this[t]={},e.dateFrom?this[t].start=moment(e.dateFrom).format("ll"):this[t].start="?",e.dateTo?this[t].end=moment(e.dateTo).format("ll"):this[t].end=moment().format("ll"),this.assignTooltips(this[t],t)},this.assignTooltips=function(t,e){t.tooltips=this.tooltips(t,e)},this.fetchStatistics=function(t,e){return i.getSummary(e).then(_.bind(this.setStatistics,this,t))},this.fetchSubscribedApps=function(t){t&&n.list().then(_.bind(this.setApps,this))},this.setStatistics=function(t,e){var i=u.getString("<Not calculated>"),s=e.data;if(s.rootDevicesCount=s.deviceCount,s.devicesCount=s.deviceWithChildrenCount,_.isNumber(s.storageSize)&&(s.storageSize=Number(s.storageSize)<0?i:o("bytes")(s.storageSize)),s.storageLimitPerDevice){var n=Math.max(s.devicesCount,1);s.storageLimit=o("bytes")(s.storageLimitPerDevice*n)}Number(s.rootDevicesCount)<0&&(s.rootDevicesCount=i),Number(s.devicesCount)<0&&(s.devicesCount=i),this.summary[t]={requestCount:_.isNumber(s.requestCount)?u.getPlural(s.requestCount,"1 API request, including:","{{$count}} API requests, including:",s):void 0,deviceRequestCount:_.isNumber(s.deviceRequestCount)?u.getPlural(s.deviceRequestCount,"1 device API request","{{$count}} device API requests",s):void 0,totalResourceCreateAndUpdateCount:_.isNumber(s.totalResourceCreateAndUpdateCount)?u.getPlural(s.totalResourceCreateAndUpdateCount,"1 inbound API request","{{$count}} inbound API requests",s):void 0,storageSize:s.storageSize?u.getString("{{storageSize}} storage",s):void 0,storageLimit:s.storageLimit?u.getString("{{storageLimit}} storage quota",s):void 0,rootDevicesCount:_.isNumber(s.rootDevicesCount)?u.getPlural(s.rootDevicesCount,"1 root device","{{$count}} root devices",s):void 0,devicesCount:_.isNumber(s.devicesCount)?u.getPlural(s.devicesCount,"1 device","{{$count}} devices",s):void 0,show:!0}},this.fetchUsersCount=function(){t.list({pageSize:1}).then(_.bind(this.setUsersCount,this))},this.setUsersCount=function(t){var e=t.statistics.totalPages;this.summary.thisMonth.usersCount=u.getPlural(e,"1 user","{{$count}} users",{})},this.setApps=function(t){this.apps=_(t).filter(_.bind(this.marketApps,this)).filter(_.bind(this.hiddenApps,this)).filter(_.bind(this.ignoredApps,this)).value()},this.marketApps=function(t){return"MARKET"===t.availability},this.hiddenApps=function(t){return!(t.manifest&&!0===t.manifest.noAppSwitcher)},this.ignoredApps=function(t){return!_.includes(this.APP_IGNORE,t.name)},this.shouldDisplayCustomTooltip=m}t.$inject=["c8yStatistics","c8yUser","c8yBase","c8yConfig","c8yApplication","$filter","gettext","gettextCatalog","c8yPermissions","$rootScope"],angular.module("c8y.parts.statistics").controller("StatisticsCtrl",t)}();