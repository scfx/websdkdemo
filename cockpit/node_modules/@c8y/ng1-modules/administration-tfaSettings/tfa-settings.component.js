"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(){function e(r,e,a,o,t,i,l,u,s,c){var y=this,n="two-factor-authentication",d=c("TOTP requires OAI-Secure login mode."),f=c("TOTP requires Allow two-factor authentication enabled."),p=c("Messaging application is not subscribed."),g=c("The setting is enforced on the platform level."),b=c("In OAI-Secure login mode, the token's validity limit is determined by the JWT token and cannot be edited here."),m=[{systemOption:!0,key:"tenant-scope-settings.enabled",default:!1,readOnly:!0},{key:"enabled",default:!1,loader:I},{key:"token.validity",default:43200,readOnlyIfTenantScopeSettingsDisabled:!0},{key:"pin.validity",default:30,readOnlyIfTenantScopeSettingsDisabled:!0},{key:"enforced",default:!1,loader:I}],v=[{key:"enabledOnSystemLevel",default:!1},{key:"enabledOnTenantLevel",default:!1},{key:"enforcedOnSystemLevel",default:!1},{key:"enforcedUsersGroup",default:""},{key:"strategy",default:"SMS"},{key:"totpEnforcedOnTenantLevel",default:!1}];function S(t){var e=h(t),n=t.default;return(t.systemOption?o.getSystemOptionValue(e,n):"function"==typeof t.loader?t.loader():o.detailValue(e,n)).then(function(e){return A(t,e)}).catch(function(){return A(t,t.default)})}function h(e){return{category:n,key:e.key}}function A(e,t){y[T(e.key)]=t,y.previousSettings[T(e.key)]=_.cloneDeep(t)}function T(e){return _.camelCase(e)}function k(e){var t={category:n,key:e.key,value:O(e)};return function(e){var t="enabled"===e.key||L(),n=y.previousSettings[T(e.key)]!==O(e),r=e.readOnly,a=e.readOnlyIfTenantScopeSettingsDisabled&&!y.tenantScopeSettingsEnabled;return n&&t&&!e.systemOption&&!(r||a)}(e)?o.updateOption(t).then(function(){return A(e,t.value)}):r.when()}function O(e){return function(e){return _.isNumber(e)||!_.isNaN(_.toNumber(e))&&_.isString(e)?_.toNumber(e):e}(y[T(e.key)])}function I(){var t=this,n=h(this);return o.getSystemOptionValue(n,this.default).then(function(e){return!0===e||"true"===_.lowerCase(e)?t.readOnly=!0:o.detailValue(n,t.default)})}function L(){return y.enabled||y.enforcedOnSystemLevel||!_.isEmpty(y.enforcedUsersGroup)}_.assign(y,{$onInit:function(){v.forEach(function(e){_.assign(y,_defineProperty({},e.key,e.default))}),r.all([r.all([].concat(_toConsumableArray(_.map(m,S)),[void e.isAvailable({contextPath:"messaging"}).then(function(e){y.smsAppAvailable=e})])),i.current().then(function(e){return l.getTfaSettings(e)}).then(function(t){return v.forEach(function(e){t[e.key]&&A(e,t[e.key])})})]).finally(function(){y.initialized=!0})},saveSettings:function(t){y.enabled&&"TOTP"===y.strategy||(y.enforced=!1);var n=y.previousSettings.strategy!==y.strategy&&L(),e=function(){var e=[].concat(_toConsumableArray(_.map(m,k)),[n?i.current().then(function(e){return l.updateTfaSettings(e,y.strategy)}):r.resolve()]);return r.all(e).then(function(){u.success(c("TFA settings saved.")),t&&t.$setPristine()})};return(n?s.requireLogout(e):e()).catch(function(e){"canceled"!==e&&u.danger(a.getResErrorMessage(e))})},limitValidityRegex:/^[0-9]\d*$/,initialized:!1,totpPopover:d,tfaIsDisabled:f,smsWarningPopover:p,enforcedOnSystemLevelPopover:g,disabledValidityLimitPopover:b,oAuthLoginMode:function(){return y.loginMode===t.loginOptions.OAUTH2_INTERNAL.value.toUpperCase()},isReadOnly:function(r){return m.some(function(e){var t=e.key,n=e.readOnly;return t===r&&n})},isTFAEnabled:L,previousSettings:{}})}e.$inject=["$q","c8yApplication","c8yBase","c8ySettings","c8yLoginOptions","c8yTenant","c8yTfaSettings","c8yAlert","c8yUserUtil","gettext"],angular.module("c8y.parts.tfaSettings").component("c8yTfaSettings",{controller:e,controllerAs:"vm",templateUrl:":::PLUGIN_PATH:::/tfa-settings.html",bindings:{loginMode:"<"}})}();